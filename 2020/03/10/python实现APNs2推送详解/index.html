

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/Myblog/img/favicon.png">
  <link rel="icon" href="/Myblog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="Simple, so charming!">
  <meta name="author" content="stellae">
  <meta name="keywords" content="">
  
  <title>python实现APNs2推送详解 - stellae&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/Myblog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/Myblog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"stellae.gitee.io","root":"/Myblog/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/Myblog/js/utils.js" ></script>
  <script  src="/Myblog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 40vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/Myblog/">&nbsp;<strong>stellae's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/Myblog/img/WtwSsqwYlA0.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="python实现APNs2推送详解">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      stellae
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-03-10 14:23" pubdate>
        2020年3月10日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.3k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      78
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">python实现APNs2推送详解</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2 年前
                
              </p>
            
            <div class="markdown-body">
              <h3 id="APNs2详解"><a href="#APNs2详解" class="headerlink" title="APNs2详解"></a>APNs2详解</h3><p>APNs提供程序API允许您将远程通知请求发送到APN。然后，APNs将通知传送到iOS，tvOS和macOS设备上的应用程序，并通过iOS传送给Apple Watch。</p>
<p>提供者API基于HTTP / 2网络协议。每次交互都从提供者发出的POST请求开始，该请求包含JSON有效负载和设备令牌。APNs将通知有效负载转发到由请求的包含设备令牌标识的特定用户设备上的应用程序。</p>
<p><strong>本文参考<a target="_blank" rel="noopener" href="https://github.com/Pr0Ger/PyAPNs2">PyAPNs2</a>三方库</strong>，因为需要修改部分代码，所以复制了代码到项目。</p>
<h3 id="准备通讯凭证"><a href="#准备通讯凭证" class="headerlink" title="准备通讯凭证"></a>准备通讯凭证</h3><ol>
<li>实现与APN通讯，需要提供<code>身份验证令牌</code> 或者<code>APNs提供商证书</code>，证书中必须选中允许APNs推送，并且后缀名为<code>.pem</code>。</li>
<li>提供与证书对应的bundle Identifier，例如<code>com.example.apple</code></li>
<li>提供需要推送到特定设备的<code>device_token</code>，<code>device_token</code>每个设备安装app时确定并且唯一。</li>
</ol>
<h3 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h3><h4 id="文件目录结构"><a href="#文件目录结构" class="headerlink" title="文件目录结构"></a>文件目录结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">.<br>├── test.py<br>├── apns2<br>│   ├── client.py<br>│   ├── credentials.py<br>│   ├── errors.py<br>│   ├── payload.py<br></code></pre></td></tr></table></figure>



<h4 id="test-py"><a href="#test-py" class="headerlink" title="test.py"></a>test.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> collections<br><span class="hljs-keyword">from</span> apns2.client <span class="hljs-keyword">import</span> APNsClient<br><span class="hljs-keyword">from</span> apns2.payload <span class="hljs-keyword">import</span> Payload<br><br>SADBOX_SERVER = <span class="hljs-string">&#x27;api.development.push.apple.com&#x27;</span><br>PRODUCT_SERVER = <span class="hljs-string">&#x27;api.push.apple.com&#x27;</span><br>DEFAULT_PORT = <span class="hljs-number">443</span><br>ALTERNATIVE_PORT = <span class="hljs-number">2197</span><br><br>device_token = <span class="hljs-string">&#x27;c58b05dabd54ehthdc138a875059ef4f66d1ae4e1f1c04f1c8bcf967f84&#x27;</span><br>payload = Payload(alert=<span class="hljs-string">&quot;Hello World!&quot;</span>, sound=<span class="hljs-string">&quot;default&quot;</span>, badge=<span class="hljs-number">1</span>)<br>payload2 = Payload(alert=<span class="hljs-string">&quot;Hello World!!&quot;</span>, sound=<span class="hljs-string">&quot;default&quot;</span>, badge=<span class="hljs-number">1</span>)<br>payload3 = Payload(alert=<span class="hljs-string">&quot;Hello World!!!&quot;</span>, sound=<span class="hljs-string">&quot;default&quot;</span>, badge=<span class="hljs-number">1</span>)<br>topic = <span class="hljs-string">&#x27;com.example.apple&#x27;</span><br>pem_file = <span class="hljs-string">&#x27;push_cer_sandbox_key.pem&#x27;</span><br>client = APNsClient(pem_file, password=<span class="hljs-string">&#x27;000000&#x27;</span>, server=SADBOX_SERVER, port=DEFAULT_PORT)<br>client.send_notification(device_token, payload, topic)  <span class="hljs-comment"># 发送单条通知</span><br><br>Notification = collections.namedtuple(<span class="hljs-string">&#x27;Notification&#x27;</span>, [<span class="hljs-string">&#x27;token&#x27;</span>, <span class="hljs-string">&#x27;payload&#x27;</span>])<br>notifications = [Notification(payload=payload, token=device_token),<br>                 Notification(payload=payload2, token=device_token),<br>                 Notification(payload=payload3, token=device_token)]<br>client.send_notification_batch(notifications=notifications, topic=topic)  <span class="hljs-comment"># 发送多条通知</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>SADBOX_SERVER指本地测试开发使用服务器地址，PRODUCT_SERVER指线上正式环境(包括我们一般的测试环境和正式环境)，topic(也就是boundid) 和 证书 也是这个道理。所以一定要区分好使用环境！</p>
</blockquote>
<h4 id="apns2-client-py"><a href="#apns2-client-py" class="headerlink" title="apns2/client.py"></a>apns2/client.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> collections<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> typing<br><span class="hljs-keyword">import</span> weakref<br><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, Iterable, Optional, Tuple, Union<br><br><span class="hljs-keyword">from</span> .credentials <span class="hljs-keyword">import</span> CertificateCredentials, Credentials<br><span class="hljs-keyword">from</span> .errors <span class="hljs-keyword">import</span> ConnectionFailed, exception_class_for_reason<br><span class="hljs-keyword">from</span> .payload <span class="hljs-keyword">import</span> Payload<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotificationPriority</span>(<span class="hljs-params">Enum</span>):</span><br>    Immediate = <span class="hljs-string">&#x27;10&#x27;</span><br>    Delayed = <span class="hljs-string">&#x27;5&#x27;</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotificationType</span>(<span class="hljs-params">Enum</span>):</span><br>    Alert = <span class="hljs-string">&#x27;alert&#x27;</span><br>    Background = <span class="hljs-string">&#x27;background&#x27;</span><br>    VoIP = <span class="hljs-string">&#x27;voip&#x27;</span><br>    Complication = <span class="hljs-string">&#x27;complication&#x27;</span><br>    FileProvider = <span class="hljs-string">&#x27;fileprovider&#x27;</span><br>    MDM = <span class="hljs-string">&#x27;mdm&#x27;</span><br><br><br>RequestStream = collections.namedtuple(<span class="hljs-string">&#x27;RequestStream&#x27;</span>, [<span class="hljs-string">&#x27;stream_id&#x27;</span>, <span class="hljs-string">&#x27;token&#x27;</span>])<br>Notification = collections.namedtuple(<span class="hljs-string">&#x27;Notification&#x27;</span>, [<span class="hljs-string">&#x27;token&#x27;</span>, <span class="hljs-string">&#x27;payload&#x27;</span>])<br><br>DEFAULT_APNS_PRIORITY = NotificationPriority.Immediate<br>CONCURRENT_STREAMS_SAFETY_MAXIMUM = <span class="hljs-number">1000</span><br>MAX_CONNECTION_RETRIES = <span class="hljs-number">3</span><br><br>logger = logging.getLogger(__name__)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">APNsClient</span>(<span class="hljs-params">object</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                 credentials: Union[Credentials, str],</span></span><br><span class="hljs-function"><span class="hljs-params">                 server: str, port: int, proto: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                 json_encoder: Optional[type] = None, password: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                 proxy_host: Optional[str] = None, proxy_port: Optional[int] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                 heartbeat_period: Optional[float] = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        <span class="hljs-keyword">if</span> isinstance(credentials, str):<br>            self.__credentials = CertificateCredentials(credentials, password)  <span class="hljs-comment"># type: Credentials</span><br>        <span class="hljs-keyword">else</span>:<br>            self.__credentials = credentials<br>        self._init_connection(server, port, proto, proxy_host, proxy_port)<br><br>        <span class="hljs-keyword">if</span> heartbeat_period:<br>            self._start_heartbeat(heartbeat_period)<br><br>        self.__json_encoder = json_encoder<br>        self.__max_concurrent_streams = <span class="hljs-number">0</span><br>        self.__previous_server_max_concurrent_streams = <span class="hljs-literal">None</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_init_connection</span>(<span class="hljs-params">self, server: str, port: int, proto: Optional[str],</span></span><br><span class="hljs-function"><span class="hljs-params">                         proxy_host: Optional[str], proxy_port: Optional[int]</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        self._connection = self.__credentials.create_connection(server, port, proto, proxy_host, proxy_port)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_start_heartbeat</span>(<span class="hljs-params">self, heartbeat_period: float</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        conn_ref = weakref.ref(self._connection)<br><br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">watchdog</span>() -&gt; <span class="hljs-keyword">None</span>:</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                conn = conn_ref()<br>                <span class="hljs-keyword">if</span> conn <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-keyword">break</span><br><br>                conn.ping(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">8</span>)<br>                time.sleep(heartbeat_period)<br><br>        thread = Thread(target=watchdog)<br>        thread.setDaemon(<span class="hljs-literal">True</span>)<br>        thread.start()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_notification</span>(<span class="hljs-params">self, token_hex: str, notification: Payload, topic: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                          priority: NotificationPriority = NotificationPriority.Immediate,</span></span><br><span class="hljs-function"><span class="hljs-params">                          expiration: Optional[int] = None, collapse_id: Optional[str] = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        stream_id = self.send_notification_async(token_hex, notification, topic, priority, expiration, collapse_id)<br>        result = self.get_notification_result(stream_id)<br>        <span class="hljs-keyword">if</span> result != <span class="hljs-string">&#x27;Success&#x27;</span>:<br>            <span class="hljs-keyword">if</span> isinstance(result, tuple):<br>                reason, info = result<br>                <span class="hljs-keyword">raise</span> exception_class_for_reason(reason)(info)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">raise</span> exception_class_for_reason(result)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_notification_async</span>(<span class="hljs-params">self, token_hex: str, notification: Payload, topic: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                priority: NotificationPriority = NotificationPriority.Immediate,</span></span><br><span class="hljs-function"><span class="hljs-params">                                expiration: Optional[int] = None, collapse_id: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                push_type: Optional[NotificationType] = None</span>) -&gt; int:</span><br>        json_str = json.dumps(notification.dict(), cls=self.__json_encoder, ensure_ascii=<span class="hljs-literal">False</span>, separators=(<span class="hljs-string">&#x27;,&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>))<br>        json_payload = json_str.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><br>        headers = &#123;&#125;<br><br>        inferred_push_type = <span class="hljs-literal">None</span>  <span class="hljs-comment"># type: Optional[str]</span><br>        <span class="hljs-keyword">if</span> topic <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            headers[<span class="hljs-string">&#x27;apns-topic&#x27;</span>] = topic<br>            <span class="hljs-keyword">if</span> topic.endswith(<span class="hljs-string">&#x27;.voip&#x27;</span>):<br>                inferred_push_type = NotificationType.VoIP.value<br>            <span class="hljs-keyword">elif</span> topic.endswith(<span class="hljs-string">&#x27;.complication&#x27;</span>):<br>                inferred_push_type = NotificationType.Complication.value<br>            <span class="hljs-keyword">elif</span> topic.endswith(<span class="hljs-string">&#x27;.pushkit.fileprovider&#x27;</span>):<br>                inferred_push_type = NotificationType.FileProvider.value<br>            <span class="hljs-keyword">elif</span> any([notification.alert, notification.badge, notification.sound]):<br>                inferred_push_type = NotificationType.Alert.value<br>            <span class="hljs-keyword">else</span>:<br>                inferred_push_type = NotificationType.Background.value<br><br>        <span class="hljs-keyword">if</span> push_type:<br>            inferred_push_type = push_type.value<br><br>        <span class="hljs-keyword">if</span> inferred_push_type:<br>            headers[<span class="hljs-string">&#x27;apns-push-type&#x27;</span>] = inferred_push_type<br><br>        <span class="hljs-keyword">if</span> priority != DEFAULT_APNS_PRIORITY:<br>            headers[<span class="hljs-string">&#x27;apns-priority&#x27;</span>] = priority.value<br><br>        <span class="hljs-keyword">if</span> expiration <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            headers[<span class="hljs-string">&#x27;apns-expiration&#x27;</span>] = <span class="hljs-string">&#x27;%d&#x27;</span> % expiration<br><br>        auth_header = self.__credentials.get_authorization_header(topic)<br>        <span class="hljs-keyword">if</span> auth_header <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            headers[<span class="hljs-string">&#x27;authorization&#x27;</span>] = auth_header<br><br>        <span class="hljs-keyword">if</span> collapse_id <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            headers[<span class="hljs-string">&#x27;apns-collapse-id&#x27;</span>] = collapse_id<br><br>        url = <span class="hljs-string">&#x27;/3/device/&#123;&#125;&#x27;</span>.format(token_hex)<br>        stream_id = self._connection.request(<span class="hljs-string">&#x27;POST&#x27;</span>, url, json_payload, headers)  <span class="hljs-comment"># type: int</span><br>        <span class="hljs-keyword">return</span> stream_id<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_notification_result</span>(<span class="hljs-params">self, stream_id: int</span>) -&gt; Union[str, Tuple[str, str]]:</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Get result for specified stream</span><br><span class="hljs-string">        The function returns: &#x27;Success&#x27; or &#x27;failure reason&#x27; or (&#x27;Unregistered&#x27;, timestamp)</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> self._connection.get_response(stream_id) <span class="hljs-keyword">as</span> response:<br>            <span class="hljs-keyword">if</span> response.status == <span class="hljs-number">200</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Success&#x27;</span><br>            <span class="hljs-keyword">else</span>:<br>                raw_data = response.read().decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>                data = json.loads(raw_data)  <span class="hljs-comment"># type: Dict[str, str]</span><br>                <span class="hljs-keyword">if</span> response.status == <span class="hljs-number">410</span>:<br>                    <span class="hljs-keyword">return</span> data[<span class="hljs-string">&#x27;reason&#x27;</span>], data[<span class="hljs-string">&#x27;timestamp&#x27;</span>]<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> data[<span class="hljs-string">&#x27;reason&#x27;</span>]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_notification_batch</span>(<span class="hljs-params">self, notifications: Iterable[Notification], topic: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                priority: NotificationPriority = NotificationPriority.Immediate,</span></span><br><span class="hljs-function"><span class="hljs-params">                                expiration: Optional[int] = None, collapse_id: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                push_type: Optional[NotificationType] = None</span>) -&gt; Dict[str, Union[str, Tuple[str, str]]]:</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Send a notification to a list of tokens in batch. Instead of sending a synchronous request</span><br><span class="hljs-string">        for each token, send multiple requests concurrently. This is done on the same connection,</span><br><span class="hljs-string">        using HTTP/2 streams (one request per stream).</span><br><span class="hljs-string"></span><br><span class="hljs-string">        APNs allows many streams simultaneously, but the number of streams can vary depending on</span><br><span class="hljs-string">        server load. This method reads the SETTINGS frame sent by the server to figure out the</span><br><span class="hljs-string">        maximum number of concurrent streams. Typically, APNs reports a maximum of 500.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The function returns a dictionary mapping each token to its result. The result is &quot;Success&quot;</span><br><span class="hljs-string">        if the token was sent successfully, or the string returned by APNs in the &#x27;reason&#x27; field of</span><br><span class="hljs-string">        the response, if the token generated an error.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        notification_iterator = iter(notifications)<br>        next_notification = next(notification_iterator, <span class="hljs-literal">None</span>)<br>        <span class="hljs-comment"># Make sure we&#x27;re connected to APNs, so that we receive and process the server&#x27;s SETTINGS</span><br>        <span class="hljs-comment"># frame before starting to send notifications.</span><br>        self.connect()<br><br>        results = &#123;&#125;<br>        open_streams = collections.deque()  <span class="hljs-comment"># type: typing.Deque[RequestStream]</span><br>        <span class="hljs-comment"># Loop on the tokens, sending as many requests as possible concurrently to APNs.</span><br>        <span class="hljs-comment"># When reaching the maximum concurrent streams limit, wait for a response before sending</span><br>        <span class="hljs-comment"># another request.</span><br>        <span class="hljs-keyword">while</span> len(open_streams) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> next_notification <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-comment"># Update the max_concurrent_streams on every iteration since a SETTINGS frame can be</span><br>            <span class="hljs-comment"># sent by the server at any time.</span><br>            self.update_max_concurrent_streams()<br>            <span class="hljs-keyword">if</span> next_notification <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> len(open_streams) &lt; self.__max_concurrent_streams:<br>                logger.info(<span class="hljs-string">&#x27;Sending to token %s&#x27;</span>, next_notification.token)<br>                stream_id = self.send_notification_async(next_notification.token, next_notification.payload, topic,<br>                                                         priority, expiration, collapse_id, push_type)<br>                open_streams.append(RequestStream(stream_id, next_notification.token))<br><br>                next_notification = next(notification_iterator, <span class="hljs-literal">None</span>)<br>                <span class="hljs-keyword">if</span> next_notification <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-comment"># No tokens remaining. Proceed to get results for pending requests.</span><br>                    logger.info(<span class="hljs-string">&#x27;Finished sending all tokens, waiting for pending requests.&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># We have at least one request waiting for response (otherwise we would have either</span><br>                <span class="hljs-comment"># sent new requests or exited the while loop.) Wait for the first outstanding stream</span><br>                <span class="hljs-comment"># to return a response.</span><br>                pending_stream = open_streams.popleft()<br>                result = self.get_notification_result(pending_stream.stream_id)<br>                logger.info(<span class="hljs-string">&#x27;Got response for %s: %s&#x27;</span>, pending_stream.token, result)<br>                results[pending_stream.token] = result<br><br>        <span class="hljs-keyword">return</span> results<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_max_concurrent_streams</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        <span class="hljs-comment"># Get the max_concurrent_streams setting returned by the server.</span><br>        <span class="hljs-comment"># The max_concurrent_streams value is saved in the H2Connection instance that must be</span><br>        <span class="hljs-comment"># accessed using a with statement in order to acquire a lock.</span><br>        <span class="hljs-comment"># pylint: disable=protected-access</span><br>        <span class="hljs-keyword">with</span> self._connection._conn <span class="hljs-keyword">as</span> connection:<br>            max_concurrent_streams = connection.remote_settings.max_concurrent_streams<br><br>        <span class="hljs-keyword">if</span> max_concurrent_streams == self.__previous_server_max_concurrent_streams:<br>            <span class="hljs-comment"># The server hasn&#x27;t issued an updated SETTINGS frame.</span><br>            <span class="hljs-keyword">return</span><br><br>        self.__previous_server_max_concurrent_streams = max_concurrent_streams<br>        <span class="hljs-comment"># Handle and log unexpected values sent by APNs, just in case.</span><br>        <span class="hljs-keyword">if</span> max_concurrent_streams &gt; CONCURRENT_STREAMS_SAFETY_MAXIMUM:<br>            logger.warning(<span class="hljs-string">&#x27;APNs max_concurrent_streams too high (%s), resorting to default maximum (%s)&#x27;</span>,<br>                           max_concurrent_streams, CONCURRENT_STREAMS_SAFETY_MAXIMUM)<br>            self.__max_concurrent_streams = CONCURRENT_STREAMS_SAFETY_MAXIMUM<br>        <span class="hljs-keyword">elif</span> max_concurrent_streams &lt; <span class="hljs-number">1</span>:<br>            logger.warning(<span class="hljs-string">&#x27;APNs reported max_concurrent_streams less than 1 (%s), using value of 1&#x27;</span>,<br>                           max_concurrent_streams)<br>            self.__max_concurrent_streams = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            logger.info(<span class="hljs-string">&#x27;APNs set max_concurrent_streams to %s&#x27;</span>, max_concurrent_streams)<br>            self.__max_concurrent_streams = max_concurrent_streams<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">connect</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Establish a connection to APNs. If already connected, the function does nothing. If the</span><br><span class="hljs-string">        connection fails, the function retries up to MAX_CONNECTION_RETRIES times.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        retries = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> retries &lt; MAX_CONNECTION_RETRIES:<br>            <span class="hljs-comment"># noinspection PyBroadException</span><br>            <span class="hljs-keyword">try</span>:<br>                self._connection.connect()<br>                logger.info(<span class="hljs-string">&#x27;Connected to APNs&#x27;</span>)<br>                <span class="hljs-keyword">return</span><br>            <span class="hljs-keyword">except</span> Exception:  <span class="hljs-comment"># pylint: disable=broad-except</span><br>                <span class="hljs-comment"># close the connnection, otherwise next connect() call would do nothing</span><br>                self._connection.close()<br>                retries += <span class="hljs-number">1</span><br>                logger.exception(<span class="hljs-string">&#x27;Failed connecting to APNs (attempt %s of %s)&#x27;</span>, retries, MAX_CONNECTION_RETRIES)<br><br>        <span class="hljs-keyword">raise</span> ConnectionFailed()<br><br></code></pre></td></tr></table></figure>



<h4 id="apns2-credentials-py"><a href="#apns2-credentials-py" class="headerlink" title="apns2/credentials.py"></a>apns2/credentials.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional, Tuple, TYPE_CHECKING<br><br><span class="hljs-keyword">import</span> jwt<br><br><span class="hljs-keyword">from</span> hyper <span class="hljs-keyword">import</span> HTTP20Connection  <span class="hljs-comment"># type: ignore</span><br><span class="hljs-keyword">from</span> hyper.tls <span class="hljs-keyword">import</span> init_context  <span class="hljs-comment"># type: ignore</span><br><br><span class="hljs-keyword">if</span> TYPE_CHECKING:<br>    <span class="hljs-keyword">from</span> hyper.ssl_compat <span class="hljs-keyword">import</span> SSLContext  <span class="hljs-comment"># type: ignore</span><br><br>DEFAULT_TOKEN_LIFETIME = <span class="hljs-number">3600</span><br>DEFAULT_TOKEN_ENCRYPTION_ALGORITHM = <span class="hljs-string">&#x27;ES256&#x27;</span><br><br><br><span class="hljs-comment"># Abstract Base class. This should not be instantiated directly.</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Credentials</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, ssl_context: <span class="hljs-string">&#x27;Optional[SSLContext]&#x27;</span> = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        super().__init__()<br>        self.__ssl_context = ssl_context<br><br>    <span class="hljs-comment"># Creates a connection with the credentials, if available or necessary.</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_connection</span>(<span class="hljs-params">self, server: str, port: int, proto: Optional[str], proxy_host: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                          proxy_port: Optional[int] = None</span>) -&gt; HTTP20Connection:</span><br>        <span class="hljs-comment"># self.__ssl_context may be none, and that&#x27;s fine.</span><br>        <span class="hljs-keyword">return</span> HTTP20Connection(server, port, ssl_context=self.__ssl_context, force_proto=proto <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;h2&#x27;</span>,<br>                                secure=<span class="hljs-literal">True</span>, proxy_host=proxy_host, proxy_port=proxy_port)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_authorization_header</span>(<span class="hljs-params">self, topic: Optional[str]</span>) -&gt; Optional[str]:</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-comment"># Credentials subclass for certificate authentication</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CertificateCredentials</span>(<span class="hljs-params">Credentials</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, cert_file: Optional[str] = None, password: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                 cert_chain: Optional[str] = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        ssl_context = init_context(cert=cert_file, cert_password=password)<br>        <span class="hljs-keyword">if</span> cert_chain:<br>            ssl_context.load_cert_chain(cert_chain)<br>        super(CertificateCredentials, self).__init__(ssl_context)<br><br><br><span class="hljs-comment"># Credentials subclass for JWT token based authentication</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenCredentials</span>(<span class="hljs-params">Credentials</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, auth_key_path: str, auth_key_id: str, team_id: str,</span></span><br><span class="hljs-function"><span class="hljs-params">                 encryption_algorithm: str = DEFAULT_TOKEN_ENCRYPTION_ALGORITHM,</span></span><br><span class="hljs-function"><span class="hljs-params">                 token_lifetime: int = DEFAULT_TOKEN_LIFETIME</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        self.__auth_key = self._get_signing_key(auth_key_path)<br>        self.__auth_key_id = auth_key_id<br>        self.__team_id = team_id<br>        self.__encryption_algorithm = encryption_algorithm<br>        self.__token_lifetime = token_lifetime<br><br>        self.__jwt_token = <span class="hljs-literal">None</span>  <span class="hljs-comment"># type: Optional[Tuple[float, str]]</span><br><br>        <span class="hljs-comment"># Use the default constructor because we don&#x27;t have an SSL context</span><br>        super(TokenCredentials, self).__init__()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_authorization_header</span>(<span class="hljs-params">self, topic: Optional[str]</span>) -&gt; str:</span><br>        token = self._get_or_create_topic_token()<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;bearer %s&#x27;</span> % token<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_is_expired_token</span>(<span class="hljs-params">issue_date: float</span>) -&gt; bool:</span><br>        <span class="hljs-keyword">return</span> time.time() &gt; issue_date + DEFAULT_TOKEN_LIFETIME<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_signing_key</span>(<span class="hljs-params">key_path: str</span>) -&gt; str:</span><br>        secret = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> key_path:<br>            <span class="hljs-keyword">with</span> open(key_path) <span class="hljs-keyword">as</span> f:<br>                secret = f.read()<br>        <span class="hljs-keyword">return</span> secret<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_or_create_topic_token</span>(<span class="hljs-params">self</span>) -&gt; str:</span><br>        <span class="hljs-comment"># dict of topic to issue date and JWT token</span><br>        token_pair = self.__jwt_token<br>        <span class="hljs-keyword">if</span> token_pair <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> self._is_expired_token(token_pair[<span class="hljs-number">0</span>]):<br>            <span class="hljs-comment"># Create a new token</span><br>            issued_at = time.time()<br>            token_dict = &#123;<br>                <span class="hljs-string">&#x27;iss&#x27;</span>: self.__team_id,<br>                <span class="hljs-string">&#x27;iat&#x27;</span>: issued_at,<br>            &#125;<br>            headers = &#123;<br>                <span class="hljs-string">&#x27;alg&#x27;</span>: self.__encryption_algorithm,<br>                <span class="hljs-string">&#x27;kid&#x27;</span>: self.__auth_key_id,<br>            &#125;<br>            jwt_token = jwt.encode(token_dict, self.__auth_key,<br>                                   algorithm=self.__encryption_algorithm,<br>                                   headers=headers).decode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br><br>            <span class="hljs-comment"># Cache JWT token for later use. One JWT token per connection.</span><br>            <span class="hljs-comment"># https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/establishing_a_token-based_connection_to_apns</span><br>            self.__jwt_token = (issued_at, jwt_token)<br>            <span class="hljs-keyword">return</span> jwt_token<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> token_pair[<span class="hljs-number">1</span>]<br><br></code></pre></td></tr></table></figure>



<h4 id="apns2-errors-py"><a href="#apns2-errors-py" class="headerlink" title="apns2/errors.py"></a>apns2/errors.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Type, Optional<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">APNsException</span>(<span class="hljs-params">Exception</span>):</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionFailed</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;There was an error connecting to APNs.&quot;&quot;&quot;</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InternalException</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;This exception should not be raised. If it is, please report this as a bug.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadPayloadException</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Something bad with the payload.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadCollapseId</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The collapse identifier exceeds the maximum allowed size&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadDeviceToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The specified device token was bad.</span><br><span class="hljs-string">    Verify that the request contains a valid token and that the token matches the environment.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadExpirationDate</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-expiration value is bad.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadMessageId</span>(<span class="hljs-params">InternalException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-id value is bad.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadPriority</span>(<span class="hljs-params">InternalException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-priority value is bad.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadTopic</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-topic was invalid.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeviceTokenNotForTopic</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The device token does not match the specified topic.&quot;&quot;&quot;</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DuplicateHeaders</span>(<span class="hljs-params">InternalException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;One or more headers were repeated.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IdleTimeout</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Idle time out.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MissingDeviceToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The device token is not specified in the request :path.</span><br><span class="hljs-string">    Verify that the :path header contains the device token.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MissingTopic</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-topic header of the request was not specified and was required.</span><br><span class="hljs-string">    The apns-topic header is mandatory when the client is connected using a certificate</span><br><span class="hljs-string">    that supports multiple topics.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayloadEmpty</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The message payload was empty.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TopicDisallowed</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Pushing to this topic is not allowed.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadCertificate</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The certificate was bad.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadCertificateEnvironment</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The client certificate was for the wrong environment.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExpiredProviderToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The provider token is stale and a new token should be generated.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Forbidden</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The specified action is not allowed.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvalidProviderToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The provider token is not valid or the token signature could not be verified.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MissingProviderToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;No provider certificate was used to connect to APNs and Authorization header was missing or no provider token</span><br><span class="hljs-string">    was specified. &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadPath</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The request contained a bad :path value.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodNotAllowed</span>(<span class="hljs-params">InternalException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The specified :method was not POST.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Unregistered</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The device token is inactive for the specified topic.&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, timestamp: Optional[str] = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        super(Unregistered, self).__init__()<br><br>        self.timestamp = timestamp<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayloadTooLarge</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The message payload was too large. The maximum payload size is 4096 bytes.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TooManyProviderTokenUpdates</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The provider token is being updated too often.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TooManyRequests</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Too many requests were made consecutively to the same device token.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InternalServerError</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;An internal server error occurred.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceUnavailable</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The service is unavailable.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Shutdown</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The server is shutting down.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exception_class_for_reason</span>(<span class="hljs-params">reason: str</span>) -&gt; Type[APNsException]:</span><br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-string">&#x27;BadCollapseId&#x27;</span>: BadCollapseId,<br>        <span class="hljs-string">&#x27;BadDeviceToken&#x27;</span>: BadDeviceToken,<br>        <span class="hljs-string">&#x27;BadExpirationDate&#x27;</span>: BadExpirationDate,<br>        <span class="hljs-string">&#x27;BadMessageId&#x27;</span>: BadMessageId,<br>        <span class="hljs-string">&#x27;BadPriority&#x27;</span>: BadPriority,<br>        <span class="hljs-string">&#x27;BadTopic&#x27;</span>: BadTopic,<br>        <span class="hljs-string">&#x27;DeviceTokenNotForTopic&#x27;</span>: DeviceTokenNotForTopic,<br>        <span class="hljs-string">&#x27;DuplicateHeaders&#x27;</span>: DuplicateHeaders,<br>        <span class="hljs-string">&#x27;IdleTimeout&#x27;</span>: IdleTimeout,<br>        <span class="hljs-string">&#x27;MissingDeviceToken&#x27;</span>: MissingDeviceToken,<br>        <span class="hljs-string">&#x27;MissingTopic&#x27;</span>: MissingTopic,<br>        <span class="hljs-string">&#x27;PayloadEmpty&#x27;</span>: PayloadEmpty,<br>        <span class="hljs-string">&#x27;TopicDisallowed&#x27;</span>: TopicDisallowed,<br>        <span class="hljs-string">&#x27;BadCertificate&#x27;</span>: BadCertificate,<br>        <span class="hljs-string">&#x27;BadCertificateEnvironment&#x27;</span>: BadCertificateEnvironment,<br>        <span class="hljs-string">&#x27;ExpiredProviderToken&#x27;</span>: ExpiredProviderToken,<br>        <span class="hljs-string">&#x27;Forbidden&#x27;</span>: Forbidden,<br>        <span class="hljs-string">&#x27;InvalidProviderToken&#x27;</span>: InvalidProviderToken,<br>        <span class="hljs-string">&#x27;MissingProviderToken&#x27;</span>: MissingProviderToken,<br>        <span class="hljs-string">&#x27;BadPath&#x27;</span>: BadPath,<br>        <span class="hljs-string">&#x27;MethodNotAllowed&#x27;</span>: MethodNotAllowed,<br>        <span class="hljs-string">&#x27;Unregistered&#x27;</span>: Unregistered,<br>        <span class="hljs-string">&#x27;PayloadTooLarge&#x27;</span>: PayloadTooLarge,<br>        <span class="hljs-string">&#x27;TooManyProviderTokenUpdates&#x27;</span>: TooManyProviderTokenUpdates,<br>        <span class="hljs-string">&#x27;TooManyRequests&#x27;</span>: TooManyRequests,<br>        <span class="hljs-string">&#x27;InternalServerError&#x27;</span>: InternalServerError,<br>        <span class="hljs-string">&#x27;ServiceUnavailable&#x27;</span>: ServiceUnavailable,<br>        <span class="hljs-string">&#x27;Shutdown&#x27;</span>: Shutdown,<br>    &#125;[reason]<br><br></code></pre></td></tr></table></figure>



<h4 id="apns2-payload-py"><a href="#apns2-payload-py" class="headerlink" title="apns2/payload.py"></a>apns2/payload.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any, Dict, List, Optional, Union, Iterable<br><br>MAX_PAYLOAD_SIZE = <span class="hljs-number">4096</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayloadAlert</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params"></span></span><br><span class="hljs-function"><span class="hljs-params">            self,</span></span><br><span class="hljs-function"><span class="hljs-params">            title: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            title_localized_key: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            title_localized_args: Optional[List[str]] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            body: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            body_localized_key: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            body_localized_args: Optional[List[str]] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            action_localized_key: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            action: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            launch_image: Optional[str] = None</span></span><br><span class="hljs-function"><span class="hljs-params">    </span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        self.title = title<br>        self.title_localized_key = title_localized_key<br>        self.title_localized_args = title_localized_args<br>        self.body = body<br>        self.body_localized_key = body_localized_key<br>        self.body_localized_args = body_localized_args<br>        self.action_localized_key = action_localized_key<br>        self.action = action<br>        self.launch_image = launch_image<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict</span>(<span class="hljs-params">self</span>) -&gt; Dict[str, Any]:</span><br>        result = &#123;&#125;  <span class="hljs-comment"># type: Dict[str, Any]</span><br><br>        <span class="hljs-keyword">if</span> self.title:<br>            result[<span class="hljs-string">&#x27;title&#x27;</span>] = self.title<br>        <span class="hljs-keyword">if</span> self.title_localized_key:<br>            result[<span class="hljs-string">&#x27;title-loc-key&#x27;</span>] = self.title_localized_key<br>        <span class="hljs-keyword">if</span> self.title_localized_args:<br>            result[<span class="hljs-string">&#x27;title-loc-args&#x27;</span>] = self.title_localized_args<br><br>        <span class="hljs-keyword">if</span> self.body:<br>            result[<span class="hljs-string">&#x27;body&#x27;</span>] = self.body<br>        <span class="hljs-keyword">if</span> self.body_localized_key:<br>            result[<span class="hljs-string">&#x27;loc-key&#x27;</span>] = self.body_localized_key<br>        <span class="hljs-keyword">if</span> self.body_localized_args:<br>            result[<span class="hljs-string">&#x27;loc-args&#x27;</span>] = self.body_localized_args<br><br>        <span class="hljs-keyword">if</span> self.action_localized_key:<br>            result[<span class="hljs-string">&#x27;action-loc-key&#x27;</span>] = self.action_localized_key<br>        <span class="hljs-keyword">if</span> self.action:<br>            result[<span class="hljs-string">&#x27;action&#x27;</span>] = self.action<br><br>        <span class="hljs-keyword">if</span> self.launch_image:<br>            result[<span class="hljs-string">&#x27;launch-image&#x27;</span>] = self.launch_image<br><br>        <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Payload</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params"></span></span><br><span class="hljs-function"><span class="hljs-params">            self,</span></span><br><span class="hljs-function"><span class="hljs-params">            alert: Union[PayloadAlert, str, None] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            badge: Optional[int] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            sound: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            category: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            url_args: Optional[Iterable[str]] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            custom: Optional[Dict[str, Any]] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            thread_id: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            content_available: bool = False,</span></span><br><span class="hljs-function"><span class="hljs-params">            mutable_content: bool = False,</span></span><br><span class="hljs-function"><span class="hljs-params">    </span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        self.alert = alert<br>        self.badge = badge<br>        self.sound = sound<br>        self.content_available = content_available<br>        self.category = category<br>        self.url_args = url_args<br>        self.custom = custom<br>        self.mutable_content = mutable_content<br>        self.thread_id = thread_id<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict</span>(<span class="hljs-params">self</span>) -&gt; Dict[str, Any]:</span><br>        result = &#123;<br>            <span class="hljs-string">&#x27;aps&#x27;</span>: &#123;&#125;<br>        &#125;  <span class="hljs-comment"># type: Dict[str, Any]</span><br><br>        <span class="hljs-keyword">if</span> self.alert <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> isinstance(self.alert, PayloadAlert):<br>                result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;alert&#x27;</span>] = self.alert.dict()<br>            <span class="hljs-keyword">else</span>:<br>                result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;alert&#x27;</span>] = self.alert<br>        <span class="hljs-keyword">if</span> self.badge <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;badge&#x27;</span>] = self.badge<br>        <span class="hljs-keyword">if</span> self.sound <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;sound&#x27;</span>] = self.sound<br>        <span class="hljs-keyword">if</span> self.content_available:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;content-available&#x27;</span>] = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> self.mutable_content:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;mutable-content&#x27;</span>] = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> self.thread_id <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;thread-id&#x27;</span>] = self.thread_id<br>        <span class="hljs-keyword">if</span> self.category <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;category&#x27;</span>] = self.category<br>        <span class="hljs-keyword">if</span> self.url_args <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;url-args&#x27;</span>] = self.url_args<br>        <span class="hljs-keyword">if</span> self.custom <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result.update(self.custom)<br><br>        <span class="hljs-keyword">return</span> result<br><br></code></pre></td></tr></table></figure>

<p>参考文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CommunicatingwithAPNs.html#//apple_ref/doc/uid/TP40008194-CH11-SW1">苹果官网原文</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Pr0Ger/PyAPNs2">PyAPNs2三方库地址</a></li>
</ul>
<h3 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h3><p>本地mac环境没有问题，但是部署到linux上报错。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">line 37 ssl_context = init_context(cert=cert_file, cert_password=password)  # 报错位置<br>ssl.SSLError: [SSL: CA_MD_TOO_WEAK] ca md too weak (_ssl.c:3880)  # 错误信息<br></code></pre></td></tr></table></figure>

<blockquote>
<p>hyper使用的Openssl新版本不兼容导致</p>
</blockquote>
<p><strong>解决办法：</strong></p>
<p>1、修改<code>/etc/ssl/openssl.cnf</code> 文件，设置<code>CipherString = DEFAULT@SECLEVEL=1</code> （推荐）</p>
<p>2、降级openssl版本为<code>1.1.1</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Pr0Ger/PyAPNs2/issues/103">相关issue</a></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/Myblog/categories/%E6%8E%A8%E9%80%81/">推送</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/Myblog/tags/%E6%8E%A8%E9%80%81/">推送</a>
                    
                      <a class="hover-with-bg" href="/Myblog/tags/APNs2/">APNs2</a>
                    
                      <a class="hover-with-bg" href="/Myblog/tags/ios/">ios</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/Myblog/2020/03/17/Celery-Rabbitmq%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E8%B0%83%E5%BA%A6/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Celery+Rabbitmq实现异步调度</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/Myblog/2020/03/01/Python%E6%B3%A8%E5%86%8Cwindows%E6%9C%8D%E5%8A%A1/">
                        <span class="hidden-mobile">Python注册windows服务</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                

              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/Myblog/js/events.js" ></script>
<script  src="/Myblog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/Myblog/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>






  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/Myblog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/Myblog/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/Myblog/js/boot.js" ></script>


</body>
</html>
