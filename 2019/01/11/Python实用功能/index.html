

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/Myblog/img/favicon.png">
  <link rel="icon" href="/Myblog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="Simple, so charming!">
  <meta name="author" content="stellae">
  <meta name="keywords" content="">
  
  <title>Python实用功能 - stellae&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/Myblog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/Myblog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"stellae.gitee.io","root":"/Myblog/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/Myblog/js/utils.js" ></script>
  <script  src="/Myblog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 40vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/Myblog/">&nbsp;<strong>stellae's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Myblog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/Myblog/img/WtwSsqwYlA0.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Python实用功能">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      stellae
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2019-01-11 14:28" pubdate>
        2019年1月11日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      174
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Python实用功能</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：1 年前
                
              </p>
            
            <div class="markdown-body">
              <p><strong>网站优化的两大定律：</strong></p>
<ul>
<li>第一定律：使用缓存 - 用空间换时间 - Redis/Memcached</li>
<li>第二定律：使用消息队列 - 能推迟做的事情不要马上做 - 削峰 - 上下游节点解耦合</li>
</ul>
<h4 id="配置日志功能"><a href="#配置日志功能" class="headerlink" title="配置日志功能"></a>配置日志功能</h4><p>在settings文件中配置日志信息</p>
<p>配置日志信息后可以在控制台看到其执行的sql语句。</p>
<p>日志级别：NOTSET &lt; DEBUG &lt; INFO &lt; WARNING &lt; ERROR &lt; FATAL</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python">LOGGING = &#123;<br>    <span class="hljs-string">&#x27;version&#x27;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&#x27;disable_existing_loggers&#x27;</span>: <span class="hljs-literal">False</span>,<br>    <span class="hljs-comment"># 配置日志格式化器</span><br>    <span class="hljs-string">&#x27;formatters&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;simple&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;format&#x27;</span>: <span class="hljs-string">&#x27;%(asctime)s %(module)s.%(funcName)s: %(message)s&#x27;</span>,<br>            <span class="hljs-string">&#x27;datefmt&#x27;</span>: <span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,<br>        &#125;,<br>        <span class="hljs-string">&#x27;verbose&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;format&#x27;</span>: <span class="hljs-string">&#x27;%(asctime)s %(levelname)s [%(process)d-%(threadName)s] &#x27;</span><br>                      <span class="hljs-string">&#x27;%(module)s.%(funcName)s line %(lineno)d: %(message)s&#x27;</span>,<br>            <span class="hljs-string">&#x27;datefmt&#x27;</span>: <span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,<br>        &#125;<br>    &#125;,<br>    <span class="hljs-comment"># 配置日志过滤器</span><br>    <span class="hljs-string">&#x27;filters&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;require_debug_true&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;()&#x27;</span>: <span class="hljs-string">&#x27;django.utils.log.RequireDebugTrue&#x27;</span>,<br>        &#125;,<br>    &#125;,<br>    <span class="hljs-comment"># 配置日志处理器</span><br>    <span class="hljs-string">&#x27;handlers&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;console&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-string">&#x27;logging.StreamHandler&#x27;</span>,<br>            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,<br>            <span class="hljs-string">&#x27;filters&#x27;</span>: [<span class="hljs-string">&#x27;require_debug_true&#x27;</span>],<br>            <span class="hljs-string">&#x27;formatter&#x27;</span>: <span class="hljs-string">&#x27;simple&#x27;</span>,<br>        &#125;,<br>        <span class="hljs-string">&#x27;file1&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-string">&#x27;logging.handlers.TimedRotatingFileHandler&#x27;</span>,<br>            <span class="hljs-string">&#x27;filename&#x27;</span>: <span class="hljs-string">&#x27;access.log&#x27;</span>,<br>            <span class="hljs-comment"># 日志切割方式 - W0 - 星期天切割</span><br>            <span class="hljs-string">&#x27;when&#x27;</span>: <span class="hljs-string">&#x27;W0&#x27;</span>,<br>            <span class="hljs-string">&#x27;backupCount&#x27;</span>: <span class="hljs-number">12</span>,<br>            <span class="hljs-string">&#x27;formatter&#x27;</span>: <span class="hljs-string">&#x27;simple&#x27;</span>,<br>            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;INFO&#x27;</span>,<br>        &#125;,<br>        <span class="hljs-string">&#x27;file2&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-string">&#x27;logging.handlers.TimedRotatingFileHandler&#x27;</span>,<br>            <span class="hljs-string">&#x27;filename&#x27;</span>: <span class="hljs-string">&#x27;error.log&#x27;</span>,<br>            <span class="hljs-comment"># 日志切割方式 - D - 每天一切割</span><br>            <span class="hljs-string">&#x27;when&#x27;</span>: <span class="hljs-string">&#x27;D&#x27;</span>,<br>            <span class="hljs-string">&#x27;backupCount&#x27;</span>: <span class="hljs-number">31</span>,<br>            <span class="hljs-string">&#x27;formatter&#x27;</span>: <span class="hljs-string">&#x27;verbose&#x27;</span>,<br>            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;WARNING&#x27;</span>,<br>        &#125;,<br>    &#125;,<br>    <span class="hljs-comment"># 配置日志器</span><br>    <span class="hljs-string">&#x27;loggers&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;django&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;handlers&#x27;</span>: [<span class="hljs-string">&#x27;console&#x27;</span>, <span class="hljs-string">&#x27;file1&#x27;</span>, <span class="hljs-string">&#x27;file2&#x27;</span>],<br>            <span class="hljs-string">&#x27;propagate&#x27;</span>: <span class="hljs-literal">True</span>,<br>            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,<br>        &#125;,<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="DEBUG开发工具"><a href="#DEBUG开发工具" class="headerlink" title="DEBUG开发工具"></a>DEBUG开发工具</h4><p>如果希望在页面上看到SQL执行语句或者其他信息，可以把日志级别调整到WARNING，安装一个第三方库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install django-debug-toolbar<br></code></pre></td></tr></table></figure>

<p>进行配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># settings.py</span><br><br>INSTALLED_APPS = [<br>    <span class="hljs-string">&#x27;debug_toolbar&#x27;</span>,<br>]<br><br>DEBUG_TOOLBAR_CONFIG = &#123;<br>    <span class="hljs-string">&#x27;JQUERY_URL&#x27;</span>: <span class="hljs-string">&#x27;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&#x27;</span>,<br>    <span class="hljs-string">&#x27;SHOW_COLLAPSED&#x27;</span>: <span class="hljs-literal">True</span>,<br>    <span class="hljs-string">&#x27;SHOW_TOOLBAR_CALLBACK&#x27;</span>: <span class="hljs-keyword">lambda</span> x: <span class="hljs-literal">True</span>,<br>&#125;<br><br>MIDDLEWARE = [<br>    <span class="hljs-string">&#x27;debug_toolbar.middleware.DebugToolbarMiddleware&#x27;</span>,<br>]<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#urls.py</span><br><span class="hljs-comment"># 调试模式开启</span><br><br><span class="hljs-keyword">if</span> settings.DEBUG:<br>    <span class="hljs-keyword">import</span> debug_toolbar<br>    urlpatterns.insert(<span class="hljs-number">0</span>, path(<span class="hljs-string">&quot;__debug__/&quot;</span>, include(debug_toolbar.urls)))<br></code></pre></td></tr></table></figure>

<p>如果出现问题：<code>Throwing AttributeError: &#39;module&#39; object has no attribute &#39;getrusage&#39;</code></p>
<p>解决：重写<code>DEBUG_TOOLBAR_PANELS</code> 并禁用<code>&#39;debug_toolbar.panels.timer.TimerPanel&#39;</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#settings.py</span><br><br><span class="hljs-comment"># DEBUG_TOOLBAR页面配置</span><br>DEBUG_TOOLBAR_PANELS = (<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.versions.VersionsPanel&#x27;</span>,<br>    <span class="hljs-comment"># Throwing AttributeError: &#x27;module&#x27; object has no attribute &#x27;getrusage&#x27;,</span><br>    <span class="hljs-comment"># &#x27;debug_toolbar.panels.timer.TimerPanel&#x27;,</span><br>    <span class="hljs-string">&#x27;debug_toolbar.panels.settings.SettingsPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.headers.HeadersPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.request.RequestPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.sql.SQLPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.cache.CachePanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.staticfiles.StaticFilesPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.templates.TemplatesPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.signals.SignalsPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.logging.LoggingPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.redirects.RedirectsPanel&#x27;</span>,<br>)<br></code></pre></td></tr></table></figure>



<h4 id="Django中配置Redis缓存"><a href="#Django中配置Redis缓存" class="headerlink" title="Django中配置Redis缓存"></a>Django中配置Redis缓存</h4><p>Django默认redis存放在mysql数据库，修改redis作为缓存存放数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python">CACHES = &#123;<br>    <span class="hljs-comment"># 默认缓存</span><br>    <span class="hljs-string">&#x27;default&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,<br>        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: [<br>            <span class="hljs-string">&#x27;redis://39.96.51.36:6379/0&#x27;</span>,<br>        ],<br>        <span class="hljs-string">&#x27;KEY_PREFIX&#x27;</span>: <span class="hljs-string">&#x27;fangtx&#x27;</span>,<br>        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,<br>            <span class="hljs-string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;max_connections&#x27;</span>: <span class="hljs-number">1000</span>,<br>            &#125;,<br>            <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        &#125;<br>    &#125;,<br>    <span class="hljs-comment"># 页面缓存</span><br>    <span class="hljs-string">&#x27;page&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,<br>        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: [<br>            <span class="hljs-string">&#x27;redis://39.96.51.36:6379/1&#x27;</span>,<br>        ],<br>        <span class="hljs-string">&#x27;KEY_PREFIX&#x27;</span>: <span class="hljs-string">&#x27;fangtx:page&#x27;</span>,<br>        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,<br>            <span class="hljs-string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;max_connections&#x27;</span>: <span class="hljs-number">500</span>,<br>            &#125;,<br>            <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        &#125;<br>    &#125;,<br>    <span class="hljs-comment"># 会话缓存, 设定会话放在redis中。</span><br>    <span class="hljs-string">&#x27;session&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,<br>        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: [<br>            <span class="hljs-string">&#x27;redis://39.96.51.36:6379/2&#x27;</span>,<br>        ],<br>        <span class="hljs-string">&#x27;KEY_PREFIX&#x27;</span>: <span class="hljs-string">&#x27;fangtx:session&#x27;</span>,<br>        <span class="hljs-string">&#x27;TIMEOUT&#x27;</span>: <span class="hljs-number">1209600</span>,<br>        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,<br>            <span class="hljs-string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;max_connections&#x27;</span>: <span class="hljs-number">2000</span>,<br>            &#125;,<br>            <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        &#125;<br>    &#125;,<br>    <span class="hljs-comment"># 接口数据缓存</span><br>    <span class="hljs-string">&#x27;api&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,<br>        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: [<br>            <span class="hljs-string">&#x27;redis:///39.96.51.36:6379/3&#x27;</span>,<br>        ],<br>        <span class="hljs-string">&#x27;KEY_PREFIX&#x27;</span>: <span class="hljs-string">&#x27;fangtx:api&#x27;</span>,<br>        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,<br>            <span class="hljs-string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;max_connections&#x27;</span>: <span class="hljs-number">500</span>,<br>            &#125;,<br>            <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        &#125;<br>    &#125;,<br>&#125;<br><span class="hljs-comment"># 基于缓存</span><br>SESSION_ENGINE = <span class="hljs-string">&#x27;django.contrib.sessions.backends.cache&#x27;</span><br>SESSION_CACHE_ALIAS = <span class="hljs-string">&#x27;session&#x27;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>说明：<code>from django.core.cache import cache, caches </code>  其中cache拿到默认的缓存， caches[‘xxx’]拿到指定缓存，django封装的缓存调用方式(弱小但简单)，只能操作字符串类型；<code>from django_redis import  get_redis_connection </code>拿到原生的redis连接。</p>
</blockquote>
<h4 id="获取用户IP"><a href="#获取用户IP" class="headerlink" title="获取用户IP"></a>获取用户IP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_ip_address</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;获得请求的IP地址&quot;&quot;&quot;</span><br>    ip = request.META.get(<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>, <span class="hljs-literal">None</span>)<br>    <span class="hljs-keyword">return</span> ip <span class="hljs-keyword">or</span> request.META[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]<br></code></pre></td></tr></table></figure>

<blockquote>
<p>说明：<code>request.META[&#39;REMOTE_ADDR&#39;]</code> 拿到用户ip，但是上线之后，有可能nginx路由后，有可能拿到的是自己当前服务器的地址，所以先拿<code>request.META.get(&#39;HTTP_X_FORWARDED_FOR&#39;, None)</code> </p>
</blockquote>
<h4 id="文件下载功能"><a href="#文件下载功能" class="headerlink" title="文件下载功能"></a>文件下载功能</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote, unquote<br><span class="hljs-comment"># 将中文字符装换为百分号编码</span><br><br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse, StreamingHttpResponse<br><br><span class="hljs-comment"># 如果要动态生成PDF报表可以使用ReportLab三方库</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;下载文件&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># path = os.path.dirname(__file__)</span><br>    file_stream = open(<span class="hljs-string">&#x27;static/Git工作流程.pdf&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>)<br>    file_iter = iter(<span class="hljs-keyword">lambda</span>: file_stream.read(<span class="hljs-number">4096</span>), <span class="hljs-string">b&#x27;&#x27;</span>)     <span class="hljs-comment"># b&#x27;&#x27;为终止条件</span><br>    <span class="hljs-comment"># StreamingHttpResponse适合下载大文件，传入一个可迭代对象；content_type后加MIME类型，告诉浏览器文件类型。</span><br>    resp = StreamingHttpResponse(file_iter, content_type=<span class="hljs-string">&#x27;application/pdf&#x27;</span>)<br>    filename = quote(<span class="hljs-string">&#x27;Git工作流程.pdf&#x27;</span>)<br>    <span class="hljs-comment"># attachment附件下载 ； inline-内联打开</span><br>    resp[<span class="hljs-string">&#x27;content-disposition&#x27;</span>] = <span class="hljs-string">f&#x27;attachment; filename=&quot;<span class="hljs-subst">&#123;filename&#125;</span>&quot;&#x27;</span><br>    <span class="hljs-keyword">return</span> resp<br></code></pre></td></tr></table></figure>

<blockquote>
<p>说明：</p>
<p>MIME - Multi-purpose Internet Mail Extension 服务器通过指定MIME（content-type）告诉浏览器给的内容是什么性质的内容 </p>
<p>application/json ; text/xml ; application/pdf ; application/msword ; application/msexcel  </p>
<p>image/jpeg ; image/png ; image/gif ; image/webp ; </p>
<p>audio/wav ；video/mp4 ；</p>
<p>HTTP响应头 </p>
<p>content-disposition: inline; filename=”Git.pdf” </p>
<p>content-disposition: attachment; filename=”Git.pdf”  </p>
</blockquote>
<h4 id="导出excel报表"><a href="#导出excel报表" class="headerlink" title="导出excel报表"></a>导出excel报表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote, unquote<br><br><span class="hljs-keyword">import</span> xlwt<br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">from</span> backend.models <span class="hljs-keyword">import</span> Emp<br><br><br>PAGE_SIZE = <span class="hljs-number">10</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_style</span>(<span class="hljs-params">name, *, color=<span class="hljs-number">0</span>, bold=False, italic=False</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;字体函数&quot;&quot;&quot;</span><br>    style = xlwt.XFStyle()<br>    font = xlwt.Font()<br>    font.name = name<br>    font.colour_index = color<br>    font.bold = bold<br>    font.italic = italic<br>    style.font = font<br>    <span class="hljs-keyword">return</span> style<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">export_emp_excel</span>(<span class="hljs-params">request, page</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;导出excel报表&quot;&quot;&quot;</span><br>    workbook = xlwt.Workbook()<br>    sheet = workbook.add_sheet(<span class="hljs-string">&#x27;员工详细信息&#x27;</span>)<br>    titles = [<span class="hljs-string">&#x27;编号&#x27;</span>, <span class="hljs-string">&#x27;姓名&#x27;</span>, <span class="hljs-string">&#x27;职位&#x27;</span>, <span class="hljs-string">&#x27;主管&#x27;</span>, <span class="hljs-string">&#x27;工资&#x27;</span>, <span class="hljs-string">&#x27;部门&#x27;</span>]<br>    <span class="hljs-keyword">for</span> col, title <span class="hljs-keyword">in</span> enumerate(titles):<br>        sheet.write(<span class="hljs-number">0</span>, col, title)<br>    props = (<span class="hljs-string">&#x27;no&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;job&#x27;</span>, <span class="hljs-string">&#x27;mgr&#x27;</span>, <span class="hljs-string">&#x27;sal&#x27;</span>, <span class="hljs-string">&#x27;dept&#x27;</span>)<br>    <span class="hljs-comment"># 如果查询对象的同时还要查询它的关联对象，那么必须对自动生成的SQL语句进行优化，否则会引发1+N查询(程序性能低下并且数据库压力很大)</span><br>    <span class="hljs-comment"># 如果有多对一关联，需要用连接查询加载关联对象，那么可以用select_related()来加载</span><br>    <span class="hljs-comment"># 如果有多对多关联，需要用连接查询加载关联对象，那么可以用prefetch_related()来加载</span><br>    start, end = (page - <span class="hljs-number">1</span>) * PAGE_SIZE, page * PAGE_SIZE<br>    <span class="hljs-comment"># only()和defer()方法来进行SQL投影操作 - 只显示某些列/不显示</span><br>    emps = Emp.objects.all().only(*props).select_related(<span class="hljs-string">&#x27;mgr&#x27;</span>).\<br>               select_related(<span class="hljs-string">&#x27;dept&#x27;</span>).order_by(<span class="hljs-string">&#x27;-sal&#x27;</span>)[start: end]<br>    <span class="hljs-keyword">for</span> row, emp <span class="hljs-keyword">in</span> enumerate(emps):<br>        <span class="hljs-keyword">for</span> col, prop <span class="hljs-keyword">in</span> enumerate(props):<br>            val = getattr(emp, prop, <span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">if</span> isinstance(val, (Dept, Emp)):<br>                val = val.name<br>            sheet.write(row+<span class="hljs-number">1</span>, col, val, get_style(<span class="hljs-string">&#x27;&#x27;</span>, color=<span class="hljs-number">2</span>, bold=<span class="hljs-literal">True</span>))<br>    <span class="hljs-comment"># str - 只读字符串    StringIO - 可写字符串</span><br>    <span class="hljs-comment"># bytes - 只读字节串    BytesIO - 可写字节串</span><br>    buffer = BytesIO()<br>    <span class="hljs-comment"># 提取Excel表格</span><br>    workbook.save(buffer)<br>    <span class="hljs-comment"># 生成响应对象传输数据给浏览器</span><br>    resp = HttpResponse(buffer.getvalue(), content_type=<span class="hljs-string">&#x27;application/msexcel&#x27;</span>)<br>    filename = quote(<span class="hljs-string">&#x27;员工信息表.xls&#x27;</span>)<br>    resp[<span class="hljs-string">&#x27;content-disposition&#x27;</span>] = <span class="hljs-string">f&#x27;attachment; filename=&quot;<span class="hljs-subst">&#123;filename&#125;</span>&quot;&#x27;</span><br>    <span class="hljs-keyword">return</span> resp<br></code></pre></td></tr></table></figure>

<blockquote>
<p>说明：查询数据库操作应该加上only()和defer()，优化数据库性能；如果查询语句中有关联关系，用<code>select_related(&#39;mgr&#39;)</code>对SQL语句进行优化，不然会引发1+N查询，导致性能极其低下；BytesIO()是内存中可变字节区域。</p>
</blockquote>
<blockquote>
<p><code>select_related(&#39;xxx&#39;)</code> 是一对多的预加载；<code>prefetch_related(&#39;xxx&#39;)</code>是多对多的预加载。</p>
</blockquote>
<h4 id="生成word文档"><a href="#生成word文档" class="headerlink" title="生成word文档"></a>生成word文档</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> python-docx<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> docx<br><span class="hljs-keyword">from</span> docx.enum.text <span class="hljs-keyword">import</span> WD_PARAGRAPH_ALIGNMENT<br><span class="hljs-keyword">from</span> docx.shared <span class="hljs-keyword">import</span> Pt<br><span class="hljs-keyword">from</span> docx.oxml.ns <span class="hljs-keyword">import</span> qn<br><span class="hljs-keyword">from</span> docx.shared <span class="hljs-keyword">import</span> RGBColor<br><br><br>document = docx.Document()<br><br><span class="hljs-comment"># 设置全局字体</span><br>document.styles[<span class="hljs-string">&#x27;Normal&#x27;</span>].font.name = <span class="hljs-string">u&#x27;宋体&#x27;</span><br>document.styles[<span class="hljs-string">&#x27;Normal&#x27;</span>].font.size = Pt(<span class="hljs-number">14</span>)   <span class="hljs-comment"># 四号</span><br>document.styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]._element.rPr.rFonts.set(qn(<span class="hljs-string">&#x27;w:eastAsia&#x27;</span>), <span class="hljs-string">u&#x27;宋体&#x27;</span>)<br><br><span class="hljs-comment"># 设置页眉</span><br>section = document.sections[<span class="hljs-number">0</span>]<br>header = section.header<br>paragraph1 = header.paragraphs[<span class="hljs-number">0</span>]<br>paragraph1.alignment = WD_PARAGRAPH_ALIGNMENT.CENTER   <span class="hljs-comment"># 居中</span><br>t1 = paragraph1.add_run(<span class="hljs-string">&quot;广告监测系统&quot;</span>)<br>t1.underline = <span class="hljs-literal">True</span><br>t1.font.size = Pt(<span class="hljs-number">9</span>)   <span class="hljs-comment"># 小五</span><br><br><span class="hljs-comment"># 段落1</span><br>paragraph2 = document.add_paragraph()<br>paragraph2.paragraph_format.alignment = WD_PARAGRAPH_ALIGNMENT.CENTER<br>t2 = paragraph2.add_run(<span class="hljs-string">&quot;单一广告监测报告&quot;</span>)<br><span class="hljs-comment"># 设置字号</span><br>t2.font.size = Pt(<span class="hljs-number">36</span>)   <span class="hljs-comment"># 小初</span><br><span class="hljs-comment"># 加粗</span><br>t2.bold = <span class="hljs-literal">True</span><br><span class="hljs-comment"># 设置字体</span><br>t2.font.name = <span class="hljs-string">u&quot;隶书&quot;</span><br>t2._element.rPr.rFonts.set(qn(<span class="hljs-string">&#x27;w:eastAsia&#x27;</span>), <span class="hljs-string">u&quot;隶书&quot;</span>)<br><br><span class="hljs-comment"># 换行</span><br>document.add_paragraph(text=<span class="hljs-string">&#x27;&#x27;</span>, style=<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 换行</span><br><br><span class="hljs-comment"># 换页</span><br><span class="hljs-comment"># document.paragraphs[0].runs[0].add_break(docx.enum.text.WD_BREAK.PAGE)</span><br><br><span class="hljs-comment"># 段落2</span><br>paragraph3 = document.add_paragraph()<br><span class="hljs-comment"># 一个段落里面可以添加多个add_run</span><br>t3 = paragraph3.add_run(<span class="hljs-string">&quot;段落一，使用&quot;</span>)<br>t4 = paragraph3.add_run(<span class="hljs-string">&quot; 「全局字体」 &quot;</span>)<br><span class="hljs-comment"># 下划线</span><br>t4.underline = <span class="hljs-literal">True</span><br><span class="hljs-comment"># 设置RGB值</span><br>t4.font.color.rgb = RGBColor(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">238</span>)<br><br>document.save(<span class="hljs-string">&#x27;./docx-text.docx&#x27;</span>)<br><br></code></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#all_caps       =&gt;  全部大写字母</span><br><span class="hljs-comment">#bold           =&gt;  加粗</span><br><span class="hljs-comment">#color          =&gt;  字体颜色</span><br><span class="hljs-comment">#complex_script =&gt;  是否为“复杂代码”</span><br><span class="hljs-comment">#cs_bold        =&gt;  “复杂代码”加粗</span><br><span class="hljs-comment">#cs_italic      =&gt;  “复杂代码”斜体</span><br><span class="hljs-comment">#double_strike  =&gt;  双删除线</span><br><span class="hljs-comment">#emboss         =&gt;  文本以凸出页面的方式出现</span><br><span class="hljs-comment">#hidden         =&gt;  隐藏</span><br><span class="hljs-comment">#imprint        =&gt;  印记</span><br><span class="hljs-comment">#italic         =&gt;  斜体</span><br><span class="hljs-comment">#name           =&gt;  字体</span><br><span class="hljs-comment">#no_proof       =&gt;  不验证语法错误</span><br><span class="hljs-comment">#outline        =&gt;  显示字符的轮廓</span><br><span class="hljs-comment">#shadow         =&gt;  阴影</span><br><span class="hljs-comment">#small_caps     =&gt;  小型大写字母</span><br><span class="hljs-comment">#snap_to_grid   =&gt;  定义文档网格时对齐网络</span><br><span class="hljs-comment">#strike         =&gt;  删除线</span><br><span class="hljs-comment">#subscript      =&gt;  下标</span><br><span class="hljs-comment">#superscript    =&gt;  上标</span><br><span class="hljs-comment">#underline      =&gt;  下划线</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="生成临时文件"><a href="#生成临时文件" class="headerlink" title="生成临时文件"></a>生成临时文件</h4><p>Python内置tempfile库用户生成临时文件，使用完毕会自动销毁。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> tempfile <span class="hljs-keyword">import</span> TemporaryFile, NamedTemporaryFile<br><br>TemporaryFile(mode=<span class="hljs-string">&#x27;w+b&#x27;</span>, buffering=<span class="hljs-literal">None</span>, encoding=<span class="hljs-literal">None</span>, newline=<span class="hljs-literal">None</span>, suffix=<span class="hljs-literal">None</span>, prefix=<span class="hljs-literal">None</span>, dir=<span class="hljs-literal">None</span>, *, errors=<span class="hljs-literal">None</span>)<br><br>NamedTemporaryFile(mode=<span class="hljs-string">&#x27;w+b&#x27;</span>, buffering=<span class="hljs-literal">None</span>, encoding=<span class="hljs-literal">None</span>, newline=<span class="hljs-literal">None</span>, suffix=<span class="hljs-literal">None</span>, prefix=<span class="hljs-literal">None</span>, dir=<span class="hljs-literal">None</span>, delete=<span class="hljs-literal">True</span>, *, errors=<span class="hljs-literal">None</span>)<br><span class="hljs-comment"># TemporaryFile 和 NamedTemporaryFile 区别在于后者有名字，可以用&lt;object&gt;.name 查看临时文件存储路径</span><br></code></pre></td></tr></table></figure>

<ul>
<li>TemporaryFile</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>fp = TemporaryFile()<br><span class="hljs-meta">&gt;&gt;&gt; </span>fp.write(<span class="hljs-string">b&#x27;Hello world!&#x27;</span>)<br><span class="hljs-comment"># read data from file</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>fp.seek(<span class="hljs-number">0</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>fp.read()<br><span class="hljs-string">b&#x27;Hello world!&#x27;</span><br><span class="hljs-comment"># close the file, it will be removed</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>fp.close()<br></code></pre></td></tr></table></figure>

<ul>
<li>NamedTemporaryFile</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">with</span> NamedTemporaryFile(suffix=<span class="hljs-string">&#x27;.xlsx&#x27;</span>) <span class="hljs-keyword">as</span> ntf:<br>  <span class="hljs-comment"># 执行完上下文语句，会自动销毁临时文件</span><br>  ntf.write(<span class="hljs-string">b&#x27;123456&#x27;</span>)<br>  file_path = ntf.name    <span class="hljs-comment"># 临时文件存储绝对路径</span><br></code></pre></td></tr></table></figure>

<ul>
<li>相关坑点</li>
</ul>
<p><strong>经查证，用这种方式创建的临时文件，在linux系统里不关闭文件即可再次打开读取内容，但是在windows系统，不关闭就没有权限再次打开。另外，文件默认的是，一旦关闭，就会被自动清除。所以这里就有了一个矛盾：不关闭文件就没有打开的权限；关闭之后文件就不见了，更无法打开。</strong></p>
<p>要解决这个问题，我们需要三个关键步骤：</p>
<ol>
<li>修改NamedTemporaryFile的参数，让文件关闭后不会自动清理。</li>
<li>读取之前，先关闭。</li>
<li>为了不在电脑里留下垃圾，我们另写一行代码“手动”清理这个临时文件。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> tempfile, json, os<br><br><br>data=[&#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;Jessica&#x27;</span>,<span class="hljs-string">&#x27;lang&#x27;</span>:(<span class="hljs-string">&#x27;Python&#x27;</span>,<span class="hljs-string">&#x27;English&#x27;</span>),<span class="hljs-string">&#x27;age&#x27;</span>:<span class="hljs-number">27</span>&#125;]<br>f=tempfile.NamedTemporaryFile(mode=<span class="hljs-string">&#x27;w&#x27;</span>,delete=<span class="hljs-literal">False</span>)<br><span class="hljs-comment">#注意上面一行，delete设置为False，就不会关闭文件后自动清理了</span><br>json.dump(data,f)<br>f.close()<br><span class="hljs-comment">#再次打开之前一定要先关闭</span><br><br>print(open(f.name,<span class="hljs-string">&#x27;r&#x27;</span>).read())<br>f.close()<br>os.remove(f.name)<br></code></pre></td></tr></table></figure>



<h4 id="前端报表Echarts"><a href="#前端报表Echarts" class="headerlink" title="前端报表Echarts"></a>前端报表Echarts</h4><p>获取自己所需要的报表：<a target="_blank" rel="noopener" href="https://echarts.baidu.com/">Echarts官网</a></p>
<p>使用BootCND在线加载：<a target="_blank" rel="noopener" href="https://www.bootcdn.cn/">BootCND官网</a></p>
<p>示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ECharts<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 引入 echarts.js --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/echarts/4.2.0-rc.2/echarts-en.simple.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><br><span class="css">        <span class="hljs-selector-id">#main</span> &#123;</span><br>            width: 600px;<br>            height: 400px;<br>        &#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>&gt;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 为ECharts准备一个具备大小（宽高）的Dom --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;main&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript">        <span class="hljs-comment">// 获得绘图区域并初始化</span></span><br><span class="javascript">        <span class="hljs-keyword">var</span> myChart = echarts.init($(<span class="hljs-string">&#x27;#main&#x27;</span>)[<span class="hljs-number">0</span>]);</span><br><span class="javascript">        $.get(<span class="hljs-string">&#x27;/backend/agent_bar_data/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>&#123;</span><br><span class="javascript">            <span class="hljs-comment">// 指定图表的配置项和数据(ajax)</span></span><br><span class="javascript">            <span class="hljs-keyword">var</span> option = &#123;</span><br>                title: &#123;<br><span class="javascript">                    text: <span class="hljs-string">&#x27;ECharts 入门示例&#x27;</span></span><br>                &#125;,<br>                tooltip: &#123;&#125;,<br>                legend: &#123;<br><span class="javascript">                    data:[<span class="hljs-string">&#x27;销量&#x27;</span>]</span><br>                &#125;,<br>                xAxis: &#123;<br><span class="javascript">                    data: data[<span class="hljs-string">&#x27;names&#x27;</span>]</span><br>                &#125;,<br>                yAxis: &#123;&#125;,<br>                series: [&#123;<br><span class="javascript">                    name: <span class="hljs-string">&#x27;销量&#x27;</span>,</span><br><span class="javascript">                    type: <span class="hljs-string">&#x27;bar&#x27;</span>,</span><br><span class="javascript">                    data: data[<span class="hljs-string">&#x27;totals&#x27;</span>]</span><br>                &#125;]<br>            &#125;;<br><span class="javascript">            <span class="hljs-comment">// 使用刚指定的配置项和数据显示图表。</span></span><br>            myChart.setOption(option);<br>        &#125;)<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse, StreamingHttpResponse, JsonResponse<br><span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> render<br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> connections<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;index.html&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">agent_bar_data</span>(<span class="hljs-params">request</span>):</span><br>    names, totals = [], []<br>    <span class="hljs-keyword">with</span> connections[<span class="hljs-string">&#x27;default&#x27;</span>].cursor() <span class="hljs-keyword">as</span> cursor:<br>        cursor.execute(<span class="hljs-string">&#x27;select name, total from &#x27;</span><br>                       <span class="hljs-string">&#x27; (select agentid, count(agentid) as total &#x27;</span><br>                       <span class="hljs-string">&#x27; from tb_agent_estate group by agentid) t1 &#x27;</span><br>                       <span class="hljs-string">&#x27; inner join tb_agent t2 on t1.agentid=t2.agentid&#x27;</span>)<br>        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor.fetchall():<br>            <span class="hljs-comment"># fetchall()拿到查询结果，结果为元组</span><br>            names.append(row[<span class="hljs-number">0</span>])<br>            totals.append(row[<span class="hljs-number">1</span>])<br><br>    <span class="hljs-comment"># 如果data参数不是字典而是列表，还要加上safe=False参数</span><br>    <span class="hljs-comment"># 如果字典或列中有自定义对象，那么还需要通过encoder参数指定自定义对象如何做JSON序列化</span><br>    <span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;names&#x27;</span>:names, <span class="hljs-string">&#x27;totals&#x27;</span>: totals&#125;)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>说明： 在django中想要执行原生的SQL语句，<code>from django.db import connections, connection</code> 其中<code>connection</code>拿到默认连接， <code>connections[&#39;xx&#39;]</code>拿到指定连接；</p>
</blockquote>
<h4 id="程序运行输出终端动画"><a href="#程序运行输出终端动画" class="headerlink" title="程序运行输出终端动画"></a>程序运行输出终端动画</h4><p>使用多线程，一个线程运行主程序，一个线程用于输出终端动画</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> itertools<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span>():</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">100</span>):<br>        time.sleep(<span class="hljs-number">10</span>)<br>        print(<span class="hljs-string">&#x27;\n&#x27;</span>, i)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> pool:<br>        future = pool.submit(test)<br>        <span class="hljs-comment"># 输出运行提示</span><br>        symbols = [<span class="hljs-string">&quot;.&quot;</span> * i + <span class="hljs-string">&quot; &quot;</span> * (<span class="hljs-number">4</span> - i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> itertools.cycle(symbols):<br>            <span class="hljs-keyword">if</span> future.done():<br>                print(<span class="hljs-string">&quot;success !&quot;</span>)<br>                <span class="hljs-keyword">break</span><br>            print(<span class="hljs-string">f&quot;\r请求中<span class="hljs-subst">&#123;i&#125;</span>&quot;</span>, end=<span class="hljs-string">&#x27;&#x27;</span>)       <span class="hljs-comment"># 等效: print(f&quot;\r请求中&#123;i&#125;\b&quot;) </span><br>            time.sleep(<span class="hljs-number">0.5</span>)<br>    <span class="hljs-comment"># future.result()  # 阻塞线程直到返回结果</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><code>\r</code> - 光标移动到本行首 ;  <code>\b</code> - 使当前光标向前回退一个位置</p>
</blockquote>
<h4 id="生成图片验证码"><a href="#生成图片验证码" class="headerlink" title="生成图片验证码"></a>生成图片验证码</h4><p>需要用到字体文件<code>&#39;Arial.ttf&#39;, &#39;Georgia.ttf&#39;, &#39;actionj.ttf&#39;</code>，存放在<code>/&lt;项目&gt;/static/fonts/</code>目录下。</p>
<p>captcha.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">图片验证码</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> ImageFilter<br><span class="hljs-keyword">from</span> PIL.ImageDraw <span class="hljs-keyword">import</span> Draw<br><span class="hljs-keyword">from</span> PIL.ImageFont <span class="hljs-keyword">import</span> truetype<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bezier</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;贝塞尔曲线&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.tsequence = tuple([t / <span class="hljs-number">20.0</span> <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> range(<span class="hljs-number">21</span>)])<br>        self.beziers = &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_bezier</span>(<span class="hljs-params">self, n</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制贝塞尔曲线&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">return</span> self.beziers[n]<br>        <span class="hljs-keyword">except</span> KeyError:<br>            combinations = pascal_row(n - <span class="hljs-number">1</span>)<br>            result = []<br>            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> self.tsequence:<br>                tpowers = (t ** i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n))<br>                upowers = ((<span class="hljs-number">1</span> - t) ** i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n - <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>))<br>                coefs = [c * a * b <span class="hljs-keyword">for</span> c, a, b <span class="hljs-keyword">in</span> zip(combinations,<br>                                                      tpowers, upowers)]<br>                result.append(coefs)<br>            self.beziers[n] = result<br>            <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Captcha</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;验证码&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, width, height, fonts=None, color=None</span>):</span><br>        self._image = <span class="hljs-literal">None</span><br>        self._fonts = fonts <span class="hljs-keyword">if</span> fonts <span class="hljs-keyword">else</span> \<br>            [os.path.join(os.path.join(os.path.dirname(os.path.dirname(__file__)), <span class="hljs-string">&#x27;static&#x27;</span>), <span class="hljs-string">&#x27;fonts&#x27;</span>, font)<br>             <span class="hljs-keyword">for</span> font <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;Arial.ttf&#x27;</span>, <span class="hljs-string">&#x27;Georgia.ttf&#x27;</span>, <span class="hljs-string">&#x27;actionj.ttf&#x27;</span>]]<br>        self._color = color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> random_color(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>, random.randint(<span class="hljs-number">220</span>, <span class="hljs-number">255</span>))<br>        self._width, self._height = width, height<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">instance</span>(<span class="hljs-params">cls, width=<span class="hljs-number">200</span>, height=<span class="hljs-number">75</span></span>):</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hasattr(Captcha, <span class="hljs-string">&quot;_instance&quot;</span>):<br>            cls._instance = cls(width, height)<br>        <span class="hljs-keyword">return</span> cls._instance<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">background</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制背景&quot;&quot;&quot;</span><br>        Draw(self._image).rectangle([(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), self._image.size],<br>                                    fill=random_color(<span class="hljs-number">230</span>, <span class="hljs-number">255</span>))<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">smooth</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;平滑图像&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> self._image.filter(ImageFilter.SMOOTH)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">curve</span>(<span class="hljs-params">self, width=<span class="hljs-number">4</span>, number=<span class="hljs-number">6</span>, color=None</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制曲线&quot;&quot;&quot;</span><br>        dx, height = self._image.size<br>        dx /= number<br>        path = [(dx * i, random.randint(<span class="hljs-number">0</span>, height))<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, number)]<br>        bcoefs = Bezier().make_bezier(number - <span class="hljs-number">1</span>)<br>        points = []<br>        <span class="hljs-keyword">for</span> coefs <span class="hljs-keyword">in</span> bcoefs:<br>            points.append(tuple(sum([coef * p <span class="hljs-keyword">for</span> coef, p <span class="hljs-keyword">in</span> zip(coefs, ps)])<br>                                <span class="hljs-keyword">for</span> ps <span class="hljs-keyword">in</span> zip(*path)))<br>        Draw(self._image).line(points, fill=color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> self._color, width=width)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">noise</span>(<span class="hljs-params">self, number=<span class="hljs-number">50</span>, level=<span class="hljs-number">2</span>, color=None</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制扰码&quot;&quot;&quot;</span><br>        width, height = self._image.size<br>        dx, dy = width / <span class="hljs-number">10</span>, height / <span class="hljs-number">10</span><br>        width, height = width - dx, height - dy<br>        draw = Draw(self._image)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(number):<br>            x = int(random.uniform(dx, width))<br>            y = int(random.uniform(dy, height))<br>            draw.line(((x, y), (x + level, y)),<br>                      fill=color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> self._color, width=level)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">text</span>(<span class="hljs-params">self, captcha_text, fonts, font_sizes=None, drawings=None, squeeze_factor=<span class="hljs-number">0.75</span>, color=None</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制文本&quot;&quot;&quot;</span><br>        color = color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> self._color<br>        fonts = tuple([truetype(name, size)<br>                       <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> fonts<br>                       <span class="hljs-keyword">for</span> size <span class="hljs-keyword">in</span> font_sizes <span class="hljs-keyword">or</span> (<span class="hljs-number">65</span>, <span class="hljs-number">70</span>, <span class="hljs-number">75</span>)])<br>        draw = Draw(self._image)<br>        char_images = []<br>        <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> captcha_text:<br>            font = random.choice(fonts)<br>            c_width, c_height = draw.textsize(c, font=font)<br>            char_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (c_width, c_height), (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br>            char_draw = Draw(char_image)<br>            char_draw.text((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), c, font=font, fill=color)<br>            char_image = char_image.crop(char_image.getbbox())<br>            <span class="hljs-keyword">for</span> drawing <span class="hljs-keyword">in</span> drawings:<br>                d = getattr(self, drawing)<br>                char_image = d(char_image)<br>            char_images.append(char_image)<br>        width, height = self._image.size<br>        offset = int((width - sum(int(i.size[<span class="hljs-number">0</span>] * squeeze_factor)<br>                                  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> char_images[:<span class="hljs-number">-1</span>]) -<br>                      char_images[<span class="hljs-number">-1</span>].size[<span class="hljs-number">0</span>]) / <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">for</span> char_image <span class="hljs-keyword">in</span> char_images:<br>            c_width, c_height = char_image.size<br>            mask = char_image.convert(<span class="hljs-string">&#x27;L&#x27;</span>).point(<span class="hljs-keyword">lambda</span> i: i * <span class="hljs-number">1.97</span>)<br>            self._image.paste(char_image,<br>                        (offset, int((height - c_height) / <span class="hljs-number">2</span>)),<br>                        mask)<br>            offset += int(c_width * squeeze_factor)<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">warp</span>(<span class="hljs-params">image, dx_factor=<span class="hljs-number">0.3</span>, dy_factor=<span class="hljs-number">0.3</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;图像扭曲&quot;&quot;&quot;</span><br>        width, height = image.size<br>        dx = width * dx_factor<br>        dy = height * dy_factor<br>        x1 = int(random.uniform(-dx, dx))<br>        y1 = int(random.uniform(-dy, dy))<br>        x2 = int(random.uniform(-dx, dx))<br>        y2 = int(random.uniform(-dy, dy))<br>        warp_image = Image.new(<br>            <span class="hljs-string">&#x27;RGB&#x27;</span>,<br>            (width + abs(x1) + abs(x2), height + abs(y1) + abs(y2)))<br>        warp_image.paste(image, (abs(x1), abs(y1)))<br>        width2, height2 = warp_image.size<br>        <span class="hljs-keyword">return</span> warp_image.transform(<br>            (width, height),<br>            Image.QUAD,<br>            (x1, y1, -x1, height2 - y2, width2 + x2, height2 + y2, width2 - x2, -y1))<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">offset</span>(<span class="hljs-params">image, dx_factor=<span class="hljs-number">0.1</span>, dy_factor=<span class="hljs-number">0.2</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;图像偏移&quot;&quot;&quot;</span><br>        width, height = image.size<br>        dx = int(random.random() * width * dx_factor)<br>        dy = int(random.random() * height * dy_factor)<br>        offset_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (width + dx, height + dy))<br>        offset_image.paste(image, (dx, dy))<br>        <span class="hljs-keyword">return</span> offset_image<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rotate</span>(<span class="hljs-params">image, angle=<span class="hljs-number">25</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;图像旋转&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> image.rotate(random.uniform(-angle, angle),<br>                            Image.BILINEAR, expand=<span class="hljs-number">1</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate</span>(<span class="hljs-params">self, captcha_text=<span class="hljs-string">&#x27;&#x27;</span>, fmt=<span class="hljs-string">&#x27;PNG&#x27;</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;生成验证码(文字和图片)&quot;&quot;&quot;</span><br>        self._image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (self._width, self._height), (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))<br>        self.background()<br>        self.text(captcha_text, self._fonts,<br>                  drawings=[<span class="hljs-string">&#x27;warp&#x27;</span>, <span class="hljs-string">&#x27;rotate&#x27;</span>, <span class="hljs-string">&#x27;offset&#x27;</span>])<br>        self.curve()<br>        self.noise()<br>        self.smooth()<br>        image_bytes = BytesIO()<br>        self._image.save(image_bytes, format=fmt)<br>        <span class="hljs-keyword">return</span> image_bytes.getvalue()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pascal_row</span>(<span class="hljs-params">n=<span class="hljs-number">0</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成Pascal三角第n行&quot;&quot;&quot;</span><br>    result = [<span class="hljs-number">1</span>]<br>    x, numerator = <span class="hljs-number">1</span>, n<br>    <span class="hljs-keyword">for</span> denominator <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, n // <span class="hljs-number">2</span> + <span class="hljs-number">1</span>):<br>        x *= numerator<br>        x /= denominator<br>        result.append(x)<br>        numerator -= <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> n &amp; <span class="hljs-number">1</span> == <span class="hljs-number">0</span>:<br>        result.extend(reversed(result[:<span class="hljs-number">-1</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        result.extend(reversed(result))<br>    <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">random_color</span>(<span class="hljs-params">start=<span class="hljs-number">0</span>, end=<span class="hljs-number">255</span>, opacity=<span class="hljs-number">255</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;获得随机颜色&quot;&quot;&quot;</span><br>    red = random.randint(start, end)<br>    green = random.randint(start, end)<br>    blue = random.randint(start, end)<br>    <span class="hljs-keyword">if</span> opacity <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> red, green, blue<br>    <span class="hljs-keyword">return</span> red, green, blue, opacity<br></code></pre></td></tr></table></figure>

<p>utils.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">工具函数</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><br><br>ALL_CHARS = <span class="hljs-string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_captcha_text</span>(<span class="hljs-params">length=<span class="hljs-number">4</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定长度的图片验证码文字&quot;&quot;&quot;</span><br>    code = StringIO()<br>    chars_len = len(ALL_CHARS)<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(length):<br>        index = random.randrange(chars_len)<br>        code.write(ALL_CHARS[index])<br>    <span class="hljs-keyword">return</span> code.getvalue()<br></code></pre></td></tr></table></figure>

<p>使用方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">from</span> common.captcha <span class="hljs-keyword">import</span> Captcha<br><span class="hljs-keyword">from</span> common.utils <span class="hljs-keyword">import</span> gen_captcha_text<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">captcha</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成验证码&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 随机验证码内容, 可以指定长度</span><br>    code_text = gen_captcha_text()<br>    <span class="hljs-comment"># 将验证码放入session缓存中</span><br>    request.session[<span class="hljs-string">&#x27;code_text&#x27;</span>] = code_text<br>    <span class="hljs-comment"># instance()指定验证码宽高； generate(code_text)生成验证码,返回图片二进制数据</span><br>    code_bytes = Captcha.instance().generate(code_text)<br>    <span class="hljs-keyword">return</span> HttpResponse(code_bytes, content_type=<span class="hljs-string">&#x27;image/png&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>想要在页面上直接显示出图片，可以将二进制图片利用base64编码成字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 修改以上代码</span><br>code_bytes = Captcha.instance().generate(code_text)<br>code_base64_str = base64.b64encode(code_bytes).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>:<span class="hljs-number">200</span>, <span class="hljs-string">&#x27;pic&#x27;</span>:code_base64_str&#125;)<br></code></pre></td></tr></table></figure>

<p>在src前添加data:image/jpeg;base64,+已经encode的二进制代码，就可以在网页端显示出图片</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;captcha_pic&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;data:image/gif;base64,R0lGODlhDwAPAKECAAAAzMzM/////wAAACwAAAAADwAPAAACIISPeQHsrZ5ModrLlN48CXF8m2iQ3YmmKqVlRtW4MLwWACH+H09wdGltaXplZCBieSBVbGVhZCBTbWFydFNhdmVyIQAAOw==&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;150&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;150&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>



<h4 id="生成二维码"><a href="#生成二维码" class="headerlink" title="生成二维码"></a>生成二维码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO, BytesIO<br><br><span class="hljs-keyword">import</span> qrcode<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_qrcode</span>(<span class="hljs-params">data:bytes</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成二维码&quot;&quot;&quot;</span><br>    image = qrcode.make(data)<br>    buffer = BytesIO()<br>    image.save(buffer)<br>    <span class="hljs-keyword">return</span> buffer.getvalue()<br></code></pre></td></tr></table></figure>



<h4 id="脏话检测"><a href="#脏话检测" class="headerlink" title="脏话检测"></a>脏话检测</h4><p>基于脏话统计库匹配(非正则)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*-coding:utf-8-*-</span><br><span class="hljs-comment"># 敏感词文本文件 filtered_words.txt，里面的内容为以下内容，当用户输入敏感词语时，则打印出 ** is Legal，否则打印出 ** is not Legal</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SenseWord</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.filtered_set = set()  <span class="hljs-comment"># 统计已记录敏感词汇</span><br>        filtered_word = open(<span class="hljs-string">&#x27;./filtered_words.txt&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> filtered_word.readlines():<br>            self.filtered_set.add(line.strip())<br>        filtered_word.close()<br>        print(<span class="hljs-string">&#x27;非法字符串统计库: &#x27;</span>, end=<span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.filtered_set:<br>            print(item, end=<span class="hljs-string">&#x27; / &#x27;</span>)<br>        print()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_legal</span>(<span class="hljs-params">self, check_word</span>):</span><br>        <span class="hljs-keyword">if</span> check_word <span class="hljs-keyword">in</span> self.filtered_set:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    sense_word = SenseWord()<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        check_word = input(<span class="hljs-string">&#x27;请输入检查字符串: &#x27;</span>).strip()<br>        <span class="hljs-keyword">if</span> sense_word.is_legal(check_word):<br>            print(<span class="hljs-string">&#x27;[%s] is Legal!&#x27;</span> % check_word)<br>        <span class="hljs-keyword">else</span>:<br>            print(<span class="hljs-string">&#x27;[%s] is not legal!&#x27;</span> % check_word)<br></code></pre></td></tr></table></figure>

<p>filtered_words.txt</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs txt">北京<br>程序员<br>公务员<br>领导<br>牛比<br>牛逼<br>你娘<br>你妈<br>love<br>sex<br>jiangge<br></code></pre></td></tr></table></figure>





<h4 id="生成密码强度的伪随机值"><a href="#生成密码强度的伪随机值" class="headerlink" title="生成密码强度的伪随机值"></a>生成密码强度的伪随机值</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> secrets<br><span class="hljs-keyword">import</span> string<br><br>characters = string.ascii_letters + string.digits<br>bad_password = <span class="hljs-string">&#x27;&#x27;</span>.join(secrets.choice(characters) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>))<br>print(bad_password)<br><br><span class="hljs-string">&#x27;SRvM54Z1&#x27;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>在这个例子中,我们导入了 <code>secrets</code> 模块和 <code>string</code> 模块. 然后用大写字母和数字组成了一个字符串. 最后使用 <code>secrets</code>模块的 <code>choice()</code> 方法随机地抽取出其中的字符,从而生成一个不够好的密码. 之所以说这个密码不够好是因为密码中没有特殊字符, 但实际上它已经要好过很多人使用的密码了. 还有读者指出,除此之外,这个密码也比较难记,所以很可能会被记录在纸上被人发现. 这当然也对,但是使用字典里的单词作为密码是非常不建议的,你最好习惯这种密码或者使用密码管理软件管理你的密码.</p>
</blockquote>
<h4 id="使用jwt生成token"><a href="#使用jwt生成token" class="headerlink" title="使用jwt生成token"></a>使用jwt生成token</h4><p>调用jwt库,生成json web token，其数据结构包括两部分： headers(标头)，payload(有效载体)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># headers 中一些固定参数名称的意义</span><br>headers = &#123;<br>    <span class="hljs-string">&quot;alg&quot;</span>: <span class="hljs-string">&quot;ES256&quot;</span>,<br>    <span class="hljs-string">&quot;kid&quot;</span>: <span class="hljs-string">&quot;ABC123DEFG&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>jku: 发送JWK的地址；最好用HTTPS来传输</li>
<li>jwk: 就是之前说的JWK</li>
<li>kid: jwk的ID编号</li>
<li>x5u: 指向一组X509公共证书的URL</li>
<li>x5c: X509证书链</li>
<li>x5t：X509证书的SHA-1指纹</li>
<li>x5t：S256: X509证书的SHA-256指纹</li>
<li>typ: 在原本未加密的JWT的基础上增加了 JOSE 和 JOSE+ JSON。JOSE序列化后文会说及。适用于JOSE标头的对象与此JWT混合的情况。</li>
<li>crit: 字符串数组，包含声明的名称，用作实现定义的扩展，必须由 this-&gt;JWT的解析器处理。不常见。</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># payload 中一些固定参数名称的意义, 同时可以在payload中自定义参数</span><br>payload = &#123;<br>    <span class="hljs-string">&quot;iss&quot;</span>: <span class="hljs-string">&quot;DEF123GHIJ&quot;</span>,<br>    <span class="hljs-string">&quot;iat&quot;</span>: time.time()<br> &#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>iss  【issuer】发布者的url地址</li>
<li>sub 【subject】该JWT所面向的用户，用于处理特定应用，不是常用的字段</li>
<li>aud 【audience】接受者的url地址</li>
<li>exp 【expiration】 该jwt销毁的时间；unix时间戳</li>
<li>nbf  【not before】 该jwt的使用时间不能早于该时间；unix时间戳</li>
<li>iat   【issued at】 该jwt的发布时间；unix 时间戳</li>
<li>jti    【JWT ID】 该jwt的唯一ID编号</li>
</ul>
</blockquote>
<p>生成jwt_token</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># jwt.io 获得</span><br>keystring = <span class="hljs-string">&quot;&quot;&quot;-----BEGIN PRIVATE KEY-----</span><br><span class="hljs-string">MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgevZzL1gdAFr88hb2</span><br><span class="hljs-string">OF/2NxApJCzGCEDdfSp6VQO30hyhRANCAAQRWz+jn65BtOMvdyHKcvjBeBSDZH2r</span><br><span class="hljs-string">1RTwjmYSi9R/zpBnuQ4EiMnCqfMPWiZqB4QdbAd0E7oH50VpuZ1P087G</span><br><span class="hljs-string">-----END PRIVATE KEY-----&quot;&quot;&quot;</span><br><br>jwt_token = jwt.encode(payload,  <span class="hljs-comment"># payload, 有效载体</span><br>                       keystring,  <span class="hljs-comment"># 进行加密签名的密钥</span><br>                       algorithm=<span class="hljs-string">&quot;ES256&quot;</span>,  <span class="hljs-comment"># 指明签名算法方式, 默认是HS256</span><br>                       headers=headers  <span class="hljs-comment"># json web token 数据结构包含两部分, payload(有效载体), headers(标头)</span><br>                       ).decode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>JWT 的签名算法有三种:</p>
<ol>
<li>对称加密HMAC【哈希消息验证码】 HS256/HS384/HS512 ,这种加密方式没有公钥,私钥之分, 也就是只有一个密钥, 这种加密方式适用于: 服务器将生成的jwt发送给接收方, 接收方将其返回给服务器, 服务器解析 jwt, 完成身份验证.</li>
<li>非对称加密RSASSA【RSA签名算法】RS256/RS384/RS512</li>
<li>ECDSA【椭圆曲线数据签名算法】 ES256/ES384/ES512</li>
</ol>
<p>不同签名算法使用的签名的密钥不同</p>
</blockquote>
<p>参考 <a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a> </p>
<h4 id="使用secrets生成token"><a href="#使用secrets生成token" class="headerlink" title="使用secrets生成token"></a>使用secrets生成token</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">&gt;&gt;&gt;: secrets.token_bytes()<br><span class="hljs-string">b&#x27;\xd1Od\xe0\xe4\xf8Rn&lt;/U\xf4G\xdb\x08\xa8\x85\xeb\xba&gt;\x8cO\xa7XV\x1cb\xd6\x11\xa0\xcaK&#x27;</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>secrets.token_bytes(<span class="hljs-number">8</span>)<br><span class="hljs-string">b&#x27;\xfc,9y\xbe]\x0e\xfb&#x27;</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>secrets.token_hex(<span class="hljs-number">16</span>)<br><span class="hljs-string">&#x27;6cf3baf51c12ebfcbe26d08b6bbe1ac0&#x27;</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>secrets.token_urlsafe(<span class="hljs-number">16</span>)<br><span class="hljs-string">&#x27;5t_jLGlV8yp2Q5tolvBesQ&#x27;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><code>token_bytes</code> 函数会返回一段随机的包含了n个字节的字节字符串. 我一开始没有指定要生成多少个字节,所以Python自动为我选择了一个合适的长度. 随后我又调用了一次这个函数并且明确指定了生成8个字节长度的字符串. 然后我们又试了一把 <code>token_hex</code> 函数, 它会返回一段随机的十六进制形式的字符串. 最后的 <code>token_urlsafe</code> 函数会返回一段随机的 URL安全的文本字符串. 其文本已经用 Base64 编码过了! 要注意,在实际使用中,你应该至少生成32字节长度的令牌才能够防止被暴力破解所攻破(<a target="_blank" rel="noopener" href="https://docs.python.org/3.6/library/secrets.html#how-many-bytes-should-tokens-use">source</a>).</p>
</blockquote>
<h4 id="使用lru-cache缓存函数结果"><a href="#使用lru-cache缓存函数结果" class="headerlink" title="使用lru_cache缓存函数结果"></a>使用lru_cache缓存函数结果</h4><p><code>lru_cache</code> 使用LRU算法(最近最少使用)，对参数输入以及结果缓存。由于使用字典来缓存结果，因此函数的位置和关键字参数必须是可哈希的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache<br><br><span class="hljs-meta">@lru_cache(maxsize=2)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func_wait</span>(<span class="hljs-params">x</span>):</span><br>    sleep(x)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    start_time = perf_counter()<br>    func_wait(<span class="hljs-number">0.5</span>)    <span class="hljs-comment"># 结果未缓存</span><br>    func_wait(<span class="hljs-number">1</span>)      <span class="hljs-comment"># 结果未缓存</span><br>    func_wait(<span class="hljs-number">0.5</span>)    <span class="hljs-comment"># 结果缓存</span><br>    func_wait(<span class="hljs-number">2</span>)      <span class="hljs-comment"># 结果未缓存</span><br>    func_wait(<span class="hljs-number">1</span>)      <span class="hljs-comment"># 结果未缓存</span><br>    print(<span class="hljs-string">f&#x27;it cost <span class="hljs-subst">&#123;perf_counter()-start_time&#125;</span>s&#x27;</span>)   <span class="hljs-comment"># 4.5s</span><br></code></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>如果将<em>maxsize</em>设置为None，则将禁用LRU功能，并且缓存可以无限增长。</p>
</li>
<li><p>当<em>maxsize</em>为2的幂时，LRU功能表现最佳。</p>
</li>
<li><p>如果将<em>typed</em>设置为true，则将分别缓存不同类型的函数参数。例如，<code>f(3)</code>和<code>f(3.0)</code>将被视为具有不同结果的不同调用。默认为False</p>
</li>
</ul>
</blockquote>
<h4 id="本地配置文件读写"><a href="#本地配置文件读写" class="headerlink" title="本地配置文件读写"></a>本地配置文件读写</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> configparser<br><br><span class="hljs-comment"># 读取配置文件</span><br>config_path = os.path.abspath(os.path.join(os.path.join(__file__, <span class="hljs-string">&quot;../../..&quot;</span>), <span class="hljs-string">&quot;config/config.conf&quot;</span>))<br>conf = configparser.ConfigParser()<br><br><span class="hljs-comment"># 读取</span><br>conf.get(<span class="hljs-string">&quot;section&quot;</span>, <span class="hljs-string">&quot;visitors_browse_item_number&quot;</span>)   <span class="hljs-comment"># str</span><br><span class="hljs-comment"># 写入</span><br><span class="hljs-keyword">with</span> open(config_path, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>  conf.write(f)<br></code></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs conf">[section]<br>new_sale_timedelta &#x3D; 5<br>visitors_browse_item_number &#x3D; 20<br></code></pre></td></tr></table></figure>



<h4 id="手机短信验证码"><a href="#手机短信验证码" class="headerlink" title="手机短信验证码"></a>手机短信验证码</h4><p>调用第三方服务的方式：</p>
<ol>
<li>集成SDK - 安装第三方库</li>
<li>HTTP调用 - 访问URL，交换JSON数据</li>
</ol>
<p>调用三方平台的风险就是时间不可预估，但是我们的应用不能够因为三方平台而阻止， 所以通常调用三方平台而且不需要马上获得执行结果的场景都需要进行异步化的处理。</p>
<p>1、不考虑异步化处理的代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> django_redis <span class="hljs-keyword">import</span>  get_redis_connection<br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> JsonResponse<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">code_phone</span>(<span class="hljs-params">request, mobile</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;发送手机验证码&quot;&quot;&quot;</span><br>    cli = get_redis_connection(alias=<span class="hljs-string">&#x27;default&#x27;</span>)<br>    <span class="hljs-keyword">if</span> cli.get(<span class="hljs-string">f&#x27;mobile_code:<span class="hljs-subst">&#123;mobile&#125;</span>&#x27;</span>):<br>        <span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>: <span class="hljs-number">20000</span>, <span class="hljs-string">&#x27;msg&#x27;</span>: <span class="hljs-string">&#x27;请不要在120s内重复发送手机验证码&#x27;</span>&#125;)<br>    code = gen_mobile_code(length=<span class="hljs-number">6</span>)<br>    cli.set(<span class="hljs-string">f&#x27;mobile_code:<span class="hljs-subst">&#123;mobile&#125;</span>&#x27;</span>, code, ex=<span class="hljs-number">120</span>)<br>    result = send_mobile_code(code=code, mobile=mobile)<br>    <span class="hljs-keyword">return</span> JsonResponse(result)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_mobile_code</span>(<span class="hljs-params">code:str, mobile:str</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;调用手机短信三方接口-山东墨白&quot;&quot;&quot;</span><br>    templateId = <span class="hljs-string">&#x27;TP1801025&#x27;</span><br>    headers = &#123;<span class="hljs-string">&quot;Host&quot;</span>:<span class="hljs-string">&quot;mobai.market.alicloudapi.com&quot;</span>, <span class="hljs-string">&quot;Authorization&quot;</span>:<span class="hljs-string">&quot;APPCODE b9c8d60cf919439dab918dc1cb3c1638&quot;</span>&#125;<br>    url = <span class="hljs-string">f&#x27;http://mobai.market.alicloudapi.com/mobai_sms?param=code:<span class="hljs-subst">&#123;code&#125;</span>&amp;phone=<span class="hljs-subst">&#123;mobile&#125;</span>&amp;templateId=<span class="hljs-subst">&#123;templateId&#125;</span>&#x27;</span><br>    response = requests.post(url=url, headers=headers, timeout=<span class="hljs-number">5</span>)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> json.loads(response.text)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_mobile_code</span>(<span class="hljs-params">length=<span class="hljs-number">6</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定长度的手机验证码&quot;&quot;&quot;</span><br>    code = StringIO()<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(length):<br>        code.write(str(randint(<span class="hljs-number">0</span>, <span class="hljs-number">9</span>)))<br>    <span class="hljs-keyword">return</span> code.getvalue()<br></code></pre></td></tr></table></figure>

<p>2、异步化处理：使用 celery创建生产者和消费者，生产者放入消息队列中即可，消费者进行消费。这里使用redis的list类型做队列。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><span class="hljs-keyword">import</span> celery<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> django_redis <span class="hljs-keyword">import</span>  get_redis_connection<br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> JsonResponse<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">code_phone</span>(<span class="hljs-params">request, mobile</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;发送手机验证码&quot;&quot;&quot;</span><br>    cli = get_redis_connection(alias=<span class="hljs-string">&#x27;default&#x27;</span>)<br>    <span class="hljs-keyword">if</span> cli.get(<span class="hljs-string">f&#x27;mobile_code:<span class="hljs-subst">&#123;mobile&#125;</span>&#x27;</span>):<br>        <span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>: <span class="hljs-number">20000</span>, <span class="hljs-string">&#x27;msg&#x27;</span>: <span class="hljs-string">&#x27;请不要在120s内重复发送手机验证码&#x27;</span>&#125;)<br>    code = gen_mobile_code(length=<span class="hljs-number">6</span>)<br>    cli.set(<span class="hljs-string">f&#x27;mobile_code:<span class="hljs-subst">&#123;mobile&#125;</span>&#x27;</span>, code, ex=<span class="hljs-number">120</span>)<br>    <span class="hljs-comment"># 调用带有@app.task装饰器的函数，需要使用delay函数，让发送短信的函数延迟执行(将函数调用变成一条消息放到消息队列 - 消息的生产者)</span><br>    send_mobile_code.delay(code=code, mobile=mobile)<br>    <span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>: <span class="hljs-number">20000</span>, <span class="hljs-string">&#x27;msg&#x27;</span>: <span class="hljs-string">&#x27;短信验证码已经发出&#x27;</span>&#125;)<br><br><span class="hljs-comment"># 注册环境变量（注册Django配置文件）</span><br>os.environ.setdefault(<span class="hljs-string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="hljs-string">&#x27;Fangtx.settings&#x27;</span>)<br><span class="hljs-comment"># common.views模块名，broker消息代理(从哪里获取消息队列服务)</span><br>app = celery.Celery(<span class="hljs-string">&#x27;common.views&#x27;</span>, broker=<span class="hljs-string">&#x27;redis://:123456@39.96.51.36:6379/0&#x27;</span>)<br><span class="hljs-comment"># 读取Django项目的配置信息</span><br>app.config_from_object(<span class="hljs-string">&#x27;django.conf:settings&#x27;</span>)<br><br><span class="hljs-meta">@app.task</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_mobile_code</span>(<span class="hljs-params">code:str, mobile:str</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;调用手机短信三方接口-山东墨白&quot;&quot;&quot;</span><br>    templateId = <span class="hljs-string">&#x27;TP1801025&#x27;</span><br>    headers = &#123;<span class="hljs-string">&quot;Host&quot;</span>:<span class="hljs-string">&quot;mobai.market.alicloudapi.com&quot;</span>, <span class="hljs-string">&quot;Authorization&quot;</span>:<span class="hljs-string">&quot;APPCODE b9c8d60cf919439dab918dc1cb3c1638&quot;</span>&#125;<br>    url = <span class="hljs-string">f&#x27;http://mobai.market.alicloudapi.com/mobai_sms?param=code:<span class="hljs-subst">&#123;code&#125;</span>&amp;phone=<span class="hljs-subst">&#123;mobile&#125;</span>&amp;templateId=<span class="hljs-subst">&#123;templateId&#125;</span>&#x27;</span><br>    response = requests.post(url=url, headers=headers, timeout=<span class="hljs-number">5</span>)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> json.loads(response.text)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_mobile_code</span>(<span class="hljs-params">length=<span class="hljs-number">6</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定长度的手机验证码&quot;&quot;&quot;</span><br>    code = StringIO()<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(length):<br>        code.write(str(randint(<span class="hljs-number">0</span>, <span class="hljs-number">9</span>)))<br>    <span class="hljs-keyword">return</span> code.getvalue()<br></code></pre></td></tr></table></figure>

<blockquote>
<p>说明： </p>
<ol>
<li><code>@app.task</code> 装饰需要异步处理的任务，调用时需要加入delay()函数；</li>
<li>消费者使用<code>celery -A common.views worker -l info</code>  ; </li>
<li>如果celery需要读取django配置需要加上代码 <code>os.environ.setdefault(&#39;DJANGO_SETTINGS_MODULE&#39;, &#39;Fangtx.settings&#39;)</code>  <code>app.config_from_object(&#39;django.conf:settings&#39;)</code></li>
</ol>
</blockquote>
<p>问题：windows平台出现 <code>Celery ValueError: not enough values to unpack (expected 3, got 0)</code></p>
<p>解决：安装第三方库<code>pip install eventlet</code> 然后在命令后加<code>-P eventlet</code></p>
<h4 id="图灵机器人"><a href="#图灵机器人" class="headerlink" title="图灵机器人"></a>图灵机器人</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">from</span> urllib.request <span class="hljs-keyword">import</span> urlopen, Request<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> urlencode<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TuringChatMode</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-comment"># API接口地址</span><br>        self.turing_url = <span class="hljs-string">&#x27;http://www.tuling123.com/openapi/api?&#x27;</span><br>        <span class="hljs-comment"># AppKey密钥</span><br>        self.app_key = <span class="hljs-string">&#x27;82622364a28142878dd8ad634eec401c&#x27;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getTuringText</span>(<span class="hljs-params">self, text</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;获取聊天返回内容&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 用户IP</span><br>        user_ip = self.getHostIp()<br>        <span class="hljs-comment"># MAC地址</span><br>        mac_id = self.getMacId()<br>        <span class="hljs-comment"># 请求参数</span><br>        turing_url_data = dict(<br>            <span class="hljs-comment"># AppKey密钥</span><br>            key=self.app_key,<br>            <span class="hljs-comment"># 聊天请求内容</span><br>            info=text,<br>            <span class="hljs-comment"># 用户唯一标志（可以传IP地址或者MAC地址，或者其他的唯一标识）</span><br>            userid=mac_id<br>        )<br>        <span class="hljs-comment"># 发送聊天请求</span><br>        request = Request(self.turing_url + urlencode(turing_url_data))<br>        <span class="hljs-keyword">try</span>:<br>            w_data = urlopen(request)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> error_info:<br>            <span class="hljs-keyword">return</span> error_info<br>        response_text = w_data.read().decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        json_result = json.loads(response_text)<br>        <span class="hljs-keyword">return</span> json_result[<span class="hljs-string">&#x27;text&#x27;</span>]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getHostIp</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;获取用户IP&quot;&quot;&quot;</span><br>        socket_info = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br>        socket_info.connect((<span class="hljs-string">&#x27;8.8.8.8&#x27;</span>, <span class="hljs-number">80</span>))<br>        ip = socket_info.getsockname()[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">return</span> ip<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getMacId</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;获取MAC地址&quot;&quot;&quot;</span><br>        node = uuid.getnode()<br>        mac = uuid.UUID(int=node).hex[<span class="hljs-number">-12</span>:]<br>        <span class="hljs-keyword">return</span> mac<br><br><br><span class="hljs-comment"># 聊天程序主入口</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    print(<span class="hljs-string">&quot;您可以和机器人聊天了（退出请输入q）&quot;</span>)<br>    turing = TuringChatMode()<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        msg = input(<span class="hljs-string">&quot;\n我:&quot;</span>)<br>        <span class="hljs-comment"># 设定输入q，退出聊天。</span><br>        <span class="hljs-keyword">if</span> msg == <span class="hljs-string">&#x27;q&#x27;</span>:<br>            exit(<span class="hljs-string">&quot;聊天结束!&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            turing_data = turing.getTuringText(msg)<br>            print(<span class="hljs-string">&quot;机器人:&quot;</span>, turing_data)<br></code></pre></td></tr></table></figure>



<h4 id="发送Server酱微信通知"><a href="#发送Server酱微信通知" class="headerlink" title="发送Server酱微信通知"></a>发送Server酱微信通知</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><br>SERVER_CHAN_CONF = &#123;<br>    <span class="hljs-string">&quot;is_server_chan&quot;</span>: <span class="hljs-literal">True</span>,<br>    <span class="hljs-string">&quot;server_address&quot;</span>: <span class="hljs-string">&quot;https://sc.ftqq.com/&quot;</span>,<br>    <span class="hljs-string">&quot;secret&quot;</span>: <span class="hljs-string">&quot;SCU75107Tf7aa9efty6gbe5b26d5c483e6edf72c5e0d62b19cbf8&quot;</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_server_chan</span>(<span class="hljs-params">title=None, content=None</span>):</span><br><br>    secret = SERVER_CHAN_CONF[<span class="hljs-string">&quot;secret&quot;</span>].strip()<br>    server_address = SERVER_CHAN_CONF[<span class="hljs-string">&quot;server_address&quot;</span>].strip()<br>    <span class="hljs-keyword">if</span> SERVER_CHAN_CONF[<span class="hljs-string">&quot;is_server_chan&quot;</span>] <span class="hljs-keyword">and</span> all([secret, server_address]):<br>        <span class="hljs-keyword">try</span>:<br>            server_address += <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;secret&#125;</span>.send&#x27;</span><br>            params = &#123;<span class="hljs-string">&quot;text&quot;</span>: title, <span class="hljs-string">&quot;desp&quot;</span>: content&#125;<br>            response = requests.get(server_address, params).json()<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&quot;errno&quot;</span>] == <span class="hljs-number">0</span>:<br>                print(<span class="hljs-string">&quot;已下发 Server酱 微信通知, 请查收&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                print(response)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            print(<span class="hljs-string">u&quot;Server酱 配置有误 &#123;&#125;&quot;</span>.format(e))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;缺少必要参数&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    send_server_chan(<span class="hljs-string">&#x27;测试标题&#x27;</span>, <span class="hljs-string">&#x27;测试内容&#x27;</span>)<br><br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://sc.ftqq.com/">Server酱官网</a></p>
<h4 id="接入高德地图"><a href="#接入高德地图" class="headerlink" title="接入高德地图"></a>接入高德地图</h4><p><a target="_blank" rel="noopener" href="https://lbs.amap.com/api/">高德地图开发文档</a></p>
<p>示例：地理/逆地理编码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">import</span> requests<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gaode_forward</span>(<span class="hljs-params">address</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;正向查找：输入位置返回经纬度&quot;&quot;&quot;</span><br>    key = <span class="hljs-string">&#x27;f618f239821683b024fbfa22c38f32ca&#x27;</span><br>    <span class="hljs-comment"># address = quote(address)</span><br>    response = requests.get(<span class="hljs-string">f&#x27;https://restapi.amap.com/v3/geocode/geo?key=<span class="hljs-subst">&#123;key&#125;</span>&amp;address=<span class="hljs-subst">&#123;address&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        result = json.loads(response.text)<br>        <span class="hljs-keyword">return</span> result<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gaode_backward</span>(<span class="hljs-params">x, y</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;逆向查找：通过经纬度查找位置&quot;&quot;&quot;</span><br>    key = <span class="hljs-string">&#x27;f618f239821683b024fbfa22c38f32ca&#x27;</span><br>    <span class="hljs-comment"># address = quote(address)</span><br>    response = requests.get(<span class="hljs-string">f&#x27;https://restapi.amap.com/v3/geocode/regeo?key=<span class="hljs-subst">&#123;key&#125;</span>&amp;location=<span class="hljs-subst">&#123;x&#125;</span>, <span class="hljs-subst">&#123;y&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> response.text<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-comment"># result = gaode_forward(&#x27;四川省成都市&#x27;)</span><br>    result = gaode_backward(<span class="hljs-number">104.076331</span>,<span class="hljs-number">30.623141</span>)<br>    print(result)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<blockquote>
<p>可以使用第三方封装的<a target="_blank" rel="noopener" href="https://geocoder.readthedocs.io/">各平台地图SDK</a>。</p>
</blockquote>
<h4 id="云存储服务器"><a href="#云存储服务器" class="headerlink" title="云存储服务器"></a>云存储服务器</h4><p>可以选择第三方提供的云存储服务器：AWS/Qiniu/Bmob/OSS/LeanCloud</p>
<p>国内我们可以选择<a target="_blank" rel="noopener" href="http://qiniu.com/">七牛</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 上传文件</span><br><span class="hljs-keyword">from</span> qiniu <span class="hljs-keyword">import</span> Auth, put_file, etag<br><br>access_key = <span class="hljs-string">&#x27;tmaN2Yd2jIzgy-XucHjWb5ezNBZDjGbAdwsCPR8j&#x27;</span><br>secret_key = <span class="hljs-string">&#x27;W6Mcu4Qj0_gbQAMwfXID5RyzLvFqwoCRKONrsJWr&#x27;</span><br><span class="hljs-comment">#构建鉴权对象</span><br>q = Auth(access_key, secret_key)<br><span class="hljs-comment">#要上传的空间</span><br>bucket_name = <span class="hljs-string">&#x27;data&#x27;</span><br><span class="hljs-comment">#上传到七牛后保存的文件名</span><br>key = <span class="hljs-string">&#x27;xxx.docx&#x27;</span><br><span class="hljs-comment">#生成上传 Token，可以指定过期时间等</span><br>token = q.upload_token(bucket_name, key, <span class="hljs-number">10</span>)<br><span class="hljs-comment">#要上传文件的本地路径</span><br>localfile = <span class="hljs-string">&#x27;./xxx.docx&#x27;</span><br>ret, info = put_file(token, key, localfile)<br>print(info)<br><span class="hljs-keyword">assert</span> ret[<span class="hljs-string">&#x27;key&#x27;</span>] == key<br><span class="hljs-keyword">assert</span> ret[<span class="hljs-string">&#x27;hash&#x27;</span>] == etag(localfile)<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 下载文件</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> qiniu <span class="hljs-keyword">import</span> Auth<br><br>access_key = <span class="hljs-string">&#x27;tmaN2Yd2jIzgy-XucHjWb5ezNBZDjGbAdwsCPR8j&#x27;</span><br>secret_key = <span class="hljs-string">&#x27;W6Mcu4Qj0_gbQAMwfXID5RyzLvFqwoCRKONrsJWr&#x27;</span><br>q = Auth(access_key, secret_key)<br><span class="hljs-comment">#有两种方式构造base_url的形式</span><br>bucket_domain = <span class="hljs-string">&#x27;plodffopm.bkt.clouddn.com&#x27;</span><br><span class="hljs-comment">#上传到七牛后保存的文件名</span><br>key = <span class="hljs-string">&#x27;吕皓洁python开发工程师.docx&#x27;</span><br>base_url = <span class="hljs-string">&#x27;http://%s/%s&#x27;</span> % (bucket_domain, key)<br><br><span class="hljs-comment">#可以设置token过期时间</span><br>private_url = q.private_download_url(base_url, expires=<span class="hljs-number">3600</span>)<br><span class="hljs-comment"># print(private_url)</span><br>r = requests.get(private_url)<br><span class="hljs-keyword">assert</span> r.status_code == <span class="hljs-number">200</span><br><span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./222.docx&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(r.content)<br></code></pre></td></tr></table></figure>



<h4 id="snowflake算法"><a href="#snowflake算法" class="headerlink" title="snowflake算法"></a>snowflake算法</h4><p>Snowflake是Twitter提出来的一个算法，其目的是生成一个64bit的整数。</p>
<p><img src="https://stellae.gitee.io/myblog/images/images/1552472-20191115134418390-159822005.png" srcset="/Myblog/img/loading.gif" lazyload></p>
<ul>
<li><p>1bit:一般是符号位，不做处理</p>
</li>
<li><p>41bit:用来记录时间戳，这里可以记录69年，如果设置好起始时间比如今年是2018年，那么可以用到2089年，到时候怎么办？要是这个系统能用69年，我相信这个系统早都重构了好多次了。</p>
</li>
<li><p>10bit:10bit用来记录机器ID，总共可以记录1024台机器，一般用前5位代表数据中心，后面5位是某个数据中心的机器ID</p>
</li>
<li><p>12bit:循环位，用来对同一个毫秒之内产生不同的ID，12位可以最多记录4095个，也就是在同一个机器同一毫秒最多记录4095个，多余的需要进行等待下毫秒。<br>上面只是一个将64bit划分的标准，当然也不一定这么做，可以根据不同业务的具体场景来划分，比如下面给出一个业务场景：</p>
<ol>
<li>服务目前QPS10万，预计几年之内会发展到百万。</li>
<li>当前机器三地部署，上海，北京，深圳都有。</li>
<li>当前机器10台左右，预计未来会增加至百台。<br>这个时候我们根据上面的场景可以再次合理的划分62bit,QPS几年之内会发展到百万，那么每毫秒就是千级的请求，目前10台机器那么每台机器承担百级的请求，为了保证扩展，后面的循环位可以限制到1024，也就是2^10，那么循环位10位就足够了。</li>
<li>机器三地部署我们可以用3bit总共8来表示机房位置，当前的机器10台，为了保证扩展到百台那么可以用7bit 128来表示，时间位依然是41bit,那么还剩下64-10-3-7-41-1 = 2bit,还剩下2bit可以用来进行扩展。</li>
</ol>
</li>
</ul>
<p><img src="https://stellae.gitee.io/myblog/images/images/1552472-20191115134454552-13309564.png" srcset="/Myblog/img/loading.gif" lazyload></p>
<ul>
<li>时钟回拨<br> 因为机器的原因会发生时间回拨，我们的雪花算法是强依赖我们的时间的，如果时间发生回拨，有可能会生成重复的ID，在我们上面的nextId中我们用当前时间和上一次的时间进行判断，如果当前时间小于上一次的时间那么肯定是发生了回拨，算法会直接抛出异常.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> logging<br><br><br><span class="hljs-comment"># 64位ID的划分</span><br>WORKER_ID_BITS = <span class="hljs-number">5</span><br>DATACENTER_ID_BITS = <span class="hljs-number">5</span><br>SEQUENCE_BITS = <span class="hljs-number">12</span><br><br><span class="hljs-comment"># 最大取值计算</span><br>MAX_WORKER_ID = <span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; WORKER_ID_BITS)  <span class="hljs-comment"># 2**5-1 0b11111</span><br>MAX_DATACENTER_ID = <span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; DATACENTER_ID_BITS)<br><br><span class="hljs-comment"># 移位偏移计算</span><br>WOKER_ID_SHIFT = SEQUENCE_BITS<br>DATACENTER_ID_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS<br>TIMESTAMP_LEFT_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS + DATACENTER_ID_BITS<br><br><span class="hljs-comment"># 序号循环掩码</span><br>SEQUENCE_MASK = <span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; SEQUENCE_BITS)<br><br><span class="hljs-comment"># Twitter元年时间戳</span><br>TWEPOCH = <span class="hljs-number">1288834974657</span><br><br><br>logger = logging.getLogger(<span class="hljs-string">&#x27;flask.app&#x27;</span>)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvalidSystemClock</span>(<span class="hljs-params">Exception</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    时钟回拨异常</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IdWorker</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    用于生成IDs</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, datacenter_id, worker_id, sequence=<span class="hljs-number">0</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        初始化</span><br><span class="hljs-string">        :param datacenter_id: 数据中心（机器区域）ID</span><br><span class="hljs-string">        :param worker_id: 机器ID</span><br><span class="hljs-string">        :param sequence: 序列号</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># sanity check</span><br>        <span class="hljs-keyword">if</span> worker_id &gt; MAX_WORKER_ID <span class="hljs-keyword">or</span> worker_id &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;worker_id值越界&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> datacenter_id &gt; MAX_DATACENTER_ID <span class="hljs-keyword">or</span> datacenter_id &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;datacenter_id值越界&#x27;</span>)<br><br>        self.worker_id = worker_id<br>        self.datacenter_id = datacenter_id<br>        self.sequence = sequence<br><br>        self.last_timestamp = <span class="hljs-number">-1</span>  <span class="hljs-comment"># 上次计算的时间戳</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_gen_timestamp</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成整数时间戳</span><br><span class="hljs-string">        :return:int timestamp</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> int(time.time() * <span class="hljs-number">1000</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_id</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取新ID</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        timestamp = self._gen_timestamp()<br><br>        <span class="hljs-comment"># 时钟回拨</span><br>        <span class="hljs-keyword">if</span> timestamp &lt; self.last_timestamp:<br>            logging.error(<span class="hljs-string">&#x27;clock is moving backwards. Rejecting requests until &#123;&#125;&#x27;</span>.format(self.last_timestamp))<br>            <span class="hljs-keyword">raise</span> InvalidSystemClock<br><br>        <span class="hljs-keyword">if</span> timestamp == self.last_timestamp:<br>            self.sequence = (self.sequence + <span class="hljs-number">1</span>) &amp; SEQUENCE_MASK<br>            <span class="hljs-keyword">if</span> self.sequence == <span class="hljs-number">0</span>:<br>                timestamp = self._til_next_millis(self.last_timestamp)<br>        <span class="hljs-keyword">else</span>:<br>            self.sequence = <span class="hljs-number">0</span><br><br>        self.last_timestamp = timestamp<br><br>        new_id = ((timestamp - TWEPOCH) &lt;&lt; TIMESTAMP_LEFT_SHIFT) | (self.datacenter_id &lt;&lt; DATACENTER_ID_SHIFT) | \<br>                 (self.worker_id &lt;&lt; WOKER_ID_SHIFT) | self.sequence<br>        <span class="hljs-keyword">return</span> new_id<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_til_next_millis</span>(<span class="hljs-params">self, last_timestamp</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        等到下一毫秒</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        timestamp = self._gen_timestamp()<br>        <span class="hljs-keyword">while</span> timestamp &lt;= last_timestamp:<br>            timestamp = self._gen_timestamp()<br>        <span class="hljs-keyword">return</span> timestamp<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    worker = IdWorker(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>)<br>    print(worker.get_id())<br></code></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>datacenter_id:  数据中心（机器区域）ID</li>
<li>worker_id:  机器ID</li>
<li>sequence:  序列号</li>
</ul>
</blockquote>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/Myblog/categories/Python/">Python</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/Myblog/tags/%E5%AE%9E%E7%94%A8%E5%8A%9F%E8%83%BD/">实用功能</a>
                    
                      <a class="hover-with-bg" href="/Myblog/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/">工具类</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/Myblog/2019/01/14/RESTful%E7%AE%80%E8%BF%B0/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">RESTful简述</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/Myblog/2019/01/09/Docker%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E6%8C%87%E5%8D%97/">
                        <span class="hidden-mobile">Docker简易上手指南</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                

              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/Myblog/js/events.js" ></script>
<script  src="/Myblog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/Myblog/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>






  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/Myblog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/Myblog/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/Myblog/js/boot.js" ></script>


</body>
</html>
