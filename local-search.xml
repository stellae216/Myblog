<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>从零到一搭建Web框架</title>
    <link href="/Myblog/2023/11/15/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BAWeb%E6%A1%86%E6%9E%B6/"/>
    <url>/Myblog/2023/11/15/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BAWeb%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>为什么我们要使用web框架？ 要解答这个问题，首先需要知道我们工作中遇到了什么样的问题，web框架能够为我们带来什么？只有想明白了这个问题，我们才能知道我们需要什么样的框架，实现什么样的功能。相信阅读完本文你能够有自己的答案。</p><p><em>tip：本文旨在指明设计框架的思路，与使用编程语言无关，本文我们使用golang作为示例。</em></p><p>我们先来看看标准库<code>http/net</code>如何处理一个请求</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    http.HandleFunc(<span class="hljs-string">&quot;/api/v1/hello&quot;</span>, helloHandler)<br>    http.HandleFunc(<span class="hljs-string">&quot;/api/v1/test&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;&#125;)<br>    <span class="hljs-keyword">if</span> err := http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, <span class="hljs-literal">nil</span>); err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">helloHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    res := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">0</span>, <span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;ok&quot;</span>&#125;<br>    w.WriteHeader(http.StatusOK)<br>    b, err := json.Marshal(res)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> _, err = w.Write(b); err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>通过这个例子，我们可以发现标准库提供的能力太过基础，不支持类似 <strong>动态路由</strong>、<strong>工具集</strong>、<strong>中间件</strong>、<strong>错误处理</strong> 等能力。这个时候就需要框架来给我们提供相应的能力，让我们远离频繁手工处理复杂代码，这就是框架的价值所在。</p><p>接下来让我们来搭建一个web框架(设计思路参考Gin)，下面是框架的各个模块实现。</p><h3 id="HTTP基础"><a href="#HTTP基础" class="headerlink" title="HTTP基础"></a>HTTP基础</h3><p>通过查看<code>net/http</code>的源码可以发现，<code>Handler</code>是一个接口，需要实现方法 <em>ServeHTTP</em> ，也就是说，只要传入任何实现了 <em>ServerHTTP</em> 接口的实例，所有的HTTP请求，就都交给了该实例处理了。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Engine <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    <span class="hljs-keyword">switch</span> r.URL.Path &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;/&quot;</span>:<br>        fmt.Fprint(w, <span class="hljs-string">&quot;URL.Path = %q\n&quot;</span>, r.URL.Path)<br>    <span class="hljs-keyword">default</span>:<br>        fmt.Fprintf(w, <span class="hljs-string">&quot;404 NOT FOUND: %s\n&quot;</span>, r.URL)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    engine := <span class="hljs-built_in">new</span>(Engine)<br>    http.HandleFunc(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    &#125;)<br>    http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, engine)<br>&#125;<br></code></pre></td></tr></table></figure><p>我们实现方法<code>ServeHTTP(w http.ResponseWriter, r *http.Request)</code> ，现在相当于拦截了所有的http请求，拥有的统一的请求入口，我们可以在这里做一些特定路由的处理，也能够做其他业务处理逻辑，比如日志、异常处理等。并且我们能够拿到req 和 response请求，可以自行处理http请求和响应，当然我们也可以将一些常用的请求封装起来，简化业务代码开发。</p><p>我们简单完善下代码后大概是这样</p><p><code>engine.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">type</span> Engine <span class="hljs-keyword">struct</span> &#123;<br>    router <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]HandlerFunc<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    key := r.Method + <span class="hljs-string">&quot;-&quot;</span> + r.URL.Path<br>    <span class="hljs-keyword">if</span> _, ok := e.router[key]; !ok &#123;<br>        w.WriteHeader(http.StatusNotFound)<br>        fmt.Fprintf(w, <span class="hljs-string">&quot;404 NOT FOUND: %s\n&quot;</span>, key)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    fmt.Fprintf(w, <span class="hljs-string">&quot;URL.Path = %s\n&quot;</span>, key)<br>&#125;<br><br><span class="hljs-keyword">type</span> HandlerFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewEngine</span><span class="hljs-params">()</span> *<span class="hljs-title">Engine</span></span> &#123;<br>    <span class="hljs-keyword">return</span> &amp;Engine&#123;router: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]HandlerFunc)&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">Run</span><span class="hljs-params">(port <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>    <span class="hljs-keyword">return</span> http.ListenAndServe(<span class="hljs-string">&quot;:&quot;</span>+port, e)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">AddRoute</span><span class="hljs-params">(method <span class="hljs-keyword">string</span>, pattern <span class="hljs-keyword">string</span>, handler HandlerFunc)</span></span> &#123;<br>    e.router[method+<span class="hljs-string">&quot;-&quot;</span>+pattern] = handler<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">GET</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler HandlerFunc)</span></span> &#123;<br>    e.AddRoute(http.MethodGet, pattern, handler)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">POST</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler HandlerFunc)</span></span> &#123;<br>    e.AddRoute(http.MethodPost, pattern, handler)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">PATCH</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler HandlerFunc)</span></span> &#123;<br>    e.AddRoute(http.MethodPatch, pattern, handler)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">PUT</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler HandlerFunc)</span></span> &#123;<br>    e.AddRoute(http.MethodPut, pattern, handler)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">DELETE</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler HandlerFunc)</span></span> &#123;<br>    e.AddRoute(http.MethodDelete, pattern, handler)<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>main.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    e := engine.NewEngine()<br>    e.GET(<span class="hljs-string">&quot;/api/v1/hello&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    &#125;)<br>    e.POST(<span class="hljs-string">&quot;/api/v1/hello&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;&#125;)<br>    <span class="hljs-keyword">if</span> err := e.Run(<span class="hljs-string">&quot;8080&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(err)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>现在看起来是不是已经优雅很多了，但是目前封装的能力还不够，比如handler函数我们还需要单独处理请求和相应，还不支持路由、分组、以及中间件，后面我们会一一组装。</p><h3 id="Context上下文"><a href="#Context上下文" class="headerlink" title="Context上下文"></a>Context上下文</h3><p>对Web服务来说，无非是根据请求<code>*http.Request</code>，构造响应<code>http.ResponseWriter</code>。但是这两个对象提供的接口粒度太细，比如我们要构造一个完整的响应，需要考虑消息头(Header)和消息体(Body)，而 Header 包含了状态码(StatusCode)，消息类型(ContentType)等几乎每次请求都需要设置的信息。因此，如果不进行有效的封装，那么框架的用户将需要写大量重复，繁杂的代码，而且容易出错。针对常用场景，能够高效地构造出 HTTP 响应是一个好的框架必须考虑的点。</p><p>用返回 JSON 数据作比较，感受下封装前后的差距。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">obj = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>    <span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-string">&quot;hello world&quot;</span>,<br>&#125;<br>w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)<br>w.WriteHeader(http.StatusOK)<br>encoder := json.NewEncoder(w)<br><span class="hljs-keyword">if</span> err := encoder.Encode(obj); err != <span class="hljs-literal">nil</span> &#123;<br>    http.Error(w, err.Error(), <span class="hljs-number">500</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>VS 封装后：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">c.RetJson(http.StatusOK, <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>        <span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-string">&quot;hello world&quot;</span>,<br>&#125;)<br></code></pre></td></tr></table></figure><p>所以针对使用场景，封装<code>*http.Request</code>和<code>http.ResponseWriter</code>的方法，简化相关接口的调用，只是设计 Context 的原因之一。Context 随着每一个请求的出现而产生，请求的结束而销毁，和当前请求强相关的信息都应由 Context 承载。因此，设计 Context 结构，扩展性和复杂性留在了内部，而对外简化了接口。路由的处理函数，以及将要实现的中间件，参数都统一使用 Context 实例， Context 就像一次会话的百宝箱，可以找到任何东西。</p><p><code>engine.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Engine <span class="hljs-keyword">struct</span> &#123;<br>    Router *router.Router<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewEngine</span><span class="hljs-params">()</span> *<span class="hljs-title">Engine</span></span> &#123;<br>    <span class="hljs-keyword">return</span> &amp;Engine&#123;Router: router.NewRouter()&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">Run</span><span class="hljs-params">(port <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>    <span class="hljs-keyword">return</span> http.ListenAndServe(<span class="hljs-string">&quot;:&quot;</span>+port, e)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>context.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> context<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;encoding/json&quot;</span><br>    <span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Context <span class="hljs-keyword">struct</span> &#123;<br>    Writer http.ResponseWriter<br>    Req    *http.Request<br>    Path   <span class="hljs-keyword">string</span><br>    Method <span class="hljs-keyword">string</span><br>    <span class="hljs-comment">// response http code</span><br>    StatusCode <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-keyword">type</span> HandlerFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx *Context)</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewContext</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span> *<span class="hljs-title">Context</span></span> &#123;<br>    <span class="hljs-keyword">return</span> &amp;Context&#123;<br>        Writer: w,<br>        Req:    r,<br>        Path:   r.URL.Path,<br>        Method: r.Method,<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">PostForm</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">return</span> c.Req.FormValue(key)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">Query</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">return</span> c.Req.URL.Query().Get(key)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">Status</span><span class="hljs-params">(code <span class="hljs-keyword">int</span>)</span></span> &#123;<br>    c.StatusCode = code<br>    c.Writer.WriteHeader(code)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">SetHeader</span><span class="hljs-params">(headers <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> headers &#123;<br>        c.Writer.Header().Set(key, value)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">RetString</span><span class="hljs-params">(code <span class="hljs-keyword">int</span>, str <span class="hljs-keyword">string</span>)</span></span> &#123;<br>    c.SetHeader(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;<br>        <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;text/plain&quot;</span>,<br>    &#125;)<br>    c.Status(code)<br>    c.Writer.Write([]<span class="hljs-keyword">byte</span>(str))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">RetJson</span><span class="hljs-params">(code <span class="hljs-keyword">int</span>, obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>    c.SetHeader(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;<br>        <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br>    &#125;)<br>    c.Status(code)<br>    encoder := json.NewEncoder(c.Writer)<br>    <span class="hljs-keyword">if</span> err := encoder.Encode(obj); err != <span class="hljs-literal">nil</span> &#123;<br>        http.Error(c.Writer, err.Error(), <span class="hljs-number">500</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">RetData</span><span class="hljs-params">(code <span class="hljs-keyword">int</span>, d []<span class="hljs-keyword">byte</span>)</span></span> &#123;<br>    c.Status(code)<br>    c.Writer.Write(d)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">RetHTML</span><span class="hljs-params">(code <span class="hljs-keyword">int</span>, html <span class="hljs-keyword">string</span>)</span></span> &#123;<br>    c.SetHeader(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;<br>        <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;text/html&quot;</span>,<br>    &#125;)<br>    c.RetData(code, []<span class="hljs-keyword">byte</span>(html))<br>&#125;<br><br></code></pre></td></tr></table></figure><p>所有会话内请求和响应的处理，都可以在context中完成。</p><ul><li><code>Context</code>目前只包含了<code>http.ResponseWriter</code>和<code>*http.Request</code>，另外提供了对 Method 和 Path 这两个常用属性的直接访问。</li><li>提供了访问Query和PostForm参数的方法。</li><li>提供了快速构造String/Data/JSON/HTML响应的方法。</li></ul><h3 id="Route路由和分组"><a href="#Route路由和分组" class="headerlink" title="Route路由和分组"></a>Route路由和分组</h3><p>在前面我们用了一个非常简单的<code>map</code>结构存储了路由表，使用<code>map</code>存储键值对，索引非常高效，但是有一个弊端，键值对的存储的方式，只能用来索引静态路由。那如果我们想支持类似于<code>/hello/:name</code>这样的动态路由怎么办呢？所谓动态路由，即一条路由规则可以匹配某一类型而非某一条固定的路由。例如<code>/hello/:name</code>，可以匹配<code>/hello/stellaelv</code>、<code>hello/heathsong</code>等。</p><p>动态路由有很多种实现方式，支持的规则、性能等有很大的差异。例如开源的路由实现<code>gorouter</code>支持在路由规则中嵌入正则表达式，例如<code>/p/[0-9A-Za-z]+</code>，即路径中的参数仅匹配数字和字母；另一个开源实现<code>httprouter</code>就不支持正则表达式，采用<code>/hello/:name</code>的形式去匹配，著名的Web开源框架<code>gin</code> 就是使用了<code>httprouter</code>。</p><p>实现动态路由最常用的数据结构，被称为前缀树(Trie树)：每一个节点的所有的子节点都拥有相同的前缀。这种结构非常适用于路由匹配，比如我们定义了如下路由规则：</p><ul><li>/:name/a</li><li>/:name/b</li><li>/:name/c</li><li>/about</li><li>/p/blog</li><li>/p/related</li></ul><p><img src="https://stellae.gitee.io/myblog/images/images/WechatIMG71852.jpg"></p><p>HTTP请求的路径恰好是由<code>/</code>分隔的多段构成的，因此，每一段可以作为前缀树的一个节点。我们通过树结构查询，如果中间某一层的节点都不满足条件，那么就说明没有匹配到的路由，查询结束。</p><p>接下来我们实现的动态路由具备以下功能。</p><ul><li>支持通用参数匹配符号<code>:</code>  -&gt;   例如 <code>/hello/:name</code>，可以匹配 <code>/hello/a</code> 和 <code>/hello/b</code>。</li></ul><h4 id="前缀树"><a href="#前缀树" class="headerlink" title="前缀树"></a>前缀树</h4><p>首先我们需要设计树节点上应该存储哪些信息。</p><p><code>tree.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Node <span class="hljs-keyword">struct</span> &#123;<br>    pattern  <span class="hljs-keyword">string</span> <span class="hljs-comment">// 待匹配路由, 如 /:name/stellae</span><br>    part     <span class="hljs-keyword">string</span> <span class="hljs-comment">// 路由中的一部分，如 :name</span><br>    children []*Node<br>    handler  context.HandlerFunc <span class="hljs-comment">// 叶子节点保存handler</span><br>&#125;<br></code></pre></td></tr></table></figure><p>与普通的树不同，为了实现动态路由匹配，我们需要判断<code>child.part</code> 首字母是否是 <code>:</code>，如果模糊匹配到了<code>:name</code>，会以<code>&#123;&quot;name&quot;: part&#125;</code> 的形式返回，方便后续context 存储和使用。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// matchChild 返回匹配节点和路径参数</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(n *Node)</span> <span class="hljs-title">matchChild</span><span class="hljs-params">(part <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Node, <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> _, children := <span class="hljs-keyword">range</span> n.children &#123;<br>        <span class="hljs-keyword">if</span> children.part[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;:&#x27;</span> &#123;<br>            <span class="hljs-keyword">return</span> children, <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;<br>                children.part[<span class="hljs-number">1</span>:]: part,<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> children.part == part &#123;<br>            <span class="hljs-keyword">return</span> children, <span class="hljs-literal">nil</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>对于路由来说，最重要的当然是注册与匹配了。开发服务时，注册路由规则，映射handler；访问时，匹配路由规则，查找到对应的handler。因此，Trie 树需要支持节点的插入与查询。插入功能很简单，递归查找每一层的节点，如果没有匹配到当前<code>part</code>的节点，则新建一个。</p><p>有一点需要注意，只有叶子节点才保存pattern和 handler信息。因此，当我们递归匹配每个子节点时，必须要成功匹配到叶子结点，并且pattern和 handler信息不为空才算匹配成功。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(n *Node)</span> <span class="hljs-title">Insert</span><span class="hljs-params">(idx <span class="hljs-keyword">int</span>, parts []<span class="hljs-keyword">string</span>, handler context.HandlerFunc)</span></span> &#123;<br>    pattern := strings.Join(parts, <span class="hljs-string">&quot;/&quot;</span>)<br>    nextNode, _ := n.matchChild(parts[idx])<br>    <span class="hljs-keyword">if</span> nextNode == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// 新增节点</span><br>        nextNode = &amp;Node&#123;<br>            part:     parts[idx],<br>            children: <span class="hljs-built_in">make</span>([]*Node, <span class="hljs-number">0</span>),<br>        &#125;<br>        <span class="hljs-comment">// 叶子节点保存接口和handler信息</span><br>        <span class="hljs-keyword">if</span> idx == <span class="hljs-built_in">len</span>(parts)<span class="hljs-number">-1</span> &#123;<br>            nextNode.pattern = pattern<br>            nextNode.handler = handler<br>        &#125;<br>        n.children = <span class="hljs-built_in">append</span>(n.children, nextNode)<br>        <span class="hljs-keyword">if</span> idx == <span class="hljs-built_in">len</span>(parts)<span class="hljs-number">-1</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 已存在节点</span><br>    <span class="hljs-keyword">if</span> idx == <span class="hljs-built_in">len</span>(parts)<span class="hljs-number">-1</span> &amp;&amp; nextNode.handler != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(fmt.Errorf(<span class="hljs-string">&quot;已存在路由：%s, 不允许重复注册！&quot;</span>, pattern))<br>    &#125;<br>    nextNode.Insert(idx+<span class="hljs-number">1</span>, parts, handler)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(n *Node)</span> <span class="hljs-title">Search</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, ctx *context.Context)</span> <span class="hljs-params">(<span class="hljs-keyword">bool</span>, context.HandlerFunc)</span></span> &#123;<br>    parts := strings.Split(pattern, <span class="hljs-string">&quot;/&quot;</span>)<br>    <span class="hljs-keyword">for</span> idx, part := <span class="hljs-keyword">range</span> parts &#123;<br>        nextNode, params := n.matchChild(part)<br>        <span class="hljs-keyword">if</span> nextNode == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-comment">// 匹配失败</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><br>        &#125;<br>        <span class="hljs-comment">// 设置url参数</span><br>        <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> params &#123;<br>            ctx.SetParams(k, v)<br>        &#125;<br>        <span class="hljs-comment">// 匹配成功</span><br>        <span class="hljs-keyword">if</span> idx == <span class="hljs-built_in">len</span>(parts)<span class="hljs-number">-1</span> &amp;&amp; nextNode.pattern != <span class="hljs-string">&quot;&quot;</span> &amp;&amp; nextNode.handler != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, nextNode.handler<br>        &#125;<br>        n = nextNode<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>Trie 树的插入与查找都成功实现了，接下来我们将 Trie 树应用到路由中去吧。</p><p><code>router.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Router)</span> <span class="hljs-title">AddRoute</span><span class="hljs-params">(method <span class="hljs-keyword">string</span>, pattern <span class="hljs-keyword">string</span>, handler context.HandlerFunc)</span></span> &#123;<br>    parts := strings.Split(method+pattern, <span class="hljs-string">&quot;/&quot;</span>)<br>    r.Node.Insert(<span class="hljs-number">0</span>, parts, handler)<br>    fmt.Printf(<span class="hljs-string">&quot;[Interface] add interface %s %s \n&quot;</span>, method, pattern)<br>&#125;<br></code></pre></td></tr></table></figure><p>context中新增属性<code>URLParams</code>，存储url path 中的参数数据</p><p><code>context.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Context <span class="hljs-keyword">struct</span> &#123;<br>    Writer    http.ResponseWriter<br>    Req       *http.Request<br>    Path      <span class="hljs-keyword">string</span><br>    Method    <span class="hljs-keyword">string</span><br>    URLParams <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span> <span class="hljs-comment">// url 路径参数，例如:name</span><br>    <span class="hljs-comment">// response http code</span><br>    StatusCode <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewContext</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span> *<span class="hljs-title">Context</span></span> &#123;<br>    <span class="hljs-keyword">return</span> &amp;Context&#123;<br>        Writer:    w,<br>        Req:       r,<br>        Path:      r.URL.Path,<br>        Method:    r.Method,<br>        URLParams: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>),<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">Params</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">return</span> c.URLParams[key]<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">SetParams</span><span class="hljs-params">(key, val <span class="hljs-keyword">string</span>)</span></span> &#123;<br>    c.URLParams[key] = val<br>&#125;<br></code></pre></td></tr></table></figure><p><code>engine.go</code></p><p>我们统一接口处理 <code>ServeHTTP(w http.ResponseWriter, r *http.Request)</code> 方法里面调用<code>Node.Search(pattern, c)</code> 利用前缀树匹配路由获取handler</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    c := context.NewContext(w, r)<br>    pattern := c.Method + c.Path<br>    exist, handler := e.Router.Node.Search(pattern, c)<br>    <span class="hljs-keyword">if</span> !exist &#123;<br>        c.RetString(http.StatusNotFound, <span class="hljs-string">&quot;404 NOT FOUND&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    handler(c)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>main.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    e := engine.NewEngine()<br>    router := e.Router<br>    router.GET(<span class="hljs-string">&quot;/api/v1/hello/:name&quot;</span>, HelloHandler)<br>    <span class="hljs-keyword">if</span> err := e.Run(<span class="hljs-string">&quot;8080&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(err)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HelloHandler2</span><span class="hljs-params">(c *context.Context)</span></span> &#123;<br>    c.RetString(http.StatusOK, <span class="hljs-string">&quot;hello &quot;</span>+c.Params(<span class="hljs-string">&quot;name&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><p>分组控制(Group Control)是 Web 框架应提供的基础功能之一。所谓分组，是指路由的分组。如果没有路由分组，我们需要针对每一个路由进行控制。但是真实的业务场景中，往往某一组路由需要相似的处理。例如：</p><ul><li>以<code>/post</code>开头的路由匿名可访问。</li><li>以<code>/admin</code>开头的路由需要鉴权。</li><li>以<code>/api</code>开头的路由是 RESTful 接口，可以对接第三方平台，需要三方平台鉴权。</li></ul><p>大部分情况下的路由分组，是以相同的前缀来区分的。因此，我们今天实现的分组控制也是以前缀来区分，并且支持分组的嵌套。例如<code>/post</code>是一个分组，<code>/post/a</code>和<code>/post/b</code>可以是该分组下的子分组。作用在<code>/post</code>分组上的中间件(middleware)，也都会作用在子分组，子分组还可以应用自己特有的中间件。</p><p>中间件可以给框架提供无限的扩展能力，应用在分组上，可以使得分组控制的收益更为明显，而不是共享相同的路由前缀这么简单。例如<code>/admin</code>的分组，可以应用鉴权中间件；<code>/</code>分组应用日志中间件，<code>/</code>是默认的最顶层的分组，也就意味着给所有的路由，即整个框架增加了记录日志的能力。</p><p><code>group.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Group <span class="hljs-keyword">struct</span> &#123;<br>    Prefix      <span class="hljs-keyword">string</span>                <span class="hljs-comment">// 完整的路由前缀</span><br>    Middlewares []context.HandlerFunc <span class="hljs-comment">// support middleware</span><br>    Child       *Group<br>    Router      *Router <span class="hljs-comment">// 指向router，注册路由</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">AddGroup</span><span class="hljs-params">(part <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">Group</span></span> &#123;<br>    child := &amp;Group&#123;<br>        Prefix: g.Prefix + part,<br>        Router: g.Router, <span class="hljs-comment">// 所有group共用同一颗前缀树，也就是同一个router</span><br>    &#125;<br>    g.Child = child<br>    <span class="hljs-keyword">return</span> child<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">GET</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler context.HandlerFunc)</span></span> &#123;<br>    g.Router.GET(g.Prefix+pattern, handler)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">POST</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler context.HandlerFunc)</span></span> &#123;<br>    g.Router.POST(g.Prefix+pattern, handler)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">PATCH</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler context.HandlerFunc)</span></span> &#123;<br>    g.Router.PATCH(g.Prefix+pattern, handler)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">PUT</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler context.HandlerFunc)</span></span> &#123;<br>    g.Router.PUT(g.Prefix+pattern, handler)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">DELETE</span><span class="hljs-params">(pattern <span class="hljs-keyword">string</span>, handler context.HandlerFunc)</span></span> &#123;<br>    g.Router.DELETE(g.Prefix+pattern, handler)<br>&#125;<br><br></code></pre></td></tr></table></figure><p>对应engine和main文件调整如下：</p><p><code>engine</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Engine <span class="hljs-keyword">struct</span> &#123;<br>    Router *router.Router<br>    Group  *router.Group  <span class="hljs-comment">// 新增Group属性</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewEngine</span><span class="hljs-params">()</span> *<span class="hljs-title">Engine</span></span> &#123;<br>    engine := &amp;Engine&#123;Router: router.NewRouter()&#125;<br>    <span class="hljs-comment">// 注意：路由前缀树保存在router上，所以new Group时需要指向同一个router</span><br>    engine.Group = &amp;router.Group&#123;Router: engine.Router&#125;<br>    <span class="hljs-keyword">return</span> engine<br>&#125;<br></code></pre></td></tr></table></figure><p><code>main.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    e := engine.NewEngine()<br>    groupApi := e.Group.AddGroup(<span class="hljs-string">&quot;/api&quot;</span>)<br>    groupV2 := groupApi.AddGroup(<span class="hljs-string">&quot;/v2&quot;</span>)<br>    groupV2.GET(<span class="hljs-string">&quot;/hello&quot;</span>, HelloHandler)<br>    groupV2.GET(<span class="hljs-string">&quot;/hello/:name&quot;</span>, HelloHandler2)<br><br>    <span class="hljs-keyword">if</span> err := e.Run(<span class="hljs-string">&quot;8080&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(err)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里我们的<strong>路由分组</strong>功能就算是大功告成了。至于提供扩展能力支持中间件的内容，放在后面去实现。</p><h3 id="Middleware中间件"><a href="#Middleware中间件" class="headerlink" title="Middleware中间件"></a>Middleware中间件</h3><p><strong>中间件是什么？</strong></p><p>中间件(middlewares)，简单说，就是非业务的技术类组件。Web 框架本身不可能去理解所有的业务，因而不可能实现所有的功能。因此，框架需要有一个插口，允许用户自己定义功能，嵌入到框架中，仿佛这个功能是框架原生支持的一样。因此，对中间件而言，需要考虑2个比较关键的点：</p><ul><li>插入点在哪？使用框架的人并不关心底层逻辑的具体实现，如果插入点太底层，中间件逻辑就会非常复杂。如果插入点离用户太近，那和用户直接定义一组函数，每次在 Handler 中手工调用没有多大的优势了。</li><li>中间件的输入是什么？中间件的输入，决定了扩展能力。暴露的参数太少，用户发挥空间有限。</li></ul><p><strong>那对于一个 Web 框架而言，中间件应该设计成什么样呢？</strong></p><p>中间件的定义与路由映射的 Handler 一致，处理的输入是<code>Context</code>对象。插入点是框架接收到请求初始化<code>Context</code>对象后，允许用户使用自己定义的中间件做一些额外的处理，例如记录日志等，以及对<code>Context</code>进行二次加工。另外通过调用<code>(*Context).Next()</code>函数，中间件可等待用户自己定义的 <code>Handler</code>处理结束后，再做一些额外的操作，例如计算本次处理所用时间等。即 中间件支持用户在请求被处理的前后，做一些额外的操作。</p><p>举个例子，我们希望最终能够支持如下定义的中间件，<code>c.Next()</code>表示等待执行其他的中间件或用户的<code>Handler</code>：</p><p><code>middleware.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Timer</span><span class="hljs-params">()</span> <span class="hljs-title">context</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *context.Context)</span></span> &#123;<br>        t := time.Now()<br>        c.Next()<br>        fmt.Printf(<span class="hljs-string">&quot;[Timer] request %s cost %v\n&quot;</span>, c.Req.RequestURI, time.Since(t))<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Logger</span><span class="hljs-params">()</span> <span class="hljs-title">context</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *context.Context)</span></span> &#123;<br>        c.Next()<br>        fmt.Printf(<span class="hljs-string">&quot;[Logger] request %s, http status: %d!\n&quot;</span>, c.Req.RequestURI, c.StatusCode)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>当我们收到请求后，匹配路由，该请求的所有信息都保存在<code>Context</code>中。中间件也不例外，接收到请求后，应查找所有应作用于该路由的中间件，保存在<code>Context</code>中，依次进行调用。中间件不仅作用在处理流程前，也可以作用在处理流程后，即在用户定义的 Handler 处理完毕后，还可以执行剩下的操作。</p><p>为此，我们给<code>Context</code>添加了2个参数，定义了<code>Next</code>方法：</p><p><code>context.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Context <span class="hljs-keyword">struct</span> &#123;<br>    Writer    http.ResponseWriter<br>    Req       *http.Request<br>    Path      <span class="hljs-keyword">string</span><br>    Method    <span class="hljs-keyword">string</span><br>    URLParams <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span> <span class="hljs-comment">// url 路径参数，例如:name</span><br>    <span class="hljs-comment">// response http code</span><br>    StatusCode <span class="hljs-keyword">int</span><br>    <span class="hljs-comment">// middleware</span><br>    Handlers []HandlerFunc<br>    idx      <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewContext</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span> *<span class="hljs-title">Context</span></span> &#123;<br>    <span class="hljs-keyword">return</span> &amp;Context&#123;<br>        Writer:    w,<br>        Req:       r,<br>        Path:      r.URL.Path,<br>        Method:    r.Method,<br>        URLParams: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>),<br>        idx:       <span class="hljs-number">0</span>,<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">Next</span><span class="hljs-params">()</span></span> &#123;<br>    c.idx++<br>    c.Handlers[c.idx](c)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>idx</code>是记录当前执行到第几个中间件，当在中间件中调用<code>Next</code>方法时，控制权交给了下一个中间件，直到调用到最后一个中间件，然后再从后往前。</p><p>同时调整<code>ServeHTTP</code>方法，在请求过来之前，匹配路由查询所有的middleware，保存在context中，同时将该用户handler一起保存起来。</p><p><code>engine.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Engine)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    c := context.NewContext(w, r)<br>    <span class="hljs-comment">// 遍历当前请求属于哪些路由组，获取对应的middlewares(handler)，保存于context</span><br>    group := e.Group<br>    <span class="hljs-keyword">for</span> group.Child != <span class="hljs-literal">nil</span> &#123;<br>        group = group.Child<br>        <span class="hljs-comment">// group.Prefix+&quot;/&quot;  避免错误匹配</span><br>        <span class="hljs-keyword">if</span> strings.HasPrefix(c.Path, group.Prefix+<span class="hljs-string">&quot;/&quot;</span>) &#123;<br>            c.Handlers = <span class="hljs-built_in">append</span>(c.Handlers, group.Middlewares...)<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 匹配路由处理业务</span><br>    exist, handler := e.Router.Node.Search(c.Method+c.Path, c)<br>    <span class="hljs-keyword">if</span> !exist &#123;<br>        handler = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx *context.Context)</span></span> &#123;<br>            c.RetString(http.StatusNotFound, <span class="hljs-string">&quot;404 NOT FOUND&quot;</span>)<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 加入业务逻辑handler，后面统一处理</span><br>    c.Handlers = <span class="hljs-built_in">append</span>(c.Handlers, handler)<br>    c.Handlers[<span class="hljs-number">0</span>](c)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>main.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    e := engine.NewEngine()<br>    groupApi := e.Group.AddGroup(<span class="hljs-string">&quot;/api&quot;</span>)<br>    groupApi.Use(middleware.Timer())<br>    groupV2 := groupApi.AddGroup(<span class="hljs-string">&quot;/v2&quot;</span>)<br>    groupV2.Use(middleware.Logger())<br>    groupV2.GET(<span class="hljs-string">&quot;/hello&quot;</span>, HelloHandler)<br>    groupV2.GET(<span class="hljs-string">&quot;/hello/:name&quot;</span>, HelloHandler2)<br><br>    <span class="hljs-keyword">if</span> err := e.Run(<span class="hljs-string">&quot;8080&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(err)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>同时应用下面两个中间件，执行顺序应该是如何？</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test1</span><span class="hljs-params">()</span> <span class="hljs-title">context</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *context.Context)</span></span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;part1&quot;</span>)<br>        c.Next()<br>        fmt.Println(<span class="hljs-string">&quot;part2&quot;</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test2</span><span class="hljs-params">()</span> <span class="hljs-title">context</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *context.Context)</span></span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;part3&quot;</span>)<br>        c.Next()<br>        fmt.Println(<span class="hljs-string">&quot;part4&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最终的顺序是<code>part1 -&gt; part3 -&gt; User Handler -&gt; part 4 -&gt; part2</code></p><h3 id="Error错误恢复"><a href="#Error错误恢复" class="headerlink" title="Error错误恢复"></a>Error错误恢复</h3><p>Go 语言中，比较常见的错误处理方法是返回 error，由调用者决定后续如何处理。但是如果是无法恢复的错误，可以手动触发 panic，当然如果在程序运行过程中出现了类似于数组越界的错误，panic 也会被触发。我们也可以使用 recover 函数，可以避免因为 panic 发生而导致整个程序终止，recover 函数只在 defer 中生效。</p><p>对一个 Web 框架而言，错误处理机制是非常必要的。可能是框架本身没有完备的测试，导致在某些情况下出现空指针异常等情况。也有可能用户不正确的参数，触发了某些异常，例如数组越界，空指针等。如果因为这些原因导致系统宕机，必然是不可接受的。</p><p>所以我们可以添加一个非常简单的错误处理机制，即在此类错误发生时，向用户返回 <em>Internal Server Error</em>，并且在日志中打印必要的错误信息，方便进行错误定位。</p><p>我们之前实现了中间件机制，错误处理也可以作为一个中间件，增强 gee 框架的能力。</p><p>新增文件 <strong>recovery.go</strong>，在这个文件中实现中间件 <code>Recovery</code>。</p><p><code>recovery.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Recovery</span><span class="hljs-params">()</span> <span class="hljs-title">context</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *context.Context)</span></span> &#123;<br>        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>                message := fmt.Sprintf(<span class="hljs-string">&quot;%s&quot;</span>, err)<br>                fmt.Printf(<span class="hljs-string">&quot;%s\n\n&quot;</span>, trace(message))<br>                c.RetString(http.StatusInternalServerError, <span class="hljs-string">&quot;Internal Server Error&quot;</span>)<br>            &#125;<br>        &#125;()<br>        c.Next()<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// print stack trace for debug</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">trace</span><span class="hljs-params">(message <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">var</span> pcs [<span class="hljs-number">32</span>]<span class="hljs-keyword">uintptr</span><br>    n := runtime.Callers(<span class="hljs-number">3</span>, pcs[:]) <span class="hljs-comment">// skip first 3 caller</span><br><br>    <span class="hljs-keyword">var</span> str strings.Builder<br>    str.WriteString(message + <span class="hljs-string">&quot;\nTraceback:&quot;</span>)<br>    <span class="hljs-keyword">for</span> _, pc := <span class="hljs-keyword">range</span> pcs[:n] &#123;<br>        fn := runtime.FuncForPC(pc)<br>        file, line := fn.FileLine(pc)<br>        str.WriteString(fmt.Sprintf(<span class="hljs-string">&quot;\n\t%s:%d&quot;</span>, file, line))<br>    &#125;<br>    <span class="hljs-keyword">return</span> str.String()<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>在 <em>trace()</em> 中，调用了 <code>runtime.Callers(3, pcs[:])</code>，Callers 用来返回调用栈的程序计数器, 第 0 个 Caller 是 Callers 本身，第 1 个是上一层 trace，第 2 个是再上一层的 <code>defer func</code>。因此，为了日志简洁一点，我们跳过了前 3 个 Caller。</p><p>接下来，通过 <code>runtime.FuncForPC(pc)</code> 获取对应的函数，在通过 <code>fn.FileLine(pc)</code> 获取到调用该函数的文件名和行号，打印在日志中。</p></blockquote><p>只需要在<code>ServeHTTP(w http.ResponseWriter, r *http.Request)</code> 开始初添加一句代码，赋予context 错误恢复的能力:</p><p> <code>c.Handlers = []context.HandlerFunc&#123;middleware.Recovery()&#125;</code></p><p>如果发生异常，我们可以在后台日志中看到如下内容，引发错误的原因和堆栈信息都被打印了出来。通过日志，我们可以很容易地发现问题所在。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">runtime error: index out of range [100] with length 2<br>Traceback:<br>        /Users/deathfeeling/.gvm/gos/go1.19/src/runtime/panic.go:885<br>        /Users/deathfeeling/.gvm/gos/go1.19/src/runtime/panic.go:113<br>        /Users/deathfeeling/Codes/go/src/github.com/stellae216/web-go/main.go:60<br>        /Users/deathfeeling/Codes/go/src/github.com/stellae216/web-go/middleware/middleware.go:13<br>        /Users/deathfeeling/Codes/go/src/github.com/stellae216/web-go/middleware/middleware.go:12<br>        /Users/deathfeeling/Codes/go/src/github.com/stellae216/web-go/middleware/recovery.go:21<br>        /Users/deathfeeling/Codes/go/src/github.com/stellae216/web-go/middleware/recovery.go:20<br>        /Users/deathfeeling/Codes/go/src/github.com/stellae216/web-go/engine/engine.go:40<br>        /Users/deathfeeling/.gvm/gos/go1.19/src/net/http/server.go:2948<br>        /Users/deathfeeling/.gvm/gos/go1.19/src/net/http/server.go:1992<br>        /Users/deathfeeling/.gvm/gos/go1.19/src/runtime/asm_arm64.s:1166<br><br></code></pre></td></tr></table></figure><p><strong>到这里web框架的基础功能都已经具备了，大概只有不到400行代码，你就可以拥有一个完全自定义的高可用web框架😊😊</strong></p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>Web框架</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>web框架</tag>
      
      <tag>framework</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang中struct相互转换</title>
    <link href="/Myblog/2023/06/25/Golang%E4%B8%ADstruct%E7%9B%B8%E4%BA%92%E8%BD%AC%E6%8D%A2/"/>
    <url>/Myblog/2023/06/25/Golang%E4%B8%ADstruct%E7%9B%B8%E4%BA%92%E8%BD%AC%E6%8D%A2/</url>
    
    <content type="html"><![CDATA[<p>相信大家也遇到过，现有的项目里存在大量的struct的转换，里面的逻辑多是挨个成员拷贝赋值。这种情况下，我们常规解决方案一般是以下几种：</p><ol><li><p>手撸代码转换，开发效率低下。</p></li><li><p>先序列化再反序列化。适用与绝大部份场景，但是性能低下。</p></li><li><p>使用一些进行拷贝操作的三方库，但是这种多数都是利用反射进行拷贝，性能也得不到保障。</p></li><li><p>利用unsafe.pointer进行转换，效率高，但是利用不当容易存在风险。</p></li></ol><p>大部分朋友应该都是选择的前面两种方式，但都不尽如人意。直觉告诉我，这种事情应该有更优雅的实现方式。</p><p>在多番查找后，目光锁定在了 <a href="https://github.com/jmattheis/goverter">goverter</a>，它可以自动生成转换代码，说白了就是方式1的升级版，手撸代码的重复体力劳动，交给工具来完成。</p><p>话不多说，我们来看看例子</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// 定义两个相似的结构体</span><br><span class="hljs-keyword">type</span> A <span class="hljs-keyword">struct</span> &#123;<br>   Nested *ANested<br>   Filed      <span class="hljs-keyword">string</span><br>&#125;<br><span class="hljs-keyword">type</span> ANested <span class="hljs-keyword">struct</span> &#123;<br>   A <span class="hljs-keyword">string</span><br>   B <span class="hljs-keyword">int</span><br>   C *<span class="hljs-keyword">string</span><br>   D []<span class="hljs-keyword">int</span><br>   E []*<span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-keyword">type</span> B <span class="hljs-keyword">struct</span> &#123;<br>   Nested *BNested<br>   Filed      <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;filed&quot;`</span><br>&#125;<br><span class="hljs-keyword">type</span> BNested <span class="hljs-keyword">struct</span> &#123;<br>   A <span class="hljs-keyword">string</span><br>   B <span class="hljs-keyword">int</span><br>   C *<span class="hljs-keyword">string</span><br>   D []<span class="hljs-keyword">int</span><br>   E []*<span class="hljs-keyword">string</span><br>&#125;<br></code></pre></td></tr></table></figure><p>如果是手撸代码，我们可能是这么写。只要手速够快，开发效率也能提上去…</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">convertByHand</span><span class="hljs-params">(a *A)</span></span> &#123;<br>  <span class="hljs-keyword">var</span> b B<br>  b.Nested = &amp;BNested&#123;&#125;<br>  b.Nested.A = a.Nested.A<br>  b.Nested.B = a.Nested.B<br>  b.Nested.C = a.Nested.C<br>  b.Nested.D = a.Nested.D<br>  b.Nested.E = a.Nested.E<br>  b.A = a.A<br>&#125;<br></code></pre></td></tr></table></figure><p>我们使用goverter，只需要添加接口告诉系统如何进行转换。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// goverter:converter</span><br><span class="hljs-keyword">type</span> Converter <span class="hljs-keyword">interface</span> &#123;<br>ConvertItems(source []A) []B<br><br>Convert(source A) B<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go run github.com/jmattheis/goverter/cmd/goverter@v0.17.4 ./<br></code></pre></td></tr></table></figure><p>系统自动添加目录<code>generated</code>并生成go文件并添加转换代码如下</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// Code generated by github.com/jmattheis/goverter, DO NOT EDIT.</span><br><br><span class="hljs-keyword">package</span> generated<br><br><span class="hljs-keyword">import</span> structs <span class="hljs-string">&quot;test/structs&quot;</span><br><br><span class="hljs-keyword">type</span> ConverterImpl <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *ConverterImpl)</span> <span class="hljs-title">Convert</span><span class="hljs-params">(source structs.A)</span> <span class="hljs-title">structs</span>.<span class="hljs-title">B</span></span> &#123;<br><span class="hljs-keyword">var</span> structsB structs.B<br>structsB.Nested = c.pStructsANestedToPStructsBNested(source.Nested)<br>structsB.Filed = source.Filed<br><span class="hljs-keyword">return</span> structsB<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *ConverterImpl)</span> <span class="hljs-title">ConvertItems</span><span class="hljs-params">(source []structs.A)</span> []<span class="hljs-title">structs</span>.<span class="hljs-title">B</span></span> &#123;<br><span class="hljs-keyword">var</span> structsBList []structs.B<br><span class="hljs-keyword">if</span> source != <span class="hljs-literal">nil</span> &#123;<br>structsBList = <span class="hljs-built_in">make</span>([]structs.B, <span class="hljs-built_in">len</span>(source))<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(source); i++ &#123;<br>structsBList[i] = c.Convert(source[i])<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> structsBList<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *ConverterImpl)</span> <span class="hljs-title">pStructsANestedToPStructsBNested</span><span class="hljs-params">(source *structs.ANested)</span> *<span class="hljs-title">structs</span>.<span class="hljs-title">BNested</span></span> &#123;<br><span class="hljs-keyword">var</span> pStructsBNested *structs.BNested<br><span class="hljs-keyword">if</span> source != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">var</span> structsBNested structs.BNested<br>structsBNested.A = (*source).A<br>structsBNested.B = (*source).B<br><span class="hljs-keyword">var</span> pString *<span class="hljs-keyword">string</span><br><span class="hljs-keyword">if</span> (*source).C != <span class="hljs-literal">nil</span> &#123;<br>xstring := *(*source).C<br>pString = &amp;xstring<br>&#125;<br>structsBNested.C = pString<br><span class="hljs-keyword">var</span> intList []<span class="hljs-keyword">int</span><br><span class="hljs-keyword">if</span> (*source).D != <span class="hljs-literal">nil</span> &#123;<br>intList = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>((*source).D))<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>((*source).D); i++ &#123;<br>intList[i] = (*source).D[i]<br>&#125;<br>&#125;<br>structsBNested.D = intList<br><span class="hljs-keyword">var</span> pStringList []*<span class="hljs-keyword">string</span><br><span class="hljs-keyword">if</span> (*source).E != <span class="hljs-literal">nil</span> &#123;<br>pStringList = <span class="hljs-built_in">make</span>([]*<span class="hljs-keyword">string</span>, <span class="hljs-built_in">len</span>((*source).E))<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>((*source).E); j++ &#123;<br><span class="hljs-keyword">var</span> pString2 *<span class="hljs-keyword">string</span><br><span class="hljs-keyword">if</span> (*source).E[j] != <span class="hljs-literal">nil</span> &#123;<br>xstring2 := *(*source).E[j]<br>pString2 = &amp;xstring2<br>&#125;<br>pStringList[j] = pString2<br>&#125;<br>&#125;<br>structsBNested.E = pStringList<br>pStructsBNested = &amp;structsBNested<br>&#125;<br><span class="hljs-keyword">return</span> pStructsBNested<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1、定义转换前后的结构体</p><p>2、定义接口指定如何转换，接口需要添加注解：<code>// goverter:converter</code></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// goverter:converter</span><br><span class="hljs-keyword">type</span> Converter <span class="hljs-keyword">interface</span> &#123;<br>  ConvertItems(source []Input) []Output<br><br>  <span class="hljs-comment">// goverter:ignore Irrelevant</span><br>  <span class="hljs-comment">// goverter:map Nested.AgeInYears Age</span><br>  Convert(source Input) Output<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p> <code>goverter:ignore</code> : 需要忽略的字段</p><p><code>goverter:map</code> ： 特殊字段映射</p></blockquote><p>3、执行转换命令生成转换代码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go run github.com/jmattheis/goverter/cmd/goverter@v0.17.4 ./<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>goverter</tag>
      
      <tag>struct</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang常见面试问题详解</title>
    <link href="/Myblog/2023/04/06/Golang%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2023/04/06/Golang%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h4 id="为什么map是非线程安全的？"><a href="#为什么map是非线程安全的？" class="headerlink" title="为什么map是非线程安全的？"></a>为什么map是非线程安全的？</h4><p>golang的map 跟hash map 是一样的，hash map 的内存是按照2的倍数开辟的，当前面开辟的内存不够的时候，会新开辟一段内存，将原来内存的数据转移到新的内存块中，这个过程是没有加锁的，如果这个时候同时有个读的线程过来获取这块内存数据，就会出现数据安全问题。</p><p>那么为什么golang的map设计时不加锁呢？ </p><p>作为基础的数据结构，常见的业务诉求根本不会应用到并发相关的场景，也就没有必要为了保证线程安全而进行加锁，大大降低代码执行的效率。</p><p>所以多个goroutine同时操作map的时候可能会出现concurrent map writes 的问题，如果需要应对并发场景，可以自己实现一个加好读写锁的map结构，建议直接用golang 的sync.Map。性能相对较好，同时简单易用。</p><h4 id="为什么redis要设计为单线程模式"><a href="#为什么redis要设计为单线程模式" class="headerlink" title="为什么redis要设计为单线程模式"></a>为什么redis要设计为单线程模式</h4><p>因为Redis是基于内存的数据操作，时间的花费主要集中在IO上，CPU不是Redis的性能瓶颈，Redis的瓶颈最有可能是机器内存的大小或者网络带宽。既然单线程容易实现，而且CPU不会成为瓶颈，那就顺理成章地采用单线程的方案了。</p><p>并且redis中还有类似list、hash等复杂的数据结构，这些结构有可能会进行很细粒度的操作，比如在很长的列表后面添加一个元素，在hash当中添加或者删除数据。这种情况下就需要加非常多的锁，导致同步的的开销大大增加，然而设计为单线程便不会有这些问题。</p><h4 id="redis为什么单线程还能支持如此高的并发"><a href="#redis为什么单线程还能支持如此高的并发" class="headerlink" title="redis为什么单线程还能支持如此高的并发"></a>redis为什么单线程还能支持如此高的并发</h4><ul><li><p>redis是基于内存，读写速度都非常的快</p></li><li><p>redis单线程，没有并发相关的问题，也省去了多线程竞争资源加锁和上下文切换的开销。</p></li><li><p>redis采用了非阻塞的IO多路复用技术，能够处理并发的连接，将接收到的指令统一放在队列中运行， 同一时刻只会有一个命令执行。内部实现采用epoll，采用了epoll+自己实现的简单的事件框架。epoll中的读、写、关闭、连接都转化成了事件，然后利用epoll的多路复用特性，绝不在io上浪费一点时间。这也是redis能够支持如此高吞吐量非常重要的原因。</p><blockquote><p>多路-指的是多个socket连接，复用-指的是复用一个线程。多路复用主要有三种技术：select，poll，epoll。epoll是最新的也是目前最好的多路复用技术。</p></blockquote></li></ul><h4 id="协程、线程、进程的区别"><a href="#协程、线程、进程的区别" class="headerlink" title="协程、线程、进程的区别"></a>协程、线程、进程的区别</h4><p><strong>基本概念：</strong></p><ul><li><p>进程：进程是操作系统进行资源分配的基本单位，每个进程都有自己的独立内存空间。由于进程比较重量，占据独立的内存，所以上下文进程间的切换开销（栈、寄存器、虚拟内存、文件句柄等）比较大，但相对比较稳定安全。</p></li><li><p>线程：线程又叫做轻量级进程，是进程的一个实体，是处理器任务调度和执行的基本单位位。它是比进程更小的能独立运行的基本单位。线程只拥有一点在运行中必不可少的资源(如程序计数器，一组寄存器和栈)，但是它可与同属一个进程的其他的线程共享进程所拥有的全部资源。</p></li><li><p>协程：协程又称微线程，是一种用户态的轻量级线程，协程的调度完全由用户控制（也就是在用户态执行）。协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到线程的堆区，在切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作栈则基本没有内核切换的开销，可以不加锁的访问全局变量，所以上下文的切换非常快。</p><p>协程最大的优势就是协程极高的执行效率。因为子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和线程切换相比，线程数量越多，协程的性能优势就越明显。不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。此外，一个线程的内存在MB级别，而协程只需要KB级别。</p></li></ul><p><strong>进程与线程区别：</strong></p><ol><li><p>根本区别：进程是操作系统资源分配的基本单位，而线程是处理器任务调度和执行的基本单位。</p></li><li><p>资源开销：每个进程都有独立的代码和数据空间，程序之间的切换会有较大的开销；线程可以看做轻量级的进程，同一进程的线程共享代码和数据空间，每个线程都有自己独立的运行栈和程序计数器，线程之间切换的开销小。</p></li><li><p>包含关系：如果一个进程内有多个线程，则执行过程不是一条线的，而是多条线（线程）共同完成的。</p></li><li><p>内存分配：同一进程的线程共享本进程的地址空间和资源，而进程之间的地址空间和资源是相互独立的。</p></li><li><p>影响关系：一个进程崩溃后，在保护模式下不会对其他进程产生影响，但是一个线程崩溃整个进程都死掉。所以多进程要比多线程健壮。</p></li><li><p>执行过程：每个独立的进程有程序运行的入口、顺序执行序列和程序出口。但是线程不能独立执行，必须依存在应用程序中，由应用程序提供多个线程执行控制。两者均可并发执行。</p></li></ol><p><strong>携程与线程的区别：</strong></p><ol><li>一个线程可以有多个协程。</li><li>大多数业务场景下，线程、进程可以看做是同步机制，而协程则是异步。</li><li>线程是抢占式，而协程是非抢占式的，所以需要用户代码释放使用权来切换到其他协程，因此同一时间其实只有一个协程拥有运行权，相当于单线程的能力。</li><li>协程并不是取代线程，而且抽象于线程之上。线程是被分割的CPU资源, 协程是组织好的代码流程, 协程需要线程来承载运行。</li></ol><h4 id="goroutine-和线程的区别"><a href="#goroutine-和线程的区别" class="headerlink" title="goroutine 和线程的区别"></a>goroutine 和线程的区别</h4>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>面试</tag>
      
      <tag>go</tag>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis常见问题详解</title>
    <link href="/Myblog/2023/03/17/Redis%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2023/03/17/Redis%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h4 id="为什么redis要设计为单线程模式"><a href="#为什么redis要设计为单线程模式" class="headerlink" title="为什么redis要设计为单线程模式"></a>为什么redis要设计为单线程模式</h4><p>因为Redis是基于内存的数据操作，时间的花费主要集中在IO上，CPU不是Redis的性能瓶颈，Redis的瓶颈最有可能是机器内存的大小或者网络带宽。既然单线程容易实现，而且CPU不会成为瓶颈，那就顺理成章地采用单线程的方案了。</p><p>并且redis中还有类似list、hash等复杂的数据结构，这些结构有可能会进行很细粒度的操作，比如在很长的列表后面添加一个元素，在hash当中添加或者删除数据。这种情况下就需要加非常多的锁，导致同步的的开销大大增加，然而设计为单线程便不会有这些问题。</p><h4 id="redis单线程却可以承担几十万的并发"><a href="#redis单线程却可以承担几十万的并发" class="headerlink" title="redis单线程却可以承担几十万的并发"></a>redis单线程却可以承担几十万的并发</h4><ul><li><p>redis是基于内存，读写速度都非常的快</p></li><li><p>redis单线程，没有并发相关的问题，也省去了多线程竞争资源加锁和上下文切换的开销。</p></li><li><p>redis采用了非阻塞的IO多路复用技术，能够处理并发的连接，将接收到的指令统一放在队列中运行， 同一时刻只会有一个命令执行。内部实现采用epoll，采用了epoll+自己实现的简单的事件框架。epoll中的读、写、关闭、连接都转化成了事件，然后利用epoll的多路复用特性，绝不在io上浪费一点时间。这也是redis能够支持如此高吞吐量非常重要的原因。</p><blockquote><p>多路-指的是多个socket连接，复用-指的是复用一个线程。多路复用主要有三种技术：select，poll，epoll。epoll是最新的也是目前最好的多路复用技术。</p></blockquote></li></ul><h4 id="redis的弊端"><a href="#redis的弊端" class="headerlink" title="redis的弊端"></a>redis的弊端</h4><ul><li>单线程无法发挥cpu多核的性能，一旦cpu成为了性能瓶颈，就需要开启多个redis实例来支持，并且需要考虑多个redis实例之间数据同步的问题。</li></ul>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数字证书详解</title>
    <link href="/Myblog/2022/07/05/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2022/07/05/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>我们知道，摘要算法用来确保数据没有被篡改，非对称加密算法可以对数据进行加解密，签名算法可以确保数据完整性和抗否认性，把这些算法集合到一起，并搞一套完善的标准，这就是数字证书。</p><p>因此，数字证书就是集合了多种密码学算法，用于实现数据加解密、身份认证、签名等多种功能的一种安全标准。</p><p>数字证书可以防止中间人攻击，因为它采用链式签名认证，即通过根证书（Root CA）去签名下一级证书，这样层层签名，直到最终的用户证书。而Root CA证书内置于操作系统中，所以，任何经过CA认证的数字证书都可以对其本身进行校验，确保证书本身不是伪造的。</p><h2 id="生成证书与转换证书格式命令"><a href="#生成证书与转换证书格式命令" class="headerlink" title="生成证书与转换证书格式命令"></a>生成证书与转换证书格式命令</h2><p><strong>需要提前安装<code>openssl</code>和<code>keytool</code>工具</strong></p><h4 id="生成RSA密钥对"><a href="#生成RSA密钥对" class="headerlink" title="生成RSA密钥对"></a>生成RSA密钥对</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lsl">openssl genrsa -out rsa_private.<span class="hljs-type">key</span> <span class="hljs-number">2048</span><br>openssl req -new -x509 -days <span class="hljs-number">3650</span> -<span class="hljs-type">key</span> rsa_private.<span class="hljs-type">key</span> -out pub.cer<br></code></pre></td></tr></table></figure><h4 id="生成keystore并设置密码"><a href="#生成keystore并设置密码" class="headerlink" title="生成keystore并设置密码"></a>生成keystore并设置密码</h4><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">keytool -genkey -<span class="hljs-built_in">alias</span> <span class="hljs-built_in">encrypt</span> -keyalg RSA -validity <span class="hljs-number">3650</span> -keystore prod_encrypt.keystore<br></code></pre></td></tr></table></figure><h4 id="keystore生成cer文件"><a href="#keystore生成cer文件" class="headerlink" title="keystore生成cer文件"></a>keystore生成cer文件</h4><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">keytool -exportcert -<span class="hljs-built_in">alias</span> <span class="hljs-built_in">encrypt</span> -keystore prod_encrypt.keystore -storepass &lt;password&gt; -storetype pkcs12 -rfc -<span class="hljs-built_in">file</span> &lt;cer&gt; <br></code></pre></td></tr></table></figure><h4 id="keystore转换为pem并去掉pem密码"><a href="#keystore转换为pem并去掉pem密码" class="headerlink" title="keystore转换为pem并去掉pem密码"></a>keystore转换为pem并去掉pem密码</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">keytool</span> <span class="hljs-selector-tag">-importkeystore</span> <span class="hljs-selector-tag">-srckeystore</span> <span class="hljs-selector-tag">prod_encrypt</span><span class="hljs-selector-class">.keystore</span> <span class="hljs-selector-tag">-destkeystore</span> <span class="hljs-selector-tag">prod_encrypt</span><span class="hljs-selector-class">.p12</span> <span class="hljs-selector-tag">-deststoretype</span> <span class="hljs-selector-tag">PKCS12</span><br><span class="hljs-selector-tag">openssl</span> <span class="hljs-selector-tag">pkcs12</span> <span class="hljs-selector-tag">-in</span> <span class="hljs-selector-tag">prod_encrypt</span><span class="hljs-selector-class">.p12</span> <span class="hljs-selector-tag">-nocerts</span> <span class="hljs-selector-tag">-nodes</span> <span class="hljs-selector-tag">-out</span> <span class="hljs-selector-tag">prod_encrypt</span><span class="hljs-selector-class">.key</span>   # 转为<span class="hljs-selector-tag">pem</span><br><span class="hljs-selector-tag">openssl</span> <span class="hljs-selector-tag">rsa</span> <span class="hljs-selector-tag">-in</span> <span class="hljs-selector-tag">prod_encrypt</span><span class="hljs-selector-class">.key</span> <span class="hljs-selector-tag">-out</span> <span class="hljs-selector-tag">pri_key</span><span class="hljs-selector-class">.pem</span>   # 去掉<span class="hljs-selector-tag">pem</span>密码<br></code></pre></td></tr></table></figure><h4 id="pkcs1转pksc8"><a href="#pkcs1转pksc8" class="headerlink" title="pkcs1转pksc8"></a>pkcs1转pksc8</h4><p>pkcs1 - BEGIN RSA PRIVATE KEY</p><p>pksc8 - BEGIN PRIVATE KEY</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">openssl</span> pkcs<span class="hljs-number">8</span> -topk<span class="hljs-number">8</span> -inform PEM -in pri_key.pem -outform pem -nocrypt -out pkcs<span class="hljs-number">8</span>.pem<br></code></pre></td></tr></table></figure><h4 id="pkcs8转pksc1"><a href="#pkcs8转pksc1" class="headerlink" title="pkcs8转pksc1"></a>pkcs8转pksc1</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">openssl</span> <span class="hljs-selector-tag">rsa</span> <span class="hljs-selector-tag">-in</span> <span class="hljs-selector-tag">pkcs8</span><span class="hljs-selector-class">.pem</span> <span class="hljs-selector-tag">-out</span> <span class="hljs-selector-tag">pri_key</span><span class="hljs-selector-class">.pem</span><br></code></pre></td></tr></table></figure><h4 id="私钥生成公钥"><a href="#私钥生成公钥" class="headerlink" title="私钥生成公钥"></a>私钥生成公钥</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">openssl</span> <span class="hljs-selector-tag">rsa</span> <span class="hljs-selector-tag">-in</span> <span class="hljs-selector-tag">pri_key</span><span class="hljs-selector-class">.pem</span> <span class="hljs-selector-tag">-pubout</span> <span class="hljs-selector-tag">-out</span> <span class="hljs-selector-tag">pub_key</span><span class="hljs-selector-class">.pem</span><br></code></pre></td></tr></table></figure><h4 id="PFX转PEM"><a href="#PFX转PEM" class="headerlink" title="PFX转PEM"></a>PFX转PEM</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">openssl</span> <span class="hljs-selector-tag">pkcs12</span> <span class="hljs-selector-tag">-in</span> <span class="hljs-selector-tag">private</span><span class="hljs-selector-class">.pfx</span> <span class="hljs-selector-tag">-nocerts</span> <span class="hljs-selector-tag">-nodes</span> <span class="hljs-selector-tag">-out</span> <span class="hljs-selector-tag">pfx_private</span><span class="hljs-selector-class">.key</span><br>如果有密码，抹掉密码<br><span class="hljs-selector-tag">openssl</span> <span class="hljs-selector-tag">rsa</span> <span class="hljs-selector-tag">-in</span> <span class="hljs-selector-tag">pfx_private</span><span class="hljs-selector-class">.key</span> <span class="hljs-selector-tag">-out</span> <span class="hljs-selector-tag">pfx_prv</span><span class="hljs-selector-class">.pem</span><br><span class="hljs-selector-tag">openssl</span> <span class="hljs-selector-tag">rsa</span> <span class="hljs-selector-tag">-in</span> <span class="hljs-selector-tag">pfx_private</span><span class="hljs-selector-class">.key</span> <span class="hljs-selector-tag">-pubout</span> <span class="hljs-selector-tag">-out</span> <span class="hljs-selector-tag">pfx_pub</span><span class="hljs-selector-class">.pem</span><br></code></pre></td></tr></table></figure><h4 id="CER转PEM"><a href="#CER转PEM" class="headerlink" title="CER转PEM"></a>CER转PEM</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">openssl</span> <span class="hljs-selector-tag">x509</span> <span class="hljs-selector-tag">-in</span> <span class="hljs-selector-tag">xiamen_encrypt</span><span class="hljs-selector-class">.cer</span> <span class="hljs-selector-tag">-pubkey</span> <span class="hljs-selector-tag">-noout</span> &gt; <span class="hljs-selector-tag">xiamen_pub</span><span class="hljs-selector-class">.pem</span><br></code></pre></td></tr></table></figure><h4 id="生成x509证书以及对应私钥"><a href="#生成x509证书以及对应私钥" class="headerlink" title="生成x509证书以及对应私钥"></a>生成x509证书以及对应私钥</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">openssl req -newkey rsa:<span class="hljs-number">2048</span> -nodes -keyout certificate_key.pem -x509 -days <span class="hljs-number">356</span> -<span class="hljs-keyword">out</span> certificate.pem<br></code></pre></td></tr></table></figure><h4 id="查看证书内容"><a href="#查看证书内容" class="headerlink" title="查看证书内容"></a>查看证书内容</h4><p>Issuer 证书颁发机构 - Subject 证书拥有者 自签名证书：颁发机构和拥有者是同一个人，一般在内部局域网系统使用，不能在互联网使用。 </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">openssl</span> x<span class="hljs-number">509</span> -in certificate.pem -text<br></code></pre></td></tr></table></figure><h2 id="练习实例"><a href="#练习实例" class="headerlink" title="练习实例"></a>练习实例</h2><p><strong>Alice需要发送一个电子合同给Bob，那么证书的签发、使用和验证过程是怎么样的？</strong></p><ol><li><p>首先由证书机构创建自签名证书(根证书) <code>openssl req -newkey rsa:2048 -nodes -keyout certificate.key -x509 -days 356 -out certificate.crt</code></p></li><li><p>用户创建自己的私钥以及csr(证书请求) <code>openssl req -new -nodes -keyout Alice.key -out Alice.csr</code></p></li><li><p>用证书机构的私钥、根证书和Alice的csr为Alice创建数字证书 <code>openssl x509 -req -in Alice.csr -CA certificate.crt -CAkey certificate.key -CAcreateserial -out Alice.crt</code></p><blockquote><p>成功后生成文件certificate.srl，记录机构颁发证书序列号</p></blockquote></li><li><p>Alice使用私钥对商业合同进行签名，然后把签名后的合同和Alice的数字证书一起给Bob <code>echo &quot;this is a encode text&quot; &gt; alice-contract</code> <code>openssl dgst -sha256 -sign Alice.key -out alice-contract-sign.sha256 alice-contract</code></p></li><li><p>Bob收到合同后，要先验证Alice的证书是否合法 <code>openssl verify Alice.crt</code> 没有指定证书，会使用操作系统内置的根证书去验证(失败) <code>openssl verify -CAfile certificate.crt</code> 验证成功</p></li><li><p>验收了Alice的证书后，使用Alice的证书中的公钥对合同的电子签名进行验证，以证明合同是否由Alice发出的</p><ul><li><p>从Alice的数字证书中到处导出Alice的公钥 <code>openssl x509 -pubkey -noout -in Alice.crt &gt; Alice-pub.key</code></p></li><li><p>使用公钥对合同签名进行验证 <code>openssl dgst -sha256 -verify Alice-pub.key -signature alice-contract-sign.sha256 alice-contract</code> 校验成功！</p></li></ul></li></ol>]]></content>
    
    
    <categories>
      
      <category>证书</category>
      
    </categories>
    
    
    <tags>
      
      <tag>证书</tag>
      
      <tag>数字证书</tag>
      
      <tag>openssl</tag>
      
      <tag>keytool</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang之atomic原子操作</title>
    <link href="/Myblog/2022/06/10/Golang%E4%B9%8Batomic%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"/>
    <url>/Myblog/2022/06/10/Golang%E4%B9%8Batomic%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>对于并发操作而言，原子操作是个非常现实的问题。典型的就是i++的问题。 当两个CPU同时对内存中的i进行读取，然后把加一之后的值放入内存中，可能两次i++的结果，这个i只增加了一次。 如何保证多CPU对同一块内存的操作是原子的。 golang中sync/atomic就是做这个使用的。</p><p>具体的原子操作在不同的操作系统中实现是不同的。比如在Intel的CPU架构机器上，主要是使用总线锁的方式实现的。 大致的意思就是当一个CPU需要操作一个内存块的时候，向总线发送一个LOCK信号，所有CPU收到这个信号后就不对这个内存块进行操作了。 等待操作的CPU执行完操作后，发送UNLOCK信号，才结束。 在AMD的CPU架构机器上就是使用MESI一致性协议的方式来保证原子操作。 所以我们在看atomic源码的时候，我们看到它针对不同的操作系统有不同汇编语言文件。</p><h2 id="互斥锁与原子操作的区别"><a href="#互斥锁与原子操作的区别" class="headerlink" title="互斥锁与原子操作的区别"></a>互斥锁与原子操作的区别</h2><p>平日里，在并发编程里，Go语言<code>sync</code>包里的同步原语<code>Mutex</code>是我们经常用来保证并发安全的，那么他跟<code>atomic</code>包里的这些操作有啥区别呢？在我看来他们在使用目的和底层实现上都不一样：</p><ul><li>使用目的：互斥锁是用来保护一段逻辑，原子操作用于对一个变量的更新保护。</li><li>底层实现：<code>Mutex</code>由<strong>操作系统</strong>的调度器实现，而<code>atomic</code>包中的原子操作则由<strong>底层硬件指令</strong>直接提供支持，这些指令在执行的过程中是不允许中断的，因此原子操作可以在<code>lock-free</code>的情况下保证并发安全，并且它的性能也能做到随<code>CPU</code>个数的增多而线性扩展。</li></ul><p>对于一个变量更新的保护，原子操作通常会更有效率，并且更能利用计算机多核的优势。原子操作由<strong>底层硬件</strong>支持，而锁则由操作系统的<strong>调度器</strong>实现。锁应当用来保护一段逻辑，对于一个变量更新的保护，原子操作通常会更有效率，并且更能利用计算机多核的优势。</p><p>比如下面这个计数程序，分别使用互斥锁和原子操作：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mutexAdd</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> a <span class="hljs-keyword">int32</span> =  <span class="hljs-number">0</span><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    <span class="hljs-keyword">var</span> mu sync.Mutex<br>    start := time.Now()<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000000</span>; i++ &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            mu.Lock()<br>            a += <span class="hljs-number">1</span><br>            mu.Unlock()<br>        &#125;()<br>    &#125;<br>    wg.Wait()<br>    timeSpends := time.Now().Sub(start).Nanoseconds()<br>    fmt.Printf(<span class="hljs-string">&quot;use mutex a is %d, spend time: %v\n&quot;</span>, a, timeSpends)<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AtomicAdd</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> a <span class="hljs-keyword">int32</span> =  <span class="hljs-number">0</span><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    start := time.Now()<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            atomic.AddInt32(&amp;a, <span class="hljs-number">1</span>)<br>        &#125;()<br>    &#125;<br>    wg.Wait()<br>    timeSpends := time.Now().Sub(start).Nanoseconds()<br>    fmt.Printf(<span class="hljs-string">&quot;use atomic a is %d, spend time: %v\n&quot;</span>, atomic.LoadInt32(&amp;a), timeSpends)<br>&#125;<br></code></pre></td></tr></table></figure><p>可以观察到计数器的结果都最后都是<code>1000000</code>，都是线程安全的。</p><p><strong>需要注意的是，所有原子操作方法的被操作数形参必须是指针类型，通过指针变量可以获取被操作数在内存中的地址，从而施加特殊的CPU指令，确保同一时间只有一个goroutine能够进行操作</strong>。</p><h2 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h2><h3 id="增加或减少"><a href="#增加或减少" class="headerlink" title="增加或减少"></a>增加或减少</h3><p>对一个数值进行增加或者减少的行为也需要保证是原子的，它对应于atomic包的函数就是</p><ul><li>func AddInt32(addr *int32, delta int32) (new int32)</li><li>func AddInt64(addr *int64, delta int64) (new int64)</li><li>func AddUint32(addr *uint32, delta uint32) (new uint32)</li><li>func AddUint64(addr *uint64, delta uint64) (new uint64)</li><li>func AddUintptr(addr *uintptr, delta uintptr) (new uintptr)</li></ul><p>相关例子见上文</p><h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><p>原子操作中最经典的CAS(compare-and-swap)在atomic包中是Compare开头的函数。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapInt32</span><span class="hljs-params">(addr *<span class="hljs-keyword">int32</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">int32</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapInt64</span><span class="hljs-params">(addr *<span class="hljs-keyword">int64</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">int64</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapPointer</span><span class="hljs-params">(addr *unsafe.Pointer, old, <span class="hljs-built_in">new</span> unsafe.Pointer)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapUint32</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint32</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uint32</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapUint64</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint64</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uint64</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapUintptr</span><span class="hljs-params">(addr *<span class="hljs-keyword">uintptr</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uintptr</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br></code></pre></td></tr></table></figure><p>CAS的意思是判断内存中的某个值是否等于old值，如果是的话，则赋new值给这块内存。CAS是一个方法，并不局限在CPU原子操作中。 CAS比互斥锁乐观，但是也就代表CAS是有赋值不成功的时候，调用CAS的那一方就需要处理赋值不成功的后续行为了。</p><p>这一系列的函数需要比较后再进行交换，也有不需要进行比较就进行交换的原子操作。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapInt32</span><span class="hljs-params">(addr *<span class="hljs-keyword">int32</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">int32</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">int32</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapInt64</span><span class="hljs-params">(addr *<span class="hljs-keyword">int64</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">int64</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">int64</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapPointer</span><span class="hljs-params">(addr *unsafe.Pointer, <span class="hljs-built_in">new</span> unsafe.Pointer)</span> <span class="hljs-params">(old unsafe.Pointer)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapUint32</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint32</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uint32</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">uint32</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapUint64</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint64</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uint64</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">uint64</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapUintptr</span><span class="hljs-params">(addr *<span class="hljs-keyword">uintptr</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uintptr</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">uintptr</span>)</span></span><br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-comment">// 定义一个struct类型P</span><br><span class="hljs-keyword">type</span> P <span class="hljs-keyword">struct</span>&#123; x, y, z <span class="hljs-keyword">int</span> &#125;<br><br><span class="hljs-comment">// 执行类型P的指针</span><br><span class="hljs-keyword">var</span> pP *P<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>    <span class="hljs-comment">// 定义一个执行unsafe.Pointer值的指针变量</span><br>    <span class="hljs-keyword">var</span> unsafe1 = (*unsafe.Pointer)(unsafe.Pointer(&amp;pP))<br><br>    <span class="hljs-comment">// Old pointer</span><br>    <span class="hljs-keyword">var</span> sy P<br><br>    <span class="hljs-comment">// 为了演示效果先将unsafe1设置成Old Pointer</span><br>    px := atomic.SwapPointer(<br>        unsafe1, unsafe.Pointer(&amp;sy))<br><br>    <span class="hljs-comment">// 执行CAS操作，交换成功，结果返回true</span><br>    y := atomic.CompareAndSwapPointer(<br>        unsafe1, unsafe.Pointer(&amp;sy), px)<br><br>    fmt.Println(y)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="读取或写入"><a href="#读取或写入" class="headerlink" title="读取或写入"></a>读取或写入</h3><p>当我们要读取一个变量的时候，很有可能这个变量正在被写入，这个时候，我们就很有可能读取到写到一半的数据。 所以读取操作是需要一个原子行为的。在atomic包中就是Load开头的函数群。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadInt32</span><span class="hljs-params">(addr *<span class="hljs-keyword">int32</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">int32</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadInt64</span><span class="hljs-params">(addr *<span class="hljs-keyword">int64</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">int64</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadPointer</span><span class="hljs-params">(addr *unsafe.Pointer)</span> <span class="hljs-params">(val unsafe.Pointer)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadUint32</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint32</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">uint32</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadUint64</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint64</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">uint64</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadUintptr</span><span class="hljs-params">(addr *<span class="hljs-keyword">uintptr</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">uintptr</span>)</span></span><br></code></pre></td></tr></table></figure><p>好了，读取我们是完成了原子性，那写入呢？也是同样的，如果有多个CPU往内存中一个数据块写入数据的时候，可能导致这个写入的数据不完整。 在atomic包对应的是Store开头的函数群。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreInt32</span><span class="hljs-params">(addr *<span class="hljs-keyword">int32</span>, val <span class="hljs-keyword">int32</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreInt64</span><span class="hljs-params">(addr *<span class="hljs-keyword">int64</span>, val <span class="hljs-keyword">int64</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StorePointer</span><span class="hljs-params">(addr *unsafe.Pointer, val unsafe.Pointer)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreUint32</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint32</span>, val <span class="hljs-keyword">uint32</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreUint64</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint64</span>, val <span class="hljs-keyword">uint64</span>)</span></span><br>- <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreUintptr</span><span class="hljs-params">(addr *<span class="hljs-keyword">uintptr</span>, val <span class="hljs-keyword">uintptr</span>)</span></span><br></code></pre></td></tr></table></figure><p><strong>atomic.Value保证任意值的读写安全!</strong></p><p>如果你想要并发安全的设置一个结构体的多个字段，一般的我们需要把结构体转换为指针，通过<code>StorePointer</code>来进行操作。我们还可以使用<code>atomic</code>包后来引入的<code>atomic.Value</code>，它在底层为我们完成了从具体指针类型到<code>unsafe.Pointer</code>之间的转换。它使得我们可以不依赖于不保证兼容性的<code>unsafe.Pointer</code>类型，同时又能将任意数据类型的读写操作封装成原子性操作（中间状态对外不可见）。</p><p><code>atomic.Value</code>类型对外暴露了两个方法：</p><ul><li><code>v.Store(c)</code> - 写操作，将原始的变量<code>c</code>存放到一个<code>atomic.Value</code>类型的<code>v</code>里。</li><li><code>c := v.Load()</code> - 读操作，从线程安全的<code>v</code>中读取上一步存放的内容。</li></ul><p>1.17 版本我看还增加了<code>Swap</code>和<code>CompareAndSwap</code>方法。</p><p>简洁的接口使得它的使用也很简单，只需将需要做并发保护的变量读取和赋值操作用<code>Load()</code>和<code>Store()</code>代替就行了。</p><p>由于<code>Load()</code>返回的是一个<code>interface&#123;&#125;</code>类型，所以在使用前我们记得要先转换成具体类型的值，再使用。下面是一个简单的例子演示<code>atomic.Value</code>的用法。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;sync&quot;</span><br>    <span class="hljs-string">&quot;sync/atomic&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Rectangle <span class="hljs-keyword">struct</span> &#123;<br>    length <span class="hljs-keyword">int</span><br>    width  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-keyword">var</span> rect atomic.Value<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">update</span><span class="hljs-params">(width, length <span class="hljs-keyword">int</span>)</span></span> &#123;<br>    rectLocal := <span class="hljs-built_in">new</span>(Rectangle)<br>    rectLocal.width = width<br>    rectLocal.length = length<br>    rect.Store(rectLocal)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    wg := sync.WaitGroup&#123;&#125;<br>    wg.Add(<span class="hljs-number">10</span>)<br>    <span class="hljs-keyword">var</span> n <span class="hljs-keyword">int</span><br>    <span class="hljs-comment">// 10 个协程并发更新</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>        n = i<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            update(n, n+<span class="hljs-number">5</span>)<br>        &#125;()<br>    &#125;<br>    wg.Wait()<br>    _r := rect.Load().(*Rectangle)<br>    fmt.Printf(<span class="hljs-string">&quot;rect.width=%d\nrect.length=%d\n&quot;</span>, _r.width, _r.length)<br>&#125;<br><span class="hljs-comment">// rect.width=9</span><br><span class="hljs-comment">// rect.length=14</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原子操作</tag>
      
      <tag>atomic</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang实现简单的内存级别缓存</title>
    <link href="/Myblog/2022/05/11/Golang%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E5%AD%98%E7%BA%A7%E5%88%AB%E7%BC%93%E5%AD%98/"/>
    <url>/Myblog/2022/05/11/Golang%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E5%AD%98%E7%BA%A7%E5%88%AB%E7%BC%93%E5%AD%98/</url>
    
    <content type="html"><![CDATA[<p>使用go自带的sync.Map和time.AfterFunc可以很简单的实现一个基于内存的缓存map。key不多的时候，效果还是很不错的。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> cache<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;sync&quot;</span><br><span class="hljs-string">&quot;sync/atomic&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> CacheMap sync.Map<br><span class="hljs-keyword">var</span> CacheLength <span class="hljs-keyword">int64</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Set</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, data <span class="hljs-keyword">interface</span>&#123;&#125;, timeout <span class="hljs-keyword">int</span>)</span></span> &#123;<br>CacheMap.Store(key, data)<br>atomic.AddInt64(&amp;CacheLength, <span class="hljs-number">1</span>)<br>time.AfterFunc(time.Second*time.Duration(timeout), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>atomic.AddInt64(&amp;CacheLength, <span class="hljs-number">-1</span>)<br>CacheMap.Delete(key)<br>&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Get</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-keyword">bool</span>)</span></span> &#123;<br><span class="hljs-keyword">return</span> CacheMap.Load(key)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Len</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">int</span>(CacheLength)<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>缓存</tag>
      
      <tag>cache</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>一个简单的键值存储数据库boltdb</title>
    <link href="/Myblog/2022/04/21/%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E9%94%AE%E5%80%BC%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93boltdb/"/>
    <url>/Myblog/2022/04/21/%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E9%94%AE%E5%80%BC%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93boltdb/</url>
    
    <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Bolt 是由 Howard Chu 的 <a href="https://link.jianshu.com/?t=https://symas.com/lmdb/technical/">LMDB</a> 项目启发的一个纯粹的 Go key/value数据库。 该项目的目标是为不需要完整数据库服务器（如Postgres或MySQL）的项目提供一个简单，快速和可靠的数据库。</p><p>Bolt 最初的目标是提供一个简单的纯 Go key/value 存储，并且不会使代码具有多余的特性。目前该项目取得了成功，所以作者已经宣布不再对其进行维护。 Blot 处于稳定状态，并有多年的成功生产使用。因此，作者觉得把它放在现在的状态是最谨慎的做法。</p><h3 id="bolt使用方法"><a href="#bolt使用方法" class="headerlink" title="bolt使用方法"></a>bolt使用方法</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go get -u github.com/boltdb/bolt/...<br></code></pre></td></tr></table></figure><h4 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;log&quot;</span><br><br>    <span class="hljs-string">&quot;github.com/boltdb/bolt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// Open the my.db data file in your current directory.</span><br>    <span class="hljs-comment">// It will be created if it doesn&#x27;t exist.</span><br>    db, err := bolt.Open(<span class="hljs-string">&quot;my.db&quot;</span>, <span class="hljs-number">0600</span>, &amp;bolt.Options&#123;Timeout: <span class="hljs-number">1</span> * time.Second&#125;)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br>    <span class="hljs-keyword">defer</span> db.Close()<br><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>请注意，Bolt 会在数据文件上获得文件锁，因此多个进程无法同时打开同一个数据库。打开一个已经打开的 Bolt 数据库会导致它挂起，直到其他进程关闭它。为了防止无限期等待，您可以将超时选项传递给<code>Open()</code>函数：</p></blockquote><h4 id="读写事务"><a href="#读写事务" class="headerlink" title="读写事务"></a>读写事务</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs golang">err := db.Update(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span> <span class="hljs-title">error</span></span> &#123;<br>    ...<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br></code></pre></td></tr></table></figure><h4 id="只读事务"><a href="#只读事务" class="headerlink" title="只读事务"></a>只读事务</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs golang">err := db.View(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span> <span class="hljs-title">error</span></span> &#123;<br>    ...<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br></code></pre></td></tr></table></figure><h4 id="手动事务"><a href="#手动事务" class="headerlink" title="手动事务"></a>手动事务</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// Start a writable transaction.</span><br>tx, err := db.Begin(<span class="hljs-literal">true</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-keyword">defer</span> tx.Rollback()<br><br><span class="hljs-comment">// Use the transaction...</span><br>_, err := tx.CreateBucket([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;MyBucket&quot;</span>))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">// Commit the transaction and check for error.</span><br><span class="hljs-keyword">if</span> err := tx.Commit(); err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>第一个参数<code>DB.Begin()</code>是一个布尔值，说明事务是否应该是可写的。</p></blockquote><h4 id="创建桶"><a href="#创建桶" class="headerlink" title="创建桶"></a>创建桶</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs golang">db.Update(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span> <span class="hljs-title">error</span></span> &#123;<br>    b, err := tx.CreateBucket([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;MyBucket&quot;</span>))<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;create bucket: %s&quot;</span>, err)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br></code></pre></td></tr></table></figure><h4 id="设置键值对"><a href="#设置键值对" class="headerlink" title="设置键值对"></a>设置键值对</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs golang">db.Update(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span> <span class="hljs-title">error</span></span> &#123;<br>    b := tx.Bucket([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;MyBucket&quot;</span>))<br>    err := b.Put([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;answer&quot;</span>), []<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;42&quot;</span>))<br>    <span class="hljs-keyword">return</span> err<br>&#125;)<br></code></pre></td></tr></table></figure><h4 id="遍历键值对"><a href="#遍历键值对" class="headerlink" title="遍历键值对"></a>遍历键值对</h4><p>Bolt 将其密钥以字节排序的顺序存储在存储桶中。这使得对这些键的顺序迭代非常快。要遍历键，我们将使用 <code>Cursor</code></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs golang">db.View(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span> <span class="hljs-title">error</span></span> &#123;<br>    <span class="hljs-comment">// Assume bucket exists and has keys</span><br>    b := tx.Bucket([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;MyBucket&quot;</span>))<br><br>    c := b.Cursor()<br><br>    <span class="hljs-keyword">for</span> k, v := c.First(); k != <span class="hljs-literal">nil</span>; k, v = c.Next() &#123;<br>        fmt.Printf(<span class="hljs-string">&quot;key=%s, value=%s\n&quot;</span>, k, v)<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br></code></pre></td></tr></table></figure><h4 id="前缀扫描"><a href="#前缀扫描" class="headerlink" title="前缀扫描"></a>前缀扫描</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs golang">db.View(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span> <span class="hljs-title">error</span></span> &#123;<br>    <span class="hljs-comment">// Assume bucket exists and has keys</span><br>    c := tx.Bucket([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;MyBucket&quot;</span>)).Cursor()<br><br>    prefix := []<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;1234&quot;</span>)<br>    <span class="hljs-keyword">for</span> k, v := c.Seek(prefix); k != <span class="hljs-literal">nil</span> &amp;&amp; bytes.HasPrefix(k, prefix); k, v = c.Next() &#123;<br>        fmt.Printf(<span class="hljs-string">&quot;key=%s, value=%s\n&quot;</span>, k, v)<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br></code></pre></td></tr></table></figure><h4 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BackUpDB</span><span class="hljs-params">(backupFilsPath <span class="hljs-keyword">string</span>)</span></span> &#123;<br>    db := database.GetBoltDB()<br>    <span class="hljs-keyword">defer</span> db.Close()<br>    db.View(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span> <span class="hljs-title">error</span></span> &#123;<br>        <span class="hljs-keyword">return</span> tx.CopyFile(backupFilsPath, <span class="hljs-number">0600</span>)<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>官方介绍备份方法如下</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BackupHandleFunc</span><span class="hljs-params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;<br>    err := db.View(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span> <span class="hljs-title">error</span></span> &#123;<br>        w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>)<br>        w.Header().Set(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">`attachment; filename=&quot;my.db&quot;`</span>)<br>        w.Header().Set(<span class="hljs-string">&quot;Content-Length&quot;</span>, strconv.Itoa(<span class="hljs-keyword">int</span>(tx.Size())))<br>        _, err := tx.WriteTo(w)<br>        <span class="hljs-keyword">return</span> err<br>    &#125;)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        http.Error(w, err.Error(), http.StatusInternalServerError)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>curl http://localhost/backup &gt; my.db</code></p></blockquote><h4 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h4><p>将备份文件，直接覆盖db文件即可，简单粗暴。</p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="https://github.com/boltdb/bolt#installing">GitHub - boltdb/bolt: An embedded key/value database for Go.</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>bolt</tag>
      
      <tag>键值存储</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go gRPC入门与实践</title>
    <link href="/Myblog/2022/04/20/Go-gRPC%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/"/>
    <url>/Myblog/2022/04/20/Go-gRPC%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h3 id="什么是gRPC"><a href="#什么是gRPC" class="headerlink" title="什么是gRPC"></a>什么是gRPC</h3><p>要说gRPC，需要先了解什么是RPC。</p><p><strong>RPC</strong> (Remote Procedure Call)是远程过程调用，比如说现在有两台服务器A, B，一个在A服务器上的应用想要调用B服务器上的应用，由于不在两个方法不在一个内存空间，不能直接调用，需要通过网络表达调用的语义和传达调用的数据。常存在于分布式系统中。<strong>RPC的本质是提供了一种轻量无感知的跨进程通信的方式</strong></p><p><strong>gRPC</strong> 是谷歌开源的一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计。带来诸如双向流、流控、头部压缩、单 TCP 连接上的多复用请求等特。这些特性使得其在移动设备上表现更好，更省电和节省空间占用。</p><ul><li>内容交换格式采用ProtoBuf(Google Protocol Buffers)，开源已久，提供了一种灵活、高效、自动序列化结构数据的机制，作用与XML，Json类似，但使用二进制，（反）序列化速度快，压缩效率高。</li><li>传输协议 采用http2，性能比http1.1好了很多。</li></ul><h3 id="安装protoc协议编译器插件"><a href="#安装protoc协议编译器插件" class="headerlink" title="安装protoc协议编译器插件"></a>安装protoc协议编译器插件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28<br>go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2<br></code></pre></td></tr></table></figure><blockquote><p>将<code>$GOPATH/bin</code>添加到PATH中</p></blockquote><h3 id="编写和编译-proto文件"><a href="#编写和编译-proto文件" class="headerlink" title="编写和编译 proto文件"></a>编写和编译 proto文件</h3><p><code>kstor.proto</code></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-comment">// 指定使用 proto3 版本</span><br>syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-comment">// 分号前后分别代表: 生成的go文件的存放地址(会自动生成目录) 和 生成的go文件所属的包名</span><br><span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;./;kstor_proto&quot;</span>;<br><br><span class="hljs-comment">// 随便定义一个包名</span><br><span class="hljs-keyword">package</span> grpc.service.kstor_proto;<br><br><span class="hljs-comment">// The greeting service definition.</span><br><span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">Greeter</span> </span>&#123;<br>  <span class="hljs-comment">// 发送问候方法名，有无stream代表了是否要用串流还是单向</span><br>  <span class="hljs-comment">// rpc SayCreateBucket (RequestCreateBucket) returns (stream ReplyCreateBucket) &#123;&#125;</span><br>  <span class="hljs-function"><span class="hljs-keyword">rpc</span> SayGetKey (RequestGetKey) <span class="hljs-keyword">returns</span> (ReplyGetKey) </span>&#123;&#125;<br>  <span class="hljs-function"><span class="hljs-keyword">rpc</span> SaySetKey (RequestSetKey) <span class="hljs-keyword">returns</span> (ReplySetKey) </span>&#123;&#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">RequestGetKey</span> </span>&#123;<br> <span class="hljs-comment">//  类型 变量名 序列号(与Reply对应)</span><br>  <span class="hljs-built_in">string</span> addr = <span class="hljs-number">1</span>;<br>  <span class="hljs-built_in">string</span> port = <span class="hljs-number">2</span>;<br>  <span class="hljs-built_in">string</span> key = <span class="hljs-number">3</span>;<br>  <span class="hljs-built_in">string</span> prefixKey = <span class="hljs-number">4</span>;<br>  <span class="hljs-built_in">string</span> bucket = <span class="hljs-number">5</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">ReplyGetKey</span> </span>&#123;<br>  <span class="hljs-built_in">string</span> getKeyMessage = <span class="hljs-number">3</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">RequestSetKey</span> </span>&#123;<br>  <span class="hljs-built_in">string</span> addr = <span class="hljs-number">1</span>;<br>  <span class="hljs-built_in">string</span> port = <span class="hljs-number">2</span>;<br>  <span class="hljs-built_in">string</span> key = <span class="hljs-number">3</span>;<br>  <span class="hljs-built_in">string</span> value = <span class="hljs-number">4</span>;<br>  <span class="hljs-built_in">string</span> bucket = <span class="hljs-number">5</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">ReplySetKey</span> </span>&#123;<br>  <span class="hljs-built_in">string</span> setKeyMessage = <span class="hljs-number">3</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>使用命令编译协议配置文件，生成<code>*.pb.go</code>文件和<code>*_grpc.pb.go</code>文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">protoc -I. --go_out=. --go-grpc_out=. *.proto<br><span class="hljs-meta">#</span><span class="bash"> -I, 相当于 -IPATH 和 --proto_path, 指定 proto 文件依赖的包所要搜索的路径 (这里没有依赖, 可以不写)</span><br><span class="hljs-meta">#</span><span class="bash"> --go_out 参数是指定生成 *.pb.go 文件的路径</span><br><span class="hljs-meta">#</span><span class="bash"> --go-grpc_out 参数是指定生成 *_grpc.pb.go 文件的路径</span><br></code></pre></td></tr></table></figure><p>结构如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">├── README.md<br>├── cache<br>│   └── cache.go<br>├── client<br>│   └── client.go<br>├── go.mod<br>├── go.sum<br>├── kstor_proto<br>│   ├── kstor.pb.go<br>│   ├── kstor.proto<br>│   └── kstor_grpc.pb.go<br>├── main.go<br>└── server<br>    └── server.go<br></code></pre></td></tr></table></figure><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p><code>server/server.go</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs shell">package server<br><br>import (<br>&quot;context&quot;<br>&quot;fmt&quot;<br>&quot;google.golang.org/grpc&quot;<br>&quot;kstor/cache&quot;<br>&quot;kstor/database&quot;<br>&quot;kstor/global&quot;<br>proto &quot;kstor/kstor_proto&quot;<br>&quot;log&quot;<br>&quot;net&quot;<br>)<br><br>type server struct &#123;<br>proto.UnimplementedGreeterServer<br>&#125;<br><br>// SayGetKey 查询key<br>func (s *server) SayGetKey(ctx context.Context, in *proto.RequestGetKey) (*proto.ReplyGetKey, error) &#123;<br>reply := &amp;proto.ReplyGetKey&#123;<br>GetKeyMessage: &quot;&quot;,<br>&#125;<br>key, bucket := in.GetKey(), in.GetBucket()<br>log.Printf(&quot;Received operate get key -&gt; %v&quot;, in)<br>cacheValue, isCache := cache.Cache.GetCache(key, bucket, &quot;normal&quot;)<br>if isCache &#123;<br>reply.GetKeyMessage = fmt.Sprintf(&quot;Get key【%s】information from bucket【%s】for gRPC\n-&gt; %v&quot;, key, bucket, cacheValue)<br>return reply, nil<br>&#125;<br>db := database.GetBoltDB()<br>defer db.Close()<br>bk, err := database.GetKeyByBucket(key, bucket, db)<br>if err != nil &#123;<br>reply.GetKeyMessage = fmt.Sprintf(&quot;Get key【%s】information from bucket【%s】failed! %s&quot;, key, bucket, err.Error())<br>return reply, nil<br>&#125;<br>if bk.Value == &quot;&quot; &#123;<br>reply.GetKeyMessage = fmt.Sprintf(&quot;Not found key【%s】information from bucket【%s】!&quot;, key, bucket)<br>return reply, nil<br>&#125;<br>// 设置缓存<br>cache.Cache.SetCache(key, bk.Value, bucket, &quot;normal&quot;)<br>reply.GetKeyMessage = fmt.Sprintf(&quot;Get key【%s】information from bucket【%s】for gRPC\n-&gt; %v&quot;, key, bucket, bk)<br>return reply, nil<br>&#125;<br><br>// SaySetKey 设置key<br>func (s *server) SaySetKey(ctx context.Context, in *proto.RequestSetKey) (*proto.ReplySetKey, error) &#123;<br>reply := &amp;proto.ReplySetKey&#123;<br>SetKeyMessage: &quot;&quot;,<br>&#125;<br>log.Printf(&quot;Received operate set key -&gt; %v&quot;, in)<br>db := database.GetBoltDB()<br>defer db.Close()<br>err := database.SetKeyByBucket(in.GetKey(), in.GetValue(), in.GetBucket(), db)<br>if err != nil &#123;<br>reply.SetKeyMessage = fmt.Sprintf(&quot;set key【%s】failed! %s&quot;, in.GetKey(), err.Error())<br>return reply, nil<br>&#125;<br>// 使存量key缓存失效<br>cache.Cache.DeleteCache(in.GetKey(), in.GetBucket())<br>reply.SetKeyMessage = fmt.Sprintf(&quot;Key【%s】from bucket【%s】set successfully for gRPC&quot;, in.GetKey(), in.GetBucket())<br>return reply, nil<br>&#125;<br><br>// Run 启动grpc服务端<br>func Run() &#123;<br>lis, err := net.Listen(&quot;tcp&quot;, &quot;:&quot; + global.GRPCPort)<br>if err != nil &#123;<br>log.Fatalf(&quot;failed to listen: %v&quot;, err)<br>&#125;<br><br>srv := grpc.NewServer()<br>// 注册服务<br>proto.RegisterGreeterServer(srv, &amp;server&#123;&#125;)<br><br>log.Printf(&quot;gRPC server is running, try to connect to %s:%s...&quot;, global.GRPCAddr, global.GRPCPort)<br>// 起服务<br>if err := srv.Serve(lis); err != nil &#123;<br>log.Fatalf(&quot;failed to serve: %v&quot;, err)<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p><code>clien/clien.go</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs shell"><br>package client<br><br>import (<br>&quot;context&quot;<br>&quot;google.golang.org/grpc/credentials/insecure&quot;<br>&quot;kstor/global&quot;<br>&quot;log&quot;<br>&quot;time&quot;<br><br>&quot;google.golang.org/grpc&quot;<br>proto &quot;kstor/kstor_proto&quot;<br>)<br><br>// Run 启动客户端<br>func Run(opt, addr, port string) &#123;<br>// Set up a connection to the server.<br>serverHost := addr + &quot;:&quot; + port<br>conn, err := grpc.Dial(serverHost, grpc.WithTransportCredentials(insecure.NewCredentials()), grpc.WithBlock())<br>if err != nil &#123;<br>log.Fatalf(&quot;did not connect: %v&quot;, err)<br>&#125;<br>defer conn.Close()<br><br>c := proto.NewGreeterClient(conn)<br>ctx, cancel := context.WithTimeout(context.Background(), time.Second)<br>defer cancel()<br>// Contact the server and print out its response.<br>switch opt &#123;<br>case global.GetKey:<br>ReqGetKey(c, ctx)<br>case global.SetKey:<br>ReqSetKey(c, ctx)<br>default:<br>log.Fatal(&quot;params error&quot;)<br>&#125;<br>&#125;<br><br>// ReqGetKey 查询key请求<br>func ReqGetKey(c proto.GreeterClient, ctx context.Context) &#123;<br>r, err := c.SayGetKey(ctx,<br>&amp;proto.RequestGetKey&#123;Key: global.Key, PrefixKey: global.PrefixKey, Bucket: global.Bucket&#125;)<br>if err != nil &#123;<br>log.Fatalf(&quot;could not greet: %v&quot;, err)<br>&#125;<br>log.Printf(&quot;Reply: %s&quot;, r.GetGetKeyMessage())<br>&#125;<br><br>// ReqSetKey 设置key请求<br>func ReqSetKey(c proto.GreeterClient, ctx context.Context) &#123;<br>r, err := c.SaySetKey(ctx,<br>&amp;proto.RequestSetKey&#123;Key: global.Key, Value: global.Value, Bucket: global.Bucket&#125;)<br>if err != nil &#123;<br>log.Fatalf(&quot;could not greet: %v&quot;, err)<br>&#125;<br>log.Printf(&quot;Reply: %s&quot;, r.GetSetKeyMessage())<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><p><a href="https://github.com/grpc/grpc-go">GitHub - grpc/grpc-go: The Go language implementation of gRPC. HTTP/2 based RPC</a></p></li><li><p><a href="https://www.grpc.io/docs/languages/go/quickstart/">Quick start | Go | gRPC</a></p></li><li><p><a href="https://www.jianshu.com/p/0d776e653906">Go gRPC 入门与实践 - 简书</a></p></li><li><p><a href="https://segmentfault.com/a/1190000019216566">grpc - 使用 golang 带你从头撸一套 RPC 服务</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>gRPC</category>
      
      <category>RPC</category>
      
    </categories>
    
    
    <tags>
      
      <tag>grpc</tag>
      
      <tag>grpc-go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang命令行利器之cobra</title>
    <link href="/Myblog/2022/04/20/Golang%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%88%A9%E5%99%A8%E4%B9%8Bcobra/"/>
    <url>/Myblog/2022/04/20/Golang%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%88%A9%E5%99%A8%E4%B9%8Bcobra/</url>
    
    <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Cobra 是 Go 的 CLI 框架。它包含一个用于创建功能强大的现代 CLI 应用程序的库，以及一个用于快速生成基于 Cobra 的应用程序和命令文件的工具。</p><h3 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h3><ul><li>安装cobra</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go get -u github.com/spf13/cobra<br></code></pre></td></tr></table></figure><ul><li>安装cobra-cli</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go install github.com/spf13/cobra-cli@latest<br></code></pre></td></tr></table></figure><blockquote><ul><li><p>需要将<code>$GOPATH/bin</code>添加到PATH中</p></li><li><p>然后可以使用<code>cobra-cli init</code> 初始化<code>cmd</code>应用</p></li><li><p>使用<code>cobra add &lt;cmd name&gt;</code> 创建指定命令行源文件</p></li></ul></blockquote><p>此时你的目录结构应该是这样的：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">├── cmd<br>│   ├── backup.go<br>│   ├── bucket.go<br>│   ├── key.go<br>│   ├── root.go<br>│   └── server.go<br>└── main.go<br></code></pre></td></tr></table></figure><p>其中<code>root.go</code>为根命令，添加了<code>backup</code> /  <code>bucket</code> / <code>key</code> / <code>server</code> 等子命令，可以在各文件中定义命令相关接收参数和通用配置。</p><ul><li>相关代码</li></ul><p><code>main.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Copyright © 2022 NAME HERE &lt;EMAIL ADDRESS&gt;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;kstor/cmd&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>cmd.Execute()<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>cmd/root.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Copyright © 2022 NAME HERE &lt;EMAIL ADDRESS&gt;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">package</span> cmd<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><br><span class="hljs-string">&quot;github.com/spf13/cobra&quot;</span><br>)<br><br><span class="hljs-comment">// rootCmd represents the base command when called without any subcommands</span><br><span class="hljs-keyword">var</span> rootCmd = &amp;cobra.Command&#123;<br>Use:   <span class="hljs-string">&quot;kstor&quot;</span>,<br>Short: <span class="hljs-string">&quot;A simple key-value store project&quot;</span>,<br>Long:  <span class="hljs-string">`A simple key-value store project`</span>,<br><span class="hljs-comment">// Uncomment the following line if your bare application</span><br><span class="hljs-comment">// has an action associated with it:</span><br>Run: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cmd *cobra.Command, args []<span class="hljs-keyword">string</span>)</span></span> &#123;<br>log.Println(<span class="hljs-string">&quot;Hello Cobra CLI&quot;</span>)<br>&#125;,<br>&#125;<br><br><span class="hljs-comment">// Execute adds all child commands to the root command and sets flags appropriately.</span><br><span class="hljs-comment">// This is called by main.main(). It only needs to happen once to the rootCmd.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Execute</span><span class="hljs-params">()</span></span> &#123;<br>err := rootCmd.Execute()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// Here you will define your flags and configuration settings.</span><br><span class="hljs-comment">// Cobra supports persistent flags, which, if defined here,</span><br><span class="hljs-comment">// will be global for your application.</span><br><br><span class="hljs-comment">// rootCmd.PersistentFlags().StringVar(&amp;cfgFile, &quot;global&quot;, &quot;&quot;, &quot;global file (default is $HOME/.kstor.yaml)&quot;)</span><br><br><span class="hljs-comment">// Cobra also supports local flags, which will only run</span><br><span class="hljs-comment">// when this action is called directly.</span><br><span class="hljs-comment">//rootCmd.Flags().BoolP(&quot;toggle&quot;, &quot;t&quot;, false, &quot;Help message for toggle&quot;)</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>cmd/server.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Copyright © 2022 NAME HERE &lt;EMAIL ADDRESS&gt;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">package</span> cmd<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;github.com/spf13/cobra&quot;</span><br><span class="hljs-string">&quot;github.com/spf13/viper&quot;</span><br><br><span class="hljs-string">&quot;kstor/server&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> GRPCPort <span class="hljs-keyword">string</span><br><br><span class="hljs-comment">// serverCmd represents the server command</span><br><span class="hljs-keyword">var</span> serverCmd = &amp;cobra.Command&#123;<br>Use:   <span class="hljs-string">&quot;server&quot;</span>,<br>Short: <span class="hljs-string">&quot;start the service&quot;</span>,<br>Long:  <span class="hljs-string">&quot;start the service&quot;</span>,<br>Run: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cmd *cobra.Command, args []<span class="hljs-keyword">string</span>)</span></span> &#123;<br><span class="hljs-comment">// 启动gRPC服务端</span><br>server.Run()<br>&#125;,<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>rootCmd.AddCommand(serverCmd)<br><span class="hljs-comment">// port</span><br>serverCmd.Flags().StringVarP(&amp;GRPCPort, <span class="hljs-string">&quot;port&quot;</span>, <span class="hljs-string">&quot;p&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;service port&quot;</span>)<br>viper.BindPFlag(<span class="hljs-string">&quot;port&quot;</span>, serverCmd.PersistentFlags().Lookup(<span class="hljs-string">&quot;port&quot;</span>))<br>serverCmd.MarkFlagRequired(<span class="hljs-string">&quot;port&quot;</span>)<br><br><span class="hljs-comment">// Here you will define your flags and configuration settings.</span><br><br><span class="hljs-comment">// Cobra supports Persistent Flags which will work for this command</span><br><span class="hljs-comment">// and all subcommands, e.g.:</span><br><span class="hljs-comment">//serverCmd.PersistentFlags().String(&quot;port&quot;, &quot;port&quot;, &quot;service port&quot;)</span><br><br><span class="hljs-comment">// Cobra supports local flags which will only run when this command</span><br><span class="hljs-comment">// is called directly, e.g.:</span><br><span class="hljs-comment">//serverCmd.Flags().BoolP(&quot;toggle&quot;, &quot;t&quot;, false, &quot;Help message for toggle&quot;)</span><br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><ul><li><p><code>cobra.Command.Run</code>- 调用命令执行方法入口</p></li><li><p><code>rootCmd.AddCommand(serverCmd)</code> - 添加server子命令</p></li><li><p><code>serverCmd.Flags().StringVarP()</code> - 绑定子命令参数</p></li><li><p><code>viper.BindPFlag(&quot;port&quot;, serverCmd.PersistentFlags().Lookup(&quot;port&quot;))</code> -  绑定port参数</p></li><li><p><code>serverCmd.MarkFlagRequired(&quot;port&quot;)</code> - 设置参数必填</p></li></ul></blockquote><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><p><a href="https://github.com/spf13/cobra">github cobra</a></p></li><li><p><a href="https://juejin.cn/post/6924541628031959047">Cobra 中文文档 - 掘金</a></p></li><li><p><a href="https://www.jianshu.com/p/99aae91587af">Go语言命令行利器cobra使用教程 - 简书</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>CLI框架</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cli</tag>
      
      <tag>cobra</tag>
      
      <tag>命令行</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言select常见用法</title>
    <link href="/Myblog/2022/03/17/Go%E8%AF%AD%E8%A8%80select%E5%B8%B8%E8%A7%81%E7%94%A8%E6%B3%95/"/>
    <url>/Myblog/2022/03/17/Go%E8%AF%AD%E8%A8%80select%E5%B8%B8%E8%A7%81%E7%94%A8%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h3 id="特性速览"><a href="#特性速览" class="headerlink" title="特性速览"></a>特性速览</h3><p><code>select</code>是Go在语言层面提供的多路复用<code>I/O</code>机制，用于检测多个管道是否就绪(可读或者可写)，并且只能作用于管道。</p><ul><li><p>如果存在多个<code>case</code>就绪，系统会随机执行其中之一</p></li><li><p>如果所有<code>case</code>都不满足，但若存在<code>default</code>语句，则会执行对应逻辑 (<code>default</code>实际上是一种特殊的<code>case</code>，它能够出现在select的任意位置，但每次<code>select</code>中只能出现一次)</p></li><li><p>如果所有<code>case</code>都不满足，并且没有<code>default</code>语句，则会进入阻塞状态，直到某个<code>case</code>满足条件</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">convert</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>    <span class="hljs-keyword">switch</span> t := i.(<span class="hljs-keyword">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-keyword">int</span>:<br>        <span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;i is interger&quot;</span>, t)<br>    <span class="hljs-keyword">case</span> <span class="hljs-keyword">string</span>:<br>        <span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;i is string&quot;</span>, t)<br>    <span class="hljs-keyword">case</span> <span class="hljs-keyword">float64</span>:<br>        <span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;i is float64&quot;</span>, t)<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;type not found&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="select常见用法"><a href="#select常见用法" class="headerlink" title="select常见用法"></a>select常见用法</h3><h4 id="永久阻塞"><a href="#永久阻塞" class="headerlink" title="永久阻塞"></a>永久阻塞</h4><p>当某些时候，我们需要启动携程处理任务，但是不希望<code>main</code>函数退出，就可以采用下面这种方式永久性阻塞，保证携程任务正常工作。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;time clock...&quot;</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>PrintTest()<br>&#125;()<br><span class="hljs-keyword">select</span> &#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PrintTest</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br>time.Sleep(time.Second * <span class="hljs-number">1</span>)<br>fmt.Println(time.Now().Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>))<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>select &#123;&#125;</code> 中不包含任何<code>case</code>语句和 <code>default</code>语句，则会陷入永久性阻塞。</p></blockquote><h4 id="超时机制"><a href="#超时机制" class="headerlink" title="超时机制"></a>超时机制</h4><p>处理任务时，设置一个任务处理时间的<code>deadline</code>，如果超时未成功处理，则主动结束退出任务。</p><ul><li>方式一</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    timeout := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>, <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        time.Sleep(<span class="hljs-number">2</span> * time.Second)<br>        timeout &lt;- <span class="hljs-literal">true</span><br>    &#125;()<br>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)<br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-ch:<br>    <span class="hljs-keyword">case</span> &lt;-timeout:<br>        fmt.Println(<span class="hljs-string">&quot;timeout 01&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>方式二</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>job := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>job &lt;- <span class="hljs-string">&quot;done&quot;</span><br>&#125;()<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;- job:<br>fmt.Println(<span class="hljs-string">&quot;job done!&quot;</span>)<br><span class="hljs-keyword">case</span> &lt;- time.After(time.Second * <span class="hljs-number">2</span>):<br>fmt.Println(<span class="hljs-string">&quot;timeout...&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="快速检错"><a href="#快速检错" class="headerlink" title="快速检错"></a>快速检错</h4><p>有时候需要用管道来传递错误，这时候可以使用<code>select</code>语句来检查管道中是否存在错误，避免陷入循环</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>errCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> error)<br>job(errCh)<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> jobErr := &lt;- errCh:<br><span class="hljs-keyword">if</span> jobErr != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">default</span>:<br>fmt.Println(<span class="hljs-string">&quot;no error&quot;</span>)<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>select</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>gitee-pages一键自动部署博客.md</title>
    <link href="/Myblog/2022/03/10/gitee-pages%E4%B8%80%E9%94%AE%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%8D%9A%E5%AE%A2/"/>
    <url>/Myblog/2022/03/10/gitee-pages%E4%B8%80%E9%94%AE%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>由于 Gitee Pages 的访问速度很快，很多朋友会选择 Gitee Pages 部署项目（如：个人博客、开源项目国内镜像站点）。但是它不像 GitHub Pages 那样，一提交代码就能自动更新 Pages，因为 Gitee 的自动部署属于 Gitee Pages Pro 的服务。</p><p>为了实现 Gitee Pages 的自动部署，找到了大佬开发的工具 <a href="https://github.com/marketplace/actions/gitee-pages-action">Gitee Pages Action</a> ，只需要在 GitHub 项目的 Settings 页面下配置 keys，然后在 <code>.github/workflows/</code> 下创建一个工作流，通过工作流自动将代码从Github拷贝到Gitee，再模拟自动点击构建部署博客。</p><h3 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h3><h4 id="创建workflow"><a href="#创建workflow" class="headerlink" title="创建workflow"></a>创建workflow</h4><p>首先我们需要知道hexo的目录结构：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">./<br>├── README.md<br>├── .deploy_git<br>├── _config.yml<br>├── db.json<br>├── node_modules<br>├── package-lock.json<br>├── package.json<br>├── public<br>├── scaffolds<br>├── source<br>└── themes<br></code></pre></td></tr></table></figure><p><code>_config.yml</code>描述了你的hexo仓库的一些基本信息，其中包括了你通过<code>hexo deploy</code> 部署指向的远端仓库地址。而需要推送的内容，是存放在<code>.deploy_git</code>文件夹中的，也就是我们通过命令<code>hexo generate</code>生成的博客html原始文件。</p><p>所以这里我们要添加的<code>workflow</code>工作流，位于<code>.deploy_git/.github/workflows/xxx.yml</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> .github/workflows/sync.yml</span><br><br>name: Sync<br><br>on:<br>  push:<br>    branches: [main]<br>  workflow_dispatch:<br><br>jobs:<br>  build:<br>    runs-on: ubuntu-latest<br>    steps:<br>      - name: Sync to Gitee<br>        uses: wearerequired/git-mirror-action@master<br>        env:<br>          # 注意在 Settings-&gt;Secrets 配置 GITEE_RSA_PRIVATE_KEY<br>          SSH_PRIVATE_KEY: $&#123;&#123; secrets.GITEE_RSA_PRIVATE_KEY &#125;&#125;<br>        with:<br>          # 注意替换为你的 GitHub 源仓库地址<br>          source-repo: git@github.com:doocs/leetcode.git<br>          # 注意替换为你的 Gitee 目标仓库地址<br>          destination-repo: git@gitee.com:Doocs/leetcode.git<br><br>      - name: Build Gitee Pages<br>        uses: yanglbme/gitee-pages-action@main<br>        with:<br>          # 注意替换为你的 Gitee 用户名<br>          gitee-username: yanglbme<br>          # 注意在 Settings-&gt;Secrets 配置 GITEE_PASSWORD<br>          gitee-password: $&#123;&#123; secrets.GITEE_PASSWORD &#125;&#125;<br>          # 注意替换为你的 Gitee 仓库，仓库名严格区分大小写，请准确填写，否则会出错<br>          gitee-repo: doocs/leetcode<br>          # 要部署的分支，默认是 master，若是其他分支，则需要指定（指定的分支必须存在）<br>          branch: main<br></code></pre></td></tr></table></figure><h4 id="配置密钥"><a href="#配置密钥" class="headerlink" title="配置密钥"></a>配置密钥</h4><p><strong>这里建议生成两对SSH Key，分别用于Github和Gitee。当然也可以用同一对，只要保证配置在 <code>Github -&gt; repo -&gt; setting -&gt; secrets中Gitee的私钥</code> 能够与 <code>Gitee -&gt; 设置中的SSH公钥</code> 对应上就好了</strong></p><ol><li><p>在命令行终端或 Git Bash 使用命令 <code>ssh-keygen -t rsa -C &quot;youremail@example.com&quot;</code> 生成 SSH Key，注意替换为自己的邮箱。生成的 <code>id_rsa</code> 是私钥，<code>id_rsa.pub</code> 是公钥。(⚠️注意此处不要设置密码，生成的公私钥用于下面 GitHub / Gitee 的配置，以保证公私钥成对，否则从 GitHub -&gt; Gitee 的同步将会失败。)</p></li><li><p>在 GitHub 项目的「Settings -&gt; Secrets」路径下配置好命名为 <code>GITEE_RSA_PRIVATE_KEY</code> 和 <code>GITEE_PASSWORD</code> 的两个密钥。其中：<code>GITEE_RSA_PRIVATE_KEY</code> 存放 <code>id_rsa</code> 私钥；<code>GITEE_PASSWORD</code> 存放 Gitee 帐号的密码。</p></li><li><p>在 GitHub 的个人设置页面「<a href="https://github.com/settings/keys">Settings -&gt; SSH and GPG keys</a>」配置 SSH 公钥（即：<code>id_rsa.pub</code>），命名随意。</p></li><li><p>在 Gitee 的个人设置页面「<a href="https://gitee.com/profile/sshkeys">安全设置 -&gt; SSH 公钥</a>」配置 SSH 公钥（即：<code>id_rsa.pub</code>），命名随意。</p></li></ol><h4 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h4><p>如果一切配置正常，并成功触发 <a href="https://github.com/marketplace/actions/gitee-pages-action">Gitee Pages Action</a> ，Gitee Pages Action 会打印出成功的结果。并且，我们会在 Gitee 公众号收到一条登录通知。这是 Gitee Pages Action 程序帮我们登录到 Gitee 官网，并为我们点击了项目的部署按钮。</p><h4 id="错误及解决方案"><a href="#错误及解决方案" class="headerlink" title="错误及解决方案"></a>错误及解决方案</h4><p>首次需要<strong>手动</strong>登录 Gitee ，点击“启动”进行 Gitee Pages 服务的部署。</p><p>更多错误情况见 <a href="https://github.com/marketplace/actions/gitee-pages-action#%E9%94%99%E8%AF%AF%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">错误及解决方案</a></p><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>如果希望完成后添加消息推送通知，可以参看文章 <a href="https://github.com/easychen/github-action-server-chan">github-action-server-chan</a></p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><p><a href="https://lxd0619.github.io/frontend/hexo%E5%90%8C%E6%97%B6%E9%83%A8%E7%BD%B2GitHub%E5%92%8CGitee.html">hexo自动同步部署GitHub和Gitee pages</a></p></li><li><p><a href="https://github.com/marketplace/actions/gitee-pages-action">Gitee Pages Action · Actions · GitHub Marketplace · GitHub</a></p></li><li><p><a href="https://github.com/wearerequired/git-mirror-action">GitHub - wearerequired/git-mirror-action</a></p></li><li><p><a href="https://github.com/yanglbme/gitee-pages-action">GitHub - yanglbme/gitee-pages-action</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang自动化之robotgo</title>
    <link href="/Myblog/2022/01/22/Golang%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Brobotgo/"/>
    <url>/Myblog/2022/01/22/Golang%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Brobotgo/</url>
    
    <content type="html"><![CDATA[<h3 id="什么是robotgo"><a href="#什么是robotgo" class="headerlink" title="什么是robotgo"></a>什么是robotgo</h3><p>Golang 跨平台自动化系统，用于控制键盘、鼠标、位图、图像、读取屏幕，进程、窗口句柄以及全局事件监听。RobotGo 支持 Mac, Windows, and Linux(X11)系统</p><h3 id="安装robotgo"><a href="#安装robotgo" class="headerlink" title="安装robotgo"></a>安装robotgo</h3><p>建议安装go1.17版本，亲测有效。</p><ul><li>mac环境</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Xcode Command Line Tools</span><br>xcode-<span class="hljs-keyword">select</span> --install<br><span class="hljs-comment">// golang version</span><br><span class="hljs-keyword">go</span> version go1<span class="hljs-number">.17</span><span class="hljs-number">.6</span> darwin/arm64 <br><span class="hljs-comment">// robotgo version</span><br>github.com/<span class="hljs-keyword">go</span>-vgo/robotgo v0<span class="hljs-number">.100</span><span class="hljs-number">.10</span><br></code></pre></td></tr></table></figure><ul><li>windows环境</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 需要安装mingw-w64，下载后把对应bin目录添加到path中，执行 gcc -v 刷新</span><br>https:<span class="hljs-comment">//sourceforge.net/projects/mingw-w64/</span><br><span class="hljs-comment">// golang version</span><br><span class="hljs-keyword">go</span> version go1<span class="hljs-number">.17</span><span class="hljs-number">.6</span> darwin/arm64 <br><span class="hljs-comment">// robotgo version</span><br>github.com/<span class="hljs-keyword">go</span>-vgo/robotgo v0<span class="hljs-number">.100</span><span class="hljs-number">.10</span><br></code></pre></td></tr></table></figure><h3 id="模拟事件"><a href="#模拟事件" class="headerlink" title="模拟事件"></a>模拟事件</h3><ul><li>模拟键盘输入</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 按击空格键，空格-space / 回车-enter</span><br>robotgo.KeyTap(<span class="hljs-string">&quot;space&quot;</span>)  <br><span class="hljs-comment">// 同时按住command + e 键</span><br>robotgo.KeyTap(<span class="hljs-string">&quot;e&quot;</span>, <span class="hljs-string">&quot;command&quot;</span>)<br><span class="hljs-comment">// 一直按住键，不放开</span><br>robotgo.KeyToggle(<span class="hljs-string">`a`</span>, <span class="hljs-string">`down`</span>)<br><span class="hljs-comment">// 解除按住，弹起键</span><br>robotgo.KeyToggle(<span class="hljs-string">`a`</span>, <span class="hljs-string">`up`</span>)<br><span class="hljs-comment">// 输入字符(同时)，接收第二个参数，输入每个字符设置时间间隔</span><br>robotgo.TypeStr(<span class="hljs-string">&quot;hello world&quot;</span>)<br>robotgo.TypeStr(<span class="hljs-string">&quot;hello world&quot;</span>, <span class="hljs-number">1000</span>)<br></code></pre></td></tr></table></figure><ul><li>模拟鼠标操作</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 获取鼠标所在坐标</span><br>x, y := robotgo.GetMousePos()<br><span class="hljs-comment">// 将鼠标移动到屏幕 x:800 y:400 的位置（闪现到指定位置）</span><br>robotgo.Move(<span class="hljs-number">800</span>, <span class="hljs-number">400</span>)<br><span class="hljs-comment">// 将鼠标移动到屏幕 x:800 y:400 的位置（模仿人类操作, 缓慢移动到指定位置）</span><br>robotgo.MoveSmooth(<span class="hljs-number">800</span>, <span class="hljs-number">400</span>)<br><span class="hljs-comment">// 第3，4个参数分别代表：纵坐标x和横坐标的延迟到达时间，</span><br>robotgo.MoveSmooth(<span class="hljs-number">800</span>, <span class="hljs-number">400</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>)<br><span class="hljs-comment">// 鼠标点击：button -&gt; &quot;left&quot; / &quot;right&quot; / &quot;wheelLeft&quot;， double 是否双击</span><br>robotgo.Click(button <span class="hljs-keyword">string</span>, double <span class="hljs-keyword">bool</span>)<br><span class="hljs-comment">// 移动到指定位置后进行鼠标点击</span><br>robotgo.MoveClick(<span class="hljs-number">800</span>, <span class="hljs-number">400</span>, <span class="hljs-string">`left`</span>, <span class="hljs-literal">true</span>)<br><span class="hljs-comment">// 按住鼠标拖动到指定位置</span><br>robotgo.DragSmooth(<span class="hljs-number">600</span>, <span class="hljs-number">400</span>) <br><span class="hljs-comment">// 滑动鼠标滚轮 第二个参数&quot;up&quot;/&quot;down&quot;</span><br>robotgo.ScrollMouse(<span class="hljs-number">100</span>, <span class="hljs-string">&quot;down&quot;</span>)<br></code></pre></td></tr></table></figure><ul><li>窗口操作</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 获得当前window</span><br>m := robotgo.GetActive()<br><span class="hljs-comment">// 激活window</span><br>robotgo.SetActive(m)<br><span class="hljs-comment">// 关闭当前window</span><br>robotgo.CloseWindow()<br></code></pre></td></tr></table></figure><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><ul><li>自动打开浏览器进行关键字搜索</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    exec.Command(<span class="hljs-string">&quot;open&quot;</span>, <span class="hljs-string">&quot;-a&quot;</span>, <span class="hljs-string">&quot;/Applications/Google Chrome.app&quot;</span>, <span class="hljs-string">&quot;http://www.baidu.com&quot;</span>).Run()<br>    <span class="hljs-comment">//等待</span><br>    robotgo.MilliSleep(<span class="hljs-number">5</span> * <span class="hljs-number">1000</span>)<br>    <span class="hljs-comment">// get current Window Active</span><br>    mdata := robotgo.GetActive()<br>    <span class="hljs-comment">// set Window Active</span><br>    robotgo.SetActive(mdata)<br>    robotgo.TypeStr(<span class="hljs-string">&quot;why golang&quot;</span>, <span class="hljs-number">100</span>)<br>    robotgo.KeyTap(<span class="hljs-string">&quot;enter&quot;</span>)<br>    robotgo.MilliSleep(<span class="hljs-number">5</span> * <span class="hljs-number">1000</span>)<br>    <span class="hljs-comment">// close current Window</span><br>    robotgo.CloseWindow()<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>如果是windows环境可以选择打开ie浏览器，替换第一句代码即可</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">exec.Command(<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>, <span class="hljs-string">&quot;iexplore.exe&quot;</span>, <span class="hljs-string">&quot;www.zhihu.com&quot;</span>).Run()<br></code></pre></td></tr></table></figure></blockquote><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="https://github.com/go-vgo/Mingw">robotgo</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>自动化</tag>
      
      <tag>robotgo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang操作Excel文件</title>
    <link href="/Myblog/2022/01/20/Golang%E6%93%8D%E4%BD%9CExcel%E6%96%87%E4%BB%B6/"/>
    <url>/Myblog/2022/01/20/Golang%E6%93%8D%E4%BD%9CExcel%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><code>Excelize</code> 是 <code>Go</code> 语言编写的用于操作 <code>Office Excel</code> 文档基础库，基于 <code>ECMA-376，ISO/IEC 29500</code> 国际标准。可以使用它来读取、写入由 <code>Microsoft Excel™ 2007</code> 及以上版本创建的电子表格文档。支持 <code>XLSX / XLSM / XLTM / XLTX</code> 等多种文档格式，高度兼容带有样式、图片(表)、透视表、切片器等复杂组件的文档，并提供流式读写 <code>API</code>，用于处理包含大规模数据的工作簿。可应用于各类报表平台、云计算、边缘计算等系统。使用本类库要求使用的 <code>Go 语言为 1.15 或更高版本</code>。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go get github.com/xuri/excelize<br></code></pre></td></tr></table></figure><p>如果你使用的是<code>go mod</code>，那么使用下面的命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go get github.com/xuri/excelize/v2<br></code></pre></td></tr></table></figure><h3 id="操作excel"><a href="#操作excel" class="headerlink" title="操作excel"></a>操作excel</h3><p>本文仅介绍<code>excelize</code>基础用法， 其他高级用法例如插入图片、公式计算、设置单元格样式等，这里不一一展开，详情可以见官网文档 <a href="https://github.com/qax-os/excelize">excelize</a></p><h4 id="读取excel文件"><a href="#读取excel文件" class="headerlink" title="读取excel文件"></a>读取excel文件</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs golang">mport (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;github.com/xuri/excelize/v2&quot;</span><br><span class="hljs-string">&quot;strconv&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReadExcel</span><span class="hljs-params">(excelPath <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">([][]<span class="hljs-keyword">string</span>, error)</span></span> &#123;<br>excel, err := excelize.OpenFile(excelPath)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>sheetName := excel.GetSheetName(<span class="hljs-number">0</span>)<br>data, err := excel.GetRows(sheetName)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">for</span> _, i := <span class="hljs-keyword">range</span> data &#123;<br>fmt.Println(i)<br>&#125;<br><span class="hljs-keyword">return</span> data, <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="生成excel文件"><a href="#生成excel文件" class="headerlink" title="生成excel文件"></a>生成excel文件</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;github.com/xuri/excelize/v2&quot;</span><br><span class="hljs-string">&quot;strconv&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> LetterMap <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]<span class="hljs-keyword">string</span> = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]<span class="hljs-keyword">string</span>&#123;<br><span class="hljs-number">0</span>:  <span class="hljs-string">&quot;A&quot;</span>,<br><span class="hljs-number">1</span>:  <span class="hljs-string">&quot;B&quot;</span>,<br><span class="hljs-number">2</span>:  <span class="hljs-string">&quot;C&quot;</span>,<br><span class="hljs-number">3</span>:  <span class="hljs-string">&quot;D&quot;</span>,<br><span class="hljs-number">4</span>:  <span class="hljs-string">&quot;E&quot;</span>,<br><span class="hljs-number">5</span>:  <span class="hljs-string">&quot;F&quot;</span>,<br><span class="hljs-number">6</span>:  <span class="hljs-string">&quot;G&quot;</span>,<br><span class="hljs-number">7</span>:  <span class="hljs-string">&quot;H&quot;</span>,<br><span class="hljs-number">8</span>:  <span class="hljs-string">&quot;I&quot;</span>,<br><span class="hljs-number">9</span>:  <span class="hljs-string">&quot;J&quot;</span>,<br><span class="hljs-number">10</span>: <span class="hljs-string">&quot;K&quot;</span>,<br><span class="hljs-number">11</span>: <span class="hljs-string">&quot;L&quot;</span>,<br><span class="hljs-number">12</span>: <span class="hljs-string">&quot;M&quot;</span>,<br><span class="hljs-number">13</span>: <span class="hljs-string">&quot;N&quot;</span>,<br><span class="hljs-number">14</span>: <span class="hljs-string">&quot;O&quot;</span>,<br><span class="hljs-number">15</span>: <span class="hljs-string">&quot;P&quot;</span>,<br><span class="hljs-number">16</span>: <span class="hljs-string">&quot;Q&quot;</span>,<br><span class="hljs-number">17</span>: <span class="hljs-string">&quot;R&quot;</span>,<br><span class="hljs-number">18</span>: <span class="hljs-string">&quot;S&quot;</span>,<br><span class="hljs-number">19</span>: <span class="hljs-string">&quot;T&quot;</span>,<br><span class="hljs-number">20</span>: <span class="hljs-string">&quot;U&quot;</span>,<br><span class="hljs-number">21</span>: <span class="hljs-string">&quot;V&quot;</span>,<br><span class="hljs-number">22</span>: <span class="hljs-string">&quot;W&quot;</span>,<br><span class="hljs-number">23</span>: <span class="hljs-string">&quot;X&quot;</span>,<br><span class="hljs-number">24</span>: <span class="hljs-string">&quot;Y&quot;</span>,<br><span class="hljs-number">25</span>: <span class="hljs-string">&quot;Z&quot;</span>,<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WriteExcel</span><span class="hljs-params">(excelPath <span class="hljs-keyword">string</span>, data [][]<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>excel := excelize.NewFile()<br>sheetName := <span class="hljs-string">&quot;Sheet1&quot;</span><br><span class="hljs-comment">//sheetIdx := excel.NewSheet(sheetName)</span><br><span class="hljs-keyword">for</span> idx1, row := <span class="hljs-keyword">range</span> data &#123;<br><span class="hljs-keyword">for</span> idx2, val := <span class="hljs-keyword">range</span> row &#123;<br><span class="hljs-keyword">if</span> err := excel.SetCellValue(sheetName, LetterMap[idx2]+strconv.Itoa(idx1+<span class="hljs-number">1</span>), val); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">//excel.SetActiveSheet(sheetIdx)</span><br><span class="hljs-keyword">if</span> err := excel.SaveAs(excelPath); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li><p>可以不用生成<code>newSheet</code>并且激活他，默认会进行此操作</p></li><li><p>写入内容时需要指定单元格位置例如<code>A1</code>、<code>B3</code>，所以我们需要维护一个<code>LetterMap</code>，根据插入数据索引生成单元格位置数据</p></li></ul></blockquote>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>excel</tag>
      
      <tag>excelize</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang定时器</title>
    <link href="/Myblog/2022/01/07/Golang%E5%AE%9A%E6%97%B6%E5%99%A8/"/>
    <url>/Myblog/2022/01/07/Golang%E5%AE%9A%E6%97%B6%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<p><code>Go</code> 可以借助 <code>time.Ticker/time.timer</code> 来实现定时触发器，主要原理是借助无缓冲<code>channel</code>无数据时读取操作会阻塞当前协程，<code>Go</code>会在给定的时间后向<code>channel</code>中写入一些数据（当前时间），故阻塞的协程可以恢复运行，达到延迟或定时执行的功能。</p><ul><li>ticker</li></ul><p><code>time.NewTicker(Duration)</code> 按照给定时间周期性触发</p><ul><li>timer</li></ul><p><code>time.NewTimer(Duration)</code>按照给定时间固定触发，如果想要实现类似<code>ticker</code>的效果，可以在触发完成后调用<code>timer.Reset(Duration)</code>重置触发时间。</p><p><strong><code>ticker</code>和<code>timer</code>会在定义完成后，记录第一次触发时间，并且在时间到达之后，发送到对应无缓冲通道中(<code>timer.C or ticker.C</code>)，发送值为当前时间。</strong></p><p>使用<code>ticker</code>和<code>timer</code>制作定时器打印当前时间</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestTimerAndTicker</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    wg.Add(<span class="hljs-number">2</span>)<br>    layout := <span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span><br>    fmt.Println(<span class="hljs-string">&quot;start: &quot;</span>, time.Now().Format(layout))<br>    ticker := time.NewTicker(<span class="hljs-number">2</span> * time.Second)<br>    timer := time.NewTimer(<span class="hljs-number">2</span> * time.Second)<br><br>    <span class="hljs-comment">//time.Sleep(4 * time.Second)</span><br><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *time.Ticker)</span></span> &#123;<br>        <span class="hljs-keyword">defer</span> wg.Done()<br>        <span class="hljs-keyword">for</span> &#123;<br>            r := &lt;- t.C<br>            fmt.Println(<span class="hljs-string">&quot;ticker C: &quot;</span>, r.Format(layout))<br>            <span class="hljs-comment">//fmt.Println(&quot;ticker: &quot;, time.Now().Format(layout))</span><br>        &#125;<br>    &#125;(ticker)<br><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *time.Timer)</span></span> &#123;<br>        <span class="hljs-keyword">for</span> &#123;<br>            r := &lt;- t.C<br>            fmt.Println(<span class="hljs-string">&quot;timer C: &quot;</span>, r.Format(layout))<br>            <span class="hljs-comment">//fmt.Println(&quot;timer: &quot;, time.Now().Format(layout))</span><br>            t.Reset(<span class="hljs-number">2</span> * time.Second)<br>        &#125;<br>    &#125;(timer)<br>    wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>定时器</tag>
      
      <tag>ticker</tag>
      
      <tag>timer</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ioutil.TempFile临时文件</title>
    <link href="/Myblog/2021/11/11/ioutil-TempFile%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6/"/>
    <url>/Myblog/2021/11/11/ioutil-TempFile%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>很多时候我们需要创建一些文件和目录进行操作，但是在不同操作系统中，不同文件夹有不同的操作权限，所以这时候我们就需要临时目录了，不同操作系统对应的临时目录不同，但是都有对应的读写权限。</p><h4 id="创建临时目录"><a href="#创建临时目录" class="headerlink" title="创建临时目录"></a>创建临时目录</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TempDir</span><span class="hljs-params">(dir, prefix <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(name <span class="hljs-keyword">string</span>, err error)</span></span><br></code></pre></td></tr></table></figure><blockquote><ul><li>dir - 指定临时文件夹路径，传入零值默认取os.TempDir()</li><li>perfix - 匹配子文件夹名称，如果不写<code>&quot;*&quot;</code>默认在最后添加，并且所有<code>&quot;*&quot;</code>会被替换成随机数字字符串</li></ul></blockquote><h4 id="创建临时文件"><a href="#创建临时文件" class="headerlink" title="创建临时文件"></a>创建临时文件</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TempFile</span><span class="hljs-params">(dir, pattern <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(f *os.File, err error)</span></span><br></code></pre></td></tr></table></figure><blockquote><ul><li>dir - 指定创建临时文件路径，传入零值默认取os.TempDir()</li><li>pattern - 指定创建文件名称，如果不写<code>&quot;*&quot;</code>默认在最后添加，并且所有<code>&quot;*&quot;</code>会被替换成随机数字字符串</li></ul></blockquote><p>操作实例</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go">def main() &#123;<br>tempPath, _ := ioutil.TempDir(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;tempfile-*&quot;</span>)<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := os.RemoveAll(tempPath); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err.Error())<br>&#125;<br>&#125;()<br>fmt.Println(tempPath)<br>tmpFile, err := ioutil.TempFile(tempPath, <span class="hljs-string">&quot;prefix-*.txt&quot;</span>)<br><span class="hljs-keyword">defer</span> tmpFile.Close()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err.Error())<br>&#125;<br>fmt.Println(tmpFile.Name())<br><span class="hljs-keyword">if</span> err := ioutil.WriteFile(tmpFile.Name(), []<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;hello world!&quot;</span>, <span class="hljs-number">0666</span>)); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err.Error())<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>os.Remove()</code> 和 <code>os.RemoveAll()</code> 区别在于前者只能删除空文件夹或者文件，后者只要有权限，都能够进行删除。如果文件句柄没有释放，同样也会因为资源被占用无法删除。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>临时文件</tag>
      
      <tag>tempfile</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis缓存雪崩、穿透、击穿</title>
    <link href="/Myblog/2021/10/11/Redis%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF/"/>
    <url>/Myblog/2021/10/11/Redis%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF/</url>
    
    <content type="html"><![CDATA[<p>Redis我们常用给一些热点数据或耗时任务来做缓存，但是实际开发中我们可能会遇到缓存雪崩、穿透和击穿的情况，下面分别是他们之前的区别和对应的解决方案。</p><h4 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h4><p>目前电商首页以及热点数据都会去做缓存 ，一般缓存都是定时任务去刷新，或者是查不到之后去更新的。假设如果是定时任务刷新则容易出现缓存雪崩的问题：大面积的缓存失效，打崩了DB</p><p><strong>举个简单的例子</strong>：如果所有首页的Key失效时间都是12小时，中午12点刷新的，我零点有个秒杀活动大量用户涌入，假设当时每秒 6000 个请求，本来缓存在可以扛住每秒 5000 个请求，但是缓存当时所有的Key都失效了。此时 1 秒 6000 个请求全部落数据库，数据库必然扛不住，它会报一下警，真实情况可能DBA都没反应过来就直接挂了。此时，如果没用什么特别的方案来处理这个故障，DBA 很着急，重启数据库，但是数据库立马又被新的流量给打死了。</p><p><strong>解决方式：</strong></p><ul><li>缓存过期时间添加随机值，这样不会出现大面积缓存失效的现象</li><li>或者不设置过期时间，只在数据有变动时去更新缓存</li></ul><h4 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h4><p>缓存击穿是指一个Key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个Key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个完好无损的桶上凿开了一个洞。</p><p><strong>解决方式：</strong></p><ul><li>设置热点数据永远不过期。</li><li>加上互斥锁。</li></ul><h4 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h4><p>缓存穿透是指缓存和数据库中都没有的数据，而用户不断发起请求，这样所有请求都会落到DB上，并且因为数据库也没有对应数据，导致不会产生新的缓存，攻击会导致数据库压力过大，严重会击垮数据库。比如数据库的 id 都是1开始自增上去的，如发起为id值为 -1 的数据或 id 为特别大不存在的数据，就会出现这种情况。</p><p><strong>解决方式：</strong></p><ul><li>服务端对用户传递参数合法性进行校验</li><li>从缓存取不到的数据，在数据库中也没有取到，这时也可以将对应Key的Value对写为null、位置错误、稍后重试这样的值具体取啥问产品，或者看具体的场景，缓存有效时间可以设置短点，如30秒（设置太长会导致正常情况也没法使用）</li></ul>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang新手易踩坑点</title>
    <link href="/Myblog/2021/09/29/Golang%E6%96%B0%E6%89%8B%E6%98%93%E8%B8%A9%E5%9D%91%E7%82%B9/"/>
    <url>/Myblog/2021/09/29/Golang%E6%96%B0%E6%89%8B%E6%98%93%E8%B8%A9%E5%9D%91%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h4 id="修改string-类型的常量"><a href="#修改string-类型的常量" class="headerlink" title="修改string 类型的常量"></a>修改string 类型的常量</h4><p>尝试使用索引遍历字符串，来更新字符串中的个别字符，是不允许的。</p><p>string 类型的值是只读的二进制 byte slice，如果真要修改字符串中的字符，将 string 转为 []byte 修改后，再转为 string 即可</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 修改字符串的错误示例</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  x := <span class="hljs-string">&quot;text&quot;</span><br>  x[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;T&quot;</span>    <span class="hljs-comment">// error: cannot assign to x[0]</span><br>  fmt.Println(x)<br>&#125;<br></code></pre></td></tr></table></figure><p>可以这样去修改</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  x := <span class="hljs-string">&quot;text&quot;</span><br>  xBytes := []<span class="hljs-keyword">byte</span>(x)<br>  xBytes[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;T&#x27;</span> <span class="hljs-comment">// 注意此时的 T 是 rune 类型</span><br>  x = <span class="hljs-keyword">string</span>(xBytes)<br>  fmt.Println(x) <span class="hljs-comment">// Text</span><br>&#125;<br></code></pre></td></tr></table></figure><p>注意: 上边的示例并不是更新字符串的正确姿势，因为一个 UTF8 编码的字符可能会占多个字节，比 如汉字就需要 3~4 个字节来存储，此时更新其中的一个字节是错误的。</p><p>更新字串的正确姿势: <strong>将 string 转为 rune slice(此时 1 个 rune 可能占多个 byte)，直接更新 rune 中的字符</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  x := <span class="hljs-string">&quot;text&quot;</span><br>  xRunes := []<span class="hljs-keyword">rune</span>(x)<br>  xRunes[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;我&#x27;</span><br>  x = <span class="hljs-keyword">string</span>(xRunes)<br>  fmt.Println(x) <span class="hljs-comment">// 我ext</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="字符串的长度"><a href="#字符串的长度" class="headerlink" title="字符串的长度"></a>字符串的长度</h4><p>Go 的内建函数 <code>len()</code> 返回的是字符串的 <code>byte</code> 数量</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    x := <span class="hljs-string">&quot;Go语言&quot;</span><br>    fmt.Println(<span class="hljs-built_in">len</span>(x))<br>&#125;<br><span class="hljs-comment">// 8</span><br></code></pre></td></tr></table></figure><p>如果需要计算字符串的字符数，可使用 <code>&quot;unicode/utf8&quot;</code> 包中的 <code>RuneCountInString(str string) (n int)</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    x := <span class="hljs-string">&quot;Go语言&quot;</span><br>    fmt.Println(utf8.RuneCountInString(x))<br>&#125;<br><span class="hljs-comment">// 4</span><br></code></pre></td></tr></table></figure><blockquote><p>注意：RuneCountInString 并不总是返回我们看到的字符数，因为有的字符会占用 2 个 rune</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    char := <span class="hljs-string">&quot;é&quot;</span><br>    fmt.Println(<span class="hljs-built_in">len</span>(char)) <span class="hljs-comment">// 3</span><br>    fmt.Println(utf8.RuneCountInString(char)) <span class="hljs-comment">// 2 </span><br>    fmt.Println(<span class="hljs-string">&quot;cafe\u0301&quot;</span>) <span class="hljs-comment">// café // 法文的 cafe，实际上是两个 rune 的组合</span><br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h4 id="range-迭代-map-乱序"><a href="#range-迭代-map-乱序" class="headerlink" title="range 迭代 map 乱序"></a>range 迭代 map 乱序</h4><p>如果你希望以特定的顺序(如按 key 排序)来迭代 map，要注意每次迭代都可能产生不一样的结果。</p><p>Go 的运行时是有意打乱迭代顺序的，所以你得到的迭代结果可能不一致。</p><h4 id="for-语句中的迭代变量与闭包函数"><a href="#for-语句中的迭代变量与闭包函数" class="headerlink" title="for 语句中的迭代变量与闭包函数"></a>for 语句中的迭代变量与闭包函数</h4><p>for 语句中的迭代变量在每次迭代中都会重用，即 for 中创建的闭包函数接收到的参数始终是同一个 变量，在 goroutine 开始执行时都会得到同一个迭代值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    data := []<span class="hljs-keyword">string</span> &#123;<span class="hljs-string">&quot;one&quot;</span>, <span class="hljs-string">&quot;two&quot;</span>, <span class="hljs-string">&quot;three&quot;</span>&#125;<br>    <span class="hljs-keyword">for</span> _, i := <span class="hljs-keyword">range</span> data &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            fmt.Println(i)<br>        &#125;()<br>    &#125;<br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>&#125;<br><span class="hljs-comment">// 输出 three three three</span><br></code></pre></td></tr></table></figure><p>最简单的解决方法:无需修改 goroutine 函数，在 for 内部使用局部变量保存迭代值，再传参</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    data := []<span class="hljs-keyword">string</span> &#123;<span class="hljs-string">&quot;one&quot;</span>, <span class="hljs-string">&quot;two&quot;</span>, <span class="hljs-string">&quot;three&quot;</span>&#125;<br>    <span class="hljs-keyword">for</span> _, i := <span class="hljs-keyword">range</span> data &#123;<br>        j := i<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            fmt.Println(j)<br>        &#125;()<br>    &#125;<br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>&#125;<br><span class="hljs-comment">// 输出 one two three</span><br></code></pre></td></tr></table></figure><p>另一个解决方法:直接将当前的迭代值以参数形式传递给匿名函数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    data := []<span class="hljs-keyword">string</span> &#123;<span class="hljs-string">&quot;one&quot;</span>, <span class="hljs-string">&quot;two&quot;</span>, <span class="hljs-string">&quot;three&quot;</span>&#125;<br>    <span class="hljs-keyword">for</span> _, i := <span class="hljs-keyword">range</span> data &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(in <span class="hljs-keyword">string</span>)</span></span> &#123;<br>            fmt.Println(in)<br>        &#125;(i)<br>    &#125;<br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>&#125;<br><span class="hljs-comment">// 输出 one two three</span><br></code></pre></td></tr></table></figure><h4 id="不导出的-struct-字段无法被-encode"><a href="#不导出的-struct-字段无法被-encode" class="headerlink" title="不导出的 struct 字段无法被 encode"></a>不导出的 struct 字段无法被 encode</h4><p>以小写字母开头的字段成员是无法被外部直接访问的，所以 struct 在进行 json、xml、gob 等格式的 encode 操作时，这些私有字段会被忽略，导出时得到零值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  in := MyData&#123;<span class="hljs-number">1</span>, <span class="hljs-string">&quot;two&quot;</span>&#125;<br>  fmt.Printf(<span class="hljs-string">&quot;%#v\n&quot;</span>, in) <span class="hljs-comment">// main.MyData&#123;One:1, two:&quot;two&quot;&#125;</span><br>  encoded, _ := json.Marshal(in)<br>  fmt.Println(<span class="hljs-keyword">string</span>(encoded)) <span class="hljs-comment">// &#123;&quot;One&quot;:1&#125; // 私有字段 two 被忽略了</span><br><br>  <span class="hljs-keyword">var</span> out MyData<br>  json.Unmarshal(encoded, &amp;out)<br>  fmt.Printf(<span class="hljs-string">&quot;%#v\n&quot;</span>, out)     <span class="hljs-comment">// main.MyData&#123;One:1, two:&quot;&quot;&#125;</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="类型声明与方法"><a href="#类型声明与方法" class="headerlink" title="类型声明与方法"></a>类型声明与方法</h4><p>从一个interface 类型创建新类型时，声明会保留它的方法集</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> myLocker sync.Locker     <span class="hljs-comment">// sync.Locker 是 interface 类型</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> locker myLocker<br>    locker.Lock()<br>    locker.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><p>从一个现有的非 interface 类型创建新类型时，并不会继承原有的方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> myMutex sync.Mutex       <span class="hljs-comment">// sync.Mutex 是 struct 类型</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> mtx myMutex<br>    mtx.Lock()<br>    mtx.UnLock()<br>&#125;<br></code></pre></td></tr></table></figure><p>如果你需要使用原类型的方法，可将原类型以匿名字段的形式嵌到你定义的新 struct 中</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> myMutex <span class="hljs-keyword">struct</span> &#123;<br>    sync.Mutex<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> mtx myMutex<br>    mtx.Lock()<br>    mtx.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="defer-函数的参数值"><a href="#defer-函数的参数值" class="headerlink" title="defer 函数的参数值"></a>defer 函数的参数值</h4><p>对 defer 延迟执行的函数，它的参数会在声明时候就会求出具体值，而不是在执行时才求值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;result: &quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> i * <span class="hljs-number">2</span> &#125;())<br>    i++<br>&#125;<br><span class="hljs-comment">// 2</span><br></code></pre></td></tr></table></figure><h4 id="interface类型作为方法参数"><a href="#interface类型作为方法参数" class="headerlink" title="interface类型作为方法参数"></a>interface类型作为方法参数</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Inter <span class="hljs-keyword">interface</span> &#123;<br>    GetName() <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Person)</span> <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;person&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">test</span><span class="hljs-params">(i Inter)</span></span> &#123;<br>    fmt.Println(i.GetName())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> p Person<br>    test(p)<br>&#125;<br></code></pre></td></tr></table></figure><p>以上例子中 <code>test(p)</code>处会报错，编译不通过。因为此处定义<code>*Person</code>实现了接口<code>Inter</code>，而不是<code>Person</code>，所以传入<code>p</code>是不能够被方法<code>test(i Inter)</code>接受的。</p><p>所以我们这样修改一下就好了。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> p Person<br>    test(&amp;p)<br>&#125;<br></code></pre></td></tr></table></figure><p>我们再看这个例子。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Inter <span class="hljs-keyword">interface</span> &#123;<br>    GetName() <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span> <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;person&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">test</span><span class="hljs-params">(i Inter)</span></span> &#123;<br>    fmt.Println(i.GetName())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> p1 Person<br>    <span class="hljs-keyword">var</span> p2 Person<br>    test(p1)<br>    test(&amp;p2)<br>&#125;<br></code></pre></td></tr></table></figure><p>你会惊奇的发现<code>test(p1)</code>、<code>test(&amp;p2)</code>都OK，可以正常编译运行。如果按照上面的思路，实现接口的是结构体<code>Person</code>而不是<code>*Person</code>，为什么<code>test(&amp;p2)</code>可以正常编译呢？</p><p>因为golang里面，定义<code>GetName</code>普通方法(非指针类型)时，会自动生成对应指针类型的方法，所以都能够正常传入。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span> <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;person&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>同样的，我们也就可以理解为什么定义<code>interface&#123;&#125;</code>类型的参数，可以接收任意类型值。</p><p> </p><h4 id="如何优雅组装切片"><a href="#如何优雅组装切片" class="headerlink" title="如何优雅组装切片"></a>如何优雅组装切片</h4><p><strong>使用append函数 和 拆分切片实现切片重组！</strong></p><p>案例一：<code>[]int&#123;1,2,3,4,5,6&#125;</code>  =&gt; <code>[]int&#123;4,5,6,1,2,3&#125;</code></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs golang">a := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>&#125;<br>res = <span class="hljs-built_in">append</span>(a[<span class="hljs-number">3</span>:], a[:<span class="hljs-number">3</span>]...)<br></code></pre></td></tr></table></figure><p>案例二：在切片<code>[]int&#123;1,2,3,4,5,6&#125;</code> 索引为1的位置插入元素0</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs golang">a := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>&#125;<br>res = <span class="hljs-built_in">append</span>(a[:<span class="hljs-number">1</span>], <span class="hljs-built_in">append</span>([]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">0</span>&#125;, a[<span class="hljs-number">1</span>:]...)...)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GoLang实用功能</title>
    <link href="/Myblog/2021/08/27/GoLang%E5%AE%9E%E7%94%A8%E5%8A%9F%E8%83%BD/"/>
    <url>/Myblog/2021/08/27/GoLang%E5%AE%9E%E7%94%A8%E5%8A%9F%E8%83%BD/</url>
    
    <content type="html"><![CDATA[<h3 id="MD5值"><a href="#MD5值" class="headerlink" title="MD5值"></a>MD5值</h3><p>计算字符串对应md5值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MD5</span><span class="hljs-params">(str <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>    s := md5.New()<br>    s.Write([]<span class="hljs-keyword">byte</span>(str))<br>    <span class="hljs-keyword">return</span> hex.EncodeToString(s.Sum(<span class="hljs-literal">nil</span>))<br>&#125;<br></code></pre></td></tr></table></figure><p>计算文件对应md值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MD5ToFile</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;<br>    f, err := os.Open(path)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>    &#125;<br>    <span class="hljs-keyword">defer</span> f.Close()<br>    s := md5.New()<br>    <span class="hljs-keyword">if</span> _, err := io.Copy(s, f); err != <span class="hljs-literal">nil</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>    &#125;<br>    <span class="hljs-keyword">return</span> hex.EncodeToString(s.Sum(<span class="hljs-literal">nil</span>)), <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="判断是否为零值"><a href="#判断是否为零值" class="headerlink" title="判断是否为零值"></a>判断是否为零值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IsZeroOfUnderlyingType</span><span class="hljs-params">(x <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;<br>    <span class="hljs-keyword">return</span> reflect.DeepEqual(x, reflect.Zero(reflect.TypeOf(x)).Interface())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>      <span class="hljs-keyword">var</span> person Person   <span class="hljs-comment">// 定义一个零值</span><br>        fmt.Println(IsZeroOfUnderlyingType(person))  <span class="hljs-comment">// true</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li><code>reflect.Zero</code> - 获取指定类型的零值的值</li><li><code>reflect.DeepEqual</code> - 用来判断两个值是否深度一致：除了类型相同；在可以时（主要是基本类型）会使用==；但还会比较array、slice的成员，map的键值对，结构体字段进行深入比对。map的键值对，对键只使用==，但值会继续往深层比对。DeepEqual函数可以正确处理循环的类型。函数类型只有都会nil时才相等；空切片不等于nil切片；还会考虑array、slice的长度、map键值对数。</li></ul></blockquote><h3 id="golang在不同环境交叉编译"><a href="#golang在不同环境交叉编译" class="headerlink" title="golang在不同环境交叉编译"></a>golang在不同环境交叉编译</h3><p>Golang 支持交叉编译， 在一个平台上生成然后再另外一个平台去执行。 而且编译的工具【build】这个工具是Golang 内置的，使用非常方便。</p><ul><li>mac环境编译</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"># linux 下去执行<br>CGO_ENABLED=<span class="hljs-number">0</span>  GOOS=linux  GOARCH=amd64  <span class="hljs-keyword">go</span> build main.<span class="hljs-keyword">go</span><br># Windows 下去执行<br>CGO_ENABLED=<span class="hljs-number">0</span> GOOS=windows  GOARCH=amd64  <span class="hljs-keyword">go</span>  build  main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><ul><li>liunx环境编译</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"># Mac  下去执行<br>CGO_ENABLED=<span class="hljs-number">0</span> GOOS=darwin  GOARCH=amd64  <span class="hljs-keyword">go</span> build main.<span class="hljs-keyword">go</span><br># Windows 下执行<br>CGO_ENABLED=<span class="hljs-number">0</span> GOOS=windows  GOARCH=amd64  <span class="hljs-keyword">go</span> build main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><ul><li>windows环境编译</li></ul><p>需要写一个批处理程序，在里面去设置，因为windows 下的 terminal 不支持shell , 这跟 Mac 和 Linux下的有点不同</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"># Mac 下执行<br>SET  CGO_ENABLED=<span class="hljs-number">0</span><br>SET GOOS=darwin<br>SET GOARCH=amd64<br><span class="hljs-keyword">go</span> build main.<span class="hljs-keyword">go</span><br><br># Linux 去执行<br>SET CGO_ENABLED=<span class="hljs-number">0</span><br>SET GOOS=linux<br>SET GOARCH=amd64<br><span class="hljs-keyword">go</span> build main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><p><strong>参数说明：</strong></p><ul><li><strong>CGO_ENABLED</strong> : CGO 表示golang中的工具，CGO_ENABLED 表示CGO禁用，交叉编译中不能使用CGO的</li><li><strong>GOOS</strong> : 目标平台<ul><li>mac 对应 <strong>darwin</strong></li><li>linux 对应 <strong>linux</strong></li><li>windows 对应 <strong>windows</strong></li></ul></li><li><strong>GOARCH</strong> ：目标平台的体系架构【386，amd64,arm】, 目前市面上的个人电脑一般都是amd64架构的<ul><li>386 也称 x86 对应 32位操作系统</li><li>amd64 也称 x64 对应 64位操作系统</li><li>arm 这种架构一般用于嵌入式开发。 比如 Android , IOS , Win mobile , TIZEN 等</li></ul></li></ul><h3 id="常用外链"><a href="#常用外链" class="headerlink" title="常用外链"></a>常用外链</h3><ul><li><a href="https://studygolang.com/pkgdoc">Golang参考标准库中文文档</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>实用功能</tag>
      
      <tag>工具类</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言之Gorm快速上手</title>
    <link href="/Myblog/2021/08/23/Go%E8%AF%AD%E8%A8%80%E4%B9%8BGorm%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/"/>
    <url>/Myblog/2021/08/23/Go%E8%AF%AD%E8%A8%80%E4%B9%8BGorm%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/</url>
    
    <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>gorm是一个使用Go语言编写的ORM框架。配套齐全的<a href="https://gorm.io/zh_CN/docs/index.html">中文官方文档</a>，对开发者友好，支持主流数据库，并且拥有以下特性。</p><ul><li>全功能 ORM</li><li>关联 (Has One，Has Many，Belongs To，Many To Many，多态，单表继承)</li><li>Create，Save，Update，Delete，Find 中钩子方法</li><li>支持 <code>Preload</code>、<code>Joins</code> 的预加载</li><li>事务，嵌套事务，Save Point，Rollback To Saved Point</li><li>Context、预编译模式、DryRun 模式</li><li>批量插入，FindInBatches，Find/Create with Map，使用 SQL 表达式、Context Valuer 进行 CRUD</li><li>SQL 构建器，Upsert，数据库锁，Optimizer/Index/Comment Hint，命名参数，子查询</li><li>复合主键，索引，约束</li><li>Auto Migration</li><li>自定义 Logger</li><li>灵活的可扩展插件 API：Database Resolver（多数据库，读写分离）、Prometheus…</li><li>每个特性都经过了测试的重重考验</li><li>开发者友好</li></ul><h3 id="GORM配置"><a href="#GORM配置" class="headerlink" title="GORM配置"></a>GORM配置</h3><p>安装gorm</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> get -u gorm.io/gorm<br><span class="hljs-keyword">go</span> get -u gorm.io/driver/postgres<br></code></pre></td></tr></table></figure><p>这里是测试的项目结构</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go">.<br>├── app<br>│   ├── config<br>│   │   └── db.<span class="hljs-keyword">go</span><br>│   ├── db.<span class="hljs-keyword">go</span><br>│   ├── entity<br>│   │   ├── base.<span class="hljs-keyword">go</span><br>│   │   └── member.<span class="hljs-keyword">go</span><br>│   ├── model<br>│   │   ├── base.<span class="hljs-keyword">go</span><br>│   │   └── member.<span class="hljs-keyword">go</span><br>│   ├── router<br>│   │   ├── health.<span class="hljs-keyword">go</span><br>│   │   └── member.<span class="hljs-keyword">go</span><br>│   ├── service<br>│   │   └── member.<span class="hljs-keyword">go</span><br>│   └── utils<br>│       └── function.<span class="hljs-keyword">go</span><br>├── docker-compose.yml<br>├── <span class="hljs-keyword">go</span>.mod<br>├── <span class="hljs-keyword">go</span>.sum<br>└── main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><h4 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h4><p>app/db.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">var</span> DB *gorm.DB<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>dsn := url.URL&#123;<br>User:     url.UserPassword(config.DBConfig.UserName, config.DBConfig.Password),<br>Scheme:   <span class="hljs-string">&quot;postgres&quot;</span>,<br>Host:     fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, config.DBConfig.Host, config.DBConfig.Port),<br>Path:     config.DBConfig.DataBase,<br>RawQuery: (&amp;url.Values&#123;<span class="hljs-string">&quot;sslmode&quot;</span>: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;disable&quot;</span>&#125;&#125;).Encode(),<br>&#125;<br>dbUrl := dsn.String()<br>dbGorm, err := gorm.Open(postgres.Open(dbUrl), &amp;gorm.Config&#123;<br>DisableForeignKeyConstraintWhenMigrating: <span class="hljs-literal">true</span>,<br>Logger:                                   logger.Default.LogMode(logger.Info),<br>NamingStrategy: schema.NamingStrategy&#123;<br><span class="hljs-comment">//TablePrefix: &quot;gorm_&quot;,</span><br>SingularTable: <span class="hljs-literal">true</span>,<br><span class="hljs-comment">//NoLowerCase: true,</span><br>&#125;,<br>&#125;)<br><span class="hljs-comment">//禁用外键约束</span><br><span class="hljs-comment">//在打开连接时设置日志级别为Info</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;failed to connect database&quot;</span>)<br>&#125;<br>err = dbGorm.AutoMigrate(&amp;Member&#123;&#125;, &amp;Record&#123;&#125;, &amp;RecordItem&#123;&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;failed to migrator&quot;</span>)<br>&#125;<br>DB = dbGorm<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><ul><li>DisableForeignKeyConstraintWhenMigrating - 迁移时是否禁用外键</li><li>Logger - 定义数据库日志输出等级(info可以打印执行sql)</li><li>TablePrefix - 设置表名前缀</li><li>SingularTable - 设置表名是否为单数，默认false</li><li>NoLowerCase - 设置表名是否不小写，默认false</li></ul></blockquote><p>main.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> _ <span class="hljs-string">&quot;app&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>执行<code>app/db.go</code>中的 <code>init </code> 函数，初始化数据库</p></blockquote><h4 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h4><p>查看官方文档有<a href="https://gorm.io/zh_CN/docs/models.html#%E5%AD%97%E6%AE%B5%E6%A0%87%E7%AD%BE">gorm标签</a>的详细使用方式。</p><p>app/model/base.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> BaseModel <span class="hljs-keyword">struct</span> &#123;<br>ID        <span class="hljs-keyword">uint</span>      <span class="hljs-string">`gorm:&quot;primaryKey;comment:ID&quot;`</span><br>CreatedAt time.Time <span class="hljs-string">`gorm:&quot;column:created_at;default:now();not null;comment:创建时间&quot;`</span><br>UpdatedAt time.Time <span class="hljs-string">`gorm:&quot;column:updated_at;default:now();not null;autoUpdateTime;comment:修改时间&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Record <span class="hljs-keyword">struct</span> &#123;<br>BaseModel<br>Note       *<span class="hljs-keyword">string</span>      <span class="hljs-string">`gorm:&quot;column:note;type:text;comment:备注&quot;`</span><br>Weight     *<span class="hljs-keyword">float32</span>    <span class="hljs-string">`gorm:&quot;column:weight;comment:体重(斤)&quot;`</span><br>IsWBM      <span class="hljs-keyword">bool</span>        <span class="hljs-string">`gorm:&quot;column:is_wbm;not null;comment:Drink water before meals&quot;`</span><br>IsRun      <span class="hljs-keyword">bool</span>        <span class="hljs-string">`gorm:&quot;column:is_run;not null;comment:Running&quot;`</span><br>RecordDate time.Time   <span class="hljs-string">`gorm:&quot;column:record_date;default:now();type:date;uniqueIndex:record_agg_unique_idx;not null;comment:记录日期date&quot;`</span><br>MemberId   <span class="hljs-keyword">string</span>      <span class="hljs-string">`gorm:&quot;column:member_id;not null;uniqueIndex:record_agg_unique_idx;comment:用户ID&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li><p><code>autoUpdateTime</code> - 更新数据时自动更新此字段时间</p></li><li><p><code>索引</code> - 使用<code>index</code>和<code>unique</code> 可分别添加<code>索引</code>和<code>唯一索引</code>，索引名称默认定义 ；<code>index</code> , <code>uniqueIndex </code> 指定相同的名字可以创建联合(唯一)索引，创建联合唯一索引时，不要使用<code>unique</code>标签，会继续创建单个唯一索引</p></li></ul></blockquote><p>app/model/member.go</p><p><strong>非必填参数类型建议使用指针，可以保存<code>nil</code>类型，对应数据库中的<code>null</code></strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//type Tabler interface &#123;</span><br><span class="hljs-comment">//TableName() string</span><br><span class="hljs-comment">//&#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//func (t *Member) TableName() string &#123;</span><br><span class="hljs-comment">//return &quot;member&quot;</span><br><span class="hljs-comment">//&#125;</span><br><br><span class="hljs-keyword">type</span> Member <span class="hljs-keyword">struct</span> &#123;<br>BaseModel<br>Username <span class="hljs-keyword">string</span> <span class="hljs-string">`gorm:&quot;column:username;type:varchar(16);unique;not null;comment:用户名&quot;`</span><br>Password <span class="hljs-keyword">string</span> <span class="hljs-string">`gorm:&quot;column:password;type:varchar(128);not null;comment:密码&quot;`</span><br>Phone    *<span class="hljs-keyword">string</span> <span class="hljs-string">`gorm:&quot;column:phone;type:varchar(16);comment:手机号码&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li><p>默认表名：复数小写形式，如果是驼峰改为下划线连接。</p></li><li><p>自定义表名：可以通过实现<code>Tabler</code>接口来更改，<code>TableName()</code>方法返回值为真正创建的表名。</p></li><li><p>自定义表名：也可以通过前文提到的<code>schema.NamingStrategy</code>相关参数进行设置。</p></li></ul></blockquote><h4 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h4><h5 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;golang.org/x/crypto/bcrypt&quot;</span><br><br><span class="hljs-keyword">var</span> db *gorm.DB = app.DB<br><br><span class="hljs-comment">// 参数类型建议使用指针，不为required时，对应零值为nil，insert db时能够方便转换成null </span><br><span class="hljs-keyword">type</span> MemberPartInfo <span class="hljs-keyword">struct</span> &#123;<br>Username  *<span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;username&quot; binding:&quot;required&quot;`</span><br>Password  *<span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;password&quot; binding:&quot;required&quot;`</span><br>Phone   *<span class="hljs-keyword">string</span>      <span class="hljs-string">`json:&quot;phone&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MemberRouter</span><span class="hljs-params">(router *gin.RouterGroup)</span></span> &#123;<br>r := router.Group(<span class="hljs-string">&quot;/members&quot;</span>)<br>r.POST(<span class="hljs-string">&quot;/&quot;</span>, addMember)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addMember</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br><span class="hljs-keyword">var</span> data entity.MemberPartInfo<br><span class="hljs-keyword">if</span> err := c.ShouldBindJSON(&amp;data); err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusBadRequest, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br>  <span class="hljs-comment">// 计算密码加盐哈希值，验证用函数bcrypt.CompareHashAndPassword(hashPassword, password)</span><br>bHash, err := bcrypt.GenerateFromPassword([]<span class="hljs-keyword">byte</span>(*data.Password), bcrypt.DefaultCost)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusForbidden, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">var</span> member = Member&#123;Username: *data.Username, Password: <span class="hljs-keyword">string</span>(bHash), Phone: data.Phone&#125;<br><span class="hljs-keyword">if</span> err := db.Create(&amp;member).Error; err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusForbidden, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br>c.JSON(http.StatusCreated, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>orm接收或传入null值，可以用 <strong>指针</strong> 或 <strong>sql.NullXXX方法</strong>，sql.NullXXX中Valid属性为false时，值为null。实际使用情况来看，个人认为用指针更好，可以参考这篇文章 <a href="https://blog.csdn.net/weixin_42279809/article/details/107800081">gin框架参数零值json绑定的问题</a></p></blockquote><h5 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MemberInfo <span class="hljs-keyword">struct</span> &#123;<br>  ID        *<span class="hljs-keyword">uint</span>      <span class="hljs-string">`json:&quot;id&quot;`</span><br>CreatedAt *time.Time <span class="hljs-string">`json:&quot;created_at&quot;`</span><br>UpdatedAt *time.Time <span class="hljs-string">`json:&quot;updated_at&quot;`</span><br>Username *<span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;username&quot; binding:&quot;required&quot;`</span><br>Password *<span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;password&quot; binding:&quot;required&quot;`</span><br>Phone    *<span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;phone&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">singleMemberInfo</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>memberID := c.Param(<span class="hljs-string">&quot;memberID&quot;</span>)<br><span class="hljs-keyword">var</span> member entity.MemberInfo<br>db.Model(&amp;Member&#123;&#125;).First(&amp;member, memberID)<br>c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>, <span class="hljs-string">&quot;member&quot;</span>: member&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">memberList</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br><span class="hljs-keyword">var</span> members []entity.MemberInfo<br>db.Model(&amp;Member&#123;&#125;).Order(<span class="hljs-string">&quot;id&quot;</span>).Find(&amp;members)<br>c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;ok&quot;</span>, <span class="hljs-string">&quot;data&quot;</span>: members&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>更多高级用法查看<a href="https://gorm.io/zh_CN/docs/query.html#%E6%A3%80%E7%B4%A2%E5%8D%95%E4%B8%AA%E5%AF%B9%E8%B1%A1">官网</a></p><h5 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h5><ul><li>update - 更新单个字段</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">updateMemberInfo</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>memberID := c.Param(<span class="hljs-string">&quot;memberID&quot;</span>)<br>result := db.Model(&amp;Member&#123;&#125;).Where(<span class="hljs-string">&quot;id = ?&quot;</span>, memberID).Update(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;Bob&quot;</span>)<br><span class="hljs-keyword">if</span> err := result.Error; err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusForbidden, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br>c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;update success&quot;</span>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>updates - 更新多个字段</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">result := db.Model(&amp;Member&#123;&#125;).Where(<span class="hljs-string">&quot;id = ?&quot;</span>, memberID).Updates(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><ul><li>save - 保存所有字段</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">updateMemberInfo</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>memberID := c.Param(<span class="hljs-string">&quot;memberID&quot;</span>)<br><span class="hljs-keyword">var</span> m Member<br><span class="hljs-keyword">if</span> db.Model(&amp;Member&#123;&#125;).First(&amp;m, memberID).RowsAffected == <span class="hljs-number">0</span> &#123;<br>c.JSON(http.StatusForbidden, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;没有找到用户信息&quot;</span>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br>m.Username = <span class="hljs-string">&quot;Bob&quot;</span><br>  <span class="hljs-comment">// 注意：如果m为零值，这里save会变成insert操作，所以前面必须加上逻辑判断是否找到用户</span><br><span class="hljs-keyword">if</span> err := db.Save(&amp;m).Error; err != <span class="hljs-literal">nil</span>&#123;<br>c.JSON(http.StatusForbidden, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br>c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;update success&quot;</span>, <span class="hljs-string">&quot;member&quot;</span>: m&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deleteMember</span><span class="hljs-params">(c *gin.Context)</span></span>&#123;<br>memberID := c.Param(<span class="hljs-string">&quot;memberID&quot;</span>)<br>db.Where(<span class="hljs-string">&quot;id=?&quot;</span>, memberID).Delete(&amp;Member&#123;&#125;)<br>  <span class="hljs-comment">// db.Delete(&amp;Member&#123;&#125;, memberID)   根据主键删除</span><br>c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;delete success&quot;</span>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="原生SQL"><a href="#原生SQL" class="headerlink" title="原生SQL"></a>原生SQL</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">singleMemberInfo</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>memberID := c.Param(<span class="hljs-string">&quot;memberID&quot;</span>)<br><span class="hljs-keyword">var</span> member entity.MemberInfo<br>db.Raw(<span class="hljs-string">&quot;select * from member where id = ?&quot;</span>, memberID).Find(&amp;member)<br>c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>, <span class="hljs-string">&quot;member&quot;</span>: member&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="开启事务"><a href="#开启事务" class="headerlink" title="开启事务"></a>开启事务</h4><ul><li>自动事务</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">db.Transaction(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *gorm.DB)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> err := tx.Create(&amp;member).Error; err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// 返回任何错误都会回滚事务</span><br><span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-comment">// 返回 nil 提交事务</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>手动事务</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">tx := db.Begin()<br>tx.Create(&amp;member)<br>tx.Commit()<br> <span class="hljs-comment">// 出现异常手动执行tx.Rollback()</span><br></code></pre></td></tr></table></figure><h4 id="Special-function"><a href="#Special-function" class="headerlink" title="Special function"></a>Special function</h4><h5 id="Find-和-Scan"><a href="#Find-和-Scan" class="headerlink" title="Find 和 Scan"></a>Find 和 Scan</h5><p><code>Find</code> 和 <code>Scan</code> 都是将查询的数据反序列化到对象中，使用情况基本相同</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">db.Model(&amp;Member&#123;&#125;).Where(<span class="hljs-string">&quot;id = ?&quot;</span>, memberID).Find(&amp;member)<br>db.Table(<span class="hljs-string">&quot;member&quot;</span>).Where(<span class="hljs-string">&quot;id = ?&quot;</span>, memberID).Scan(&amp;member)<br></code></pre></td></tr></table></figure><blockquote><p><code>Find</code> 和 <code>Scan</code> 可以互换</p></blockquote><h5 id="Raw-和-Exec"><a href="#Raw-和-Exec" class="headerlink" title="Raw 和 Exec"></a>Raw 和 Exec</h5><p><code>Raw</code> 和 <code>Exec</code> 都可以接收原生SQL执行，<code>Raw</code>适合执行需要接收返回值的语句，<code>Exec</code>适合执行不需要返回值的语句</p><ul><li>Raw</li></ul><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">db.<span class="hljs-constructor">Raw(<span class="hljs-string">&quot;select * from member where id = ?&quot;</span>, <span class="hljs-params">memberID</span>)</span>.<span class="hljs-constructor">Scan(&amp;<span class="hljs-params">member</span>)</span><br></code></pre></td></tr></table></figure><ul><li>Exec</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">db.Exec(<span class="hljs-string">&quot;update member set password=&#x27;123456&#x27;&quot;</span>)<br></code></pre></td></tr></table></figure><h4 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h4><p><a href="https://gorm.io/zh_CN/docs/hooks.html">钩子函数(Hook)</a> 是在创建、查询、更新、删除等操作之前、之后调用的函数。</p><p>如果您已经为模型定义了指定的方法，它会在创建、更新、查询、删除时自动被调用。如果任何回调返回错误，GORM 将停止后续的操作并回滚事务。</p><p>钩子方法的函数签名应该是 <code>func(*gorm.DB) error</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *User)</span> <span class="hljs-title">AfterCreate</span><span class="hljs-params">(tx *gorm.DB)</span> <span class="hljs-params">(err error)</span></span> &#123;<br>  <span class="hljs-keyword">if</span> u.ID == <span class="hljs-number">1</span> &#123;<br>    tx.Model(u).Update(<span class="hljs-string">&quot;role&quot;</span>, <span class="hljs-string">&quot;admin&quot;</span>)<br>  &#125;<br>  <span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *User)</span> <span class="hljs-title">AfterUpdate</span><span class="hljs-params">(tx *gorm.DB)</span> <span class="hljs-params">(err error)</span></span> &#123;<br>  <span class="hljs-keyword">if</span> u.Confirmed &#123;<br>    tx.Model(&amp;Address&#123;&#125;).Where(<span class="hljs-string">&quot;user_id = ?&quot;</span>, u.ID).Update(<span class="hljs-string">&quot;verfied&quot;</span>, <span class="hljs-literal">true</span>)<br>  &#125;<br>  <span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *User)</span> <span class="hljs-title">AfterDelete</span><span class="hljs-params">(tx *gorm.DB)</span> <span class="hljs-params">(err error)</span></span> &#123;<br>  <span class="hljs-keyword">if</span> u.Confirmed &#123;<br>    tx.Model(&amp;Address&#123;&#125;).Where(<span class="hljs-string">&quot;user_id = ?&quot;</span>, u.ID).Update(<span class="hljs-string">&quot;invalid&quot;</span>, <span class="hljs-literal">false</span>)<br>  &#125;<br>  <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><ul><li><a href="https://gorm.io/zh_CN/docs/models.html">gorm中文官方文档</a></li><li><a href="https://gorm.io/zh_CN/docs/models.html#%E5%AD%97%E6%AE%B5%E6%A0%87%E7%AD%BE">gorm标签</a></li><li><a href="https://pkg.go.dev/github.com/go-playground/validator/v10#pkg-overview">go-playground/validator</a></li><li><a href="https://blog.csdn.net/weixin_42279809/article/details/107800081">gin框架参数零值json绑定的问题</a></li><li><a href="http://foreversmart.cc/go/the-difference-of-gorm-scan-and-find/">Gorm 中 Scan 和 Find 的区别</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>gorm</tag>
      
      <tag>orm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>shell常用命令</title>
    <link href="/Myblog/2021/08/18/shell%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/Myblog/2021/08/18/shell%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="常用shell命令"><a href="#常用shell命令" class="headerlink" title="常用shell命令"></a>常用shell命令</h2><p>如果需要查询shell命令的相关参数，可以使用指令<code>man</code>，如<code>man sed</code>，</p><h3 id="输出文件结构"><a href="#输出文件结构" class="headerlink" title="输出文件结构"></a>输出文件结构</h3><p>这里我们需要使用到<code>tree</code>指令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tree -L 3 ./<br></code></pre></td></tr></table></figure><blockquote><p><code>-L</code> 输出目录层级</p></blockquote><h3 id="查询带有特定字符串的文件"><a href="#查询带有特定字符串的文件" class="headerlink" title="查询带有特定字符串的文件"></a>查询带有特定字符串的文件</h3><p>查询当前路径下带有字符串<code>aaaa</code>的文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">grep -rl &#x27;aaaa&#x27; ./<br></code></pre></td></tr></table></figure><blockquote><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c">-r 表示搜索子目录<br>-l 表示输出匹配的文件名<br></code></pre></td></tr></table></figure></blockquote><h3 id="批量替换文件中字符串"><a href="#批量替换文件中字符串" class="headerlink" title="批量替换文件中字符串"></a>批量替换文件中字符串</h3><p>linux环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sed -i &quot;s/aaa/abc/g&quot; test.txt<br></code></pre></td></tr></table></figure><p>这条语句在linux平台下可以正常运行。但是在mac下运行会报错。</p><p>mac环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sed -i &quot;&quot; &quot;s/aaa/abc/g&quot; test.txt<br></code></pre></td></tr></table></figure><blockquote><p>sed命令： </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"> man sed<br>............<br><br>     -i extension<br>             Edit files in-place, saving backups with the specified extension.  If a zero-length extension is given, no backup will be saved.  It is not recom-<br>             mended to give a zero-length extension when in-place editing files, as you risk corruption or partial content in situations where disk space is<br>             exhausted, etc.<br></code></pre></td></tr></table></figure><p>从上面解释可以看出，mac系统中 <code>-i</code> 需要并且必须带一个字符串，用来备份源文件，并且这个字符串将会加在源文件名后面，构成备份文件名。</p></blockquote><p>批量替换特定路径下文件指定内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">grep -rl &#x27;aaa&#x27; ./ | xargs sed -i &quot;&quot; &quot;s/aaa/abc/g&quot;<br></code></pre></td></tr></table></figure><h3 id="自动定时关机"><a href="#自动定时关机" class="headerlink" title="自动定时关机"></a>自动定时关机</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> mac environment</span><br><span class="hljs-meta">#</span><span class="bash"> -v 当前时间的基础上进行加减运算</span><br><span class="hljs-meta">#</span><span class="bash"> +<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span> 格式化时间输出(%y-年份后2位)</span><br><br><span class="hljs-meta">#</span><span class="bash"> 40mins后关机</span><br>方法一<br>date -v +40M +&quot;%y%m%d%H%M&quot;  | xargs sudo shutdown -h  <br>方法二<br>sudo shutdown -h +40<br><br></code></pre></td></tr></table></figure><blockquote></blockquote>]]></content>
    
    
    <categories>
      
      <category>Shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言Web框架之Gin快速上手</title>
    <link href="/Myblog/2021/08/10/Go%E8%AF%AD%E8%A8%80Web%E6%A1%86%E6%9E%B6%E4%B9%8BGin%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/"/>
    <url>/Myblog/2021/08/10/Go%E8%AF%AD%E8%A8%80Web%E6%A1%86%E6%9E%B6%E4%B9%8BGin%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="原生Web服务"><a href="#原生Web服务" class="headerlink" title="原生Web服务"></a>原生Web服务</h2><p>Go语言里面提供了一个完善的net/http包，通过http包可以很方便的搭建起来一个可以运行的Web服务。同时使用这个包能很简单地对Web的路由，静态文件，模版，cookie等数据进行设置和操作。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;html/template&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br>    <span class="hljs-string">&quot;net/http&quot;</span><br>    <span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sayhelloName</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    r.ParseForm()       <span class="hljs-comment">//解析url传递的参数，对于POST则解析响应包的主体（request body）</span><br>    <span class="hljs-comment">//注意:如果没有调用ParseForm方法，下面无法获取表单的数据</span><br>    fmt.Println(r.Form) <span class="hljs-comment">//这些信息是输出到服务器端的打印信息</span><br>    fmt.Println(<span class="hljs-string">&quot;path&quot;</span>, r.URL.Path)<br>    fmt.Println(<span class="hljs-string">&quot;scheme&quot;</span>, r.URL.Scheme)<br>    fmt.Println(r.Form[<span class="hljs-string">&quot;url_long&quot;</span>])<br>    <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> r.Form &#123;<br>        fmt.Println(<span class="hljs-string">&quot;key:&quot;</span>, k)<br>        fmt.Println(<span class="hljs-string">&quot;val:&quot;</span>, strings.Join(v, <span class="hljs-string">&quot;&quot;</span>))<br>    &#125;<br>    fmt.Fprintf(w, <span class="hljs-string">&quot;Hello astaxie!&quot;</span>) <span class="hljs-comment">//这个写入到w的是输出到客户端的</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">login</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;method:&quot;</span>, r.Method) <span class="hljs-comment">//获取请求的方法</span><br>    <span class="hljs-keyword">if</span> r.Method == <span class="hljs-string">&quot;GET&quot;</span> &#123;<br>        t, _ := template.ParseFiles(<span class="hljs-string">&quot;login.gtpl&quot;</span>)<br>        log.Println(t.Execute(w, <span class="hljs-literal">nil</span>))<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//请求的是登录数据，那么执行登录的逻辑判断</span><br>        fmt.Println(<span class="hljs-string">&quot;username:&quot;</span>, r.Form[<span class="hljs-string">&quot;username&quot;</span>])<br>        fmt.Println(<span class="hljs-string">&quot;password:&quot;</span>, r.Form[<span class="hljs-string">&quot;password&quot;</span>])<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    http.HandleFunc(<span class="hljs-string">&quot;/&quot;</span>, sayhelloName)       <span class="hljs-comment">//设置访问的路由</span><br>    http.HandleFunc(<span class="hljs-string">&quot;/login&quot;</span>, login)         <span class="hljs-comment">//设置访问的路由</span><br>    err := http.ListenAndServe(<span class="hljs-string">&quot;:9090&quot;</span>, <span class="hljs-literal">nil</span>) <span class="hljs-comment">//设置监听的端口</span><br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(<span class="hljs-string">&quot;ListenAndServe: &quot;</span>, err)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Web框架Gin"><a href="#Web框架Gin" class="headerlink" title="Web框架Gin"></a>Web框架Gin</h2><p>Gin 是一个用 Go (Golang) 编写的 HTTP web 框架。 它是一个类似于 <a href="https://github.com/go-martini/martini">martini</a> 但拥有更好性能的 API 框架, 优于 <a href="https://github.com/julienschmidt/httprouter">httprouter</a>，速度提高了近 40 倍。 如果你是性能和高效的追求者, 你会爱上 <a href="https://github.com/gin-gonic/gin">Gin</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">go get -u github.com/gin-gonic/gin<br></code></pre></td></tr></table></figure><blockquote><p><code>-u</code>：已存在相关的代码包，强行更新代码包及其依赖包</p></blockquote><h3 id="绑定路由"><a href="#绑定路由" class="headerlink" title="绑定路由"></a>绑定路由</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    engine := gin.Default()<br>    router := engine.Group(<span class="hljs-string">&quot;/api&quot;</span>)<br>    v1 := router.Group(<span class="hljs-string">&quot;/v1&quot;</span>)<br>    v1.GET(<span class="hljs-string">&quot;/hello&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context *gin.Context)</span></span> &#123;<br>        context.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;v1 api&quot;</span>&#125;)<br>    &#125;)<br><br>    v2 := router.Group(<span class="hljs-string">&quot;/v2&quot;</span>)<br>    v2.GET(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context *gin.Context)</span></span> &#123;<br>        context.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;v2 api&quot;</span>&#125;)<br>    &#125;)<br>    engine.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>一般在项目中，我们会拆分不同的路由到各个文件中，方便进行管理，根据以下项目结构，我们会在<code>main.go</code>中配置根路由，在<code>router</code>中去配置各个路由组。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">.<br>├── app<br>│   └── router<br>│       ├── health.go<br>│       ├── member.go<br>│       ├── record.go<br>│       └── record_item.go<br>└── main.go<br></code></pre></td></tr></table></figure><p>app/main.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    r := gin.Default()<br>    bootRouter := r.Group(<span class="hljs-string">&quot;/api&quot;</span>)<br>    router.HealthRouter(bootRouter)<br>    router.MemberRouter(bootRouter)<br>    router.RecordRouter(bootRouter)<br>    router.RecordItemRouter(bootRouter)<br>    err := r.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;web server run failed&quot;</span>)<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>app/router/member.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MemberRouter</span><span class="hljs-params">(router *gin.RouterGroup)</span></span> &#123;<br>    r := router.Group(<span class="hljs-string">&quot;/members&quot;</span>)<br>    r.GET(<span class="hljs-string">&quot;/&quot;</span>, memberList)<br>    r.POST(<span class="hljs-string">&quot;/&quot;</span>, addMember)<br>    r.GET(<span class="hljs-string">&quot;/:memberID&quot;</span>, getMemberInfo)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">memberList</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addMember</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getMemberInfo</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;&#125;<br></code></pre></td></tr></table></figure><h3 id="获取参数"><a href="#获取参数" class="headerlink" title="获取参数"></a>获取参数</h3><h4 id="Querystring-parameters"><a href="#Querystring-parameters" class="headerlink" title="Querystring parameters"></a>Querystring parameters</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    router := gin.Default()<br><br>    router.GET(<span class="hljs-string">&quot;/welcome&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>        firstname := c.DefaultQuery(<span class="hljs-string">&quot;firstname&quot;</span>, <span class="hljs-string">&quot;Guest&quot;</span>)<br>        lastname := c.Query(<span class="hljs-string">&quot;lastname&quot;</span>) <span class="hljs-comment">// shortcut for c.Request.URL.Query().Get(&quot;lastname&quot;)</span><br>        c.String(http.StatusOK, <span class="hljs-string">&quot;Hello %s %s&quot;</span>, firstname, lastname)<br>    &#125;)<br>    router.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>DefaultQuery</code>指定默认值，<code>Query</code>如果获取不到对应的值，则默认为零值，也就是<code>&quot;&quot;</code></p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TestSchema <span class="hljs-keyword">struct</span> &#123;<br>    Firstname <span class="hljs-keyword">string</span>     <span class="hljs-string">`form:&quot;firstname,default=Guest&quot;`</span><br>    Lastname <span class="hljs-keyword">string</span>      <span class="hljs-string">`form:&quot;lastname&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    router := gin.Default()<br><br>    router.GET(<span class="hljs-string">&quot;/welcome&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>    <span class="hljs-keyword">var</span> params TestSchema<br>    <span class="hljs-keyword">if</span> err := c.ShouldBindQuery(&amp;params); err != <span class="hljs-literal">nil</span> &#123;<br>      c.JSON(http.StatusBadRequest, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br>      <span class="hljs-keyword">return</span><br>    &#125;<br>        firstname := params.Firstname<br>        lastname := params.Lastname<br>        c.String(http.StatusOK, <span class="hljs-string">&quot;Hello %s %s&quot;</span>, firstname, lastname)<br>    &#125;)<br>    router.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Query 参数 使用 <code>form</code> 标签能够获取，<code>default</code>设置默认值</p></blockquote><h4 id="Parameters-in-path"><a href="#Parameters-in-path" class="headerlink" title="Parameters in path"></a>Parameters in path</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    router := gin.Default()<br><br>  router.GET(<span class="hljs-string">&quot;/user/:name&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>      name := c.Param(<span class="hljs-string">&quot;name&quot;</span>)<br>        <span class="hljs-comment">// page := c.Params.ByName(&quot;page&quot;)    // c.Param(&quot;name&quot;) 也是调用这个方法</span><br>        c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;name&quot;</span>: name&#125;)<br>  &#125;)<br>    router.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Paramerters-in-header"><a href="#Paramerters-in-header" class="headerlink" title="Paramerters in header"></a>Paramerters in header</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserInfo</span><span class="hljs-params">(c *gin.Context)</span> <span class="hljs-params">(entity.MemberInfo, error)</span></span> &#123;<br>    memberID := c.Request.Header.Get(<span class="hljs-string">&quot;X-Consumer-Custom-ID&quot;</span>)<br>    <span class="hljs-comment">//memberID := c.GetHeader(&quot;X-Consumer-Custom-ID&quot;)  // 同上，没有对应key则为零值</span><br>    <span class="hljs-keyword">var</span> m entity.MemberInfo<br>    <span class="hljs-keyword">if</span> memberID == <span class="hljs-string">&quot;&quot;</span> &#123;<br>        <span class="hljs-keyword">return</span> m, errors.New(<span class="hljs-string">&quot;请在Header传入X-Consumer-Custom-ID用户信息&quot;</span>)<br>    &#125;<br>    r := db.Table(<span class="hljs-string">&quot;member&quot;</span>).First(&amp;m, <span class="hljs-string">&quot;id = ?&quot;</span>, memberID)<br>    <span class="hljs-keyword">if</span> r.RowsAffected == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> m, errors.New(<span class="hljs-string">&quot;没有找到该用户信息&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> m, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Data-in-json"><a href="#Data-in-json" class="headerlink" title="Data in json"></a>Data in json</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> AddMember <span class="hljs-keyword">struct</span> &#123;<br>    Username  <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;username&quot; binding:&quot;required&quot;`</span><br>    Password  <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;password&quot; binding:&quot;required&quot;`</span><br>    Phone  <span class="hljs-keyword">string</span>       <span class="hljs-string">`json:&quot;phone&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    router := gin.Default()<br><br>  router.POST(<span class="hljs-string">&quot;/users&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>        <span class="hljs-keyword">var</span> data AddMember<br>        <span class="hljs-keyword">if</span> err := c.ShouldBindJSON(&amp;data); err != <span class="hljs-literal">nil</span> &#123;<br>        c.JSON(http.StatusBadRequest, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br>        <span class="hljs-keyword">return</span><br>      &#125;<br>      username := data.Username<br>        password := data.Password<br>    c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;username&quot;</span>: username, <span class="hljs-string">&quot;password&quot;</span>: password&#125;)<br>  &#125;)<br>    router.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Json 数据 需要使用 <code>json</code> 标签获取</p></blockquote><h4 id="Multipart-Urlencoded-Form"><a href="#Multipart-Urlencoded-Form" class="headerlink" title="Multipart/Urlencoded Form"></a>Multipart/Urlencoded Form</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    router := gin.Default()<br><br>    router.POST(<span class="hljs-string">&quot;/form_post&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>        message := c.PostForm(<span class="hljs-string">&quot;message&quot;</span>)<br>        nick := c.DefaultPostForm(<span class="hljs-string">&quot;nick&quot;</span>, <span class="hljs-string">&quot;anonymous&quot;</span>)<br><br>        c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>            <span class="hljs-string">&quot;status&quot;</span>:  <span class="hljs-string">&quot;posted&quot;</span>,<br>            <span class="hljs-string">&quot;message&quot;</span>: message,<br>            <span class="hljs-string">&quot;nick&quot;</span>:    nick,<br>        &#125;)<br>    &#125;)<br>    router.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Upload-files"><a href="#Upload-files" class="headerlink" title="Upload files"></a>Upload files</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    router := gin.Default()<br>    <span class="hljs-comment">// Set a lower memory limit for multipart forms (default is 32 MiB)</span><br>    router.MaxMultipartMemory = <span class="hljs-number">8</span> &lt;&lt; <span class="hljs-number">20</span>  <span class="hljs-comment">// 8 MiB</span><br>    router.POST(<span class="hljs-string">&quot;/upload&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>        <span class="hljs-comment">// single file</span><br>        file, _ := c.FormFile(<span class="hljs-string">&quot;file&quot;</span>)<br>        filename := file.Filename<br>        log.Println(filename)<br><br>        <span class="hljs-comment">// Upload the file to specific dst.</span><br>        c.SaveUploadedFile(file, fmt.Sprintf(<span class="hljs-string">&quot;./&quot;</span> + filename))<br>        c.String(http.StatusOK, fmt.Sprintf(<span class="hljs-string">&quot;&#x27;%s&#x27; uploaded!&quot;</span>, file.Filename))<br>    &#125;)<br>    router.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>8 &lt;&lt; 20</code> ：将8左移20位，也就是8388608字节(8MIB)</p></blockquote><h3 id="参数校验"><a href="#参数校验" class="headerlink" title="参数校验"></a>参数校验</h3><p>在 gin 框架中，参数验证有两种：<code>模型绑定和验证</code>  和 <code>自定义验证器</code></p><h4 id="模型绑定和验证"><a href="#模型绑定和验证" class="headerlink" title="模型绑定和验证"></a>模型绑定和验证</h4><p>gin的参数校验是用 <a href="https://pkg.go.dev/github.com/go-playground/validator/v10#pkg-overview">go-playground/validator</a> ，大家可以选择适合的tag进行使用。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;golang.org/x/crypto/bcrypt&quot;</span><br><br><span class="hljs-keyword">var</span> db *gorm.DB = app.DB<br><br><span class="hljs-keyword">type</span> MemberPartInfo <span class="hljs-keyword">struct</span> &#123;<br>    Username  *<span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;username&quot; binding:&quot;required&quot;`</span><br>    Password  *<span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;password&quot; binding:&quot;required&quot;`</span><br>    Phone   *<span class="hljs-keyword">string</span>      <span class="hljs-string">`json:&quot;phone&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MemberRouter</span><span class="hljs-params">(router *gin.RouterGroup)</span></span> &#123;<br>    r := router.Group(<span class="hljs-string">&quot;/members&quot;</span>)<br>    r.POST(<span class="hljs-string">&quot;/&quot;</span>, addMember)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addMember</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>    <span class="hljs-keyword">var</span> data entity.MemberPartInfo<br>    <span class="hljs-keyword">if</span> err := c.ShouldBindJSON(&amp;data); err != <span class="hljs-literal">nil</span> &#123;<br>        c.JSON(http.StatusBadRequest, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>  <span class="hljs-comment">// 计算密码加盐哈希值，验证用函数bcrypt.CompareHashAndPassword(hashPassword, password)</span><br>    bHash, err := bcrypt.GenerateFromPassword([]<span class="hljs-keyword">byte</span>(*data.Password), bcrypt.DefaultCost)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        c.JSON(http.StatusForbidden, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">var</span> member = Member&#123;Username: *data.Username, Password: <span class="hljs-keyword">string</span>(bHash), Phone: data.Phone&#125;<br>    <span class="hljs-keyword">if</span> err := db.Create(&amp;member).Error; err != <span class="hljs-literal">nil</span> &#123;<br>        c.JSON(http.StatusForbidden, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    c.JSON(http.StatusCreated, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li>模型参数建议使用指针类型，在不为required时，对应零值为nil，insert db时能够方便转换成null进行存储。参考这篇文章<a href="https://blog.csdn.net/weixin_42279809/article/details/107800081">gin框架参数零值json绑定的问题</a> </li><li><code>ShouldBindJSON</code> 和 <code>BindJSON</code> 区别，两者都能返回错误信息，但是后者会在header中写入400状态码</li></ul></blockquote><h4 id="自定义验证器"><a href="#自定义验证器" class="headerlink" title="自定义验证器"></a>自定义验证器</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> get -u github.com/<span class="hljs-keyword">go</span>-playground/validator/v10<br></code></pre></td></tr></table></figure><p>在 v9 之前，validator 的自定义验证一直是这样的：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">customFunc</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">    v *validator.Validate, topStruct reflect.Value, currentStructOrField reflect.Value,</span></span><br><span class="hljs-function"><span class="hljs-params">    field reflect.Value, fieldType reflect.Type, fieldKind reflect.Kind, param <span class="hljs-keyword">string</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">)</span> <span class="hljs-title">bool</span></span> &#123;  <br>  <span class="hljs-keyword">if</span> i, ok := field.Interface().(<span class="hljs-keyword">uint8</span>); ok &#123;<br>      <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1</span> || i &gt; <span class="hljs-number">2</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>显得冗长，不优雅，在 v9 经过重新设计以后，我们就可以通过更加优雅的方式来定义自己的字段验证了：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/go-playground/validator/v10&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TypeValid</span><span class="hljs-params">(fl validator.FieldLevel)</span> <span class="hljs-title">bool</span></span> &#123;<br>    <span class="hljs-keyword">if</span> i, ok := fl.Field().Interface().(<span class="hljs-keyword">uint8</span>); ok &#123;<br>        <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1</span> || i &gt; <span class="hljs-number">2</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>检验字段<code>1 &lt;= i &lt;= 2</code></p></blockquote><p>注册验证器</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span>    <span class="hljs-string">&quot;github.com/gin-gonic/gin/binding&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">if</span> v, ok := binding.Validator.Engine().(*validator.Validate); ok &#123;<br>        v.RegisterValidation(<span class="hljs-string">&quot;TypeValid&quot;</span>, TypeValid)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>注册成功之后就可以进行使用了</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> RecordItemPartInfo <span class="hljs-keyword">struct</span> &#123;<br>    Type        *<span class="hljs-keyword">uint8</span>     <span class="hljs-string">`json:&quot;type&quot; binding:&quot;required,TypeValid&quot;`</span><br>    Description *<span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;description&quot; binding:&quot;required&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>这里我注册的是gin封装好的验证器，使用关键字<code>binding</code>进行解析，如果需要注册原生验证器，需要这样修改。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">type</span> RecordItemPartInfo struct &#123;<br>    <span class="hljs-keyword">Type</span>        *uint8     `<span class="hljs-type">json</span>:&quot;type&quot; <span class="hljs-keyword">validate</span>:&quot;required,TypeValid&quot;`<br>    Description *string    `<span class="hljs-type">json</span>:&quot;description&quot; <span class="hljs-keyword">validate</span>:&quot;required&quot;`<br>&#125;<br><br><br>func init() &#123;<br>    var <span class="hljs-keyword">validate</span> *<span class="hljs-keyword">validator</span>.<span class="hljs-keyword">Validate</span> = <span class="hljs-keyword">validator</span>.<span class="hljs-built_in">New</span>()<br>    <span class="hljs-keyword">validate</span>.RegisterValidation(&quot;TypeValid&quot;, TypeValid)<br>&#125;<br></code></pre></td></tr></table></figure><p>需要自定义错误消息的话，添加<code>tag</code>  - <code>reg_error_info:错误信息</code></p><h4 id="特殊的日期解析校验"><a href="#特殊的日期解析校验" class="headerlink" title="特殊的日期解析校验"></a>特殊的日期解析校验</h4><p><code>Go</code> 自身的 <code>time.Time</code> 类型默认解析的日期格式是 <code>RFC3339</code> 标准，也就是 <code>2006-01-02T15:04:05Z</code> 的格式。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> RecordItemPartInfo <span class="hljs-keyword">struct</span> &#123;<br>    RecordTime  *time.Time <span class="hljs-string">`json:&quot;record_time&quot; binding:&quot;required&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>但是如果我们想要在 <code>Gin</code> 的 <code>shouldBindJSON</code> 方法中，传入 <code>YYYY-MM-DD hh:mm:ss</code> 格式的日期格式作为 <code>time.Time</code> 类型的值，就会引发类似于 <code>parsing time xx as xx: cannot parse xx as xx</code> 的报错信息，这是因为 <code>time.Time</code> 类型默认支持的日期格式与我们传入的格式不同，导致解析出错。</p><p><strong>解决方法</strong>： 我们需要定义一个新的 <code>time.Time</code> 类型，自定义的日期格式解析行为，包括 <code>c.ShouldBindJSON</code> / <code>c.JSON</code> / <code>gorm写入Value</code> / <code>gorm写出Scan</code> </p><p><code>gorm</code> 内部是通过 <code>Value</code> 和 <code>Scan</code> 这两个方法完成值的写入和检出。那么从这个角度出发，我们就需要给我们的类型实现 <code>Value</code> 和 <code>Scan</code> 方法，分别对应写入的时候获取值和检出的时候解析值。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyLocalTime time.Time<br><br><span class="hljs-keyword">var</span> loc, _ = time.LoadLocation(<span class="hljs-string">&quot;Asia/Shanghai&quot;</span>)<br><span class="hljs-keyword">const</span> TimeFormat = <span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span><br><br><span class="hljs-comment">// 对应c.ShouldBindJSON方法，反序列化</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *MyLocalTime)</span> <span class="hljs-title">UnmarshalJSON</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">(err error)</span></span> &#123;<br>    <span class="hljs-comment">// 空值不进行解析</span><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">2</span> &#123;<br>        *t = MyLocalTime(time.Time&#123;&#125;)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>  <span class="hljs-comment">// 指定解析的格式</span><br>    now, err := time.ParseInLocation(<span class="hljs-string">`&quot;`</span>+TimeFormat+<span class="hljs-string">`&quot;`</span>, <span class="hljs-keyword">string</span>(data), loc)<br>    *t = MyLocalTime(now)<br>    <span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// 序列化</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t MyLocalTime)</span> <span class="hljs-title">MarshalJSON</span><span class="hljs-params">()</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;<br>    b := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">byte</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(TimeFormat)+<span class="hljs-number">2</span>)<br>    b = <span class="hljs-built_in">append</span>(b, <span class="hljs-string">&#x27;&quot;&#x27;</span>)<br>    b = time.Time(t).AppendFormat(b, TimeFormat)<br>    b = <span class="hljs-built_in">append</span>(b, <span class="hljs-string">&#x27;&quot;&#x27;</span>)<br>    <span class="hljs-keyword">return</span> b, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 写入数据库时调用</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t MyLocalTime)</span> <span class="hljs-title">Value</span><span class="hljs-params">()</span> <span class="hljs-params">(driver.Value, error)</span></span> &#123;<br>  <span class="hljs-comment">// 0001-01-01 00:00:00 属于空值，遇到空值解析成 null 即可</span><br>    <span class="hljs-keyword">if</span> t.String() == <span class="hljs-string">&quot;0001-01-01 00:00:00&quot;</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> time.Time(t).Format(TimeFormat), <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 检出数据库时调用</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *MyLocalTime)</span> <span class="hljs-title">Scan</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>  <span class="hljs-comment">// mysql 内部日期的格式可能是 2006-01-02 15:04:05 +0800 CST 格式，所以检出的时候还需要进行一次格式化</span><br>    tTime, _ := time.ParseInLocation(<span class="hljs-string">&quot;2006-01-02 15:04:05 +0800 CST&quot;</span>, v.(time.Time).String(), loc)<br>    *t = MyLocalTime(tTime)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 用于 fmt.Println 和后续验证场景</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t MyLocalTime)</span> <span class="hljs-title">String</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">return</span> time.Time(t).Format(TimeFormat)<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> RecordItemPartInfo <span class="hljs-keyword">struct</span> &#123;<br>    RecordTime  *MyLocalTime <span class="hljs-string">`json:&quot;record_time&quot; binding:&quot;required&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>gorm</code>中对应的时间类型也要使用<code>MyLocalTime</code>，才能正常使用自定义的 <code>Value</code>和 <code>Scan</code> 方法</p></blockquote><p>这时候你的 <code>go</code> 应用已经可以正常存取自定义的日期格式格式了，但是如果传入一个空字符串 <code>&quot;&quot;</code> 日期数据，也会通过校验，并在数据库写入 <code>null</code>！这个问题是因为 <code>gin</code> 内置的 <code>validator</code> 对我们的 <code>model.LocalTime</code> 还没有一个完善的空值检测机制，我们只需要加上这个检测机制即可。（实现如下）</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;github.com/gin-gonic/gin/binding&quot;</span><br>    <span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">if</span> v, ok := binding.Validator.Engine().(*validator.Validate); ok &#123;<br>        <span class="hljs-comment">// 注册 model.LocalTime 类型的自定义校验规则</span><br>        v.RegisterCustomTypeFunc(ValidateJSONDateType, entity.MyLocalTime&#123;&#125;)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ValidateJSONDateType</span><span class="hljs-params">(field reflect.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br>    <span class="hljs-keyword">if</span> field.Type() == reflect.TypeOf(MyLocalTime&#123;&#125;) &#123;<br>        timeStr := field.Interface().(MyLocalTime).String()<br>        <span class="hljs-comment">// 0001-01-01 00:00:00 是 go 中 time.Time 类型的空值</span><br>        <span class="hljs-comment">// 这里返回 Nil 则会被 validator 判定为空值，而无法通过 `binding:&quot;required&quot;` 规则</span><br>        <span class="hljs-keyword">if</span> timeStr == <span class="hljs-string">&quot;0001-01-01 00:00:00&quot;</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> timeStr<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>参考文章《<a href="https://segmentfault.com/a/1190000022264001">Go 自定义日期时间格式解析解决方案</a>》</p><h3 id="自定义中间件"><a href="#自定义中间件" class="headerlink" title="自定义中间件"></a>自定义中间件</h3><p>如果需要自定义engine，不使用默认自带的中间件<code>gin.Logger()</code>和<code>gin.Recovery()</code>等，则可以使用<code>gin.New()</code>创建空干净的engine，自定义logger或recovery动作，可以参考下这篇文章 <a href="https://github.com/xinliangnote/Go/blob/master/01-Gin%E6%A1%86%E6%9E%B6/05-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86.md">自定义错误处理</a></p><p>自定义中间件，需要函数返回<code>gin.HandlerFunc</code>类型，在<code>c.Next()</code> 前后位置分别自定义<code>request</code>前后的逻辑。</p><p>在中间件中如果不想继续后续接口的调用不能直接return，而是应该调用<code>c.Abort()</code>方法。如果需要返回状态码和对应的消息体，可以使用<code>c.AbortWithStatusJSON()</code>方法。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    r := gin.New()<br>  <span class="hljs-comment">// 使用用中间件</span><br>    r.Use(Logger(), Recover())<br><br>    r.GET(<span class="hljs-string">&quot;/test&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>        example := c.MustGet(<span class="hljs-string">&quot;example&quot;</span>).(<span class="hljs-keyword">string</span>)<br>        log.Println(example)<br>    &#125;)<br>    r.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="接口处理时间"><a href="#接口处理时间" class="headerlink" title="接口处理时间"></a>接口处理时间</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">costTime</span><span class="hljs-params">()</span> <span class="hljs-title">gin</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>        nowTime := time.Now()<br>        c.Next()<br>        costTime := time.Since(nowTime)<br>        url := c.Request.URL.String()<br>        fmt.Printf(<span class="hljs-string">&quot;the request URL %s cost %v\n&quot;</span>, url, costTime)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Auth</span><span class="hljs-params">()</span> <span class="hljs-title">gin</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>        <span class="hljs-comment">// 排除不需要认证的接口</span><br>        unAuthPaths := []<span class="hljs-keyword">string</span> &#123;<br>            <span class="hljs-string">&quot;/api/members&quot;</span>,<br>        &#125;<br>        flag := <span class="hljs-literal">true</span><br>        path := c.Request.URL.String()<br>        <span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> unAuthPaths &#123;<br>            <span class="hljs-keyword">if</span> strings.Contains(path, p) &#123;<br>                flag = <span class="hljs-literal">false</span><br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 正常情况我们应该验证登录签名，这里只简单验证请求头是否有X-Consumer-Custom-ID请求头信息</span><br>        <span class="hljs-keyword">if</span> _, err := utils.UserInfoByHeader(c); err != <span class="hljs-literal">nil</span> &amp;&amp; flag &#123;<br>            c.Abort()<br>            c.JSON(http.StatusBadRequest, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: err.Error()&#125;)<br>            <span class="hljs-comment">//c.AbortWithStatusJSON(http.StatusBadRequest, gin.H&#123;&quot;message&quot;: err.Error()&#125;)</span><br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        c.Next()<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserInfoByHeader</span><span class="hljs-params">(c *gin.Context)</span> <span class="hljs-params">(entity.MemberInfo, error)</span></span> &#123;<br>    memberID := c.Request.Header.Get(<span class="hljs-string">&quot;X-Consumer-Custom-ID&quot;</span>)<br>    <span class="hljs-keyword">var</span> m entity.MemberInfo<br>    <span class="hljs-keyword">if</span> memberID == <span class="hljs-string">&quot;&quot;</span> &#123;<br>        <span class="hljs-keyword">return</span> m, errors.New(<span class="hljs-string">&quot;请在Header传入X-Consumer-Custom-ID用户信息&quot;</span>)<br>    &#125;<br>    r := db.Table(<span class="hljs-string">&quot;member&quot;</span>).First(&amp;m, <span class="hljs-string">&quot;id = ?&quot;</span>, memberID)<br>    <span class="hljs-keyword">if</span> r.RowsAffected == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> m, errors.New(<span class="hljs-string">&quot;没有找到该用户信息&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> m, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h3><p>gin支持各种类型数据库，如<code>postgresql</code> / <code>mysql</code> / <code>mongodb</code>等，这里我们以<code>pg</code>为例进行绑定。</p><p>需要安装<code>go get -u gorm.io/driver/postgres</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">.<br>├── app<br>│   ├── config<br>│   │   └── db.<span class="hljs-keyword">go</span><br>│   ├── db.<span class="hljs-keyword">go</span><br>│   └── model<br>│   │   ├── base.<span class="hljs-keyword">go</span><br>│   │   ├── member.<span class="hljs-keyword">go</span><br>│   │   ├── record.<span class="hljs-keyword">go</span><br>│   │   └── record_item.<span class="hljs-keyword">go</span><br>├── docker-compose.yml<br>└── main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><p>app/config/db.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> config<br><br><span class="hljs-keyword">type</span> DB <span class="hljs-keyword">struct</span> &#123;<br>    Host     <span class="hljs-keyword">string</span><br>    Port     <span class="hljs-keyword">int</span><br>    DataBase <span class="hljs-keyword">string</span><br>    UserName <span class="hljs-keyword">string</span><br>    Password <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-keyword">var</span> DBConfig = DB&#123;<br>    <span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>    <span class="hljs-number">5432</span>,<br>    <span class="hljs-string">&quot;diet&quot;</span>,<br>    <span class="hljs-string">&quot;diet&quot;</span>,<br>    <span class="hljs-string">&quot;diet&quot;</span>,<br>&#125;<br></code></pre></td></tr></table></figure><p>app/db.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> app<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;gorm.io/driver/postgres&quot;</span><br>    <span class="hljs-string">&quot;gorm.io/gorm&quot;</span><br>    <span class="hljs-string">&quot;gorm.io/gorm/logger&quot;</span><br>    <span class="hljs-string">&quot;gorm.io/gorm/schema&quot;</span><br>    <span class="hljs-string">&quot;net/url&quot;</span><br><br>    <span class="hljs-string">&quot;diet/app/config&quot;</span><br>    . <span class="hljs-string">&quot;diet/app/model&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> DB *gorm.DB<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>    dsn := url.URL&#123;<br>        User:     url.UserPassword(config.DBConfig.UserName, config.DBConfig.Password),<br>        Scheme:   <span class="hljs-string">&quot;postgres&quot;</span>,<br>        Host:     fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, config.DBConfig.Host, config.DBConfig.Port),<br>        Path:     config.DBConfig.DataBase,<br>        RawQuery: (&amp;url.Values&#123;<span class="hljs-string">&quot;sslmode&quot;</span>: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;disable&quot;</span>&#125;&#125;).Encode(),<br>    &#125;<br>    dbUrl := dsn.String()    <span class="hljs-comment">// postgres://diet:diet@127.0.0.1:5432/diet?sslmode=disable</span><br>    dbGorm, err := gorm.Open(postgres.Open(dbUrl), &amp;gorm.Config&#123;<br>        DisableForeignKeyConstraintWhenMigrating: <span class="hljs-literal">true</span>,<br>        Logger:                                   logger.Default.LogMode(logger.Info),<br>        NamingStrategy: schema.NamingStrategy&#123;<br>            <span class="hljs-comment">//TablePrefix: &quot;gorm_&quot;,</span><br>            SingularTable: <span class="hljs-literal">true</span>,<br>            <span class="hljs-comment">//NoLowerCase: true,</span><br>        &#125;,<br>    &#125;)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;failed to connect database&quot;</span>)<br>    &#125;<br>  <span class="hljs-comment">// 自动创建表</span><br>    err = dbGorm.AutoMigrate(&amp;Member&#123;&#125;, &amp;Record&#123;&#125;, &amp;RecordItem&#123;&#125;)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;failed to migrator&quot;</span>)<br>    &#125;<br>    DB = dbGorm<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li><p>DisableForeignKeyConstraintWhenMigrating - migrate时禁用外键</p></li><li><p>Logger - 指定数据库logger，设置<code>ogger.Default.LogMode(logger.Info)</code> 则默认会打印所有执行sql</p></li><li><p>NamingStrategy - 设置orm命名策略。<code>TablePrefix</code> 设置表前缀；<code>SingularTable</code> 设置表名为单数，默认为复数；<code>NoLowerCase</code> 设置表名不为小写，默认小写。</p></li></ul><blockquote><p> 如果orm中需要自定义表名，只需要重写<code>TableName()</code>方法即可</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Tabler <span class="hljs-keyword">interface</span> &#123;<br>    TableName() <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *Member)</span> <span class="hljs-title">TableName</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;member&quot;</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Member <span class="hljs-keyword">struct</span> &#123;<br>    ID       <span class="hljs-keyword">uint</span>   <span class="hljs-string">`gorm:&quot;primaryKey;comment:ID&quot;`</span><br>    Username <span class="hljs-keyword">string</span> <span class="hljs-string">`gorm:&quot;column:username;not null;comment:用户名&quot;`</span><br>    Password <span class="hljs-keyword">string</span> <span class="hljs-string">`gorm:&quot;column:password;not null;comment:密码&quot;`</span><br>    Phone    *<span class="hljs-keyword">string</span> <span class="hljs-string">`gorm:&quot;column:phone;comment=手机号码&quot;`</span>    <span class="hljs-comment">// 使用指针类型是为了方便传入零值能转换为null</span><br>&#125;<br></code></pre></td></tr></table></figure></blockquote></blockquote><p>app/main.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> _ <span class="hljs-string">&quot;diet/app&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>使用<code>_</code>方式导入，不会导入对应模块的方法或变量，仅仅执行对应的<code>init</code>函数</p></blockquote><h3 id="规划项目结构"><a href="#规划项目结构" class="headerlink" title="规划项目结构"></a>规划项目结构</h3><p>这面的目录结构是我自定义的，大家也可以根据自己的习惯去定义。推荐大家看看这篇文章<a href="https://tech.meituan.com/2017/12/22/ddd-in-practice.html"><a href="https://tech.meituan.com/2017/12/22/ddd-in-practice.html">领域驱动设计在互联网业务开发中的实践</a></a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go">.<br>├── README.md<br>├── app<br>│   ├── config<br>│   │   └── db.<span class="hljs-keyword">go</span><br>│   ├── db.<span class="hljs-keyword">go</span><br>│   ├── entity<br>│   │   └── member.<span class="hljs-keyword">go</span><br>│   ├── middleware<br>│   │   └── auth.<span class="hljs-keyword">go</span><br>│   ├── model<br>│   │   ├── base.<span class="hljs-keyword">go</span><br>│   │   └── member.<span class="hljs-keyword">go</span><br>│   ├── router<br>│   │   ├── health.<span class="hljs-keyword">go</span><br>│   │   └── member.<span class="hljs-keyword">go</span><br>│   ├── service<br>│   │   └── member.<span class="hljs-keyword">go</span><br>│   └── utils<br>│       └── function.<span class="hljs-keyword">go</span><br>├── docker-compose.yml<br>├── <span class="hljs-keyword">go</span>.mod<br>├── <span class="hljs-keyword">go</span>.sum<br>├── main.<span class="hljs-keyword">go</span><br>├── migration<br>└── todo.txt<br></code></pre></td></tr></table></figure><blockquote><ul><li><code>config</code> - 定义项目的一些参数配置</li><li><code>entity</code> - 对提交过来的数据进行验证，然后将验证完成的数据传递给 service 处理</li><li><code>middleware</code> - 存放自定义的中间件</li><li><code>model</code> - 数据库ORM</li><li><code>router</code> - 项目API路由</li><li><code>service</code> - 业务层：定制化一些业务逻辑</li><li><code>utils</code> - 自定义一些工具包</li></ul></blockquote><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="https://gin-gonic.com/zh-cn/docs/">Gin官方文档</a></li><li><a href="https://pkg.go.dev/github.com/go-playground/validator/v10#pkg-overview">go-playground/validator</a> </li><li><a href="https://github.com/xinliangnote/Go/tree/master/03-go-gin-api%20%5B%E6%96%87%E6%A1%A3%5D">03-go-gin-api</a></li><li><a href="https://segmentfault.com/a/1190000022527284">gin - validator 参数校验</a></li><li><a href="https://studygolang.com/pkgdoc">golang标准库中文文档</a></li><li><a href="https://segmentfault.com/a/1190000022264001">Go 自定义日期时间格式解析解决方案</a></li><li><a href="https://tech.meituan.com/2017/12/22/ddd-in-practice.html">领域驱动设计在互联网业务开发中的实践</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>gin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言日志模块</title>
    <link href="/Myblog/2021/08/07/Go%E8%AF%AD%E8%A8%80%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/"/>
    <url>/Myblog/2021/08/07/Go%E8%AF%AD%E8%A8%80%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<p>日志输出是软件开发中必不可少的部分，通常必需包含以下三个重要的内容：<br>1，发生事件的时间戳<br>2，日志的级别，debug，error或info等<br>3，日志的上下文内容，协助问题的排查</p><h3 id="log标准模块"><a href="#log标准模块" class="headerlink" title="log标准模块"></a>log标准模块</h3><p>log包提供基本的日志功能，但是没有提供日志级别（比如debug、warning、error），默认情况日志会打印到标准错误输出中。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>     log.Println(<span class="hljs-string">&quot;Content from log package!&quot;</span>)<br>&#125;<br><span class="hljs-comment">// 2020/07/09 12:20:53 Content from log package!</span><br></code></pre></td></tr></table></figure><p>我们可以通过配置，将日志信息输出到文件中</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// 如果文件logs.txt不存在，会自动创建</span><br>    file, err := os.OpenFile(<span class="hljs-string">&quot;logs.txt&quot;</span>, os.O_APPEND|os.O_CREATE|os.O_WRONLY, <span class="hljs-number">0666</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br><br>    log.SetOutput(file)<br>    log.Println(<span class="hljs-string">&quot;Content from log package!&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>只要实现接口io.Writer的类型都可以作为文件的输出。</p></blockquote><p>可以使用<code>log.New()</code>实现自定义logger来自定义输出，函数有下面三个参数</p><ul><li>out：任何实现io.Writer接口的类型，它是日志输出的目的地</li><li>prefix：这个字符串将附在每条日志的开头</li><li>flag：常量集合，允许定义日志的属性，比如提供输出日志的文件名、行号、日期和时间</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;log&quot;</span><br>    <span class="hljs-string">&quot;os&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> (<br>    WarningLogger *log.Logger<br>    InfoLogger    *log.Logger<br>    ErrorLogger   *log.Logger<br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>    file, err := os.OpenFile(<span class="hljs-string">&quot;logs.txt&quot;</span>, os.O_APPEND|os.O_CREATE|os.O_WRONLY, <span class="hljs-number">0666</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br><br>    InfoLogger = log.New(file, <span class="hljs-string">&quot;INFO: &quot;</span>, log.Ldate|log.Ltime|log.Lshortfile)<br>    WarningLogger = log.New(file, <span class="hljs-string">&quot;WARNING: &quot;</span>, log.Ldate|log.Ltime|log.Lshortfile)<br>    ErrorLogger = log.New(file, <span class="hljs-string">&quot;ERROR: &quot;</span>, log.Ldate|log.Ltime|log.Lshortfile)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    InfoLogger.Println(<span class="hljs-string">&quot;Starting the application...&quot;</span>)<br>    InfoLogger.Println(<span class="hljs-string">&quot;Something noteworthy happened&quot;</span>)<br>    WarningLogger.Println(<span class="hljs-string">&quot;There is something you should know about&quot;</span>)<br>    ErrorLogger.Println(<span class="hljs-string">&quot;Something went wrong&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// INFO: 2020/07/09 12:20:53 main.go:26: Starting the application...</span><br><span class="hljs-comment">// INFO: 2020/07/09 12:20:53 main.go:27: Something noteworthy happened</span><br><span class="hljs-comment">// WARNING: 2020/07/09 12:20:53 12:01:06 main.go:28: There is something you should know about</span><br><span class="hljs-comment">// ERROR: 2020/07/09 12:20:53 main.go:29: Something went wrong</span><br></code></pre></td></tr></table></figure><h3 id="logrus三方模块"><a href="#logrus三方模块" class="headerlink" title="logrus三方模块"></a>logrus三方模块</h3><p>两个常见的日志框架是logrus和glog。后者到目前作者已没有再进行维护，这里我们介绍logrus使用，很多流行的项目都有使用，比如大名鼎鼎的Docker。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">go get &quot;github.com/Sirupsen/logrus&quot;<br></code></pre></td></tr></table></figure><p>logrus和标准的log包是完全兼容的，可以用logrus完全替代log，logrus的使用也是非常的简单。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  log <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    log.Println(<span class="hljs-string">&quot;Content from logrus package!&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>通过在logger中设置日志级别，可以根据环境输出日志项（Debug、Info、Warn、Error、Fatal、Panic），默认为Info级别</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">log.SetLevel(log.DebugLevel)<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br>    log <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    log.SetFormatter(&amp;log.JSONFormatter&#123;&#125;)<br><br>    log.Debug(<span class="hljs-string">&quot;Useful debugging information.&quot;</span>)<br>    log.Info(<span class="hljs-string">&quot;Something noteworthy happened!&quot;</span>)<br>    log.Warn(<span class="hljs-string">&quot;You should probably take a look at this.&quot;</span>)<br>    log.Error(<span class="hljs-string">&quot;Something failed but I&#x27;m not quitting.&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>还可以设置输出Json格式的日志，有时候提供为分析服务使用非常的方便</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br>    log <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    log.SetFormatter(&amp;log.JSONFormatter&#123;&#125;)<br>    log.Info(<span class="hljs-string">&quot;Something noteworthy happened!&quot;</span>)<br>&#125;<br><span class="hljs-comment">// &#123;&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;Something noteworthy happened!&quot;,&quot;time&quot;:&quot;2019-12-09T16:18:21+01:00&quot;&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>log</tag>
      
      <tag>日志</tag>
      
      <tag>logrus</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言之变量逃逸分析</title>
    <link href="/Myblog/2021/07/30/Go%E8%AF%AD%E8%A8%80%E4%B9%8B%E5%8F%98%E9%87%8F%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"/>
    <url>/Myblog/2021/07/30/Go%E8%AF%AD%E8%A8%80%E4%B9%8B%E5%8F%98%E9%87%8F%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h3 id="为什么要逃逸分析"><a href="#为什么要逃逸分析" class="headerlink" title="为什么要逃逸分析"></a>为什么要逃逸分析</h3><p>首先我们需要知道，逃逸分析的概念：自动决定变量分配方式，提高运行效率。</p><p>写过C/C++的同学都知道，调用著名的malloc和new函数可以在堆上分配一块内存，这块内存的使用和销毁的责任都在程序员。一不小心，就会发生内存泄露，搞得胆战心惊。</p><p>切换到Golang后，基本不会担心内存泄露了。虽然也有new函数，但是使用new函数得到的内存不一定就在堆上。堆和栈的区别对程序员“模糊化”了，当然这一切都是Go编译器在背后帮我们完成的。</p><p><strong>栈和堆相比，栈的分配和回收速度非常快，分配内存只需要两个CPU指令：“PUSH”和“RELEASE”(分配和释放)就可以完成；堆适合不可预知大小的内存分配，并且分配速度较慢，容易形成内存碎片，垃圾回收需要gc来处理。</strong></p><p>编译器通过<code>逃逸分析</code>来决定一个变量是在栈上分配，还是在堆上分配。通过逃逸分析，可以尽量把那些不需要分配到堆上的变量直接分配到栈上，堆上的变量少了，会减轻分配堆内存的开销，同时也会减少gc的压力，提高程序的运行速度。</p><p>Go语言的设计者不希望开发者将精力放在内存应该分配在栈还是堆的问题上，编译器会自动帮助开发者完成这个纠结的选择，但变量逃逸分析也是需要了解的一个编译器技术，这个技术不仅用于Go语言，在 Java 等语言的编译器优化上也使用了类似的技术。</p><h3 id="什么情况会逃逸分析"><a href="#什么情况会逃逸分析" class="headerlink" title="什么情况会逃逸分析"></a>什么情况会逃逸分析</h3><p>Go逃逸分析最基本的原则是：如果一个函数返回对一个变量的引用，那么它就会发生逃逸。</p><p>简单来说，编译器会分析代码的特征和代码生命周期，Go中的变量只有在编译器可以证明在函数返回后不会再被引用的，才分配到栈上，其他情况下都是分配到堆上。</p><p>简单来说，编译器会根据变量是否被外部引用来决定是否逃逸：</p><ol><li>如果函数外部没有引用，则优先放到栈中 (如果需要申请的内存过大，超过了栈的存储能力，也会放在堆中)；</li><li>如果函数外部存在引用，则必定放到堆中；</li></ol><p>大概存在3种情况会发生逃逸：</p><ol><li>在某个函数中new或字面量创建出的变量，将其指针作为函数返回值，则该变量一定发生逃逸（构造函数返回的指针变量一定逃逸）</li><li>被已经逃逸的变量引用的指针，一定发生逃逸；</li><li>被指针类型的slice、map和chan引用的指针，一定发生逃逸；</li></ol><h3 id="逃逸分析实例"><a href="#逃逸分析实例" class="headerlink" title="逃逸分析实例"></a>逃逸分析实例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span> *<span class="hljs-title">int</span></span> &#123;<br>    t := <span class="hljs-number">3</span><br>    <span class="hljs-keyword">return</span> &amp;t<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    x := foo()<br>    fmt.Println(*x)<br>&#125;<br></code></pre></td></tr></table></figure><p>使用如下命令运行可以查看变量逃逸情况</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> run -gcflags <span class="hljs-string">&quot;-m -l&quot;</span> main.<span class="hljs-keyword">go</span><br><br># command-line-arguments<br>src/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">6</span>:<span class="hljs-number">2</span>: moved to heap: t<br>src/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">12</span>:<span class="hljs-number">13</span>: ... argument does not escape<br>src/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">12</span>:<span class="hljs-number">14</span>: *x escapes to heap<br></code></pre></td></tr></table></figure><blockquote><ul><li><p>使用 go run 运行程序时，<code>-gcflags</code> 参数是编译参数。其中 <code>-m</code> 表示进行内存分配分析，<code>-l</code> 表示避免程序内联，也就是避免进行程序优化。</p></li><li><p>下面两种显示都表示发生逃逸，当xxx变量为值类型时，为第一种，当xxx变量类型为指针时，出现第二种。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">moved to heap:xxx<br>xxx escapes to heap<br></code></pre></td></tr></table></figure></li><li><p>foo函数里的变量<code>t</code>逃逸了，和我们预想的一致。让我们不解的是为什么main函数里的<code>x</code>也逃逸了？这是因为有些函数参数为interface类型，比如fmt.Println(a …interface{})，编译期间很难确定其参数的具体类型，也会发生逃逸。</p></li></ul></blockquote><p>不要盲目使用变量的指针作为函数参数，虽然它会减少复制操作。但其实当参数为变量自身的时候，复制是在栈上完成的操作，开销远比变量逃逸后动态地在堆上分配内存少的多。</p><p>最后，尽量写出少一些逃逸的代码，提升程序的运行效率。</p><p>参考文章：</p><ul><li><a href="https://zhuanlan.zhihu.com/p/91559562">golang 逃逸分析详解</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>逃逸分析</tag>
      
      <tag>变量逃逸</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言的值传递和指针传递</title>
    <link href="/Myblog/2021/07/29/Go%E8%AF%AD%E8%A8%80%E7%9A%84%E5%80%BC%E4%BC%A0%E9%80%92%E5%92%8C%E6%8C%87%E9%92%88%E4%BC%A0%E9%80%92/"/>
    <url>/Myblog/2021/07/29/Go%E8%AF%AD%E8%A8%80%E7%9A%84%E5%80%BC%E4%BC%A0%E9%80%92%E5%92%8C%E6%8C%87%E9%92%88%E4%BC%A0%E9%80%92/</url>
    
    <content type="html"><![CDATA[<p>Go允许通过指针（有时称为引用）和值来传递参数。在这篇文章中，我们将比较两种方法，特别注意可能影响选择的不同情境。</p><h3 id="参数类型"><a href="#参数类型" class="headerlink" title="参数类型"></a>参数类型</h3><p>在了解参数传递类型之前，我们需要先了解go中的值类型和引用类型</p><h4 id="值类型"><a href="#值类型" class="headerlink" title="值类型"></a>值类型</h4><p>值类型有: <code>int、float、bool、array、struct</code>等。</p><p>值传递是指在调用函数时将实际参数复制一份传递到函数中，这样在函数中如果对参数进行修改，将不会影响到实际参数。声明一个值类型变量时，编译器会在栈中分配一个空间，空间里存储的就是该变量的值　</p><h4 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h4><p>引用类型有：<code>slice，map，channel，interface，func，string</code>等。</p><p>所谓引用传递是指在调用函数时将实际参数的地址传递到函数中，那么在函数中对参数所进行的修改，将影响到实际参数。声明一个引用类型的变量，编译器会把实例的内存分配在堆上</p><p>string和其他语言一样，是引用类型，string的底层实现<code>struct String &#123; byte* str; intgo len; &#125;;</code> 但是因为string不允许修改，每次操作string只能生成新的对象，所以在看起来使用时像值类型。</p><h3 id="传递类型"><a href="#传递类型" class="headerlink" title="传递类型"></a>传递类型</h3><p><strong>值类型数据会使用值传递方式，引用类型参数会使用指针传递方式。但是严格地说，go方法或函数只有一种传递方式，那就是<code>值传递</code>！指针传递只是创建了指向同一内存地址的指针的副本。</strong></p><h4 id="值传递"><a href="#值传递" class="headerlink" title="值传递"></a>值传递</h4><p>值传递会创建一个新的变量副本并将其传递给所调用的函数或方法，副本和原始变量分配在不同的内存地址。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;  <br>    firstName <span class="hljs-keyword">string</span><br>    lastName  <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">changeName</span><span class="hljs-params">(p Person)</span></span> &#123;  <br>    p.firstName = <span class="hljs-string">&quot;Bob&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;  <br>    person := Person &#123;<br>        firstName: <span class="hljs-string">&quot;Alice&quot;</span>,<br>        lastName: <span class="hljs-string">&quot;Dow&quot;</span>,<br>    &#125;<br><br>    changeName(person)<br><br>    fmt.Println(person)<br>&#125;<br><span class="hljs-comment">// &#123;Alice Dow&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>请注意，即使函数changeName将firstName更改为Bob，但更改不会影响main函数中的变量person。发生这种情况是因为函数changeName修改了变量person的一个副本，而不是person本身。</p></blockquote><h4 id="指针传递"><a href="#指针传递" class="headerlink" title="指针传递"></a>指针传递</h4><p>在指针传递变量的情况下，将创建指向相同内存地址的新副本</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;  <br>    firstName <span class="hljs-keyword">string</span><br>    lastName  <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">changeName</span><span class="hljs-params">(p *Person)</span></span> &#123;  <br>    p.firstName = <span class="hljs-string">&quot;Bob&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;  <br>    person := Person &#123;<br>        firstName: <span class="hljs-string">&quot;Alice&quot;</span>,<br>        lastName: <span class="hljs-string">&quot;Dow&quot;</span>,<br>    &#125;<br><br>    changeName(&amp;person)<br><br>    fmt.Println(person)<br>&#125;<br><span class="hljs-comment">// &#123;Bob Dow&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>在这种情况下，函数main中的变量person在函数changeName中被修改。</p><p>发生这种情况是因为<code>＆person</code>和<code>p</code>是存储在相同内存地址的相同结构的两个不同指针。</p></blockquote><h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><ul><li><p>变量不能修改</p><p>这种情况，我们没有其他的选择，只能通过值传递。所以这个变量不能在下游修改。反之亦然，如果变量被期望修改，它必须通过指针传递。</p></li><li><p>变量结构较大</p><p>如果变量是一个较大的结构，性能是一个问题，最好是通过指针传递变量。这样可以避免在内存中复制整个结构。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>值传递</tag>
      
      <tag>引用传递</tag>
      
      <tag>指针传递</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言之GMP模型</title>
    <link href="/Myblog/2021/07/22/Go%E8%AF%AD%E8%A8%80%E4%B9%8BGMP%E6%A8%A1%E5%9E%8B/"/>
    <url>/Myblog/2021/07/22/Go%E8%AF%AD%E8%A8%80%E4%B9%8BGMP%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h3 id="GMP模型"><a href="#GMP模型" class="headerlink" title="GMP模型"></a>GMP模型</h3><p>Go语言虽然使用一个Go关键字即可实现并发，但Goroutine被调度到后端之后，具体的实现却比较复杂。这里我们就要介绍一下Go调度器之GMP模型。</p><ul><li><code>G</code></li></ul><p>G代表一个Goroutine对象，每次go调用的时候，都会创建一个G对象，它包括栈、指令指针以及对于调用goroutines很重要的其它信息。其中包括执行的函数指令及参数；G保存的任务对象；线程上下文切换，现场保护和现场恢复需要的寄存器(SP、IP)等信息。</p><ul><li><code>M</code></li></ul><p>M是一个线程Machine，所有M是有线程栈的。如果不对该线程栈提供内存的话，系统会给该线程栈提供内存(不同操作系统提供的线程栈大小不同)。当指定了线程栈，则M.stack→G.stack，M的PC寄存器指向G提供的函数，然后去执行。所有的G任务，最终还是在M上执行。</p><ul><li><code>P</code></li></ul><p>P是Processor处理器，并不是真正的物理CPU。所以当P有任务时需要创建或者唤醒一个系统线程来执行它队列里的任务。所以P/M需要进行绑定，构成一个执行单元。由P来调度G在M上的运行，P的个数就是GOMAXPROCS（最大256），启动时固定的，一般不修改；M的个数和P的个数不一定一样多（会有休眠的M或者不需要太多的M）（最大10000）；每一个P保存着本地G任务队列，也有一个全局G任务队列</p><p>P决定了同时可以并发任务的数量，可通过GOMAXPROCS限制同时执行用户级任务的操作系统线程。可以通过runtime.GOMAXPROCS进行指定。在Go1.5之后GOMAXPROCS被默认设置可用的核数，而之前则默认为1。</p><h3 id="调度过程"><a href="#调度过程" class="headerlink" title="调度过程"></a>调度过程</h3><p>首先创建一个G对象，G对象保存到P本地队列或者是全局队列。P此时去唤醒一个M。P继续执行它的执行序。M寻找是否有空闲的P，如果有则将该G对象移动到它本身。接下来M执行一个调度循环(调用G对象-&gt;执行-&gt;清理线程→继续找新的Goroutine执行)。</p><p>M执行过程中，随时会发生上下文切换。当发生上线文切换时，需要对执行现场进行保护，以便下次被调度执行时进行现场恢复。Go调度器M的栈保存在G对象上，只需要将M所需要的寄存器(SP、PC等)保存到G对象上就可以实现现场保护。当这些寄存器数据被保护起来，就随时可以做上下文切换了，在中断之前把现场保存起来。如果此时G任务还没有执行完，M可以将任务重新丢到P的任务队列，等待下一次被调度执行。当再次被调度执行时，M通过访问G的vdsoSP、vdsoPC寄存器进行现场恢复(从上次中断位置继续执行)。</p><p><img src="https://stellae.gitee.io/myblog/images/images/a4vWtvRWGQ.jpeg!large" alt="go func()调度流程"></p><p>从上图我们可以分析出几个结论：</p><p> 1、我们通过 go func () 来创建一个 goroutine；</p><p> 2、有两个存储 G 的队列，一个是局部调度器 P 的本地队列、一个是全局 G 队列。新创建的 G 会先保存在 P 的本地队列中，如果 P 的本地队列已经满了就会保存在全局的队列中；</p><p> 3、G 只能运行在 M 中，一个 M 必须持有一个 P，M 与 P 是 1：1 的关系。M 会从 P 的本地队列弹出一个可执行状态的 G 来执行，如果 P 的本地队列为空，就会想其他的 MP 组合偷取一个可执行的 G 来执行；</p><p> 4、一个 M 调度 G 执行的过程是一个循环机制；</p><p> 5、当 M 执行某一个 G 时候如果发生了 syscall 或则其余阻塞操作，M 会阻塞，如果当前有一些 G 在执行，runtime 会把这个线程 M 从 P 中摘除 (detach)，然后再创建一个新的操作系统的线程 (如果有空闲的线程可用就复用空闲线程) 来服务于这个 P；</p><p> 6、当 M 系统调用结束时候，这个 G 会尝试获取一个空闲的 P 执行，并放入到这个 P 的本地队列。如果获取不到 P，那么这个线程 M 变成休眠状态， 加入到空闲线程中，然后这个 G 会被放入全局队列中。</p><h3 id="调度生命周期"><a href="#调度生命周期" class="headerlink" title="调度生命周期"></a>调度生命周期</h3><p><img src="https://stellae.gitee.io/myblog/images/images/j37FX8nek9.png!large"></p><p>特殊的 M0 和 G0</p><p>M0 是启动程序后的编号为 0 的主线程，这个 M 对应的实例会在全局变量 runtime.m0 中，不需要在 heap 上分配，M0 负责执行初始化操作和启动第一个 G， 在之后 M0 就和其他的 M 一样了。</p><p>G0 是每次启动一个 M 都会第一个创建的 gourtine，G0 仅用于负责调度的 G，G0 不指向任何可执行的函数，每个 M 都会有一个自己的 G0。在调度或系统调用时会使用 G0 的栈空间，全局变量的 G0 是 M0 的 G0。</p><p>总结：</p><p>相比大多数并行设计模型，Go比较优势的设计就是P上下文这个概念的出现，如果只有G和M的对应关系，那么当G阻塞在IO上的时候，M是没有实际在工作的，这样造成了资源的浪费，没有了P，那么所有G的列表都放在全局，这样导致临界区太大，对多核调度造成极大影响。</p><p>而goroutine在使用上面的特点，感觉既可以用来做密集的多核计算，又可以做高并发的IO应用，做IO应用的时候，写起来感觉和对程序员最友好的同步阻塞一样，而实际上由于runtime的调度，底层是以同步非阻塞的方式在运行（即IO多路复用）。</p><p>所以说保护现场的抢占式调度和G被阻塞后传递给其他m调用的核心思想，使得goroutine的产生。</p><p>参考文章：</p><ul><li><a href="https://learnku.com/articles/41728">典藏版 Golang 调度器 GMP 原理与调度全分析</a></li><li><a href="https://segmentfault.com/a/1190000039773754">Go 群友提问：Goroutine 数量控制在多少合适，会影响 GC 和调度？</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>gmp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言垃圾回收机制</title>
    <link href="/Myblog/2021/07/21/Go%E8%AF%AD%E8%A8%80%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/"/>
    <url>/Myblog/2021/07/21/Go%E8%AF%AD%E8%A8%80%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<p>垃圾回收(Garbage Collection，简称GC)是编程语言中提供的内存管理功能。</p><p>在传统的系统级编程语言（主要指C/C++）中，程序员定义了一个变量，就是在内存中开辟了一段相应的空间来存值。由于内存是有限的，所以当程序不再需要使用某个变量的时候，就需要销毁该对象并释放其所占用的内存资源，好重新利用这段空间。在C/C++中，释放无用变量内存空间的事情需要由程序员自己来处理。就是说当程序员认为变量没用了，就手动地释放其占用的内存。但是这样显然非常繁琐，如果有所遗漏，就可能造成资源浪费甚至<a href="https://link.segmentfault.com/?url=https://baike.baidu.com/item/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2">内存泄露</a>。当软件系统比较复杂，变量多的时候程序员往往就忘记<a href="https://link.segmentfault.com/?url=https://baike.baidu.com/item/%E9%87%8A%E6%94%BE%E5%86%85%E5%AD%98/10736171">释放内存</a>或者在不该释放的时候释放内存了。这对于程序开发人员是一个比较头痛的问题。</p><p>为了解决这个问题，后来开发出来的几乎所有新语言（java，python，php等等）都引入了语言层面的自动内存管理 – 也就是语言的使用者只用关注内存的申请而不必关心内存的释放，内存释放由虚拟机（virtual machine）或运行时（runtime）来自动进行管理。而这种对不再使用的内存资源进行自动回收的功能就被称为垃圾回收。</p><h3 id="常见的垃圾回收方法"><a href="#常见的垃圾回收方法" class="headerlink" title="常见的垃圾回收方法"></a>常见的垃圾回收方法</h3><h4 id="引用计数（reference-counting）"><a href="#引用计数（reference-counting）" class="headerlink" title="引用计数（reference counting）"></a>引用计数（reference counting）</h4><p>引用计数通过在对象上增加自己被引用的次数，被其他对象引用时加1，引用自己的对象被回收时减1，引用数为0的对象即为可以被回收的对象。这种算法在内存比较紧张和实时性比较高的系统中使用的比较广泛，如ios cocoa框架，php，python等。</p><p>优点：</p><p>1、方式简单，回收速度快。</p><p>缺点：</p><p>1、需要额外的空间存放计数。</p><p>2、无法处理循环引用（如a.b=b;b.a=a这种情况）。</p><p>3、频繁更新引用计数降低了性能。</p><h4 id="标记-清除（mark-and-sweep）"><a href="#标记-清除（mark-and-sweep）" class="headerlink" title="标记-清除（mark and sweep）"></a>标记-清除（mark and sweep）</h4><p>该方法分为两步，标记从根变量开始迭代得遍历所有被引用的对象，对能够通过应用遍历访问到的对象都进行标记为“被引用”；标记完成后进行清除操作，对没有标记过的内存进行回收（回收同时可能伴有碎片整理操作）。</p><p>这种方法解决了引用计数的不足，但是也有比较明显的问题：每次启动垃圾回收都会暂停当前所有的正常代码执行，回收是系统响应能力大大降低！当然后续也出现了很多<code>mark&amp;sweep算法</code>的变种（如三色标记法）优化了这个问题。</p><h4 id="三色标记法"><a href="#三色标记法" class="headerlink" title="三色标记法"></a>三色标记法</h4><p>三色标记算法是对<code>mark&amp;sweep算法</code>中标记阶段的改进，原理如下：</p><ol><li>起初所有对象都是白色。</li><li>从根出发扫描所有可达对象，标记为灰色，放入待处理队列。</li><li>从队列取出灰色对象，将其引用对象标记为灰色放入队列，自身标记为黑色。</li><li>重复 3，直到灰色对象队列为空。此时白色对象即为垃圾，进行回收。</li></ol><p>可视化如下：</p><p><img src="https://stellae.gitee.io/myblog/images/images/2732449449-5c66324354fa8.gif" alt="三色标记法"></p><p>根对象：</p><ol><li><p>全局变量：程序在编译期间就能够确定的那些存在于程序整个生命周期的变量。</p></li><li><p>执行栈：每个goroutine都包含自己的执行栈，这些执行栈上包含栈上的变量以及指向分配的堆内存区块的指针。</p></li><li><p>寄存器：寄存器的值可能表示一个指针，参与计算的这些指针可能指向某些赋值器分配的堆内存区块。</p></li></ol><p>三色标记的一个明显好处是能够让用户程序和 mark 并发的进行，具体可以参考论文：《On-the-fly garbage collection: an exercise in cooperation.》，Golang 的 GC 实现也是基于这篇论文。</p><h4 id="复制收集"><a href="#复制收集" class="headerlink" title="复制收集"></a>复制收集</h4><p>复制收集的方式只需要对对象进行一次扫描。准备一个「新的空间」，从根开始，对对象进行扫，如果存在对这个对象的引用，就把它复制到「新空间中」。一次扫描结束之后，所有存在于「新空间」的对象就是所有的非垃圾对象。</p><p>这两种方式各有千秋，标记清除的方式节省内存但是两次扫描需要更多的时间，对于垃圾比例较小的情况占优势。复制收集更快速但是需要额外开辟一块用来复制的内存，对垃圾比例较大的情况占优势。特别的，复制收集有「局部性」的优点。</p><p>在复制收集的过程中，会按照对象被引用的顺序将对象复制到新空间中。于是，关系较近的对象被放在距离较近的内存空间的可能性会提高，这叫做局部性。局部性高的情况下，内存缓存会更有效地运作，程序的性能会提高。</p><p>对于标记清除，有一种标记-压缩算法的衍生算法：</p><p>对于压缩阶段，它的工作就是移动所有的可达对象到堆内存的同一个区域中，使他们紧凑的排列在一起，从而将所有非可达对象释放出来的空闲内存都集中在一起，通过这样的方式来达到减少内存碎片的目的。</p><h4 id="分代收集（generation）"><a href="#分代收集（generation）" class="headerlink" title="分代收集（generation）"></a>分代收集（generation）</h4><p>这种收集方式用了程序的一种特性：大部分对象会从产生开始在很短的时间内变成垃圾，而存在的很长时间的对象往往都有较长的生命周期。</p><p>根据对象的存活周期不同将内存划分为新生代和老年代，存活周期短的为新生代，存活周期长的为老年代。这样就可以根据每块内存的特点采用最适当的收集算法。</p><p>新创建的对象存放在称为 新生代（young generation）中（一般来说，新生代的大小会比 老年代小很多）。高频对新生成的对象进行回收，称为「小回收」，低频对所有对象回收，称为「大回收」。每一次「小回收」过后，就把存活下来的对象归为老年代，「小回收」的时候，遇到老年代直接跳过。大多数分代回收算法都采用的「复制收集」方法，因为小回收中垃圾的比例较大。</p><p>这种方式存在一个问题：如果在某个新生代的对象中，存在「老生代」的对象对它的引用，它就不是垃圾了，那么怎么制止「小回收」对其回收呢？这里用到了一中叫做写屏障的方式。</p><p>程序对所有涉及修改对象内容的地方进行保护，被称为「写屏障」（Write Barrier）。写屏障不仅用于分代收集，也用于其他GC算法中。</p><p>在此算法的表现是，用一个记录集来记录从新生代到老生代的引用。如果有两个对象A和B，当对A的对象内容进行修改并加入B的引用时，如果①A是「老生代」②B是「新生代」。则将这个引用加入到记录集中。「小回收」的时候，因为记录集中有对B的引用，所以B不再是垃圾。</p><h3 id="Go垃圾回收机制历史"><a href="#Go垃圾回收机制历史" class="headerlink" title="Go垃圾回收机制历史"></a>Go垃圾回收机制历史</h3><p>go语言垃圾回收总体采用的是经典的mark and sweep算法。</p><ul><li><p>v1.3以前版本 STW（Stop The World）</p><p>golang的垃圾回收算法都非常简陋，然后其性能也广被诟病:go runtime在一定条件下（内存超过阈值或定期如2min），暂停所有任务的执行，进行mark&amp;sweep操作，操作完成后启动所有任务的执行。在内存使用较多的场景下，go程序在进行垃圾回收时会发生非常明显的卡顿现象（Stop The World）。在对响应速度要求较高的后台服务进程中，这种延迟简直是不能忍受的！这个时期国内外很多在生产环境实践go语言的团队都或多或少踩过gc的坑。当时解决这个问题比较常用的方法是尽快控制自动分配内存的内存数量以减少gc负荷，同时采用手动管理内存的方法处理需要大量及高频分配内存的场景。</p></li><li><p>v1.3 Mark STW, Sweep 并行</p><p>1.3版本中，go runtime分离了mark和sweep操作，和以前一样，也是先暂停所有任务执行并启动mark，mark完成后马上就重新启动被暂停的任务了，而是让sweep任务和普通协程任务一样并行的和其他任务一起执行。如果运行在多核处理器上，go会试图将gc任务放到单独的核心上运行而尽量不影响业务代码的执行。go team自己的说法是减少了50%-70%的暂停时间。</p></li><li><p>v1.5 三色标记法</p><p>go 1.5正在实现的垃圾回收器是“非分代的、非移动的、并发的、三色的标记清除垃圾收集器”。引入了上文介绍的三色标记法，这种方法的mark操作是可以渐进执行的而不需每次都扫描整个内存空间，可以减少stop the world的时间。 由此可以看到，一路走来直到1.5版本，go的垃圾回收性能也是一直在提升，但是相对成熟的垃圾回收系统（如java jvm和javascript v8），go需要优化的路径还很长（但是相信未来一定是美好的~）。</p></li><li><p>v1.8 混合写屏障（hybrid write barrier）</p><p>这个版本的 GC 代码相比之前改动还是挺大的，采用一种混合的 write barrier 方式 （Yuasa-style deletion write barrier [Yuasa ‘90] 和 Dijkstra-style insertion write barrier [Dijkstra ‘78]）来避免 堆栈重新扫描。</p><p>混合屏障的优势在于它允许堆栈扫描永久地使堆栈变黑（没有STW并且没有写入堆栈的障碍），这完全消除了堆栈重新扫描的需要，从而消除了对堆栈屏障的需求。重新扫描列表。特别是堆栈障碍在整个运行时引入了显着的复杂性，并且干扰了来自外部工具（如GDB和基于内核的分析器）的堆栈遍历。</p><p>此外，与Dijkstra风格的写屏障一样，混合屏障不需要读屏障，因此指针读取是常规的内存读取; 它确保了进步，因为物体单调地从白色到灰色再到黑色。</p><p>混合屏障的缺点很小。它可能会导致更多的浮动垃圾，因为它会在标记阶段的任何时刻保留从根（堆栈除外）可到达的所有内容。然而，在实践中，当前的Dijkstra障碍可能几乎保留不变。混合屏障还禁止某些优化：特别是，如果Go编译器可以静态地显示指针是nil，则Go编译器当前省略写屏障，但是在这种情况下混合屏障需要写屏障。这可能会略微增加二进制大小。</p></li></ul><p>通过go team多年对gc的不断改进和忧化，GC的卡顿问题在1.8 版本基本上可以做到 1 毫秒以下的 GC 级别。 实际上，gc低延迟是有代价的，其中最大的是吞吐量的下降。由于需要实现并行处理，线程间同步和多余的数据生成复制都会占用实际逻辑业务代码运行的时间。GHC的全局停止GC对于实现高吞吐量来说是十分合适的，而Go则更擅长与低延迟。<br>并行GC的第二个代价是不可预测的堆空间扩大。程序在GC的运行期间仍能不断分配任意大小的堆空间，因此我们需要在到达最大的堆空间之前实行一次GC，但是过早实行GC会造成不必要的GC扫描，这也是需要衡量利弊的。因此在使用Go时，需要自行保证程序有足够的内存空间。</p><p>垃圾收集是一个难题，没有所谓十全十美的方案，通常是为了适应应用场景做出的一种取舍。</p><p>相信GO未来会更好。</p>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>垃圾回收</tag>
      
      <tag>三色标记法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言Context上下文管理</title>
    <link href="/Myblog/2021/07/20/Go%E8%AF%AD%E8%A8%80Context%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86/"/>
    <url>/Myblog/2021/07/20/Go%E8%AF%AD%E8%A8%80Context%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>context在Go1.7之后就进入标准库中了。它主要的用处如果用一句话来说，是在于控制goroutine的生命周期。</p><p>在 Go http 包的 Server 中，每一个请求在都有一个对应的<code>goroutine</code>去处理。请求处理函数通常会启动额外的<code>goroutine</code>用来访问后端服务，比如数据库和 RPC 服务。用来处理一个请求的<code>goroutine</code>通常需要访问一些与请求特定的数据，比如终端用户的身份认证信息、验证相关的 token、请求的截止时间。当一个请求被取消或超时时，所有用来处理该请求的<code>goroutine</code>都应该迅速退出，然后系统才能释放这些<code>goroutine</code>占用的资源</p><p>Context有四种结构和方法：</p><p><code>CancelContext</code> / <code>TimeoutContext</code> / <code>DeadLineContext</code> / <code>ValueContext </code></p><p> <code>WithCancel</code> / <code>WithTimeout</code> / <code>WithDeadline</code> / <code>WithValue</code></p><p>Context 的调用应该是链式的，通过<code>WithXXX</code>派生出新的 Context 和 CancelFunc。当父 Context 被取消时，其派生的所有 Context 都将取消。调用 CancelFunc 将取消子代，移除父代对子代的引用，并且停止所有定时器。未能调用 CancelFunc 将泄漏子代，直到父代被取消或定时器触发。<code>go vet</code>工具检查所有流程控制路径上使用 CancelFuncs。</p><h3 id="模拟实例"><a href="#模拟实例" class="headerlink" title="模拟实例"></a>模拟实例</h3><h4 id="取消执行"><a href="#取消执行" class="headerlink" title="取消执行"></a>取消执行</h4><p>示例：演示使用一个可取消的上下文，以防止 goroutine 泄漏。示例函数结束时，defer 调用 cancel 方法，gen goroutine 将返回而不泄漏。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// gen generates integers in a separate goroutine and</span><br><span class="hljs-comment">// sends them to the returned channel.</span><br><span class="hljs-comment">// The callers of gen need to cancel the context once</span><br><span class="hljs-comment">// they are done consuming generated integers not to leak</span><br><span class="hljs-comment">// the internal goroutine started by gen.</span><br>gen := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;<br>dst := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)<br>n := <span class="hljs-number">1</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// returning not to leak the goroutine</span><br><span class="hljs-keyword">case</span> dst &lt;- n:<br>n++<br>&#125;<br>&#125;<br>&#125;()<br><span class="hljs-keyword">return</span> dst<br>&#125;<br><br>ctx, cancel := context.WithCancel(context.Background())<br><span class="hljs-keyword">defer</span> cancel() <span class="hljs-comment">// cancel when we are finished consuming integers</span><br><br><span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> gen(ctx) &#123;<br>fmt.Println(n)<br><span class="hljs-keyword">if</span> n == <span class="hljs-number">10</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="超时请求"><a href="#超时请求" class="headerlink" title="超时请求"></a>超时请求</h4><p>我们发送RPC请求的时候，往往希望对这个请求进行一个超时的限制。当一个RPC请求超过10s的请求，自动断开。当然我们使用CancelContext，也能实现这个功能（开启一个新的goroutine，这个goroutine拿着cancel函数，当时间到了，就调用cancel函数）。</p><p>鉴于这个需求是非常常见的，context包也实现了这个需求：timerCtx。具体实例化的方法是 WithDeadline 和 WithTimeout。</p><p>具体的timerCtx里面的逻辑也就是通过time.AfterFunc来调用ctx.cancel的。</p><ul><li><code>WithTimeOut</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// Pass a context with a timeout to tell a blocking function that it</span><br>    <span class="hljs-comment">// should abandon its work after the timeout elapses.</span><br>    ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">50</span>*time.Millisecond)<br>    <span class="hljs-keyword">defer</span> cancel()<br><br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Second):<br>        fmt.Println(<span class="hljs-string">&quot;overslept&quot;</span>)<br>    <span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>        fmt.Println(ctx.Err()) <span class="hljs-comment">// prints &quot;context deadline exceeded&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>WithDeadline</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    d := time.Now().Add(<span class="hljs-number">50</span> * time.Millisecond)<br>    ctx, cancel := context.WithDeadline(context.Background(), d)<br><br>    <span class="hljs-comment">// Even though ctx will be expired, it is good practice to call its</span><br>    <span class="hljs-comment">// cancelation function in any case. Failure to do so may keep the</span><br>    <span class="hljs-comment">// context and its parent alive longer than necessary.</span><br>    <span class="hljs-keyword">defer</span> cancel()<br><br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Second):<br>        fmt.Println(<span class="hljs-string">&quot;overslept&quot;</span>)<br>    <span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>        fmt.Println(ctx.Err())<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在http的客户端里面加上timeout也是一个常见的办法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go">uri := <span class="hljs-string">&quot;https://httpbin.org/delay/3&quot;</span><br>req, err := http.NewRequest(<span class="hljs-string">&quot;GET&quot;</span>, uri, <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;http.NewRequest() failed with &#x27;%s&#x27;\n&quot;</span>, err)<br>&#125;<br><br>ctx, _ := context.WithTimeout(context.Background(), time.Millisecond*<span class="hljs-number">100</span>)<br>req = req.WithContext(ctx)<br><br>resp, err := http.DefaultClient.Do(req)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;http.DefaultClient.Do() failed with:\n&#x27;%s&#x27;\n&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> resp.Body.Close()<br></code></pre></td></tr></table></figure><h4 id="传递数据"><a href="#传递数据" class="headerlink" title="传递数据"></a>传递数据</h4><p>context还提供了valueCtx的数据结构，先来看看官方例子。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">type</span> favContextKey <span class="hljs-keyword">string</span><br><br>    f := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, k favContextKey)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> v := ctx.Value(k); v != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(<span class="hljs-string">&quot;found value:&quot;</span>, v)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        fmt.Println(<span class="hljs-string">&quot;key not found:&quot;</span>, k)<br>    &#125;<br><br>    k := favContextKey(<span class="hljs-string">&quot;language&quot;</span>)<br>    ctx := context.WithValue(context.Background(), k, <span class="hljs-string">&quot;Go&quot;</span>)<br><br>    f(ctx, k)<br>    f(ctx, favContextKey(<span class="hljs-string">&quot;color&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>提供的键必须是可比性和应该不是字符串类型或任何其他内置的类型以避免包使用的上下文之间的碰撞。WithValue 用户应该定义自己的键的类型。为了避免分配分配给接口 {} 时，上下文键经常有具体类型结构 {}。另外，导出的上下文关键变量静态类型应该是一个指针或接口。</p></blockquote><p>这个valueCtx最经常使用的场景就是在一个http服务器中，在request中传递一个特定值，比如有一个中间件，做cookie验证，然后把验证后的用户名存放在request中。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;context&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> FooKey <span class="hljs-keyword">string</span><br><br><span class="hljs-keyword">var</span> UserName = FooKey(<span class="hljs-string">&quot;user-name&quot;</span>)<br><span class="hljs-keyword">var</span> UserId = FooKey(<span class="hljs-string">&quot;user-id&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foo</span><span class="hljs-params">(next http.HandlerFunc)</span> <span class="hljs-title">http</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>ctx := context.WithValue(r.Context(), UserId, <span class="hljs-string">&quot;1&quot;</span>)<br>ctx2 := context.WithValue(ctx, UserName, <span class="hljs-string">&quot;yejianfeng&quot;</span>)<br>next(w, r.WithContext(ctx2))<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserName</span><span class="hljs-params">(context context.Context)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">if</span> ret, ok := context.Value(UserName).(<span class="hljs-keyword">string</span>); ok &#123;<br><span class="hljs-keyword">return</span> ret<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserId</span><span class="hljs-params">(context context.Context)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">if</span> ret, ok := context.Value(UserId).(<span class="hljs-keyword">string</span>); ok &#123;<br><span class="hljs-keyword">return</span> ret<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">test</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;welcome: &quot;</span>))<br>w.Write([]<span class="hljs-keyword">byte</span>(GetUserId(r.Context())))<br>w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot; &quot;</span>))<br>w.Write([]<span class="hljs-keyword">byte</span>(GetUserName(r.Context())))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>http.Handle(<span class="hljs-string">&quot;/&quot;</span>, foo(test))<br>http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, <span class="hljs-literal">nil</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>参考文章</p><ul><li><p><a href="https://deepzz.com/post/golang-context-package-notes.html">快速掌握 Golang context 包</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/68792989">深度解读context源码</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>context</tag>
      
      <tag>上下文管理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言sync.WaitGroup用法</title>
    <link href="/Myblog/2021/07/16/Go%E8%AF%AD%E8%A8%80sync-WaitGroup%E7%94%A8%E6%B3%95/"/>
    <url>/Myblog/2021/07/16/Go%E8%AF%AD%E8%A8%80sync-WaitGroup%E7%94%A8%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<p>Go程序中，主线程为了等待goroutine都运行完毕，不得不在程序的末尾使用<code>time.Sleep()</code> 来睡眠一段时间，等待其他线程充分运行。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span> ; i++&#123;<br>        <span class="hljs-keyword">go</span> fmt.Println(i)<br>    &#125;<br>    time.Sleep(time.Second)<br>&#125;<br></code></pre></td></tr></table></figure><p>但是对于实际生活的大多数场景来说，1秒是不够的，并且大部分时候我们都无法预知for循环内代码运行时间的长短。这时候就不能使用<code>time.Sleep()</code> 来完成等待操作了。</p><p>我们可以考虑用<code>channel</code>实现以上效果：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>, <span class="hljs-number">100</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;<br>            fmt.Println(i)<br>            c &lt;- <span class="hljs-literal">true</span><br>        &#125;(i)<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>        &lt;-c<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>但是管道在这里显得有些大材小用，因为它被设计出来不仅仅只是在这里用作简单的同步处理，所以这里使用管道实际上是不合适的。而且假设我们有一万、十万甚至更多的for循环，也要申请同样数量大小的管道出来，对内存也是不小的开销。</p><p>这时候就可以请出我们的主角<code>sync.WaitGroup</code>，它能够更方便的帮助我们达到这个目的。</p><p><strong><code>WaitGroup</code> 对象内部有一个计数器，最初从0开始，它有三个方法：<code>Add(), Done(), Wait()</code> 用来控制计数器的数量。</strong></p><p><strong><code>Add(n)</code> 把计数器设置为<code>n</code> ，<code>Done()</code> 每次把计数器<code>-1</code> ，<code>wait()</code> 会阻塞代码的运行，直到计数器地值减为0。</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    wg := sync.WaitGroup&#123;&#125;<br>    wg.Add(<span class="hljs-number">100</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;<br>            fmt.Println(i)<br>            wg.Done()<br>        &#125;(i)<br>    &#125;<br>    wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>注意事项：</strong></p><ul><li><p>计数器不能为负值 - 我们不能使用<code>Add()</code> 给<code>wg</code> 设置一个负值，否则代码将会报错。</p></li><li><p>函数传递参数<code>WaitGroup</code>对象，必须使用指针。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    wg := sync.WaitGroup&#123;&#125;<br>    wg.Add(<span class="hljs-number">100</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>        <span class="hljs-keyword">go</span> f(i, &amp;wg)<br>    &#125;<br>    wg.Wait()<br>&#125;<br><br><span class="hljs-comment">// 一定要通过指针传值，不然进程会进入死锁状态</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>, wg *sync.WaitGroup)</span></span> &#123; <br>    fmt.Println(i)<br>    wg.Done()<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WaitGroup</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言slice详解</title>
    <link href="/Myblog/2021/07/16/Go%E8%AF%AD%E8%A8%80slice%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2021/07/16/Go%E8%AF%AD%E8%A8%80slice%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="slice介绍"><a href="#slice介绍" class="headerlink" title="slice介绍"></a>slice介绍</h3><p>切片是 Go 中的一种基本的数据结构，使用这种结构可以用来管理数据集合。切片的设计想法是由动态数组概念而来，为了开发者可以更加方便的使一个数据结构可以自动增加和减少。</p><p>Go默认使用值传递，如果把第一个大数组传递给函数会消耗很多内存。这种情况下，我们使用切片就能很好的解决这个问题，切片是引用传递，所以它们不需要使用额外的内存并且比使用数组更有效率。</p><p><strong>切片的结构体由3部分构成：Pointer 是指向一个底层数组的指针，len 代表当前切片的长度，cap 是当前切片的容量，cap 总是大于等于 len</strong></p><p>slice 的数据结构定义如下:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span> &#123;<br>    array unsafe.Pointer<br>    <span class="hljs-built_in">len</span>   <span class="hljs-keyword">int</span><br>    <span class="hljs-built_in">cap</span>   <span class="hljs-keyword">int</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="slice创建和初始化"><a href="#slice创建和初始化" class="headerlink" title="slice创建和初始化"></a>slice创建和初始化</h3><h4 id="通过make函数创建切片"><a href="#通过make函数创建切片" class="headerlink" title="通过make函数创建切片"></a>通过make函数创建切片</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">a := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">1</span>)       <span class="hljs-comment">// [0]   len 1   cap 1</span><br>b := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">4</span>, <span class="hljs-number">10</span>)   <span class="hljs-comment">// [0, 0, 0, 0]   len 4 cap 10</span><br></code></pre></td></tr></table></figure><blockquote><p>通过<code>make()</code>函数创建的切片，已经由系统初始化了内存，切片中的元素初始值为对应类型的零值，注意切片本身的值<code>!= nil</code></p></blockquote><h4 id="通过字面量创建切片"><a href="#通过字面量创建切片" class="headerlink" title="通过字面量创建切片"></a>通过字面量创建切片</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> a []<span class="hljs-keyword">int</span>   <span class="hljs-comment">// nil   len 0 cap 0</span><br><span class="hljs-keyword">var</span> a []<span class="hljs-keyword">int</span> = []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>&#125;   <span class="hljs-comment">// len 4 cap 4</span><br>b := a[:<span class="hljs-number">3</span>]   <span class="hljs-comment">// [1,2,3]  // len 3 cap 5</span><br>c := a[:<span class="hljs-number">3</span>:<span class="hljs-number">4</span>] <span class="hljs-comment">// [1,2,3]  // len 3 cap 4</span><br></code></pre></td></tr></table></figure><blockquote><p>1、切片如果没有初始化值，值对应值为<code>nil</code>；</p><p>2、一个冒号(如b)为简单表达式，两个冒号(如c)为扩展表达式，具体区别后文会有详细描述。</p></blockquote><h5 id="简单表达式"><a href="#简单表达式" class="headerlink" title="简单表达式"></a>简单表达式</h5><p><code>b := a[low:high]</code>为简单表达式，这也是我们平时使用屏幕最多的方式，它与原数组或切片共享底层数组，简单表达式适用于数组、切片和字符串。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">len</span> = high - low<br><span class="hljs-attr">cap</span> = &amp;array.len - low<br></code></pre></td></tr></table></figure><p>因为与原数组或切片共享内存，当我们使用<code>append</code>给<code>b</code>追加元素的时候，可能会覆盖<code>a[high]</code>及后面的元素</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">a := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>&#125;<br>b := a[<span class="hljs-number">1</span>:<span class="hljs-number">4</span>]<br>b = <span class="hljs-built_in">append</span>(b, <span class="hljs-number">0</span>)  <span class="hljs-comment">// 此时a[4]将会由5变成0</span><br></code></pre></td></tr></table></figure><h5 id="扩展表达式"><a href="#扩展表达式" class="headerlink" title="扩展表达式"></a>扩展表达式</h5><p><code>c := a[low:high:max]</code>为扩展表达式，扩展表达式的出现，主要是为用来限制新切片的容量，<code>low</code>和<code>high</code>与简单表达式定义相同，<code>max</code>用于指定容量。扩展表达式只能适用于数组或切片，不能够用于字符串。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">len</span> = high - low<br><span class="hljs-attr">cap</span> = max - low<br></code></pre></td></tr></table></figure><p>新切片同样与原数组或切片共享内存，当使用<code>append</code>给<code>c</code>追加元素时，如果<code>cap</code>没有满，则跟简单表达式一样，会覆盖<code>a[high]</code>之后的元素，<strong>但是如果追加元素超过c限制容量，会产生一个新的切片，不会影响原始的数组或切片</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">a := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>&#125;<br>c1 := a[<span class="hljs-number">1</span>:<span class="hljs-number">4</span>:<span class="hljs-number">5</span>]<br>c1 = <span class="hljs-built_in">append</span>(c1, <span class="hljs-number">0</span>)  <span class="hljs-comment">// 容量足够，此时a[5]将会从5变成0</span><br><span class="hljs-comment">// c1 [2,3,4,0]     a [1,2,3,4,0]</span><br><br>c2 := a[<span class="hljs-number">1</span>:<span class="hljs-number">4</span>:<span class="hljs-number">5</span>]<br>c2 = <span class="hljs-built_in">append</span>(c2, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment">// 容量不够，创建新的切片，原切片a不会发生变化</span><br><span class="hljs-comment">// c2 [2,3,4,0,0]   a [1,2,3,4,5]</span><br></code></pre></td></tr></table></figure><blockquote><p>如果<code>c2 = append(c2, 0, 0)</code>，替换成2次<code>c2 = append(c2, 0)</code>，结果又回是怎么样呢？</p></blockquote><h3 id="slice扩容"><a href="#slice扩容" class="headerlink" title="slice扩容"></a>slice扩容</h3><p>当一个切片的容量满了，就需要扩容了。怎么扩，策略是什么？</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">growslice</span><span class="hljs-params">(et *_type, old slice, <span class="hljs-built_in">cap</span> <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">slice</span></span> &#123;<br>    <span class="hljs-keyword">if</span> raceenabled &#123;<br>        callerpc := getcallerpc(unsafe.Pointer(&amp;et))<br>        racereadrangepc(old.array, <span class="hljs-keyword">uintptr</span>(old.<span class="hljs-built_in">len</span>*<span class="hljs-keyword">int</span>(et.size)), callerpc, funcPC(growslice))<br>    &#125;<br>    <span class="hljs-keyword">if</span> msanenabled &#123;<br>        msanread(old.array, <span class="hljs-keyword">uintptr</span>(old.<span class="hljs-built_in">len</span>*<span class="hljs-keyword">int</span>(et.size)))<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> et.size == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-comment">// 如果新要扩容的容量比原来的容量还要小，这代表要缩容了，那么可以直接报panic了。</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span> &lt; old.<span class="hljs-built_in">cap</span> &#123;<br>            <span class="hljs-built_in">panic</span>(errorString(<span class="hljs-string">&quot;growslice: cap out of range&quot;</span>))<br>        &#125;<br><br>        <span class="hljs-comment">// 如果当前切片的大小为0，还调用了扩容方法，那么就新生成一个新的容量的切片返回。</span><br>        <span class="hljs-keyword">return</span> slice&#123;unsafe.Pointer(&amp;zerobase), old.<span class="hljs-built_in">len</span>, <span class="hljs-built_in">cap</span>&#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 这里就是扩容的策略</span><br>    newcap := old.<span class="hljs-built_in">cap</span><br>    doublecap := newcap + newcap<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span> &gt; doublecap &#123;<br>        newcap = <span class="hljs-built_in">cap</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> old.<span class="hljs-built_in">len</span> &lt; <span class="hljs-number">1024</span> &#123;<br>            newcap = doublecap<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Check 0 &lt; newcap to detect overflow</span><br>            <span class="hljs-comment">// and prevent an infinite loop.</span><br>            <span class="hljs-keyword">for</span> <span class="hljs-number">0</span> &lt; newcap &amp;&amp; newcap &lt; <span class="hljs-built_in">cap</span> &#123;<br>                newcap += newcap / <span class="hljs-number">4</span><br>            &#125;<br>            <span class="hljs-comment">// Set newcap to the requested cap when</span><br>            <span class="hljs-comment">// the newcap calculation overflowed.</span><br>            <span class="hljs-keyword">if</span> newcap &lt;= <span class="hljs-number">0</span> &#123;<br>                newcap = <span class="hljs-built_in">cap</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 计算新的切片的容量，长度。</span><br>    <span class="hljs-keyword">var</span> lenmem, newlenmem, capmem <span class="hljs-keyword">uintptr</span><br>    <span class="hljs-keyword">const</span> ptrSize = unsafe.Sizeof((*<span class="hljs-keyword">byte</span>)(<span class="hljs-literal">nil</span>))<br>    <span class="hljs-keyword">switch</span> et.size &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        lenmem = <span class="hljs-keyword">uintptr</span>(old.<span class="hljs-built_in">len</span>)<br>        newlenmem = <span class="hljs-keyword">uintptr</span>(<span class="hljs-built_in">cap</span>)<br>        capmem = roundupsize(<span class="hljs-keyword">uintptr</span>(newcap))<br>        newcap = <span class="hljs-keyword">int</span>(capmem)<br>    <span class="hljs-keyword">case</span> ptrSize:<br>        lenmem = <span class="hljs-keyword">uintptr</span>(old.<span class="hljs-built_in">len</span>) * ptrSize<br>        newlenmem = <span class="hljs-keyword">uintptr</span>(<span class="hljs-built_in">cap</span>) * ptrSize<br>        capmem = roundupsize(<span class="hljs-keyword">uintptr</span>(newcap) * ptrSize)<br>        newcap = <span class="hljs-keyword">int</span>(capmem / ptrSize)<br>    <span class="hljs-keyword">default</span>:<br>        lenmem = <span class="hljs-keyword">uintptr</span>(old.<span class="hljs-built_in">len</span>) * et.size<br>        newlenmem = <span class="hljs-keyword">uintptr</span>(<span class="hljs-built_in">cap</span>) * et.size<br>        capmem = roundupsize(<span class="hljs-keyword">uintptr</span>(newcap) * et.size)<br>        newcap = <span class="hljs-keyword">int</span>(capmem / et.size)<br>    &#125;<br><br>    <span class="hljs-comment">// 判断非法的值，保证容量是在增加，并且容量不超过最大容量</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span> &lt; old.<span class="hljs-built_in">cap</span> || <span class="hljs-keyword">uintptr</span>(newcap) &gt; maxSliceCap(et.size) &#123;<br>        <span class="hljs-built_in">panic</span>(errorString(<span class="hljs-string">&quot;growslice: cap out of range&quot;</span>))<br>    &#125;<br><br>    <span class="hljs-keyword">var</span> p unsafe.Pointer<br>    <span class="hljs-keyword">if</span> et.kind&amp;kindNoPointers != <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-comment">// 在老的切片后面继续扩充容量</span><br>        p = mallocgc(capmem, <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>)<br>        <span class="hljs-comment">// 将 lenmem 这个多个 bytes 从 old.array地址 拷贝到 p 的地址处</span><br>        memmove(p, old.array, lenmem)<br>        <span class="hljs-comment">// 先将 P 地址加上新的容量得到新切片容量的地址，然后将新切片容量地址后面的 capmem-newlenmem 个 bytes 这块内存初始化。为之后继续 append() 操作腾出空间。</span><br>        memclrNoHeapPointers(add(p, newlenmem), capmem-newlenmem)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 重新申请新的数组给新切片</span><br>        <span class="hljs-comment">// 重新申请 capmen 这个大的内存地址，并且初始化为0值</span><br>        p = mallocgc(capmem, et, <span class="hljs-literal">true</span>)<br>        <span class="hljs-keyword">if</span> !writeBarrier.enabled &#123;<br>            <span class="hljs-comment">// 如果还不能打开写锁，那么只能把 lenmem 大小的 bytes 字节从 old.array 拷贝到 p 的地址处</span><br>            memmove(p, old.array, lenmem)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 循环拷贝老的切片的值</span><br>            <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">uintptr</span>(<span class="hljs-number">0</span>); i &lt; lenmem; i += et.size &#123;<br>                typedmemmove(et, add(p, i), add(old.array, i))<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 返回最终新切片，容量更新为最新扩容之后的容量</span><br>    <span class="hljs-keyword">return</span> slice&#123;p, old.<span class="hljs-built_in">len</span>, newcap&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>所以Go 中切片扩容的策略是这样的：</strong></p><ul><li><strong>首先判断，如果新申请容量（<code>cap</code>）大于2倍的旧容量（<code>old.cap</code>），最终容量（<code>newcap</code>）就是新申请的容量（<code>cap</code>）</strong></li><li><strong>否则判断，如果旧切片的长度小于1024，则最终容量(<code>newcap</code>)就是旧容量(<code>old.cap</code>)的两倍，即（<code>newcap=doublecap</code>）</strong></li><li><strong>否则判断，如果旧切片长度大于等于1024，则最终容量（<code>newcap</code>）从旧容量（<code>old.cap</code>）开始循环增加原来的 1/4，即（<code>newcap=old.cap,for &#123;newcap += newcap/4&#125;</code>）直到最终容量（newcap）大于等于新申请的容量(cap)，即（<code>newcap &gt;= cap</code>）</strong></li><li><strong>如果最终容量（<code>cap</code>）计算值溢出，则最终容量（<code>cap</code>）就是新申请容量（<code>cap</code>）</strong></li></ul><p><strong>注意：扩容扩大的容量都是针对原来的容量而言的，而不是针对原来数组的长度而言的。</strong></p><h3 id="并发安全性"><a href="#并发安全性" class="headerlink" title="并发安全性"></a>并发安全性</h3><p><strong>slice 和 map 一样，都不是并发安全的。</strong>如果想要保证并发安全，只需要保证同一时间只有一个goroutine进行写操作。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> slc []<span class="hljs-keyword">int</span><br><br>    n := <span class="hljs-number">10000</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(a <span class="hljs-keyword">int</span>)</span></span> &#123;<br>            slc = <span class="hljs-built_in">append</span>(slc, a)<br>        &#125;(i)<br>    &#125;<br>    fmt.Println(<span class="hljs-string">&quot;done len:&quot;</span>, <span class="hljs-built_in">len</span>(slc))<br>&#125;<br><span class="hljs-comment">// done len: 7859</span><br></code></pre></td></tr></table></figure><p>从这个例子，我们验证了上面并发不安全的结论。</p><p>这里我们有两种方式保证并发安全：</p><ul><li>加锁 - 适用于性能要求低和逻辑不复杂的场景。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    slc := []<span class="hljs-keyword">int</span>&#123;&#125;<br>    n := <span class="hljs-number">10000</span><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    <span class="hljs-keyword">var</span> lock sync.Mutex<br>    wg.Add(n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(a <span class="hljs-keyword">int</span>)</span></span> &#123;<br>            lock.Lock()<br>            slc = <span class="hljs-built_in">append</span>(slc, a)<br>            lock.Unlock()<br>            wg.Done()<br>        &#125;(i)<br>    &#125;<br>    wg.Wait()<br><br>    fmt.Println(<span class="hljs-string">&quot;done len:&quot;</span>, <span class="hljs-built_in">len</span>(slc))<br>&#125;<br><span class="hljs-comment">// done len: 10000</span><br></code></pre></td></tr></table></figure><ul><li><code>active object</code> - 避免多个goroutine竞争锁。 适合业务场景复杂，性能要求高的场景。</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// active object对象</span><br><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;<br>    channel <span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span> <span class="hljs-string">`desc:&quot;即将加入到数据slice的数据&quot;`</span><br>    data    []<span class="hljs-keyword">int</span>    <span class="hljs-string">`desc:&quot;数据slice&quot;`</span><br>&#125;<br><br><br><span class="hljs-comment">// 新建一个size大小缓存的active object对象</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewService</span><span class="hljs-params">(size <span class="hljs-keyword">int</span>, done <span class="hljs-keyword">func</span>()</span>) *<span class="hljs-title">Service</span></span> &#123;<br>    s := &amp;Service&#123;<br>        channel: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, size),<br>        data:    <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">0</span>),<br>    &#125;<br><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        s.schedule()<br>        done()<br>    &#125;()<br>    <span class="hljs-keyword">return</span> s<br>&#125;<br><br><span class="hljs-comment">// 把管道中的数据append到slice中</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">schedule</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">for</span> v := <span class="hljs-keyword">range</span> s.channel &#123;<br>        s.data = <span class="hljs-built_in">append</span>(s.data, v)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 增加一个值</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">Add</span><span class="hljs-params">(v <span class="hljs-keyword">int</span>)</span></span> &#123;<br>    s.channel &lt;- v<br>&#125;<br><br><span class="hljs-comment">// 管道使用完关闭</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">Close</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-built_in">close</span>(s.channel)<br>&#125;<br><br><span class="hljs-comment">// 返回slice</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">Slice</span><span class="hljs-params">()</span> []<span class="hljs-title">int</span></span> &#123;<br>    <span class="hljs-keyword">return</span> s.data<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>    <span class="hljs-comment">// 1. 新建一个active object, 并增加结束信号</span><br>    c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>    s := NewService(<span class="hljs-number">100</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; &#125;)<br><br>    <span class="hljs-comment">// 2. 起n个goroutine不断执行增加操作</span><br>    n := <span class="hljs-number">10000</span><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    wg.Add(n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(a <span class="hljs-keyword">int</span>)</span></span> &#123;<br>            s.Add(a)<br>            wg.Done()<br>        &#125;(i)<br>    &#125;<br>    wg.Wait()<br>    s.Close()<br><br>    &lt;-c<br><br>    <span class="hljs-comment">// 3. 校验所有结果是否都被添加上</span><br>    fmt.Println(<span class="hljs-string">&quot;done len:&quot;</span>, <span class="hljs-built_in">len</span>(s.Slice()))<br>&#125;<br><span class="hljs-comment">// done len: 10000</span><br></code></pre></td></tr></table></figure><p>参考文章</p><ul><li><a href="https://halfrost.com/go_slice/">深入解析 Go 中 Slice 底层实现</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>slice</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言sort排序详解</title>
    <link href="/Myblog/2021/07/14/Go%E8%AF%AD%E8%A8%80sort%E6%8E%92%E5%BA%8F%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2021/07/14/Go%E8%AF%AD%E8%A8%80sort%E6%8E%92%E5%BA%8F%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="sort介绍"><a href="#sort介绍" class="headerlink" title="sort介绍"></a>sort介绍</h3><p>go语言对数据进行排序，主要使用sort内置模块，下面我们详细介绍如何去使用这个模块。</p><p>该包实现了四种基本排序算法：插入排序、归并排序、堆排序和快速排序。 但是这四种排序方法是不公开的，它们只被用于 sort 包内部使用。所以在对数据集合排序时不必考虑应当选择哪一种排序方法，<strong>只要实现了 sort.Interface 定义的三个方法：获取数据集合长度的 Len() 方法、比较两个元素大小的 Less() 方法和交换两个元素位置的 Swap() 方法，就可以顺利对数据集合进行排序</strong>。</p><p><strong>sort 包会根据实际数据自动选择高效的排序算法</strong>。 除此之外，为了方便对常用数据类型的操作，sort 包提供了对[]int 切片、[]float64 切片和[]string 切片完整支持，主要包括：</p><ul><li>对基本数据类型切片的排序支持</li><li>基本数据元素查找</li><li>判断基本数据类型切片是否已经排好序</li><li>对排好序的数据集合逆序</li></ul><h3 id="sort几种排序方法"><a href="#sort几种排序方法" class="headerlink" title="sort几种排序方法"></a>sort几种排序方法</h3><h4 id="内部数据类型排序"><a href="#内部数据类型排序" class="headerlink" title="内部数据类型排序"></a>内部数据类型排序</h4><p>前面已经提到，<em>sort</em>包原生支持<code>[]int</code>、<code>[]float64</code> 和<code>[]string</code> 三种内建数据类型切片的排序操作，即不必我们自己实现相关的 Len()、Less() 和 Swap() 方法。对应提供了3种数据类型<code>sort.IntSlice</code>、 <code>sort.Float64Slice</code>和 <code>sort.StringSlice</code> </p><p>所以我们可以<strong>使用以下方式进行排序</strong>：</p><ul><li><code>sort.Ints</code></li></ul><p>同样的还有<code>sort.Strings</code>和 <code>sort.Float64s</code> 方法支持对应的数据类型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">tests := []<span class="hljs-keyword">int</span> &#123;<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>&#125;<br>sort.Ints(tests)<br></code></pre></td></tr></table></figure><ul><li><code>sort.Sort</code></li></ul><p>同样的还有<code>sort.StringSlice</code>和 <code>sort.Float64Slice</code> 方法支持对应的数据类型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">sort.Sort(sort.IntSlice(tests))<br></code></pre></td></tr></table></figure><ul><li><code>sort.Slice</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">sort.Slice(tests, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123; <span class="hljs-keyword">return</span> tests[i] &lt; tests[j] &#125;)<br></code></pre></td></tr></table></figure><p>如果需要降序，可以使用<code>sort.Reverse</code>方法 </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">sort.Sort(sort.Reverse(sort.IntSlice(tests)))<br></code></pre></td></tr></table></figure><h4 id="自定义数据类型排序"><a href="#自定义数据类型排序" class="headerlink" title="自定义数据类型排序"></a>自定义数据类型排序</h4><p>对于自定义数据类型，比如结构体，系统无法预知我们通过什么属性进行排序，所有我们需要自己去实现<code>sort.Interface</code>定义的3个方法<code>Len()</code>、<code>Less()</code>、<code>Swap()</code>，才能使用<code>sort.Interface</code>相关的方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Student <span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>score <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Students []Student<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Students)</span> <span class="hljs-title">Len</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(s)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Students)</span> <span class="hljs-title">Less</span><span class="hljs-params">(i, j <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">return</span> s[i].score &lt; s[j].score<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Students)</span> <span class="hljs-title">Swap</span><span class="hljs-params">(i, j <span class="hljs-keyword">int</span>)</span></span> &#123;<br>s[i], s[j] = s[j], s[i]<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  students := Students &#123;<br>&#123;<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">70</span>&#125;,<br>&#123;<span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-number">60</span>&#125;,<br>&#123;<span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">80</span>&#125;,<br>&#125;<br>sort.Sort(students)<br>fmt.Println(students)<br>&#125;<br><br><span class="hljs-comment">// [&#123;b 60&#125; &#123;a 70&#125; &#123;c 80&#125;]</span><br></code></pre></td></tr></table></figure><p>其实我们也可以使用<code>sort.Slice</code>方法，通过传入匿名函数来指定如何排序</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">students := [] <span class="hljs-keyword">struct</span> &#123;<br>  name <span class="hljs-keyword">string</span><br>  score <span class="hljs-keyword">int</span><br>&#125;&#123;<br>  &#123;<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">70</span>&#125;,<br>  &#123;<span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-number">60</span>&#125;,<br>  &#123;<span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">80</span>&#125;,<br>&#125;<br>sort.Slice(students, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123; <span class="hljs-keyword">return</span> students[i].score &lt; students[j].score &#125;)<br>fmt.Println(students)<br><br><span class="hljs-comment">// [&#123;b 60&#125; &#123;a 70&#125; &#123;c 80&#125;]</span><br></code></pre></td></tr></table></figure><p>参考文章</p><ul><li><a href="https://books.studygolang.com/The-Golang-Standard-Library-by-Example/chapter03/03.1.html">sort排序算法</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>sort</tag>
      
      <tag>排序</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言panic与recover最佳实践</title>
    <link href="/Myblog/2021/07/13/Go%E8%AF%AD%E8%A8%80panic%E4%B8%8Erecover%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <url>/Myblog/2021/07/13/Go%E8%AF%AD%E8%A8%80panic%E4%B8%8Erecover%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h3 id="初识-panic-和-recover"><a href="#初识-panic-和-recover" class="headerlink" title="初识 panic 和 recover"></a>初识 panic 和 recover</h3><ul><li><p><code>panic</code></p><p>说到panic就不得不提到error，Go 的 error 就相当于原先的 “Exception”，而那些异常严重的 “Exception” 叫 panic</p><p><code>panic</code> 这个词，在英语中具有<code>恐慌、恐慌的</code>等意思。从字面意思理解的话，在 Go 语言中，代表极其严重的问题，程序员最害怕出现的问题。一旦出现，就意味着程序的结束并退出。Go 语言中 <code>panic</code> 关键字主要用于主动抛出异常，类似 <code>java</code> 等语言中的 <code>throw</code> 关键字。</p></li><li><p><code>recover</code><br><code>recover</code> 这个词，在英语中具有<code>恢复、复原</code>等意思。从字面意思理解的话，在 Go 语言中，代表将程序状态从严重的错误中恢复到正常状态。Go 语言中 <code>recover</code> 关键字主要用于捕获异常，让程序回到正常状态，类似 <code>java</code> 等语言中的 <code>try ... catch</code> 。</p></li></ul><h3 id="深入-panic-和-recover"><a href="#深入-panic-和-recover" class="headerlink" title="深入 panic 和 recover"></a>深入 panic 和 recover</h3><p> 这样完美的解决了上层业务无脑 catch 的情况。这是一个很棒的思路，但是在实践中会有一些问题。</p><p>最常见的：业务逻辑满屏的 error ，模块库大量预留错误</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 使用error的写法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">first</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">second</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">third</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fourth</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fifth</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Do</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>    <span class="hljs-keyword">var</span> err error<br>    <span class="hljs-keyword">if</span> err = first(); err == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> err = second(); err == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">if</span> err = third(); err == <span class="hljs-literal">nil</span> &#123;<br>                <span class="hljs-keyword">if</span> err = fourth(); err == <span class="hljs-literal">nil</span> &#123;<br>                    <span class="hljs-keyword">if</span> err = fifth(); err == <span class="hljs-literal">nil</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure><p>所以过多的预留 error，会造成流程控制极大的问题。那么如果这个时候我们使用以下 panic ，你会发现世界瞬间干净了许多。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// panic 写法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Do2</span><span class="hljs-params">()</span> <span class="hljs-params">(err error)</span></span> &#123;<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">if</span> r:= <span class="hljs-built_in">recover</span>() ; r!= <span class="hljs-literal">nil</span>&#123;<br>            err = fmt.Errorf(<span class="hljs-string">&quot;Error: %+v&quot;</span>, r)<br>        &#125;<br>    &#125;()<br>    first2()<br>    second2()<br>    third2()<br>    fourth2()<br>    fifth2()<br>    <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><p>如果还不理解，可以看下面这个例子。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(err)<br>        &#125;<br>    &#125;()<br>    <span class="hljs-keyword">var</span> bar = []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>&#125;<br>    fmt.Println(bar[<span class="hljs-number">1</span>])   <span class="hljs-comment">// 下标越界出现panic，也可以通过关键字panic主动抛出错误</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    foo()<br>    fmt.Println(<span class="hljs-string">&quot;exit&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// runtime error: index out of range</span><br><span class="hljs-comment">// exit</span><br></code></pre></td></tr></table></figure><blockquote><ul><li><code>panic</code> 能够改变程序的控制流，调用 <code>panic</code> 后会立刻停止执行当前函数的剩余代码，并在当前 Goroutine 中递归执行调用方的 <code>defer</code>；</li><li><code>recover</code> 可以中止 <code>panic</code> 造成的程序崩溃。它是一个只能在 <code>defer</code> 中发挥作用的函数，在其他作用域中调用不会发挥作用；</li></ul></blockquote><p>参考文章：</p><ul><li><a href="https://zhuanlan.zhihu.com/p/87345297">Go 语言 panic 与 error 最佳实践</a></li><li><a href="https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-panic-recover/">panic 和 recover</a></li><li><a href="https://xiaomi-info.github.io/2020/01/20/go-trample-panic-recover/">Go 语言踩坑记——panic 与 recover</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>panic</tag>
      
      <tag>error</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言defer详解</title>
    <link href="/Myblog/2021/07/13/Go%E8%AF%AD%E8%A8%80defer%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2021/07/13/Go%E8%AF%AD%E8%A8%80defer%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="defer-关键字"><a href="#defer-关键字" class="headerlink" title="defer 关键字"></a>defer 关键字</h3><p>很多现代的编程语言中都有 <code>defer</code> 关键字，<strong>Go 语言的 <code>defer</code> 会在当前函数返回前执行传入的函数</strong>。它会经常被用于关闭文件描述符、关闭数据库连接以及解锁资源。</p><p>例如：使用defer回滚事务</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createPost</span><span class="hljs-params">(db *gorm.DB)</span> <span class="hljs-title">error</span></span> &#123;<br>    tx := db.Begin()<br>    <span class="hljs-keyword">defer</span> tx.Rollback()<br>    <br>    <span class="hljs-keyword">if</span> err := tx.Create(&amp;Post&#123;Author: <span class="hljs-string">&quot;Draveness&quot;</span>&#125;).Error; err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> tx.Commit().Error<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="defer的两大特性"><a href="#defer的两大特性" class="headerlink" title="defer的两大特性"></a>defer的两大特性</h3><h4 id="1、defer函数的调用时机"><a href="#1、defer函数的调用时机" class="headerlink" title="1、defer函数的调用时机"></a>1、defer函数的调用时机</h4><p><strong>如果多次调用defer函数，则会倒序依次执行</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br><span class="hljs-keyword">defer</span> fmt.Println(i)<br>&#125;<br>&#125;<br><br>$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span><br><span class="hljs-number">4</span><br><span class="hljs-number">3</span><br><span class="hljs-number">2</span><br><span class="hljs-number">1</span><br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h4 id="2、预计算参数"><a href="#2、预计算参数" class="headerlink" title="2、预计算参数"></a>2、预计算参数</h4><p><strong>当defer定义函数时，如果函数有参数，则会预先计算好参数，函数的参数不会等到真正执行时计算</strong></p><p>例子：计算函数运行时间(不符合预期)</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>startedAt := time.Now()<br><span class="hljs-keyword">defer</span> fmt.Println(time.Since(startedAt))<br><br>time.Sleep(time.Second)<br>&#125;<br><br>$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span><br><span class="hljs-number">0</span>s<br></code></pre></td></tr></table></figure><blockquote><p>因为函数<code>defer fmt.Println</code>存在参数，所以<code>time.Since(startedAt)</code>已经被计算出来，所以结果并不符合我们的预期。</p></blockquote><p>当我们知道defer这个特性之后，可以调整代码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>startedAt := time.Now()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; fmt.Println(time.Since(startedAt)) &#125;()<br><br>time.Sleep(time.Second)<br>&#125;<br><br>$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span><br><span class="hljs-number">1</span>s<br></code></pre></td></tr></table></figure><blockquote><p>使用无参匿名函数，避开预计算参数的问题。</p></blockquote><ul><li><a href="https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/">defer关键字底层实现与详解</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>defer</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go日期转换详解</title>
    <link href="/Myblog/2021/07/10/Go%E6%97%A5%E6%9C%9F%E8%BD%AC%E6%8D%A2%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2021/07/10/Go%E6%97%A5%E6%9C%9F%E8%BD%AC%E6%8D%A2%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="Go内置time模块"><a href="#Go内置time模块" class="headerlink" title="Go内置time模块"></a>Go内置time模块</h3><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><p><code>time.Now()</code> - 获取现在时间 Time 时间类型</p><p><code>time.Now().Unix()</code> - 获取现在时间戳</p><p><code>time.Now().Format(&quot;2006-01-02 15:04:05&quot;)</code> - 获取当前时间格式化显示()</p><blockquote><p>这是个奇葩，必须是这个时间点，据说是go诞生之日，记忆方法: <code>6-1-2-3-4-5</code></p></blockquote><h4 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h4><ul><li><p>Time -&gt; String</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">strTimeFormat := time.Now().Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>)<br></code></pre></td></tr></table></figure></li><li><p>String -&gt; Time</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">local, _ := time.LoadLocation(<span class="hljs-string">&quot;Local&quot;</span>)<br>myTime, _ := time.ParseInLocation(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>, strTimeFormat, local)<br><span class="hljs-comment">// 2021-07-10 10:04:47 +0800 CST</span><br></code></pre></td></tr></table></figure><blockquote><p>参数Local 可以替换为 UTC， 对应转换为UTC格式时间 </p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">myTime, _ := time.Parse(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>, strTimeFormat)<br><span class="hljs-comment">// 2021-07-10 10:04:47 +0000 UTC</span><br></code></pre></td></tr></table></figure><blockquote><p><code>time.Parse</code>只能转换为UTC时间</p></blockquote></li><li><p>Time -&gt; 时间戳</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">timestamp := time.Now().Unix()<br></code></pre></td></tr></table></figure></li><li><p>时间戳 -&gt; Time</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">myTime := time.Unix(timestamp, <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure></li><li><p>自行组装时间</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">local, _ := time.LoadLocation(<span class="hljs-string">&quot;Local&quot;</span>)<br>myDate := time.Date(<span class="hljs-number">2015</span>, <span class="hljs-number">01</span>, <span class="hljs-number">01</span>, <span class="hljs-number">11</span>, <span class="hljs-number">11</span>, <span class="hljs-number">11</span>, <span class="hljs-number">0</span>, local)<br><span class="hljs-comment">// 2015-01-01 11:11:11 +0800 CST</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="时间转换"><a href="#时间转换" class="headerlink" title="时间转换"></a>时间转换</h4><ul><li><code>time.Add()</code> 时间加减</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">now := time.Now()    <span class="hljs-comment">// 2021-07-10 10:40:23.083227 +0800 CST m=+0.000143876</span><br>pd, _ := time.ParseDuration(<span class="hljs-string">&quot;-1h&quot;</span>)<br>now1 := now.Add(pd)  <span class="hljs-comment">// 2021-07-10 09:40:23.083227 +0800 CST m=-3599.999856124</span><br></code></pre></td></tr></table></figure><blockquote><p>ParseDuration解析一个时间段字符串。一个时间段字符串是一个序列，每个片段包含可选的正负号、<br>十进制数、可选的小数部分和单位后缀，如”300ms”、”-1.5h”、”2h45m”。<br>合法的单位有<code>&quot;ns&quot;纳秒,&quot;us&quot;,&quot;µs&quot;、&quot;ms&quot;毫秒、&quot;s&quot;秒、&quot;m&quot;分钟、&quot;h&quot;小时</code></p></blockquote><ul><li><code>time.Sub()</code> 计算两个时间差值</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">local, _ := time.LoadLocation(<span class="hljs-string">&quot;Local&quot;</span>)<br>after := time.Date(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, local)<br>before := time.Date(<span class="hljs-number">2020</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, local)<br>diff := after.Sub(before)<br>fmt.Println(<span class="hljs-string">&quot;hours: &quot;</span>, diff.Hours())       <span class="hljs-comment">// hours:  744</span><br>fmt.Println(<span class="hljs-string">&quot;seconds: &quot;</span>, diff.Seconds())   <span class="hljs-comment">// seconds:  2.6784e+06</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>日期</tag>
      
      <tag>时间</tag>
      
      <tag>time</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何低内存消耗解析大型XML</title>
    <link href="/Myblog/2020/09/17/%E5%A6%82%E4%BD%95%E4%BD%8E%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97%E8%A7%A3%E6%9E%90%E5%A4%A7%E5%9E%8BXML/"/>
    <url>/Myblog/2020/09/17/%E5%A6%82%E4%BD%95%E4%BD%8E%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97%E8%A7%A3%E6%9E%90%E5%A4%A7%E5%9E%8BXML/</url>
    
    <content type="html"><![CDATA[<h3 id="XML简介"><a href="#XML简介" class="headerlink" title="XML简介"></a>XML简介</h3><p>XML是可扩展标记语言（eXtensible Markup Language）的缩写，它是是一种数据表示格式，可以描述非常复杂的数据结构，常用于传输和存储数据。</p><p>例如，一个描述书籍的XML文档可能如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">note</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;book.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">book</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Java核心技术<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">author</span>&gt;</span>Cay S. Horstmann<span class="hljs-tag">&lt;/<span class="hljs-name">author</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">isbn</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;CN&quot;</span>&gt;</span>1234567<span class="hljs-tag">&lt;/<span class="hljs-name">isbn</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tags</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tag</span>&gt;</span>Java<span class="hljs-tag">&lt;/<span class="hljs-name">tag</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tag</span>&gt;</span>Network<span class="hljs-tag">&lt;/<span class="hljs-name">tag</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tags</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">pubDate</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">book</span>&gt;</span><br></code></pre></td></tr></table></figure><p>XML有几个特点：一是纯文本，默认使用UTF-8编码，二是可嵌套，适合表示结构化数据。如果把XML内容存为文件，那么它就是一个XML文件，例如<code>book.xml</code>。此外，XML内容经常通过网络作为消息传输。</p><h3 id="迭代下载XML到临时文件"><a href="#迭代下载XML到临时文件" class="headerlink" title="迭代下载XML到临时文件"></a>迭代下载XML到临时文件</h3><p>如果加载大型XML，使用zeep默认会加载xml到内存自动进行解析，但是这样会造成大量内存消耗。如果是使用requests，则可以类似这样处理：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">url = <span class="hljs-string">&quot;http://wx4.sinaimg.cn/large/d030806aly1fq1vn8j0ajj21ho28bduy.jpg&quot;</span><br><br>rsp = requests.get(url, stream=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;1.jpg&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> rsp.iter_content(chunk_size=<span class="hljs-number">1024</span>):  <span class="hljs-comment"># 边下载边存硬盘, chunk_size 可以自由调整为可以更好地适合您的用例的数字</span><br>        f.write(i)<br></code></pre></td></tr></table></figure><p>zeep底层也是使用request，对应我们需要这样设置：<code>stream=True</code> 和 <code>iter_content(chunk_size=1024)</code> 进行迭代加载到本地，后面自行再进行解析。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">from</span> zeep <span class="hljs-keyword">import</span> Client, Settings<br><span class="hljs-keyword">from</span> zeep.transports <span class="hljs-keyword">import</span> Transport<br><span class="hljs-keyword">from</span> requests <span class="hljs-keyword">import</span> Session <span class="hljs-keyword">as</span> ReqSession<br><span class="hljs-keyword">from</span> requests_ntlm <span class="hljs-keyword">import</span> HttpNtlmAuth<br><br>req_session = ReqSession()<br>req_session.stream = <span class="hljs-literal">True</span><br>req_session.auth = HttpNtlmAuth(<span class="hljs-string">&quot;xxxxxxx&quot;</span>, <span class="hljs-string">&quot;xxxxxx&quot;</span>)<br>transport = Transport(session=req_session)<br>setting = Settings(raw_response=<span class="hljs-literal">True</span>)    <span class="hljs-comment"># 拒绝自动解析xml</span><br><br><br>url = <span class="hljs-string">&#x27;http://xxxxxxxx/APIMP_SalesPriceList&#x27;</span><br>client = Client(url, transport=transport, settings=setting)<br><br>filtered = [&#123;<span class="hljs-string">&#x27;Field&#x27;</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&#x27;Criteria&#x27;</span>: <span class="hljs-string">&quot;&quot;</span>&#125;]<br>rep = client.service.ReadMultiple(filtered, bookmarkKey=<span class="hljs-string">&#x27;&#x27;</span>, setSize=<span class="hljs-string">&#x27;0&#x27;</span>)<br><span class="hljs-keyword">if</span> rep.status_code != <span class="hljs-number">200</span>:<br>  <span class="hljs-keyword">raise</span> ConnectionError(<span class="hljs-string">&quot;Request Failed!&quot;</span>)<br><span class="hljs-keyword">with</span> NamedTemporaryFile(suffix=<span class="hljs-string">&quot;.xml&quot;</span>) <span class="hljs-keyword">as</span> ntf:<br>  ntf_path = ntf.name    <span class="hljs-comment"># 临时文件路径</span><br>  logging.info(<span class="hljs-string">&quot;Download temporary xml file to local.&quot;</span>)<br>  <span class="hljs-comment"># 迭代下载xml写入临时文件</span><br>  <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> rep.iter_content(chunk_size=<span class="hljs-number">1024</span>):<br>    ntf.write(text)<br>    ntf.seek(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><h3 id="迭代解析XML"><a href="#迭代解析XML" class="headerlink" title="迭代解析XML"></a>迭代解析XML</h3><p>上面我们已经将大型XML保存到临时文件，为了节约内存，我们需要进行迭代加载XML文件进行解析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_xml</span>(<span class="hljs-params">xml_path</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    迭代解析xml, 每次返回一整条数据</span><br><span class="hljs-string">    :return type: dict</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    context = etree.iterparse(xml_path, events=(<span class="hljs-string">&quot;end&quot;</span>,))<br>    item = dict()<br>    <span class="hljs-keyword">for</span> _, elem <span class="hljs-keyword">in</span> context:<br>        val = elem.text<br>        <span class="hljs-keyword">if</span> val <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> item != &#123;&#125;:<br>                <span class="hljs-keyword">yield</span> item<br>                item = dict()<br>            <span class="hljs-keyword">continue</span><br>        key = str.split(elem.tag[<span class="hljs-number">1</span>:], <span class="hljs-string">&quot;&#125;&quot;</span>, <span class="hljs-number">1</span>)[<span class="hljs-number">-1</span>]<br>        item[key] = val<br>        <span class="hljs-comment"># 释放对节点的引用，回收内存</span><br>        <span class="hljs-comment"># It&#x27;s safe to call clear() here because no descendants will be accessed</span><br>        elem.clear()<br>        <span class="hljs-comment"># Also eliminate now-empty references from the root node to &lt;Title&gt;</span><br>        <span class="hljs-keyword">while</span> elem.getprevious() <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">del</span> elem.getparent()[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><blockquote><p>如果不释放对不需要节点的引用，同样会消耗比较大的内存</p></blockquote><p>所以最后应该是这样</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">with</span> NamedTemporaryFile(suffix=<span class="hljs-string">&quot;.xml&quot;</span>) <span class="hljs-keyword">as</span> ntf:<br>  ntf_path = ntf.name<br>  logging.info(<span class="hljs-string">&quot;Download temporary xml file to local.&quot;</span>)<br>  <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> rep.iter_content(chunk_size=chunk_size):<br>    ntf.write(text)<br>    ntf.seek(<span class="hljs-number">0</span>)<br>    logging.info(<span class="hljs-string">&quot;Download Successful, start to parse the xml file.&quot;</span>)<br>    <span class="hljs-keyword">for</span> dic <span class="hljs-keyword">in</span> parse_xml(ntf_path):<br>      <span class="hljs-keyword">yield</span> dic<br></code></pre></td></tr></table></figure><h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><ul><li><p><a href="https://www.jianshu.com/p/0eff5fb281c0">Python Response.iter_content</a> / <a href="https://requests.readthedocs.io/zh_CN/latest/api.html#requests.Response.iter_content">Requests iter_content</a></p></li><li><p><a href="https://docs.python-zeep.org/en/master/client.html#creating-the-raw-xml-documents">Zeep Client</a></p></li><li><p><a href="https://www.ibm.com/developerworks/library/x-hiperfparse/">High-performance XML parsing in Python with lxml</a> / <a href="https://www.ibm.com/developerworks/cn/xml/x-hiperfparse/#resources">使用由 Python 编写的 lxml 实现高性能 XML 解析</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>XML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>xml</tag>
      
      <tag>lxml</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Numba加速Python执行</title>
    <link href="/Myblog/2020/09/15/Numba%E5%8A%A0%E9%80%9FPython%E6%89%A7%E8%A1%8C/"/>
    <url>/Myblog/2020/09/15/Numba%E5%8A%A0%E9%80%9FPython%E6%89%A7%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<h3 id="Numba简介"><a href="#Numba简介" class="headerlink" title="Numba简介"></a>Numba简介</h3><p>说道现在最流行的语言，就不得不提python。可是python虽然容易上手，但速度却有点感人。如何用简单的方法让python加速到近乎可以媲美C的速度呢？今天来就来谈谈numba这个宝贝。对你没看错，不是numpy，就是numba。</p><p>Numba是Python的即时编译器，它最适用于使用NumPy数组和函数以及循环的代码。使用Numba的最常用方法是通过其装饰器集合，可以应用于您的函数来指示Numba编译它们。当调用Numba修饰函数时，它被编译为机器代码“及时”执行，并且您的全部或部分代码随后可以以本机机器代码速度运行！</p><p>Numba读取装饰函数的Python字节码，并将其与有关函数输入参数类型的信息相结合。它分析并优化您的代码，最后使用LLVM编译器库生成函数的机器代码版本，根据您的CPU功能量身定制。每次调用函数时都会使用此编译版本。</p><h3 id="Numba有多快"><a href="#Numba有多快" class="headerlink" title="Numba有多快"></a>Numba有多快</h3><p>python由于gil的大锁，所以在做计算密集型的任务的时候，会出现性能不足的问题。虽然在数学计算中，有很多成功的库，比如numpy等，但是还是没有逃脱gil的大锁。所以我踩了下numba的坑。</p><p>Numba可以在<code>nopython</code>模式下运行，或者至少编译一些循环，它将针对您的特定CPU进行编译。加速因应用而异，但可以是一到两个数量级。Numba有一个 <a href="http://numba.pydata.org/numba-doc/latest/user/performance-tips.html#performance-tips">性能指南</a>，涵盖了获得额外性能的常用选项。</p><p>Numba必须为执行函数的机器代码版本之前给出的参数类型编译函数，这需要时间。但是，一旦编译完成，Numba会为所呈现的特定类型的参数缓存函数的机器代码版本。如果再次使用相同的类型调用它，它可以重用缓存的版本而不必再次编译。</p><h3 id="Numba的优势"><a href="#Numba的优势" class="headerlink" title="Numba的优势"></a>Numba的优势</h3><p><strong>1. 简单，往往只要1行代码就有惊喜</strong></p><p><strong>2. 对循环（loop）有奇效，而往往在科学计算中限制python速度的就是loop</strong></p><p><strong>3. 兼容常用的科学计算包，如numpy、cmath等</strong></p><p><strong>4. 可以创建ufunc</strong></p><p><strong>5. 会自动调整精度，保证准确性</strong></p><h3 id="如何使用Numba"><a href="#如何使用Numba" class="headerlink" title="如何使用Numba"></a>如何使用Numba</h3><p>老规矩，pip安装numba</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install numba<br></code></pre></td></tr></table></figure><p>使用实例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> jit<br><br><br><span class="hljs-meta">@jit(nopython=True)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calc</span>(<span class="hljs-params">n, i=<span class="hljs-number">0</span>, cols=<span class="hljs-number">0</span>, diags=<span class="hljs-number">0</span>, trans=<span class="hljs-number">0</span></span>):</span><br>    <span class="hljs-keyword">if</span> i == n:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        rt = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(n):<br>            col = <span class="hljs-number">1</span> &lt;&lt; j<br>            diag = <span class="hljs-number">1</span> &lt;&lt; (i - j + n - <span class="hljs-number">1</span>)<br>            tran = <span class="hljs-number">1</span> &lt;&lt; (i + j)<br><br>            <span class="hljs-keyword">if</span> (col &amp; cols) == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (diag &amp; diags) == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (tran &amp; trans) == <span class="hljs-number">0</span>:<br>                rt += calc(n, i+<span class="hljs-number">1</span>, cols | col, diags | diag, trans | tran)<br>        <span class="hljs-keyword">return</span> rt<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    t = time.time()<br>    print(<span class="hljs-string">f&quot;result:<span class="hljs-subst">&#123;calc(<span class="hljs-number">13</span>)&#125;</span>&quot;</span>)<br>    print(<span class="hljs-string">f&quot;cost:<span class="hljs-subst">&#123;time.time() - t&#125;</span>s&quot;</span>)<br></code></pre></td></tr></table></figure><blockquote><ol><li><p><code>nopython=True</code> - nopython编译模式的行为本质上是编译装饰函数，以便它完全运行而不需要Python解释器的参与。这是使用Numba <code>jit</code>装饰器的推荐和最佳实践方式，因为它可以带来最佳性能。</p></li><li><p><code>@njit</code>等价于<code>@jit(nopython=True)</code></p></li><li><p>下面是一些额外参数:</p></li></ol><ul><li><code>parallel = True</code>- <a href="http://numba.pydata.org/numba-doc/latest/reference/jit-compilation.html#jit-decorator-parallel">启用功能</a>的 <a href="http://numba.pydata.org/numba-doc/latest/user/parallel.html#numba-parallel">自动并行</a>化。</li><li><code>fastmath = True</code>- 为该功能启用<a href="http://numba.pydata.org/numba-doc/latest/user/jit-decorator-fastmath">快速数学</a>行为。</li></ul></blockquote><p>以下是在本机上，分别使用和未使用numba情况的输出，以此作为性能对比参考</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">result:73712<br>cost:1.1680660247802734s<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">result:73712<br>cost:22.645495176315308s<br></code></pre></td></tr></table></figure><p>提升的性能可以自行感受一下。</p><h3 id="Numba相关坑点"><a href="#Numba相关坑点" class="headerlink" title="Numba相关坑点"></a>Numba相关坑点</h3><ul><li><p>numba对numpy的很多表达式不支持，最好打开官方文档看着写，规避不支持的表达式~</p></li><li><p>精度方面可能会引起误差。</p><p>numba会自动转换数据类型以适应计算，但是在个别时候，<strong>这种自动转变类型可能会引起一些计算误差</strong>。通常这个误差是非常小的，几乎不会造成任何影响。但如果你所处理的问题会积累误差，比如求解非线性方程，那么在非常多的计算之后误差可能就是肉眼可见了。<strong>如果你发现有这样的问题，记得在jit中指定输入输出的数据类型。</strong>numba具有C所有的数据类型，比如对上面的求和函数，只需要把@nb.jit()改为@nb.jit(nb.int64(nb.int32[:]))即可。nb.int64是说输出的数字为int64类型，nb.int32是说输入的数据类型为int32，而[:]是说输入的是数组。</p></li></ul><h3 id="相关参考链接"><a href="#相关参考链接" class="headerlink" title="相关参考链接"></a>相关参考链接</h3><ul><li><a href="https://github.com/numba/numba">github code</a> / <a href="http://numba.pydata.org/">官文</a> / <a href="https://blog.csdn.net/jiangjiang_jian/article/details/89576134">Numba的5分钟指南</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Numba</category>
      
    </categories>
    
    
    <tags>
      
      <tag>numba</tag>
      
      <tag>优化程序</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PostGIS空间数据库</title>
    <link href="/Myblog/2020/08/25/PostGIS%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <url>/Myblog/2020/08/25/PostGIS%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<h3 id="PostGIS简介"><a href="#PostGIS简介" class="headerlink" title="PostGIS简介"></a>PostGIS简介</h3><p><strong>PostGIS</strong>是一个空间数据库，空间数据库像存储和操作数据库中其他任何对象一样去存储和操作空间对象。</p><p><strong>PostGIS</strong>通过向PostgreSQL添加对<strong>空间数据类型</strong>、<strong>空间索引</strong>和<strong>空间函数</strong>的支持，将PostgreSQL数据库管理系统转换为<strong>空间数据库</strong>。</p><p>因为PostGIS是建立在PostgreSQL之上的，所以PostGIS自动继承了重要的”<strong>企业级</strong>“特性以及开放源代码的标准。</p><p>可以说PostGIS仅仅只是PostgreSQL的一个插件，但是它将PostgreSQL变成了一个强大的空间数据库！</p><p><strong>空间数据</strong>与数据库关联起来的三个要素：<strong>数据类型</strong>、<strong>索引</strong>和<strong>函数</strong></p><ul><li><strong>空间数据类型</strong>用于指定图形为<strong>点</strong>（point）、<strong>线</strong>（line）和<strong>面</strong>（polygon）</li><li>多维度<strong>空间索引</strong>被用于进行空间操作的高效处理（注意是多维度哦，而不是只有针对二维空间数据的索引）</li><li><strong>空间函数</strong>构建于SQL语言中，用于进行空间属性和空间关系的查询</li></ul><p><strong>空间数据类型</strong>、<strong>空间索引</strong>和<strong>空间函数</strong>组合在一起，提供了灵活的结构用于空间数据库的性能优化和分析。</p><p>地球不是平的，也没有简单的方法把它放在一张平面纸地图上（或电脑屏幕上），所以计算时需要投影到某个坐标系里面</p><p>PostGIS包含更改数据投影（重投影）的功能，即使用<strong>ST_Transform(geometry, srid)**函数就可以实现重投影。另外，为了查看和设置几何图形的空间参照标识符，PostGIS提供了</strong>ST_SRID(geometry）<strong>和</strong>ST_SetSRID(geometry，SRID）**函数。</p><p><strong>简单来说，空间数据库允许地理信息存入数据库，使用一些特定的函数来方便我们使用。</strong></p><h3 id="PostGIS使用"><a href="#PostGIS使用" class="headerlink" title="PostGIS使用"></a>PostGIS使用</h3><ul><li>添加插件，转换pgsql为空间数据库</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> extension postgis;<br></code></pre></td></tr></table></figure><blockquote><ul><li>使用<code>select postgis_full_version();</code>可以检查是否安装好插件；</li><li>安装成功后会新增相关表</li></ul><p>注意：需要提前集成postgis插件才能使用，所以需要使用特定的数据库版本。</p></blockquote><ul><li>创建数据库</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> global_points (<br>    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,<br>    <span class="hljs-keyword">name</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">64</span>),<br>    geog GEOGRAPHY(POINT,<span class="hljs-number">4326</span>)<br>);<br> <br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> global_points (<span class="hljs-keyword">name</span>, geog) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;Town&#x27;</span>, <span class="hljs-string">&#x27;SRID=4326;POINT(-110 30)&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> global_points (<span class="hljs-keyword">name</span>, geog) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;Forest&#x27;</span>, <span class="hljs-string">&#x27;SRID=4326;POINT(-109 29)&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> global_points (<span class="hljs-keyword">name</span>, geog) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;London&#x27;</span>, <span class="hljs-string">&#x27;SRID=4326;POINT(0 49)&#x27;</span>);<br><br></code></pre></td></tr></table></figure><blockquote><p>地理坐标最常见的SRID是<strong>4326（WGS84地理坐标系统）</strong>，对应于”<strong>WGS84球体</strong>上的<strong>经度</strong>/<strong>纬度</strong>“</p></blockquote><ul><li>添加空间索引</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> geographies_geog_idx <span class="hljs-keyword">on</span> <span class="hljs-string">&quot;global_points&quot;</span> <span class="hljs-keyword">using</span> GIST (geog);<br></code></pre></td></tr></table></figure><h3 id="PostGIS-常用函数"><a href="#PostGIS-常用函数" class="headerlink" title="PostGIS 常用函数"></a>PostGIS 常用函数</h3><ul><li>求一个几何对象在一定范围内(KM)内的所有几何对象</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 下两种等效，分别是通过经纬度和转换后的值进行查询</span><br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> erp_user <span class="hljs-keyword">where</span> ST_DWithin(geog, ST_SetSRID(ST_Point(<span class="hljs-number">41.6685744</span>, <span class="hljs-number">-0.884504</span>), <span class="hljs-number">4326</span>)::geography, <span class="hljs-number">1000</span>);<br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> erp_user <span class="hljs-keyword">where</span> ST_DWithin(geog, <span class="hljs-string">&#x27;0101000020E61000003B962D48E9CB4440A639C31E24D5EDBF&#x27;</span>, <span class="hljs-number">1000</span>);<br><span class="hljs-comment">-- 下面这种写法也能实现</span><br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> erp_user <span class="hljs-keyword">where</span> ST_Distance(geog, <span class="hljs-string">&#x27;0101000020E61000003B962D48E9CB4440A639C31E24D5EDBF&#x27;</span>) &lt;= <span class="hljs-number">1000</span><br></code></pre></td></tr></table></figure><blockquote><p>ST_DWithin: 如果两个几何对象间距离在给定值范围内，则返回true</p></blockquote><ul><li>求两个几何对象的距离</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> ST_Distance(ST_SetSRID(ST_Point(<span class="hljs-number">41.6685744</span>, <span class="hljs-number">-0.885504</span>), <span class="hljs-number">4326</span>)::geography,  <br>                   ST_SetSRID(ST_Point(<span class="hljs-number">41.6685744</span>, <span class="hljs-number">-0.884504</span>), <span class="hljs-number">4326</span>)::geography)<br></code></pre></td></tr></table></figure><h3 id="PostGIS-ORM"><a href="#PostGIS-ORM" class="headerlink" title="PostGIS ORM"></a>PostGIS ORM</h3><p>这里我们使用sqlalchemy</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># model.py</span><br><span class="hljs-keyword">from</span> geoalchemy2 <span class="hljs-keyword">import</span> Geography<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ERPUser</span>(<span class="hljs-params">BaseModel, db.Model</span>):</span><br>    geog_info = db.Column(db.JSON, comment=<span class="hljs-string">&quot;谷歌地址解析数据&quot;</span>)<br>    geog = db.Column(Geography(geometry_type=<span class="hljs-string">&#x27;POINT&#x27;</span>, srid=<span class="hljs-number">4326</span>), comment=<span class="hljs-string">&quot;Geography点位&quot;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">from sqlalchemy import func, text<br><br>ERPUser.query.filter_by(name=&#x27;张三&#x27;).update(&#123;&quot;geog&quot;:  text(&quot;&#x27;SRID=4326;POINT(-110 30)&#x27;&quot;)&#125;, synchronize_session=False)<br></code></pre></td></tr></table></figure><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul><li><a href="https://zhuanlan.zhihu.com/c_1253365661696491520">PostGIS教程系列</a></li><li><a href="http://postgis.net/docs/manual-3.0/PostGIS_Special_Functions_Index.html#PostGIS_GeographyFunctions">官方GeographyFunctions</a></li><li><a href="https://blog.csdn.net/xlxxcc/article/details/65629541">PostGIS 常用函数中文介绍说明</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>PostGIS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pgsql</tag>
      
      <tag>postgis</tag>
      
      <tag>gis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Snowflake算法</title>
    <link href="/Myblog/2020/08/18/Snowflake%E7%AE%97%E6%B3%95/"/>
    <url>/Myblog/2020/08/18/Snowflake%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h3 id="Snowflake介绍"><a href="#Snowflake介绍" class="headerlink" title="Snowflake介绍"></a>Snowflake介绍</h3><p>snowflake算法来源于Twitter，算法的特性是有序、唯一，并且要求高性能，低延迟（每台机器每秒至少生成10k条数据，并且响应时间在2ms以内），要在分布式环境（多集群，跨机房）下使用。</p><p>SnowFlake所生成的ID一共分成四部分：</p><p><img src="https://stellae.gitee.io/myblog/images/images/43566875433546576435.png"></p><p><strong>1.第一位</strong></p><p>占用1bit，其值始终是0，没有实际作用。</p><p><strong>2.时间戳</strong></p><p>占用41bit，精确到毫秒，总共可以容纳约140年的时间。</p><p><strong>3.工作机器id</strong></p><p>占用10bit，其中高位5bit是数据中心ID（datacenterId），低位5bit是工作节点ID（workerId），做多可以容纳1024个节点。</p><p><strong>4.序列号</strong></p><p>占用12bit，这个值在同一毫秒同一节点上从0开始不断累加，最多可以累加到4095。</p><p>SnowFlake算法在同一毫秒内最多可以生成多少个全局唯一ID呢？只需要做一个简单的乘法：</p><p>同一毫秒的ID数量 =&gt; <code>1024 X 4096 = 4194304</code>，这个数字在绝大多数并发场景下都是够用的。</p><h3 id="SnowFlake算法的优点"><a href="#SnowFlake算法的优点" class="headerlink" title="SnowFlake算法的优点"></a>SnowFlake算法的优点</h3><p>1.生成ID时不依赖于DB，完全在内存生成，高性能高可用。</p><p>2.ID呈趋势递增，后续插入索引树的时候性能较好。</p><h3 id="SnowFlake算法的缺点"><a href="#SnowFlake算法的缺点" class="headerlink" title="SnowFlake算法的缺点"></a>SnowFlake算法的缺点</h3><p>依赖于系统时钟的一致性。如果某台机器的系统时钟回拨，有可能造成ID冲突，或者ID乱序</p><h3 id="SQL实现"><a href="#SQL实现" class="headerlink" title="SQL实现"></a>SQL实现</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> global_id_sequence;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> id_generator(<span class="hljs-keyword">OUT</span> <span class="hljs-keyword">result</span> <span class="hljs-built_in">bigint</span>) <span class="hljs-keyword">AS</span> $$<br><span class="hljs-keyword">DECLARE</span><br>    our_epoch <span class="hljs-built_in">bigint</span> := <span class="hljs-number">1314220021721</span>;<br>    seq_id bigint;<br>    now_millis bigint;<br>    <span class="hljs-comment">-- the id of this DB shard, must be set for each</span><br>    <span class="hljs-comment">-- schema shard you have - you could pass this as a parameter too</span><br>    shard_id int := 1;<br><span class="hljs-keyword">BEGIN</span><br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">nextval</span>(<span class="hljs-string">&#x27;global_id_sequence&#x27;</span>) % <span class="hljs-number">1024</span> <span class="hljs-keyword">INTO</span> seq_id;<br><br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">FLOOR</span>(<span class="hljs-keyword">EXTRACT</span>(EPOCH <span class="hljs-keyword">FROM</span> clock_timestamp()) * <span class="hljs-number">1000</span>) <span class="hljs-keyword">INTO</span> now_millis;<br>    result := (now_millis - our_epoch) &lt;&lt; 23;<br>    result := result | (shard_id &lt;&lt; 10);<br>    result := result | (seq_id);<br>    <span class="hljs-comment">-- result := result::text;</span><br><span class="hljs-keyword">END</span>;<br>$$ LANGUAGE PLPGSQL;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">users</span>(<br>  <span class="hljs-keyword">id</span> <span class="hljs-built_in">bigint</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> id_generator(),<br>  email <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">unique</span>,<br>  <span class="hljs-keyword">first</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),<br>  <span class="hljs-keyword">last</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>)<br>)<br></code></pre></td></tr></table></figure><h3 id="Python实现"><a href="#Python实现" class="headerlink" title="Python实现"></a>Python实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><br><br><span class="hljs-comment"># 64位ID的划分</span><br>WORKER_ID_BITS = <span class="hljs-number">5</span><br>DATACENTER_ID_BITS = <span class="hljs-number">5</span><br>SEQUENCE_BITS = <span class="hljs-number">12</span><br><br><span class="hljs-comment"># 最大取值计算</span><br>MAX_WORKER_ID = <span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; WORKER_ID_BITS)  <span class="hljs-comment"># 2**5-1 0b11111</span><br>MAX_DATACENTER_ID = <span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; DATACENTER_ID_BITS)<br><br><span class="hljs-comment"># 移位偏移计算</span><br>WOKER_ID_SHIFT = SEQUENCE_BITS<br>DATACENTER_ID_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS<br>TIMESTAMP_LEFT_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS + DATACENTER_ID_BITS<br><br><span class="hljs-comment"># 序号循环掩码</span><br>SEQUENCE_MASK = <span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; SEQUENCE_BITS)<br><br><span class="hljs-comment"># Twitter元年时间戳</span><br>TWEPOCH = <span class="hljs-number">1288834974657</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvalidSystemClock</span>(<span class="hljs-params">Exception</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    时钟回拨异常</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IdWorker</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    用于生成IDs</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, datacenter_id=<span class="hljs-number">1</span>, worker_id=<span class="hljs-number">1</span>, sequence=<span class="hljs-number">0</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        初始化</span><br><span class="hljs-string">        :param datacenter_id: 数据中心（机器区域）ID</span><br><span class="hljs-string">        :param worker_id: 机器ID</span><br><span class="hljs-string">        :param sequence: 序列号</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># sanity check</span><br>        <span class="hljs-keyword">if</span> worker_id &gt; MAX_WORKER_ID <span class="hljs-keyword">or</span> worker_id &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;worker_id值越界&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> datacenter_id &gt; MAX_DATACENTER_ID <span class="hljs-keyword">or</span> datacenter_id &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;datacenter_id值越界&#x27;</span>)<br><br>        self.worker_id = worker_id<br>        self.datacenter_id = datacenter_id<br>        self.sequence = sequence<br><br>        self.last_timestamp = <span class="hljs-number">-1</span>  <span class="hljs-comment"># 上次计算的时间戳</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_gen_timestamp</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成整数时间戳</span><br><span class="hljs-string">        :return:int timestamp</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> int(time.time() * <span class="hljs-number">1000</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_id</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取新ID</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        timestamp = self._gen_timestamp()<br><br>        <span class="hljs-comment"># 时钟回拨</span><br>        <span class="hljs-keyword">if</span> timestamp &lt; self.last_timestamp:<br>            print(<span class="hljs-string">&#x27;clock is moving backwards. Rejecting requests until &#123;&#125;&#x27;</span>.format(self.last_timestamp))<br>            <span class="hljs-keyword">raise</span> InvalidSystemClock<br><br>        <span class="hljs-keyword">if</span> timestamp == self.last_timestamp:<br>            self.sequence = (self.sequence + <span class="hljs-number">1</span>) &amp; SEQUENCE_MASK<br>            <span class="hljs-keyword">if</span> self.sequence == <span class="hljs-number">0</span>:<br>                timestamp = self._til_next_millis(self.last_timestamp)<br>        <span class="hljs-keyword">else</span>:<br>            self.sequence = <span class="hljs-number">0</span><br><br>        self.last_timestamp = timestamp<br><br>        new_id = ((timestamp - TWEPOCH) &lt;&lt; TIMESTAMP_LEFT_SHIFT) | (self.datacenter_id &lt;&lt; DATACENTER_ID_SHIFT) | \<br>                 (self.worker_id &lt;&lt; WOKER_ID_SHIFT) | self.sequence<br>        <span class="hljs-keyword">return</span> str(new_id)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_til_next_millis</span>(<span class="hljs-params">self, last_timestamp</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        等到下一毫秒</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        timestamp = self._gen_timestamp()<br>        <span class="hljs-keyword">while</span> timestamp &lt;= last_timestamp:<br>            timestamp = self._gen_timestamp()<br>        <span class="hljs-keyword">return</span> timestamp<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    snowflake_id = IdWorker().get_id()<br>    print(type(snowflake_id), snowflake_id)<br><br></code></pre></td></tr></table></figure><h3 id="Golang实现"><a href="#Golang实现" class="headerlink" title="Golang实现"></a>Golang实现</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> application<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;sync&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>    epoch             = <span class="hljs-keyword">int64</span>(<span class="hljs-number">1577808000000</span>)                           <span class="hljs-comment">// 设置起始时间(时间戳/毫秒)：2020-01-01 00:00:00，有效期69年</span><br>    timestampBits     = <span class="hljs-keyword">uint</span>(<span class="hljs-number">41</span>)                                       <span class="hljs-comment">// 时间戳占用位数</span><br>    dataCenterIdBits  = <span class="hljs-keyword">uint</span>(<span class="hljs-number">2</span>)                                        <span class="hljs-comment">// 数据中心id所占位数</span><br>    workerIdBits      = <span class="hljs-keyword">uint</span>(<span class="hljs-number">7</span>)                                        <span class="hljs-comment">// 机器id所占位数</span><br>    sequenceBits      = <span class="hljs-keyword">uint</span>(<span class="hljs-number">12</span>)                                       <span class="hljs-comment">// 序列所占的位数</span><br>    timestampMax      = <span class="hljs-keyword">int64</span>(<span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; timestampBits))              <span class="hljs-comment">// 时间戳最大值</span><br>    dataCenterIdMax   = <span class="hljs-keyword">int64</span>(<span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; dataCenterIdBits))           <span class="hljs-comment">// 支持的最大数据中心id数量</span><br>    workerIdMax       = <span class="hljs-keyword">int64</span>(<span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; workerIdBits))               <span class="hljs-comment">// 支持的最大机器id数量</span><br>    sequenceMask      = <span class="hljs-keyword">int64</span>(<span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; sequenceBits))               <span class="hljs-comment">// 支持的最大序列id数量</span><br>    workerIdShift     = sequenceBits                                   <span class="hljs-comment">// 机器id左移位数</span><br>    dataCenterIdShift = sequenceBits + workerIdBits                    <span class="hljs-comment">// 数据中心id左移位数</span><br>    timestampShift    = sequenceBits + workerIdBits + dataCenterIdBits <span class="hljs-comment">// 时间戳左移位数</span><br>)<br><br><span class="hljs-keyword">type</span> Snowflake <span class="hljs-keyword">struct</span> &#123;<br>    sync.Mutex         <span class="hljs-comment">// 锁</span><br>    DataCenterId <span class="hljs-keyword">int64</span> <span class="hljs-comment">// 数据中心机房id</span><br>    WorkerId     <span class="hljs-keyword">int64</span> <span class="hljs-comment">// 工作节点</span><br>    Sequence     <span class="hljs-keyword">int64</span> <span class="hljs-comment">// 序列号</span><br>    Timestamp    <span class="hljs-keyword">int64</span> <span class="hljs-comment">// 时间戳 ，毫秒</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Snowflake)</span> <span class="hljs-title">NextVal</span><span class="hljs-params">()</span> <span class="hljs-title">int64</span></span> &#123;<br>    s.Lock()<br>    now := time.Now().UnixNano() / <span class="hljs-number">1e6</span> <span class="hljs-comment">// 转毫秒</span><br>    <span class="hljs-keyword">if</span> s.Timestamp == now &#123;<br>        <span class="hljs-comment">// 当同一时间戳（精度：毫秒）下多次生成id会增加序列号</span><br>        s.Sequence = (s.Sequence + <span class="hljs-number">1</span>) &amp; sequenceMask<br>        <span class="hljs-keyword">if</span> s.Sequence == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">// 如果当前序列超出12bit长度，则需要等待下一毫秒</span><br>            <span class="hljs-comment">// 下一毫秒将使用sequence:0</span><br>            <span class="hljs-keyword">for</span> now &lt;= s.Timestamp &#123;<br>                now = time.Now().UnixNano() / <span class="hljs-number">1e6</span><br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 不同时间戳（精度：毫秒）下直接使用序列号：0</span><br>        s.Sequence = <span class="hljs-number">0</span><br>    &#125;<br>    t := now - epoch<br>    <span class="hljs-keyword">if</span> t &gt; timestampMax &#123;<br>        s.Unlock()<br>        fmt.Printf(<span class="hljs-string">&quot;epoch must be between 0 and %d&quot;</span>, timestampMax<span class="hljs-number">-1</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    s.Timestamp = now<br>    r := <span class="hljs-keyword">int64</span>((t)&lt;&lt;timestampShift | (s.DataCenterId &lt;&lt; dataCenterIdShift) | (s.WorkerId &lt;&lt; workerIdShift) | (s.Sequence))<br>    s.Unlock()<br>    <span class="hljs-keyword">return</span> r<br>&#125;<br></code></pre></td></tr></table></figure><p>单元测试</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> unit<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;sync&quot;</span><br>    <span class="hljs-string">&quot;testing&quot;</span><br>    <span class="hljs-string">&quot;useful-tools-golang/application&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSnowflake</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    snow1 := application.Snowflake&#123;<br>        WorkerId:     <span class="hljs-number">1</span>,<br>        DataCenterId: <span class="hljs-number">4</span>,<br>    &#125;<br>    snow2 := application.Snowflake&#123;<br>        WorkerId:     <span class="hljs-number">1</span>,<br>        DataCenterId: <span class="hljs-number">5</span>,<br>    &#125;<br>    <span class="hljs-keyword">var</span> wg = sync.WaitGroup&#123;&#125;<br>    wg.Add(<span class="hljs-number">20</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++ &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            t.Log(snow1.NextVal())<br>            t.Log(snow2.NextVal())<br>            wg.Done()<br>        &#125;()<br>    &#125;<br>    wg.Wait()<br>&#125;<br><span class="hljs-comment">// 输出格式类似：206676807726927873</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Snowflake</category>
      
    </categories>
    
    
    <tags>
      
      <tag>snowflake</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hasura-基于PostgreSQL的GraphQL引擎</title>
    <link href="/Myblog/2020/08/05/Hasura-%E5%9F%BA%E4%BA%8EPostgreSQL%E7%9A%84GraphQL%E5%BC%95%E6%93%8E/"/>
    <url>/Myblog/2020/08/05/Hasura-%E5%9F%BA%E4%BA%8EPostgreSQL%E7%9A%84GraphQL%E5%BC%95%E6%93%8E/</url>
    
    <content type="html"><![CDATA[<h3 id="Hasura简介"><a href="#Hasura简介" class="headerlink" title="Hasura简介"></a>Hasura简介</h3><p>Hasura GraphQL引擎是一种快速的GraphQL服务器，通过Postgres为您提供即时，实时的GraphQL API，并具有针对数据库事件的<a href="https://github.com/hasura/graphql-engine/blob/master/event-triggers.md">webhook触发器</a>和业务逻辑的<a href="https://github.com/hasura/graphql-engine/blob/master/remote-schemas.md">远程模式</a>。</p><p>Hasura可帮助您构建由Postgres支持的GraphQL应用程序，或使用Postgres将其逐步移至GraphQL以用于现有应用程序。</p><p>如果你还不知道什么是GraphQL，可以去看下我的另外一片文章<a href="https://stellae.gitee.io/myblog/2020/08/05/%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8GraphQL/">《为什么要使用GraphQL》</a></p><h3 id="Hasura特性"><a href="#Hasura特性" class="headerlink" title="Hasura特性"></a>Hasura特性</h3><p>Hasura具有许多功能，可帮助您快速采用GraphQL和<a href="http://3factor.app/">3factor</a>架构：</p><ul><li><strong>进行强大的查询</strong>：内置过滤，分页，模式搜索，批量插入，更新，删除突变</li><li><strong>实时</strong>：使用订阅将任何GraphQL查询转换为实时查询</li><li><strong>合并远程模式</strong>：通过单个GraphQL Engine端点访问业务逻辑的自定义GraphQL模式。<a href="https://github.com/hasura/graphql-engine/blob/master/remote-schemas.md">阅读更多</a>。</li><li><strong>触发webhooks或无服务器功能</strong>：在Postgres上插入/更新/删除事件（<a href="https://github.com/hasura/graphql-engine/blob/master/event-triggers.md">了解更多</a>）</li><li><strong>与现有的实时数据库兼容</strong>：将其指向现有的Postgres数据库，以立即获得可立即使用的GraphQL API</li><li><strong>细粒度的访问控制</strong>：与您的auth系统集成的动态访问控制（例如：auth0，firebase-auth）</li><li><strong>高性能和低占用空间</strong>：〜15MB docker映像；〜50MB RAM @ 1000请求/秒; 多核意识</li><li><strong>管理员界面和迁移</strong>：管理员界面和受Rails启发的架构迁移</li><li><strong>Postgres❤️</strong>：支持Postgres类型（PostGIS /地理定位等），将视图转换为<em>图形</em>，触发具有突变的存储函数或过程</li></ul><h3 id="Hasura常用命令"><a href="#Hasura常用命令" class="headerlink" title="Hasura常用命令"></a>Hasura常用命令</h3><ul><li>打开hasura控制台</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hasura console<br></code></pre></td></tr></table></figure><ul><li>查看migrate状态</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hasura migrate status<br></code></pre></td></tr></table></figure><ul><li>升级migrate</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hasura migrate appply<br></code></pre></td></tr></table></figure><ul><li>更新metadata</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hasura metadata apply<br></code></pre></td></tr></table></figure><ul><li>创建migrate</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hasura migrate create &lt;migrate base name&gt;<br></code></pre></td></tr></table></figure><ul><li>回退migrate版本</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hasura migrate apply --down &lt;num&gt;<br></code></pre></td></tr></table></figure><p><strong>远程操作：<code>&lt;hasura command&gt; --endpoint &lt;url&gt; --admin-secret &lt;key&gt;</code></strong></p><p><a href="https://hasura.io/docs/1.0/graphql/manual/hasura-cli/index.html">官方命令说明</a></p><h3 id="相关外链"><a href="#相关外链" class="headerlink" title="相关外链"></a>相关外链</h3><ul><li><a href="https://graphql.org/">GraphQL官方文档</a></li><li><a href="https://hasura.io/docs/1.0/graphql/manual/queries/index.html">GraphQL语法</a></li><li><a href="https://hasura.io/docs/1.0/graphql/manual/index.html">Hasura官方文档</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>GraphQL</category>
      
      <category>Hasura</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pgsql</tag>
      
      <tag>hasura</tag>
      
      <tag>graphql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>为什么要使用GraphQL</title>
    <link href="/Myblog/2020/08/05/%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8GraphQL/"/>
    <url>/Myblog/2020/08/05/%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8GraphQL/</url>
    
    <content type="html"><![CDATA[<h3 id="什么是GraphQL"><a href="#什么是GraphQL" class="headerlink" title="什么是GraphQL"></a>什么是GraphQL</h3><p>什么是 GraphQL？GraphQL是由 Facebook 在 2012 年创立的一门开源<strong>查询语言</strong>。</p><p>在它开源之前，Facebook 就已经在内部移动端应用中使用过。为什么选用移动应用？GraphQL 作为通用的 REST 架构的替代方案而被开发出来，它允许客户端只请求其需要的数据——不多也不少，一切在客户端的主导下。</p><p>在一个 RESTful 架构下，因为后端开发人员定义在各个 URL 的资源上返回的数据，而不是前端开发人员来提出数据需求，使得按需获取数据会非常困难。经常前端需要请求一个资源中所有的信息，即便只需要其中的一部分数据。这个问题被称之为过度获取（overfetching）。最恶劣的场景下，一个客户端应用不得不请求多个而不是一个资源，这通常会发起多个网络请求。这不仅会造成过度获取的问题，也会造成瀑布式的网络请求（waterfall network requests）。</p><p>那么将像 GraphQL 之类的查询语言，不仅在服务端程使用，也应用到客户端的话，客户端来决定需要什么数据，这样只需要发送一个请求到服务端。在 Facebook 的 GraphQL 移动端开发场景下，这极大地减少了忘了请求，因为 GraphQL 一次只需要发起一个请求，并且传输中数据数量也减少了。</p><p>Facebook 开源了 GraphQL 标准和其 JavaScript 版本的实现。后来主要编程语言也实现了标准。此外，GraphQL 周边的生态不仅仅水平上扩展了不同语言的实现，并且还出现了在 GraphQL 基础上实现了类库（比如 Apollo 和 Relay）。</p><p>一个 GraphQL 操作可以是一个查询（query（读操作））、修改（mutation（写操作））以及订阅（subscription（持续读操作））。这些操作中每一种都只是根据 GraphQL 标准构造的一段字符串而已。一旦一个 GraphQL 操作从前端应用到达后端应用，首先会在后端解释整个 GraphQL schema，然后再为前端解析相关的数据。GraphQL 并没有要求网络层选型（通常是 HTTP），也没有要求传输数据格式（通常是 JSON）。甚至没有要求应用架构（通常是前后端分离架构）。它只是一个查询语言。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs text">// GraphQL 查询<br>author(id: &quot;7&quot;) &#123;<br>  id<br>  name<br>  avatarUrl<br>  articles(limit: 2) &#123;<br>    name<br>    urlSlug<br>  &#125;<br>&#125;<br><br>// GraphQL 查询结果<br>&#123;<br>  &quot;data&quot;: &#123;<br>    &quot;author&quot;: &#123;<br>      &quot;id&quot;: &quot;7&quot;,<br>      &quot;name&quot;: &quot;Robin Wieruch&quot;,<br>      &quot;avatarUrl&quot;: &quot;https://domain.com/authors/7&quot;,<br>      &quot;articles&quot;: [<br>        &#123;<br>          &quot;name&quot;: &quot;The Road to learn React&quot;,<br>          &quot;urlSlug&quot;: &quot;the-road-to-learn-react&quot;<br>        &#125;,<br>        &#123;<br>          &quot;name&quot;: &quot;React Testing Tutorial&quot;,<br>          &quot;urlSlug&quot;: &quot;react-testing-tutorial&quot;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>如你所见，一个查询请求了多个资源（作者（author）、文章（article）），在 GraphQL 中被称为字段（fileds），及时 GraphQL scheme 提供了更多是数据（比如文章中的描述（description）和发布时间（releaseDate） ），我们只会拿到这些字段的一个子集（文章中的名称（name）和 urlSlug）。相对地，在 RESTful 架构中，需要至少两个连续请求分别获取作者实体和它的文章，GraphQL 只需要一个查询就可以做到。此外，查询只需要选择必要的字段即可，而不是整个数据实体。</p><p>这就是 GraphQL 的基本介绍。服务端提供了定义了可用数据的层级关系和类型的 GraphQL schema，客户端只用查询其需要的数据即可。</p><h3 id="GraphQL的优点"><a href="#GraphQL的优点" class="headerlink" title="GraphQL的优点"></a>GraphQL的优点</h3><h4 id="声明式地数据获取"><a href="#声明式地数据获取" class="headerlink" title="声明式地数据获取"></a>声明式地数据获取</h4><p>如之前看到的那样，GraphQL 在使用查询语句式，使用声明式的方式获取数据。客户端在一个查询请求中，选择需要的数据和相关的字段实体。客户端根据其 UI 来决定需要的字段。你可以说这是 UI 驱动地数据获取。比方说，Airbnb 使用 GraphQL的例子，在 Airbnb 中的一个搜索界面，经常需要搜索房屋的住房体验和其他相关的一些信息，为了能在一个请求中检索所有的数据，一个 GraphQL 查询会根据 UI 选择数据中的一部分达到完美的匹配。毕竟，GraphQL 提供了极佳的关注点分离方式：客户端知道它需要什么数据，服务端知道数据的结构，以及如何从一些数据源（比如数据库、微服务、第三方 API）中拉取数据。</p><h4 id="在-GraphQL-中没有过度获取"><a href="#在-GraphQL-中没有过度获取" class="headerlink" title="在 GraphQL 中没有过度获取"></a>在 GraphQL 中没有过度获取</h4><p>使用 GraphQL 不会存在过度获取的现象。使用与 Web 客户端公用的一个 RESTful API，一个移动客户端很可能会获取过多的数据，但是使用同样的 GraphQL API，移动客户端可以选择和 Web 客户端不同的数据字段。因此移动客户端能减少获取的信息，因为相对于 Web 应用的更大的屏幕，小屏幕上可能显示不了那么多信息。GraphQL 通过最开始按客户端需求选择数据，减少了传输数据的大小。</p><h4 id="在-React、Angular、Node-和-Co-中的-GraphQL"><a href="#在-React、Angular、Node-和-Co-中的-GraphQL" class="headerlink" title="在 React、Angular、Node 和 Co 中的 GraphQL"></a>在 React、Angular、Node 和 Co 中的 GraphQL</h4><p>GraphQL 并不只让 React 的开发者激动。即便 Facebook 只展示了一个使用 React 的客户端程序，但是它和任何前端或者后端的解决方案是解耦的，无关的。GraphQL 的相关实现是用 JavaScript 写的，因此 GraphQL 可以用在 Angular、Vue、Express、Hapi、Koa 以及任何其他客户端或者服务端的 JavaScript 类库上，并且这还只是在 JavaScript 的生态中。GraphQL 模仿了让 REST 这么流行的一个特点：一个两个实体（比如服务端和客户端）语言无关的接口（查询语言）。这样你可以在任意编程语言中通过使用一个 GraphQL 标准的实现使用 GraphQL 了。</p><h4 id="单一数据源（Single-Source-of-Truth）"><a href="#单一数据源（Single-Source-of-Truth）" class="headerlink" title="单一数据源（Single Source of Truth）"></a>单一数据源（Single Source of Truth）</h4><p>在 GraphQL 应用中存在者单一数据源：GraphQL schema。它提供了一个所有可用数据检索的源头。鉴于 GraphQL 的 schema 通常会在服务端定义，客户端可以基于 schema 读取（query）和写入（mutation）数据。因此，服务端提供了所有可用的信息，客户端只需要执行 GraphQL 查询获取部分数据，或者通过 GraphQL 修改变更部分数据。</p><h4 id="GraphQL-拥抱趋势"><a href="#GraphQL-拥抱趋势" class="headerlink" title="GraphQL 拥抱趋势"></a>GraphQL 拥抱趋势</h4><p>GraphQL 适应了现在应用构建的变化趋势。你可能只有一个后端应用，但是可能会有多个依赖同一个后端应用的客户端（web 端、移动端、智能手表等等…）。因此 GraphQL 不仅能在前后端进行沟通，也能满足每一个客户端的具体要求（比如网络使用的要求、数据嵌套的要求、按需获取数据的要求），而不需要为每一个客户端定制不同的 API。</p><p>另外一方面，在服务端，可能不止一个后端应用，而是一个微服务集群来提供各自具体的功能。这简直是 GraphQL 的完美使用场景，它将所有的功能编织汇总到一个 GraphQL schema 汇总。</p><h4 id="拼接-GraphQL-Schema"><a href="#拼接-GraphQL-Schema" class="headerlink" title="拼接 GraphQL Schema"></a>拼接 GraphQL Schema</h4><p>拼接 Schema 使得多个 schema 可以聚合成一个。什么时候你需要考虑这个？考虑一下后端的微服务架构。每个微服务处理特定域的业务逻辑和数据。因此，每个微服务都可以定义自己的GraphQL架构。之后，使用 Schema 拼接将所有 Schema 聚合到一个可以被客户端访问的 Schema 中。最终，每个微服务都可以拥有自己的 GraphQL 端点，而一个 GraphQL API网关将所有 schema 合并到一个全局 schema 中，以便使得客户端可以使用。</p><h4 id="GraphQL-自省（Introspection）"><a href="#GraphQL-自省（Introspection）" class="headerlink" title="GraphQL 自省（Introspection）"></a>GraphQL 自省（Introspection）</h4><p>GraphQL 自省允许通过 GraphQL API 检索 GraphQL schema。因为 schema 包含了包含了 GraphQL API 可以获得的所有数据信息，本身就是一份完美的自动生成的 API 文档。不仅仅是 API 的文档，也允许客户端通过mock GraphQL 的 schema 达到测试的目的，或者使用 schema 拼接的接口检索多个微服务的 schema。</p><h4 id="强类型的-GraphQL"><a href="#强类型的-GraphQL" class="headerlink" title="强类型的 GraphQL"></a>强类型的 GraphQL</h4><p>GraphQL 是一门强类型的查询语言，因为它是通过 GraphQL Schema Definition Language（SDL）书写的。因为有了强类型，它就拥有了强类型编程语言一样的好处：更不容出错、可以在编辑期验证并且支持编辑器智能补全和验证相关的集成。</p><h4 id="GraphQL-版本化"><a href="#GraphQL-版本化" class="headerlink" title="GraphQL 版本化"></a>GraphQL 版本化</h4><p>在 GraphQL 中没有 API 版本的说法。在 REST 中，通常会提供一个 API 的多个版本（比如 <code>http://api.domain.com/v1/</code>、<code>http://api.domain.com/v2/</code>），因为随着时间过去，可能资源的结构也会发生变化。在 GraphQL 中，API 废弃可以做到字段级别，因此当一个客户端减少到一个废弃的字段，会得到一个废弃相关的警告。当没有客户端再使用这个废弃知道后，就可以从 schema 汇总移除这个字段了。这让一个 GraphQL API 不需要使用版本化的方式来演进。</p><h4 id="成长中的-GraphQL-生态"><a href="#成长中的-GraphQL-生态" class="headerlink" title="成长中的 GraphQL 生态"></a>成长中的 GraphQL 生态</h4><p>GraphQL 的生态正在发展壮大。不仅仅是 GraphQL 天然的强类型特性适宜集成编辑器和 IDE 的演进，GraphQL 相关的应用也在演进。你可能记得在处理 REST API 的时候的 <a href="https://www.getpostman.com/">Postman</a>，现在有 <a href="https://github.com/graphql/graphiql">GraphiQL</a> 或者 <a href="https://github.com/prismagraphql/graphql-playground">GraphQL Playground</a>可以调试你的应用。你也可以找到如 <a href="https://www.gatsbyjs.org/">Gatsby.js</a> 这样的使用 GraphQL 的 React 静态页面生成器。比如，使用 Gatsby.js 你可以在构建时期通过一个 GraphQL 来提供你的博客内容来源。你可能还听说过内容管理系统（CMS）（比如 <a href="https://graphcms.com/">GraphCMS</a>）通过 GraphQL API 来提供（博客）内容。不仅在技术领域有所演进，这还有很多 GraphQL 相关 大会、聚会和社区不断涌现，并且也可以通过一些 newsletters 和 podcast 了解到 GraphQL。</p><h3 id="GraphQL的缺点"><a href="#GraphQL的缺点" class="headerlink" title="GraphQL的缺点"></a>GraphQL的缺点</h3><h4 id="GraphQL-查询的复杂性"><a href="#GraphQL-查询的复杂性" class="headerlink" title="GraphQL 查询的复杂性"></a>GraphQL 查询的复杂性</h4><p>人们经常错误地认为 GraphQL 就是在后端替代了数据库。并不是这样的，GraphQL 仅仅是一个查询语言。在服务端，一个查询需要解析数据，因此一个 GraphQL 相关实现常常需要执行数据库访问，但 GraphQL 其实不关心这些。还有，GraphQL 在你需要在一个查询中获取多个字段（作者、文章、评论）的时候，它对性能瓶颈没有任何帮助。无论使用 RESTful 架构还是 GraphQL，不同资源/字段仍然需要从一个数据源去获取。</p><p>因此当一个客户端需要一次查询很多嵌套字段时，前端开发通常不能很清楚他正在通过服务端访问不同的数据库获取过多的数据。这需要一种机制（比如最深查询深度、查询复杂度权重、避免递归、持久化查询）来制止来自客户端的（性能）昂贵的查询。</p><h4 id="查询频率限制"><a href="#查询频率限制" class="headerlink" title="查询频率限制"></a>查询频率限制</h4><p>另一个问题是频率限制，在 REST 中，可以简单的声明”一天之中，我们只允许请求这么多资源“，在一个独立的 GraphQL 操作中很难做到这一点，因为任何操作的开销都可以是廉价的或者昂贵的。这就是那些有着公共 GraphQL API 的公司提出的特定速率限制计算，通常可以归结为前面提到的最大查询深度和查询复杂度权重问题。</p><h4 id="GraphQL-缓存"><a href="#GraphQL-缓存" class="headerlink" title="GraphQL 缓存"></a>GraphQL 缓存</h4><p>一个简单缓存，相比 REST，在 GraphQL 中实现会变得极其复杂。在 REST 中你通过 URL 访问资源，因此你可以在资源级别实现缓存，因为资源使用 URL 作为其标识符。在 GraphQL 中就复杂了，因为即便它操作的是同一个实体，每个查询都各不相同。比如，一个查询中，你可能只会请求一个作者的名字，但是在另外一次查询中你可能也想知道他的电子邮箱地址。这就需要你有一个更加健全的机制中来确保字段级别的缓存，实现起来并不简单。不过，多数基于 GraphQL 构建的类库都提供了开箱即用的缓存机制。</p><h3 id="为什么不用REST"><a href="#为什么不用REST" class="headerlink" title="为什么不用REST"></a>为什么不用REST</h3><p>GraphQL 是通常用来连接客户端和服务端的 RESTful 架构的替代方案。在前面的内容中，你已经多次听到 REST 了，那么什么是使用 GraphQL 而不是 RESTful ，显而易见的好处呢？</p><p>因为 REST 提出通过 URL 来标识资源，最终常常会出现低效的连续请求。比方说，最开始你通过 id 来定位一个作者实体，然后你通过作者的 id 获取的某个信息来请求他所有的文章。在 GraphQL 中只需要一个请求就能办到，这是更加效率的。更进一步而言，如果你想只想获取作者的所有文章数据，而不关心作者的信息，GraphQL 允许只你选择你需要的信息。在 REST 中，你需要先获取作者的所有实体信息，即使你值关心被这个作者写的文章而已。因为过度获取这个问题，只有在使用 REST 才会出现，而 GraphQL 就不会。</p><p>现在客户端应用不适合 RESTful 的服务端应用了。比方说，在 Airbnb 平台上，获取搜索结果，它为你展示了房屋、住房体验以及其他相关信息。住房和住房体验在各自的 RESTful 资源中，那么你需要支持多个网络请求。当使用 GraphQL API，你只需要在一个 GraphQL 查询中一起获取所有需要的实体（比如住房和住房体验）或者嵌套的其他相关信息（比如作者的文章信息）。</p><p>最终 GraphQL 将数据有服务端主导返回什么数据变成了客户端决定需要什么什么。这就是一开始 GraphQL 被发明的原因，因为在 Facebook 的一个移动应用和他们的 web 应用需要的数据是不一样的。</p><p>总之，仍然有些场景下使用 REST 来沟通客户端和服务端是有价值的途径，通常应用是资源驱动，也不需要像 GraphQL 这些的查询语言提供的灵活能力。然而，我还是推荐你尝试使用 GraphQL 来开发你的下一个客户/服务端架构。</p><h3 id="相关外链"><a href="#相关外链" class="headerlink" title="相关外链"></a>相关外链</h3><ul><li><a href="https://graphql.org/">GraphQL官方文档</a></li><li><a href="https://hasura.io/docs/1.0/graphql/manual/queries/index.html">GraphQL语法</a></li><li><a href="https://graphql.org/code/#python">GraphQL的Python实现</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>GraphQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>graphql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Airflow任务调度框架</title>
    <link href="/Myblog/2020/06/30/Airflow%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6/"/>
    <url>/Myblog/2020/06/30/Airflow%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="Airflow是什么"><a href="#Airflow是什么" class="headerlink" title="Airflow是什么"></a>Airflow是什么</h3><p>Airflow 是 Airbnb 开源的一个用 Python 编写的调度工具。于 2014 年启动，2015 年春季开源，2016 年加入 Apache 软件基金会的孵化计划。</p><p>Airflow 通过 DAG 也即是有向非循环图来定义整个工作流，因而具有非常强大的表达能力。</p><p>在进一步介绍 Airflow 之前，我想先介绍一些在 Airflow 中常见的名词概念：</p><ul><li><p><strong>DAG</strong></p><p>DAG 意为有向无循环图，在 Airflow 中则定义了整个完整的作业。同一个 DAG 中的所有 Task 拥有相同的调度时间。</p></li><li><p><strong>Task</strong></p><p>Task 为 DAG 中具体的作业任务，它必须存在于某一个 DAG 之中。Task 在 DAG 中配置依赖关系，跨 DAG 的依赖是可行的，但是并不推荐。跨 DAG 依赖会导致 DAG 图的直观性降低，并给依赖管理带来麻烦。</p></li><li><p><strong>DAG Run</strong></p><p>当一个 DAG 满足它的调度时间，或者被外部触发时，就会产生一个 DAG Run。可以理解为由 DAG 实例化的实例。</p></li><li><p><strong>Task Instance</strong></p><p>当一个 Task 被调度启动时，就会产生一个 Task Instance。可以理解为由 Task 实例化的实例。</p></li></ul><h3 id="Airflow的服务构成"><a href="#Airflow的服务构成" class="headerlink" title="Airflow的服务构成"></a>Airflow的服务构成</h3><p>一个正常运行的 Airflow 系统一般由以下几个服务构成</p><ul><li><p><strong>WebServer</strong></p><p>Airflow 提供了一个可视化的 Web 界面。启动 WebServer 后，就可以在 Web 界面上查看定义好的 DAG 并监控及改变运行状况。也可以在 Web 界面中对一些变量进行配置。</p></li><li><p><strong>Worker</strong></p><p>一般来说我们用 Celery Worker 来执行具体的作业。Worker 可以部署在多台机器上，并可以分别设置接收的队列。当接收的队列中有作业任务时，Worker 就会接收这个作业任务，并开始执行。Airflow 会自动在每个部署 Worker 的机器上同时部署一个 Serve Logs 服务，这样我们就可以在 Web 界面上方便的浏览分散在不同机器上的作业日志了。</p></li><li><p><strong>Scheduler</strong></p><p>整个 Airflow 的调度由 Scheduler 负责发起，每隔一段时间 Scheduler 就会检查所有定义完成的 DAG 和定义在其中的作业，如果有符合运行条件的作业，Scheduler 就会发起相应的作业任务以供 Worker 接收。</p></li><li><p><strong>Flower</strong></p><p>Flower 提供了一个可视化界面以监控所有 Celery Worker 的运行状况。这个服务并不是必要的。</p></li></ul><h3 id="Airflow安装和使用"><a href="#Airflow安装和使用" class="headerlink" title="Airflow安装和使用"></a>Airflow安装和使用</h3><ul><li>安装</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install apache-airflow<br></code></pre></td></tr></table></figure><ul><li>设置airflow home</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">&gt;</span><span class="bash"> mkdir ~/airflow</span><br><span class="hljs-meta">&gt;</span><span class="bash"> <span class="hljs-built_in">export</span> AIRFLOW_HOME=~/airflow</span><br></code></pre></td></tr></table></figure><ul><li>初始化</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">airflow initdb<br></code></pre></td></tr></table></figure><blockquote><p>Airflow 在运行需要 Database 记录每一次跑过的 Task 的結果，所以接下来我們要初始化 Database，Airflow 预设使用 SQLite，之后我們也可以把 Database 变成 PostgreSQL 或是 MySQL 等等。</p></blockquote><ul><li>启动webserver</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">airflow webserver -p 8080<br></code></pre></td></tr></table></figure><ul><li>启动scheduler</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">airflow scheduler<br></code></pre></td></tr></table></figure><h3 id="Airflow自定义"><a href="#Airflow自定义" class="headerlink" title="Airflow自定义"></a>Airflow自定义</h3><h4 id="编写DAG1"><a href="#编写DAG1" class="headerlink" title="编写DAG1"></a>编写DAG1</h4><p>相同表结构进行数据同步</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta<br><span class="hljs-keyword">from</span> airflow <span class="hljs-keyword">import</span> DAG<br><span class="hljs-keyword">from</span> airflow.utils.dates <span class="hljs-keyword">import</span> days_ago<br><span class="hljs-keyword">from</span> airflow.models <span class="hljs-keyword">import</span> Variable<br><br><span class="hljs-keyword">import</span> sys<br>sys.path.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;/opt/bitnami/airflow/dags/git&quot;</span>)<br><span class="hljs-keyword">from</span> acme.operators.dwh_operators <span class="hljs-keyword">import</span> AuditOperator, PostgresToPostgresOperator<br><br><br><br>default_args = &#123;<br>    <span class="hljs-string">&#x27;owner&#x27;</span>: <span class="hljs-string">&#x27;XingChen&#x27;</span>, <span class="hljs-comment"># DAG 擁有者的名稱，如上一篇說明的，通常是負責實作這個 DAG 的人員名稱</span><br>    <span class="hljs-string">&#x27;depends_on_past&#x27;</span>: <span class="hljs-literal">False</span>, <span class="hljs-comment"># 每一次執行的 Task 是否會依賴於上次執行的 Task，如果是 True 的話，代表上次的 Task 如果執行失敗，這次的 Task 不会执行，而是放到trigger里面等待执行</span><br>    <span class="hljs-string">&#x27;start_date&#x27;</span>: datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">24</span>), <span class="hljs-comment">#  Task 從哪個日期後開始可以被 Scheduler 排入排程</span><br>  <span class="hljs-string">&#x27;start_data&#x27;</span>: days_ago(<span class="hljs-number">1</span>),   <span class="hljs-comment"># 两种都可以</span><br>    <span class="hljs-string">&#x27;email&#x27;</span>: [<span class="hljs-string">&#x27;airflow@example.com&#x27;</span>], <span class="hljs-comment"># 如果 Task 執行失敗的話，要寄信給哪些人的 email</span><br>    <span class="hljs-string">&#x27;email_on_failure&#x27;</span>: <span class="hljs-literal">False</span>, <span class="hljs-comment"># 如果 Task 執行失敗的話，是否寄信</span><br>    <span class="hljs-string">&#x27;email_on_retry&#x27;</span>: <span class="hljs-literal">False</span>, <span class="hljs-comment"># 如果 Task 重試的話，是否寄信</span><br>    <span class="hljs-string">&#x27;retries&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-comment"># 最多重試的次數</span><br>    <span class="hljs-string">&#x27;retry_delay&#x27;</span>: timedelta(minutes=<span class="hljs-number">5</span>), <span class="hljs-comment"># 每次重試中間的間隔</span><br>    <span class="hljs-comment"># &#x27;end_date&#x27;: datetime(2020, 2, 29), # Task 從哪個日期後，開始不被 Scheduler 放入排程</span><br>    <span class="hljs-comment"># &#x27;execution_timeout&#x27;: timedelta(seconds=300), # Task 執行時間的上限</span><br>    <span class="hljs-comment"># &#x27;on_failure_callback&#x27;: some_function, # Task 執行失敗時，呼叫的 function</span><br>    <span class="hljs-comment"># &#x27;on_success_callback&#x27;: some_other_function, # Task 執行成功時，呼叫的 function</span><br>    <span class="hljs-comment"># &#x27;on_retry_callback&#x27;: another_function, # Task 重試時，呼叫的 function</span><br>&#125;<br><br><br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">synchronize basic data of traditional media to internet db</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>tmpl_search_path = Variable.get(<span class="hljs-string">&quot;sql_path&quot;</span>)<br><br><br><span class="hljs-keyword">with</span> DAG(<br>    dag_id=<span class="hljs-string">&quot;hubble-internet-stage&quot;</span>,<br>    tags=[<span class="hljs-string">&quot;hubble-internet&quot;</span>],<br>    default_args=default_args,<br>    template_searchpath=tmpl_search_path,<br>    description=<span class="hljs-string">&quot;synchronize basic data of traditional media to internet db&quot;</span>,<br>    schedule_interval=timedelta(hours=<span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> dag:<br><br>    <span class="hljs-comment"># Law</span><br>    audit_law_category_record = AuditOperator(<br>        task_id=<span class="hljs-string">&#x27;audit_internet_law_category_record&#x27;</span>,<br>        postgres_conn_id=<span class="hljs-string">&#x27;hubble-internet-stage-db&#x27;</span>,<br>        audit_key=<span class="hljs-string">&quot;law_category&quot;</span>,<br>        cycle_dtm=<span class="hljs-string">&quot;&#123;&#123; ts &#125;&#125;&quot;</span>,<br>        dag=dag,<br>        pool=<span class="hljs-string">&#x27;hubble_internet_pool&#x27;</span><br>    )<br><br>    extract_law_category = PostgresToPostgresOperator(<br>        task_id=<span class="hljs-string">&#x27;extract_internet_law_category&#x27;</span>,<br>        sql=<span class="hljs-string">&#x27;internet_law_category.sql&#x27;</span>,<br>        pg_table=<span class="hljs-string">&#x27;law_category&#x27;</span>,<br>        src_postgres_conn_id=<span class="hljs-string">&#x27;hubble-db-stage&#x27;</span>,<br>        dest_posgres_conn_id=<span class="hljs-string">&#x27;hubble-internet-stage-db&#x27;</span>,<br>        pg_preoperator=<span class="hljs-string">&quot;DELETE FROM law_category&quot;</span>,<br>        dag=dag,<br>        pool=<span class="hljs-string">&#x27;hubble_internet_pool&#x27;</span>)<br><br>    audit_law_category_record &gt;&gt; extract_law_category<br><br></code></pre></td></tr></table></figure><blockquote><p><code>task1 &gt;&gt; [task2, task3]</code>  - 代表<code>task1</code>执行之后同时执行<code>task2</code>和<code>task3</code></p><p><code>sql_path</code>定义在<code>Variable</code>里面，值为sql目录的绝对路径，通过<code>    template_searchpath=tmpl_search_path,</code>可以拿到对应文件</p></blockquote><h4 id="编写DAG2"><a href="#编写DAG2" class="headerlink" title="编写DAG2"></a>编写DAG2</h4><p>适用于表结构大体相同，需要修改部分数据或者自定义插入sql</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta<br><span class="hljs-keyword">from</span> airflow <span class="hljs-keyword">import</span> DAG<br><span class="hljs-keyword">from</span> airflow.utils.dates <span class="hljs-keyword">import</span> days_ago<br><span class="hljs-keyword">from</span> airflow.models <span class="hljs-keyword">import</span> Variable<br><br><span class="hljs-keyword">import</span> sys<br>sys.path.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;/opt/bitnami/airflow/dags/git&quot;</span>)<br><span class="hljs-keyword">from</span> acme.operators.dwh_operators <span class="hljs-keyword">import</span> AuditOperator, PostgresToPostgresCustomOperator<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Synchronize Spanish environmental data</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>default_args = &#123;<br>    <span class="hljs-string">&quot;owner&quot;</span>: <span class="hljs-string">&quot;Lvhaojie&quot;</span>,<br>    <span class="hljs-string">&quot;depends_on_past&quot;</span>: <span class="hljs-literal">False</span>,<br>    <span class="hljs-string">&quot;start_date&quot;</span>: days_ago(<span class="hljs-number">0</span>),<br>    <span class="hljs-string">&quot;email&quot;</span>: [<span class="hljs-string">&quot;haojie.lv@coloseo.cn&quot;</span>],<br>    <span class="hljs-string">&quot;email_on_failure&quot;</span>: <span class="hljs-literal">True</span>,<br>    <span class="hljs-string">&quot;email_on_retry&quot;</span>: <span class="hljs-literal">True</span>,<br>    <span class="hljs-string">&quot;retries&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;retry_delay&quot;</span>: timedelta(minutes=<span class="hljs-number">10</span>),<br>&#125;<br><br>tmpl_search_path = Variable.get(<span class="hljs-string">&quot;sql_path&quot;</span>)<br><br><span class="hljs-keyword">with</span> DAG(<br>    dag_id=<span class="hljs-string">&quot;spain_uat_country&quot;</span>,<br>    tags=[<span class="hljs-string">&quot;spain-uat&quot;</span>],<br>    default_args=default_args,<br>    template_searchpath=tmpl_search_path,<br>    description=<span class="hljs-string">&quot;synchronize spain production environmental data of table country&quot;</span>,<br>    schedule_interval=timedelta(hours=<span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> dag:<br><br>    audit_country_record = AuditOperator(<br>        task_id=<span class="hljs-string">&#x27;audit_spain_country_record&#x27;</span>,<br>        postgres_conn_id=<span class="hljs-string">&#x27;spain-sevilla-uat&#x27;</span>,<br>        audit_key=<span class="hljs-string">&quot;country&quot;</span>,<br>        cycle_dtm=<span class="hljs-string">&quot;&#123;&#123; ts &#125;&#125;&quot;</span>,<br>        dag=dag,<br>        pool=<span class="hljs-string">&#x27;spain-uat&#x27;</span><br>    )<br><br>    extract_country = PostgresToPostgresCustomOperator(<br>        task_id=<span class="hljs-string">&#x27;extract_spain_country&#x27;</span>,<br>        src_postgres_conn_id=<span class="hljs-string">&#x27;spain-pablo-picasso-production&#x27;</span>,<br>        src_postgres_sql=<span class="hljs-string">&#x27;query_uat_country.sql&#x27;</span>,<br>        dest_posgres_conn_id=<span class="hljs-string">&#x27;spain-sevilla-uat&#x27;</span>,<br>        dest_posgres_sql=<span class="hljs-string">&#x27;insert_uat_country.sql&#x27;</span>,<br>        sql_key=<span class="hljs-string">&quot;query_data&quot;</span>,<br>        dag=dag,<br>        pool=<span class="hljs-string">&#x27;spain-uat&#x27;</span>)<br><br>    audit_country_record &gt;&gt; extract_country<br><br></code></pre></td></tr></table></figure><h4 id="自定义Operator"><a href="#自定义Operator" class="headerlink" title="自定义Operator"></a>自定义Operator</h4><p><code>Operator</code> 用来定义 <code>Task</code>，有些 <code>Task</code> 的功能是执行 <code>Bash</code> 指令、有些則是执行 <code>Python</code>，当然也可以通过 <code>Python Operator</code> 执行全部的事，但通过不同功能的 <code>Operator</code> 来定义 <code>Task</code>，在实际上会更容易些。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">import</span> logging<br><br><br><span class="hljs-keyword">from</span> airflow.hooks.postgres_hook <span class="hljs-keyword">import</span> PostgresHook<br><span class="hljs-keyword">from</span> airflow.models <span class="hljs-keyword">import</span> BaseOperator<br><span class="hljs-keyword">from</span> airflow.utils.decorators <span class="hljs-keyword">import</span> apply_defaults<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostgresToPostgresOperator</span>(<span class="hljs-params">BaseOperator</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Executes sql code in a Postgres database and inserts into another</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param src_postgres_conn_id: 源库</span><br><span class="hljs-string">    :type src_postgres_conn_id: string</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param dest_postgres_conn_id: 目标库</span><br><span class="hljs-string">    :type dest_postgres_conn_id: String</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param sql: 执行的 sql 或 sql 模版文件</span><br><span class="hljs-string">    :type sql: sql 语句 或 sql 模版文件，模版文件后缀名必须为 .sql</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param parameters: sql 执行的参数字典</span><br><span class="hljs-string">    :type parameters: dict</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    template_fields = (<br>        <span class="hljs-string">&quot;sql&quot;</span>,<br>        <span class="hljs-string">&quot;parameters&quot;</span>,<br>        <span class="hljs-string">&quot;pg_table&quot;</span>,<br>        <span class="hljs-string">&quot;pg_preoperator&quot;</span>,<br>        <span class="hljs-string">&quot;pg_postoperator&quot;</span>,<br>    )<br>    template_ext = (<span class="hljs-string">&quot;.sql&quot;</span>,)<br>    ui_color = <span class="hljs-string">&quot;#ededed&quot;</span><br><br><span class="hljs-meta">    @apply_defaults</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params"></span></span><br><span class="hljs-function"><span class="hljs-params">        self,</span></span><br><span class="hljs-function"><span class="hljs-params">        sql,</span></span><br><span class="hljs-function"><span class="hljs-params">        pg_table,</span></span><br><span class="hljs-function"><span class="hljs-params">        src_postgres_conn_id=<span class="hljs-string">&quot;postgres_default&quot;</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">        dest_posgres_conn_id=<span class="hljs-string">&quot;postgres_default&quot;</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">        pg_preoperator=None,</span></span><br><span class="hljs-function"><span class="hljs-params">        pg_postoperator=None,</span></span><br><span class="hljs-function"><span class="hljs-params">        parameters=None,</span></span><br><span class="hljs-function"><span class="hljs-params">        *args,</span></span><br><span class="hljs-function"><span class="hljs-params">        **kwargs</span></span><br><span class="hljs-function"><span class="hljs-params">    </span>):</span><br>        super().__init__(*args, **kwargs)<br>        self.sql = sql<br>        self.pg_table = pg_table<br>        self.src_postgres_conn_id = src_postgres_conn_id<br>        self.dest_postgres_conn_id = dest_posgres_conn_id<br>        self.pg_preoperator = pg_preoperator<br>        self.pg_postoperator = pg_postoperator<br>        self.parameters = parameters<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>(<span class="hljs-params">self, context</span>):</span><br>        logging.info(<span class="hljs-string">&quot;Executing: &quot;</span> + str(self.sql))<br>        src_pg = PostgresHook(postgres_conn_id=self.src_postgres_conn_id)<br>        dest_pg = PostgresHook(postgres_conn_id=self.dest_postgres_conn_id)<br><br>        logging.info(<br>            <span class="hljs-string">&quot;Transferring Postgres query results into other Postgres databases.&quot;</span><br>        )<br>        conn = src_pg.get_conn()<br>        cursor = conn.cursor()<br>        cursor.execute(self.sql, self.parameters)<br><br>        <span class="hljs-keyword">if</span> self.pg_preoperator:<br>            logging.info(<span class="hljs-string">&quot;Running Postgres preoperator&quot;</span>)<br>            dest_pg.run(self.pg_preoperator)<br><br>        logging.info(<span class="hljs-string">&quot;Inserting rows into Postgres&quot;</span>)<br>        dest_pg.insert_rows(table=self.pg_table, rows=cursor)<br><br>        <span class="hljs-keyword">if</span> self.pg_postoperator:<br>            logging.info(<span class="hljs-string">&quot;Running Postgres postoperator&quot;</span>)<br>            dest_pg.run(self.pg_postoperator)<br><br>        logging.info(<span class="hljs-string">&quot;Done.&quot;</span>)<br><br>        <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostgresToPostgresCustomOperator</span>(<span class="hljs-params">BaseOperator</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Executes sql code in a Postgres database and inserts into another</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param src_postgres_conn_id: 源库</span><br><span class="hljs-string">    :type src_postgres_conn_id: string</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param dest_postgres_conn_id: 目标库</span><br><span class="hljs-string">    :type dest_postgres_conn_id: String</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param sql: 执行的 sql 或 sql 模版文件</span><br><span class="hljs-string">    :type sql: sql 语句 或 sql 模版文件，模版文件后缀名必须为 .sql</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param parameters: sql 执行的参数字典</span><br><span class="hljs-string">    :type parameters: dict</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    template_fields = (<br>        <span class="hljs-string">&quot;src_postgres_sql&quot;</span>,<br>        <span class="hljs-string">&quot;dest_posgres_sql&quot;</span>,<br>        <span class="hljs-string">&quot;pg_preoperator&quot;</span>,<br>        <span class="hljs-string">&quot;pg_postoperator&quot;</span>,<br>    )<br>    template_ext = (<span class="hljs-string">&quot;.sql&quot;</span>,)<br>    ui_color = <span class="hljs-string">&quot;#ededed&quot;</span><br><br><span class="hljs-meta">    @apply_defaults</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params"></span></span><br><span class="hljs-function"><span class="hljs-params">        self,</span></span><br><span class="hljs-function"><span class="hljs-params">        src_postgres_sql,</span></span><br><span class="hljs-function"><span class="hljs-params">        dest_posgres_sql,</span></span><br><span class="hljs-function"><span class="hljs-params">        src_postgres_conn_id=<span class="hljs-string">&quot;postgres_default&quot;</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">        dest_posgres_conn_id=<span class="hljs-string">&quot;postgres_default&quot;</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">        pg_preoperator=None,</span></span><br><span class="hljs-function"><span class="hljs-params">        pg_postoperator=None,</span></span><br><span class="hljs-function"><span class="hljs-params">        sql_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">        *args,</span></span><br><span class="hljs-function"><span class="hljs-params">        **kwargs</span></span><br><span class="hljs-function"><span class="hljs-params">    </span>):</span><br>        super().__init__(*args, **kwargs)<br>        self.src_postgres_sql = src_postgres_sql<br>        self.dest_posgres_sql = dest_posgres_sql<br>        self.src_postgres_conn_id = src_postgres_conn_id<br>        self.dest_postgres_conn_id = dest_posgres_conn_id<br>        self.pg_preoperator = pg_preoperator<br>        self.pg_postoperator = pg_postoperator<br>        self.sql_key = sql_key<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>(<span class="hljs-params">self, context</span>):</span><br>        logging.info(<span class="hljs-string">&quot;Executing: &quot;</span> + str(self.src_postgres_sql))<br>        src_pg = PostgresHook(postgres_conn_id=self.src_postgres_conn_id)<br>        dest_pg = PostgresHook(postgres_conn_id=self.dest_postgres_conn_id)<br><br>        logging.info(<br>            <span class="hljs-string">&quot;Transferring Postgres query results into other Postgres databases.&quot;</span><br>        )<br>        src_conn = src_pg.get_conn()<br>        src_cursor = src_conn.cursor()<br>        src_cursor.execute(self.src_postgres_sql)<br><br>        <span class="hljs-keyword">if</span> self.pg_preoperator:<br>            logging.info(<span class="hljs-string">&quot;Running Postgres preoperator&quot;</span>)<br>            dest_pg.run(self.pg_preoperator)<br><br>        logging.info(<span class="hljs-string">&quot;Inserting rows into Postgres&quot;</span>)<br>        <span class="hljs-keyword">if</span> self.sql_key:<br>            query_data = src_cursor.fetchall()<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> query_data:<br>                dest_pg.run(self.dest_posgres_sql,<br>                            parameters=&#123;self.sql_key: i&#125;)<br>        <span class="hljs-keyword">else</span>:<br>            dest_pg.run(self.dest_posgres_sql)<br><br>        <span class="hljs-keyword">if</span> self.pg_postoperator:<br>            logging.info(<span class="hljs-string">&quot;Running Postgres postoperator&quot;</span>)<br>            dest_pg.run(self.pg_postoperator)<br><br>        logging.info(<span class="hljs-string">&quot;Done.&quot;</span>)<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostgresOperatorWithTemplatedParams</span>(<span class="hljs-params">BaseOperator</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Executes sql code in a specific Postgres database</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param postgres_conn_id: 目标库</span><br><span class="hljs-string">    :type  postgres_conn_id: string</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param sql: sql 语句或 sql 模版</span><br><span class="hljs-string">    :type  sql: sql 语句或 sql 模版文件，文件后缀必须为.sql</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    template_fields = (<span class="hljs-string">&quot;sql&quot;</span>, <span class="hljs-string">&quot;parameters&quot;</span>)<br>    template_ext = (<span class="hljs-string">&quot;.sql&quot;</span>,)<br>    ui_color = <span class="hljs-string">&quot;#ededed&quot;</span><br><br><span class="hljs-meta">    @apply_defaults</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params"></span></span><br><span class="hljs-function"><span class="hljs-params">        self,</span></span><br><span class="hljs-function"><span class="hljs-params">        sql,</span></span><br><span class="hljs-function"><span class="hljs-params">        postgres_conn_id=<span class="hljs-string">&quot;postgres_default&quot;</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">        autocommit=False,</span></span><br><span class="hljs-function"><span class="hljs-params">        parameters=None,</span></span><br><span class="hljs-function"><span class="hljs-params">        *args,</span></span><br><span class="hljs-function"><span class="hljs-params">        **kwargs</span></span><br><span class="hljs-function"><span class="hljs-params">    </span>):</span><br>        super().__init__(*args, **kwargs)<br>        self.sql = sql<br>        self.postgres_conn_id = postgres_conn_id<br>        self.autocommit = autocommit<br>        self.parameters = parameters<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>(<span class="hljs-params">self, context</span>):</span><br>        logging.info(<span class="hljs-string">&quot;Executing:&quot;</span> + str(self.sql))<br>        self.hook = PostgresHook(postgres_conn_id=self.postgres_conn_id)<br>        self.hook.run(self.sql, self.autocommit, parameters=self.parameters)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuditOperator</span>(<span class="hljs-params">BaseOperator</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Manages audit id&#x27;s in the databse to make sure that</span><br><span class="hljs-string">    operations are traceable.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param postgres_conn_id: 目标库</span><br><span class="hljs-string">    :type postgres_conn_id: string</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param audit_key: The key to use in the audit table</span><br><span class="hljs-string">    :type autid_key: string</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param cycle_dtm: The dtm of the extraction cycle run (ds)</span><br><span class="hljs-string">    :type cycle_dtm: datetime</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    template_fields = (<span class="hljs-string">&quot;audit_key&quot;</span>, <span class="hljs-string">&quot;cycle_dtm&quot;</span>)<br>    ui_color = <span class="hljs-string">&quot;#ededed&quot;</span><br><br><span class="hljs-meta">    @apply_defaults</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params"></span></span><br><span class="hljs-function"><span class="hljs-params">        self,</span></span><br><span class="hljs-function"><span class="hljs-params">        postgres_conn_id=<span class="hljs-string">&quot;postgres_default&quot;</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">        audit_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">        cycle_dtm=None,</span></span><br><span class="hljs-function"><span class="hljs-params">        *args,</span></span><br><span class="hljs-function"><span class="hljs-params">        **kwargs</span></span><br><span class="hljs-function"><span class="hljs-params">    </span>):</span><br>        super().__init__(*args, **kwargs)<br>        self.postgres_conn_id = postgres_conn_id<br>        self.audit_key = audit_key<br>        self.cycle_dtm = cycle_dtm<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>(<span class="hljs-params">self, context</span>):</span><br>        logging.info(<span class="hljs-string">&quot;Getting postgres hook object&quot;</span>)<br>        hook = PostgresHook(postgres_conn_id=self.postgres_conn_id)<br><br>        logging.info(<span class="hljs-string">&quot;Acquiring lock and updating audit table.&quot;</span>)<br>        conn = hook.get_conn()<br>        cursor = conn.cursor()<br>        cursor.execute(<span class="hljs-string">&quot;LOCK TABLE audit_runs IN ACCESS EXCLUSIVE MODE&quot;</span>)<br>        cursor.close()<br><br>        logging.info(<span class="hljs-string">&quot;Acquiring new audit number&quot;</span>)<br>        cursor = conn.cursor()<br>        cursor.execute(<br>            <span class="hljs-string">&quot;SELECT COALESCE(MAX(audit_id), 0)+1 FROM audit_runs&quot;</span><br>        )<br>        row = cursor.fetchone()<br>        cursor.close()<br>        audit_id = row[<span class="hljs-number">0</span>]<br>        logging.info(<span class="hljs-string">&quot;Found audit id %d.&quot;</span> % (audit_id))<br><br>        params = &#123;<br>            <span class="hljs-string">&quot;audit_id&quot;</span>: audit_id,<br>            <span class="hljs-string">&quot;audit_key&quot;</span>: self.audit_key,<br>            <span class="hljs-string">&quot;exec_dtm&quot;</span>: datetime.now(),<br>            <span class="hljs-string">&quot;cycle_dtm&quot;</span>: self.cycle_dtm,<br>        &#125;<br>        cursor = conn.cursor()<br>        logging.info(<span class="hljs-string">&quot;updating audit table with audit id: %d&quot;</span> % (audit_id))<br>        cursor.execute(<br>            <span class="hljs-string">&quot;INSERT INTO audit_runs &quot;</span><br>            <span class="hljs-string">&quot;(audit_id, audit_key, execution_dtm, cycle_dtm) VALUES &quot;</span><br>            <span class="hljs-string">&quot;(%(audit_id)s, %(audit_key)s, %(exec_dtm)s, %(cycle_dtm)s)&quot;</span>,<br>            params,<br>        )<br>        conn.commit()<br>        cursor.close()<br>        conn.close()<br><br>        ti = context[<span class="hljs-string">&quot;ti&quot;</span>]<br>        ti.xcom_push(key=<span class="hljs-string">&quot;audit_id&quot;</span>, value=audit_id)<br><br>        <span class="hljs-keyword">return</span> audit_id<br><br></code></pre></td></tr></table></figure><blockquote><ul><li><code>template_fields</code>: airflow的每个operator都定义了template_fields变量，其意思是需要渲染的字段，在执行时会自动渲染这些字段里的模板参数。举例:template_fields = (‘sql’, ‘partition’, ‘hive_table’)，也就是说执行operator时只有这4个字段里包含的模板参数会被渲染</li><li><code>PostgresToPostgresOperator</code>：适用于两个库表结构完全相同的情况；</li><li><code>PostgresToPostgresCustomOperator</code> ：适用于对数据进行简单处理的任务</li></ul><p>以上自定义的<code>Operator</code>，可以自定义执行类似同步数据这种任务。</p></blockquote><h4 id="Airflow日志定期清理"><a href="#Airflow日志定期清理" class="headerlink" title="Airflow日志定期清理"></a>Airflow日志定期清理</h4><p>airflow日志记录详细，占用空间也特别大，所以一般情况需要定期进行日志清理。下面我们编写一个定期任务来实现这个功能。</p><p><code>airflow_logs_cleanup.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">A maintenance workflow that you can deploy into Airflow to periodically clean</span><br><span class="hljs-string">out the task logs to avoid those getting too big.</span><br><span class="hljs-string">airflow trigger_dag --conf &#x27;[curly-braces]&quot;maxLogAgeInDays&quot;:30[curly-braces]&#x27; airflow-log-cleanup</span><br><span class="hljs-string">--conf options:</span><br><span class="hljs-string">    maxLogAgeInDays:&lt;INT&gt; - Optional</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> airflow.models <span class="hljs-keyword">import</span> DAG, Variable<br><span class="hljs-keyword">from</span> airflow.configuration <span class="hljs-keyword">import</span> conf<br><span class="hljs-keyword">from</span> airflow.utils.dates <span class="hljs-keyword">import</span> days_ago<br><span class="hljs-keyword">from</span> airflow.operators.bash_operator <span class="hljs-keyword">import</span> BashOperator<br><span class="hljs-keyword">from</span> airflow.operators.dummy_operator <span class="hljs-keyword">import</span> DummyOperator<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> logging<br><br><br><span class="hljs-comment"># airflow-log-cleanup</span><br><br><br>DAG_ID = os.path.basename(__file__).replace(<span class="hljs-string">&quot;.pyc&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;.py&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>START_DATE = days_ago(<span class="hljs-number">1</span>)<br>BASE_LOG_FOLDER = conf.get(<span class="hljs-string">&quot;core&quot;</span>, <span class="hljs-string">&quot;base_log_folder&quot;</span>)<br><span class="hljs-comment"># How often to Run. @daily - Once a day at Midnight</span><br>SCHEDULE_INTERVAL = <span class="hljs-string">&quot;@daily&quot;</span><br><span class="hljs-comment"># Who is listed as the owner of this DAG in the Airflow Web Server</span><br>DAG_OWNER_NAME = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-comment"># List of email address to send email alerts to if this job fails</span><br>ALERT_EMAIL_ADDRESSES = []<br><span class="hljs-comment"># Length to retain the log files if not already provided in the conf. If this</span><br><span class="hljs-comment"># is set to 30, the job will remove those files that are 30 days old or older</span><br>DEFAULT_MAX_LOG_AGE_IN_DAYS = Variable.get(<br>    <span class="hljs-string">&quot;airflow_log_cleanup__max_log_age_in_days&quot;</span>, <span class="hljs-number">14</span><br>)<br><span class="hljs-comment"># Whether the job should delete the logs or not. Included if you want to</span><br><span class="hljs-comment"># temporarily avoid deleting the logs</span><br>ENABLE_DELETE = <span class="hljs-literal">True</span><br><span class="hljs-comment"># The number of worker nodes you have in Airflow. Will attempt to run this</span><br><span class="hljs-comment"># process for however many workers there are so that each worker gets its</span><br><span class="hljs-comment"># logs cleared.</span><br>NUMBER_OF_WORKERS = <span class="hljs-number">1</span><br>DIRECTORIES_TO_DELETE = [BASE_LOG_FOLDER]<br>ENABLE_DELETE_CHILD_LOG = Variable.get(<br>    <span class="hljs-string">&quot;airflow_log_cleanup__enable_delete_child_log&quot;</span>, <span class="hljs-string">&quot;False&quot;</span><br>)<br>LOG_CLEANUP_PROCESS_LOCK_FILE = <span class="hljs-string">&quot;/tmp/airflow_log_cleanup_worker.lock&quot;</span><br>logging.info(<span class="hljs-string">&quot;ENABLE_DELETE_CHILD_LOG  &quot;</span> + ENABLE_DELETE_CHILD_LOG)<br><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> BASE_LOG_FOLDER <span class="hljs-keyword">or</span> BASE_LOG_FOLDER.strip() == <span class="hljs-string">&quot;&quot;</span>:<br>    <span class="hljs-keyword">raise</span> ValueError(<br>        <span class="hljs-string">&quot;BASE_LOG_FOLDER variable is empty in airflow.cfg. It can be found &quot;</span><br>        <span class="hljs-string">&quot;under the [core] section in the cfg file. Kindly provide an &quot;</span><br>        <span class="hljs-string">&quot;appropriate directory path.&quot;</span><br>    )<br><br><span class="hljs-keyword">if</span> ENABLE_DELETE_CHILD_LOG.lower() == <span class="hljs-string">&quot;true&quot;</span>:<br>    <span class="hljs-keyword">try</span>:<br>        CHILD_PROCESS_LOG_DIRECTORY = conf.get(<br>            <span class="hljs-string">&quot;scheduler&quot;</span>, <span class="hljs-string">&quot;child_process_log_directory&quot;</span><br>        )<br>        <span class="hljs-keyword">if</span> CHILD_PROCESS_LOG_DIRECTORY != <span class="hljs-string">&#x27; &#x27;</span>:<br>            DIRECTORIES_TO_DELETE.append(CHILD_PROCESS_LOG_DIRECTORY)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        logging.exception(<br>            <span class="hljs-string">&quot;Could not obtain CHILD_PROCESS_LOG_DIRECTORY from &quot;</span> +<br>            <span class="hljs-string">&quot;Airflow Configurations: &quot;</span> + str(e)<br>        )<br><br>default_args = &#123;<br>    <span class="hljs-string">&#x27;owner&#x27;</span>: DAG_OWNER_NAME,<br>    <span class="hljs-string">&#x27;depends_on_past&#x27;</span>: <span class="hljs-literal">False</span>,<br>    <span class="hljs-string">&#x27;email&#x27;</span>: ALERT_EMAIL_ADDRESSES,<br>    <span class="hljs-string">&#x27;email_on_failure&#x27;</span>: <span class="hljs-literal">True</span>,<br>    <span class="hljs-string">&#x27;email_on_retry&#x27;</span>: <span class="hljs-literal">False</span>,<br>    <span class="hljs-string">&#x27;start_date&#x27;</span>: START_DATE,<br>    <span class="hljs-string">&#x27;retries&#x27;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&#x27;retry_delay&#x27;</span>: timedelta(minutes=<span class="hljs-number">1</span>)<br>&#125;<br><br>dag = DAG(<br>    DAG_ID,<br>    default_args=default_args,<br>    schedule_interval=SCHEDULE_INTERVAL,<br>    start_date=START_DATE<br>)<br><span class="hljs-keyword">if</span> hasattr(dag, <span class="hljs-string">&#x27;doc_md&#x27;</span>):<br>    dag.doc_md = __doc__<br><span class="hljs-keyword">if</span> hasattr(dag, <span class="hljs-string">&#x27;catchup&#x27;</span>):<br>    dag.catchup = <span class="hljs-literal">False</span><br><br>start = DummyOperator(<br>    task_id=<span class="hljs-string">&#x27;start&#x27;</span>,<br>    dag=dag)<br><br>log_cleanup = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">echo &quot;Getting Configurations...&quot;</span><br><span class="hljs-string">BASE_LOG_FOLDER=&quot;&#123;&#123;params.directory&#125;&#125;&quot;</span><br><span class="hljs-string">WORKER_SLEEP_TIME=&quot;&#123;&#123;params.sleep_time&#125;&#125;&quot;</span><br><span class="hljs-string">sleep $&#123;WORKER_SLEEP_TIME&#125;s</span><br><span class="hljs-string">MAX_LOG_AGE_IN_DAYS=&quot;&#123;&#123;dag_run.conf.maxLogAgeInDays&#125;&#125;&quot;</span><br><span class="hljs-string">if [ &quot;$&#123;MAX_LOG_AGE_IN_DAYS&#125;&quot; == &quot;&quot; ]; then</span><br><span class="hljs-string">    echo &quot;maxLogAgeInDays conf variable isn&#x27;t included. Using Default &#x27;&quot;&quot;&quot;</span> + str(DEFAULT_MAX_LOG_AGE_IN_DAYS) + <span class="hljs-string">&quot;&quot;&quot;&#x27;.&quot;</span><br><span class="hljs-string">    MAX_LOG_AGE_IN_DAYS=&#x27;&quot;&quot;&quot;</span> + str(DEFAULT_MAX_LOG_AGE_IN_DAYS) + <span class="hljs-string">&quot;&quot;&quot;&#x27;</span><br><span class="hljs-string">fi</span><br><span class="hljs-string">ENABLE_DELETE=&quot;&quot;&quot;</span> + str(<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">if</span> ENABLE_DELETE <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;false&quot;</span>) + <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">echo &quot;Finished Getting Configurations&quot;</span><br><span class="hljs-string">echo &quot;&quot;</span><br><span class="hljs-string">echo &quot;Configurations:&quot;</span><br><span class="hljs-string">echo &quot;BASE_LOG_FOLDER:      &#x27;$&#123;BASE_LOG_FOLDER&#125;&#x27;&quot;</span><br><span class="hljs-string">echo &quot;MAX_LOG_AGE_IN_DAYS:  &#x27;$&#123;MAX_LOG_AGE_IN_DAYS&#125;&#x27;&quot;</span><br><span class="hljs-string">echo &quot;ENABLE_DELETE:        &#x27;$&#123;ENABLE_DELETE&#125;&#x27;&quot;</span><br><span class="hljs-string">cleanup() &#123;</span><br><span class="hljs-string">    echo &quot;Executing Find Statement: $1&quot;</span><br><span class="hljs-string">    FILES_MARKED_FOR_DELETE=`eval $1`</span><br><span class="hljs-string">    echo &quot;Process will be Deleting the following File(s)/Directory(s):&quot;</span><br><span class="hljs-string">    echo &quot;$&#123;FILES_MARKED_FOR_DELETE&#125;&quot;</span><br><span class="hljs-string">    echo &quot;Process will be Deleting `echo &quot;$&#123;FILES_MARKED_FOR_DELETE&#125;&quot; | \</span><br><span class="hljs-string">    grep -v &#x27;^$&#x27; | wc -l` File(s)/Directory(s)&quot;     \</span><br><span class="hljs-string">    # &quot;grep -v &#x27;^$&#x27;&quot; - removes empty lines.</span><br><span class="hljs-string">    # &quot;wc -l&quot; - Counts the number of lines</span><br><span class="hljs-string">    echo &quot;&quot;</span><br><span class="hljs-string">    if [ &quot;$&#123;ENABLE_DELETE&#125;&quot; == &quot;true&quot; ];</span><br><span class="hljs-string">    then</span><br><span class="hljs-string">        if [ &quot;$&#123;FILES_MARKED_FOR_DELETE&#125;&quot; != &quot;&quot; ];</span><br><span class="hljs-string">        then</span><br><span class="hljs-string">            echo &quot;Executing Delete Statement: $2&quot;</span><br><span class="hljs-string">            eval $2</span><br><span class="hljs-string">            DELETE_STMT_EXIT_CODE=$?</span><br><span class="hljs-string">            if [ &quot;$&#123;DELETE_STMT_EXIT_CODE&#125;&quot; != &quot;0&quot; ]; then</span><br><span class="hljs-string">                echo &quot;Delete process failed with exit code \</span><br><span class="hljs-string">                    &#x27;$&#123;DELETE_STMT_EXIT_CODE&#125;&#x27;&quot;</span><br><span class="hljs-string">                echo &quot;Removing lock file...&quot;</span><br><span class="hljs-string">                rm -f &quot;&quot;&quot;</span> + str(LOG_CLEANUP_PROCESS_LOCK_FILE) + <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                if [ &quot;$&#123;REMOVE_LOCK_FILE_EXIT_CODE&#125;&quot; != &quot;0&quot; ]; then</span><br><span class="hljs-string">                    echo &quot;Error removing the lock file. \</span><br><span class="hljs-string">                    Check file permissions.\</span><br><span class="hljs-string">                    To re-run the DAG, ensure that the lock file has been \</span><br><span class="hljs-string">                    deleted (&quot;&quot;&quot;</span> + str(LOG_CLEANUP_PROCESS_LOCK_FILE) + <span class="hljs-string">&quot;&quot;&quot;).&quot;</span><br><span class="hljs-string">                    exit $&#123;REMOVE_LOCK_FILE_EXIT_CODE&#125;</span><br><span class="hljs-string">                fi</span><br><span class="hljs-string">                exit $&#123;DELETE_STMT_EXIT_CODE&#125;</span><br><span class="hljs-string">            fi</span><br><span class="hljs-string">        else</span><br><span class="hljs-string">            echo &quot;WARN: No File(s)/Directory(s) to Delete&quot;</span><br><span class="hljs-string">        fi</span><br><span class="hljs-string">    else</span><br><span class="hljs-string">        echo &quot;WARN: You&#x27;re opted to skip deleting the File(s)/Directory(s)!!!&quot;</span><br><span class="hljs-string">    fi</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">if [ ! -f &quot;&quot;&quot;</span> + str(LOG_CLEANUP_PROCESS_LOCK_FILE) + <span class="hljs-string">&quot;&quot;&quot; ]; then</span><br><span class="hljs-string">    echo &quot;Lock file not found on this node! \</span><br><span class="hljs-string">    Creating it to prevent collisions...&quot;</span><br><span class="hljs-string">    touch &quot;&quot;&quot;</span> + str(LOG_CLEANUP_PROCESS_LOCK_FILE) + <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    CREATE_LOCK_FILE_EXIT_CODE=$?</span><br><span class="hljs-string">    if [ &quot;$&#123;CREATE_LOCK_FILE_EXIT_CODE&#125;&quot; != &quot;0&quot; ]; then</span><br><span class="hljs-string">        echo &quot;Error creating the lock file. \</span><br><span class="hljs-string">        Check if the airflow user can create files under tmp directory. \</span><br><span class="hljs-string">        Exiting...&quot;</span><br><span class="hljs-string">        exit $&#123;CREATE_LOCK_FILE_EXIT_CODE&#125;</span><br><span class="hljs-string">    fi</span><br><span class="hljs-string">    echo &quot;&quot;</span><br><span class="hljs-string">    echo &quot;Running Cleanup Process...&quot;</span><br><span class="hljs-string">    FIND_STATEMENT=&quot;find $&#123;BASE_LOG_FOLDER&#125;/*/* -type f -mtime \</span><br><span class="hljs-string">     +$&#123;MAX_LOG_AGE_IN_DAYS&#125;&quot;</span><br><span class="hljs-string">    DELETE_STMT=&quot;$&#123;FIND_STATEMENT&#125; -exec rm -f &#123;&#125; \;&quot;</span><br><span class="hljs-string">    cleanup &quot;$&#123;FIND_STATEMENT&#125;&quot; &quot;$&#123;DELETE_STMT&#125;&quot;</span><br><span class="hljs-string">    CLEANUP_EXIT_CODE=$?</span><br><span class="hljs-string">    FIND_STATEMENT=&quot;find $&#123;BASE_LOG_FOLDER&#125;/*/* -type d -empty&quot;</span><br><span class="hljs-string">    DELETE_STMT=&quot;$&#123;FIND_STATEMENT&#125; -prune -exec rm -rf &#123;&#125; \;&quot;</span><br><span class="hljs-string">    cleanup &quot;$&#123;FIND_STATEMENT&#125;&quot; &quot;$&#123;DELETE_STMT&#125;&quot;</span><br><span class="hljs-string">    CLEANUP_EXIT_CODE=$?</span><br><span class="hljs-string">    FIND_STATEMENT=&quot;find $&#123;BASE_LOG_FOLDER&#125;/* -type d -empty&quot;</span><br><span class="hljs-string">    DELETE_STMT=&quot;$&#123;FIND_STATEMENT&#125; -prune -exec rm -rf &#123;&#125; \;&quot;</span><br><span class="hljs-string">    cleanup &quot;$&#123;FIND_STATEMENT&#125;&quot; &quot;$&#123;DELETE_STMT&#125;&quot;</span><br><span class="hljs-string">    CLEANUP_EXIT_CODE=$?</span><br><span class="hljs-string">    echo &quot;Finished Running Cleanup Process&quot;</span><br><span class="hljs-string">    echo &quot;Deleting lock file...&quot;</span><br><span class="hljs-string">    rm -f &quot;&quot;&quot;</span> + str(LOG_CLEANUP_PROCESS_LOCK_FILE) + <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    REMOVE_LOCK_FILE_EXIT_CODE=$?</span><br><span class="hljs-string">    if [ &quot;$&#123;REMOVE_LOCK_FILE_EXIT_CODE&#125;&quot; != &quot;0&quot; ]; then</span><br><span class="hljs-string">        echo &quot;Error removing the lock file. Check file permissions. To re-run the DAG, ensure that the lock file has been deleted (&quot;&quot;&quot;</span> + str(LOG_CLEANUP_PROCESS_LOCK_FILE) + <span class="hljs-string">&quot;&quot;&quot;).&quot;</span><br><span class="hljs-string">        exit $&#123;REMOVE_LOCK_FILE_EXIT_CODE&#125;</span><br><span class="hljs-string">    fi</span><br><span class="hljs-string">else</span><br><span class="hljs-string">    echo &quot;Another task is already deleting logs on this worker node. \</span><br><span class="hljs-string">    Skipping it!&quot;</span><br><span class="hljs-string">    echo &quot;If you believe you&#x27;re receiving this message in error, kindly check \</span><br><span class="hljs-string">    if &quot;&quot;&quot;</span> + str(LOG_CLEANUP_PROCESS_LOCK_FILE) + <span class="hljs-string">&quot;&quot;&quot; exists and delete it.&quot;</span><br><span class="hljs-string">    exit 0</span><br><span class="hljs-string">fi</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">for</span> log_cleanup_id <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, NUMBER_OF_WORKERS + <span class="hljs-number">1</span>):<br><br>    <span class="hljs-keyword">for</span> dir_id, directory <span class="hljs-keyword">in</span> enumerate(DIRECTORIES_TO_DELETE):<br><br>        log_cleanup_op = BashOperator(<br>            task_id=<span class="hljs-string">&#x27;log_cleanup_worker_num_&#x27;</span> + str(log_cleanup_id) + <span class="hljs-string">&#x27;_dir_&#x27;</span> + str(dir_id),<br>            bash_command=log_cleanup,<br>            params=&#123;<br>                <span class="hljs-string">&quot;directory&quot;</span>: str(directory),<br>                <span class="hljs-string">&quot;sleep_time&quot;</span>: int(log_cleanup_id)*<span class="hljs-number">3</span>&#125;,<br>            dag=dag)<br><br>        log_cleanup_op.set_upstream(start)<br></code></pre></td></tr></table></figure><blockquote><ul><li><p><code>airflow.configuration.conf.get</code>: 可以获取airflow配置文件<code>airflow.cfg</code>中的配置信息。</p></li><li><p><code>airflow_log_cleanup__max_log_age_in_days</code>： airflow变量设置日志清理范围</p></li><li><p><code>airflow_log_cleanup__enable_delete_child_log</code>: airflow变量设置是否清理子日志</p></li></ul></blockquote><h3 id="相关坑点"><a href="#相关坑点" class="headerlink" title="相关坑点"></a>相关坑点</h3><ul><li>sql中进行时间过滤，应该使用airflow内置的时间，来获取任务执行时的时间，比如 <code>&#123;&#123; ds &#125;&#125;</code> 或者 <code>&#123;&#123; ts &#125;&#125;</code> – <a href="https://airflow.apache.org/docs/1.10.10/macros-ref.html">airflow macros</a></li><li>airflow会在当前任务结束时间(开始时间+时间间隔)到达时，才会将当前任务编排到scheduler开始执行。</li><li>如果没有开启 dag，也就是 <code>trigger</code> 的状态为 <code>off</code>，点击<code>trigger dag</code>会把任务挂起，直至开启 dag 才会执行。</li><li>airflow日志占用内存比较严重，如果需要定期清理见上文示例。</li></ul><p>其他坑点见 <a href="https://gist.github.com/diggzhang/a3db0856dbf5ef80b89a797a0712d968">传送门</a></p><ul><li>参考文章 - <a href="https://www.coderbridge.com/@FrankYang0529/6c90609c64c14df284f141b703c03702">Airflow动手玩</a> / <a href="https://github.com/gtoonstra/etl-with-airflow/tree/master/examples/etl-example/dags">etl-with-airflow</a> / <a href="https://airflow.apache.org/docs/stable/macros-ref.html">Airflow模版语法</a> / <a href="https://github.com/teamclairvoyant/airflow-maintenance-dags/blob/master/log-cleanup/airflow-log-cleanup.py">日志清理实例</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Airflow</category>
      
    </categories>
    
    
    <tags>
      
      <tag>airflow</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pandoc格式转换工具</title>
    <link href="/Myblog/2020/04/09/Pandoc%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2%E5%B7%A5%E5%85%B7/"/>
    <url>/Myblog/2020/04/09/Pandoc%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2%E5%B7%A5%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<h3 id="Pandoc简介"><a href="#Pandoc简介" class="headerlink" title="Pandoc简介"></a>Pandoc简介</h3><p>Pandoc 是一个命令行工具，用于将文件从一种标记语言转换为另一种标记语言。标记语言使用标签来标记文档的各个部分。常用的标记语言包括 Markdown、ReStructuredText、HTML、LaTex、ePub 和 Microsoft Word DOCX。</p><p>简单来说，<a href="https://pandoc.org/">Pandoc</a> 允许你将一些文件从一种标记语言转换为另一种标记语言。典型的例子包括将 Markdown 文件转换为演示文稿、LaTeX，PDF 甚至是 ePub</p><h3 id="Pandoc常用命令"><a href="#Pandoc常用命令" class="headerlink" title="Pandoc常用命令"></a>Pandoc常用命令</h3><ul><li>Markdown to docx: <code>pandoc xxx.md -o xxx.docx</code></li><li>Markdown to pdf: <code>pandoc xxx.md --pdf-engine=xelatex -o xxx.pdf</code></li><li>Markdown to html: <code>pandoc xxx.md -o xxx.html</code></li><li>Docx to markdown: <code>pandoc -s xxx.docx -t markdown -o xxx.md</code></li></ul><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="https://github.com/jgm/pandoc">Pandoc Github</a></li><li><a href="https://pandoc.org/MANUAL.html">Pandoc Params Guide</a></li><li><a href="https://www.pandoc.org/demos.html">Pandoc Demo</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Pandoc</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pandoc</tag>
      
      <tag>格式转换</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FastAPI项目实战</title>
    <link href="/Myblog/2020/03/25/FastAPI%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/"/>
    <url>/Myblog/2020/03/25/FastAPI%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<h3 id="FastAPI基础"><a href="#FastAPI基础" class="headerlink" title="FastAPI基础"></a>FastAPI基础</h3><p>FastAPI是一种现代，快速（高性能）的Web框架，用于基于标准Python类型提示使用Python 3.6+构建API。</p><p>主要功能是：</p><ul><li><strong>快速</strong>：非常高的性能，看齐NodeJS和Go。现有最快的Python框架之一。</li><li><strong>快速编码</strong>：将功能开发速度提高约200％至300％。</li><li><strong>更少的错误</strong>：减少约40％的人为错误（开发人员）。</li><li><strong>直观</strong>：强大的编辑器支持。完成无处不在。调试时间更少。</li><li><strong>简易</strong>：旨在易于使用和学习。减少阅读文档的时间。</li><li><strong>短</strong>：最小化代码重复。每个参数声明中的多个功能。更少的错误。</li><li><strong>健壮</strong>：获取可用于生产的代码。具有自动交互式文档。</li><li><strong>基于标准</strong>：基于（并完全兼容）API的开放标准：<a href="https://github.com/OAI/OpenAPI-Specification">OpenAPI</a>（以前称为Swagger）和<a href="http://json-schema.org/">JSON Schema</a>。</li></ul><p><strong>使用FastAPI</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install fastapi<br>pip install uvicorn<br></code></pre></td></tr></table></figure><blockquote><p>使用ASGI server</p></blockquote><h3 id="FastAPI项目实战"><a href="#FastAPI项目实战" class="headerlink" title="FastAPI项目实战"></a>FastAPI项目实战</h3><h4 id="项目目录结构"><a href="#项目目录结构" class="headerlink" title="项目目录结构"></a>项目目录结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">.<br>├── app<br>│   ├── __init__.py<br>│   ├── config<br>│   │   ├── __init__.py<br>│   ├── models<br>│   │   ├── __init__.py<br>│   └── resources<br>│       ├── __init__.py<br>│       ├── items.py     # 介绍ORM以及开启事务 <br>│       └── users.py     # 介绍FastAPI基本使用<br>├── docker-compose.yaml<br>├── main.py<br>└── requirements.txt<br><br></code></pre></td></tr></table></figure><blockquote><p>如果需要使用静态文件可以参考 <a href="https://fastapi.tiangolo.com/tutorial/static-files/">传送门</a>。</p></blockquote><h4 id="docker-compose-yaml"><a href="#docker-compose-yaml" class="headerlink" title="docker-compose.yaml"></a>docker-compose.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.7&#x27;</span><br><br><span class="hljs-attr">services:</span><br><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:11.7-alpine</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">postgres_data:/var/lib/postgresql/data/</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">5432</span><span class="hljs-string">:5432</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_USER=test</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_PASSWORD=test</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_DB=test</span><br><br><br><span class="hljs-attr">volumes:</span><br>  <span class="hljs-attr">postgres_data:</span><br></code></pre></td></tr></table></figure><blockquote><p>通过docker创建本地数据库</p></blockquote><h4 id="main-py"><a href="#main-py" class="headerlink" title="main.py"></a>main.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> uvicorn<br><br><span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> get_app<br><br><br>app = get_app()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># uvicorn.run(app, host=&quot;0.0.0.0&quot;, port=8000)</span><br>    uvicorn.run(<span class="hljs-string">&quot;main:app&quot;</span>, reload=<span class="hljs-literal">True</span>, host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">8000</span>)<br><br></code></pre></td></tr></table></figure><blockquote><ul><li>使用<code>uvicorn.run</code>启动，如果需要设置<code>reload=True</code>，必须替换<code>app</code> -&gt; <code>&quot;&lt;module&gt;:&lt;attribute&gt;&quot;</code></li><li>同样可以使用命令<code>uvicorn main:app --reload</code>启动服务。其中<code>main</code>为启动文件，<code>app</code>为<code>FastAPI()</code>，<code>--reload</code>指修改代码自动重启，一般用户开发模式</li></ul></blockquote><h4 id="app-init-py"><a href="#app-init-py" class="headerlink" title="app/init.py"></a>app/init.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Request<br><span class="hljs-keyword">from</span> fastapi.middleware.cors <span class="hljs-keyword">import</span> CORSMiddleware<br><span class="hljs-keyword">from</span> fastapi.middleware.gzip <span class="hljs-keyword">import</span> GZipMiddleware<br><br><span class="hljs-keyword">from</span> .resources <span class="hljs-keyword">import</span> router<br><span class="hljs-keyword">from</span> .models <span class="hljs-keyword">import</span> database<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_app</span>() -&gt; FastAPI:</span><br>    app = FastAPI()<br><br>    origins = [<br>        <span class="hljs-string">&quot;http://localhost.tiangolo.com&quot;</span>,<br>        <span class="hljs-string">&quot;https://localhost.tiangolo.com&quot;</span>,<br>        <span class="hljs-string">&quot;http://localhost&quot;</span>,<br>        <span class="hljs-string">&quot;http://localhost:8080&quot;</span>,<br>    ]<br><br>    <span class="hljs-comment"># 开启cors（跨源资源共享）</span><br>    app.add_middleware(<br>        CORSMiddleware,<br>        allow_origins=origins,<br>        allow_credentials=<span class="hljs-literal">True</span>,<br>        allow_methods=[<span class="hljs-string">&quot;*&quot;</span>],<br>        allow_headers=[<span class="hljs-string">&quot;*&quot;</span>],<br>    )<br>    <span class="hljs-comment"># 500字节以上才开启gzip</span><br>    app.add_middleware(<br>        GZipMiddleware,<br>        minimum_size=<span class="hljs-number">500</span><br>    )<br>    <br>    <span class="hljs-comment"># 添加中间件计算程序运行时间</span><br><span class="hljs-meta">    @app.middleware(&quot;http&quot;)</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_process_time_header</span>(<span class="hljs-params">request: Request, call_next</span>):</span><br>        start_time = time.time()<br>        response = <span class="hljs-keyword">await</span> call_next(request)<br>        process_time = time.time() - start_time<br>        response.headers[<span class="hljs-string">&quot;X-Process-Time&quot;</span>] = str(process_time)<br>        <span class="hljs-keyword">return</span> response<br><br>    app.include_router(router, prefix=<span class="hljs-string">&quot;/api&quot;</span>)<br>    <br>    <span class="hljs-comment"># 添加数据库连接和关闭事件</span><br><span class="hljs-meta">    @app.on_event(&quot;startup&quot;)</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span>():</span><br>        <span class="hljs-keyword">await</span> database.connect()<br><br><span class="hljs-meta">    @app.on_event(&quot;shutdown&quot;)</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shutdown</span>():</span><br>        <span class="hljs-keyword">await</span> database.disconnect()<br><br>    <span class="hljs-keyword">return</span> app<br><br></code></pre></td></tr></table></figure><blockquote><ul><li><p>该<code>CORSMiddleware</code>实现使用的默认参数默认情况下是限制性的，因此您需要显式启用特定的来源，方法或标头，以便允许浏览器在跨域上下文中使用它们。</p><p>支持以下参数：</p><ul><li><code>allow_origins</code>-应该允许进行跨域请求的来源列表。例如<code>[&#39;https://example.org&#39;, &#39;https://www.example.org&#39;]</code>。您可以<code>[&#39;*&#39;]</code>用来允许任何来源。</li><li><code>allow_origin_regex</code>-一个正则表达式字符串，与应允许进行跨域请求的原点匹配。例如。<code>&#39;https://.*\.example\.org&#39;</code>。</li><li><code>allow_methods</code>-跨域请求应允许的HTTP方法列表。默认为<code>[&#39;GET&#39;]</code>。您可以使用<code>[&#39;*&#39;]</code>允许所有标准方法。</li><li><code>allow_headers</code>-跨域请求应支持的HTTP请求标头列表。默认为<code>[]</code>。您可以<code>[&#39;*&#39;]</code>用来允许所有标头。的<code>Accept</code>，<code>Accept-Language</code>，<code>Content-Language</code>和<code>Content-Type</code>头总是允许CORS请求。</li><li><code>allow_credentials</code>-表示跨域请求应支持cookie。默认为<code>False</code>。</li><li><code>expose_headers</code>-指出应使浏览器可以访问的所有响应标头。默认为<code>[]</code>。</li><li><code>max_age</code>-设置浏览器缓存CORS响应的最长时间（以秒为单位）。默认为<code>60</code>。</li></ul></li><li><p>添加中间件有以上两种方式，其他 <a href="https://fastapi.tiangolo.com/advanced/middleware/">middleware用法</a>。</p></li></ul></blockquote><h4 id="app-config-init-py"><a href="#app-config-init-py" class="headerlink" title="app/config/init.py"></a>app/config/init.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">DATABASE_URL = <span class="hljs-string">&quot;postgresql://test:test@127.0.0.1:5432/test&quot;</span><br></code></pre></td></tr></table></figure><h4 id="app-models-init-py"><a href="#app-models-init-py" class="headerlink" title="app/models/init.py"></a>app/models/init.py</h4><p><strong>这里需要安装以下三方库，来支持异步连接pgsql</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">pip install psycopg2-binary==2.8.5<br>pip install asyncpg==0.20.1<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sa<br><span class="hljs-keyword">from</span> databases <span class="hljs-keyword">import</span> Database<br><br><span class="hljs-keyword">from</span> app.config <span class="hljs-keyword">import</span> DATABASE_URL<br><br><br>database = Database(DATABASE_URL)<br>metadata = sa.MetaData()<br><br><br>Room = sa.Table(<br>    <span class="hljs-string">&quot;user&quot;</span>,    <span class="hljs-comment"># table name</span><br>    metadata,<br>    sa.Column(<span class="hljs-string">&quot;id&quot;</span>, sa.Integer, primary_key=<span class="hljs-literal">True</span>),<br>    sa.Column(<span class="hljs-string">&quot;code&quot;</span>, sa.VARCHAR(<span class="hljs-number">64</span>)),<br>    sa.Column(<span class="hljs-string">&quot;name&quot;</span>, sa.VARCHAR(<span class="hljs-number">32</span>)),<br>    sa.Column(<span class="hljs-string">&quot;phone&quot;</span>, sa.VARCHAR(<span class="hljs-number">64</span>)),<br>    sa.Column(<span class="hljs-string">&quot;status&quot;</span>, sa.Boolean),<br>    sa.Column(<span class="hljs-string">&quot;note&quot;</span>, sa.Text)<br>)<br><br><br>Item = sa.Table(<br>    <span class="hljs-string">&quot;item&quot;</span>,<br>    metadata,<br>    sa.Column(<span class="hljs-string">&quot;id&quot;</span>, sa.Integer, primary_key=<span class="hljs-literal">True</span>),<br>    sa.Column(<span class="hljs-string">&quot;code&quot;</span>, sa.VARCHAR(<span class="hljs-number">64</span>)),<br>    sa.Column(<span class="hljs-string">&quot;name&quot;</span>, sa.VARCHAR(<span class="hljs-number">32</span>)),<br>    sa.Column(<span class="hljs-string">&quot;description&quot;</span>, sa.VARCHAR(<span class="hljs-number">256</span>)),<br>    sa.Column(<span class="hljs-string">&quot;status&quot;</span>, sa.Boolean),<br>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    engine = sa.create_engine(DATABASE_URL)<br>    metadata.create_all(engine)<br>    print(<span class="hljs-string">&quot;create table successful!&quot;</span>)<br></code></pre></td></tr></table></figure><blockquote><p>因为要异步连接数据库，所以ORM不能使用session层，需要使用database层操作数据库。</p></blockquote><h4 id="app-resources-init-py"><a href="#app-resources-init-py" class="headerlink" title="app/resources/init.py"></a>app/resources/init.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter<br><br><span class="hljs-keyword">from</span> .items <span class="hljs-keyword">import</span> router <span class="hljs-keyword">as</span> router_item<br><span class="hljs-keyword">from</span> .users <span class="hljs-keyword">import</span> router <span class="hljs-keyword">as</span> router_users<br><br><br>router = APIRouter()<br><br>router.include_router(router_item, tags=[<span class="hljs-string">&quot;items&quot;</span>], prefix=<span class="hljs-string">&quot;/items&quot;</span>)<br>router.include_router(router_users, tags=[<span class="hljs-string">&quot;users&quot;</span>], prefix=<span class="hljs-string">&quot;/users&quot;</span>)<br></code></pre></td></tr></table></figure><blockquote><p>注册分路由(<code>tags</code>标记swagger)</p></blockquote><h4 id="app-resources-users-py"><a href="#app-resources-users-py" class="headerlink" title="app/resources/users.py"></a>app/resources/users.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional, List, Tuple, Dict, Set<br><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, validator, root_validator, Field, HttpUrl, EmailStr<br><span class="hljs-keyword">from</span> pydantic.errors <span class="hljs-keyword">import</span> PydanticValueError<br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, HTTPException, Query, Path, Body, Header, Cookie, Form, File, UploadFile, BackgroundTasks<br><br>router = APIRouter()<br><br><br><span class="hljs-meta">@router.get(&quot;/&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">users_root</span>(<span class="hljs-params">page: int = Query(<span class="hljs-params"><span class="hljs-number">1</span>, gt=<span class="hljs-number">0</span></span>), per_page: int = Query(<span class="hljs-params"><span class="hljs-number">10</span>, gt=<span class="hljs-number">0</span></span>), limit: Optional[int] = None</span>):</span><br>    <span class="hljs-comment"># query params: page, per_page 默认值为1，10，并且会强制转换成对应类型</span><br>    <span class="hljs-comment"># Query可以执行额外的验证，第一个参数是默认值，参数title和description用于swagger文档</span><br>    <span class="hljs-comment"># limit: Optional[int] = None 用来告诉limit值可能为None</span><br>    users = list(range(<span class="hljs-number">100</span>))<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;users&quot;</span>: users[(page<span class="hljs-number">-1</span>)*per_page: page*per_page], <span class="hljs-string">&quot;limit&quot;</span>: limit&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Suggestion</span>(<span class="hljs-params">BaseModel</span>):</span><br>    pic: List[str] = Query(<span class="hljs-literal">None</span>, max_length=<span class="hljs-number">5</span>)<br>    content: Optional[str] = <span class="hljs-literal">None</span><br>    is_deal: bool = <span class="hljs-literal">False</span><br><br><br><span class="hljs-meta">@router.post(&quot;/&#123;user_id&#125;/suggestions&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read_users</span>(<span class="hljs-params">suggestion: Suggestion, user_id: int = Path(<span class="hljs-params">..., gt=<span class="hljs-number">0</span></span>)</span>):</span><br>  <span class="hljs-comment"># suggestion 指定主体参数</span><br>    <span class="hljs-comment"># Path 可以额外验证路径参数， ...代表为必须</span><br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;user_id&quot;</span>: user_id, <span class="hljs-string">&quot;suggestion&quot;</span>: suggestion&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">BaseModel</span>):</span><br>    username: str = Field(<span class="hljs-literal">None</span>, title=<span class="hljs-string">&quot;The title of the username&quot;</span>, max_length=<span class="hljs-number">10</span>)<br>    full_name: str = <span class="hljs-literal">None</span><br>    email: EmailStr<br>      <br><span class="hljs-meta">    @validator(&quot;username&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">username_validator</span>(<span class="hljs-params">cls, username</span>):</span><br>        <span class="hljs-keyword">if</span> username.isdigit():<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;incorrect username&#x27;</span>)<br>        <span class="hljs-keyword">return</span> username<br><span class="hljs-meta">    @root_validator</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root_validator_test</span>(<span class="hljs-params">cls, fields</span>):</span><br>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> any(fields.values(<span class="hljs-string">&quot;at least one parameter&quot;</span>)):<br>          <span class="hljs-keyword">raise</span> PydanticValueError()<br>        <span class="hljs-keyword">return</span> fields<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Token</span>(<span class="hljs-params">BaseModel</span>):</span><br>    token: str = Field(..., description=<span class="hljs-string">&quot;The description of the token&quot;</span>)<br>    status: bool = <span class="hljs-literal">True</span>    <br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Image</span>(<span class="hljs-params">BaseModel</span>):</span><br>    url: HttpUrl<br>    name: str<br><br><br><span class="hljs-meta">@router.post(&quot;/&#123;user_id&#125;/tokens&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read_tokens</span>(<span class="hljs-params">user_id, user: User, token: Token, importance: int = Body(<span class="hljs-params">..., gt=<span class="hljs-number">0</span></span>)</span>):</span><br>    <span class="hljs-comment"># Body可以在多个主体参数外，额外定义数据</span><br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;user_id&quot;</span>: user_id, <span class="hljs-string">&quot;user&quot;</span>: user, <span class="hljs-string">&quot;token&quot;</span>: token, <span class="hljs-string">&quot;importance&quot;</span>: importance&#125;<br>  <br>  <br><span class="hljs-meta">@router.post(&quot;/uploadfile&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_file</span>(<span class="hljs-params">file: UploadFile = File(<span class="hljs-params">...</span>)</span>):</span><br>    <span class="hljs-comment"># 用于解析，需要安装python-multipart库</span><br>    <span class="hljs-comment"># file: bytes = File(...)  可以直接获取二进制数据。大文件建议用UploadFile，对内存更友好</span><br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>, <span class="hljs-string">&quot;filename&quot;</span>: file.filename&#125;<br>  <br>  <br><br>  <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write_notification</span>(<span class="hljs-params">email: str, message=<span class="hljs-string">&quot;&quot;</span></span>):</span><br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&quot;log.txt&quot;</span>, mode=<span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> email_file:<br>        content = <span class="hljs-string">f&quot;notification for <span class="hljs-subst">&#123;email&#125;</span>: <span class="hljs-subst">&#123;message&#125;</span>&quot;</span><br>        email_file.write(content)<br><br><br><span class="hljs-meta">@router.post(&quot;/send-notification/&#123;email&#125;&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_notification</span>(<span class="hljs-params">email: str, background_tasks: BackgroundTasks</span>):</span><br>  <span class="hljs-string">&quot;&quot;&quot;后台任务&quot;&quot;&quot;</span><br>    background_tasks.add_task(write_notification, email, message=<span class="hljs-string">&quot;some notification&quot;</span>)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Notification sent in the background&quot;</span>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><ul><li><code>Query, Path, Body, Header, Cookie, Form, File, BackgroundTasks</code> 分别为 <code>请求参数，位置参数，请求体，header，cookie，form，上传文件, 后台任务</code> 。具体使用如上例子所示，指定默认值为<code>...</code>代表为必选，可以指定参数title和description用于swagger文档。</li></ul><p>form上传文件示例：写入临时文件进行读取</p><blockquote><p>需要安装解析库<code>python-multipart</code></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> tempfile <span class="hljs-keyword">import</span> NamedTemporaryFile<br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, File, UploadFile<br><br><span class="hljs-keyword">from</span> app.minio_server <span class="hljs-keyword">import</span> MinioServer<br><span class="hljs-keyword">from</span> app.utils <span class="hljs-keyword">import</span> file_hasher<br><br>router = APIRouter()<br><br><span class="hljs-meta">@router.post(&quot;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_file</span>(<span class="hljs-params">file: UploadFile = File(<span class="hljs-params">..., description = <span class="hljs-string">&quot;使用form表单上传文件&quot;</span></span>)</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;上传文件&quot;&quot;&quot;</span><br>    file_name = file.filename<br>    prefix, suffix = file_name.split(<span class="hljs-string">&quot;.&quot;</span>)<br>    content_type = file.content_type<br>    b_data = file.file.read()<br>    minio_server = MinioServer()<br>    <span class="hljs-keyword">with</span> NamedTemporaryFile(suffix=<span class="hljs-string">&quot;.&quot;</span> + suffix) <span class="hljs-keyword">as</span> ntf:<br>        ntf.write(b_data)<br>        temp_file_path = ntf.name<br>        save_name = file_hasher(temp_file_path) + <span class="hljs-string">&quot;.&quot;</span> + suffix<br>        file_url = minio_server.up_file(save_name, temp_file_path, content_type)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;url&quot;</span>: file_url&#125;<br></code></pre></td></tr></table></figure><ul><li><p><code>Optional, List, Tuple, Dict, Set</code>分别为 <code>可选，列表，元组，字典，集合</code>。</p></li><li><p>模型中自定义<code>validator</code>修饰的函数，可以执行额外的验证。传送门 =&gt; <a href="https://pydantic-docs.helpmanual.io/usage/validators/">pydantic validator</a></p></li><li><p>嵌套模型，可以修改模型为自定义，例如:</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Image</span>(<span class="hljs-params">BaseModel</span>):</span><br>    url: str<br>    name: str<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Item</span>(<span class="hljs-params">BaseModel</span>):</span><br>    name: str<br>    description: str = <span class="hljs-literal">None</span><br>    price: float<br>    tax: float = <span class="hljs-literal">None</span><br>    tags: Set[str] = []<br>    image: Image = <span class="hljs-literal">None</span>   <span class="hljs-comment"># 此处为模型嵌套</span><br></code></pre></td></tr></table></figure><ul><li>返回异常 - <code>raise HTTPException(status_code=403, detail=&quot;not found item&quot;)</code></li></ul></blockquote><h4 id="app-resources-items-py"><a href="#app-resources-items-py" class="headerlink" title="app/resources/items.py"></a>app/resources/items.py</h4><p><strong>这里主要介绍ORM对数据库执行CRUD操作</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List<br><br><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel<br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, Path<br><br><span class="hljs-keyword">from</span> ..models <span class="hljs-keyword">import</span> database, Item<br><br><br>router = APIRouter()<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ItemModel</span>(<span class="hljs-params">BaseModel</span>):</span><br>    code: str<br>    name: str<br>    description: str<br>    status: bool<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ItemsModel</span>(<span class="hljs-params">BaseModel</span>):</span><br>    code_list: List[str]<br>    name: str<br>    description: str<br>    status: bool<br><br><br><span class="hljs-comment"># 查询单个数据</span><br><span class="hljs-meta">@router.get(&quot;/&#123;item_id&#125;&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">items_get</span>(<span class="hljs-params">item_id: int = Path(<span class="hljs-params">..., gt=<span class="hljs-number">0</span></span>)</span>):</span><br>    r_item = <span class="hljs-keyword">await</span> database.fetch_one(Item.select(Item.c.id == item_id))<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;item&quot;</span>: r_item&#125;<br><br><br><span class="hljs-comment"># 添加数据</span><br><span class="hljs-meta">@router.post(&quot;/&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">items_insert</span>(<span class="hljs-params">item: ItemModel</span>):</span><br>    item_id = <span class="hljs-keyword">await</span> database.execute(Item.insert(), item.__dict__)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;item&quot;</span>: dict(item, **&#123;<span class="hljs-string">&quot;id&quot;</span>: item_id&#125;)&#125;<br><br><br><span class="hljs-comment"># 修改单个数据</span><br><span class="hljs-meta">@router.patch(&quot;/&#123;item_id&#125;&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">item_update</span>(<span class="hljs-params">item: ItemModel, item_id: int = Path(<span class="hljs-params">..., gt=<span class="hljs-number">0</span></span>)</span>):</span><br>    <span class="hljs-keyword">await</span> database.execute(Item.update().where(Item.c.id == item_id), item.__dict__)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><br><span class="hljs-comment"># 删除单个数据</span><br><span class="hljs-meta">@router.delete(&quot;/&#123;item_id&#125;&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">item_delete</span>(<span class="hljs-params">item_id: int = Path(<span class="hljs-params">..., gt=<span class="hljs-number">0</span></span>)</span>):</span><br>    <span class="hljs-keyword">await</span> database.execute(Item.delete().where(Item.c.id == item_id))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><br><span class="hljs-comment"># 开启事务环境，模拟批量修改数据</span><br><span class="hljs-meta">@router.put(&quot;/update_items&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_items</span>(<span class="hljs-params">items: ItemsModel</span>):</span><br>    data = items.__dict__<br>    code_list = data.pop(<span class="hljs-string">&quot;code_list&quot;</span>)   <span class="hljs-comment"># code_list: [&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;]</span><br><br>    transaction = database.transaction()<br>    <span class="hljs-keyword">await</span> transaction.start()   <span class="hljs-comment"># 开启事务</span><br>    <span class="hljs-keyword">for</span> code <span class="hljs-keyword">in</span> code_list:<br>        <span class="hljs-keyword">await</span> database.execute(Item.update().where(Item.c.code == code), data)<br>        <span class="hljs-keyword">if</span> code == <span class="hljs-string">&#x27;A&#x27;</span>:<br>            <span class="hljs-keyword">await</span> transaction.commit()   <span class="hljs-comment"># 提交sql并销毁事务</span><br>            <span class="hljs-keyword">await</span> transaction.start()    <span class="hljs-comment"># 开启新的事务</span><br>        <span class="hljs-keyword">if</span> code == <span class="hljs-string">&#x27;B&#x27;</span>:<br>            <span class="hljs-keyword">await</span> transaction.rollback()   <span class="hljs-comment"># 执行sql回滚</span><br>            <span class="hljs-keyword">await</span> transaction.start()<br>        <span class="hljs-keyword">if</span> code == <span class="hljs-string">&#x27;C&#x27;</span>:<br>            <span class="hljs-keyword">await</span> transaction.commit()<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><blockquote><p><code>commit()</code> 和 <code>rollback()</code>方法会销毁事务环境，所以不能在没有任何修改操作重复提交，否则会报错。</p></blockquote><p>开启事务方式可以也可以这么写…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@router.put(&quot;/update_items&quot;)</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_items</span>(<span class="hljs-params">items: ItemsModel</span>):</span><br>    data = items.__dict__<br>    code_list = data.pop(<span class="hljs-string">&quot;code_list&quot;</span>)   <span class="hljs-comment"># code_list: [&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;]</span><br>    <br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> database.transaction() <span class="hljs-keyword">as</span> transaction:<br>        <span class="hljs-keyword">for</span> code <span class="hljs-keyword">in</span> code_list:<br>            <span class="hljs-keyword">await</span> database.execute(Item.update().where(Item.c.code == code), data)<br>            <span class="hljs-keyword">if</span> code == <span class="hljs-string">&#x27;A&#x27;</span>:<br>                <span class="hljs-keyword">await</span> transaction.commit()<br>                <span class="hljs-keyword">await</span> transaction.start()<br>            <span class="hljs-keyword">if</span> code == <span class="hljs-string">&#x27;B&#x27;</span>:<br>                <span class="hljs-keyword">await</span> transaction.rollback()<br>                <span class="hljs-keyword">await</span> transaction.start()<br>            <span class="hljs-keyword">if</span> code == <span class="hljs-string">&#x27;C&#x27;</span>:<br>                <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><blockquote><p><code>async with</code> 异步上下文语法，会在自动调用<code>__aenter__()</code> 和 <code>__aexit__()</code> 方法。</p><p><code>__aenter__()</code>会调用<code>start()</code>方法开启一个事务。</p><p><code>__aexit__()</code>如果发生异常，会执行<code>rollback()</code>进行回滚；否则执行<code>commit()</code>进行提交。</p></blockquote><h4 id="下载导出文件"><a href="#下载导出文件" class="headerlink" title="下载导出文件"></a>下载导出文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> starlette.responses <span class="hljs-keyword">import</span> Response<br><br><span class="hljs-meta">@router.get(&quot;/&#123;edition_id:int&#125;/word-report&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">export_edition_information</span>(<span class="hljs-params">edition_id: int, db: Session = Depends(<span class="hljs-params">get_db</span>)</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;广告信息导出 =&gt; WORD&quot;&quot;&quot;</span><br>    edition = db.query(Edition).filter_by(id=edition_id).first()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> edition:<br>        <span class="hljs-keyword">raise</span> HTTPException(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;广告不存在&quot;</span>)<br>    law_items = db.query(LawItem).filter(LawItem.id.in_(edition.laws)).order_by(LawItem.id).all()<br><br>    type_dict = dict(zip([<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>], [<span class="hljs-string">&quot;网站&quot;</span>, <span class="hljs-string">&quot;小程序和APP&quot;</span>, <span class="hljs-string">&quot;自媒体&quot;</span>]))<br>    data = dict(edition.to_dict(),<br>                law_items=[i.to_dict() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> law_items],<br>                edition_type=type_dict[edition.type])<br>    <span class="hljs-comment"># 写入WORD文档</span><br>    docx_name = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;edition.name&#125;</span>.docx&quot;</span><br>    bytes_value = gen_word_template(data=data)<br>    header = &#123;<span class="hljs-string">&quot;content-disposition&quot;</span>: <span class="hljs-string">f&quot;attachment; filename*=utf-8&#x27;&#x27;<span class="hljs-subst">&#123;parse.quote(docx_name)&#125;</span>&quot;</span>,<br>              <span class="hljs-string">&quot;Access-Control-Expose-Headers&quot;</span>: <span class="hljs-string">&quot;content-disposition&quot;</span>&#125;<br>    resp = Response(bytes_value, headers=header, media_type=<span class="hljs-string">&quot;application/msword&quot;</span>)<br>    <span class="hljs-keyword">return</span> resp<br></code></pre></td></tr></table></figure><blockquote><ul><li><p><code>filename*=utf-8&#39;&#39;</code> 设置文件名和编码</p></li><li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Expose-Headers">Access-Control-Expose-Headers</a> 暴露哪些响应头给前端获取</p></li></ul></blockquote><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="https://fastapi.tiangolo.com/">FastAPI官方文档</a></li><li><a href="https://github.com/nsidnev/fastapi-realworld-example-app">FastAPI项目实例</a></li><li><a href="https://pydantic-docs.helpmanual.io/">pydantic官方文档</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>FastAPI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fastapi</tag>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python实现FCM推送详解</title>
    <link href="/Myblog/2020/03/18/python%E5%AE%9E%E7%8E%B0FCM%E6%8E%A8%E9%80%81%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2020/03/18/python%E5%AE%9E%E7%8E%B0FCM%E6%8E%A8%E9%80%81%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="FCM详解"><a href="#FCM详解" class="headerlink" title="FCM详解"></a>FCM详解</h3><p>与ios的APNs2对应的，android使用FCM进行消息推送(由以前的GCM升级)，在查阅资料后，发现在python中已经有人造好轮子了，这里我们使用 PyFCm 第三方库。</p><p><strong>本文参考<a href="https://github.com/olucurious/PyFCM">PyFCM</a>三方库</strong>，因为需要修改部分代码，所以复制了代码到项目。</p><h3 id="准备通讯凭证"><a href="#准备通讯凭证" class="headerlink" title="准备通讯凭证"></a>准备通讯凭证</h3><ol><li><code>api_key</code> - 必须保证FCM项目下<code>api_key</code> 和 <code>google-services.json</code> 保持一致，<code>api_key</code>可以从这里获得<code>https://console.firebase.google.com/project/&lt;project-name&gt;/settings/cloudmessaging</code></li><li><code>registration_id(device_token)</code> - 设备token，安装时唯一确定。同样必须保证能够与<code>api_key</code>对应。</li></ol><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><h4 id="文件目录结构"><a href="#文件目录结构" class="headerlink" title="文件目录结构"></a>文件目录结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">├── app<br>│   ├── fcm<br>│   │   ├── __init__.py<br>│   │   ├── baseapi.py<br>│   │   ├── errors.py<br>│   │   └── fcm.py<br>├── config<br>│   ├── development.py<br>│   ├── production.py<br>│   └── staging.py<br></code></pre></td></tr></table></figure><h4 id="config-development-py"><a href="#config-development-py" class="headerlink" title="config/development.py"></a>config/development.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># android FCM</span><br><span class="hljs-comment"># FCM_API_KEY = &#x27;AIzaSyA5LU8K3t1****KwfxS3LRJ4uaTf7IwY&#x27;  # 旧版</span><br>FCM_API_KEY = <span class="hljs-string">&#x27;AAAANVRLsgw:APA91bHue*****kf2kVMWphoMQ5o9PhvEgzSx4q4ADrj2SLYg-cQeEl1kNzpMoFuYwQIEiTemql5Ot59FRsaBZTAetaRe--eAL1J42KjaYL1XW1o5d4LgDJ2B1S&#x27;</span><br><br></code></pre></td></tr></table></figure><h4 id="app-fcm-init-py"><a href="#app-fcm-init-py" class="headerlink" title="app/fcm/init.py"></a>app/fcm/init.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> .fcm <span class="hljs-keyword">import</span> FCMNotification<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_fcm_notification</span>(<span class="hljs-params">token: str, notification: str</span>):</span><br>    <span class="hljs-keyword">return</span> FCMNotification().notify_single_device(registration_id=token, message_body=notification)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_fcm_notifications_batch</span>(<span class="hljs-params">tokens: list, notification: str</span>):</span><br>    <span class="hljs-keyword">return</span> FCMNotification().notify_multiple_devices(registration_ids=tokens, message_body=notification)<br></code></pre></td></tr></table></figure><h4 id="app-fcm-baseapi-py"><a href="#app-fcm-baseapi-py" class="headerlink" title="app/fcm/baseapi.py"></a>app/fcm/baseapi.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> current_app<br><span class="hljs-keyword">from</span> requests.adapters <span class="hljs-keyword">import</span> HTTPAdapter<br><span class="hljs-keyword">from</span> requests.packages.urllib3 <span class="hljs-keyword">import</span> Retry<br><br><span class="hljs-keyword">from</span> .errors <span class="hljs-keyword">import</span> AuthenticationError, InvalidDataError, FCMError, FCMServerError, FCMNotRegisteredError<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseAPI</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Base class for the pyfcm API wrapper for FCM</span><br><span class="hljs-string">    Attributes:</span><br><span class="hljs-string">        api_key (str): Firebase API key</span><br><span class="hljs-string">        proxy_dict (dict): use proxy (keys: `http`, `https`)</span><br><span class="hljs-string">        env (str): for example &quot;app_engine&quot;</span><br><span class="hljs-string">        json_encoder</span><br><span class="hljs-string">        adapter: requests.adapters.HTTPAdapter()</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    CONTENT_TYPE = <span class="hljs-string">&quot;application/json&quot;</span><br>    FCM_END_POINT = <span class="hljs-string">&quot;https://fcm.googleapis.com/fcm/send&quot;</span><br>    INFO_END_POINT = <span class="hljs-string">&#x27;https://iid.googleapis.com/iid/info/&#x27;</span><br>    <span class="hljs-comment"># FCM only allows up to 1000 reg ids per bulk message.</span><br>    FCM_MAX_RECIPIENTS = <span class="hljs-number">1000</span><br><br>    <span class="hljs-comment">#: Indicates that the push message should be sent with low priority. Low</span><br>    <span class="hljs-comment">#: priority optimizes the client app&#x27;s battery consumption, and should be used</span><br>    <span class="hljs-comment">#: unless immediate delivery is required. For messages with low priority, the</span><br>    <span class="hljs-comment">#: app may receive the message with unspecified delay.</span><br>    FCM_LOW_PRIORITY = <span class="hljs-string">&#x27;normal&#x27;</span><br><br>    <span class="hljs-comment">#: Indicates that the push message should be sent with a high priority. When a</span><br>    <span class="hljs-comment">#: message is sent with high priority, it is sent immediately, and the app can</span><br>    <span class="hljs-comment">#: wake a sleeping device and open a network connection to your server.</span><br>    FCM_HIGH_PRIORITY = <span class="hljs-string">&#x27;high&#x27;</span><br><br>    <span class="hljs-comment"># Number of times to retry calls to info endpoint</span><br>    INFO_RETRIES = <span class="hljs-number">3</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, proxy_dict=None, env=None, json_encoder=None, adapter=None</span>):</span><br>        <span class="hljs-comment"># Your api-key can be gotten from:  https://console.firebase.google.com/project/&lt;project-name&gt;/settings/cloudmessaging</span><br>        api_key = current_app.config[<span class="hljs-string">&#x27;FCM_API_KEY&#x27;</span>]<br>        <span class="hljs-keyword">if</span> api_key:<br>            self._FCM_API_KEY = api_key<br>        <span class="hljs-keyword">elif</span> os.getenv(<span class="hljs-string">&#x27;FCM_API_KEY&#x27;</span>, <span class="hljs-literal">None</span>):<br>            self._FCM_API_KEY = os.getenv(<span class="hljs-string">&#x27;FCM_API_KEY&#x27;</span>, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> AuthenticationError(<span class="hljs-string">&quot;Please provide the api_key in the google-services.json file&quot;</span>)<br><br>        self.FCM_REQ_PROXIES = <span class="hljs-literal">None</span><br>        self.requests_session = requests.Session()<br>        retries = Retry(backoff_factor=<span class="hljs-number">1</span>, status_forcelist=[<span class="hljs-number">502</span>, <span class="hljs-number">503</span>],<br>                        method_whitelist=(Retry.DEFAULT_METHOD_WHITELIST | frozenset([<span class="hljs-string">&#x27;POST&#x27;</span>])))<br>        self.requests_session.mount(<span class="hljs-string">&#x27;http://&#x27;</span>, adapter <span class="hljs-keyword">or</span> HTTPAdapter(max_retries=retries))<br>        self.requests_session.mount(<span class="hljs-string">&#x27;https://&#x27;</span>, adapter <span class="hljs-keyword">or</span> HTTPAdapter(max_retries=retries))<br>        self.requests_session.headers.update(self.request_headers())<br>        self.requests_session.mount(self.INFO_END_POINT, HTTPAdapter(max_retries=self.INFO_RETRIES))<br><br>        <span class="hljs-keyword">if</span> proxy_dict <span class="hljs-keyword">and</span> isinstance(proxy_dict, dict) <span class="hljs-keyword">and</span> ((<span class="hljs-string">&#x27;http&#x27;</span> <span class="hljs-keyword">in</span> proxy_dict) <span class="hljs-keyword">or</span> (<span class="hljs-string">&#x27;https&#x27;</span> <span class="hljs-keyword">in</span> proxy_dict)):<br>            self.FCM_REQ_PROXIES = proxy_dict<br>            self.requests_session.proxies.update(proxy_dict)<br>        self.send_request_responses = []<br><br>        <span class="hljs-keyword">if</span> env == <span class="hljs-string">&#x27;app_engine&#x27;</span>:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">from</span> requests_toolbelt.adapters <span class="hljs-keyword">import</span> appengine<br>                appengine.monkeypatch()<br>            <span class="hljs-keyword">except</span> ModuleNotFoundError:<br>                <span class="hljs-keyword">pass</span><br><br>        self.json_encoder = json_encoder<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request_headers</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Generates request headers including Content-Type and Authorization</span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            dict: request headers</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> &#123;<br>            <span class="hljs-string">&quot;Content-Type&quot;</span>: self.CONTENT_TYPE,<br>            <span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;key=&quot;</span> + self._FCM_API_KEY,<br>        &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">registration_id_chunks</span>(<span class="hljs-params">self, registration_ids</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Splits registration ids in several lists of max 1000 registration ids per list</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            xrange<br>        <span class="hljs-keyword">except</span> NameError:<br>            xrange = range<br><br>        <span class="hljs-comment"># Yield successive 1000-sized (max fcm recipients per request) chunks from registration_ids</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">0</span>, len(registration_ids), self.FCM_MAX_RECIPIENTS):<br>            <span class="hljs-keyword">yield</span> registration_ids[i:i + self.FCM_MAX_RECIPIENTS]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">json_dumps</span>(<span class="hljs-params">self, data</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Standardized json.dumps function with separators and sorted keys set</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> json.dumps(<br>            data,<br>            separators=(<span class="hljs-string">&#x27;,&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>),<br>            sort_keys=<span class="hljs-literal">True</span>,<br>            cls=self.json_encoder,<br>            ensure_ascii=<span class="hljs-literal">False</span><br>        ).encode(<span class="hljs-string">&#x27;utf8&#x27;</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_payload</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                      registration_ids=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      topic_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      message_body=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      message_title=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      message_icon=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      sound=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      condition=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      collapse_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      delay_while_idle=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                      time_to_live=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      restricted_package_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      low_priority=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                      dry_run=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                      data_message=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      click_action=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      badge=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      color=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      tag=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      body_loc_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      body_loc_args=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      title_loc_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      title_loc_args=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      content_available=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      remove_notification=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                      android_channel_id=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                      extra_notification_kwargs=&#123;&#125;,</span></span><br><span class="hljs-function"><span class="hljs-params">                      **extra_kwargs</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Parses parameters of FCMNotification&#x27;s methods to FCM nested json</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        fcm_payload = dict()<br>        <span class="hljs-keyword">if</span> registration_ids:<br>            <span class="hljs-keyword">if</span> len(registration_ids) &gt; <span class="hljs-number">1</span>:<br>                fcm_payload[<span class="hljs-string">&#x27;registration_ids&#x27;</span>] = registration_ids<br>            <span class="hljs-keyword">else</span>:<br>                fcm_payload[<span class="hljs-string">&#x27;to&#x27;</span>] = registration_ids[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">if</span> condition:<br>            fcm_payload[<span class="hljs-string">&#x27;condition&#x27;</span>] = condition<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># In the `to` reference at: https://firebase.google.com/docs/cloud-messaging/http-server-ref#send-downstream</span><br>            <span class="hljs-comment"># We have `Do not set this field (to) when sending to multiple topics`</span><br>            <span class="hljs-comment"># Which is why it&#x27;s in the `else` block since `condition` is used when multiple topics are being targeted</span><br>            <span class="hljs-keyword">if</span> topic_name:<br>                fcm_payload[<span class="hljs-string">&#x27;to&#x27;</span>] = <span class="hljs-string">&#x27;/topics/%s&#x27;</span> % topic_name<br>        <span class="hljs-comment"># Revert to legacy API compatible priority</span><br>        <span class="hljs-keyword">if</span> low_priority:<br>            fcm_payload[<span class="hljs-string">&#x27;priority&#x27;</span>] = self.FCM_LOW_PRIORITY<br>        <span class="hljs-keyword">else</span>:<br>            fcm_payload[<span class="hljs-string">&#x27;priority&#x27;</span>] = self.FCM_HIGH_PRIORITY<br><br>        <span class="hljs-keyword">if</span> delay_while_idle:<br>            fcm_payload[<span class="hljs-string">&#x27;delay_while_idle&#x27;</span>] = delay_while_idle<br>        <span class="hljs-keyword">if</span> collapse_key:<br>            fcm_payload[<span class="hljs-string">&#x27;collapse_key&#x27;</span>] = collapse_key<br>        <span class="hljs-keyword">if</span> time_to_live <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> isinstance(time_to_live, int):<br>                fcm_payload[<span class="hljs-string">&#x27;time_to_live&#x27;</span>] = time_to_live<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">raise</span> InvalidDataError(<span class="hljs-string">&quot;Provided time_to_live is not an integer&quot;</span>)<br>        <span class="hljs-keyword">if</span> restricted_package_name:<br>            fcm_payload[<span class="hljs-string">&#x27;restricted_package_name&#x27;</span>] = restricted_package_name<br>        <span class="hljs-keyword">if</span> dry_run:<br>            fcm_payload[<span class="hljs-string">&#x27;dry_run&#x27;</span>] = dry_run<br><br>        <span class="hljs-keyword">if</span> data_message:<br>            <span class="hljs-keyword">if</span> isinstance(data_message, dict):<br>                fcm_payload[<span class="hljs-string">&#x27;data&#x27;</span>] = data_message<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">raise</span> InvalidDataError(<span class="hljs-string">&quot;Provided data_message is in the wrong format&quot;</span>)<br><br>        fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>] = &#123;&#125;<br>        <span class="hljs-keyword">if</span> message_icon:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;icon&#x27;</span>] = message_icon<br>        <span class="hljs-comment"># If body is present, use it</span><br>        <span class="hljs-keyword">if</span> message_body:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;body&#x27;</span>] = message_body<br>        <span class="hljs-comment"># Else use body_loc_key and body_loc_args for body</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> body_loc_key:<br>                fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;body_loc_key&#x27;</span>] = body_loc_key<br>            <span class="hljs-keyword">if</span> body_loc_args:<br>                <span class="hljs-keyword">if</span> isinstance(body_loc_args, list):<br>                    fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;body_loc_args&#x27;</span>] = body_loc_args<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">raise</span> InvalidDataError(<span class="hljs-string">&#x27;body_loc_args should be an array&#x27;</span>)<br>        <span class="hljs-comment"># If title is present, use it</span><br>        <span class="hljs-keyword">if</span> message_title:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;title&#x27;</span>] = message_title<br>        <span class="hljs-comment"># Else use title_loc_key and title_loc_args for title</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> title_loc_key:<br>                fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;title_loc_key&#x27;</span>] = title_loc_key<br>            <span class="hljs-keyword">if</span> title_loc_args:<br>                <span class="hljs-keyword">if</span> isinstance(title_loc_args, list):<br>                    fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;title_loc_args&#x27;</span>] = title_loc_args<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">raise</span> InvalidDataError(<span class="hljs-string">&#x27;title_loc_args should be an array&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> android_channel_id:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;android_channel_id&#x27;</span>] = android_channel_id<br><br>        <span class="hljs-comment"># This is needed for iOS when we are sending only custom data messages</span><br>        <span class="hljs-keyword">if</span> content_available <span class="hljs-keyword">and</span> isinstance(content_available, bool):<br>            fcm_payload[<span class="hljs-string">&#x27;content_available&#x27;</span>] = content_available<br><br>        <span class="hljs-keyword">if</span> click_action:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;click_action&#x27;</span>] = click_action<br>        <span class="hljs-keyword">if</span> isinstance(badge, int) <span class="hljs-keyword">and</span> badge &gt;= <span class="hljs-number">0</span>:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;badge&#x27;</span>] = badge<br>        <span class="hljs-keyword">if</span> color:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;color&#x27;</span>] = color<br>        <span class="hljs-keyword">if</span> tag:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;tag&#x27;</span>] = tag<br>        <span class="hljs-comment"># only add the &#x27;sound&#x27; key if sound is not None</span><br>        <span class="hljs-comment"># otherwise a default sound will play -- even with empty string args.</span><br>        <span class="hljs-keyword">if</span> sound:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>][<span class="hljs-string">&#x27;sound&#x27;</span>] = sound<br><br>        <span class="hljs-keyword">if</span> extra_kwargs:<br>            fcm_payload.update(extra_kwargs)<br><br>        <span class="hljs-keyword">if</span> extra_notification_kwargs:<br>            fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>].update(extra_notification_kwargs)<br><br>        <span class="hljs-comment"># Do this if you only want to send a data message.</span><br>        <span class="hljs-keyword">if</span> remove_notification:<br>            <span class="hljs-keyword">del</span> fcm_payload[<span class="hljs-string">&#x27;notification&#x27;</span>]<br><br>        <span class="hljs-keyword">return</span> self.json_dumps(fcm_payload)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">do_request</span>(<span class="hljs-params">self, payload, timeout</span>):</span><br>        response = self.requests_session.post(self.FCM_END_POINT, data=payload, timeout=timeout)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Retry-After&#x27;</span> <span class="hljs-keyword">in</span> response.headers <span class="hljs-keyword">and</span> int(response.headers[<span class="hljs-string">&#x27;Retry-After&#x27;</span>]) &gt; <span class="hljs-number">0</span>:<br>            sleep_time = int(response.headers[<span class="hljs-string">&#x27;Retry-After&#x27;</span>])<br>            time.sleep(sleep_time)<br>            <span class="hljs-keyword">return</span> self.do_request(payload, timeout)<br>        <span class="hljs-keyword">return</span> response<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_request</span>(<span class="hljs-params">self, payloads=None, timeout=None</span>):</span><br>        self.send_request_responses = []<br>        <span class="hljs-keyword">for</span> payload <span class="hljs-keyword">in</span> payloads:<br>            response = self.do_request(payload, timeout)<br>            self.send_request_responses.append(response)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">registration_info_request</span>(<span class="hljs-params">self, registration_id</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Makes a request for registration info and returns the response object</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> self.requests_session.get(<br>            self.INFO_END_POINT + registration_id,<br>            params=&#123;<span class="hljs-string">&#x27;details&#x27;</span>: <span class="hljs-string">&#x27;true&#x27;</span>&#125;<br>        )<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clean_registration_ids</span>(<span class="hljs-params">self, registration_ids=[]</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Checks registration ids and excludes inactive ids</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        valid_registration_ids = []<br>        <span class="hljs-keyword">for</span> registration_id <span class="hljs-keyword">in</span> registration_ids:<br>            details = self.registration_info_request(registration_id)<br>            <span class="hljs-keyword">if</span> details.status_code == <span class="hljs-number">200</span>:<br>                valid_registration_ids.append(registration_id)<br>        <span class="hljs-keyword">return</span> valid_registration_ids<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_registration_id_info</span>(<span class="hljs-params">self, registration_id</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Returns details related to a registration id if it exists otherwise return None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        response = self.registration_info_request(registration_id)<br>        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>            <span class="hljs-keyword">return</span> response.json()<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">subscribe_registration_ids_to_topic</span>(<span class="hljs-params">self, registration_ids, topic_name</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Subscribes a list of registration ids to a topic</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        url = <span class="hljs-string">&#x27;https://iid.googleapis.com/iid/v1:batchAdd&#x27;</span><br>        payload = &#123;<br>            <span class="hljs-string">&#x27;to&#x27;</span>: <span class="hljs-string">&#x27;/topics/&#x27;</span> + topic_name,<br>            <span class="hljs-string">&#x27;registration_tokens&#x27;</span>: registration_ids,<br>        &#125;<br>        response = self.requests_session.post(url, json=payload)<br>        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">400</span>:<br>            error = response.json()<br>            <span class="hljs-keyword">raise</span> InvalidDataError(error[<span class="hljs-string">&#x27;error&#x27;</span>])<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> FCMError()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unsubscribe_registration_ids_from_topic</span>(<span class="hljs-params">self, registration_ids, topic_name</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Unsubscribes a list of registration ids from a topic</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        url = <span class="hljs-string">&quot;https://iid.googleapis.com/iid/v1:batchRemove&quot;</span><br>        payload = &#123;<br>            <span class="hljs-string">&#x27;to&#x27;</span>: <span class="hljs-string">&#x27;/topics/&#x27;</span> + topic_name,<br>            <span class="hljs-string">&#x27;registration_tokens&#x27;</span>: registration_ids,<br>        &#125;<br>        response = self.requests_session.post(url, json=payload)<br>        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">400</span>:<br>            error = response.json()<br>            <span class="hljs-keyword">raise</span> InvalidDataError(error[<span class="hljs-string">&#x27;error&#x27;</span>])<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> FCMError()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_responses</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Parses the json response sent back by the server and tries to get out the important return variables</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        response_dict = &#123;<br>            <span class="hljs-string">&#x27;multicast_ids&#x27;</span>: [],<br>            <span class="hljs-string">&#x27;success&#x27;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&#x27;failure&#x27;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&#x27;canonical_ids&#x27;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&#x27;results&#x27;</span>: [],<br>            <span class="hljs-string">&#x27;topic_message_id&#x27;</span>: <span class="hljs-literal">None</span><br>        &#125;<br><br>        <span class="hljs-keyword">for</span> response <span class="hljs-keyword">in</span> self.send_request_responses:<br>            <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;content-length&#x27;</span> <span class="hljs-keyword">in</span> response.headers <span class="hljs-keyword">and</span> int(response.headers[<span class="hljs-string">&#x27;content-length&#x27;</span>]) &lt;= <span class="hljs-number">0</span>:<br>                    <span class="hljs-keyword">raise</span> FCMServerError(<span class="hljs-string">&quot;FCM server connection error, the response is empty&quot;</span>)<br>                <span class="hljs-keyword">else</span>:<br>                    parsed_response = response.json()<br><br>                    multicast_id = parsed_response.get(<span class="hljs-string">&#x27;multicast_id&#x27;</span>, <span class="hljs-literal">None</span>)<br>                    success = parsed_response.get(<span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-number">0</span>)<br>                    failure = parsed_response.get(<span class="hljs-string">&#x27;failure&#x27;</span>, <span class="hljs-number">0</span>)<br>                    canonical_ids = parsed_response.get(<span class="hljs-string">&#x27;canonical_ids&#x27;</span>, <span class="hljs-number">0</span>)<br>                    results = parsed_response.get(<span class="hljs-string">&#x27;results&#x27;</span>, [])<br>                    message_id = parsed_response.get(<span class="hljs-string">&#x27;message_id&#x27;</span>, <span class="hljs-literal">None</span>)  <span class="hljs-comment"># for topic messages</span><br>                    <span class="hljs-keyword">if</span> message_id:<br>                        success = <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">if</span> multicast_id:<br>                        response_dict[<span class="hljs-string">&#x27;multicast_ids&#x27;</span>].append(multicast_id)<br>                    response_dict[<span class="hljs-string">&#x27;success&#x27;</span>] += success<br>                    response_dict[<span class="hljs-string">&#x27;failure&#x27;</span>] += failure<br>                    response_dict[<span class="hljs-string">&#x27;canonical_ids&#x27;</span>] += canonical_ids<br>                    response_dict[<span class="hljs-string">&#x27;results&#x27;</span>].extend(results)<br>                    response_dict[<span class="hljs-string">&#x27;topic_message_id&#x27;</span>] = message_id<br><br>            <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">401</span>:<br>                <span class="hljs-keyword">raise</span> AuthenticationError(<span class="hljs-string">&quot;There was an error authenticating the sender account&quot;</span>)<br>            <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">400</span>:<br>                <span class="hljs-keyword">raise</span> InvalidDataError(response.text)<br>            <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">404</span>:<br>                <span class="hljs-keyword">raise</span> FCMNotRegisteredError(<span class="hljs-string">&quot;Token not registered&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">raise</span> FCMServerError(<span class="hljs-string">&quot;FCM server is temporarily unavailable&quot;</span>)<br>        <span class="hljs-keyword">return</span> response_dict<br></code></pre></td></tr></table></figure><h4 id="api-fcm-errors-py"><a href="#api-fcm-errors-py" class="headerlink" title="api/fcm/errors.py"></a>api/fcm/errors.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FCMError</span>(<span class="hljs-params">Exception</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    PyFCM Error</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthenticationError</span>(<span class="hljs-params">FCMError</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    API key not found or there was an error authenticating the sender</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FCMNotRegisteredError</span>(<span class="hljs-params">FCMError</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    push token is not registered</span><br><span class="hljs-string">    https://firebase.google.com/docs/reference/fcm/rest/v1/ErrorCode</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FCMServerError</span>(<span class="hljs-params">FCMError</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Internal server error or timeout error on Firebase cloud messaging server</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvalidDataError</span>(<span class="hljs-params">FCMError</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Invalid input</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InternalPackageError</span>(<span class="hljs-params">FCMError</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    JSON parsing error, please create a new github issue describing what you&#x27;re doing</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RetryAfterException</span>(<span class="hljs-params">Exception</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Retry-After must be handled by external logic.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, delay</span>):</span><br>        self.delay = delay<br></code></pre></td></tr></table></figure><h4 id="api-fcm-errors-py-1"><a href="#api-fcm-errors-py-1" class="headerlink" title="api/fcm/errors.py"></a>api/fcm/errors.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> .baseapi <span class="hljs-keyword">import</span> BaseAPI<br><span class="hljs-keyword">from</span> .errors <span class="hljs-keyword">import</span> InvalidDataError<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FCMNotification</span>(<span class="hljs-params">BaseAPI</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">notify_single_device</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                             registration_id=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             message_body=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             message_title=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             message_icon=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             sound=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             condition=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             collapse_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             delay_while_idle=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                             time_to_live=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             restricted_package_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             low_priority=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                             dry_run=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                             data_message=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             click_action=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             badge=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             color=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             tag=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             body_loc_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             body_loc_args=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             title_loc_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             title_loc_args=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             content_available=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             android_channel_id=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             timeout=<span class="hljs-number">5</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">                             extra_notification_kwargs=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                             extra_kwargs=&#123;&#125;</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Send push notification to a single device</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> registration_id <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">raise</span> InvalidDataError(<span class="hljs-string">&#x27;Invalid registration ID&#x27;</span>)<br>        <span class="hljs-comment"># [registration_id] cos we&#x27;re sending to a single device</span><br>        payload = self.parse_payload(<br>            registration_ids=[registration_id],<br>            message_body=message_body,<br>            message_title=message_title,<br>            message_icon=message_icon,<br>            sound=sound,<br>            condition=condition,<br>            collapse_key=collapse_key,<br>            delay_while_idle=delay_while_idle,<br>            time_to_live=time_to_live,<br>            restricted_package_name=restricted_package_name,<br>            low_priority=low_priority,<br>            dry_run=dry_run, data_message=data_message, click_action=click_action,<br>            badge=badge,<br>            color=color,<br>            tag=tag,<br>            body_loc_key=body_loc_key,<br>            body_loc_args=body_loc_args,<br>            title_loc_key=title_loc_key,<br>            title_loc_args=title_loc_args,<br>            android_channel_id=android_channel_id,<br>            content_available=content_available,<br>            extra_notification_kwargs=extra_notification_kwargs,<br>            **extra_kwargs<br>        )<br><br>        self.send_request([payload], timeout)<br>        <span class="hljs-keyword">return</span> self.parse_responses()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">single_device_data_message</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   registration_id=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   condition=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   collapse_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   delay_while_idle=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   time_to_live=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   restricted_package_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   low_priority=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   dry_run=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   data_message=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   content_available=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   android_channel_id=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   timeout=<span class="hljs-number">5</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   extra_notification_kwargs=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                   extra_kwargs=&#123;&#125;</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Send push message to a single device</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> registration_id <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">raise</span> InvalidDataError(<span class="hljs-string">&#x27;Invalid registration ID&#x27;</span>)<br>        <span class="hljs-comment"># [registration_id] cos we&#x27;re sending to a single device</span><br>        payload = self.parse_payload(<br>            registration_ids=[registration_id],<br>            condition=condition,<br>            collapse_key=collapse_key,<br>            delay_while_idle=delay_while_idle,<br>            time_to_live=time_to_live,<br>            restricted_package_name=restricted_package_name,<br>            low_priority=low_priority,<br>            dry_run=dry_run,<br>            data_message=data_message,<br>            content_available=content_available,<br>            remove_notification=<span class="hljs-literal">True</span>,<br>            android_channel_id=android_channel_id,<br>            extra_notification_kwargs=extra_notification_kwargs,<br>            **extra_kwargs<br>        )<br><br>        self.send_request([payload], timeout)<br>        <span class="hljs-keyword">return</span> self.parse_responses()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">notify_multiple_devices</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                                registration_ids=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                message_body=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                message_title=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                message_icon=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                sound=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                condition=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                collapse_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                delay_while_idle=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                time_to_live=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                restricted_package_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                low_priority=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                dry_run=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                data_message=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                click_action=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                badge=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                color=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                tag=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                body_loc_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                body_loc_args=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                title_loc_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                title_loc_args=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                content_available=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                android_channel_id=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                timeout=<span class="hljs-number">5</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">                                extra_notification_kwargs=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                extra_kwargs=&#123;&#125;</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Sends push notification to multiple devices, can send to over 1000 devices</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(registration_ids, list):<br>            <span class="hljs-keyword">raise</span> InvalidDataError(<span class="hljs-string">&#x27;Invalid registration IDs (should be list)&#x27;</span>)<br><br>        payloads = []<br><br>        registration_id_chunks = self.registration_id_chunks(registration_ids)<br>        <span class="hljs-keyword">for</span> registration_ids <span class="hljs-keyword">in</span> registration_id_chunks:<br>            <span class="hljs-comment"># appends a payload with a chunk of registration ids here</span><br>            payloads.append(self.parse_payload(<br>                registration_ids=registration_ids,<br>                message_body=message_body,<br>                message_title=message_title,<br>                message_icon=message_icon,<br>                sound=sound,<br>                condition=condition,<br>                collapse_key=collapse_key,<br>                delay_while_idle=delay_while_idle,<br>                time_to_live=time_to_live,<br>                restricted_package_name=restricted_package_name,<br>                low_priority=low_priority,<br>                dry_run=dry_run, data_message=data_message,<br>                click_action=click_action,<br>                badge=badge,<br>                color=color,<br>                tag=tag,<br>                body_loc_key=body_loc_key,<br>                body_loc_args=body_loc_args,<br>                title_loc_key=title_loc_key,<br>                title_loc_args=title_loc_args,<br>                content_available=content_available,<br>                android_channel_id=android_channel_id,<br>                extra_notification_kwargs=extra_notification_kwargs,<br>                **extra_kwargs<br>            ))<br>        self.send_request(payloads, timeout)<br>        <span class="hljs-keyword">return</span> self.parse_responses()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">multiple_devices_data_message</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      registration_ids=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      condition=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      collapse_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      delay_while_idle=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      time_to_live=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      restricted_package_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      low_priority=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      dry_run=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      data_message=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      content_available=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      timeout=<span class="hljs-number">5</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      extra_notification_kwargs=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      extra_kwargs=&#123;&#125;</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Sends push message to multiple devices, can send to over 1000 devices</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(registration_ids, list):<br>            <span class="hljs-keyword">raise</span> InvalidDataError(<span class="hljs-string">&#x27;Invalid registration IDs (should be list)&#x27;</span>)<br><br>        payloads = []<br>        registration_id_chunks = self.registration_id_chunks(registration_ids)<br>        <span class="hljs-keyword">for</span> registration_ids <span class="hljs-keyword">in</span> registration_id_chunks:<br>            <span class="hljs-comment"># appends a payload with a chunk of registration ids here</span><br>            payloads.append(self.parse_payload(<br>                registration_ids=registration_ids,<br>                condition=condition,<br>                collapse_key=collapse_key,<br>                delay_while_idle=delay_while_idle,<br>                time_to_live=time_to_live,<br>                restricted_package_name=restricted_package_name,<br>                low_priority=low_priority,<br>                dry_run=dry_run,<br>                data_message=data_message,<br>                content_available=content_available,<br>                remove_notification=<span class="hljs-literal">True</span>,<br>                extra_notification_kwargs=extra_notification_kwargs,<br>                **extra_kwargs)<br>            )<br>        self.send_request(payloads, timeout)<br>        <span class="hljs-keyword">return</span> self.parse_responses()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">notify_topic_subscribers</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 topic_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 message_body=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 message_title=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 message_icon=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 sound=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 condition=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 collapse_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 delay_while_idle=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 time_to_live=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 restricted_package_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 low_priority=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 dry_run=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 data_message=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 click_action=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 badge=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 color=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 tag=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 body_loc_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 body_loc_args=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 title_loc_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 title_loc_args=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 content_available=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 android_channel_id=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 timeout=<span class="hljs-number">5</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 extra_notification_kwargs=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 extra_kwargs=&#123;&#125;</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Sends push notification to multiple devices subscribed to a topic</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        payload = self.parse_payload(<br>            topic_name=topic_name,<br>            condition=condition,<br>            message_body=message_body,<br>            message_title=message_title,<br>            message_icon=message_icon,<br>            sound=sound,<br>            collapse_key=collapse_key,<br>            delay_while_idle=delay_while_idle,<br>            time_to_live=time_to_live,<br>            restricted_package_name=restricted_package_name,<br>            low_priority=low_priority,<br>            dry_run=dry_run, data_message=data_message, click_action=click_action,<br>            badge=badge,<br>            color=color,<br>            tag=tag,<br>            body_loc_key=body_loc_key,<br>            body_loc_args=body_loc_args,<br>            title_loc_key=title_loc_key,<br>            title_loc_args=title_loc_args,<br>            content_available=content_available,<br>            android_channel_id=android_channel_id,<br>            extra_notification_kwargs=extra_notification_kwargs,<br>            **extra_kwargs<br>        )<br>        self.send_request([payload], timeout)<br>        <span class="hljs-keyword">return</span> self.parse_responses()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">topic_subscribers_data_message</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       topic_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       condition=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       collapse_key=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       delay_while_idle=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       time_to_live=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       restricted_package_name=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       low_priority=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       dry_run=False,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       data_message=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       content_available=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       timeout=<span class="hljs-number">5</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       extra_notification_kwargs=None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                       extra_kwargs=&#123;&#125;</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Sends data notification to multiple devices subscribed to a topic</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> extra_kwargs <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            extra_kwargs = &#123;&#125;<br>        payload = self.parse_payload(topic_name=topic_name,<br>                                     condition=condition,<br>                                     collapse_key=collapse_key,<br>                                     delay_while_idle=delay_while_idle,<br>                                     time_to_live=time_to_live,<br>                                     restricted_package_name=restricted_package_name,<br>                                     low_priority=low_priority,<br>                                     dry_run=dry_run,<br>                                     data_message=data_message,<br>                                     content_available=content_available,<br>                                     remove_notification=<span class="hljs-literal">True</span>,<br>                                     extra_notification_kwargs=extra_notification_kwargs,<br>                                     **extra_kwargs)<br>        self.send_request([payload], timeout)<br>        <span class="hljs-keyword">return</span> self.parse_responses()<br></code></pre></td></tr></table></figure><h3 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h3><ul><li>本地环境和线上环境如果在墙内，需要设置vpn才能推送成功，并且安卓手机想要收到推送消息，必须有google全家桶，同样的需要设置vpn才能正常收到消息。</li><li>registration_id (device_token) 需要和 api_key 需要在同一个fcm项目下，不然registration_id会验证失败。</li></ul><p>**参考文章： **<a href="https://firebase.google.com/docs/cloud-messaging/http-server-ref#notification-payload-support">FCM官文</a> / <a href="https://github.com/olucurious/PyFCM">PyFCM库</a></p>]]></content>
    
    
    <categories>
      
      <category>推送</category>
      
    </categories>
    
    
    <tags>
      
      <tag>推送</tag>
      
      <tag>FCM</tag>
      
      <tag>android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Celery+Rabbitmq实现异步调度</title>
    <link href="/Myblog/2020/03/17/Celery-Rabbitmq%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E8%B0%83%E5%BA%A6/"/>
    <url>/Myblog/2020/03/17/Celery-Rabbitmq%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E8%B0%83%E5%BA%A6/</url>
    
    <content type="html"><![CDATA[<h3 id="异步任务场景"><a href="#异步任务场景" class="headerlink" title="异步任务场景"></a>异步任务场景</h3><p>当业务场景涉及需要调用第三方应用，或者一些比较耗时，并且不需要立马执行，不需要等待执行完成拿到结果。在这种情况下，不能让耗时任务阻碍主线程任务进行，所以需要使用异步任务执行。</p><h3 id="第三方库使用"><a href="#第三方库使用" class="headerlink" title="第三方库使用"></a>第三方库使用</h3><p>我们使用celery调度异步任务，队列使用rabbitmq，结果保存在redis持久化。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install celery<br></code></pre></td></tr></table></figure><blockquote><p>Flask-Celery官方已经不推荐使用！</p></blockquote><h3 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h3><p>目录树如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">├── app<br>│   ├── __init__.py<br>│   ├── models.py<br>│   ├── resources<br>│   │   ├── __init__.py<br>│   │   ├── order.py<br>│   ├── tasks<br>│   │   ├── __init__.py<br>│   │   └── order_task.py<br>├── config<br>│   ├── __init__.py<br>│   ├── celery_config.py<br>│   ├── default.py<br>│   ├── development.py<br>│   ├── production.py<br>│   └── staging.py<br>├── docker-compose.yml<br>├── run.py<br></code></pre></td></tr></table></figure><h4 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">mq:<br>  image: rabbitmq:3.7-management-alpine<br>  ports:<br>    - 5672:5672<br>    - 15672:15672<br>  environment:<br>    - RABBITMQ_DEFAULT_USER=xxx<br>    - RABBITMQ_DEFAULT_PASS=xxx<br>    - RABBITMQ_DEFAULT_VHOST=xxx<br>  volumes:<br>    - /var/lib/rabbitmq/mnesia<br></code></pre></td></tr></table></figure><blockquote><p>docker创建rabbitmq容器，本地打开<code>127.0.0.1:15672</code>，输入账号名和密码可以查看队列状态。</p></blockquote><h4 id="config-celery-config-py"><a href="#config-celery-config-py" class="headerlink" title="config/celery_config.py"></a>config/celery_config.py</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">from</span> kombu import Queue<br><br>enable_utc = <span class="hljs-literal">False</span><br>imports = (<span class="hljs-string">&#x27;app.tasks.order_task&#x27;</span>,)<br><span class="hljs-comment"># result_backend_transport_options = &#123;&#x27;master_name&#x27;: &quot;mymaster&quot;&#125;</span><br>task_soft_time_limit = 600<br>task_create_missing_queues = <span class="hljs-literal">False</span><br>worker_concurrency = 4      # celery worker的并发数，默认是服务器的内核数目,也是命令行-c参数指定的数目<br>worker_prefetch_multiplier = 4        # celery worker 每次去BROKER中预取任务的数量<br>worker_disable_rate_limits = <span class="hljs-literal">True</span>      # 关闭限速<br><br>task_queues = (Queue(<span class="hljs-string">&#x27;celery&#x27;</span>, <span class="hljs-attribute">routing_key</span>=<span class="hljs-string">&#x27;celery&#x27;</span>),<br>               Queue(<span class="hljs-string">&#x27;order_task&#x27;</span>, <span class="hljs-attribute">routing_key</span>=<span class="hljs-string">&#x27;order_task&#x27;</span>))<br>               <br>task_routes = &#123;<br>    <span class="hljs-string">&quot;app.tasks.order_task.*&quot;</span>: &#123;<span class="hljs-string">&quot;queue&quot;</span>: <span class="hljs-string">&quot;order_task&quot;</span>, <span class="hljs-string">&quot;routing_key&quot;</span>: <span class="hljs-string">&quot;order_task&quot;</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>imports：指定异步任务方法位置</p><p>task_queues：1、celery队列为默认队列，必须要有；2、最好每一类任务添加一个队列</p><p>task_routes：任务添加时根据标头自动添加到对应队列</p></blockquote><h4 id="config-development-py"><a href="#config-development-py" class="headerlink" title="config/development.py"></a>config/development.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">CELERY_BROKER_URL = <span class="hljs-string">&#x27;amqp://xxx:xxx@127.0.0.1:5672/xxx&#x27;</span>     <span class="hljs-comment"># username:password@host:port/virtual host</span><br>CELERY_RESULT_BACKEND = <span class="hljs-string">&#x27;redis://127.0.0.1:6379/0&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p>设置对应环境celery使用队列，以及结果保存位置</p><p><code>virtual host</code>:  可为空</p></blockquote><h4 id="app-init-py"><a href="#app-init-py" class="headerlink" title="app/init.py"></a>app/init.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_app</span>(<span class="hljs-params">test_config=None</span>):</span><br>    app = Flask(__name__, instance_relative_config=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-comment"># 加载配置文件，需设置配置文件路径（环境变量设置）</span><br>    app.config.from_object(<span class="hljs-string">&#x27;config.default&#x27;</span>)<br>    app.config.from_envvar(<span class="hljs-string">&#x27;APP_CONFIG_FILE&#x27;</span>)   <br><br>    <span class="hljs-keyword">return</span> app<br><br>app = create_app()<br></code></pre></td></tr></table></figure><h4 id="app-task-init-py"><a href="#app-task-init-py" class="headerlink" title="app/task/init.py"></a>app/task/init.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> celery <span class="hljs-keyword">import</span> Celery<br><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> celery_config<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_celery</span>():</span><br>    celery = Celery(<br>        broker=os.environ.get(<span class="hljs-string">&quot;CELERY_BROKER_URL&quot;</span>,<br>                              <span class="hljs-string">&quot;amqp://hubblenet:hubblenet@127.0.0.1:5672&quot;</span>),<br>        backend=os.environ.get(<span class="hljs-string">&quot;CELERY_RESULT_BACKEND&quot;</span>,<br>                               <span class="hljs-string">&quot;redis://127.0.0.1:6379/2&quot;</span>)<br>    )<br>    celery.config_from_object(celery_config)<br><br>    <span class="hljs-keyword">return</span> celery<br><br><br>celery_app = make_celery()<br><br></code></pre></td></tr></table></figure><h4 id="app-task-order-task-py"><a href="#app-task-order-task-py" class="headerlink" title="app/task/order_task.py"></a>app/task/order_task.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> celery_app<br><br><span class="hljs-meta">@celery_app.task(ignore_result=True, queue=&#x27;order_task&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">order_notification_task</span>(<span class="hljs-params">salesman_code</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;订单推送通知任务&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure><blockquote><p>ignore_result：忽略结果；</p><p>queue：指定任务加入队列， celery添加了task_routes参数可以不用指定队列</p></blockquote><h4 id="app-resources-order-py"><a href="#app-resources-order-py" class="headerlink" title="app/resources/order.py"></a>app/resources/order.py</h4><p>在这里执行调用异步任务</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">order_notification_task.delay(salesman_code=salesman_no)<br></code></pre></td></tr></table></figure><blockquote><p>异步任务需要使用delay方式调用。同样也可以使用apply_async方法调用，可以设置额外参数</p></blockquote><h4 id="建立worker常驻进程消费任务"><a href="#建立worker常驻进程消费任务" class="headerlink" title="建立worker常驻进程消费任务"></a>建立worker常驻进程消费任务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">celery -A app.tasks worker -P gevent -l info -Q celery,order_task<br></code></pre></td></tr></table></figure><blockquote><p><code>-A</code> ：celery实例位置 </p><p><code>-P</code>：指定并发模式(<code>prefork (default)</code>，<code>eventlet</code>，<code>gevent</code>，<code>threads</code>， <code>solo</code>)</p><p><code>-Q</code> ：消费目标队列，多个队列使用<code>,</code>间隔</p></blockquote><p><code>celery worker --help</code>  查看更多命令行参数可以</p><p>相关文章链接： <a href="https://blog.csdn.net/u012206617/article/details/106495425">Celery参数详解、配置参数</a> / <a href="https://www.celerycn.io/yong-hu-zhi-nan/tiao-yong-ren-wu-calling-tasks">Celery 中文手册</a></p>]]></content>
    
    
    <categories>
      
      <category>Celery</category>
      
    </categories>
    
    
    <tags>
      
      <tag>celery</tag>
      
      <tag>异步任务</tag>
      
      <tag>rabbitmq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python实现APNs2推送详解</title>
    <link href="/Myblog/2020/03/10/python%E5%AE%9E%E7%8E%B0APNs2%E6%8E%A8%E9%80%81%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2020/03/10/python%E5%AE%9E%E7%8E%B0APNs2%E6%8E%A8%E9%80%81%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="APNs2详解"><a href="#APNs2详解" class="headerlink" title="APNs2详解"></a>APNs2详解</h3><p>APNs提供程序API允许您将远程通知请求发送到APN。然后，APNs将通知传送到iOS，tvOS和macOS设备上的应用程序，并通过iOS传送给Apple Watch。</p><p>提供者API基于HTTP / 2网络协议。每次交互都从提供者发出的POST请求开始，该请求包含JSON有效负载和设备令牌。APNs将通知有效负载转发到由请求的包含设备令牌标识的特定用户设备上的应用程序。</p><p><strong>本文参考<a href="https://github.com/Pr0Ger/PyAPNs2">PyAPNs2</a>三方库</strong>，因为需要修改部分代码，所以复制了代码到项目。</p><h3 id="准备通讯凭证"><a href="#准备通讯凭证" class="headerlink" title="准备通讯凭证"></a>准备通讯凭证</h3><ol><li>实现与APN通讯，需要提供<code>身份验证令牌</code> 或者<code>APNs提供商证书</code>，证书中必须选中允许APNs推送，并且后缀名为<code>.pem</code>。</li><li>提供与证书对应的bundle Identifier，例如<code>com.example.apple</code></li><li>提供需要推送到特定设备的<code>device_token</code>，<code>device_token</code>每个设备安装app时确定并且唯一。</li></ol><h3 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h3><h4 id="文件目录结构"><a href="#文件目录结构" class="headerlink" title="文件目录结构"></a>文件目录结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">.<br>├── test.py<br>├── apns2<br>│   ├── client.py<br>│   ├── credentials.py<br>│   ├── errors.py<br>│   ├── payload.py<br></code></pre></td></tr></table></figure><h4 id="test-py"><a href="#test-py" class="headerlink" title="test.py"></a>test.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> collections<br><span class="hljs-keyword">from</span> apns2.client <span class="hljs-keyword">import</span> APNsClient<br><span class="hljs-keyword">from</span> apns2.payload <span class="hljs-keyword">import</span> Payload<br><br>SADBOX_SERVER = <span class="hljs-string">&#x27;api.development.push.apple.com&#x27;</span><br>PRODUCT_SERVER = <span class="hljs-string">&#x27;api.push.apple.com&#x27;</span><br>DEFAULT_PORT = <span class="hljs-number">443</span><br>ALTERNATIVE_PORT = <span class="hljs-number">2197</span><br><br>device_token = <span class="hljs-string">&#x27;c58b05dabd54ehthdc138a875059ef4f66d1ae4e1f1c04f1c8bcf967f84&#x27;</span><br>payload = Payload(alert=<span class="hljs-string">&quot;Hello World!&quot;</span>, sound=<span class="hljs-string">&quot;default&quot;</span>, badge=<span class="hljs-number">1</span>)<br>payload2 = Payload(alert=<span class="hljs-string">&quot;Hello World!!&quot;</span>, sound=<span class="hljs-string">&quot;default&quot;</span>, badge=<span class="hljs-number">1</span>)<br>payload3 = Payload(alert=<span class="hljs-string">&quot;Hello World!!!&quot;</span>, sound=<span class="hljs-string">&quot;default&quot;</span>, badge=<span class="hljs-number">1</span>)<br>topic = <span class="hljs-string">&#x27;com.example.apple&#x27;</span><br>pem_file = <span class="hljs-string">&#x27;push_cer_sandbox_key.pem&#x27;</span><br>client = APNsClient(pem_file, password=<span class="hljs-string">&#x27;000000&#x27;</span>, server=SADBOX_SERVER, port=DEFAULT_PORT)<br>client.send_notification(device_token, payload, topic)  <span class="hljs-comment"># 发送单条通知</span><br><br>Notification = collections.namedtuple(<span class="hljs-string">&#x27;Notification&#x27;</span>, [<span class="hljs-string">&#x27;token&#x27;</span>, <span class="hljs-string">&#x27;payload&#x27;</span>])<br>notifications = [Notification(payload=payload, token=device_token),<br>                 Notification(payload=payload2, token=device_token),<br>                 Notification(payload=payload3, token=device_token)]<br>client.send_notification_batch(notifications=notifications, topic=topic)  <span class="hljs-comment"># 发送多条通知</span><br></code></pre></td></tr></table></figure><blockquote><p>SADBOX_SERVER指本地测试开发使用服务器地址，PRODUCT_SERVER指线上正式环境(包括我们一般的测试环境和正式环境)，topic(也就是boundid) 和 证书 也是这个道理。所以一定要区分好使用环境！</p></blockquote><h4 id="apns2-client-py"><a href="#apns2-client-py" class="headerlink" title="apns2/client.py"></a>apns2/client.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> collections<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> typing<br><span class="hljs-keyword">import</span> weakref<br><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, Iterable, Optional, Tuple, Union<br><br><span class="hljs-keyword">from</span> .credentials <span class="hljs-keyword">import</span> CertificateCredentials, Credentials<br><span class="hljs-keyword">from</span> .errors <span class="hljs-keyword">import</span> ConnectionFailed, exception_class_for_reason<br><span class="hljs-keyword">from</span> .payload <span class="hljs-keyword">import</span> Payload<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotificationPriority</span>(<span class="hljs-params">Enum</span>):</span><br>    Immediate = <span class="hljs-string">&#x27;10&#x27;</span><br>    Delayed = <span class="hljs-string">&#x27;5&#x27;</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotificationType</span>(<span class="hljs-params">Enum</span>):</span><br>    Alert = <span class="hljs-string">&#x27;alert&#x27;</span><br>    Background = <span class="hljs-string">&#x27;background&#x27;</span><br>    VoIP = <span class="hljs-string">&#x27;voip&#x27;</span><br>    Complication = <span class="hljs-string">&#x27;complication&#x27;</span><br>    FileProvider = <span class="hljs-string">&#x27;fileprovider&#x27;</span><br>    MDM = <span class="hljs-string">&#x27;mdm&#x27;</span><br><br><br>RequestStream = collections.namedtuple(<span class="hljs-string">&#x27;RequestStream&#x27;</span>, [<span class="hljs-string">&#x27;stream_id&#x27;</span>, <span class="hljs-string">&#x27;token&#x27;</span>])<br>Notification = collections.namedtuple(<span class="hljs-string">&#x27;Notification&#x27;</span>, [<span class="hljs-string">&#x27;token&#x27;</span>, <span class="hljs-string">&#x27;payload&#x27;</span>])<br><br>DEFAULT_APNS_PRIORITY = NotificationPriority.Immediate<br>CONCURRENT_STREAMS_SAFETY_MAXIMUM = <span class="hljs-number">1000</span><br>MAX_CONNECTION_RETRIES = <span class="hljs-number">3</span><br><br>logger = logging.getLogger(__name__)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">APNsClient</span>(<span class="hljs-params">object</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                 credentials: Union[Credentials, str],</span></span><br><span class="hljs-function"><span class="hljs-params">                 server: str, port: int, proto: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                 json_encoder: Optional[type] = None, password: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                 proxy_host: Optional[str] = None, proxy_port: Optional[int] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                 heartbeat_period: Optional[float] = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        <span class="hljs-keyword">if</span> isinstance(credentials, str):<br>            self.__credentials = CertificateCredentials(credentials, password)  <span class="hljs-comment"># type: Credentials</span><br>        <span class="hljs-keyword">else</span>:<br>            self.__credentials = credentials<br>        self._init_connection(server, port, proto, proxy_host, proxy_port)<br><br>        <span class="hljs-keyword">if</span> heartbeat_period:<br>            self._start_heartbeat(heartbeat_period)<br><br>        self.__json_encoder = json_encoder<br>        self.__max_concurrent_streams = <span class="hljs-number">0</span><br>        self.__previous_server_max_concurrent_streams = <span class="hljs-literal">None</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_init_connection</span>(<span class="hljs-params">self, server: str, port: int, proto: Optional[str],</span></span><br><span class="hljs-function"><span class="hljs-params">                         proxy_host: Optional[str], proxy_port: Optional[int]</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        self._connection = self.__credentials.create_connection(server, port, proto, proxy_host, proxy_port)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_start_heartbeat</span>(<span class="hljs-params">self, heartbeat_period: float</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        conn_ref = weakref.ref(self._connection)<br><br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">watchdog</span>() -&gt; <span class="hljs-keyword">None</span>:</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                conn = conn_ref()<br>                <span class="hljs-keyword">if</span> conn <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-keyword">break</span><br><br>                conn.ping(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">8</span>)<br>                time.sleep(heartbeat_period)<br><br>        thread = Thread(target=watchdog)<br>        thread.setDaemon(<span class="hljs-literal">True</span>)<br>        thread.start()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_notification</span>(<span class="hljs-params">self, token_hex: str, notification: Payload, topic: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                          priority: NotificationPriority = NotificationPriority.Immediate,</span></span><br><span class="hljs-function"><span class="hljs-params">                          expiration: Optional[int] = None, collapse_id: Optional[str] = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        stream_id = self.send_notification_async(token_hex, notification, topic, priority, expiration, collapse_id)<br>        result = self.get_notification_result(stream_id)<br>        <span class="hljs-keyword">if</span> result != <span class="hljs-string">&#x27;Success&#x27;</span>:<br>            <span class="hljs-keyword">if</span> isinstance(result, tuple):<br>                reason, info = result<br>                <span class="hljs-keyword">raise</span> exception_class_for_reason(reason)(info)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">raise</span> exception_class_for_reason(result)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_notification_async</span>(<span class="hljs-params">self, token_hex: str, notification: Payload, topic: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                priority: NotificationPriority = NotificationPriority.Immediate,</span></span><br><span class="hljs-function"><span class="hljs-params">                                expiration: Optional[int] = None, collapse_id: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                push_type: Optional[NotificationType] = None</span>) -&gt; int:</span><br>        json_str = json.dumps(notification.dict(), cls=self.__json_encoder, ensure_ascii=<span class="hljs-literal">False</span>, separators=(<span class="hljs-string">&#x27;,&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>))<br>        json_payload = json_str.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><br>        headers = &#123;&#125;<br><br>        inferred_push_type = <span class="hljs-literal">None</span>  <span class="hljs-comment"># type: Optional[str]</span><br>        <span class="hljs-keyword">if</span> topic <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            headers[<span class="hljs-string">&#x27;apns-topic&#x27;</span>] = topic<br>            <span class="hljs-keyword">if</span> topic.endswith(<span class="hljs-string">&#x27;.voip&#x27;</span>):<br>                inferred_push_type = NotificationType.VoIP.value<br>            <span class="hljs-keyword">elif</span> topic.endswith(<span class="hljs-string">&#x27;.complication&#x27;</span>):<br>                inferred_push_type = NotificationType.Complication.value<br>            <span class="hljs-keyword">elif</span> topic.endswith(<span class="hljs-string">&#x27;.pushkit.fileprovider&#x27;</span>):<br>                inferred_push_type = NotificationType.FileProvider.value<br>            <span class="hljs-keyword">elif</span> any([notification.alert, notification.badge, notification.sound]):<br>                inferred_push_type = NotificationType.Alert.value<br>            <span class="hljs-keyword">else</span>:<br>                inferred_push_type = NotificationType.Background.value<br><br>        <span class="hljs-keyword">if</span> push_type:<br>            inferred_push_type = push_type.value<br><br>        <span class="hljs-keyword">if</span> inferred_push_type:<br>            headers[<span class="hljs-string">&#x27;apns-push-type&#x27;</span>] = inferred_push_type<br><br>        <span class="hljs-keyword">if</span> priority != DEFAULT_APNS_PRIORITY:<br>            headers[<span class="hljs-string">&#x27;apns-priority&#x27;</span>] = priority.value<br><br>        <span class="hljs-keyword">if</span> expiration <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            headers[<span class="hljs-string">&#x27;apns-expiration&#x27;</span>] = <span class="hljs-string">&#x27;%d&#x27;</span> % expiration<br><br>        auth_header = self.__credentials.get_authorization_header(topic)<br>        <span class="hljs-keyword">if</span> auth_header <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            headers[<span class="hljs-string">&#x27;authorization&#x27;</span>] = auth_header<br><br>        <span class="hljs-keyword">if</span> collapse_id <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            headers[<span class="hljs-string">&#x27;apns-collapse-id&#x27;</span>] = collapse_id<br><br>        url = <span class="hljs-string">&#x27;/3/device/&#123;&#125;&#x27;</span>.format(token_hex)<br>        stream_id = self._connection.request(<span class="hljs-string">&#x27;POST&#x27;</span>, url, json_payload, headers)  <span class="hljs-comment"># type: int</span><br>        <span class="hljs-keyword">return</span> stream_id<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_notification_result</span>(<span class="hljs-params">self, stream_id: int</span>) -&gt; Union[str, Tuple[str, str]]:</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Get result for specified stream</span><br><span class="hljs-string">        The function returns: &#x27;Success&#x27; or &#x27;failure reason&#x27; or (&#x27;Unregistered&#x27;, timestamp)</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> self._connection.get_response(stream_id) <span class="hljs-keyword">as</span> response:<br>            <span class="hljs-keyword">if</span> response.status == <span class="hljs-number">200</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Success&#x27;</span><br>            <span class="hljs-keyword">else</span>:<br>                raw_data = response.read().decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>                data = json.loads(raw_data)  <span class="hljs-comment"># type: Dict[str, str]</span><br>                <span class="hljs-keyword">if</span> response.status == <span class="hljs-number">410</span>:<br>                    <span class="hljs-keyword">return</span> data[<span class="hljs-string">&#x27;reason&#x27;</span>], data[<span class="hljs-string">&#x27;timestamp&#x27;</span>]<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> data[<span class="hljs-string">&#x27;reason&#x27;</span>]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_notification_batch</span>(<span class="hljs-params">self, notifications: Iterable[Notification], topic: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                priority: NotificationPriority = NotificationPriority.Immediate,</span></span><br><span class="hljs-function"><span class="hljs-params">                                expiration: Optional[int] = None, collapse_id: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                                push_type: Optional[NotificationType] = None</span>) -&gt; Dict[str, Union[str, Tuple[str, str]]]:</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Send a notification to a list of tokens in batch. Instead of sending a synchronous request</span><br><span class="hljs-string">        for each token, send multiple requests concurrently. This is done on the same connection,</span><br><span class="hljs-string">        using HTTP/2 streams (one request per stream).</span><br><span class="hljs-string"></span><br><span class="hljs-string">        APNs allows many streams simultaneously, but the number of streams can vary depending on</span><br><span class="hljs-string">        server load. This method reads the SETTINGS frame sent by the server to figure out the</span><br><span class="hljs-string">        maximum number of concurrent streams. Typically, APNs reports a maximum of 500.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The function returns a dictionary mapping each token to its result. The result is &quot;Success&quot;</span><br><span class="hljs-string">        if the token was sent successfully, or the string returned by APNs in the &#x27;reason&#x27; field of</span><br><span class="hljs-string">        the response, if the token generated an error.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        notification_iterator = iter(notifications)<br>        next_notification = next(notification_iterator, <span class="hljs-literal">None</span>)<br>        <span class="hljs-comment"># Make sure we&#x27;re connected to APNs, so that we receive and process the server&#x27;s SETTINGS</span><br>        <span class="hljs-comment"># frame before starting to send notifications.</span><br>        self.connect()<br><br>        results = &#123;&#125;<br>        open_streams = collections.deque()  <span class="hljs-comment"># type: typing.Deque[RequestStream]</span><br>        <span class="hljs-comment"># Loop on the tokens, sending as many requests as possible concurrently to APNs.</span><br>        <span class="hljs-comment"># When reaching the maximum concurrent streams limit, wait for a response before sending</span><br>        <span class="hljs-comment"># another request.</span><br>        <span class="hljs-keyword">while</span> len(open_streams) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> next_notification <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-comment"># Update the max_concurrent_streams on every iteration since a SETTINGS frame can be</span><br>            <span class="hljs-comment"># sent by the server at any time.</span><br>            self.update_max_concurrent_streams()<br>            <span class="hljs-keyword">if</span> next_notification <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> len(open_streams) &lt; self.__max_concurrent_streams:<br>                logger.info(<span class="hljs-string">&#x27;Sending to token %s&#x27;</span>, next_notification.token)<br>                stream_id = self.send_notification_async(next_notification.token, next_notification.payload, topic,<br>                                                         priority, expiration, collapse_id, push_type)<br>                open_streams.append(RequestStream(stream_id, next_notification.token))<br><br>                next_notification = next(notification_iterator, <span class="hljs-literal">None</span>)<br>                <span class="hljs-keyword">if</span> next_notification <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-comment"># No tokens remaining. Proceed to get results for pending requests.</span><br>                    logger.info(<span class="hljs-string">&#x27;Finished sending all tokens, waiting for pending requests.&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># We have at least one request waiting for response (otherwise we would have either</span><br>                <span class="hljs-comment"># sent new requests or exited the while loop.) Wait for the first outstanding stream</span><br>                <span class="hljs-comment"># to return a response.</span><br>                pending_stream = open_streams.popleft()<br>                result = self.get_notification_result(pending_stream.stream_id)<br>                logger.info(<span class="hljs-string">&#x27;Got response for %s: %s&#x27;</span>, pending_stream.token, result)<br>                results[pending_stream.token] = result<br><br>        <span class="hljs-keyword">return</span> results<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_max_concurrent_streams</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        <span class="hljs-comment"># Get the max_concurrent_streams setting returned by the server.</span><br>        <span class="hljs-comment"># The max_concurrent_streams value is saved in the H2Connection instance that must be</span><br>        <span class="hljs-comment"># accessed using a with statement in order to acquire a lock.</span><br>        <span class="hljs-comment"># pylint: disable=protected-access</span><br>        <span class="hljs-keyword">with</span> self._connection._conn <span class="hljs-keyword">as</span> connection:<br>            max_concurrent_streams = connection.remote_settings.max_concurrent_streams<br><br>        <span class="hljs-keyword">if</span> max_concurrent_streams == self.__previous_server_max_concurrent_streams:<br>            <span class="hljs-comment"># The server hasn&#x27;t issued an updated SETTINGS frame.</span><br>            <span class="hljs-keyword">return</span><br><br>        self.__previous_server_max_concurrent_streams = max_concurrent_streams<br>        <span class="hljs-comment"># Handle and log unexpected values sent by APNs, just in case.</span><br>        <span class="hljs-keyword">if</span> max_concurrent_streams &gt; CONCURRENT_STREAMS_SAFETY_MAXIMUM:<br>            logger.warning(<span class="hljs-string">&#x27;APNs max_concurrent_streams too high (%s), resorting to default maximum (%s)&#x27;</span>,<br>                           max_concurrent_streams, CONCURRENT_STREAMS_SAFETY_MAXIMUM)<br>            self.__max_concurrent_streams = CONCURRENT_STREAMS_SAFETY_MAXIMUM<br>        <span class="hljs-keyword">elif</span> max_concurrent_streams &lt; <span class="hljs-number">1</span>:<br>            logger.warning(<span class="hljs-string">&#x27;APNs reported max_concurrent_streams less than 1 (%s), using value of 1&#x27;</span>,<br>                           max_concurrent_streams)<br>            self.__max_concurrent_streams = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            logger.info(<span class="hljs-string">&#x27;APNs set max_concurrent_streams to %s&#x27;</span>, max_concurrent_streams)<br>            self.__max_concurrent_streams = max_concurrent_streams<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">connect</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Establish a connection to APNs. If already connected, the function does nothing. If the</span><br><span class="hljs-string">        connection fails, the function retries up to MAX_CONNECTION_RETRIES times.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        retries = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> retries &lt; MAX_CONNECTION_RETRIES:<br>            <span class="hljs-comment"># noinspection PyBroadException</span><br>            <span class="hljs-keyword">try</span>:<br>                self._connection.connect()<br>                logger.info(<span class="hljs-string">&#x27;Connected to APNs&#x27;</span>)<br>                <span class="hljs-keyword">return</span><br>            <span class="hljs-keyword">except</span> Exception:  <span class="hljs-comment"># pylint: disable=broad-except</span><br>                <span class="hljs-comment"># close the connnection, otherwise next connect() call would do nothing</span><br>                self._connection.close()<br>                retries += <span class="hljs-number">1</span><br>                logger.exception(<span class="hljs-string">&#x27;Failed connecting to APNs (attempt %s of %s)&#x27;</span>, retries, MAX_CONNECTION_RETRIES)<br><br>        <span class="hljs-keyword">raise</span> ConnectionFailed()<br><br></code></pre></td></tr></table></figure><h4 id="apns2-credentials-py"><a href="#apns2-credentials-py" class="headerlink" title="apns2/credentials.py"></a>apns2/credentials.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional, Tuple, TYPE_CHECKING<br><br><span class="hljs-keyword">import</span> jwt<br><br><span class="hljs-keyword">from</span> hyper <span class="hljs-keyword">import</span> HTTP20Connection  <span class="hljs-comment"># type: ignore</span><br><span class="hljs-keyword">from</span> hyper.tls <span class="hljs-keyword">import</span> init_context  <span class="hljs-comment"># type: ignore</span><br><br><span class="hljs-keyword">if</span> TYPE_CHECKING:<br>    <span class="hljs-keyword">from</span> hyper.ssl_compat <span class="hljs-keyword">import</span> SSLContext  <span class="hljs-comment"># type: ignore</span><br><br>DEFAULT_TOKEN_LIFETIME = <span class="hljs-number">3600</span><br>DEFAULT_TOKEN_ENCRYPTION_ALGORITHM = <span class="hljs-string">&#x27;ES256&#x27;</span><br><br><br><span class="hljs-comment"># Abstract Base class. This should not be instantiated directly.</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Credentials</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, ssl_context: <span class="hljs-string">&#x27;Optional[SSLContext]&#x27;</span> = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        super().__init__()<br>        self.__ssl_context = ssl_context<br><br>    <span class="hljs-comment"># Creates a connection with the credentials, if available or necessary.</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_connection</span>(<span class="hljs-params">self, server: str, port: int, proto: Optional[str], proxy_host: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                          proxy_port: Optional[int] = None</span>) -&gt; HTTP20Connection:</span><br>        <span class="hljs-comment"># self.__ssl_context may be none, and that&#x27;s fine.</span><br>        <span class="hljs-keyword">return</span> HTTP20Connection(server, port, ssl_context=self.__ssl_context, force_proto=proto <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;h2&#x27;</span>,<br>                                secure=<span class="hljs-literal">True</span>, proxy_host=proxy_host, proxy_port=proxy_port)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_authorization_header</span>(<span class="hljs-params">self, topic: Optional[str]</span>) -&gt; Optional[str]:</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-comment"># Credentials subclass for certificate authentication</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CertificateCredentials</span>(<span class="hljs-params">Credentials</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, cert_file: Optional[str] = None, password: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">                 cert_chain: Optional[str] = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        ssl_context = init_context(cert=cert_file, cert_password=password)<br>        <span class="hljs-keyword">if</span> cert_chain:<br>            ssl_context.load_cert_chain(cert_chain)<br>        super(CertificateCredentials, self).__init__(ssl_context)<br><br><br><span class="hljs-comment"># Credentials subclass for JWT token based authentication</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenCredentials</span>(<span class="hljs-params">Credentials</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, auth_key_path: str, auth_key_id: str, team_id: str,</span></span><br><span class="hljs-function"><span class="hljs-params">                 encryption_algorithm: str = DEFAULT_TOKEN_ENCRYPTION_ALGORITHM,</span></span><br><span class="hljs-function"><span class="hljs-params">                 token_lifetime: int = DEFAULT_TOKEN_LIFETIME</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        self.__auth_key = self._get_signing_key(auth_key_path)<br>        self.__auth_key_id = auth_key_id<br>        self.__team_id = team_id<br>        self.__encryption_algorithm = encryption_algorithm<br>        self.__token_lifetime = token_lifetime<br><br>        self.__jwt_token = <span class="hljs-literal">None</span>  <span class="hljs-comment"># type: Optional[Tuple[float, str]]</span><br><br>        <span class="hljs-comment"># Use the default constructor because we don&#x27;t have an SSL context</span><br>        super(TokenCredentials, self).__init__()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_authorization_header</span>(<span class="hljs-params">self, topic: Optional[str]</span>) -&gt; str:</span><br>        token = self._get_or_create_topic_token()<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;bearer %s&#x27;</span> % token<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_is_expired_token</span>(<span class="hljs-params">issue_date: float</span>) -&gt; bool:</span><br>        <span class="hljs-keyword">return</span> time.time() &gt; issue_date + DEFAULT_TOKEN_LIFETIME<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_signing_key</span>(<span class="hljs-params">key_path: str</span>) -&gt; str:</span><br>        secret = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> key_path:<br>            <span class="hljs-keyword">with</span> open(key_path) <span class="hljs-keyword">as</span> f:<br>                secret = f.read()<br>        <span class="hljs-keyword">return</span> secret<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_or_create_topic_token</span>(<span class="hljs-params">self</span>) -&gt; str:</span><br>        <span class="hljs-comment"># dict of topic to issue date and JWT token</span><br>        token_pair = self.__jwt_token<br>        <span class="hljs-keyword">if</span> token_pair <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> self._is_expired_token(token_pair[<span class="hljs-number">0</span>]):<br>            <span class="hljs-comment"># Create a new token</span><br>            issued_at = time.time()<br>            token_dict = &#123;<br>                <span class="hljs-string">&#x27;iss&#x27;</span>: self.__team_id,<br>                <span class="hljs-string">&#x27;iat&#x27;</span>: issued_at,<br>            &#125;<br>            headers = &#123;<br>                <span class="hljs-string">&#x27;alg&#x27;</span>: self.__encryption_algorithm,<br>                <span class="hljs-string">&#x27;kid&#x27;</span>: self.__auth_key_id,<br>            &#125;<br>            jwt_token = jwt.encode(token_dict, self.__auth_key,<br>                                   algorithm=self.__encryption_algorithm,<br>                                   headers=headers).decode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br><br>            <span class="hljs-comment"># Cache JWT token for later use. One JWT token per connection.</span><br>            <span class="hljs-comment"># https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/establishing_a_token-based_connection_to_apns</span><br>            self.__jwt_token = (issued_at, jwt_token)<br>            <span class="hljs-keyword">return</span> jwt_token<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> token_pair[<span class="hljs-number">1</span>]<br><br></code></pre></td></tr></table></figure><h4 id="apns2-errors-py"><a href="#apns2-errors-py" class="headerlink" title="apns2/errors.py"></a>apns2/errors.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Type, Optional<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">APNsException</span>(<span class="hljs-params">Exception</span>):</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionFailed</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;There was an error connecting to APNs.&quot;&quot;&quot;</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InternalException</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;This exception should not be raised. If it is, please report this as a bug.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadPayloadException</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Something bad with the payload.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadCollapseId</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The collapse identifier exceeds the maximum allowed size&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadDeviceToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The specified device token was bad.</span><br><span class="hljs-string">    Verify that the request contains a valid token and that the token matches the environment.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadExpirationDate</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-expiration value is bad.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadMessageId</span>(<span class="hljs-params">InternalException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-id value is bad.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadPriority</span>(<span class="hljs-params">InternalException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-priority value is bad.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadTopic</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-topic was invalid.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeviceTokenNotForTopic</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The device token does not match the specified topic.&quot;&quot;&quot;</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DuplicateHeaders</span>(<span class="hljs-params">InternalException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;One or more headers were repeated.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IdleTimeout</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Idle time out.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MissingDeviceToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The device token is not specified in the request :path.</span><br><span class="hljs-string">    Verify that the :path header contains the device token.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MissingTopic</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The apns-topic header of the request was not specified and was required.</span><br><span class="hljs-string">    The apns-topic header is mandatory when the client is connected using a certificate</span><br><span class="hljs-string">    that supports multiple topics.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayloadEmpty</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The message payload was empty.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TopicDisallowed</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Pushing to this topic is not allowed.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadCertificate</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The certificate was bad.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadCertificateEnvironment</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The client certificate was for the wrong environment.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExpiredProviderToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The provider token is stale and a new token should be generated.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Forbidden</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The specified action is not allowed.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvalidProviderToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The provider token is not valid or the token signature could not be verified.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MissingProviderToken</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;No provider certificate was used to connect to APNs and Authorization header was missing or no provider token</span><br><span class="hljs-string">    was specified. &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadPath</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The request contained a bad :path value.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodNotAllowed</span>(<span class="hljs-params">InternalException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The specified :method was not POST.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Unregistered</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The device token is inactive for the specified topic.&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, timestamp: Optional[str] = None</span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        super(Unregistered, self).__init__()<br><br>        self.timestamp = timestamp<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayloadTooLarge</span>(<span class="hljs-params">BadPayloadException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The message payload was too large. The maximum payload size is 4096 bytes.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TooManyProviderTokenUpdates</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The provider token is being updated too often.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TooManyRequests</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Too many requests were made consecutively to the same device token.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InternalServerError</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;An internal server error occurred.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceUnavailable</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The service is unavailable.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Shutdown</span>(<span class="hljs-params">APNsException</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;The server is shutting down.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exception_class_for_reason</span>(<span class="hljs-params">reason: str</span>) -&gt; Type[APNsException]:</span><br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-string">&#x27;BadCollapseId&#x27;</span>: BadCollapseId,<br>        <span class="hljs-string">&#x27;BadDeviceToken&#x27;</span>: BadDeviceToken,<br>        <span class="hljs-string">&#x27;BadExpirationDate&#x27;</span>: BadExpirationDate,<br>        <span class="hljs-string">&#x27;BadMessageId&#x27;</span>: BadMessageId,<br>        <span class="hljs-string">&#x27;BadPriority&#x27;</span>: BadPriority,<br>        <span class="hljs-string">&#x27;BadTopic&#x27;</span>: BadTopic,<br>        <span class="hljs-string">&#x27;DeviceTokenNotForTopic&#x27;</span>: DeviceTokenNotForTopic,<br>        <span class="hljs-string">&#x27;DuplicateHeaders&#x27;</span>: DuplicateHeaders,<br>        <span class="hljs-string">&#x27;IdleTimeout&#x27;</span>: IdleTimeout,<br>        <span class="hljs-string">&#x27;MissingDeviceToken&#x27;</span>: MissingDeviceToken,<br>        <span class="hljs-string">&#x27;MissingTopic&#x27;</span>: MissingTopic,<br>        <span class="hljs-string">&#x27;PayloadEmpty&#x27;</span>: PayloadEmpty,<br>        <span class="hljs-string">&#x27;TopicDisallowed&#x27;</span>: TopicDisallowed,<br>        <span class="hljs-string">&#x27;BadCertificate&#x27;</span>: BadCertificate,<br>        <span class="hljs-string">&#x27;BadCertificateEnvironment&#x27;</span>: BadCertificateEnvironment,<br>        <span class="hljs-string">&#x27;ExpiredProviderToken&#x27;</span>: ExpiredProviderToken,<br>        <span class="hljs-string">&#x27;Forbidden&#x27;</span>: Forbidden,<br>        <span class="hljs-string">&#x27;InvalidProviderToken&#x27;</span>: InvalidProviderToken,<br>        <span class="hljs-string">&#x27;MissingProviderToken&#x27;</span>: MissingProviderToken,<br>        <span class="hljs-string">&#x27;BadPath&#x27;</span>: BadPath,<br>        <span class="hljs-string">&#x27;MethodNotAllowed&#x27;</span>: MethodNotAllowed,<br>        <span class="hljs-string">&#x27;Unregistered&#x27;</span>: Unregistered,<br>        <span class="hljs-string">&#x27;PayloadTooLarge&#x27;</span>: PayloadTooLarge,<br>        <span class="hljs-string">&#x27;TooManyProviderTokenUpdates&#x27;</span>: TooManyProviderTokenUpdates,<br>        <span class="hljs-string">&#x27;TooManyRequests&#x27;</span>: TooManyRequests,<br>        <span class="hljs-string">&#x27;InternalServerError&#x27;</span>: InternalServerError,<br>        <span class="hljs-string">&#x27;ServiceUnavailable&#x27;</span>: ServiceUnavailable,<br>        <span class="hljs-string">&#x27;Shutdown&#x27;</span>: Shutdown,<br>    &#125;[reason]<br><br></code></pre></td></tr></table></figure><h4 id="apns2-payload-py"><a href="#apns2-payload-py" class="headerlink" title="apns2/payload.py"></a>apns2/payload.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any, Dict, List, Optional, Union, Iterable<br><br>MAX_PAYLOAD_SIZE = <span class="hljs-number">4096</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayloadAlert</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params"></span></span><br><span class="hljs-function"><span class="hljs-params">            self,</span></span><br><span class="hljs-function"><span class="hljs-params">            title: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            title_localized_key: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            title_localized_args: Optional[List[str]] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            body: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            body_localized_key: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            body_localized_args: Optional[List[str]] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            action_localized_key: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            action: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            launch_image: Optional[str] = None</span></span><br><span class="hljs-function"><span class="hljs-params">    </span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        self.title = title<br>        self.title_localized_key = title_localized_key<br>        self.title_localized_args = title_localized_args<br>        self.body = body<br>        self.body_localized_key = body_localized_key<br>        self.body_localized_args = body_localized_args<br>        self.action_localized_key = action_localized_key<br>        self.action = action<br>        self.launch_image = launch_image<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict</span>(<span class="hljs-params">self</span>) -&gt; Dict[str, Any]:</span><br>        result = &#123;&#125;  <span class="hljs-comment"># type: Dict[str, Any]</span><br><br>        <span class="hljs-keyword">if</span> self.title:<br>            result[<span class="hljs-string">&#x27;title&#x27;</span>] = self.title<br>        <span class="hljs-keyword">if</span> self.title_localized_key:<br>            result[<span class="hljs-string">&#x27;title-loc-key&#x27;</span>] = self.title_localized_key<br>        <span class="hljs-keyword">if</span> self.title_localized_args:<br>            result[<span class="hljs-string">&#x27;title-loc-args&#x27;</span>] = self.title_localized_args<br><br>        <span class="hljs-keyword">if</span> self.body:<br>            result[<span class="hljs-string">&#x27;body&#x27;</span>] = self.body<br>        <span class="hljs-keyword">if</span> self.body_localized_key:<br>            result[<span class="hljs-string">&#x27;loc-key&#x27;</span>] = self.body_localized_key<br>        <span class="hljs-keyword">if</span> self.body_localized_args:<br>            result[<span class="hljs-string">&#x27;loc-args&#x27;</span>] = self.body_localized_args<br><br>        <span class="hljs-keyword">if</span> self.action_localized_key:<br>            result[<span class="hljs-string">&#x27;action-loc-key&#x27;</span>] = self.action_localized_key<br>        <span class="hljs-keyword">if</span> self.action:<br>            result[<span class="hljs-string">&#x27;action&#x27;</span>] = self.action<br><br>        <span class="hljs-keyword">if</span> self.launch_image:<br>            result[<span class="hljs-string">&#x27;launch-image&#x27;</span>] = self.launch_image<br><br>        <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Payload</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params"></span></span><br><span class="hljs-function"><span class="hljs-params">            self,</span></span><br><span class="hljs-function"><span class="hljs-params">            alert: Union[PayloadAlert, str, None] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            badge: Optional[int] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            sound: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            category: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            url_args: Optional[Iterable[str]] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            custom: Optional[Dict[str, Any]] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            thread_id: Optional[str] = None,</span></span><br><span class="hljs-function"><span class="hljs-params">            content_available: bool = False,</span></span><br><span class="hljs-function"><span class="hljs-params">            mutable_content: bool = False,</span></span><br><span class="hljs-function"><span class="hljs-params">    </span>) -&gt; <span class="hljs-keyword">None</span>:</span><br>        self.alert = alert<br>        self.badge = badge<br>        self.sound = sound<br>        self.content_available = content_available<br>        self.category = category<br>        self.url_args = url_args<br>        self.custom = custom<br>        self.mutable_content = mutable_content<br>        self.thread_id = thread_id<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict</span>(<span class="hljs-params">self</span>) -&gt; Dict[str, Any]:</span><br>        result = &#123;<br>            <span class="hljs-string">&#x27;aps&#x27;</span>: &#123;&#125;<br>        &#125;  <span class="hljs-comment"># type: Dict[str, Any]</span><br><br>        <span class="hljs-keyword">if</span> self.alert <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> isinstance(self.alert, PayloadAlert):<br>                result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;alert&#x27;</span>] = self.alert.dict()<br>            <span class="hljs-keyword">else</span>:<br>                result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;alert&#x27;</span>] = self.alert<br>        <span class="hljs-keyword">if</span> self.badge <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;badge&#x27;</span>] = self.badge<br>        <span class="hljs-keyword">if</span> self.sound <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;sound&#x27;</span>] = self.sound<br>        <span class="hljs-keyword">if</span> self.content_available:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;content-available&#x27;</span>] = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> self.mutable_content:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;mutable-content&#x27;</span>] = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> self.thread_id <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;thread-id&#x27;</span>] = self.thread_id<br>        <span class="hljs-keyword">if</span> self.category <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;category&#x27;</span>] = self.category<br>        <span class="hljs-keyword">if</span> self.url_args <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result[<span class="hljs-string">&#x27;aps&#x27;</span>][<span class="hljs-string">&#x27;url-args&#x27;</span>] = self.url_args<br>        <span class="hljs-keyword">if</span> self.custom <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            result.update(self.custom)<br><br>        <span class="hljs-keyword">return</span> result<br><br></code></pre></td></tr></table></figure><p>参考文章：</p><ul><li><a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CommunicatingwithAPNs.html#//apple_ref/doc/uid/TP40008194-CH11-SW1">苹果官网原文</a></li><li><a href="https://github.com/Pr0Ger/PyAPNs2">PyAPNs2三方库地址</a></li></ul><h3 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h3><p>本地mac环境没有问题，但是部署到linux上报错。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">line 37 ssl_context = init_context(cert=cert_file, cert_password=password)  # 报错位置<br>ssl.SSLError: [SSL: CA_MD_TOO_WEAK] ca md too weak (_ssl.c:3880)  # 错误信息<br></code></pre></td></tr></table></figure><blockquote><p>hyper使用的Openssl新版本不兼容导致</p></blockquote><p><strong>解决办法：</strong></p><p>1、修改<code>/etc/ssl/openssl.cnf</code> 文件，设置<code>CipherString = DEFAULT@SECLEVEL=1</code> （推荐）</p><p>2、降级openssl版本为<code>1.1.1</code></p><ul><li><a href="https://github.com/Pr0Ger/PyAPNs2/issues/103">相关issue</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>推送</category>
      
    </categories>
    
    
    <tags>
      
      <tag>推送</tag>
      
      <tag>APNs2</tag>
      
      <tag>ios</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python注册windows服务</title>
    <link href="/Myblog/2020/03/01/Python%E6%B3%A8%E5%86%8Cwindows%E6%9C%8D%E5%8A%A1/"/>
    <url>/Myblog/2020/03/01/Python%E6%B3%A8%E5%86%8Cwindows%E6%9C%8D%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h3 id="安装pywin32"><a href="#安装pywin32" class="headerlink" title="安装pywin32"></a>安装pywin32</h3><p>注册windows服务需要使用到框架<code>pywin32</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install pywin32<br></code></pre></td></tr></table></figure><h3 id="注册服务模版"><a href="#注册服务模版" class="headerlink" title="注册服务模版"></a>注册服务模版</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> win32serviceutil<br><span class="hljs-keyword">import</span> win32service<br><span class="hljs-keyword">import</span> win32event<br><span class="hljs-keyword">import</span> servicemanager<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-keyword">from</span> apscheduler.schedulers.blocking <span class="hljs-keyword">import</span> BlockingScheduler<br><span class="hljs-keyword">from</span> src.ws <span class="hljs-keyword">import</span> BASE_DIR<br><br><span class="hljs-keyword">from</span> src.ws.ws <span class="hljs-keyword">import</span> main<br><br>logging.basicConfig(<br>    filename=os.path.join(BASE_DIR, <span class="hljs-string">&#x27;data-sync-service.log&#x27;</span>),<br>    level=logging.DEBUG,<br>    format=<span class="hljs-string">&#x27;%(asctime)s %(levelname)-7.7s %(message)s&#x27;</span>, datefmt=<span class="hljs-string">&#x27;%Y/%m/%d %I:%M:%S %p&#x27;</span><br>)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpainDataSvc</span>(<span class="hljs-params">win32serviceutil.ServiceFramework</span>):</span><br>    _svc_name_ = <span class="hljs-string">&quot;SpainDataSvc&quot;</span>   <span class="hljs-comment"># 注册服务名</span><br>    _svc_display_name_ = <span class="hljs-string">&quot;Spain data sync service...&quot;</span>   <span class="hljs-comment"># 服务在windows系统中显示的名称</span><br>    _svc_description_ = <span class="hljs-string">&quot;This code is a Python service Test&quot;</span>  <span class="hljs-comment"># 服务描述</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">schedule</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-comment"># 业务逻辑：定时任务，西班牙时间每2小时更新一次，应用启动时立即执行一次</span><br>        scheduler = BlockingScheduler()<br>        scheduler.add_job(main, <span class="hljs-string">&#x27;interval&#x27;</span>, hours=<span class="hljs-number">2</span>, id=<span class="hljs-string">&#x27;update_erp_data&#x27;</span>, misfire_grace_time=<span class="hljs-number">600</span>,<br>                          next_run_time=datetime.datetime.now(), coalesce=<span class="hljs-literal">True</span>, replace_existing=<span class="hljs-literal">True</span>)<br>        logging.info(<span class="hljs-string">&quot;sync job start.&quot;</span>)<br>        <span class="hljs-keyword">return</span> scheduler<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, args</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;Constructor of the winservice&quot;&quot;&quot;</span><br>        win32serviceutil.ServiceFramework.__init__(self, args)<br>        self.hWaitStop = win32event.CreateEvent(<span class="hljs-literal">None</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">None</span>)<br>        socket.setdefaulttimeout(<span class="hljs-number">60</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">SvcDoRun</span>(<span class="hljs-params">self</span>):</span><br>      <span class="hljs-string">&quot;&quot;&quot;Called when the service is asked to start&quot;&quot;&quot;</span><br>        servicemanager.LogMsg(servicemanager.EVENTLOG_INFORMATION_TYPE,<br>                              servicemanager.PYS_SERVICE_STARTED,<br>                              (self._svc_name_, <span class="hljs-string">&#x27;&#x27;</span>))<br>        logging.info(<span class="hljs-string">f&quot;data sync start monitor.&quot;</span>)<br>        self.schedule().start()        <br>        <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">SvcStop</span>(<span class="hljs-params">self</span>):</span><br>      <span class="hljs-string">&quot;&quot;&quot;Called when the service is asked to stop&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 先告诉SCM停止这个过程 </span><br>        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)<br>        <span class="hljs-comment"># 设置事件</span><br>        win32event.SetEvent(self.hWaitStop)<br>        self.schedule().shutdown()<br>        sys.exit()<br>        <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;重写方法：开始之前添加逻辑，例如运行条件&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;重写方法：结束之前添加逻辑，使运行条件无效&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>  <span class="hljs-comment"># 注册服务</span><br>    win32serviceutil.HandleCommandLine(SpainDataSvc)<br><br></code></pre></td></tr></table></figure><blockquote><ol><li><p>类的<code>__init__</code>函数执行完后，系统服务开始启动，windows系统会自动调用SvcDoRun函数，这个函数的执行<strong>不可以结束</strong>，因为结束就代表服务停止。所以当我们放自己的代码在SvcDoRun函数中执行的时候，必须确保该函数不退出，如果退出或者该函数没有正常运行就表示服务停止</p></li><li><p>当停止服务的时候，系统会调用SvcDoStop函数，该函数通过设置标志位等方式让SvcDoRun函数退出，就是正常的停止服务。例子中是通过event事件让SvcDoRun函数停止等待，从而退出该函数，从而使服务停止。</p></li><li><p>系统关机不会调用SvcDoStop函数</p></li></ol></blockquote><h3 id="服务相关命令"><a href="#服务相关命令" class="headerlink" title="服务相关命令"></a>服务相关命令</h3><ul><li>注册服务 <code>python xxx.py install</code></li><li>注册服务并且使开机自启动 <code>python xxx.py --startup auto install</code></li><li>更新服务 <code>python xxx.py update</code></li><li>卸载服务 <code>python xxx.py remove</code></li><li>查看服务 <code>mmc Services.msc</code> 或者 打开任务管理器查看</li><li>启动服务 <code>net start &lt;service name&gt;</code> 或者 <code>python xxx.py start</code></li><li>停止服务 <code>net stop &lt;service name&gt;</code> 或者 <code>python xxx.py stop</code></li><li>重启服务 <code>net restart &lt;service name&gt;</code> 或者 <code>python xxx.py restart</code></li></ul><h3 id="1053错误"><a href="#1053错误" class="headerlink" title="1053错误"></a>1053错误</h3><p>代码运行没有问题后，安装服务，然而start 的时候出现错误 1053：服务没有及时响应启动或控制请求（Error 1053: The service did not respond to the start or control request in a timely fashion）</p><p><strong>解决方法</strong>：</p><p>What you need to do is to add the Python27 to SYSTEM PATH, and not to USER PATH, since as a default the python service will get installed as a ‘LocalSystem’ and so when it attempts to start it uses the SYSTEM PATH variable - that’s why you can run it from the command prompt, your USER PATH is right.</p><p>python默认安装是作为LocalSystem，配置的是用户路径而不是环境变量，所以需要添加环境变量。</p><p><strong>在用户变量处去掉python路径，然后在系统环境变量加入python路径</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs PATH">C:\Users\星辰\AppData\Local\Programs\Python\Python36\Lib\site-packages\pywin32_system32;<br><br>C:\Users\星辰\AppData\Local\Programs\Python\Python36\Lib\site-packages\win32;<br><br>C:\Users\星辰\AppData\Local\Programs\Python\Python36\Scripts\;<br><br>C:\Users\星辰\AppData\Local\Programs\Python\Python36\;<br></code></pre></td></tr></table></figure><p>start service成功。<br><a href="https://stackoverflow.com/questions/8943371/cant-start-windows-service-written-in-python-win32serviceutil">参考解决方案</a></p>]]></content>
    
    
    <categories>
      
      <category>Service</category>
      
    </categories>
    
    
    <tags>
      
      <tag>service</tag>
      
      <tag>windows</tag>
      
      <tag>pywin32</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>翻译po文件半自动脚本</title>
    <link href="/Myblog/2019/11/24/%E7%BF%BB%E8%AF%91po%E6%96%87%E4%BB%B6%E5%8D%8A%E8%87%AA%E5%8A%A8%E8%84%9A%E6%9C%AC/"/>
    <url>/Myblog/2019/11/24/%E7%BF%BB%E8%AF%91po%E6%96%87%E4%BB%B6%E5%8D%8A%E8%87%AA%E5%8A%A8%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>因为工作原因，需要翻译一些po文件，但是手动翻译又费力又耗时，网上搜索发现有<a href="https://poedit.net/">poedit</a>工具针对翻译po文件比较好用，但是出于软件翻译需要收费，于是自己折腾了一下写了此脚本。</p><h3 id="脚本功能"><a href="#脚本功能" class="headerlink" title="脚本功能"></a>脚本功能</h3><p>实现自动生成待翻译 excel文档，上传google成功后，输入翻译结果至程序，自动填写并生成新的po文件。</p><h3 id="脚本说明"><a href="#脚本说明" class="headerlink" title="脚本说明"></a>脚本说明</h3><p>本脚本不提供翻译功能，翻译使用<a href="https://translate.google.cn/">谷歌翻译</a>，支持上传文档批量翻译，翻译成功后打开调试工具获取搜索结果，输入程序即可，已翻译的数据不会进行覆盖。</p><p>谷歌翻译返回数据接口如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">t?anno=3&amp;client=wt_lib&amp;format=html&amp;v=1.0&amp;key&amp;logld=vTE_20190916_00&amp;sl=en&amp;tl=zh-CN&amp;sp=nmt&amp;tc=1&amp;tk=932453.434242&amp;mode=1<br></code></pre></td></tr></table></figure><p>数据结果如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[&quot;1个&quot;,&quot;参数错误&quot;,&quot;2&quot;,&quot;错误的请求&quot;, ...]<br></code></pre></td></tr></table></figure><p>将上述返回的多个数据结果以列表形式输入程序。</p><h3 id="脚本详情"><a href="#脚本详情" class="headerlink" title="脚本详情"></a>脚本详情</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> xlwt<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read_po</span>(<span class="hljs-params">po_path</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;依序读取po文件所有待翻译字符&quot;&quot;&quot;</span><br>    msgid_list = []<br>    <span class="hljs-keyword">with</span> open(po_path, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        line = f.readline()<br>        msgid, flag = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">while</span> line:<br>            line = line.strip()<br>            <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">&#x27;&quot;&#x27;</span>) <span class="hljs-keyword">and</span> flag:<br>                msgid += line[<span class="hljs-number">1</span>:<span class="hljs-number">-1</span>]<br>            <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">&#x27;msgstr&#x27;</span>):<br>                flag = <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">if</span> msgid:<br>                    msgid_list.append(msgid)<br>                msgid = <span class="hljs-string">&#x27;&#x27;</span><br>            <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">&#x27;msgid&#x27;</span>):<br>                msgid += line[<span class="hljs-number">7</span>:<span class="hljs-number">-1</span>]<br>                flag = <span class="hljs-literal">True</span><br>            line = f.readline()<br>    <span class="hljs-keyword">return</span> msgid_list<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write_po</span>(<span class="hljs-params">msg_info, po_path, po_new_path</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;读取po文件同时写入翻译结果&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">with</span> open(po_path, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f1:<br>        <span class="hljs-keyword">with</span> open(po_new_path, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f2:<br>            line = f1.readline()<br>            msgid, flag = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">while</span> line:<br>                line = line.strip()<br>                <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">&#x27;&quot;&#x27;</span>) <span class="hljs-keyword">and</span> flag:<br>                    msgid += line[<span class="hljs-number">1</span>:<span class="hljs-number">-1</span>]<br>                <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">&#x27;msgid&#x27;</span>):<br>                    msgid += line[<span class="hljs-number">7</span>:<span class="hljs-number">-1</span>]<br>                    flag = <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">&#x27;msgstr&#x27;</span>):<br>                    msgstr = line[<span class="hljs-number">8</span>:<span class="hljs-number">-1</span>]<br>                    tran_lang = msg_info.get(msgid, <span class="hljs-string">&#x27;&#x27;</span>)<br>                    <span class="hljs-comment"># 如果已翻译不做修改，否则写入翻译</span><br>                    <span class="hljs-keyword">if</span> msgstr:<br>                        f2.writelines(<span class="hljs-string">&#x27;msgstr &quot;%s&quot;&#x27;</span> % msgstr)<br>                    <span class="hljs-keyword">elif</span> tran_lang:<br>                        f2.writelines(<span class="hljs-string">&#x27;msgstr &quot;%s&quot;&#x27;</span> % tran_lang)<br>                    <span class="hljs-keyword">else</span>:<br>                        f2.writelines(line)<br>                    msgid, flag = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">else</span>:<br>                    f2.writelines(line)<br>                f2.writelines(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>                line = f1.readline()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_excel</span>(<span class="hljs-params">msgid, excel_path</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成待翻译excel文件&quot;&quot;&quot;</span><br>    workbook = xlwt.Workbook(encoding=<span class="hljs-string">&quot;utf8&quot;</span>)<br>    worksheet = workbook.add_sheet(<span class="hljs-string">&#x27;sheet1&#x27;</span>)<br>    <span class="hljs-keyword">for</span> row, msg <span class="hljs-keyword">in</span> enumerate(msgid):<br>        worksheet.write(row, <span class="hljs-number">0</span>, str(row+<span class="hljs-number">1</span>))<br>        worksheet.write(row, <span class="hljs-number">1</span>, msg)<br>    workbook.save(excel_path)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>(<span class="hljs-params">po_path, tran_po_path, excel_path</span>):</span><br>    msgid = read_po(po_path)<br>    gen_excel(msgid, excel_path)<br>    counter_and_result = []<br>    print(<span class="hljs-string">f&#x27;请将生成好的excel上传至google翻译～～\n生成excel位置:<span class="hljs-subst">&#123;excel_path&#125;</span>&#x27;</span>)<br>    <span class="hljs-comment"># 打开网页调试工具，获取翻译结果输入</span><br>    google_tran = input(<span class="hljs-string">&#x27;请输入翻译结果，按a结束:&#x27;</span>)<br>    <span class="hljs-keyword">while</span> google_tran != <span class="hljs-string">&#x27;a&#x27;</span>:<br>        counter_and_result.extend(eval(google_tran))<br>        google_tran = input(<span class="hljs-string">&#x27;请输入翻译结果，按a结束:&#x27;</span>)<br><br>    msgstr = [tran <span class="hljs-keyword">for</span> i, tran <span class="hljs-keyword">in</span> enumerate(counter_and_result) <span class="hljs-keyword">if</span> i % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">if</span> len(msgid) != len(msgstr):<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;len(msgid)=<span class="hljs-subst">&#123;len(msgid)&#125;</span> 与 len(msgstr)=<span class="hljs-subst">&#123;len(msgstr)&#125;</span>，长度不一致，结果有误！&quot;</span>)<br>    msg_info = dict(zip(msgid, msgstr))<br>    write_po(msg_info, po_path, tran_po_path)<br>    print(<span class="hljs-string">f&#x27;翻译文件写入成功! \n文件位置: <span class="hljs-subst">&#123;tran_po_path&#125;</span>&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># 指定文件路径</span><br>    po_path = <span class="hljs-string">&#x27;/Users/stellae/Downloads/temp/messages.po&#x27;</span><br>    tran_po_path = <span class="hljs-string">&#x27;/Users/stellae/Downloads/temp/messages_new.po&#x27;</span><br>    excel_path = <span class="hljs-string">&#x27;/Users/stellae/Downloads/temp/translation.xls&#x27;</span><br>    main(po_path, tran_po_path, excel_path)<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>实用脚本</category>
      
    </categories>
    
    
    <tags>
      
      <tag>po</tag>
      
      <tag>翻译</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>flask-babel多国语言支持</title>
    <link href="/Myblog/2019/11/19/flask-babel%E5%A4%9A%E5%9B%BD%E8%AF%AD%E8%A8%80%E6%94%AF%E6%8C%81/"/>
    <url>/Myblog/2019/11/19/flask-babel%E5%A4%9A%E5%9B%BD%E8%AF%AD%E8%A8%80%E6%94%AF%E6%8C%81/</url>
    
    <content type="html"><![CDATA[<h3 id="Flask-babel简介"><a href="#Flask-babel简介" class="headerlink" title="Flask-babel简介"></a>Flask-babel简介</h3><p>Flask-babel 是基于 Flask 的 i18n 扩展。</p><p>安装它的时候会顺便安装 <a href="http://babel.edgewall.org/">Babel</a>、<a href="http://pytz.sourceforge.net/">pytz</a>、<a href="http://pypi.python.org/pypi/speaklater">speaklater</a> 这三个包，其中 Babel 是 Python 的一个国际化工具包。pytz 是处理时区的工具包，speaklater 相当于是 Babel 的一个辅助工具。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install flask-babel<br></code></pre></td></tr></table></figure><h3 id="大致使用流程"><a href="#大致使用流程" class="headerlink" title="大致使用流程"></a>大致使用流程</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs txt">1.开始，你需要初始化设置，flask扩展固定流程<br>2.在本地建一个babel.cfg文件，设置需要翻译的文件和应用jinja2文件。<br>3.然后记住几个命令，利用这几个命令，生成文件，流程大概是这样 --babel.cfg---*.pot --*.po----*.mo<br>*.po里的内容是需要我们翻译的。<br>*.mo是我们编译生成的文件。<br>4.使用mo文件数据(gettext或者jinja2模版渲染)<br></code></pre></td></tr></table></figure><h3 id="Flask-babel实战"><a href="#Flask-babel实战" class="headerlink" title="Flask-babel实战"></a>Flask-babel实战</h3><p><code>app/__init__.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask_babel <span class="hljs-keyword">import</span> Babel<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> g<br><br><span class="hljs-keyword">from</span> ..utils.function <span class="hljs-keyword">import</span> get_text<br><br>babel = Babel(app)<br><br><br><span class="hljs-meta">@app.before_request</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">before_request</span>():</span><br>    g._out = get_text()<br></code></pre></td></tr></table></figure><blockquote><p>创建钩子函数，将国际化输出函数绑定到全局变量g上，方便视图函数使用。</p></blockquote><p><code>config/default.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">LANGUAGES = [<span class="hljs-string">&#x27;zh&#x27;</span>, <span class="hljs-string">&#x27;en&#x27;</span>, <span class="hljs-string">&#x27;es&#x27;</span>]    <span class="hljs-comment"># 支持的语言列表（对应需要生成不同的语言目录）</span><br></code></pre></td></tr></table></figure><p><code>app/resources/*.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 业务接口代码</span><br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> g<br><span class="hljs-keyword">from</span> flask_babel <span class="hljs-keyword">import</span> _<br><br><span class="hljs-meta">@api.route(&quot;/foo&quot;)</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Manage</span>(<span class="hljs-params">Resource</span>):</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>():</span><br>      a = _(<span class="hljs-string">&#x27;hello world！&#x27;</span>)<br>      b = _(<span class="hljs-string">&#x27;my name is xingchen&#x27;</span>)<br>      <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&#x27;a&#x27;</span>: a, <span class="hljs-string">&#x27;b&#x27;</span>: b, <span class="hljs-string">&#x27;a1&#x27;</span>: g._out(a), <span class="hljs-string">&#x27;b1&#x27;</span>: g._out(b)&#125;)<br></code></pre></td></tr></table></figure><blockquote><p>使用<code>_()</code>标记需要翻译的文本，后面执行命令会扫描对应文件标记处，生成<code>.pot</code>文件</p></blockquote><p>创建方法用于处理客户端发送的带<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Language">Accept-Language</a>头部的请求-携带语言信息</p><p><code>app/utils/function.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gettext<br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request, current_app<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_language</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;获取用户语言&quot;&quot;&quot;</span><br>    language = request.headers.get(<span class="hljs-string">&#x27;Accept-Language&#x27;</span>)<br>    <span class="hljs-keyword">if</span> language <span class="hljs-keyword">in</span> current_app.config[<span class="hljs-string">&#x27;LANGUAGES&#x27;</span>]:<br>        <span class="hljs-keyword">return</span> language<br>    <span class="hljs-keyword">return</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_text</span>(<span class="hljs-params">domain=<span class="hljs-string">&#x27;messages&#x27;</span>, localedir=<span class="hljs-string">&#x27;translations&#x27;</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;获取对应国际化输出对象&quot;&quot;&quot;</span><br>    language = get_language()<br>    <span class="hljs-keyword">if</span> language:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">return</span> gettext.translation(domain, localedir, languages=[language]).gettext<br>        <span class="hljs-keyword">except</span> FileNotFoundError:<br>            <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">lambda</span> x: x<br></code></pre></td></tr></table></figure><blockquote><p>注意：官方flask-babel只能在jinja2渲染的文本中使用mo文件，所以这里我使用了gettext库，指定mo文件和语言使用翻译数据。</p></blockquote><h3 id="Flask-babel相关命令"><a href="#Flask-babel相关命令" class="headerlink" title="Flask-babel相关命令"></a>Flask-babel相关命令</h3><h4 id="创建babel-cfg文件"><a href="#创建babel-cfg文件" class="headerlink" title="创建babel.cfg文件"></a>创建babel.cfg文件</h4><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs txt">[python: app/**.py]<br>[jinja2: app/templates/**.html]<br>extensions=jinja2.ext.autoescape,jinja2.ext.with_<br></code></pre></td></tr></table></figure><p>前两行分别定义了Python和Jinja2模板文件的文件名匹配模式，Python文件多个写多行即可。 第三行定义了Jinja2模板引擎提供的两个扩展，以帮助Flask-Babel正确解析模板文件。</p><h4 id="提取文本到pot文件"><a href="#提取文本到pot文件" class="headerlink" title="提取文本到pot文件"></a>提取文本到pot文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">pybabel extract -F babel.cfg -o messages.pot .<br><span class="hljs-meta">#</span><span class="bash"> pybabel extract -F babel.cfg -k _l -o messages.pot .</span><br></code></pre></td></tr></table></figure><p><code>pybabel extract</code>命令读取<code>-F</code>选项中给出的配置文件，然后从命令给出的目录（当前目录或本处的<code>.</code> ）扫描与配置的源匹配的目录中的所有代码和模板文件。 默认情况下，<code>pybabel</code>将查找<code>_()</code>以作为文本标记，但我也使用了重命名为<code>_l()</code>的延迟版本，所以我需要用<code>-k _l</code>来告诉该工具也要查找它 。 <code>-o</code>选项提供输出文件的名称。</p><p>我应该注意，<em>messages.pot</em>文件不需要合并到项目中。 这是一个只要再次运行上面的命令，就可以在需要时轻松地重新生成的文件。 因此，不需要将该文件提交到源代码管理。</p><h4 id="生成对应语言目录及po文件"><a href="#生成对应语言目录及po文件" class="headerlink" title="生成对应语言目录及po文件"></a>生成对应语言目录及po文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">pybabel init -i messages.pot -d translations -l zh<br></code></pre></td></tr></table></figure><p><code>pybabel init</code>命令将<em>messages.pot</em>文件作为输入，并将语言目录写入<code>-d</code>选项中指定的目录中，<code>-l</code>选项中指定的是翻译语言。 我将在<em>translations</em>目录中安装所有翻译，因为这是Flask-Babel默认提取翻译文件的地方。 该命令将在该目录内为西班牙数据文件创建一个<em>zh</em>子目录。 特别是，将会有一个名为<code>translations/zh/LC_MESSAGES/messages.po</code>的新文件，是需要翻译的文件路径。</p><p>如果你想支持其他语言，只需要各自的语言代码重复上述命令，就能使得每种语言都有一个包含<em>messages.po</em>文件的存储库。</p><p>在每个语言存储库中创建的<code>messages.po</code>文件使用的格式是语言翻译的事实标准。</p><p><strong>最流行的翻译应用程序是开源的<a href="http://www.poedit.net/">poedit</a>。</strong></p><p><strong>此时生成po文件后需要进行翻译后再进行后续操作。</strong></p><h4 id="编译所有mo文件"><a href="#编译所有mo文件" class="headerlink" title="编译所有mo文件"></a>编译所有mo文件</h4><p><em>messages.po</em>文件是一种用于翻译的源文件。 当你想开始使用这些翻译后的文本时，这个文件需要被编译成一种格式，这种格式在运行时可以被应用程序使用。 要编译应用程序的所有翻译，可以使用<code>pybabel compile</code>命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">pybabel compile -d translations<br></code></pre></td></tr></table></figure><h4 id="更新翻译文件"><a href="#更新翻译文件" class="headerlink" title="更新翻译文件"></a>更新翻译文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">pybabel extract -F babel.cfg -o messages.pot .<br>pybabel update -i messages.pot -d translations<br>pybabel compile -d translations<br></code></pre></td></tr></table></figure><p><code>extract</code>命令与我之前执行的命令相同，但现在它会生成<em>messages.pot</em>的新版本，其中包含所有以前的文本以及最近用<code>_()</code>或<code>_l()</code>包装的文本。 <code>update</code>调用采用新的<code>messages.pot</code>文件并将其合并到与项目相关的所有<em>messages.po</em>文件中。 这将是一个智能合并，其中任何现有的文本将被单独保留，而只有在<em>messages.pot</em>中添加或删除的条目才会受到影响。</p><p><em>messages.po</em>文件更新后，你就可以继续新的测试了，再次编译它，以便对应用生效。</p><p>参考文章：<a href="https://wizardforcel.gitbooks.io/the-flask-mega-tutorial-2017-zh/docs/13.html">flask-babel中文文档</a> / <a href="https://www.jianshu.com/p/f996de352d7a">flask-babel使用流程</a> / <a href="https://blog.csdn.net/orangleliu/article/details/79706260">gettext获取mo文件数据</a></p>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>国际化</tag>
      
      <tag>babel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git的奇技淫巧</title>
    <link href="/Myblog/2019/11/13/Git%E7%9A%84%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/"/>
    <url>/Myblog/2019/11/13/Git%E7%9A%84%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="Git的奇技淫巧"><a href="#Git的奇技淫巧" class="headerlink" title="Git的奇技淫巧"></a>Git的奇技淫巧</h1><blockquote><p>Git常用命令集合，Fork于<a href="https://github.com/git-tips/tips">tips</a>项目</p></blockquote><p>Git是一个 “分布式版本管理工具”，简单的理解版本管理工具：大家在写东西的时候都用过 “回撤” 这个功能，但是回撤只能回撤几步，假如想要找回我三天之前的修改，光用 “回撤” 是找不回来的。而 “版本管理工具” 能记录每次的修改，只要提交到版本仓库，你就可以找到之前任何时刻的状态（文本状态）。</p><p>下面的内容就是列举了常用的 Git 命令和一些小技巧，可以通过 “页面内查找” 的方式进行快速查询：<code>Ctrl/Command+f</code>。</p><h2 id="开卷必读"><a href="#开卷必读" class="headerlink" title="开卷必读"></a>开卷必读</h2><p><em>如果之前未使用过 Git，可以学习 <a href="http://rogerdudler.github.io/git-guide/index.zh.html">Git 小白教程</a>入门</em></p><ol><li><strong>一定要先测试命令的效果后</strong>，再用于工作环境中，以防造成不能弥补的后果！<strong>到时候别拿着砍刀来找我</strong></li><li>所有的命令都在<code>git version 2.7.4 (Apple Git-66)</code>下测试通过</li><li>统一概念：<ul><li>工作区：改动（增删文件和内容）</li><li>暂存区：输入命令：<code>git add 改动的文件名</code>，此次改动就放到了 ‘暂存区’</li><li>本地仓库(简称：本地)：输入命令：<code>git commit 此次修改的描述</code>，此次改动就放到了 ’本地仓库’，每个 commit，我叫它为一个 ‘版本’。</li><li>远程仓库(简称：远程)：输入命令：<code>git push 远程仓库</code>，此次改动就放到了 ‘远程仓库’（GitHub 等)</li><li>commit-id：输出命令：<code>git log</code>，最上面那行 <code>commit xxxxxx</code>，后面的字符串就是 commit-id</li></ul></li><li>如果喜欢这个项目，欢迎 Star、提交 Pr、<a href="https://github.com/521xueweihan/git-tips/issues">反馈问题</a></li></ol><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul><li><a href="#%E5%B1%95%E7%A4%BA%E5%B8%AE%E5%8A%A9%E4%BF%A1%E6%81%AF">展示帮助信息</a></li><li><a href="#%E5%9B%9E%E5%88%B0%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E7%9A%84%E7%8A%B6%E6%80%81">回到远程仓库的状态</a></li><li><a href="#%E9%87%8D%E8%AE%BE%E7%AC%AC%E4%B8%80%E4%B8%AA-commit">重设第一个commit</a></li><li><a href="#%E6%9F%A5%E7%9C%8B%E5%86%B2%E7%AA%81%E6%96%87%E4%BB%B6%E5%88%97%E8%A1%A8">查看冲突文件列表</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E5%B7%A5%E4%BD%9C%E5%8C%BA%E5%92%8C%E6%9A%82%E5%AD%98%E5%8C%BA%E7%9A%84%E4%B8%8D%E5%90%8C">展示工作区和暂存区的不同</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E6%9A%82%E5%AD%98%E5%8C%BA%E5%92%8C%E6%9C%80%E8%BF%91%E7%89%88%E6%9C%AC%E7%9A%84%E4%B8%8D%E5%90%8C">展示暂存区和最近版本的不同</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E6%9A%82%E5%AD%98%E5%8C%BA%E5%B7%A5%E4%BD%9C%E5%8C%BA%E5%92%8C%E6%9C%80%E8%BF%91%E7%89%88%E6%9C%AC%E7%9A%84%E4%B8%8D%E5%90%8C">展示暂存区、工作区和最近版本的不同</a></li><li><a href="#%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2%E5%88%B0%E4%B8%8A%E4%B8%80%E4%B8%AA%E5%88%86%E6%94%AF">快速切换到上一个分支</a></li><li><a href="#%E5%88%A0%E9%99%A4%E5%B7%B2%E7%BB%8F%E5%90%88%E5%B9%B6%E5%88%B0-master-%E7%9A%84%E5%88%86%E6%94%AF">删除已经合并到 master 的分支</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF%E5%85%B3%E8%81%94%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E7%9A%84%E6%83%85%E5%86%B5">展示本地分支关联远程仓库的情况</a></li><li><a href="#%E5%85%B3%E8%81%94%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF">关联远程分支</a></li><li><a href="#%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF">列出所有远程分支</a></li><li><a href="#%E5%88%97%E5%87%BA%E6%9C%AC%E5%9C%B0%E5%92%8C%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF">列出本地和远程分支</a></li><li><a href="#%E6%9F%A5%E7%9C%8B%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF%E5%92%8C%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF%E7%9A%84%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB">查看远程分支和本地分支的对应关系</a></li><li><a href="#%E8%BF%9C%E7%A8%8B%E5%88%A0%E9%99%A4%E4%BA%86%E5%88%86%E6%94%AF%E6%9C%AC%E5%9C%B0%E4%B9%9F%E6%83%B3%E5%88%A0%E9%99%A4">远程删除了分支本地也想删除</a></li><li><a href="#%E5%88%9B%E5%BB%BA%E5%B9%B6%E5%88%87%E6%8D%A2%E5%88%B0%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF">创建并切换到本地分支</a></li><li><a href="#%E4%BB%8E%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%B9%B6%E5%88%87%E6%8D%A2%E5%88%B0%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF">从远程分支中创建并切换到本地分支</a></li><li><a href="#%E5%88%A0%E9%99%A4%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF">删除本地分支</a></li><li><a href="#%E5%88%A0%E9%99%A4%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF">删除远程分支</a></li><li><a href="#%E9%87%8D%E5%91%BD%E5%90%8D%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF">重命名本地分支</a></li><li><a href="#%E6%9F%A5%E7%9C%8B%E6%A0%87%E7%AD%BE">查看标签</a></li><li><a href="#%E6%9F%A5%E7%9C%8B%E6%A0%87%E7%AD%BE%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF">查看标签详细信息</a></li><li><a href="#%E6%9C%AC%E5%9C%B0%E5%88%9B%E5%BB%BA%E6%A0%87%E7%AD%BE">本地创建标签</a></li><li><a href="#%E6%8E%A8%E9%80%81%E6%A0%87%E7%AD%BE%E5%88%B0%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93">推送标签到远程仓库</a></li><li><a href="#%E5%88%A0%E9%99%A4%E6%9C%AC%E5%9C%B0%E6%A0%87%E7%AD%BE">删除本地标签</a></li><li><a href="#%E5%88%A0%E9%99%A4%E8%BF%9C%E7%A8%8B%E6%A0%87%E7%AD%BE">删除远程标签</a></li><li><a href="#%E5%88%87%E5%9B%9E%E5%88%B0%E6%9F%90%E4%B8%AA%E6%A0%87%E7%AD%BE">切回到某个标签</a></li><li><a href="#%E6%94%BE%E5%BC%83%E5%B7%A5%E4%BD%9C%E5%8C%BA%E7%9A%84%E4%BF%AE%E6%94%B9">放弃工作区的修改</a></li><li><a href="#%E6%81%A2%E5%A4%8D%E5%88%A0%E9%99%A4%E7%9A%84%E6%96%87%E4%BB%B6">恢复删除的文件</a></li><li><a href="#%E4%BB%A5%E6%96%B0%E5%A2%9E%E4%B8%80%E4%B8%AA-commit-%E7%9A%84%E6%96%B9%E5%BC%8F%E8%BF%98%E5%8E%9F%E6%9F%90%E4%B8%80%E4%B8%AA-commit-%E7%9A%84%E4%BF%AE%E6%94%B9">以新增一个 commit 的方式还原某一个 commit 的修改</a></li><li><a href="#%E5%9B%9E%E5%88%B0%E6%9F%90%E4%B8%AA-commit-%E7%9A%84%E7%8A%B6%E6%80%81%E5%B9%B6%E5%88%A0%E9%99%A4%E5%90%8E%E9%9D%A2%E7%9A%84-commit">回到某个 commit 的状态，并删除后面的 commit</a></li><li><a href="#%E4%BF%AE%E6%94%B9%E4%B8%8A%E4%B8%80%E4%B8%AA-commit-%E7%9A%84%E6%8F%8F%E8%BF%B0">修改上一个 commit 的描述</a></li><li><a href="#%E6%9F%A5%E7%9C%8B-commit-%E5%8E%86%E5%8F%B2">查看 commit 历史</a></li><li><a href="#%E6%98%BE%E7%A4%BA%E6%9C%AC%E5%9C%B0%E6%9B%B4%E6%96%B0%E8%BF%87-head-%E7%9A%84-git-%E5%91%BD%E4%BB%A4%E8%AE%B0%E5%BD%95">显示本地更新过 HEAD 的 git 命令记录</a></li><li><a href="#%E4%BF%AE%E6%94%B9%E4%BD%9C%E8%80%85%E5%90%8D">修改作者名</a></li><li><a href="#%E4%BF%AE%E6%94%B9%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E7%9A%84-url">修改远程仓库的 url</a></li><li><a href="#%E5%A2%9E%E5%8A%A0%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93">增加远程仓库</a></li><li><a href="#%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93">列出所有远程仓库</a></li><li><a href="#%E6%9F%A5%E7%9C%8B%E4%B8%A4%E4%B8%AA%E6%98%9F%E6%9C%9F%E5%86%85%E7%9A%84%E6%94%B9%E5%8A%A8">查看两个星期内的改动</a></li><li><a href="#%E6%8A%8A-A-%E5%88%86%E6%94%AF%E7%9A%84%E6%9F%90%E4%B8%80%E4%B8%AA-commit-%E6%94%BE%E5%88%B0-B-%E5%88%86%E6%94%AF%E4%B8%8A">把 A 分支的某一个 commit，放到 B 分支上</a></li><li><a href="#%E7%BB%99-git-%E5%91%BD%E4%BB%A4%E8%B5%B7%E5%88%AB%E5%90%8D">给 git 命令起别名</a></li><li><a href="#%E5%AD%98%E5%82%A8%E5%BD%93%E5%89%8D%E7%9A%84%E4%BF%AE%E6%94%B9%E4%BD%86%E4%B8%8D%E7%94%A8%E6%8F%90%E4%BA%A4-commit">存储当前的修改，但不用提交 commit</a></li><li><a href="#%E4%BF%9D%E5%AD%98%E5%BD%93%E5%89%8D%E7%8A%B6%E6%80%81%E5%8C%85%E6%8B%AC-untracked-%E7%9A%84%E6%96%87%E4%BB%B6">保存当前状态，包括 untracked 的文件</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E6%89%80%E6%9C%89-stashes">展示所有 stashes</a></li><li><a href="#%E5%9B%9E%E5%88%B0%E6%9F%90%E4%B8%AA-stash-%E7%9A%84%E7%8A%B6%E6%80%81">回到某个 stash 的状态</a></li><li><a href="#%E5%9B%9E%E5%88%B0%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA-stash-%E7%9A%84%E7%8A%B6%E6%80%81%E5%B9%B6%E5%88%A0%E9%99%A4%E8%BF%99%E4%B8%AA-stash">回到最后一个 stash 的状态，并删除这个 stash</a></li><li><a href="#%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%89%E7%9A%84-stash">删除所有的 stash</a></li><li><a href="#%E4%BB%8E-stash-%E4%B8%AD%E6%8B%BF%E5%87%BA%E6%9F%90%E4%B8%AA%E6%96%87%E4%BB%B6%E7%9A%84%E4%BF%AE%E6%94%B9">从 stash 中拿出某个文件的修改</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E6%89%80%E6%9C%89-tracked-%E7%9A%84%E6%96%87%E4%BB%B6">展示所有 tracked 的文件</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E6%89%80%E6%9C%89-untracked-%E7%9A%84%E6%96%87%E4%BB%B6">展示所有 untracked 的文件</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E6%89%80%E6%9C%89%E5%BF%BD%E7%95%A5%E7%9A%84%E6%96%87%E4%BB%B6">展示所有忽略的文件</a></li><li><a href="#%E5%BC%BA%E5%88%B6%E5%88%A0%E9%99%A4-untracked-%E7%9A%84%E6%96%87%E4%BB%B6">强制删除 untracked 的文件</a></li><li><a href="#%E5%BC%BA%E5%88%B6%E5%88%A0%E9%99%A4-untracked-%E7%9A%84%E7%9B%AE%E5%BD%95">强制删除 untracked 的目录</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E7%AE%80%E5%8C%96%E7%9A%84-commit-%E5%8E%86%E5%8F%B2">展示简化的 commit 历史</a></li><li><a href="#%E6%9F%A5%E7%9C%8B%E6%9F%90%E6%AE%B5%E4%BB%A3%E7%A0%81%E6%98%AF%E8%B0%81%E5%86%99%E7%9A%84">查看某段代码是谁写的</a></li><li><a href="#%E6%8A%8A%E6%9F%90%E4%B8%80%E4%B8%AA%E5%88%86%E6%94%AF%E5%88%B0%E5%AF%BC%E5%87%BA%E6%88%90%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6">把某一个分支到导出成一个文件</a></li><li><a href="#%E4%BB%8E%E5%8C%85%E4%B8%AD%E5%AF%BC%E5%85%A5%E5%88%86%E6%94%AF">从包中导入分支</a></li><li><a href="#%E6%89%A7%E8%A1%8C-rebase-%E4%B9%8B%E5%89%8D%E8%87%AA%E5%8A%A8-stash">执行 rebase 之前自动 stash</a></li><li><a href="#%E4%BB%8E%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E6%A0%B9%E6%8D%AE-ID-%E6%8B%89%E4%B8%8B%E6%9F%90%E4%B8%80%E7%8A%B6%E6%80%81-%E5%88%B0%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF">从远程仓库根据 ID，拉下某一状态，到本地分支</a></li><li><a href="#%E8%AF%A6%E7%BB%86%E5%B1%95%E7%A4%BA%E4%B8%80%E8%A1%8C%E4%B8%AD%E7%9A%84%E4%BF%AE%E6%94%B9">详细展示一行中的修改</a></li><li><a href="#%E6%B8%85%E9%99%A4-gitignore-%E6%96%87%E4%BB%B6%E4%B8%AD%E8%AE%B0%E5%BD%95%E7%9A%84%E6%96%87%E4%BB%B6">清除 <code>.gitignore</code> 文件中记录的文件</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E6%89%80%E6%9C%89-alias-%E5%92%8C-configs">展示所有 alias 和 configs</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E5%BF%BD%E7%95%A5%E7%9A%84%E6%96%87%E4%BB%B6">展示忽略的文件</a></li><li><a href="#commit-%E5%8E%86%E5%8F%B2%E4%B8%AD%E6%98%BE%E7%A4%BA-Branch1-%E6%9C%89%E7%9A%84%E4%BD%86%E6%98%AF-Branch2-%E6%B2%A1%E6%9C%89-commit">commit 历史中显示 Branch1 有的，但是 Branch2 没有 commit</a></li><li><a href="#%E5%9C%A8-commit-log-%E4%B8%AD%E6%98%BE%E7%A4%BA-GPG-%E7%AD%BE%E5%90%8D">在 commit log 中显示 GPG 签名</a></li><li><a href="#%E5%88%A0%E9%99%A4%E5%85%A8%E5%B1%80%E8%AE%BE%E7%BD%AE">删除全局设置</a></li><li><a href="#%E6%96%B0%E5%BB%BA%E5%B9%B6%E5%88%87%E6%8D%A2%E5%88%B0%E6%96%B0%E5%88%86%E6%94%AF%E4%B8%8A%E5%90%8C%E6%97%B6%E8%BF%99%E4%B8%AA%E5%88%86%E6%94%AF%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95-commit">新建并切换到新分支上，同时这个分支没有任何 commit</a></li><li><a href="#%E5%B1%95%E7%A4%BA%E4%BB%BB%E6%84%8F%E5%88%86%E6%94%AF%E6%9F%90%E4%B8%80%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E5%AE%B9">展示任意分支某一文件的内容</a></li><li><a href="#clone-%E4%B8%8B%E6%9D%A5%E6%8C%87%E5%AE%9A%E7%9A%84%E5%8D%95%E4%B8%80%E5%88%86%E6%94%AF">clone 下来指定的单一分支</a></li><li><a href="#clone-%E6%9C%80%E6%96%B0%E4%B8%80%E6%AC%A1%E6%8F%90%E4%BA%A4">clone 最新一次提交</a></li><li><a href="#%E5%BF%BD%E7%95%A5%E6%9F%90%E4%B8%AA%E6%96%87%E4%BB%B6%E7%9A%84%E6%94%B9%E5%8A%A8">忽略某个文件的改动</a></li><li><a href="#%E5%BF%BD%E7%95%A5%E6%96%87%E4%BB%B6%E7%9A%84%E6%9D%83%E9%99%90%E5%8F%98%E5%8C%96">忽略文件的权限变化</a></li><li><a href="#%E4%BB%A5%E6%9C%80%E5%90%8E%E6%8F%90%E4%BA%A4%E7%9A%84%E9%A1%BA%E5%BA%8F%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89-Git-%E5%88%86%E6%94%AF">以最后提交的顺序列出所有 Git 分支</a></li><li><a href="#%E5%9C%A8-commit-log-%E4%B8%AD%E6%9F%A5%E6%89%BE%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9">在 commit log 中查找相关内容</a></li><li><a href="#%E6%8A%8A%E6%9A%82%E5%AD%98%E5%8C%BA%E7%9A%84%E6%8C%87%E5%AE%9A-file-%E6%94%BE%E5%88%B0%E5%B7%A5%E4%BD%9C%E5%8C%BA%E4%B8%AD">把暂存区的指定 file 放到工作区中</a></li><li><a href="#%E5%BC%BA%E5%88%B6%E6%8E%A8%E9%80%81">强制推送</a></li><li><a href="#git-%E9%85%8D%E7%BD%AE-http-%E5%92%8C-socks-%E4%BB%A3%E7%90%86">git 配置 http 和 socks 代理</a></li><li><a href="#git-%E9%85%8D%E7%BD%AE-ssh-%E4%BB%A3%E7%90%86">git 配置 ssh 代理</a></li><li><a href="#%E4%B8%80%E5%9B%BE%E8%AF%A6%E8%A7%A3">一图详解</a></li><li><a href="#%E4%BC%98%E9%9B%85%E7%9A%84%E6%8F%90%E4%BA%A4Commit%E4%BF%A1%E6%81%AF">优雅的提交Commit信息</a></li></ul><h2 id="展示帮助信息"><a href="#展示帮助信息" class="headerlink" title="展示帮助信息"></a>展示帮助信息</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">help</span> -g<br></code></pre></td></tr></table></figure><p>The command output as below:</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs stata">The common Git guides are:<br>   attributes          Defining attributes per path<br>   <span class="hljs-keyword">cli</span>                 Git command-<span class="hljs-keyword">line</span> interface and conventions<br>   core-<span class="hljs-keyword">tutorial</span>       A Git core <span class="hljs-keyword">tutorial</span> <span class="hljs-keyword">for</span> developers<br>   cvs-migration       Git <span class="hljs-keyword">for</span> CVS users<br>   diffcore            Tweaking diff output<br>   everyday            A useful minimum <span class="hljs-keyword">set</span> of commands <span class="hljs-keyword">for</span> Everyday Git<br>   glossary            A Git Glossary<br>   hooks               Hooks used <span class="hljs-keyword">by</span> Git<br>   ignore              Specifies intentionally untracked files to ignore<br>   modules             Defining submodule properties<br>   namespaces          Git namespaces<br>   repository-layout    Git Repository Layout<br>   revisions           Specifying revisions and ranges <span class="hljs-keyword">for</span> Git<br>   <span class="hljs-keyword">tutorial</span>            A <span class="hljs-keyword">tutorial</span> introduction to Git<br>   <span class="hljs-keyword">tutorial</span>-2          A <span class="hljs-keyword">tutorial</span> introduction to Git: part <span class="hljs-keyword">two</span><br>   workflows           <span class="hljs-keyword">An</span> overview of recommended workflows with Git<br><br>&#x27;git <span class="hljs-keyword">help</span> -a&#x27; and &#x27;git <span class="hljs-keyword">help</span> -<span class="hljs-keyword">g</span>&#x27; <span class="hljs-keyword">list</span> available subcommands and some concept guides. See &#x27;git <span class="hljs-keyword">help</span> &lt;command&gt;&#x27; or &#x27;git <span class="hljs-keyword">help</span> &lt;concept&gt;&#x27; to <span class="hljs-keyword">read</span> <span class="hljs-keyword">about</span> a specific subcommand or concept.<br></code></pre></td></tr></table></figure><h2 id="回到远程仓库的状态"><a href="#回到远程仓库的状态" class="headerlink" title="回到远程仓库的状态"></a>回到远程仓库的状态</h2><p>抛弃本地所有的修改，回到远程仓库的状态。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git fetch --all &amp;&amp; git reset --hard origin/master<br></code></pre></td></tr></table></figure><h2 id="重设第一个-commit"><a href="#重设第一个-commit" class="headerlink" title="重设第一个 commit"></a>重设第一个 commit</h2><p>也就是把所有的改动都重新放回工作区，并<strong>清空所有的 commit</strong>，这样就可以重新提交第一个 commit 了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git update-ref -d HEAD<br></code></pre></td></tr></table></figure><h2 id="查看冲突文件列表"><a href="#查看冲突文件列表" class="headerlink" title="查看冲突文件列表"></a>查看冲突文件列表</h2><p>展示工作区的冲突文件列表</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git diff --name-only --diff-filter=U<br></code></pre></td></tr></table></figure><h2 id="展示工作区和暂存区的不同"><a href="#展示工作区和暂存区的不同" class="headerlink" title="展示工作区和暂存区的不同"></a>展示工作区和暂存区的不同</h2><p>输出<strong>工作区</strong>和<strong>暂存区</strong>的 different (不同)。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git diff<br></code></pre></td></tr></table></figure><p>还可以展示本地仓库中任意两个 commit 之间的文件变动：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git diff &lt;commit-id&gt; &lt;commit-id&gt;<br></code></pre></td></tr></table></figure><h2 id="展示暂存区和最近版本的不同"><a href="#展示暂存区和最近版本的不同" class="headerlink" title="展示暂存区和最近版本的不同"></a>展示暂存区和最近版本的不同</h2><p>输出<strong>暂存区</strong>和本地最近的版本 (commit) 的 different (不同)。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git diff --cached<br></code></pre></td></tr></table></figure><h2 id="展示暂存区、工作区和最近版本的不同"><a href="#展示暂存区、工作区和最近版本的不同" class="headerlink" title="展示暂存区、工作区和最近版本的不同"></a>展示暂存区、工作区和最近版本的不同</h2><p>输出<strong>工作区</strong>、<strong>暂存区</strong> 和本地最近的版本 (commit) 的 different (不同)。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git diff HEAD<br></code></pre></td></tr></table></figure><h2 id="快速切换到上一个分支"><a href="#快速切换到上一个分支" class="headerlink" title="快速切换到上一个分支"></a>快速切换到上一个分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git checkout -<br></code></pre></td></tr></table></figure><h2 id="删除已经合并到-master-的分支"><a href="#删除已经合并到-master-的分支" class="headerlink" title="删除已经合并到 master 的分支"></a>删除已经合并到 master 的分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git branch --merged master | grep -v <span class="hljs-string">&#x27;^\*\|  master&#x27;</span> | xargs -n 1 git branch -d<br></code></pre></td></tr></table></figure><h2 id="展示本地分支关联远程仓库的情况"><a href="#展示本地分支关联远程仓库的情况" class="headerlink" title="展示本地分支关联远程仓库的情况"></a>展示本地分支关联远程仓库的情况</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git branch -vv<br></code></pre></td></tr></table></figure><h2 id="关联远程分支"><a href="#关联远程分支" class="headerlink" title="关联远程分支"></a>关联远程分支</h2><p>关联之后，<code>git branch -vv</code> 就可以展示关联的远程分支名了，同时推送到远程仓库直接：<code>git push</code>，不需要指定远程仓库了。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git branch -u origin/mybranch<br></code></pre></td></tr></table></figure><p>或者在 push 时加上 <code>-u</code> 参数</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git push origin/mybranch -u<br></code></pre></td></tr></table></figure><h2 id="列出所有远程分支"><a href="#列出所有远程分支" class="headerlink" title="列出所有远程分支"></a>列出所有远程分支</h2><p>-r 参数相当于：remote</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git branch -r<br></code></pre></td></tr></table></figure><h2 id="列出本地和远程分支"><a href="#列出本地和远程分支" class="headerlink" title="列出本地和远程分支"></a>列出本地和远程分支</h2><p>-a 参数相当于：all</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git branch -a<br></code></pre></td></tr></table></figure><h2 id="查看远程分支和本地分支的对应关系"><a href="#查看远程分支和本地分支的对应关系" class="headerlink" title="查看远程分支和本地分支的对应关系"></a>查看远程分支和本地分支的对应关系</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git remote show origin<br></code></pre></td></tr></table></figure><h2 id="远程删除了分支本地也想删除"><a href="#远程删除了分支本地也想删除" class="headerlink" title="远程删除了分支本地也想删除"></a>远程删除了分支本地也想删除</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git remote prune origin<br></code></pre></td></tr></table></figure><h2 id="创建并切换到本地分支"><a href="#创建并切换到本地分支" class="headerlink" title="创建并切换到本地分支"></a>创建并切换到本地分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git checkout -b &lt;branch-name&gt;<br></code></pre></td></tr></table></figure><h2 id="从远程分支中创建并切换到本地分支"><a href="#从远程分支中创建并切换到本地分支" class="headerlink" title="从远程分支中创建并切换到本地分支"></a>从远程分支中创建并切换到本地分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git checkout -b &lt;branch-name&gt; origin/&lt;branch-name&gt;<br></code></pre></td></tr></table></figure><h2 id="删除本地分支"><a href="#删除本地分支" class="headerlink" title="删除本地分支"></a>删除本地分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git branch -d &lt;local-branchname&gt;<br></code></pre></td></tr></table></figure><h2 id="删除远程分支"><a href="#删除远程分支" class="headerlink" title="删除远程分支"></a>删除远程分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git push origin --delete &lt;remote-branchname&gt;<br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git push origin :&lt;remote-branchname&gt;<br></code></pre></td></tr></table></figure><h2 id="重命名本地分支"><a href="#重命名本地分支" class="headerlink" title="重命名本地分支"></a>重命名本地分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git branch -m &lt;new-branch-name&gt;<br></code></pre></td></tr></table></figure><h2 id="查看标签"><a href="#查看标签" class="headerlink" title="查看标签"></a>查看标签</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git tag<br></code></pre></td></tr></table></figure><p>展示当前分支的最近的 tag</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git describe --tags --abbrev=0<br></code></pre></td></tr></table></figure><h2 id="查看标签详细信息"><a href="#查看标签详细信息" class="headerlink" title="查看标签详细信息"></a>查看标签详细信息</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git tag -ln<br></code></pre></td></tr></table></figure><h2 id="本地创建标签"><a href="#本地创建标签" class="headerlink" title="本地创建标签"></a>本地创建标签</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git tag &lt;version-number&gt;<br></code></pre></td></tr></table></figure><p>默认 tag 是打在最近的一次 commit 上，如果需要指定 commit 打 tag：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git tag -a &lt;version-number&gt; -m <span class="hljs-string">&quot;v1.0 发布(描述)&quot;</span> &lt;commit-id&gt;<br></code></pre></td></tr></table></figure><h2 id="推送标签到远程仓库"><a href="#推送标签到远程仓库" class="headerlink" title="推送标签到远程仓库"></a>推送标签到远程仓库</h2><p>首先要保证本地创建好了标签才可以推送标签到远程仓库：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git push origin &lt;local-version-number&gt;<br></code></pre></td></tr></table></figure><p>一次性推送所有标签，同步到远程仓库：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git push origin --tags<br></code></pre></td></tr></table></figure><h2 id="查看标签按照时间排序"><a href="#查看标签按照时间排序" class="headerlink" title="查看标签按照时间排序"></a>查看标签按照时间排序</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 按时间正序排列</span><br>git tag --sort=v:refname<br><span class="hljs-comment"># 按时间倒序排列</span><br>git tag --sort=-v:refname<br></code></pre></td></tr></table></figure><h2 id="删除本地标签"><a href="#删除本地标签" class="headerlink" title="删除本地标签"></a>删除本地标签</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git tag -d &lt;tag-name&gt;<br></code></pre></td></tr></table></figure><h2 id="删除远程标签"><a href="#删除远程标签" class="headerlink" title="删除远程标签"></a>删除远程标签</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git push origin --delete tag &lt;tagname&gt;<br></code></pre></td></tr></table></figure><h2 id="切回到某个标签"><a href="#切回到某个标签" class="headerlink" title="切回到某个标签"></a>切回到某个标签</h2><p>一般上线之前都会打 tag，就是为了防止上线后出现问题，方便快速回退到上一版本。下面的命令是回到某一标签下的状态：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git checkout -b branch_name tag_name<br></code></pre></td></tr></table></figure><h2 id="放弃工作区的修改"><a href="#放弃工作区的修改" class="headerlink" title="放弃工作区的修改"></a>放弃工作区的修改</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git checkout &lt;file-name&gt;<br></code></pre></td></tr></table></figure><p>放弃所有修改：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git checkout .<br></code></pre></td></tr></table></figure><h2 id="恢复删除的文件"><a href="#恢复删除的文件" class="headerlink" title="恢复删除的文件"></a>恢复删除的文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">git rev-list -n 1 HEAD -- &lt;file_path&gt; <span class="hljs-comment">#得到 deleting_commit</span><br><br>git checkout &lt;deleting_commit&gt;^ -- &lt;file_path&gt; <span class="hljs-comment">#回到删除文件 deleting_commit 之前的状态</span><br></code></pre></td></tr></table></figure><h2 id="以新增一个-commit-的方式还原某一个-commit-的修改"><a href="#以新增一个-commit-的方式还原某一个-commit-的修改" class="headerlink" title="以新增一个 commit 的方式还原某一个 commit 的修改"></a>以新增一个 commit 的方式还原某一个 commit 的修改</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git revert &lt;commit-id&gt;<br></code></pre></td></tr></table></figure><h2 id="回到某个-commit-的状态，并删除后面的-commit"><a href="#回到某个-commit-的状态，并删除后面的-commit" class="headerlink" title="回到某个 commit 的状态，并删除后面的 commit"></a>回到某个 commit 的状态，并删除后面的 commit</h2><p>和 revert 的区别：reset 命令会抹去某个 commit id 之后的所有 commit</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">git reset &lt;commit-id&gt;  <span class="hljs-comment">#默认就是-mixed参数。</span><br><br>git reset  -- mixed HEAD^  <span class="hljs-comment">#回退至上个版本，它将重置HEAD到另外一个commit,并且重置暂存区以便和HEAD相匹配，但是也到此为止。工作区不会被更改。</span><br><br>git reset -- soft HEAD~3  <span class="hljs-comment">#回退至三个版本之前，只回退了commit的信息，暂存区和工作区与回退之前保持一致。如果还要提交，直接commit即可  </span><br><br>git reset -- hard &lt;commit-id&gt;  <span class="hljs-comment">#彻底回退到指定commit-id的状态，暂存区和工作区也会变为指定commit-id版本的内容</span><br></code></pre></td></tr></table></figure><h2 id="修改上一个-commit-的描述"><a href="#修改上一个-commit-的描述" class="headerlink" title="修改上一个 commit 的描述"></a>修改上一个 commit 的描述</h2><p>如果暂存区有改动，同时也会将暂存区的改动提交到上一个 commit</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git commit --amend<br></code></pre></td></tr></table></figure><h2 id="查看-commit-历史"><a href="#查看-commit-历史" class="headerlink" title="查看 commit 历史"></a>查看 commit 历史</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><h2 id="查看某段代码是谁写的"><a href="#查看某段代码是谁写的" class="headerlink" title="查看某段代码是谁写的"></a>查看某段代码是谁写的</h2><p>blame 的意思为‘责怪’，你懂的。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git blame &lt;file-name&gt;<br></code></pre></td></tr></table></figure><h2 id="显示本地更新过-HEAD-的-git-命令记录"><a href="#显示本地更新过-HEAD-的-git-命令记录" class="headerlink" title="显示本地更新过 HEAD 的 git 命令记录"></a>显示本地更新过 HEAD 的 git 命令记录</h2><p>每次更新了 HEAD 的 git 命令比如 commint、amend、cherry-pick、reset、revert 等都会被记录下来（不限分支），就像 shell 的 history 一样。<br>这样你可以 reset 到任何一次更新了 HEAD 的操作之后，而不仅仅是回到当前分支下的某个 commit 之后的状态。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git reflog<br></code></pre></td></tr></table></figure><h2 id="修改作者名"><a href="#修改作者名" class="headerlink" title="修改作者名"></a>修改作者名</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git commit --amend --author=<span class="hljs-string">&#x27;Author Name &lt;email@address.com&gt;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="修改远程仓库的-url"><a href="#修改远程仓库的-url" class="headerlink" title="修改远程仓库的 url"></a>修改远程仓库的 url</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git remote set-url origin &lt;URL&gt;<br></code></pre></td></tr></table></figure><h2 id="增加远程仓库"><a href="#增加远程仓库" class="headerlink" title="增加远程仓库"></a>增加远程仓库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git remote add origin &lt;remote-url&gt;<br></code></pre></td></tr></table></figure><h2 id="列出所有远程仓库"><a href="#列出所有远程仓库" class="headerlink" title="列出所有远程仓库"></a>列出所有远程仓库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git remote<br></code></pre></td></tr></table></figure><h2 id="查看两个星期内的改动"><a href="#查看两个星期内的改动" class="headerlink" title="查看两个星期内的改动"></a>查看两个星期内的改动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git whatchanged --since=<span class="hljs-string">&#x27;2 weeks ago&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="把-A-分支的某一个-commit，放到-B-分支上"><a href="#把-A-分支的某一个-commit，放到-B-分支上" class="headerlink" title="把 A 分支的某一个 commit，放到 B 分支上"></a>把 A 分支的某一个 commit，放到 B 分支上</h2><p>这个过程需要 <code>cherry-pick</code> 命令，<a href="http://sg552.iteye.com/blog/1300713#bc2367928">参考</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git checkout &lt;branch-name&gt; &amp;&amp; git cherry-pick &lt;commit-id&gt;<br></code></pre></td></tr></table></figure><h2 id="给-git-命令起别名"><a href="#给-git-命令起别名" class="headerlink" title="给 git 命令起别名"></a>给 git 命令起别名</h2><p>简化命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">git config --global <span class="hljs-built_in">alias</span>.&lt;handle&gt; &lt;<span class="hljs-built_in">command</span>&gt;<br><br>比如：git status 改成 git st，这样可以简化命令<br><br>git config --global alias.st status<br></code></pre></td></tr></table></figure><h2 id="存储当前的修改，但不用提交-commit"><a href="#存储当前的修改，但不用提交-commit" class="headerlink" title="存储当前的修改，但不用提交 commit"></a>存储当前的修改，但不用提交 commit</h2><p>详解可以参考<a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/00137602359178794d966923e5c4134bc8bf98dfb03aea3000">廖雪峰老师的 git 教程</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git stash<br></code></pre></td></tr></table></figure><h2 id="保存当前状态，包括-untracked-的文件"><a href="#保存当前状态，包括-untracked-的文件" class="headerlink" title="保存当前状态，包括 untracked 的文件"></a>保存当前状态，包括 untracked 的文件</h2><p>untracked 文件：新建的文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git stash -u<br></code></pre></td></tr></table></figure><h2 id="展示所有-stashes"><a href="#展示所有-stashes" class="headerlink" title="展示所有 stashes"></a>展示所有 stashes</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git stash list<br></code></pre></td></tr></table></figure><h2 id="回到某个-stash-的状态"><a href="#回到某个-stash-的状态" class="headerlink" title="回到某个 stash 的状态"></a>回到某个 stash 的状态</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git stash apply &lt;stash@&#123;n&#125;&gt;<br></code></pre></td></tr></table></figure><h2 id="回到最后一个-stash-的状态，并删除这个-stash"><a href="#回到最后一个-stash-的状态，并删除这个-stash" class="headerlink" title="回到最后一个 stash 的状态，并删除这个 stash"></a>回到最后一个 stash 的状态，并删除这个 stash</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git stash pop<br></code></pre></td></tr></table></figure><h2 id="删除所有的-stash"><a href="#删除所有的-stash" class="headerlink" title="删除所有的 stash"></a>删除所有的 stash</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git stash clear<br></code></pre></td></tr></table></figure><h2 id="从-stash-中拿出某个文件的修改"><a href="#从-stash-中拿出某个文件的修改" class="headerlink" title="从 stash 中拿出某个文件的修改"></a>从 stash 中拿出某个文件的修改</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git checkout &lt;stash@&#123;n&#125;&gt; -- &lt;file-path&gt;<br></code></pre></td></tr></table></figure><h2 id="展示所有-tracked-的文件"><a href="#展示所有-tracked-的文件" class="headerlink" title="展示所有 tracked 的文件"></a>展示所有 tracked 的文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git ls-files -t<br></code></pre></td></tr></table></figure><h2 id="展示所有-untracked-的文件"><a href="#展示所有-untracked-的文件" class="headerlink" title="展示所有 untracked 的文件"></a>展示所有 untracked 的文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git ls-files --others<br></code></pre></td></tr></table></figure><h2 id="展示所有忽略的文件"><a href="#展示所有忽略的文件" class="headerlink" title="展示所有忽略的文件"></a>展示所有忽略的文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git ls-files --others -i --exclude-standard<br></code></pre></td></tr></table></figure><h2 id="强制删除-untracked-的文件"><a href="#强制删除-untracked-的文件" class="headerlink" title="强制删除 untracked 的文件"></a>强制删除 untracked 的文件</h2><p>可以用来删除新建的文件。如果不指定文件文件名，则清空所有工作的 untracked 文件。<code>clean</code> 命令，<strong>注意两点</strong>：</p><ol><li>clean 后，删除的文件无法找回</li><li>不会影响 tracked 的文件的改动，只会删除 untracked 的文件</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git clean &lt;file-name&gt; -f<br></code></pre></td></tr></table></figure><h2 id="强制删除-untracked-的目录"><a href="#强制删除-untracked-的目录" class="headerlink" title="强制删除 untracked 的目录"></a>强制删除 untracked 的目录</h2><p>可以用来删除新建的目录，<strong>注意</strong>:这个命令也可以用来删除 untracked 的文件。详情见上一条</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git clean &lt;directory-name&gt; -df<br></code></pre></td></tr></table></figure><h2 id="展示简化的-commit-历史"><a href="#展示简化的-commit-历史" class="headerlink" title="展示简化的 commit 历史"></a>展示简化的 commit 历史</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">log</span> --pretty=oneline --graph --decorate --all<br></code></pre></td></tr></table></figure><h2 id="把某一个分支到导出成一个文件"><a href="#把某一个分支到导出成一个文件" class="headerlink" title="把某一个分支到导出成一个文件"></a>把某一个分支到导出成一个文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git bundle create &lt;file&gt; &lt;branch-name&gt;<br></code></pre></td></tr></table></figure><h2 id="从包中导入分支"><a href="#从包中导入分支" class="headerlink" title="从包中导入分支"></a>从包中导入分支</h2><p>新建一个分支，分支内容就是上面 <code>git bundle create</code> 命令导出的内容</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> repo.bundle &lt;repo-dir&gt; -b &lt;branch-name&gt;<br></code></pre></td></tr></table></figure><h2 id="执行-rebase-之前自动-stash"><a href="#执行-rebase-之前自动-stash" class="headerlink" title="执行 rebase 之前自动 stash"></a>执行 rebase 之前自动 stash</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git rebase --autostash<br></code></pre></td></tr></table></figure><h2 id="从远程仓库根据-ID，拉下某一状态，到本地分支"><a href="#从远程仓库根据-ID，拉下某一状态，到本地分支" class="headerlink" title="从远程仓库根据 ID，拉下某一状态，到本地分支"></a>从远程仓库根据 ID，拉下某一状态，到本地分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git fetch origin pull/&lt;id&gt;/head:&lt;branch-name&gt;<br></code></pre></td></tr></table></figure><h2 id="详细展示一行中的修改"><a href="#详细展示一行中的修改" class="headerlink" title="详细展示一行中的修改"></a>详细展示一行中的修改</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git diff --word-diff<br></code></pre></td></tr></table></figure><h2 id="清除-gitignore-文件中记录的文件"><a href="#清除-gitignore-文件中记录的文件" class="headerlink" title="清除 gitignore 文件中记录的文件"></a>清除 gitignore 文件中记录的文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git clean -X -f<br></code></pre></td></tr></table></figure><h2 id="展示所有-alias-和-configs"><a href="#展示所有-alias-和-configs" class="headerlink" title="展示所有 alias 和 configs"></a>展示所有 alias 和 configs</h2><p><strong>注意：</strong> config 分为：当前目录（local）和全局（golbal）的 config，默认为当前目录的 config</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">git config --<span class="hljs-built_in">local</span> --list (当前目录)<br>git config --global --list (全局)<br></code></pre></td></tr></table></figure><h2 id="展示忽略的文件"><a href="#展示忽略的文件" class="headerlink" title="展示忽略的文件"></a>展示忽略的文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git status --ignored<br></code></pre></td></tr></table></figure><h2 id="commit-历史中显示-Branch1-有的，但是-Branch2-没有-commit"><a href="#commit-历史中显示-Branch1-有的，但是-Branch2-没有-commit" class="headerlink" title="commit 历史中显示 Branch1 有的，但是 Branch2 没有 commit"></a>commit 历史中显示 Branch1 有的，但是 Branch2 没有 commit</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">log</span> Branch1 ^Branch2<br></code></pre></td></tr></table></figure><h2 id="在-commit-log-中显示-GPG-签名"><a href="#在-commit-log-中显示-GPG-签名" class="headerlink" title="在 commit log 中显示 GPG 签名"></a>在 commit log 中显示 GPG 签名</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">log</span> --show-signature<br></code></pre></td></tr></table></figure><h2 id="删除全局设置"><a href="#删除全局设置" class="headerlink" title="删除全局设置"></a>删除全局设置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git config --global --<span class="hljs-built_in">unset</span> &lt;entry-name&gt;<br></code></pre></td></tr></table></figure><h2 id="新建并切换到新分支上，同时这个分支没有任何-commit"><a href="#新建并切换到新分支上，同时这个分支没有任何-commit" class="headerlink" title="新建并切换到新分支上，同时这个分支没有任何 commit"></a>新建并切换到新分支上，同时这个分支没有任何 commit</h2><p>相当于保存修改，但是重写 commit 历史</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git checkout --orphan &lt;branch-name&gt;<br></code></pre></td></tr></table></figure><h2 id="展示任意分支某一文件的内容"><a href="#展示任意分支某一文件的内容" class="headerlink" title="展示任意分支某一文件的内容"></a>展示任意分支某一文件的内容</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git show &lt;branch-name&gt;:&lt;file-name&gt;<br></code></pre></td></tr></table></figure><h2 id="clone-下来指定的单一分支"><a href="#clone-下来指定的单一分支" class="headerlink" title="clone 下来指定的单一分支"></a>clone 下来指定的单一分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> -b &lt;branch-name&gt; --single-branch https://github.com/user/repo.git<br></code></pre></td></tr></table></figure><h2 id="clone-最新一次提交"><a href="#clone-最新一次提交" class="headerlink" title="clone 最新一次提交"></a>clone 最新一次提交</h2><p>只会 clone 最近一次提交，将减少 clone 时间</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> --depth=1 https://github.com/user/repo.git<br></code></pre></td></tr></table></figure><h2 id="忽略某个文件的改动"><a href="#忽略某个文件的改动" class="headerlink" title="忽略某个文件的改动"></a>忽略某个文件的改动</h2><p>关闭 track 指定文件的改动，也就是 Git 将不会在记录这个文件的改动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git update-index --assume-unchanged path/to/file<br></code></pre></td></tr></table></figure><p>恢复 track 指定文件的改动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git update-index --no-assume-unchanged path/to/file<br></code></pre></td></tr></table></figure><h2 id="忽略文件的权限变化"><a href="#忽略文件的权限变化" class="headerlink" title="忽略文件的权限变化"></a>忽略文件的权限变化</h2><p>不再将文件的权限变化视作改动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git config core.fileMode <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><h2 id="以最后提交的顺序列出所有-Git-分支"><a href="#以最后提交的顺序列出所有-Git-分支" class="headerlink" title="以最后提交的顺序列出所有 Git 分支"></a>以最后提交的顺序列出所有 Git 分支</h2><p>最新的放在最上面</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git for-each-ref --sort=-committerdate --format=<span class="hljs-string">&#x27;%(refname:short)&#x27;</span> refs/heads/<br></code></pre></td></tr></table></figure><h2 id="在-commit-log-中查找相关内容"><a href="#在-commit-log-中查找相关内容" class="headerlink" title="在 commit log 中查找相关内容"></a>在 commit log 中查找相关内容</h2><p>通过 grep 查找，given-text：所需要查找的字段</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">log</span> --all --grep=<span class="hljs-string">&#x27;&lt;given-text&gt;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="把暂存区的指定-file-放到工作区中"><a href="#把暂存区的指定-file-放到工作区中" class="headerlink" title="把暂存区的指定 file 放到工作区中"></a>把暂存区的指定 file 放到工作区中</h2><p>不添加参数，默认是 <code>-mixed</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git reset &lt;file-name&gt;<br></code></pre></td></tr></table></figure><h2 id="强制推送"><a href="#强制推送" class="headerlink" title="强制推送"></a>强制推送</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git push -f &lt;remote-name&gt; &lt;branch-name&gt;<br></code></pre></td></tr></table></figure><h2 id="git-配置-http-和-socks-代理"><a href="#git-配置-http-和-socks-代理" class="headerlink" title="git 配置 http 和 socks 代理"></a>git 配置 http 和 socks 代理</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">git config --global https.proxy <span class="hljs-string">&#x27;http://127.0.0.1:8001&#x27;</span>   <span class="hljs-comment"># 适用于 privoxy 将 socks 协议转为 http 协议的 http 端口</span><br>git config --global http.proxy <span class="hljs-string">&#x27;http://127.0.0.1:8001&#x27;</span><br>git config --global socks.proxy <span class="hljs-string">&quot;127.0.0.1:1080&quot;</span><br></code></pre></td></tr></table></figure><h2 id="git-配置-ssh-代理"><a href="#git-配置-ssh-代理" class="headerlink" title="git 配置 ssh 代理"></a>git 配置 ssh 代理</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ cat ~/.ssh/config<br>Host gitlab.com<br>ProxyCommand nc -X 5 -x 127.0.0.1:1080 %h %p    <span class="hljs-comment"># 直接使用 shadowsocks 提供的 socks5 代理端口</span><br><br>Host github.com<br>ProxyCommand nc -X 5 -x 127.0.0.1:1080 %h %p    <br></code></pre></td></tr></table></figure><h2 id="一图详解"><a href="#一图详解" class="headerlink" title="一图详解"></a>一图详解</h2><p><img src="https://stellae.gitee.io/myblog/images/images/git.png"></p><h2 id="优雅的提交Commit信息"><a href="#优雅的提交Commit信息" class="headerlink" title="优雅的提交Commit信息"></a>优雅的提交Commit信息</h2><p>使用<a href="https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#-git-commit-guidelines">Angular团队提交规范</a></p><p>主要有以下组成</p><ul><li>标题行: 必填, 描述主要修改类型和内容</li><li>主题内容: 描述为什么修改, 做了什么样的修改, 以及开发的思路等等</li><li>页脚注释: 放 Breaking Changes 或 Closed Issues</li></ul><p>常用的修改项</p><ul><li>type: commit 的类型</li><li>feat: 新特性</li><li>fix: 修改问题</li><li>refactor: 代码重构</li><li>docs: 文档修改</li><li>style: 代码格式修改, 注意不是 css 修改</li><li>test: 测试用例修改</li><li>chore: 其他修改, 比如构建流程, 依赖管理.</li><li>scope: commit 影响的范围, 比如: route, component, utils, build…</li><li>subject: commit 的概述</li><li>body: commit 具体修改内容, 可以分为多行</li><li>footer: 一些备注, 通常是 BREAKING CHANGE 或修复的 bug 的链接.</li></ul><h2 id="使用Commitizen代替-git-commit"><a href="#使用Commitizen代替-git-commit" class="headerlink" title="使用Commitizen代替 git commit"></a>使用<code>Commitizen</code>代替 git commit</h2><p>可以使用<a href="https://github.com/commitizen/cz-cli">cz-cli</a>工具代替 <code>git commit</code></p><p>全局安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install -g commitizen cz-conventional-changelog<br><br>echo &#x27;&#123; &quot;path&quot;: &quot;cz-conventional-changelog&quot; &#125;&#x27; &gt; ~/.czrc<br></code></pre></td></tr></table></figure><p>全局安装后使用 <code>git cz</code> 代替 <code>git commit</code>就可以了,如下图</p><p><img src="https://stellae.gitee.io/myblog/images/images/gitcz.png"></p><p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ 返回顶部</a></strong></p>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Sqlite数据库</title>
    <link href="/Myblog/2019/10/31/Sqlite%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <url>/Myblog/2019/10/31/Sqlite%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<h3 id="Sqlite数据库简介"><a href="#Sqlite数据库简介" class="headerlink" title="Sqlite数据库简介"></a>Sqlite数据库简介</h3><p>SQLite 是一个C语言库，它可以提供一种轻量级的基于磁盘的数据库，这种数据库不需要独立的服务器进程，也允许需要使用一种非标准的 SQL 查询语言来访问它。一些应用程序可以使用 SQLite 作为内部数据存储。可以用它来创建一个应用程序原型，然后再迁移到更大的数据库，比如 PostgreSQL 或 Oracle。</p><h3 id="Sqlite-Python-原生"><a href="#Sqlite-Python-原生" class="headerlink" title="Sqlite + Python(原生)"></a>Sqlite + Python(原生)</h3><p>使用 Python 内置模块 sqlite3。sqlite3 模块由 Gerhard Häring 编写。它提供了符合 DB-API 2.0 规范的接口，这个规范是 <a href="https://www.python.org/dev/peps/pep-0249"><strong>PEP 249</strong></a>。具体使用方法参见 <a href="https://docs.python.org/zh-cn/3/library/sqlite3.html">官方sqlite3</a> 。</p><h3 id="Sqlite-Sqlalchemy-ORM"><a href="#Sqlite-Sqlalchemy-ORM" class="headerlink" title="Sqlite + Sqlalchemy(ORM)"></a>Sqlite + Sqlalchemy(ORM)</h3><p>这里我们使用 Python 强大的 ORM框架 Sqlalchemy 来操作 Sqlite 数据库</p><p>示例：</p><p>文件 <code>__init__.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sa<br><br>BASE_DIR = os.path.abspath(os.path.join(os.path.join(__file__, os.pardir), os.pardir))<br><br><span class="hljs-comment"># sqlite</span><br>engine = sa.create_engine(<span class="hljs-string">&quot;sqlite:///&#123;0&#125;/picture.db?check_same_thread=False&quot;</span>.format(BASE_DIR))<br><span class="hljs-comment"># engine_sqlite = sa.create_engine(&quot;sqlite:///picture.db&quot;)</span><br>Session = sa.orm.sessionmaker(bind=engine)<br>session = Session()<br></code></pre></td></tr></table></figure><blockquote><p>说明：<code>check_same_thread=False</code>: 多线程能够同时操作</p></blockquote><p>文件 <code>model.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sa<br><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base<br><span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> Base<br><br>Base = declarative_base(bind=engine)<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Picture</span>(<span class="hljs-params">Base</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;图片处理记录表&quot;&quot;&quot;</span><br>    __tablename__ = <span class="hljs-string">&#x27;picture&#x27;</span><br><br>    id = sa.Column(sa.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>)<br>    no = sa.Column(sa.String(<span class="hljs-number">20</span>), comment=<span class="hljs-string">&quot;产品货号&quot;</span>, index=<span class="hljs-literal">True</span>)<br>    hash = sa.Column(sa.String(<span class="hljs-number">256</span>), comment=<span class="hljs-string">&quot;图片哈希值&quot;</span>)<br>    failed_date = sa.Column(sa.DateTime, comment=<span class="hljs-string">&quot;更新失败时间&quot;</span>)<br>    is_success = sa.Column(sa.Boolean, default=<span class="hljs-literal">True</span>, comment=<span class="hljs-string">&quot;更新是否成功&quot;</span>)<br>    add_date = sa.Column(sa.DateTime, default=datetime.datetime.now, comment=<span class="hljs-string">&quot;更新时间&quot;</span>)<br>    last_modified_date = sa.Column(sa.DateTime, default=datetime.datetime.now,<br>                                   onupdate=datetime.datetime.now, comment=<span class="hljs-string">&quot;最后一次修改时间&quot;</span>)<br><br>    <br>Base.metadata.create_all(engine_sqlite)   <span class="hljs-comment"># 建表（自动检测是否存在）</span><br></code></pre></td></tr></table></figure><p>完成配置后，即可使用 Sqlalchemy 来操作 Sqlite数据库了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">session.add(Picture(no=item_no, hash=hasher, is_success=<span class="hljs-literal">False</span>, failed_date=datetime.datetime.now()))<br>session.commit()<br></code></pre></td></tr></table></figure><ul><li>参考文章:  <a href="https://www.cnblogs.com/lsdb/p/9835894.html">sqlalchemy操作sqlite</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>sqlite</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Logging模块基本用法</title>
    <link href="/Myblog/2019/10/31/Logging%E6%A8%A1%E5%9D%97%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/"/>
    <url>/Myblog/2019/10/31/Logging%E6%A8%A1%E5%9D%97%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h3 id="日志作用"><a href="#日志作用" class="headerlink" title="日志作用"></a>日志作用</h3><p>在部署项目时，不可能直接将所有的信息都输出到控制台中，我们可以将这些信息记录到日志文件中，这样不仅方便我们查看程序运行时的情况，也可以在项目出现故障时根据运行时产生的日志快速定位问题出现的位置。</p><p>###日志级别</p><p>Python 标准库 logging 用作记录日志，默认分为六种日志级别（括号为级别对应的数值），NOTSET（0）、DEBUG（10）、INFO（20）、WARNING（30）、ERROR（40）、CRITICAL（50）。我们自定义日志级别时注意不要和默认的日志级别数值相同，logging 执行时输出大于等于设置的日志级别的日志信息，如设置日志级别是 INFO，则 INFO、WARNING、ERROR、CRITICAL 级别的日志都会输出。</p><h3 id="配置日志"><a href="#配置日志" class="headerlink" title="配置日志"></a>配置日志</h3><p>这里我们使用python内置logging模块。logging模块使用非常简单，使用 basicConfig() 方法就能满足基本的使用需要，如果方法没有传入参数，会根据默认的配置创建Logger 对象，默认的日志级别被设置为 WARNING该函数basicConfig可选的参数如下表所示。</p><p><img src="https://stellae.gitee.io/myblog/images/images/logging_config.png"></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua">BASE_DIR = <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.abspath(<span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.join(<span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.join(__file__, <span class="hljs-built_in">os</span>.pardir), <span class="hljs-built_in">os</span>.pardir))<br><br>logging.basicConfig(<br>    filename=<span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.join(BASE_DIR, <span class="hljs-string">&#x27;pic-sync-service.log&#x27;</span>),<br>    level=logging.DEBUG,<br>    <span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;%(asctime)s : %(levelname)s : %(message)s&#x27;</span>, datefmt=<span class="hljs-string">&#x27;%Y/%m/%d %I:%M:%S %p&#x27;</span><br>)<br></code></pre></td></tr></table></figure><p>示例1 (单个输出源)：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> os<br><br>BASE_DIR = os.path.abspath(os.path.join(os.path.join(__file__, os.pardir), os.pardir))<br><br>logging.basicConfig(<br>    filename=os.path.join(BASE_DIR, <span class="hljs-string">&#x27;pic-sync-service.log&#x27;</span>),<br>    level=logging.DEBUG,<br>    format=<span class="hljs-string">&#x27;%(asctime)s : %(levelname)s : %(message)s&#x27;</span>, datefmt=<span class="hljs-string">&#x27;%Y/%m/%d %I:%M:%S %p&#x27;</span><br>)<br></code></pre></td></tr></table></figure><blockquote><p>说明 配置asctime输出时间，可以用datefmt额外指定格式</p></blockquote><p>示例2（多个输出源）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">logger = logging.getLogger()  <span class="hljs-comment"># 不加名称设置root logger</span><br>logger.setLevel(logging.INFO)<br>formatter = logging.Formatter(<br>    fmt=<span class="hljs-string">&#x27;%(asctime)s : %(levelname)s : %(message)s&#x27;</span>,<br>    datefmt=<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span><br>)<br>BASE_DIR = os.path.abspath(os.path.join(os.path.join(__file__, os.pardir), os.pardir))<br><br><span class="hljs-comment"># 使用FileHandler输出到文件</span><br>fh = logging.FileHandler(os.path.join(BASE_DIR, <span class="hljs-string">&#x27;data-sync-service.log&#x27;</span>))<br>fh.setLevel(logging.INFO)<br>fh.setFormatter(formatter)<br><br><span class="hljs-comment"># 使用StreamHandler输出到屏幕</span><br>sh = logging.StreamHandler()<br>sh.setLevel(logging.INFO)<br>sh.setFormatter(formatter)<br><br><span class="hljs-comment"># 添加两个Handler</span><br>logger.addHandler(fh)<br>logger.addHandler(sh)<br></code></pre></td></tr></table></figure><p>Formatter 对象用来设置具体的输出格式，常用变量格式如下表所示。</p><p><img src="https://stellae.gitee.io/myblog/images/images/logging_format.png"></p><h3 id="输出日志"><a href="#输出日志" class="headerlink" title="输出日志"></a>输出日志</h3><ul><li>logging.debug(‘This is a debug message’) </li><li>logging.info(‘This is an info message’) </li><li>logging.warning(‘This is a warning message’) </li><li>logging.error(‘This is an error message’) </li><li>logging.critical(‘This is a critical message’)</li></ul><p><strong>需要记录错误详细信息可以使用以下方法：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>    b = a / <span class="hljs-number">0</span><br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    logging.exception(<span class="hljs-string">&quot;Exception occurred&quot;</span>)    <span class="hljs-comment"># 推荐</span><br>    logging.error(<span class="hljs-string">&quot;Exception occurred&quot;</span>, exc_info=<span class="hljs-literal">True</span>)<br>    logging.log(level=logging.DEBUG, msg=<span class="hljs-string">&quot;Exception occurred&quot;</span>, exc_info=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>日志</category>
      
    </categories>
    
    
    <tags>
      
      <tag>log</tag>
      
      <tag>logging</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pillow图片处理</title>
    <link href="/Myblog/2019/10/09/Pillow%E5%9B%BE%E7%89%87%E5%A4%84%E7%90%86/"/>
    <url>/Myblog/2019/10/09/Pillow%E5%9B%BE%E7%89%87%E5%A4%84%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h2 id="Pillow简介"><a href="#Pillow简介" class="headerlink" title="Pillow简介"></a>Pillow简介</h2><p>PIL：Python Imaging Library，已经是Python平台事实上的图像处理标准库了。PIL功能非常强大，但API却非常简单易用。</p><p>由于PIL仅支持到Python 2.7，加上年久失修，于是一群志愿者在PIL的基础上创建了兼容的版本，名字叫<a href="https://github.com/python-pillow/Pillow">Pillow</a>，支持最新Python 3.x，又加入了许多新特性，因此，我们可以直接安装使用Pillow。</p><h2 id="Pillow安装"><a href="#Pillow安装" class="headerlink" title="Pillow安装"></a>Pillow安装</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install pillow<br></code></pre></td></tr></table></figure><h2 id="Pillow实际使用场景"><a href="#Pillow实际使用场景" class="headerlink" title="Pillow实际使用场景"></a>Pillow实际使用场景</h2><h3 id="图片模糊-轮廓"><a href="#图片模糊-轮廓" class="headerlink" title="图片模糊/轮廓"></a>图片模糊/轮廓</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageFilter<br><br>im = Image.open(<span class="hljs-string">&#x27;test.jpg&#x27;</span>)<br>im2 = im.filter(ImageFilter.BLUR)         <span class="hljs-comment"># 应用模糊滤镜</span><br><span class="hljs-comment"># im2 = im.filter(ImageFilter.CONTOUR)    # 应用轮廓滤镜</span><br>im2.save(<span class="hljs-string">&#x27;blur.jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="图片锐度"><a href="#图片锐度" class="headerlink" title="图片锐度"></a>图片锐度</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> ImageEnhance<br><br>enhancer = ImageEnhance.Sharpness(im)<br>enhancer.enhance(<span class="hljs-number">40</span>).show()   <span class="hljs-comment"># 数值越大锐度越高</span><br></code></pre></td></tr></table></figure><h3 id="图片旋转"><a href="#图片旋转" class="headerlink" title="图片旋转"></a>图片旋转</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">im_rotate = im.rotate(<span class="hljs-number">90</span>)   <span class="hljs-comment"># 逆时针旋转90度</span><br>im_rotate.show()<br></code></pre></td></tr></table></figure><h3 id="图片验证码"><a href="#图片验证码" class="headerlink" title="图片验证码"></a>图片验证码</h3><h4 id="1-示例1-简单"><a href="#1-示例1-简单" class="headerlink" title="1. 示例1 (简单)"></a>1. 示例1 (简单)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageDraw, ImageFont, ImageFilter<br><br><span class="hljs-keyword">import</span> random<br><br><br><span class="hljs-comment"># 随机字母:</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">random_char</span>():</span><br>    <span class="hljs-keyword">return</span> chr(random.randint(<span class="hljs-number">65</span>, <span class="hljs-number">90</span>))<br><br><br><span class="hljs-comment"># 随机颜色1:</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">random_color</span>():</span><br>    <span class="hljs-keyword">return</span> random.randint(<span class="hljs-number">64</span>, <span class="hljs-number">255</span>), random.randint(<span class="hljs-number">64</span>, <span class="hljs-number">255</span>), random.randint(<span class="hljs-number">64</span>, <span class="hljs-number">255</span>)<br><br><br><span class="hljs-comment"># 随机颜色2:</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">random_color2</span>():</span><br>    <span class="hljs-keyword">return</span> random.randint(<span class="hljs-number">32</span>, <span class="hljs-number">127</span>), random.randint(<span class="hljs-number">32</span>, <span class="hljs-number">127</span>), random.randint(<span class="hljs-number">32</span>, <span class="hljs-number">127</span>)<br><br><br><span class="hljs-comment"># 240 x 60:</span><br>width = <span class="hljs-number">60</span> * <span class="hljs-number">4</span><br>height = <span class="hljs-number">60</span><br>image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (width, height), (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))<br><span class="hljs-comment"># 创建Font对象:</span><br>font = ImageFont.truetype(<span class="hljs-string">&#x27;/Users/stellae/Downloads/ttf/consola.ttf&#x27;</span>, <span class="hljs-number">36</span>)<br><span class="hljs-comment"># 创建Draw对象:</span><br>draw = ImageDraw.Draw(image)<br><span class="hljs-comment"># 填充每个像素:</span><br><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(width):<br>    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> range(height):<br>        draw.point((x, y), fill=random_color())<br><span class="hljs-comment"># 输出文字:</span><br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>):<br>    draw.text((<span class="hljs-number">60</span> * t + <span class="hljs-number">10</span>, <span class="hljs-number">10</span>), random_char(), font=font, fill=random_color2())<br><span class="hljs-comment"># 模糊:</span><br>image = image.filter(ImageFilter.BLUR)<br>image.save(<span class="hljs-string">&#x27;./code.jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="2-示例2-推荐"><a href="#2-示例2-推荐" class="headerlink" title="2. 示例2 (推荐)"></a>2. 示例2 (推荐)</h4><p>需要用到字体文件<code>&#39;Arial.ttf&#39;, &#39;Georgia.ttf&#39;, &#39;actionj.ttf&#39;</code>，存放在<code>/&lt;项目&gt;/static/fonts/</code>目录下。</p><p>captcha.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">图片验证码</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> ImageFilter<br><span class="hljs-keyword">from</span> PIL.ImageDraw <span class="hljs-keyword">import</span> Draw<br><span class="hljs-keyword">from</span> PIL.ImageFont <span class="hljs-keyword">import</span> truetype<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bezier</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;贝塞尔曲线&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.tsequence = tuple([t / <span class="hljs-number">20.0</span> <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> range(<span class="hljs-number">21</span>)])<br>        self.beziers = &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_bezier</span>(<span class="hljs-params">self, n</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制贝塞尔曲线&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">return</span> self.beziers[n]<br>        <span class="hljs-keyword">except</span> KeyError:<br>            combinations = pascal_row(n - <span class="hljs-number">1</span>)<br>            result = []<br>            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> self.tsequence:<br>                tpowers = (t ** i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n))<br>                upowers = ((<span class="hljs-number">1</span> - t) ** i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n - <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>))<br>                coefs = [c * a * b <span class="hljs-keyword">for</span> c, a, b <span class="hljs-keyword">in</span> zip(combinations,<br>                                                      tpowers, upowers)]<br>                result.append(coefs)<br>            self.beziers[n] = result<br>            <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Captcha</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;验证码&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, width, height, fonts=None, color=None</span>):</span><br>        self._image = <span class="hljs-literal">None</span><br>        self._fonts = fonts <span class="hljs-keyword">if</span> fonts <span class="hljs-keyword">else</span> \<br>            [os.path.join(os.path.join(os.path.dirname(os.path.dirname(__file__)), <span class="hljs-string">&#x27;static&#x27;</span>), <span class="hljs-string">&#x27;fonts&#x27;</span>, font)<br>             <span class="hljs-keyword">for</span> font <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;Arial.ttf&#x27;</span>, <span class="hljs-string">&#x27;Georgia.ttf&#x27;</span>, <span class="hljs-string">&#x27;actionj.ttf&#x27;</span>]]<br>        self._color = color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> random_color(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>, random.randint(<span class="hljs-number">220</span>, <span class="hljs-number">255</span>))<br>        self._width, self._height = width, height<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">instance</span>(<span class="hljs-params">cls, width=<span class="hljs-number">200</span>, height=<span class="hljs-number">75</span></span>):</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hasattr(Captcha, <span class="hljs-string">&quot;_instance&quot;</span>):<br>            cls._instance = cls(width, height)<br>        <span class="hljs-keyword">return</span> cls._instance<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">background</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制背景&quot;&quot;&quot;</span><br>        Draw(self._image).rectangle([(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), self._image.size],<br>                                    fill=random_color(<span class="hljs-number">230</span>, <span class="hljs-number">255</span>))<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">smooth</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;平滑图像&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> self._image.filter(ImageFilter.SMOOTH)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">curve</span>(<span class="hljs-params">self, width=<span class="hljs-number">4</span>, number=<span class="hljs-number">6</span>, color=None</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制曲线&quot;&quot;&quot;</span><br>        dx, height = self._image.size<br>        dx /= number<br>        path = [(dx * i, random.randint(<span class="hljs-number">0</span>, height))<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, number)]<br>        bcoefs = Bezier().make_bezier(number - <span class="hljs-number">1</span>)<br>        points = []<br>        <span class="hljs-keyword">for</span> coefs <span class="hljs-keyword">in</span> bcoefs:<br>            points.append(tuple(sum([coef * p <span class="hljs-keyword">for</span> coef, p <span class="hljs-keyword">in</span> zip(coefs, ps)])<br>                                <span class="hljs-keyword">for</span> ps <span class="hljs-keyword">in</span> zip(*path)))<br>        Draw(self._image).line(points, fill=color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> self._color, width=width)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">noise</span>(<span class="hljs-params">self, number=<span class="hljs-number">50</span>, level=<span class="hljs-number">2</span>, color=None</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制扰码&quot;&quot;&quot;</span><br>        width, height = self._image.size<br>        dx, dy = width / <span class="hljs-number">10</span>, height / <span class="hljs-number">10</span><br>        width, height = width - dx, height - dy<br>        draw = Draw(self._image)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(number):<br>            x = int(random.uniform(dx, width))<br>            y = int(random.uniform(dy, height))<br>            draw.line(((x, y), (x + level, y)),<br>                      fill=color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> self._color, width=level)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">text</span>(<span class="hljs-params">self, captcha_text, fonts, font_sizes=None, drawings=None, squeeze_factor=<span class="hljs-number">0.75</span>, color=None</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制文本&quot;&quot;&quot;</span><br>        color = color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> self._color<br>        fonts = tuple([truetype(name, size)<br>                       <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> fonts<br>                       <span class="hljs-keyword">for</span> size <span class="hljs-keyword">in</span> font_sizes <span class="hljs-keyword">or</span> (<span class="hljs-number">65</span>, <span class="hljs-number">70</span>, <span class="hljs-number">75</span>)])<br>        draw = Draw(self._image)<br>        char_images = []<br>        <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> captcha_text:<br>            font = random.choice(fonts)<br>            c_width, c_height = draw.textsize(c, font=font)<br>            char_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (c_width, c_height), (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br>            char_draw = Draw(char_image)<br>            char_draw.text((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), c, font=font, fill=color)<br>            char_image = char_image.crop(char_image.getbbox())<br>            <span class="hljs-keyword">for</span> drawing <span class="hljs-keyword">in</span> drawings:<br>                d = getattr(self, drawing)<br>                char_image = d(char_image)<br>            char_images.append(char_image)<br>        width, height = self._image.size<br>        offset = int((width - sum(int(i.size[<span class="hljs-number">0</span>] * squeeze_factor)<br>                                  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> char_images[:<span class="hljs-number">-1</span>]) -<br>                      char_images[<span class="hljs-number">-1</span>].size[<span class="hljs-number">0</span>]) / <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">for</span> char_image <span class="hljs-keyword">in</span> char_images:<br>            c_width, c_height = char_image.size<br>            mask = char_image.convert(<span class="hljs-string">&#x27;L&#x27;</span>).point(<span class="hljs-keyword">lambda</span> i: i * <span class="hljs-number">1.97</span>)<br>            self._image.paste(char_image,<br>                        (offset, int((height - c_height) / <span class="hljs-number">2</span>)),<br>                        mask)<br>            offset += int(c_width * squeeze_factor)<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">warp</span>(<span class="hljs-params">image, dx_factor=<span class="hljs-number">0.3</span>, dy_factor=<span class="hljs-number">0.3</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;图像扭曲&quot;&quot;&quot;</span><br>        width, height = image.size<br>        dx = width * dx_factor<br>        dy = height * dy_factor<br>        x1 = int(random.uniform(-dx, dx))<br>        y1 = int(random.uniform(-dy, dy))<br>        x2 = int(random.uniform(-dx, dx))<br>        y2 = int(random.uniform(-dy, dy))<br>        warp_image = Image.new(<br>            <span class="hljs-string">&#x27;RGB&#x27;</span>,<br>            (width + abs(x1) + abs(x2), height + abs(y1) + abs(y2)))<br>        warp_image.paste(image, (abs(x1), abs(y1)))<br>        width2, height2 = warp_image.size<br>        <span class="hljs-keyword">return</span> warp_image.transform(<br>            (width, height),<br>            Image.QUAD,<br>            (x1, y1, -x1, height2 - y2, width2 + x2, height2 + y2, width2 - x2, -y1))<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">offset</span>(<span class="hljs-params">image, dx_factor=<span class="hljs-number">0.1</span>, dy_factor=<span class="hljs-number">0.2</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;图像偏移&quot;&quot;&quot;</span><br>        width, height = image.size<br>        dx = int(random.random() * width * dx_factor)<br>        dy = int(random.random() * height * dy_factor)<br>        offset_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (width + dx, height + dy))<br>        offset_image.paste(image, (dx, dy))<br>        <span class="hljs-keyword">return</span> offset_image<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rotate</span>(<span class="hljs-params">image, angle=<span class="hljs-number">25</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;图像旋转&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> image.rotate(random.uniform(-angle, angle),<br>                            Image.BILINEAR, expand=<span class="hljs-number">1</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate</span>(<span class="hljs-params">self, captcha_text=<span class="hljs-string">&#x27;&#x27;</span>, fmt=<span class="hljs-string">&#x27;PNG&#x27;</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;生成验证码(文字和图片)&quot;&quot;&quot;</span><br>        self._image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (self._width, self._height), (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))<br>        self.background()<br>        self.text(captcha_text, self._fonts,<br>                  drawings=[<span class="hljs-string">&#x27;warp&#x27;</span>, <span class="hljs-string">&#x27;rotate&#x27;</span>, <span class="hljs-string">&#x27;offset&#x27;</span>])<br>        self.curve()<br>        self.noise()<br>        self.smooth()<br>        image_bytes = BytesIO()<br>        self._image.save(image_bytes, format=fmt)<br>        <span class="hljs-keyword">return</span> image_bytes.getvalue()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pascal_row</span>(<span class="hljs-params">n=<span class="hljs-number">0</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成Pascal三角第n行&quot;&quot;&quot;</span><br>    result = [<span class="hljs-number">1</span>]<br>    x, numerator = <span class="hljs-number">1</span>, n<br>    <span class="hljs-keyword">for</span> denominator <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, n // <span class="hljs-number">2</span> + <span class="hljs-number">1</span>):<br>        x *= numerator<br>        x /= denominator<br>        result.append(x)<br>        numerator -= <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> n &amp; <span class="hljs-number">1</span> == <span class="hljs-number">0</span>:<br>        result.extend(reversed(result[:<span class="hljs-number">-1</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        result.extend(reversed(result))<br>    <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">random_color</span>(<span class="hljs-params">start=<span class="hljs-number">0</span>, end=<span class="hljs-number">255</span>, opacity=<span class="hljs-number">255</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;获得随机颜色&quot;&quot;&quot;</span><br>    red = random.randint(start, end)<br>    green = random.randint(start, end)<br>    blue = random.randint(start, end)<br>    <span class="hljs-keyword">if</span> opacity <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> red, green, blue<br>    <span class="hljs-keyword">return</span> red, green, blue, opacity<br></code></pre></td></tr></table></figure><p>utils.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">工具函数</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><br><br>ALL_CHARS = <span class="hljs-string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_captcha_text</span>(<span class="hljs-params">length=<span class="hljs-number">4</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定长度的图片验证码文字&quot;&quot;&quot;</span><br>    code = StringIO()<br>    chars_len = len(ALL_CHARS)<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(length):<br>        index = random.randrange(chars_len)<br>        code.write(ALL_CHARS[index])<br>    <span class="hljs-keyword">return</span> code.getvalue()<br></code></pre></td></tr></table></figure><p>使用方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">from</span> common.captcha <span class="hljs-keyword">import</span> Captcha<br><span class="hljs-keyword">from</span> common.utils <span class="hljs-keyword">import</span> gen_captcha_text<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">captcha</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成验证码&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 随机验证码内容, 可以指定长度</span><br>    code_text = gen_captcha_text()<br>    <span class="hljs-comment"># 将验证码放入session缓存中</span><br>    request.session[<span class="hljs-string">&#x27;code_text&#x27;</span>] = code_text<br>    <span class="hljs-comment"># instance()指定验证码宽高； generate(code_text)生成验证码,返回图片二进制数据</span><br>    code_bytes = Captcha.instance().generate(code_text)<br>    <span class="hljs-keyword">return</span> HttpResponse(code_bytes, content_type=<span class="hljs-string">&#x27;image/png&#x27;</span>)<br></code></pre></td></tr></table></figure><p>想要在页面上直接显示出图片，可以将二进制图片利用base64编码成字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 修改以上代码</span><br>code_bytes = Captcha.instance().generate(code_text)<br>code_base64_str = base64.b64encode(code_bytes).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>:<span class="hljs-number">200</span>, <span class="hljs-string">&#x27;pic&#x27;</span>:code_base64_str&#125;)<br></code></pre></td></tr></table></figure><p>在src前添加data:image/jpeg;base64,+已经encode的二进制代码，就可以在网页端显示出图片</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;captcha_pic&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;data:image/gif;base64,R0lGODlhDwAPAKECAAAAzMzM/////wAAACwAAAAADwAPAAACIISPeQHsrZ5ModrLlN48CXF8m2iQ3YmmKqVlRtW4MLwWACH+H09wdGltaXplZCBieSBVbGVhZCBTbWFydFNhdmVyIQAAOw==&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;150&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;150&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h3 id="图片绘制-文字-水印"><a href="#图片绘制-文字-水印" class="headerlink" title="图片绘制(文字/水印)"></a>图片绘制(文字/水印)</h3><h4 id="1-添加文字"><a href="#1-添加文字" class="headerlink" title="1. 添加文字"></a>1. 添加文字</h4><p>将QQ 头像（或者微博头像）右上角加上红色的数字，类似于微信未读信息数量那种提示效果。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageDraw, ImageFont<br><br><br>path = <span class="hljs-string">&#x27;/Users/stellae/Downloads/temp/Wechat_portrait.jpeg&#x27;</span><br>path_save = <span class="hljs-string">&#x27;/Users/stellae/Downloads/temp/Wechat_portrait_draw.png&#x27;</span><br>ttf_path = <span class="hljs-string">&#x27;/Users/stellae/Downloads/ttf/consola.ttf&#x27;</span><br>color = <span class="hljs-string">&quot;#DE7860&quot;</span>   <span class="hljs-comment"># 红色（十六进制颜色码）</span><br><span class="hljs-comment"># color = (255,0,0)   # 也可以使用RGB颜色值</span><br>font = ImageFont.truetype(font=ttf_path, size=<span class="hljs-number">100</span>)   <span class="hljs-comment"># 字体设置</span><br>draw_number = <span class="hljs-string">&#x27;6%&#x27;</span>   <span class="hljs-comment"># 内容</span><br>image = Image.open(path)<br>draw = ImageDraw.Draw(image)<br>width, height = image.size<br>draw.text((width * <span class="hljs-number">0.8</span>, height * <span class="hljs-number">0.05</span>), <span class="hljs-string">u&#x27;%s&#x27;</span> % draw_number, fill=color, font=font)  <span class="hljs-comment"># 绘制</span><br>image.save(path_save, <span class="hljs-string">&#x27;png&#x27;</span>)<br></code></pre></td></tr></table></figure><blockquote><p>这里的这个u表示将后面跟的字符串以unicode格式存储；</p><blockquote><blockquote><p>RGB颜色值与十六进制颜色值转换<a href="https://www.sioe.cn/yingyong/yanse-rgb-16/">工具</a>；</p></blockquote></blockquote></blockquote><h4 id="2-添加水印"><a href="#2-添加水印" class="headerlink" title="2. 添加水印"></a>2. 添加水印</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_watermark_to_image</span>(<span class="hljs-params">image, watermark</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;添加水印&quot;&quot;&quot;</span><br>    rgba_image = image.convert(<span class="hljs-string">&#x27;RGBA&#x27;</span>)    <span class="hljs-comment"># 转换图像模式为RGBA</span><br>    rgba_watermark = watermark.convert(<span class="hljs-string">&#x27;RGBA&#x27;</span>)<br><br>    image_x, image_y = rgba_image.size<br>    watermark_x, watermark_y = rgba_watermark.size<br><br>    <span class="hljs-comment"># 缩放图片</span><br>    scale = <span class="hljs-number">10</span><br>    watermark_scale = max(image_x / (scale * watermark_x), image_y / (scale * watermark_y))<br>    new_size = (int(watermark_x * watermark_scale), int(watermark_y * watermark_scale))<br>    rgba_watermark = rgba_watermark.resize(new_size, resample=Image.ANTIALIAS)<br>    <span class="hljs-comment"># 透明度</span><br>    rgba_watermark_mask = rgba_watermark.convert(<span class="hljs-string">&quot;L&quot;</span>).point(lut=<span class="hljs-keyword">lambda</span> x: min(x, <span class="hljs-number">180</span>))<br>    rgba_watermark.putalpha(rgba_watermark_mask)<br><br>    watermark_x, watermark_y = rgba_watermark.size<br>    <span class="hljs-comment"># 水印位置</span><br>    rgba_image.paste(rgba_watermark, box=(image_x - watermark_x, image_y - watermark_y), mask=rgba_watermark_mask)<br><br>    <span class="hljs-keyword">return</span> rgba_image<br><br><br>file_path = <span class="hljs-string">&#x27;/Users/stellae/Downloads/temp/Wechat_portrait.jpeg&#x27;</span>    <span class="hljs-comment"># 原图片</span><br>watermark_path = <span class="hljs-string">&#x27;/Users/stellae/Downloads/temp/EX101.jpg&#x27;</span>          <span class="hljs-comment"># 水印图片</span><br><br>im_before = Image.open(file_path)<br><span class="hljs-comment"># im_before.show()</span><br><br>im_watermark = Image.open(watermark_path)<br>im_after = add_watermark_to_image(im_before, im_watermark)<br>im_after.show()<br><br></code></pre></td></tr></table></figure><blockquote><p><strong>方法说明：</strong><br><strong>Image.convert(mode = None，matrix = None，dither = None，调色板= 0，<em>colors = 256</em>)方法用于转换Image模式，PIL中有九种不同模式，分别为1、L、P、RGB、RGBA、CMYK、YCbCr、I、F</strong></p><blockquote><blockquote><ul><li><p>1：1位像素，表示黑和白，但是存储的时候每个像素存储为8bit。</p></li><li><p>L：8位像素，表示黑和白。</p></li><li><p>P：8位像素，使用调色板映射到其他模式。</p></li><li><p>RGB：3x8位像素，为真彩色。</p></li><li><p>RGBA：4x8位像素，有透明通道的真彩色。</p></li><li><p>CMYK：4x8位像素，颜色分离。</p></li><li><p>YCbCr：3x8位像素，彩色视频格式。</p></li><li><p>I：32位整型像素。</p></li><li><p>F：32位浮点型像素。</p></li></ul></blockquote></blockquote><p><strong>Image.point(lut, mode=None)方法通过查找表或函数映射此图像</strong></p><blockquote><blockquote><ul><li><strong>lut</strong> –查找表，在图像中每个波段包含256个值（如果self.mode ==“ I”且mode ==“ L”，则为65536）。可以改用函数，它应使用单个参数。对每个可能的像素值调用一次该函数，并将结果表应用于图像的所有波段。</li><li><strong>模式</strong> –输出模式（默认与输入相同）。在当前版本中，仅当源图像的模式为“ L”或“ P”并且输出的模式为“ 1”或源图像的模式为“ I”且输出模式为“ L”时，才可以使用此功能</li></ul></blockquote></blockquote><p><strong>Image.putalpha(alpha)方法在此图像中添加或替换alpha层。如果图像没有Alpha图层，则将其转换为“ LA”或“ RGBA”。新层必须为“ L”或“ 1”。</strong></p><blockquote><blockquote><ul><li>alpha –新的alpha层。这可以是具有与该图像相同大小的“ L”或“ 1”图像，也可以是整数或其他颜色值。</li></ul></blockquote></blockquote><p><strong>Image.paste(im, box=None, mask=None)方法将另一个图像粘贴到该图像中。</strong></p><blockquote><blockquote><ul><li>box参数可以是2元组（给出左上角），4元组（定义左，上，右和下像素坐标），也可以是None（与（0，0）相同）。请参阅<a href="https://pillow.readthedocs.io/en/stable/handbook/concepts.html#coordinate-system">坐标系</a>。如果指定了4元组，则粘贴图像的大小必须与区域的大小匹配。</li><li>如果模式不匹配，则粘贴的图像将转换为该图像的模式（<a href="https://pillow.readthedocs.io/en/stable/reference/Image.html#PIL.Image.Image.convert"><code>convert()</code></a>有关详细信息，请参见方法）。</li><li>源可以是包含像素值的整数或元组，而不是图像。然后，该方法用给定的颜色填充区域。创建RGB图像时，还可以使用ImageColor模块支持的颜色字符串。</li><li>如果指定了遮罩，则此方法仅更新遮罩指示的区域。您可以使用“ 1”，“ L”或“ RGBA”图像（在后一种情况下，alpha波段用作遮罩）。遮罩为255时，将按原样复制给定图像。掩码为0时，将保留当前值。中间值会将两个图像混合在一起，包括它们的Alpha通道（如果有的话）。</li></ul></blockquote></blockquote></blockquote><h3 id="图片缩放-压缩"><a href="#图片缩放-压缩" class="headerlink" title="图片缩放(压缩)"></a>图片缩放(压缩)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># thumbnail.py</span><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Pool<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">thumbnail</span>(<span class="hljs-params">image_details</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定尺寸缩略图&quot;&quot;&quot;</span><br>    size, path = image_details<br>    image = Image.open(path)<br>    image.thumbnail(size)<br>    file_prefix, file_extension = os.path.splitext(path)  <span class="hljs-comment"># 分割文件前后缀</span><br>    save_path = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;file_prefix&#125;</span>_<span class="hljs-subst">&#123;size[<span class="hljs-number">0</span>]&#125;</span>_<span class="hljs-subst">&#123;size[<span class="hljs-number">1</span>]&#125;</span><span class="hljs-subst">&#123;file_extension&#125;</span>&#x27;</span><br>    image.save(save_path)<br>    <span class="hljs-keyword">return</span> save_path<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_thumbnail</span>(<span class="hljs-params">file_path</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成大小两个尺寸的缩略图&quot;&quot;&quot;</span><br>    sizes = [(<span class="hljs-number">1024</span>, <span class="hljs-number">656</span>), (<span class="hljs-number">600</span>, <span class="hljs-number">384</span>)]<br>    file_path = [file_path] * <span class="hljs-number">2</span><br>    <span class="hljs-comment"># 创建拥有2个进程数量的进程池</span><br>    pool = Pool(<span class="hljs-number">2</span>)<br>    results = pool.map(thumbnail, zip(sizes, file_path))<br>    pool.close()   <span class="hljs-comment"># 确保不会有新的进程加入pool</span><br>    pool.join()<br>    <span class="hljs-keyword">return</span> results<br><br></code></pre></td></tr></table></figure><p>如果要等比缩放，并且空缺地方填白。参考以下代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># thumbnail.py</span><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Pool<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">thumbnail</span>(<span class="hljs-params">image_details</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定尺寸缩略图,并将空缺部分填白&quot;&quot;&quot;</span><br>    size, path = image_details<br>    image = Image.open(path)<br>    aspect_width, aspect_height = size<br>    source_width, source_height = image.size<br>    <span class="hljs-comment"># 判断宽高比</span><br>    <span class="hljs-keyword">if</span> (source_width / source_height) &gt; (aspect_width / aspect_height):<br>        rate = aspect_width / source_width<br>    <span class="hljs-keyword">else</span>:<br>        rate = aspect_height / source_height<br>    rate = round(rate, <span class="hljs-number">1</span>)<br>    image = image.resize((int(source_width * rate), int(source_height * rate)), Image.ANTIALIAS)<br>    <span class="hljs-comment"># 填白</span><br>    result_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, [aspect_width, aspect_height], (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))<br>    result_image.paste(image, (int((aspect_width - image.size[<span class="hljs-number">0</span>]) / <span class="hljs-number">2</span>), int((aspect_height - image.size[<span class="hljs-number">1</span>]) / <span class="hljs-number">2</span>)))<br>    file_prefix, file_extension = os.path.splitext(path)  <span class="hljs-comment"># 分割文件前后缀</span><br>    save_path = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;file_prefix&#125;</span>_<span class="hljs-subst">&#123;image.size[<span class="hljs-number">0</span>]&#125;</span>_<span class="hljs-subst">&#123;image.size[<span class="hljs-number">1</span>]&#125;</span><span class="hljs-subst">&#123;file_extension&#125;</span>&#x27;</span><br>    result_image.save(save_path)<br>    <span class="hljs-keyword">return</span> save_path<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_thumbnail</span>(<span class="hljs-params">file_path</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成大小两个尺寸的缩略图&quot;&quot;&quot;</span><br>    sizes = [(<span class="hljs-number">1013</span>, <span class="hljs-number">650</span>), (<span class="hljs-number">600</span>, <span class="hljs-number">385</span>)]<br>    file_path = [file_path] * <span class="hljs-number">2</span><br>    <span class="hljs-comment"># 创建拥有2个进程数量的进程池</span><br>    pool = Pool(<span class="hljs-number">2</span>)<br>    results = pool.map(thumbnail, zip(sizes, file_path))<br>    pool.close()   <span class="hljs-comment"># 确保不会有新的进程加入pool</span><br>    pool.join()<br>    <span class="hljs-keyword">return</span> results<br></code></pre></td></tr></table></figure><blockquote><p>resize()方法可以缩小也可以放大，而thumbnail()方法只能缩小；</p><p>resize()方法不会改变对象的大小，只会返回一个新的Image对象，而thumbnail()方法会直接改变对象的大小，返回值为None；</p><p>resize()方法中的size参数直接规定了修改后的大小，而thumbnail()方法按比例缩小，size参数只规定修改后size的最大值。</p></blockquote><ul><li><p><strong>resize方法可以指定使用抗锯齿模式缩放图片：添加参数Image.ANTIALIAS</strong>。</p></li><li><p><strong>save方法可以指定存储图片质量：添加参数quality=&lt;0-100&gt; ，quality越大，质量越高</strong>。</p></li></ul><p>更多用法请查看 <a href="https://pillow.readthedocs.io/en/stable/reference/Image.html">Pillow方法详解</a></p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pillow</tag>
      
      <tag>验证码</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Marshmallow序列化与反序列化</title>
    <link href="/Myblog/2019/09/12/Marshmallow%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/Myblog/2019/09/12/Marshmallow%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h3 id="Marshmallow介绍"><a href="#Marshmallow介绍" class="headerlink" title="Marshmallow介绍"></a>Marshmallow介绍</h3><p>Marshmallow是一个用来将复杂的orm对象与python原生数据类型之间相互转换的库，简而言之，就是实现序列化和反序列化的第三方库。</p><p>同时，它对于数据的校检非常友好，有多种校检方式，同时相对于Schema库，它可以更有针对性的校检数据，序列化数据等（例如只取某些数据，只校检某些数据等）。</p><h3 id="自定义Schema类"><a href="#自定义Schema类" class="headerlink" title="自定义Schema类"></a>自定义Schema类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> marshmallow <span class="hljs-keyword">import</span> Schema, fields, validates, validates_schema, ValidationError, post_load, pre_load<br><span class="hljs-keyword">from</span> marshmallow.validate <span class="hljs-keyword">import</span> Length, OneOf<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserSchema</span>(<span class="hljs-params">Schema</span>):</span><br>    name = fields.Str()<br>    email = fields.Email()<br>    created_at = fields.DateTime()<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResumeSchema</span>(<span class="hljs-params">Schema</span>):</span><br>    id = fields.Integer(dump_only=<span class="hljs-literal">True</span>)<br>    logo = fields.String(required=<span class="hljs-literal">True</span>)<br>    dispatches = fields.String(required=<span class="hljs-literal">True</span>)<br>    name = fields.String(required=<span class="hljs-literal">True</span>, error_messages=&#123;<span class="hljs-string">&quot;required&quot;</span>: <span class="hljs-string">&quot;请填写公司名称&quot;</span>, <span class="hljs-string">&quot;invalid&quot;</span>: <span class="hljs-string">&quot;公司名称格式错误&quot;</span>&#125;)<br>    start_date = fields.Date(required=<span class="hljs-literal">True</span>, error_messages=&#123;<span class="hljs-string">&quot;required&quot;</span>: <span class="hljs-string">&quot;请填写任职开始时间&quot;</span>,<br>                                                            <span class="hljs-string">&quot;invalid&quot;</span>: <span class="hljs-string">&quot;任职开始时间格式错误&quot;</span>&#125;)<br><br>    <span class="hljs-comment"># 单个字段检验</span><br><span class="hljs-meta">    @validates(&#x27;id&#x27;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_id</span>(<span class="hljs-params">self, id</span>):</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-number">1</span> &lt;= id &lt;= <span class="hljs-number">10</span>:<br>        <span class="hljs-keyword">raise</span> ValidationError(<span class="hljs-string">&quot;xxxxx&quot;</span>)<br>       <br>    <span class="hljs-comment"># 拿到所有字段</span><br><span class="hljs-meta">    @validates_schema(skip_on_field_errors=True)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_quality</span>(<span class="hljs-params">self, info, **kwargs</span>):</span><br>        <span class="hljs-keyword">pass</span><br>    <br>    <span class="hljs-comment"># 修改load字段值(pre_load和post_load区别是字段校验前后进行操作)</span><br><span class="hljs-meta">    @post_load</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">slugify_dispatches</span>(<span class="hljs-params">self, in_data, **kwargs</span>):</span><br>        <span class="hljs-keyword">try</span>:<br>            in_data[<span class="hljs-string">&quot;dispatches&quot;</span>] = list(map(int, in_data[<span class="hljs-string">&quot;dispatches&quot;</span>].split(<span class="hljs-string">&quot;,&quot;</span>)))<br>        <span class="hljs-keyword">except</span> Exception:<br>            <span class="hljs-keyword">raise</span> ValidationError(<span class="hljs-string">&quot;dispatches传入格式为1,2,3...&quot;</span>)<br>        <span class="hljs-keyword">return</span> in_data<br></code></pre></td></tr></table></figure><blockquote><p>validates装饰器传入字段名称，单独校验字段</p><p>Length：使用validate=Length(1,5) ； Oneof：使用validate=Oneof((‘张三’, ‘李四’))</p></blockquote><p>fields参数说明：**</p><ul><li><p>required - 必填</p><p>当<code>Schema.load()</code>的输入缺少某个字段时错误会记录下来。如果需要定制<code>required fields</code>的错误信息，可以传入一个<code>error_messages</code>参数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">data, errors = ResumeSchema().load(&#123;<span class="hljs-string">&#x27;id&#x27;</span>: <span class="hljs-number">1</span>&#125;)<br>errors<br><span class="hljs-comment"># &#123;&#x27;logo&#x27;: [&#x27;Missing data for required field.&#x27;],</span><br><span class="hljs-comment"># &#x27;name&#x27;: [&#x27;请填写公司名称&#x27;],</span><br><span class="hljs-comment">#  &#x27;start_date&#x27;: [&#x27;请填写任职开始时间&#x27;]&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>说明<code>invalid</code>参数指格式错误返回信息。</p></blockquote></li><li><p>validate - 定制验证逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">age = fields.Number(validate=<span class="hljs-keyword">lambda</span> n: <span class="hljs-number">18</span> &lt;= n &lt;= <span class="hljs-number">40</span>)<br></code></pre></td></tr></table></figure><blockquote><p>需要定制<code>validate</code>错误信息，需要在<code>error_messages</code>中填入<code>validator_failed</code>参数</p></blockquote></li><li><p>load_from - 定义从特定字典Key取值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserSchema</span>(<span class="hljs-params">Schema</span>):</span><br>    email = fields.Email(load_from=<span class="hljs-string">&#x27;emailAddress&#x27;</span>)<br>   <br><span class="hljs-keyword">try</span>:<br>    result = UserSchema().load(&#123;<span class="hljs-string">&#x27;emailAddress&#x27;</span>: <span class="hljs-string">&#x27;foo@bar.com&#x27;</span>&#125;)<br><span class="hljs-keyword">except</span> ValidationError <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-keyword">return</span> render_response(e.messages.popitem()[<span class="hljs-number">-1</span>][<span class="hljs-number">-1</span>], <span class="hljs-number">403</span>)<br><span class="hljs-comment">#&#123;&#x27;email&#x27;: &#x27;foo@bar.com&#x27;&#125; </span><br></code></pre></td></tr></table></figure></li><li><p>dump_to - 定义编列成对应的Key(和load_from相反)</p></li><li><p>attribute - 定义fields从什么属性名取值</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">class UserSchema(Schema):<br>    email_addr = fields.String(<span class="hljs-attribute">attribute</span>=<span class="hljs-string">&quot;email&quot;</span>)<br>    <br>user = User(<span class="hljs-string">&#x27;Keith&#x27;</span>, <span class="hljs-attribute">email</span>=<span class="hljs-string">&#x27;keith@stones.com&#x27;</span>)<br>result, errors = UserSchema().dump(user)<br>pprint(result)<br><span class="hljs-comment"># &#123;&#x27;email_addr&#x27;: &#x27;keith@stones.com&#x27;&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>dump_only / load_only - 定义只能某些字段只能dump()/load()</p></li></ul><h3 id="自定义fields"><a href="#自定义fields" class="headerlink" title="自定义fields"></a>自定义fields</h3><p>继承<code>fields.Field</code>，可以自定义字段类型，实现<code>_validate</code>和<code>_serialize</code>方法可以自定义字段校验和序列化规则</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> werkzeug.datastructures <span class="hljs-keyword">import</span> FileStorage<br><span class="hljs-keyword">from</span> marshmallow <span class="hljs-keyword">import</span> Schema, fields<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StorageFields</span>(<span class="hljs-params">fields.Field</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_validate</span>(<span class="hljs-params">self, value</span>):</span><br>        <span class="hljs-keyword">if</span> isinstance(value, FileStorage):<br>            <span class="hljs-keyword">return</span> value<br>        <span class="hljs-keyword">raise</span> ValidationError(<span class="hljs-string">&quot;请用form表单形式上传文件&quot;</span>)<br>        <br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SuperviseSchema</span>(<span class="hljs-params">Schema</span>):</span><br>    file = StorageFields(required=<span class="hljs-literal">True</span>)<br>    note = fields.String(required=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><h3 id="序列化（Dump"><a href="#序列化（Dump" class="headerlink" title="序列化（Dump)"></a>序列化（Dump)</h3><h4 id="Object-–-gt-dict"><a href="#Object-–-gt-dict" class="headerlink" title="Object –&gt; dict()"></a>Object –&gt; dict()</h4><p>序列化使用schema中的<code>dump()</code>或<code>dumps()</code>方法，其中，<code>dump()</code> 方法实现<code>obj -&gt; dict</code>，<code>dumps()</code>方法实现 <code>obj -&gt; string</code>，通常Flask与Marshmallow配合序列化时，用 <code>dump()</code>方法即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> marshmallow <span class="hljs-keyword">import</span> pprint<br><br>user = User(name=<span class="hljs-string">&quot;Monty&quot;</span>, email=<span class="hljs-string">&quot;monty@python.org&quot;</span>)<br>schema = UserSchema()<br>result = schema.dump(user)<br>pprint(result.data)<br><span class="hljs-comment"># &#123;&quot;name&quot;: &quot;Monty&quot;,</span><br><span class="hljs-comment">#  &quot;email&quot;: &quot;monty@python.org&quot;,</span><br><span class="hljs-comment">#  &quot;created_at&quot;: &quot;2014-08-17T14:54:16.049594+00:00&quot;&#125;</span><br></code></pre></td></tr></table></figure><p><strong>过滤输出：</strong>当然你不需要每次都输出对象中所有字段，可以使用<code>only</code>参数来指定你需要输出的字段，这个在实际场景中很常见。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">UserSchema(only=(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;email&#x27;</span>)).dump(user).data<br><span class="hljs-comment"># &#123;&quot;name&quot;: &quot;Monty Python&quot;, &quot;email&quot;: &quot;monty@python.org&quot;&#125;</span><br></code></pre></td></tr></table></figure><p>**反向过滤输出:**你也可以使用<code>exclude</code>字段来排除你不想输出的字段。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">UserSchema(exclude=(<span class="hljs-string">&#x27;email&#x27;</span>)).dump(user).data<br></code></pre></td></tr></table></figure><h4 id="Objects-–-gt-list-dict"><a href="#Objects-–-gt-list-dict" class="headerlink" title="Objects –&gt; list[dict()]"></a>Objects –&gt; list[dict()]</h4><p>对于objects的处理，只需在schema中增加一个参数：<code>many=True</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">user1 = User(name=<span class="hljs-string">&quot;Mick&quot;</span>, email=<span class="hljs-string">&quot;mick@stones.com&quot;</span>)<br>user2 = User(name=<span class="hljs-string">&quot;Keith&quot;</span>, email=<span class="hljs-string">&quot;keith@stones.com&quot;</span>)<br>users = [user1, user2]<br><br>schema = UserSchema()<br>result = schema.dump(users, many=<span class="hljs-literal">True</span>)<br>result.data<br><br><span class="hljs-comment"># [&#123;&#x27;name&#x27;: u&#x27;Mick&#x27;,</span><br><span class="hljs-comment">#   &#x27;email&#x27;: u&#x27;mick@stones.com&#x27;,</span><br><span class="hljs-comment">#   &#x27;created_at&#x27;: &#x27;2014-08-17T14:58:57.600623+00:00&#x27;&#125;</span><br><span class="hljs-comment">#  &#123;&#x27;name&#x27;: u&#x27;Keith&#x27;,</span><br><span class="hljs-comment">#   &#x27;email&#x27;: u&#x27;keith@stones.com&#x27;,</span><br><span class="hljs-comment">#   &#x27;created_at&#x27;: &#x27;2014-08-17T14:58:57.600623+00:00&#x27;&#125;]</span><br></code></pre></td></tr></table></figure><h4 id="Partial-Loading"><a href="#Partial-Loading" class="headerlink" title="Partial Loading"></a>Partial Loading</h4><p>按照RESTful架构风格的要求，更新数据使用HTTP方法中的<code>PUT</code>或<code>PATCH</code>方法，使用PUT方法时，需要把完整的数据全部传给服务器，使用<code>PATCH</code>方法时，只需把需要改动的部分数据传给服务器即可。因此，当使用<code>PATCH</code>方法时，由于之前设定的<code>required</code>，传入数据存在无法通过<code>Marshmallow</code> 数据校验的风险，为了避免这种情况，需要借助<code>Partial Loading</code>功能。</p><p>实现<code>Partial Loadig</code>只要在<code>schema</code>构造器中增加一个<code>partial</code>参数即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">contract_schema.load(api.payload, partial=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><h4 id="Nesting-Schemas"><a href="#Nesting-Schemas" class="headerlink" title="Nesting Schemas"></a>Nesting Schemas</h4><p><code>Nested field</code>表示外键对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, name, email</span>):</span><br>        self.name = name<br>        self.email = email<br>        self.created_at = dt.datetime.now()<br>        self.friends = []<br>        self.employer = <span class="hljs-literal">None</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Blog</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, title, author</span>):</span><br>        self.title = title<br>        self.author = author  <span class="hljs-comment"># A User object</span><br><br><span class="hljs-keyword">from</span> marshmallow <span class="hljs-keyword">import</span> Schema, fields, pprint<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserSchema</span>(<span class="hljs-params">Schema</span>):</span><br>    name = fields.String()<br>    email = fields.Email()<br>    created_at = fields.DateTime()<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlogSchema</span>(<span class="hljs-params">Schema</span>):</span><br>    title = fields.String()<br>    author = fields.Nested(UserSchema)<br>    <span class="hljs-comment"># collaborators = fields.Nested(UserSchema, many=True)</span><br>    <span class="hljs-comment"># collaborators = fields.Nested(UserSchema, many=True, only=[&quot;email&quot;])</span><br><br>    <br>user = User(name=<span class="hljs-string">&quot;Monty&quot;</span>, email=<span class="hljs-string">&quot;monty@python.org&quot;</span>)<br>blog = Blog(title=<span class="hljs-string">&quot;Something Completely Different&quot;</span>, author=user)<br>result, errors = BlogSchema().dump(blog)<br>pprint(result)<br><span class="hljs-comment"># &#123;&#x27;title&#x27;: u&#x27;Something Completely Different&#x27;,</span><br><span class="hljs-comment"># &#123;&#x27;author&#x27;: &#123;&#x27;name&#x27;: u&#x27;Monty&#x27;,</span><br><span class="hljs-comment">#             &#x27;email&#x27;: u&#x27;monty@python.org&#x27;,</span><br><span class="hljs-comment">#             &#x27;created_at&#x27;: &#x27;2014-08-17T14:58:57.600623+00:00&#x27;&#125;&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>如果field 是多个对象的集合，定义时可以使用<code>many</code>参数, 如果外键对象是自引用，则Nested里第一个参数为<code>&#39;self&#39;</code>; 如果你想指定外键对象序列化后只保留它的几个字段，可以使用<code>Only</code>参数; 如果需要选择外键对象的字段层次较多，可以使用”.”操作符来指定</p></blockquote><h4 id="Schema-validate"><a href="#Schema-validate" class="headerlink" title="Schema.validate"></a>Schema.validate</h4><p>如果你只是想用<code>Schema</code>验证数据，而不生成对象，可以使用<code>Schema.validate()</code>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">errors = UserSchema().validate(&#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;Ronnie&#x27;</span>, <span class="hljs-string">&#x27;email&#x27;</span>: <span class="hljs-string">&#x27;invalid-email&#x27;</span>&#125;)<br>errors  <span class="hljs-comment"># &#123;&#x27;email&#x27;: [&#x27;&quot;invalid-email&quot; is not a valid email address.&#x27;]&#125;</span><br></code></pre></td></tr></table></figure><h3 id="反序列化（Load）"><a href="#反序列化（Load）" class="headerlink" title="反序列化（Load）"></a>反序列化（Load）</h3><p>相对<code>dump()</code>的方法就是<code>load()</code>了，可以将字典等类型转换成应用层的数据结构，即orm对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pprint <span class="hljs-keyword">import</span> pprint<br><br>user_data = &#123;<br>    <span class="hljs-string">&#x27;created_at&#x27;</span>: <span class="hljs-string">&#x27;2014-08-11T05:26:03.869245&#x27;</span>,<br>    <span class="hljs-string">&#x27;email&#x27;</span>: <span class="hljs-string">u&#x27;ken@yahoo.com&#x27;</span>,<br>    <span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">u&#x27;Ken&#x27;</span><br>&#125;<br>result = UserSchema().load(user_data)<br>pprint(result.data)<br><span class="hljs-comment"># &#123;&#x27;name&#x27;: &#x27;Ken&#x27;,</span><br><span class="hljs-comment">#  &#x27;email&#x27;: &#x27;ken@yahoo.com&#x27;,</span><br><span class="hljs-comment">#  &#x27;created_at&#x27;: datetime.datetime(2014, 8, 11, 5, 26, 3, 869245)&#125;,</span><br></code></pre></td></tr></table></figure><p>对反序列化而言，将传入的<code>dict</code>变成<code>object</code>更加有意义。在Marshmallow中，<code>dict -&gt; object</code>的方法需要自己实现，然后在该方法前面加上一个decoration：<code>post_load</code>即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> marshmallow <span class="hljs-keyword">import</span> Schema, fields, post_load<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserSchema</span>(<span class="hljs-params">Schema</span>):</span><br>    name = fields.Str()<br>    email = fields.Email()<br>    created_at = fields.DateTime()<br><br><span class="hljs-meta">    @post_load</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_user</span>(<span class="hljs-params">self, data</span>):</span><br>        <span class="hljs-keyword">return</span> User(**data)<br>      <br>user_data = &#123;<br>    <span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;Ronnie&#x27;</span>,<br>    <span class="hljs-string">&#x27;email&#x27;</span>: <span class="hljs-string">&#x27;ronnie@stones.com&#x27;</span><br>&#125;<br>schema = UserSchema()<br>result = schema.load(user_data)<br>result.data  <span class="hljs-comment"># =&gt; &lt;User(name=&#x27;Ronnie&#x27;)&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>tips: <code>load()</code>方法时，会按照<code>make_user</code>的逻辑，返回一个<code>User</code>类对象</p></blockquote><p><a href="https://www.jianshu.com/p/594865f0681b">参考文章</a> / <a href="https://marshmallow.readthedocs.io/">marshmallow官方文档</a></p>]]></content>
    
    
    <categories>
      
      <category>Marshmallow</category>
      
    </categories>
    
    
    <tags>
      
      <tag>marshmallow</tag>
      
      <tag>序列化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pandas快速入门</title>
    <link href="/Myblog/2019/08/28/Pandas%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <url>/Myblog/2019/08/28/Pandas%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Pandas简介和使用"><a href="#Pandas简介和使用" class="headerlink" title="Pandas简介和使用"></a>Pandas简介和使用</h1><p>Pandas是基于NumPy的一个非常好用的库，正如名字一样，人见人爱。之所以如此，就在于不论是读取、处理数据，用它都非常简单。此前有一篇文章《别老扯什么Hadoop了，你的数据根本不够大》指出：只有在超过5TB数据量的规模下，Hadoop才是一个合理的技术选择。相对小一些的数据，使用Python + Pandas处理起来更加敏捷。</p><h2 id="Pandas数据读取性能"><a href="#Pandas数据读取性能" class="headerlink" title="Pandas数据读取性能"></a>Pandas数据读取性能</h2><p>Pandas提供了IO工具可以将大文件分块读取，测试了一下性能，完整加载9800万条数据也只需要263秒左右，还是相当不错了。</p><p>根据测试，对于不同数据量的数据读取时间如下：</p><table><thead><tr><th align="center"></th><th align="center">1百万条</th><th align="center">1千万条</th><th align="center">1亿条</th></tr></thead><tbody><tr><td align="center">Data</td><td align="center">1s</td><td align="center">17s</td><td align="center">263s</td></tr></tbody></table><h2 id="基本数据结构"><a href="#基本数据结构" class="headerlink" title="基本数据结构"></a>基本数据结构</h2><p>Pandas有两种自己独有的基本数据结构。应该注意的是，它固然有着两种数据结构，因为它依然是python的一个库，所以，python中有的数据类型在这里依然适用，也同样还可以使用类自己定义数据类型。只不过，Pandas里面又定义了两种数据类型：Series和DataFrame，它们让数据操作更简单了。</p><ul><li>Series</li></ul><p><code>Series</code>的字符串表现形式为：索引在左边，值在右边。由于我们没有为数据指定索引。于是会自动创建一个0到N-1（N为长度）的整数型索引。</p><ul><li>DataFrame</li></ul><p><code>DataFrame</code>是一个表格型的数据结构，它包含有一组有序的列，每列可以是不同的值类型（数值，字符串，布尔值等）。<code>DataFrame</code>既有行索引也有列索引， 它可以被看做由<code>Series</code>组成的大字典。</p><h2 id="Pandas读取文件"><a href="#Pandas读取文件" class="headerlink" title="Pandas读取文件"></a>Pandas读取文件</h2><ul><li><p><strong>read_csv</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-meta">&gt;&gt;&gt; </span>marks = pd.read_csv(<span class="hljs-string">&quot;./marks.csv&quot;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>marks<br>       name  physics  python  math  english<br><span class="hljs-number">0</span>    Google      <span class="hljs-number">100</span>     <span class="hljs-number">100</span>    <span class="hljs-number">25</span>       <span class="hljs-number">12</span><br><span class="hljs-number">1</span>  Facebook       <span class="hljs-number">45</span>      <span class="hljs-number">54</span>    <span class="hljs-number">44</span>       <span class="hljs-number">88</span><br><span class="hljs-number">2</span>   Twitter       <span class="hljs-number">54</span>      <span class="hljs-number">76</span>    <span class="hljs-number">13</span>       <span class="hljs-number">91</span><br><span class="hljs-number">3</span>     Yahoo       <span class="hljs-number">54</span>     <span class="hljs-number">452</span>    <span class="hljs-number">26</span>      <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure></li><li><p><strong>read_table</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>pd.read_table(<span class="hljs-string">&quot;./marks.csv&quot;</span>, sep=<span class="hljs-string">&quot;,&quot;</span>)<br>       name  physics  python  math  english<br><span class="hljs-number">0</span>    Google      <span class="hljs-number">100</span>     <span class="hljs-number">100</span>    <span class="hljs-number">25</span>       <span class="hljs-number">12</span><br><span class="hljs-number">1</span>  Facebook       <span class="hljs-number">45</span>      <span class="hljs-number">54</span>    <span class="hljs-number">44</span>       <span class="hljs-number">88</span><br><span class="hljs-number">2</span>   Twitter       <span class="hljs-number">54</span>      <span class="hljs-number">76</span>    <span class="hljs-number">13</span>       <span class="hljs-number">91</span><br><span class="hljs-number">3</span>     Yahoo       <span class="hljs-number">54</span>     <span class="hljs-number">452</span>    <span class="hljs-number">26</span>      <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="Pandas读写数据库"><a href="#Pandas读写数据库" class="headerlink" title="Pandas读写数据库"></a>Pandas读写数据库</h2><p>Python的pandas包对表格化的数据处理能力很强，而SQL数据库的数据就是以表格的形式储存，因此经常将sql数据库里的数据直接读取为dataframe，分析操作以后再将dataframe存到sql数据库中。而pandas中的read_sql和to_sql函数就可以很方便得从sql数据库中读写数据。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine<br><br>data_connect = <span class="hljs-string">f&#x27;mysql+pymysql://<span class="hljs-subst">&#123;USER&#125;</span>:<span class="hljs-subst">&#123;PASSWORD&#125;</span>@<span class="hljs-subst">&#123;HOST&#125;</span>:<span class="hljs-subst">&#123;PORT&#125;</span>/<span class="hljs-subst">&#123;DATABASE&#125;</span>?charset=utf8&#x27;</span> <span class="hljs-comment"># mysql</span><br><span class="hljs-comment"># data_connect = f&#x27;postgresql://&#123;USER&#125;:&#123;PASSWORD&#125;@&#123;HOST&#125;:&#123;PORT&#125;/&#123;DATABASE&#125;&#x27; # postgresql</span><br>engine = create_engine(data_connect, echo=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><h4 id="1-Pandas读取数据库"><a href="#1-Pandas读取数据库" class="headerlink" title="1. Pandas读取数据库"></a>1. Pandas读取数据库</h4><ul><li><p><strong>read_sql</strong></p><p>支持sql或表名查询</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">sql = <span class="hljs-string">&quot;SELECT * FROM user&quot;</span>   <span class="hljs-comment"># sql</span><br><span class="hljs-comment"># sql = &quot;user&quot;</span><br>df = pd.read_sql(sql=sql, con=engine)<br></code></pre></td></tr></table></figure><blockquote><p>read_sql方法参数说明</p><ul><li>sql:SQL命令字符串</li><li>con：连接sql数据库的engine，一般可以用SQLalchemy或者pymysql之类的包建立</li><li>index_col: 选择某一列作为index</li><li>coerce_float:非常有用，将数字形式的字符串直接以float型读入</li><li>parse_dates:将某一列日期型字符串转换为datetime型数据，与pd.to_datetime函数功能类似。可以直接提供需要转换的列名以默认的日期形式转换，也可以用字典的格式提供列名和转换的日期格式，比如{column_name: format string}（format string：”%Y:%m:%H:%M:%S”）。</li><li>columns:要选取的列。一般没啥用，因为在sql命令里面一般就指定要选择的列了</li><li>chunksize：如果提供了一个整数值，那么就会返回一个generator，每次输出的行数就是提供的值的大小。</li><li>params：其他的一些执行参数，没用过不太清楚。。。<br>以链接常见的mysql数据库为例：</li></ul></blockquote></li><li><p><strong>read_sql_query</strong></p><p>通过自定义SQL语句读取自定义数据到DataFrame</p><ul><li><p>read_sql_query（）中可以接受SQL语句，包括增删改查。但是DELETE语句不会返回值（但是会在数据库中执行），UPDATE，SELECT，等会返回结果.</p></li><li><p>read_sql_query与read_sql使用方法类似</p></li></ul></li><li><p><strong>read_sql_table</strong></p><p>通过表名读取整张表数据到DataFrame</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">data = pd.read_sql_table(table_name = <span class="hljs-string">&#x27;user&#x27;</span>,con = engine , parse_dates = <span class="hljs-string">&#x27;time&#x27;</span>,index_col = <span class="hljs-string">&#x27;time&#x27;</span>,columns = [<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>])<br></code></pre></td></tr></table></figure></li></ul><h4 id="2-Pandas写入数据库"><a href="#2-Pandas写入数据库" class="headerlink" title="2. Pandas写入数据库"></a>2. Pandas写入数据库</h4><ul><li><p><strong>to_sql</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">df.to_sql(name=<span class="hljs-string">&#x27;table&#x27;</span>, <br>          con=con, <br>          chunksize=<span class="hljs-number">0</span><br>          if_exists=<span class="hljs-string">&#x27;append&#x27;</span>, <br>          index=<span class="hljs-literal">False</span>,<br>          dtype=&#123;<span class="hljs-string">&#x27;col1&#x27;</span>:sqlalchemy.types.INTEGER(),<br>                 <span class="hljs-string">&#x27;col2&#x27;</span>:sqlalchemy.types.NVARCHAR(length=<span class="hljs-number">255</span>),<br>                 <span class="hljs-string">&#x27;col_time&#x27;</span>:sqlalchemy.DateTime(),<br>                 <span class="hljs-string">&#x27;col_bool&#x27;</span>:sqlalchemy.types.Boolean<br>          &#125;)<br></code></pre></td></tr></table></figure><blockquote><p>to_sql方法参数说明</p><ul><li>name: 输出的表名</li><li>con: 与read_sql中相同</li><li>chunksize: 每次写入数据条数，默认0为全部，可以根据性能调整</li><li>if_exits： 三个模式：fail，若表存在，则不输出；replace：若表存在，覆盖原来表里的数据；append：若表存在，将数据写到原表的后面。默认为fail</li><li>index：是否将df的index单独写到一列中</li><li>index_label:指定列作为df的index输出，此时index为True</li><li>chunksize： 同read_sql</li><li>dtype: 指定列的输出到数据库中的数据类型。字典形式储存：{column_name: sql_dtype}。常见的数据类型有sqlalchemy.types.INTEGER() / sqlalchemy.types.NVARCHAR() / sqlalchemy.Datetime()等，具体可以参考<a href="https://docs.sqlalchemy.org/en/13/core/type_basics.html#sql-standard-and-multiple-vendor-types">这里</a></li><li>如果不提供dtype，to_sql会自动根据df列的dtype选择默认的数据类型输出，比如字符型会以sqlalchemy.types.TEXT类型输出，相比NVARCHAR，TEXT类型的数据所占的空间更大，所以一般会指定输出为NVARCHAR；而如果df的列的类型为np.int64时，将会导致无法识别并转换成INTEGER型，需要事先转换成int类型（用map，apply函数可以方便的转换）</li></ul></blockquote></li></ul><h2 id="Pandas常用方法"><a href="#Pandas常用方法" class="headerlink" title="Pandas常用方法"></a>Pandas常用方法</h2><h4 id="1-检查数据"><a href="#1-检查数据" class="headerlink" title="1. 检查数据"></a>1. 检查数据</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">df.values：DataFrame的值<br><br>df.index / df.index.name：行索引 / 行索引名字<br><br>df.columns / df.columns.name：列索引 / 列索引名字<br><br>df.head(n)：查看DataFrame对象的前n行<br><br>df.tail(n)：查看DataFrame对象的最后n行<br><br>df.shape()：查看行数和列数 df.shape[<span class="hljs-number">0</span>]查看行数，df.shape[<span class="hljs-number">1</span>]查看列数<br><br>df.info()：查看索引、数据类型和内存信息<br><br>df.describe()：查看数值型列的汇总统计<br><br>s.value_counts(dropna=<span class="hljs-literal">False</span>)：查看Series对象的唯一值和计数<br><br>df.apply(pd.Series.value_counts)：查看DataFrame对象中每一列的唯一值和计数<br></code></pre></td></tr></table></figure><h4 id="2-数据选取"><a href="#2-数据选取" class="headerlink" title="2. 数据选取"></a>2. 数据选取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">df[col] / df.col：根据列名，并以Series的形式返回列<br><br>df[[col1, col2]]：以DataFrame形式返回多列<br><br>df.loc[<span class="hljs-string">&#x27;index_one&#x27;</span>]：按索引选取数据<br><br>df.loc[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] / df.iloc[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>] / df.iat[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]：返回第一列的第一个元素<br><br>df.at[<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;no&#x27;</span>]：返回给出行和列label信息对应行列上的数据值<br><br>df.ix[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>] / df.ix[<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;no&#x27;</span>]: 可以是label数据和位置数据的混合使用<br></code></pre></td></tr></table></figure><h4 id="3-数据清洗"><a href="#3-数据清洗" class="headerlink" title="3. 数据清洗"></a>3. 数据清洗</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python">df.columns = [<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>]：重命名列名<br><br>df[(df[<span class="hljs-string">&#x27;ax&#x27;</span>] &gt; <span class="hljs-number">30</span>) &amp; (df[<span class="hljs-string">&#x27;bx&#x27;</span>] &gt; <span class="hljs-number">40</span>)]：布尔选择(筛选ax列大于<span class="hljs-number">30</span>并且bx列大于<span class="hljs-number">40</span>的值组成的DataFrame)<br><br>pd.isnull()：检查DataFrame对象中的空值，并返回一个Boolean数组<br><br>pd.notnull()：检查DataFrame对象中的非空值，并返回一个Boolean数组<br><br>df.dropna()：删除所有包含空值的行<br><br>df.dropna(axis=<span class="hljs-number">1</span>)：删除所有包含空值的列<br><br>df.fillna(x)：用x替换DataFrame对象中所有的空值<br><br>s.astype(float) / s.astype(np.float64)：将Series中的数据类型更改为Numpy中float64类型<br><span class="hljs-comment"># 这是使用float代替np.float64是因为Numpy可以使用相同的别名来表征与Python相同精度的Python数据类型</span><br><br>s.replace(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;one&#x27;</span>)：用‘one’代替所有等于<span class="hljs-number">1</span>的值<br><br>s.replace([<span class="hljs-number">1</span>,<span class="hljs-number">3</span>],[<span class="hljs-string">&#x27;one&#x27;</span>,<span class="hljs-string">&#x27;three&#x27;</span>])：用<span class="hljs-string">&#x27;one&#x27;</span>代替<span class="hljs-number">1</span>，用<span class="hljs-string">&#x27;three&#x27;</span>代替<span class="hljs-number">3</span><br><br>df.rename(columns=<span class="hljs-keyword">lambda</span> x: x + <span class="hljs-number">1</span>)：批量更改列名<br><br>df.rename(columns=&#123;<span class="hljs-string">&#x27;old_name&#x27;</span>: <span class="hljs-string">&#x27;new_ name&#x27;</span>&#125;)：选择性更改列名<br><br>df.set_index(<span class="hljs-string">&#x27;column_one&#x27;</span>)：更改索引列<br><br>df.rename(index=<span class="hljs-keyword">lambda</span> x: x + <span class="hljs-number">1</span>)：批量重命名索引<br></code></pre></td></tr></table></figure><h4 id="4-数据处理：Filter、Sort和GroupBy"><a href="#4-数据处理：Filter、Sort和GroupBy" class="headerlink" title="4. 数据处理：Filter、Sort和GroupBy"></a>4. 数据处理：Filter、Sort和GroupBy</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python">df[df[col] &gt; <span class="hljs-number">0.5</span>]：选择col列的值大于<span class="hljs-number">0.5</span>的行<br><br>df.sort_index(axis=<span class="hljs-number">0</span>, ascending=<span class="hljs-literal">True</span>)：按照索引排序，默认为升序<br><br>df.sort_index(by=[a,b,...])：按照指定排序规则排序<br><br>df.sort_values(col1)：按照列col1排序数据，默认升序排列<br><br>df.sort_values(col1, ascending=<span class="hljs-literal">False</span>)：按照列col1降序排列数据<br><br>df.sort_values([col1,col2], ascending=[<span class="hljs-literal">True</span>,<span class="hljs-literal">False</span>])：先按列col1升序排列，后按col2降序排列数据<br><br>df.groupby(col)：返回一个按列col进行分组的Groupby对象<br><br>df.groupby([col1,col2])：返回一个按多列进行分组的Groupby对象<br><br>df.groupby(col1)[col2]：返回按列col1进行分组后，列col2的均值<br><br>df.T：对DataFrame的行列进行转置<br><br>df[<span class="hljs-string">&#x27;A&#x27;</span>] = df[<span class="hljs-string">&#x27;A&#x27;</span>].astype(float)：将A列的数据类型强制转换为float64<br><br>df.pivot_table(index=col1, values=[col2,col3], aggfunc=max)：创建一个按列col1进行分组，并计算col2和col3的最大值的数据透视表<br><br>df.groupby(col1).agg(np.mean)：返回按列col1分组的所有列的均值<br><br>data.apply(np.mean)：对DataFrame中的每一列应用函数np.mean<br><br>data.apply(np.max,axis=<span class="hljs-number">1</span>)：对DataFrame中的每一列应用函数np.max<br></code></pre></td></tr></table></figure><h4 id="5-数据合并"><a href="#5-数据合并" class="headerlink" title="5. 数据合并"></a>5. 数据合并</h4><ul><li>concat</li></ul><p>Pandas在做数据拼接的时候提供类似于数据库的内连接、外连接的操作。默认是outer join即外连接，可以使用参数指定连接的类型为内连接inner join</p><ul><li>merge</li></ul><p>concat函数可以实现内外连接，而pandas的merge函数可以真正实现数据库的内外连接，且外连接还可以有左右连接的特性。merge函数默认拼接数据是inner join即内连接。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">df1.append(df2)：将df2中的行添加到df1的尾部<br><br>df.concat([df1, df2],axis=<span class="hljs-number">1</span>,join=<span class="hljs-string">&quot;outer&quot;</span>)：将df2中的列添加到df1的尾部<br><br>df1.join(df2,on=col1,how=<span class="hljs-string">&#x27;inner&#x27;</span>)：对df1的列和df2的列执行SQL形式的inner join<br><br>df1.merge(df2, how = <span class="hljs-string">&quot;left&quot;</span>)：对df1的列和df2的列执行SQL形式的left join<br></code></pre></td></tr></table></figure><h4 id="6-数据统计"><a href="#6-数据统计" class="headerlink" title="6. 数据统计"></a>6. 数据统计</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python">df.describe()：查看数据值列的汇总统计<br><br>df.sum()：返回一个含有求和小计的Series<br><br>df.mean()：返回一个含有平均值的Series<br><br>df.count()：返回每一列中的非空值的个数<br><br>df.max()：返回每一列的最大值<br><br>df.min()：返回每一列的最小值<br><br>df.median()：返回一个含有算术中位数的Series<br><br>df.var()：返回一个方差的Series<br><br>df.std()：返回一个标准差的Series<br><br>df.cumsum()：返回样本的累积和<br><br>df.cummin()：返回样本的累计最小值<br><br>df.cummax()：返回样本的累计最大值<br><br>df.cumprod()：返回样本的累计乘积<br><br>df.corr()：返回列与列之间的相关系数<br><br>df.pct_change(axis=<span class="hljs-number">0</span>)：返回样本的百分比数变化<br><br></code></pre></td></tr></table></figure><p><strong>python中的axis究竟是如何定义的呢？他们究竟代表是DataFrame的行还是列？</strong></p><p>使用0值表示沿着每一列或行标签\索引值向下执行方法</p><p>使用1值表示沿着每一行或者列标签模向执行对应的方法</p><p><img src="https://stellae.gitee.io/myblog/images/images/pandas-axis.png"></p><h4 id="7-特殊方法"><a href="#7-特殊方法" class="headerlink" title="7. 特殊方法"></a>7. 特殊方法</h4><h5 id="1-map方法"><a href="#1-map方法" class="headerlink" title="(1).map方法"></a>(1).map方法</h5><p>Series中的每一个元素进行操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">df[<span class="hljs-string">&#x27;B&#x27;</span>] = df[<span class="hljs-string">&#x27;B&#x27;</span>].map(<span class="hljs-keyword">lambda</span> x: x+<span class="hljs-number">1</span>)    <span class="hljs-comment"># 对B列每一个元素自加1</span><br></code></pre></td></tr></table></figure><h5 id="2-applymap方法"><a href="#2-applymap方法" class="headerlink" title="(2).applymap方法"></a>(2).applymap方法</h5><p>DataFrame中每一个元素进行操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">df = pd.DataFrame(np.arange(<span class="hljs-number">12</span>).reshape(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), columns=[<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>])<br>df = df.applymap(<span class="hljs-keyword">lambda</span> x: <span class="hljs-string">&#x27;%.2f&#x27;</span> % x)   <span class="hljs-comment"># 对每一个元素保留2为小数</span><br><span class="hljs-comment"># df = df.applymap(&#x27;&#123;:.2f&#125;&#x27;.format)  # 同上</span><br></code></pre></td></tr></table></figure><h5 id="3-apply方法"><a href="#3-apply方法" class="headerlink" title="(3).apply方法"></a>(3).apply方法</h5><p>DataFrame中行或列进行操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">df = pd.DataFrame(np.arange(<span class="hljs-number">12</span>).reshape(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), columns=[<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>])<br>df = df.apply(<span class="hljs-keyword">lambda</span> x: x.sum(), axis=<span class="hljs-number">0</span>)   <span class="hljs-comment"># 对每一列进行求和</span><br></code></pre></td></tr></table></figure><p><a href="http://liao.cpython.org/partFive/">Pandas教程</a> / <a href="https://www.pypandas.cn/">Pandas中文官网</a></p>]]></content>
    
    
    <categories>
      
      <category>Pandas</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pandas</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Locust-压力测试</title>
    <link href="/Myblog/2019/07/17/Locust-%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/"/>
    <url>/Myblog/2019/07/17/Locust-%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<h4 id="Locust-是什么"><a href="#Locust-是什么" class="headerlink" title="Locust 是什么"></a>Locust 是什么</h4><p>蝗虫(Locust)是一个易于使用、分发、用户负载测试工具。它是用于负载测试的网站(或其他系统),弄清楚有多少并发用户系统可以处理。</p><p>我们的想法是,在测试期间,一群蝗虫会攻击你的网站。每个蝗虫的行为(或测试用户如果你愿意)被定义为你和聚集过程实时监控从web UI。这将帮助你战斗测试和代码中识别瓶颈之前让真正的用户。</p><p>蝗虫是完全基于事件,因此可以支持在单个机器上成千上万的并发用户。与许多其他的基于事件的应用程序不使用回调。相反,它使用轻量级进程,通过gevent。每个蝗虫爬你的网站实际上是运行在它自己的进程(或一种绿色小鸟,是正确的)。这允许您编写非常富有表现力的场景在Python中没有复杂的代码和回调。</p><h4 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install locust<br></code></pre></td></tr></table></figure><p>查看locust使用参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">locust --help<br></code></pre></td></tr></table></figure><p>启动测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">locust -f Locust_test.py --host=https://example.com<br></code></pre></td></tr></table></figure><blockquote><p>-f 指定测试脚本位置 –host地址测试服务器地址</p></blockquote><p>Locust web服务默认为8089端口，访问并填入虚拟用户数量和每秒钟启动的用户数量</p><h4 id="Locust-快速使用"><a href="#Locust-快速使用" class="headerlink" title="Locust 快速使用"></a>Locust 快速使用</h4><p>官方示例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, TaskSet<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login</span>(<span class="hljs-params">l</span>):</span><br>    l.client.post(<span class="hljs-string">&quot;/login&quot;</span>, &#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;ellen_key&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;education&quot;</span>&#125;)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">logout</span>(<span class="hljs-params">l</span>):</span><br>    l.client.post(<span class="hljs-string">&quot;/logout&quot;</span>, &#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;ellen_key&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;education&quot;</span>&#125;)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>(<span class="hljs-params">l</span>):</span><br>    l.client.get(<span class="hljs-string">&quot;/&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">profile</span>(<span class="hljs-params">l</span>):</span><br>    l.client.get(<span class="hljs-string">&quot;/profile&quot;</span>)<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserBehavior</span>(<span class="hljs-params">TaskSet</span>):</span><br>    tasks = &#123;index: <span class="hljs-number">2</span>, profile: <span class="hljs-number">1</span>&#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_start</span>(<span class="hljs-params">self</span>):</span><br>        login(self)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_stop</span>(<span class="hljs-params">self</span>):</span><br>        logout(self)<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><br>    task_set = UserBehavior<br>    min_wait = <span class="hljs-number">5000</span><br>    max_wait = <span class="hljs-number">9000</span><br></code></pre></td></tr></table></figure><p>应用 – 服务器压力测试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Locust_test.py</span><br><span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, TaskSet, task<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserBehavior</span>(<span class="hljs-params">TaskSet</span>):</span><br><span class="hljs-comment"># task(*) - 权重</span><br><span class="hljs-meta">    @task(1)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">groups_task</span>(<span class="hljs-params">self</span>):</span><br>        self.client.get(<span class="hljs-string">&quot;/api/products/groups?all=1&quot;</span>)<br><br><span class="hljs-meta">    @task(1)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">country_data</span>(<span class="hljs-params">self</span>):</span><br>    self.client.get(<span class="hljs-string">&quot;/api/countries?request=all_data&quot;</span>)<br><br><span class="hljs-meta">    @task(1)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">groups_products</span>(<span class="hljs-params">self</span>):</span><br>    self.client.get(<span class="hljs-string">&quot;/api/products/filter?page=1&amp;per_page=99999&amp;top_cate=030&amp;sub_cate=006&amp;=true&amp;history=&amp;user=12393&quot;</span>)<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><br>    task_set = UserBehavior  <span class="hljs-comment"># 定义用户行为</span><br>    <span class="hljs-comment">#执行事物之间用户等待时间的上下界，单位毫秒</span><br>    min_wait = <span class="hljs-number">5000</span><br>    max_wait = <span class="hljs-number">9000</span><br></code></pre></td></tr></table></figure><p><a href="https://docs.locust.io/en/stable/api.html">官方Locust文档</a> / <a href="https://blog.csdn.net/jojoy_tester/article/details/77926470">参考文章</a></p>]]></content>
    
    
    <categories>
      
      <category>压力测试</category>
      
    </categories>
    
    
    <tags>
      
      <tag>locust</tag>
      
      <tag>压力测试</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python项目性能优化</title>
    <link href="/Myblog/2019/06/12/Python%E9%A1%B9%E7%9B%AE%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    <url>/Myblog/2019/06/12/Python%E9%A1%B9%E7%9B%AE%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h2 id="Python-代码优化常见技巧"><a href="#Python-代码优化常见技巧" class="headerlink" title="Python 代码优化常见技巧"></a>Python 代码优化常见技巧</h2><p>代码优化能够让程序运行更快，它是在不改变程序运行结果的情况下使得程序的运行效率更高，根据 80/20 原则，实现程序的重构、优化、扩展以及文档相关的事情通常需要消耗 80% 的工作量。优化通常包含两方面的内容：减小代码的体积，提高代码的运行效率。</p><h3 id="改进算法，选择合适的数据结构"><a href="#改进算法，选择合适的数据结构" class="headerlink" title="改进算法，选择合适的数据结构"></a>改进算法，选择合适的数据结构</h3><p>一个良好的算法能够对性能起到关键作用，因此性能改进的首要点是对算法的改进。在算法的时间复杂度排序上依次是：</p><p>O(1) -&gt; O(lg n) -&gt; O(n lg n) -&gt; O(n^2) -&gt; O(n^3) -&gt; O(n^k) -&gt; O(k^n) -&gt; O(n!)</p><p>因此如果能够在时间复杂度上对算法进行一定的改进，对性能的提高不言而喻。</p><h3 id="对循环的优化"><a href="#对循环的优化" class="headerlink" title="对循环的优化"></a>对循环的优化</h3><p>对循环的优化所遵循的原则是尽量减少循环过程中的计算量，有多重循环的尽量将内层的计算提到上一层。下面通过实例来对比循环优化后所带来的性能的提高。</p><p>优化前 — 132.37s：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time <br>t = time() <br>lista = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>] <br>listb =[<span class="hljs-number">0.1</span>,<span class="hljs-number">0.2</span>,<span class="hljs-number">0.3</span>,<span class="hljs-number">0.4</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">0.6</span>,<span class="hljs-number">0.7</span>,<span class="hljs-number">0.8</span>,<span class="hljs-number">0.9</span>,<span class="hljs-number">0.01</span>] <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range (<span class="hljs-number">1000000</span>): <br>    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> range(len(lista)): <br>        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> range(len(listb)): <br>            x=lista[a]+listb[b] <br><span class="hljs-keyword">print</span> <span class="hljs-string">&quot;total run time:&quot;</span><br><span class="hljs-keyword">print</span> time() - t<br></code></pre></td></tr></table></figure><p>现在进行如下优化，将长度计算提到循环外，range 用 xrange 代替，同时将第三层的计算 lista[a] 提到循环的第二层。</p><p>优化后 — 102.171s：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time <br>t = time() <br>lista = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>] <br>listb =[<span class="hljs-number">0.1</span>,<span class="hljs-number">0.2</span>,<span class="hljs-number">0.3</span>,<span class="hljs-number">0.4</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">0.6</span>,<span class="hljs-number">0.7</span>,<span class="hljs-number">0.8</span>,<span class="hljs-number">0.9</span>,<span class="hljs-number">0.01</span>] <br>len1=len(lista) <br>len2=len(listb) <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange (<span class="hljs-number">1000000</span>): <br>    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> xrange(len1): <br>        temp=lista[a] <br>        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> xrange(len2): <br>            x=temp+listb[b] <br><span class="hljs-keyword">print</span> <span class="hljs-string">&quot;total run time:&quot;</span><br><span class="hljs-keyword">print</span> time() - t<br></code></pre></td></tr></table></figure><p>上述优化后的程序其运行时间缩短为 102.171999931。在清单 4 中 lista[a] 被计算的次数为 1000000<em>10</em>10，而在优化后的代码中被计算的次数为 1000000*10，计算次数大幅度缩短，因此性能有所提升。</p><h3 id="充分利用-Lazy-if-evaluation-的特性"><a href="#充分利用-Lazy-if-evaluation-的特性" class="headerlink" title="充分利用 Lazy if-evaluation 的特性"></a>充分利用 Lazy if-evaluation 的特性</h3><p>python 中条件表达式是 lazy evaluation 的，也就是说如果存在条件表达式 if x and y，在 x 为 false 的情况下 y 表达式的值将不再计算。因此可以利用该特性在一定程度上提高程序效率。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time <br>t = time() <br>abbreviations = [<span class="hljs-string">&#x27;cf.&#x27;</span>, <span class="hljs-string">&#x27;e.g.&#x27;</span>, <span class="hljs-string">&#x27;ex.&#x27;</span>, <span class="hljs-string">&#x27;etc.&#x27;</span>, <span class="hljs-string">&#x27;fig.&#x27;</span>, <span class="hljs-string">&#x27;i.e.&#x27;</span>, <span class="hljs-string">&#x27;Mr.&#x27;</span>, <span class="hljs-string">&#x27;vs.&#x27;</span>] <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range (<span class="hljs-number">1000000</span>): <br>    <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;Mr.&#x27;</span>, <span class="hljs-string">&#x27;Hat&#x27;</span>, <span class="hljs-string">&#x27;is&#x27;</span>, <span class="hljs-string">&#x27;chasing&#x27;</span>, <span class="hljs-string">&#x27;the&#x27;</span>, <span class="hljs-string">&#x27;black&#x27;</span>, <span class="hljs-string">&#x27;cat&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>): <br>        <span class="hljs-keyword">if</span> w <span class="hljs-keyword">in</span> abbreviations: <br>        <span class="hljs-comment">#if w[-1] == &#x27;.&#x27; and w in abbreviations: </span><br>            <span class="hljs-keyword">pass</span> <br><span class="hljs-keyword">print</span> <span class="hljs-string">&quot;total run time:&quot;</span><br><span class="hljs-keyword">print</span> time() - t<br></code></pre></td></tr></table></figure><p>在未进行优化之前程序的运行时间大概为 8.84，如果使用注释行代替第一个 if，运行的时间大概为 6.17。</p><h3 id="字符串的优化"><a href="#字符串的优化" class="headerlink" title="字符串的优化"></a>字符串的优化</h3><p>python 中的字符串对象是不可改变的，因此对任何字符串的操作如拼接，修改等都将产生一个新的字符串对象，而不是基于原字符串，因此这种持续的 copy 会在一定程度上影响 python 的性能。对字符串的优化也是改善性能的一个重要的方面，特别是在处理文本较多的情况下。字符串的优化主要集中在以下几个方面:</p><ul><li>在字符串连接的使用尽量使用 join() 而不是 +，因此在字符的操作上 join 比 + 要快，因此要尽量使用 join 而不是 +</li><li>当对字符串可以使用正则表达式或者内置函数来处理的时候，选择内置函数。如 str.isalpha()，str.isdigit()，str.startswith((‘x’, ‘yz’))，str.endswith((‘x’, ‘yz’))</li></ul><h3 id="使用列表解析和生成器表达式"><a href="#使用列表解析和生成器表达式" class="headerlink" title="使用列表解析和生成器表达式"></a>使用列表解析和生成器表达式</h3><p>列表解析要比在循环中重新构建一个新的 list 更为高效，因此我们可以利用这一特性来提高运行的效率。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range (<span class="hljs-number">1000000</span>): <br>    a = [w <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> list]<br></code></pre></td></tr></table></figure><p>生成器表达式则是在 2.4 中引入的新内容，语法和列表解析类似，但是在大数据量处理时，生成器表达式的优势较为明显，它并不创建一个列表，只是返回一个生成器，因此效率较高。在上述例子上中代码 a = [w for w in list] 修改为 a = (w for w in list)，运行时间进一步减少，缩短约为 2.98s。</p><h3 id="其他优化技巧"><a href="#其他优化技巧" class="headerlink" title="其他优化技巧"></a>其他优化技巧</h3><ul><li>如果需要交换两个变量的值使用 a,b=b,a 而不是借助中间变量 t=a;a=b;b=t;</li><li>在循环的时候使用 xrange 而不是 range；使用 xrange 可以节省大量的系统内存，因为 xrange() 在序列中每次调用只产生一个整数元素。而 range() 將直接返回完整的元素列表，用于循环时会有不必要的开销。在 python3 中 xrange 不再存在，里面 range 提供一个可以遍历任意长度的范围的 iterator。</li><li>使用局部变量，避免”global” 关键字。python 访问局部变量会比全局变量要快得多，因    此可以利用这一特性提升性能。</li><li>if done is not None 比语句 if done != None 更快，读者可以自行验证；</li><li>在耗时较多的循环中，可以把函数的调用改为内联的方式；</li><li>使用级联比较 “x &lt; y &lt; z” 而不是 “x &lt; y and y &lt; z”；</li><li>while 1 要比 while True 更快（当然后者的可读性更好）；</li><li>build in 函数通常较快，add(a,b) 要优于 a+b。</li></ul><h2 id="定位程序性能瓶颈"><a href="#定位程序性能瓶颈" class="headerlink" title="定位程序性能瓶颈"></a>定位程序性能瓶颈</h2><p>对代码优化的前提是需要了解性能瓶颈在什么地方，程序运行的主要时间是消耗在哪里，对于比较复杂的代码可以借助一些工具来定位，python 内置了丰富的性能分析工具，如 profile,cProfile 与 hotshot 等。其中 Profiler 是 python 自带的一组程序，能够描述程序运行时候的性能，并提供各种统计帮助用户定位程序的性能瓶颈。Python 标准模块提供三种 profilers:cProfile,profile 以及 hotshot。</p><p>profile 的使用非常简单，只需要在使用之前进行 import 即可。具体实例如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> profile <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">profileTest</span>():</span> <br>   Total =<span class="hljs-number">1</span>; <br>   <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>): <br>       Total=Total*(i+<span class="hljs-number">1</span>) <br>       <span class="hljs-keyword">print</span> Total <br>   <span class="hljs-keyword">return</span> Total <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>: <br>   profile.run(<span class="hljs-string">&quot;profileTest()&quot;</span>)<br></code></pre></td></tr></table></figure><p>其中输出每列的具体解释如下：</p><ul><li>ncalls：表示函数调用的次数；</li><li>tottime：表示指定函数的总的运行时间，除掉函数中调用子函数的运行时间；</li><li>percall：（第一个 percall）等于 tottime/ncalls；</li><li>cumtime：表示该函数及其所有子函数的调用运行的时间，即函数开始调用到返回的时间；</li><li>percall：（第二个 percall）即函数运行一次的平均时间，等于 cumtime/ncalls；</li><li>filename:lineno(function)：每个函数调用的具体信息；</li></ul><p>如果需要将输出以日志的形式保存，只需要在调用的时候加入另外一个参数。如 profile.run(“profileTest()”,”testprof”)。</p><p>对于 profile 的剖析数据，如果以二进制文件的时候保存结果的时候，可以通过 pstats 模块进行文本报表分析，它支持多种形式的报表输出，是文本界面下一个较为实用的工具。使用非常简单：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pstats <br>p = pstats.Stats(<span class="hljs-string">&#x27;testprof&#x27;</span>) <br>p.sort_stats(<span class="hljs-string">&quot;name&quot;</span>).print_stats()<br></code></pre></td></tr></table></figure><p>其中 sort_stats() 方法能够对剖分数据进行排序， 可以接受多个排序字段，如 sort_stats(‘name’, ‘file’) 将首先按照函数名称进行排序，然后再按照文件名进行排序。常见的排序字段有 calls( 被调用的次数 )，time（函数内部运行时间），cumulative（运行的总时间）等。此外 pstats 也提供了命令行交互工具，执行 python – m pstats 后可以通过 help 了解更多使用方式。</p><p>对于大型应用程序，如果能够将性能分析的结果以图形的方式呈现，将会非常实用和直观，常见的可视化工具有 Gprof2Dot，visualpytune，KCacheGrind 等，读者可以自行查阅相关官网，本文不做详细讨论。</p><h2 id="Python-性能优化工具"><a href="#Python-性能优化工具" class="headerlink" title="Python 性能优化工具"></a>Python 性能优化工具</h2><p>Python 性能优化除了改进算法，选用合适的数据结构之外，还有几种关键的技术，比如将关键 python 代码部分重写成 C 扩展模块，或者选用在性能上更为优化的解释器等，这些在本文中统称为优化工具。python 有很多自带的优化工具，如 Psyco，Pypy，Cython，Pyrex 等，这些优化工具各有千秋，本节选择几种进行介绍。</p><h3 id="Psyco"><a href="#Psyco" class="headerlink" title="Psyco"></a>Psyco</h3><p>psyco 是一个 just-in-time 的编译器，它能够在不改变源代码的情况下提高一定的性能，Psyco 将操作编译成有点优化的机器码，其操作分成三个不同的级别，有”运行时”、”编译时”和”虚拟时”变量。并根据需要提高和降低变量的级别。运行时变量只是常规 Python 解释器处理的原始字节码和对象结构。一旦 Psyco 将操作编译成机器码，那么编译时变量就会在机器寄存器和可直接访问的内存位置中表示。同时 python 能高速缓存已编译的机器码以备今后重用，这样能节省一点时间。但 Psyco 也有其缺点，其本身运行所占内存较大。目前 psyco 已经不在 python2.7 中支持，而且不再提供维护和更新了，对其感兴趣的可以参考 <a href="http://psyco.sourceforge.net/">http://psyco.sourceforge.net/</a></p><h3 id="Pypy"><a href="#Pypy" class="headerlink" title="Pypy"></a>Pypy</h3><p>PyPy 表示 “用 Python 实现的 Python”，但实际上它是使用一个称为 RPython 的 Python 子集实现的，能够将 Python 代码转成 C， .NET， Java 等语言和平台的代码。PyPy 集成了一种即时 (JIT) 编译器。和许多编译器，解释器不同，它不关心 Python 代码的词法分析和语法树。 因为它是用 Python 语言写的，所以它直接利用 Python 语言的 Code Object.。 Code Object 是 Python 字节码的表示，也就是说， PyPy 直接分析 Python 代码所对应的字节码 ,，这些字节码即不是以字符形式也不是以某种二进制格式保存在文件中， 而在 Python 运行环境中。目前版本是 1.8. 支持不同的平台安装，windows 上安装 Pypy 需要先下载 <a href="https://bitbucket.org/pypy/pypy/downloads/pypy-1.8-win32.zip%EF%BC%8C%E7%84%B6%E5%90%8E%E8%A7%A3%E5%8E%8B%E5%88%B0%E7%9B%B8%E5%85%B3%E7%9A%84%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%B9%B6%E5%B0%86%E8%A7%A3%E5%8E%8B%E5%90%8E%E7%9A%84%E8%B7%AF%E5%BE%84%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">https://bitbucket.org/pypy/pypy/downloads/pypy-1.8-win32.zip，然后解压到相关的目录，并将解压后的路径添加到环境变量</a> path 中即可。在命令行运行 pypy，如果出现如下错误：”没有找到 MSVCR100.dll, 因此这个应用程序未能启动，重新安装应用程序可能会修复此问题”，则还需要在微软的官网上下载 VS 2010 runtime libraries 解决该问题。具体地址为 <a href="http://www.microsoft.com/download/en/details.aspx?displaylang=en&id=5555">http://www.microsoft.com/download/en/details.aspx?displaylang=en&amp;id=5555</a></p><p> 使用pypy 来编译和运行程序，其效率大大的提高。</p><h3 id="Cython"><a href="#Cython" class="headerlink" title="Cython"></a>Cython</h3><p>Cython 是用 python 实现的一种语言，可以用来写 python 扩展，用它写出来的库都可以通过 import 来载入，性能上比 python 的快。cython 里可以载入 python 扩展 ( 比如 import math)，也可以载入 c 的库的头文件 ( 比如 :cdef extern from “math.h”)，另外也可以用它来写 python 代码。将关键部分重写成 C 扩展模块</p><p>Cython 代码与 python 不同，必须先编译，编译一般需要经过两个阶段，将 pyx 文件编译为 .c 文件，再将 .c 文件编译为 .so 文件</p><p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-python-optim/index.html">本文参考文章</a></p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能优化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>APScheduler定时任务框架</title>
    <link href="/Myblog/2019/06/03/APScheduler%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6/"/>
    <url>/Myblog/2019/06/03/APScheduler%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="sched-Python内置模块"><a href="#sched-Python内置模块" class="headerlink" title="sched - Python内置模块"></a>sched - Python内置模块</h3><p>sched 模块是 Python 内置的模块，它是一个调度（延时处理机制），每次想要定时执行某任务都必须写入一个调度。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sched<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br><br><span class="hljs-comment"># 第一个参数是一个可以返回时间戳的函数，第二个参数可以在定时未到达之前阻塞。</span><br>schedule = sched.scheduler(time.time, time.sleep)<br><br><br><span class="hljs-comment"># 被周期性调度触发的函数</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_time</span>(<span class="hljs-params">inc</span>):</span><br>    print(datetime.now().strftime(<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))<br>    schedule.enter(inc, <span class="hljs-number">0</span>, print_time, (inc,))<br><br><br><span class="hljs-comment"># enter四个参数分别为：间隔事件、优先级（用于同时间到达的两个事件同时执行时定序）、被调用触发的函数，</span><br><span class="hljs-comment"># 给该触发函数的参数（tuple形式）</span><br>schedule.enter(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, print_time, (<span class="hljs-number">1</span>,))  <span class="hljs-comment"># 1s输出一次</span><br>schedule.run()<br></code></pre></td></tr></table></figure><h3 id="APScheduler定时任务框架"><a href="#APScheduler定时任务框架" class="headerlink" title="APScheduler定时任务框架"></a>APScheduler定时任务框架</h3><p>APScheduler是一个 Python 定时任务框架，使用起来十分方便。提供了基于日期、固定时间间隔以及 crontab 类型的任务，并且可以持久化任务、并以 daemon 方式运行应用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install apscheduler<br></code></pre></td></tr></table></figure><h3 id="APScheduler四个组建"><a href="#APScheduler四个组建" class="headerlink" title="APScheduler四个组建"></a>APScheduler四个组建</h3><p>APScheduler 四个组件分别为：触发器(trigger)，作业存储(job store)，执行器(executor)，调度器(scheduler)。</p><ul><li><p>触发器(trigger)</p><p>包含调度逻辑，每一个作业有它自己的触发器，用于决定接下来哪一个作业会运行。除了他们自己初始配置意外，触发器完全是无状态的。</p><p>APScheduler 有三种内建的 trigger，后面有详细说明。</p><blockquote><p>date: 特定的时间点触发<br>interval: 固定时间间隔触发<br>cron: 在特定时间周期性地触发</p></blockquote></li><li><p>作业存储(job store)</p><p>存储被调度的作业，默认的作业存储是简单地把作业保存在内存中，其他的作业存储是将作业保存在数据库中。一个作业的数据讲在保存在持久化作业存储时被序列化，并在加载时被反序列化。调度器不能分享同一个作业存储。APScheduler 默认使用 MemoryJobStore，可以修改使用 DB 存储方案。</p></li><li><p>执行器(executor)</p><p>处理作业的运行，他们通常通过在作业中提交制定的可调用对象到一个线程或者进城池来进行。当作业完成时，执行器将会通知调度器。最常用的 executor 有两种。</p><blockquote><p>ProcessPoolExecutor<br>ThreadPoolExecutor</p></blockquote></li><li><p>调度器(scheduler)</p><p>通常在应用中只有一个调度器，应用的开发者通常不会直接处理作业存储、调度器和触发器，相反，调度器提供了处理这些的合适的接口。配置作业存储和执行器可以在调度器中完成，例如添加、修改和移除作业。</p></li></ul><h3 id="APScheduler简单例子"><a href="#APScheduler简单例子" class="headerlink" title="APScheduler简单例子"></a>APScheduler简单例子</h3><p>例子：周一至周五每天早上6：30输出当前时间。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-keyword">from</span> apscheduler.schedulers.blocking <span class="hljs-keyword">import</span> BlockingScheduler<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">job</span>():</span><br>    print(datetime.now().strftime(<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))<br><br><br>scheduler = BlockingScheduler()<br><span class="hljs-comment"># scheduler.add_job(job, &#x27;cron&#x27;, minute=&#x27;*&#x27;) # 每分钟</span><br>scheduler.add_job(job, <span class="hljs-string">&#x27;cron&#x27;</span>, day_of_week=<span class="hljs-string">&#x27;1-5&#x27;</span>, hour=<span class="hljs-number">6</span>, minute=<span class="hljs-number">30</span>) <span class="hljs-comment"># 每周1-5早上6:30</span><br><span class="hljs-comment"># 开始运行调度器</span><br>scheduler.start()<br></code></pre></td></tr></table></figure><p>APScheduler 中有两种常用的调度器：BlockingScheduler 和 BackgroundScheduler，当调度器是应用中唯一要运行的任务时，使用 BlockingSchedule；如果希望调度器在后台执行，使用 BackgroundScheduler。</p><blockquote><p>BlockingScheduler – 当调度程序是进程中唯一运行的程序时。<br>BackgroundScheduler – 当你不使用下面的任何框架，并且希望调度程序在应用程序的后台运行时。<br>AsyncIOScheduler – 使用asyncio模块时。<br>GeventScheduler – 使用gevent模块时。<br>TornadoScheduler – 使用Tornado框架时。<br>TwistedScheduler – 使用Twisted框架时<br>QtScheduler – 使用Qt时。</p></blockquote><h3 id="Trigger规则"><a href="#Trigger规则" class="headerlink" title="Trigger规则"></a>Trigger规则</h3><ul><li><p>date -  特定的时间点触发</p><blockquote><ul><li>run_date (datetime|str) – the date/time to run the job at</li><li>timezone (datetime.tzinfo|str) – time zone for run_date if it doesn’t have one already</li></ul></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date<br><span class="hljs-keyword">from</span> apscheduler.schedulers.blocking <span class="hljs-keyword">import</span> BlockingScheduler<br>sched = BlockingScheduler()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_job</span>(<span class="hljs-params">text</span>):</span><br>    print(text)<br><span class="hljs-comment"># The job will be executed on November 6th, 2009</span><br>sched.add_job(my_job, <span class="hljs-string">&#x27;date&#x27;</span>, run_date=date(<span class="hljs-number">2009</span>, <span class="hljs-number">11</span>, <span class="hljs-number">6</span>), args=[<span class="hljs-string">&#x27;text&#x27;</span>])<br>sched.add_job(my_job, <span class="hljs-string">&#x27;date&#x27;</span>, run_date=datetime(<span class="hljs-number">2009</span>, <span class="hljs-number">11</span>, <span class="hljs-number">6</span>, <span class="hljs-number">16</span>, <span class="hljs-number">30</span>, <span class="hljs-number">5</span>), args=[<span class="hljs-string">&#x27;text&#x27;</span>])<br>sched.add_job(my_job, <span class="hljs-string">&#x27;date&#x27;</span>, run_date=<span class="hljs-string">&#x27;2009-11-06 16:30:05&#x27;</span>, args=[<span class="hljs-string">&#x27;text&#x27;</span>])<br><span class="hljs-comment"># The &#x27;date&#x27; trigger and datetime.now() as run_date are implicit</span><br>sched.add_job(my_job, args=[<span class="hljs-string">&#x27;text&#x27;</span>])<br>sched.start()<br></code></pre></td></tr></table></figure></li></ul><ul><li><p>interval - 固定时间间隔触发</p><p>参数：</p><blockquote><ul><li>weeks (int) – number of weeks to wait</li><li>days (int) – number of days to wait</li><li>hours (int) – number of hours to wait</li><li>minutes (int) – number of minutes to wait</li><li>seconds (int) – number of seconds to wait</li><li>start_date (datetime|str) – starting point for the interval calculation</li><li>end_date (datetime|str) – latest possible date/time to trigger on</li><li>timezone (datetime.tzinfo|str) – time zone to use for the date/time calculations</li></ul></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">from</span> apscheduler.schedulers.blocking <span class="hljs-keyword">import</span> BlockingScheduler<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">job_function</span>():</span><br>    print(<span class="hljs-string">&quot;Hello World&quot;</span>)<br><span class="hljs-comment"># BlockingScheduler</span><br>sched = BlockingScheduler()<br><span class="hljs-comment"># Schedule job_function to be called every two hours</span><br>sched.add_job(job_function, <span class="hljs-string">&#x27;interval&#x27;</span>, hours=<span class="hljs-number">2</span>)<br><span class="hljs-comment"># The same as before, but starts on 2010-10-10 at 9:30 and stops on 2014-06-15 at 11:00</span><br>sched.add_job(job_function, <span class="hljs-string">&#x27;interval&#x27;</span>, hours=<span class="hljs-number">2</span>, start_date=<span class="hljs-string">&#x27;2010-10-10 09:30:00&#x27;</span>, end_date=<span class="hljs-string">&#x27;2014-06-15 11:00:00&#x27;</span>)<br>sched.start()<br></code></pre></td></tr></table></figure></li></ul><ul><li><p>cron - 在特定时间周期性地触发</p><p>参数：</p><blockquote><ul><li>year (int|str) – 4-digit year</li><li>month (int|str) – month (1-12)</li><li>day (int|str) – day of the (1-31)</li><li>week (int|str) – ISO week (1-53)</li><li>day_of_week (int|str) – number or name of weekday (0-6 or mon,tue,wed,thu,fri,sat,sun)</li><li>hour (int|str) – hour (0-23)</li><li>minute (int|str) – minute (0-59)</li><li>second (int|str) – second (0-59)</li><li>start_date (datetime|str) – earliest possible date/time to trigger on (inclusive)</li><li>end_date (datetime|str) – latest possible date/time to trigger on (inclusive)</li><li>timezone (datetime.tzinfo|str) – time zone to use for the date/time calculations (defaults to scheduler timezone)</li></ul></blockquote><p>表达式：</p><p><img src="https://stellae.gitee.io/myblog/images/images/python_timer_expression.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> apscheduler.schedulers.blocking <span class="hljs-keyword">import</span> BlockingScheduler<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">job_function</span>():</span><br>    print(<span class="hljs-string">&quot;Hello World&quot;</span>)<br><span class="hljs-comment"># BlockingScheduler</span><br>sched = BlockingScheduler()<br><span class="hljs-comment"># Schedules job_function to be run on the third Friday</span><br><span class="hljs-comment"># of June, July, August, November and December at 00:00, 01:00, 02:00 and 03:00</span><br>sched.add_job(job_function, <span class="hljs-string">&#x27;cron&#x27;</span>, month=<span class="hljs-string">&#x27;6-8,11-12&#x27;</span>, day=<span class="hljs-string">&#x27;3rd fri&#x27;</span>, hour=<span class="hljs-string">&#x27;0-3&#x27;</span>)<br><span class="hljs-comment"># Runs from Monday to Friday at 5:30 (am) until 2014-05-30 00:00:00</span><br>sched.add_job(job_function, <span class="hljs-string">&#x27;cron&#x27;</span>, day_of_week=<span class="hljs-string">&#x27;mon-fri&#x27;</span>, hour=<span class="hljs-number">5</span>, minute=<span class="hljs-number">30</span>, end_date=<span class="hljs-string">&#x27;2014-05-30&#x27;</span>)<br>sched.start()<br></code></pre></td></tr></table></figure></li></ul><h3 id="Flask-APScheduler使用"><a href="#Flask-APScheduler使用" class="headerlink" title="Flask-APScheduler使用"></a>Flask-APScheduler使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install flask-apscheduler<br></code></pre></td></tr></table></figure><p>例子：</p><p><code>run.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask_script <span class="hljs-keyword">import</span> Manager<br><span class="hljs-keyword">from</span> flask_apscheduler <span class="hljs-keyword">import</span> APScheduler<br><br><span class="hljs-keyword">from</span> app.setting <span class="hljs-keyword">import</span> SQLALCHEMY_DATABASE_URI<br><span class="hljs-keyword">from</span> app.model <span class="hljs-keyword">import</span> db<br><span class="hljs-keyword">from</span> app.views <span class="hljs-keyword">import</span> app_bluepring<br><br><br>app = Flask(__name__)<br><br><span class="hljs-comment"># 数据库的配置</span><br>app.config[<span class="hljs-string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = SQLALCHEMY_DATABASE_URI<br>app.config[<span class="hljs-string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="hljs-literal">False</span><br><br><span class="hljs-comment"># 初始化scheduler</span><br>scheduler = APScheduler()<br>scheduler.init_app(app)<br><br><span class="hljs-comment"># 初始化app和db</span><br>db.init_app(app)<br><br><span class="hljs-comment"># 注册蓝图</span><br>app.register_blueprint(blueprint=app_bluepring, url_prefix=<span class="hljs-string">&#x27;/app&#x27;</span>)<br><br>scheduler.start()<br><br>manage = Manager(app)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>    manage.run()<br><br></code></pre></td></tr></table></figure><p><code>views.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Blueprint, current_app<br><br><br>app_bluepring = Blueprint(<span class="hljs-string">&#x27;app&#x27;</span>, __name__)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_product_pic</span>():</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-meta">@app_bluepring.route(&#x27;/creat_task&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">creat_task</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;定时任务：每天晚上7：00执行&quot;&quot;&quot;</span><br>    current_app.apscheduler.add_job(func=update_product_pic, id=<span class="hljs-string">&quot;tasks&quot;</span>, trigger=<span class="hljs-string">&quot;cron&quot;</span>, day=<span class="hljs-string">&#x27;*&#x27;</span>, hour=<span class="hljs-number">19</span>, coalesce=<span class="hljs-literal">True</span>, misfire_grace_time=<span class="hljs-number">30</span>, replace_existing=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># current_app.apscheduler.add_job(func=update_product_pic, id=&quot;tasks&quot;, trigger=&quot;cron&quot;, second=&#x27;*&#x27;)</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;create task successful&#x27;</span><br><br></code></pre></td></tr></table></figure><blockquote><p>1、misfire_grace_time，假如一个作业本来 08:00 有一次执行，但是由于某种原因没有被调度上，现在 08:01 了，这个 08:00 的运行实例被提交时，会检查它预订运行的时间和当下时间的差值（这里是1分钟），大于我们设置的 30 秒限制，那么这个运行实例不会被执行。</p><p>2、 scheduler 被 shutdown 后重启，某个任务会积攒了好几次没执行如 5 次，下次这个作业被提交给执行器时，执行 5 次。设置 coalesce=True 后，只会执行一次。</p><p>3、replace_existing=True避免出现两个以上重复任务。</p></blockquote><p><a href="https://lz5z.com/Python%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">参考文章</a> 、 <a href="https://www.cnblogs.com/kangoroo/p/7233709.html">常见问题</a></p>]]></content>
    
    
    <categories>
      
      <category>APScheduler</category>
      
    </categories>
    
    
    <tags>
      
      <tag>APScheduler</tag>
      
      <tag>定时任务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kong快速上手指南</title>
    <link href="/Myblog/2019/04/20/Kong%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E6%8C%87%E5%8D%97/"/>
    <url>/Myblog/2019/04/20/Kong%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<h4 id="Kong简介"><a href="#Kong简介" class="headerlink" title="Kong简介"></a>Kong简介</h4><p>Kong是一个云原生，高效，可扩展的分布式的API网关。自 2015 年在 github 开源后，广泛受到关注，目前已收获 2.11w+ 的 star，其核心价值在于高性能和可扩展性。</p><p>在微服务架构之下，服务被拆的非常零散，降低了耦合度的同时也给服务的统一管理增加了难度。在旧的服务治理体系之下，鉴权，限流，日志，监控等通用功能需要在每个服务中单独实现，这使得系统维护者没有一个全局的视图来统一管理这些功能。API 网关致力于解决的问题便是为微服务纳管这些通用的功能，在此基础上提高系统的可扩展性。微服务搭配上 API 网关，可以使得服务本身更专注于自己的领域，很好地对服务调用者和服务提供者做了隔离。</p><p>Kong 的插件机制是其高可扩展性的根源，Kong 可以很方便地为路由和服务提供各种插件。对于 Kong 来说，诸多功能只需要简单的配置，就可开箱即用。</p><h4 id="Docker-Installation"><a href="#Docker-Installation" class="headerlink" title="Docker Installation"></a>Docker Installation</h4><ol><li><strong>Create a Docker network</strong></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> docker network create kong-net</span><br></code></pre></td></tr></table></figure><ol start="2"><li><strong>Start your database</strong></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> docker run -d --name kong-database \</span><br>              --network=kong-net \<br>              -p 5432:5432 \<br>              -e &quot;POSTGRES_USER=kong&quot; \<br>              -e &quot;POSTGRES_DB=kong&quot; \<br>              postgres:9.6<br></code></pre></td></tr></table></figure><ol start="3"><li><strong>Prepare your database</strong></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> docker run --rm \</span><br>    --network=kong-net \<br>    -e &quot;KONG_DATABASE=postgres&quot; \<br>    -e &quot;KONG_PG_HOST=kong-database&quot; \<br>    -e &quot;KONG_CASSANDRA_CONTACT_POINTS=kong-database&quot; \<br>    kong:latest kong migrations bootstrap<br></code></pre></td></tr></table></figure><ol start="4"><li><strong>Start Kong</strong></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> docker run -d --name kong \</span><br>    --network=kong-net \<br>    -e &quot;KONG_DATABASE=postgres&quot; \<br>    -e &quot;KONG_PG_HOST=kong-database&quot; \<br>    -e &quot;KONG_CASSANDRA_CONTACT_POINTS=kong-database&quot; \<br>    -e &quot;KONG_PROXY_ACCESS_LOG=/dev/stdout&quot; \<br>    -e &quot;KONG_ADMIN_ACCESS_LOG=/dev/stdout&quot; \<br>    -e &quot;KONG_PROXY_ERROR_LOG=/dev/stderr&quot; \<br>    -e &quot;KONG_ADMIN_ERROR_LOG=/dev/stderr&quot; \<br>    -e &quot;KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl&quot; \<br>    -p 8000:8000 \<br>    -p 8443:8443 \<br>    -p 8001:8001 \<br>    -p 8444:8444 \<br>    kong:latest<br></code></pre></td></tr></table></figure><ol start="5"><li><strong>Use Kong</strong></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> curl -i http://localhost:8001/</span><br></code></pre></td></tr></table></figure><h4 id="Kong网关配置"><a href="#Kong网关配置" class="headerlink" title="Kong网关配置"></a>Kong网关配置</h4><p>Kong上游url</p><p><img src="https://stellae.gitee.io/myblog/images/images/kong_01.png" alt="Kong上游url"></p><p>Kong插件配置</p><p><img src="https://stellae.gitee.io/myblog/images/images/kong_02.png" alt="Kong插件配置"></p><p>Kong配置JWT插件</p><p><img src="https://stellae.gitee.io/myblog/images/images/kong_03.png" alt="Kong配置JWT插件"></p><p>请求需要jwt认证的网关需要在请求头上加入<code>&#123;&#39;Authorization&#39;: &#39;Bearer &lt;token&gt;&#39;&#125;</code>，网关会通过jwt插件验证是否有权限访问API接口。</p><h4 id="项目实例"><a href="#项目实例" class="headerlink" title="项目实例"></a>项目实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install PyJWT<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app/utils/kong.py</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> json <span class="hljs-keyword">import</span> loads<br><br><span class="hljs-keyword">import</span> jwt<br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> current_app<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Kong</span>:</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    API网关</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, username, custom_id</span>):</span><br>        self.username = username<br>        self.custom_id = custom_id<br>        self.location = current_app.config[<span class="hljs-string">&#x27;KONG_LOCATION&#x27;</span>]<br>        self.port = current_app.config[<span class="hljs-string">&#x27;KONG_PORT&#x27;</span>]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_consumer</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;查询consumer&quot;&quot;&quot;</span><br>        response = requests.get(<br>            <span class="hljs-string">f&#x27;http://<span class="hljs-subst">&#123;self.location&#125;</span>:<span class="hljs-subst">&#123;self.port&#125;</span>/consumers/<span class="hljs-subst">&#123;self.username&#125;</span>/&#x27;</span>)<br>        <span class="hljs-keyword">return</span> response.status_code == <span class="hljs-number">200</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_consumer</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;注册consumer&quot;&quot;&quot;</span><br>        response = requests.post(<br>            <span class="hljs-string">f&#x27;http://<span class="hljs-subst">&#123;self.location&#125;</span>:<span class="hljs-subst">&#123;self.port&#125;</span>/consumers/&#x27;</span>, &#123;<br>                <span class="hljs-string">&#x27;username&#x27;</span>: self.username,<br>                <span class="hljs-string">&#x27;custom_id&#x27;</span>: self.custom_id<br>            &#125;)<br>        <span class="hljs-comment"># 201-成功创建；409-已存在</span><br>        <span class="hljs-keyword">return</span> response.status_code == <span class="hljs-number">201</span>, response.text<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_consumer_credential</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;使用jwt插件拿到secret、key&quot;&quot;&quot;</span><br>        headers = &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/x-www-form-urlencoded&#x27;</span>&#125;<br>        response = requests.post(<br>            <span class="hljs-string">f&#x27;http://<span class="hljs-subst">&#123;self.location&#125;</span>:<span class="hljs-subst">&#123;self.port&#125;</span>/consumers/<span class="hljs-subst">&#123;self.username&#125;</span>/jwt&#x27;</span>,<br>            headers=headers)<br>        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">201</span>:<br>            result = loads(response.text)<br>            <span class="hljs-keyword">return</span> result[<span class="hljs-string">&#x27;key&#x27;</span>], result[<span class="hljs-string">&#x27;secret&#x27;</span>]<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Failed to create secret and key&quot;</span>)<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_token</span>(<span class="hljs-params">key, secret</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;创建token&quot;&quot;&quot;</span><br>        claims = &#123;<br>            <span class="hljs-string">&#x27;iss&#x27;</span>: key,  <span class="hljs-comment"># 该JWT的签发者，是否使用是可选的；</span><br>            <span class="hljs-string">&#x27;exp&#x27;</span>: int(time.time()) + <span class="hljs-number">86400</span> * <span class="hljs-number">7</span>,  <span class="hljs-comment"># 过期时间</span><br>            <span class="hljs-string">&#x27;nbf&#x27;</span>: int(time.time()),  <span class="hljs-comment"># 如果当前时间在nbf里的时间之前，则Token不被接受</span><br>            <span class="hljs-string">&#x27;iat&#x27;</span>: int(time.time())  <span class="hljs-comment"># 签发时间</span><br>        &#125;<br>        token = jwt.encode(claims, secret, algorithm=<span class="hljs-string">&#x27;HS256&#x27;</span>).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        <span class="hljs-keyword">return</span> token<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">register</span>():</span><br>  kong = Kong(<br>    username=<span class="hljs-string">&#x27;salesman_&#x27;</span> + str(salesman.id),<br>    custom_id=<span class="hljs-string">&#x27;salesman_&#x27;</span> + str(salesman.id))<br>  <span class="hljs-keyword">if</span> kong.get_consumer():<br>    <span class="hljs-keyword">return</span> render_response(<span class="hljs-string">&#x27;consumer已存在&#x27;</span>, <span class="hljs-number">502</span>)<br>  <span class="hljs-comment"># 注册consumer</span><br>  result, _ = kong.create_consumer()<br>  <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login</span>():</span><br>  kong = Kong(<br>    username=<span class="hljs-string">&#x27;user_&#x27;</span> + str(salesman.id),<br>    custom_id=<span class="hljs-string">&#x27;user_&#x27;</span> + str(salesman.id))<br>  <span class="hljs-comment"># 查看是否有该consumer</span><br>  <span class="hljs-keyword">if</span> kong.get_consumer():<br>    <span class="hljs-comment"># 通过网关jwt插件拿到key和secret</span><br>    key, secret = kong.create_consumer_credential()<br>    <span class="hljs-comment"># 登录成功后通过PyJWT生成token</span><br>    token = kong.create_token(key, secret)<br>    <br></code></pre></td></tr></table></figure><p><a href="https://docs.konghq.com/1.1.x/getting-started/quickstart/">KONG Quickstart</a> / <a href="https://docs.konghq.com/hub/kong-inc/jwt/">KONG JWT</a></p>]]></content>
    
    
    <categories>
      
      <category>Kong</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kong</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swagger快速上手指南</title>
    <link href="/Myblog/2019/04/20/Swagger%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E6%8C%87%E5%8D%97/"/>
    <url>/Myblog/2019/04/20/Swagger%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<h4 id="Swagger简介"><a href="#Swagger简介" class="headerlink" title="Swagger简介"></a>Swagger简介</h4><p>Swagger是REST APIs文档生成工具。 主要的工作量应该在于Swagger文档的编写，而文档的编写需要遵循一定的规范，即Swagger API Spec。Swagger API Spec是Swagger用来描述REST API的语言，可以用YAML和JSON表示。</p><p>书写接口描述文档是一件十分痛苦的事情，但是当我们使用Swagger并按照一定规范描述项目接口，可以自动生成接口描述文档，解放生产力。查看Swagger描述文档有两种方式：</p><ol><li>文档默认地址为项目运行根目录。</li><li>打开<code>&lt;https://petstore.swagger.io/&gt;</code> 网址，将项目生成json文件地址填入即可，如<code>&lt;https://xxx.io/api/swagger.json&gt;</code></li></ol><h4 id="Flask-Restplus"><a href="#Flask-Restplus" class="headerlink" title="Flask-Restplus"></a>Flask-Restplus</h4><p>flask-restplus是在flask框架下基于swagger的实现，我们可以使用flask-restplus代替flask-restful，其用法和后者类似，flask-restplus封装了很多方法可以对接口进行修饰。</p><h4 id="项目实例"><a href="#项目实例" class="headerlink" title="项目实例"></a>项目实例</h4><p><code>run.py</code></p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># run.py</span><br><span class="hljs-comment"># 部署项目使用</span><br><span class="hljs-keyword">from</span> gevent.pywsgi <span class="hljs-keyword">import</span> WSGIServer<br><span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> create_app<br><br><br>http_server = WSGIServer((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, int(<span class="hljs-number">5000</span>)), create_app())<br>http_server.serve_forever()<br></code></pre></td></tr></table></figure><p><code>app/__init__.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app/__init__.py</span><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask_migrate <span class="hljs-keyword">import</span> Migrate, upgrade<br><span class="hljs-keyword">from</span> flask_cors <span class="hljs-keyword">import</span> CORS<br><br><span class="hljs-keyword">from</span> .models <span class="hljs-keyword">import</span> db<br><span class="hljs-keyword">from</span> .resources <span class="hljs-keyword">import</span> api_bp<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_app</span>(<span class="hljs-params">test_config=None</span>):</span><br>    app = Flask(__name__, instance_relative_config=<span class="hljs-literal">True</span>)<br>    ctx = app.app_context()<br>    ctx.push()<br><br>    <span class="hljs-comment"># 允许跨域请求</span><br>    CORS(app, supports_credentials=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-comment"># 加载配置文件，需设置配置文件路径</span><br>    app.config.from_object(<span class="hljs-string">&#x27;config.default&#x27;</span>)<br>    app.config.from_envvar(<span class="hljs-string">&#x27;APP_CONFIG_FILE&#x27;</span>)<br><br>    <span class="hljs-comment"># 初始化 db</span><br>    db.init_app(app)<br><br>    <span class="hljs-comment"># 添加blueprint</span><br>    app.register_blueprint(api_bp, url_prefix=<span class="hljs-string">&quot;/api&quot;</span>)<br><br>    <span class="hljs-comment"># 添加 migrate</span><br>    Migrate(app, db)<br><br>    <span class="hljs-comment"># 升级到最新模型</span><br>    upgrade()<br><br>    <span class="hljs-comment"># 设置安全码</span><br>    app.secret_key = app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>]<br>    <span class="hljs-keyword">return</span> app<br></code></pre></td></tr></table></figure><p><code>app/resources/__init__.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app/resources/__init__.py</span><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Blueprint<br><span class="hljs-keyword">from</span> flask_restplus <span class="hljs-keyword">import</span> Api<br><br><span class="hljs-keyword">from</span> .health <span class="hljs-keyword">import</span> api <span class="hljs-keyword">as</span> Health<br><br>api_bp = Blueprint(<span class="hljs-string">&#x27;api&#x27;</span>, __name__)<br>api = Api(api_bp, doc=<span class="hljs-string">&#x27;/doc&#x27;</span>)<br><br><span class="hljs-comment"># 注册namespace</span><br>api.add_namespace(Health)<br></code></pre></td></tr></table></figure><p><code>app/resources/health.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app/resources/health.py</span><br><span class="hljs-keyword">from</span> flask_restplus <span class="hljs-keyword">import</span> Namespace, Resource, fields<br><span class="hljs-keyword">from</span> ..utils.redis_connection <span class="hljs-keyword">import</span> redis_conn<br><br>api = Namespace(<span class="hljs-string">&#x27;health&#x27;</span>, description=<span class="hljs-string">&#x27;backend server health&#x27;</span>)<br><br>model = api.model(<br>    <span class="hljs-string">&#x27;Health&#x27;</span>, &#123;<br>        <span class="hljs-string">&#x27;status&#x27;</span>: fields.String,<br>        <span class="hljs-string">&#x27;mymaster_host&#x27;</span>: fields.String(default=<span class="hljs-string">&#x27;unknown&#x27;</span>),<br>        <span class="hljs-string">&#x27;mymaster_port&#x27;</span>: fields.Integer(default=<span class="hljs-number">0</span>),<br>        <span class="hljs-string">&#x27;redis_client&#x27;</span>: fields.String,<br>    &#125;)<br><br><br><span class="hljs-meta">@api.route(&#x27;&#x27;)</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Health</span>(<span class="hljs-params">Resource</span>):</span><br><span class="hljs-meta">    @api.doc(body=model)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;测试接口&quot;&quot;&quot;</span><br>        sentinel, client = redis_conn()<br>        response_body = &#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;ok&quot;</span>&#125;<br>        sentinel, client = redis_conn()<br>        <span class="hljs-keyword">if</span> sentinel:<br>            host, port = sentinel.discover_master(<span class="hljs-string">&#x27;mymaster&#x27;</span>)<br>            response_body[<span class="hljs-string">&#x27;mymaster_host&#x27;</span>] = host<br>            response_body[<span class="hljs-string">&#x27;mymaster_port&#x27;</span>] = port<br>        <span class="hljs-keyword">if</span> client:<br>            response_body[<span class="hljs-string">&#x27;redis_client&#x27;</span>] = <span class="hljs-string">&#x27;ok&#x27;</span><br>        <span class="hljs-keyword">return</span> response_body, <span class="hljs-number">200</span><br><br></code></pre></td></tr></table></figure><blockquote><ol><li>@api.param(name,description) - 描述接口需要请求参数；</li><li>@api.expect(model) - 描述接口请求体需要model定义参数；</li><li>@api.response(code, decription) - 描述接口请求相应；</li><li>@api.doc(params, body, responses) - 描述接口请求参数，请求体，请求响应等信息。</li></ol></blockquote><p>参考文章 <a href="https://github.com/noirbizarre/flask-restplus">传送门1</a>  <a href="https://towardsdatascience.com/working-with-apis-using-flask-flask-restplus-and-swagger-ui-7cf447deda7f">传送门2</a></p>]]></content>
    
    
    <categories>
      
      <category>Swagger</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Swagger</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Minio对象存储</title>
    <link href="/Myblog/2019/04/20/Minio%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/"/>
    <url>/Myblog/2019/04/20/Minio%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/</url>
    
    <content type="html"><![CDATA[<h4 id="Minio简介"><a href="#Minio简介" class="headerlink" title="Minio简介"></a>Minio简介</h4><p>Minio是GlusterFS创始人之一Anand Babu Periasamy发布新的开源项目。Minio兼容Amason的S3分布式对象存储项目，采用Golang实现，客户端支持Java,Python,Javacript, Golang语言。</p><p>Minio服务端可以工作在Windows,Linux, OS X和FreeBSD上。配置简单，基本是复制可执行程序，单行命令可以运行起来。</p><h4 id="Minio服务器"><a href="#Minio服务器" class="headerlink" title="Minio服务器"></a>Minio服务器</h4><p>要创建具有永久存储的MinIO容器，您需要将本地持久目录从主机操作系统映射到虚拟配置<code>~/.minio</code> 并导出<code>/data</code>目录。 为此，请运行以下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -p 9000:9000 --name minio1 \<br>  -v /mnt/data:/data \<br>  -v /mnt/config:/root/.minio \<br>  minio/minio server /data<br></code></pre></td></tr></table></figure><p><strong>MinIO自定义Access和Secret密钥</strong></p><p>要覆盖MinIO的自动生成的密钥，您可以将Access和Secret密钥设为环境变量。 MinIO允许常规字符串作为Access和Secret密钥。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -p 9000:9000 --name minio1 \<br>  -e &quot;MINIO_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE&quot; \<br>  -e &quot;MINIO_SECRET_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&quot; \<br>  -v /mnt/data:/data \<br>  -v /mnt/config:/root/.minio \<br>  minio/minio server /data<br></code></pre></td></tr></table></figure><h4 id="Minio客户端"><a href="#Minio客户端" class="headerlink" title="Minio客户端"></a>Minio客户端</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">ls       列出文件和文件夹。<br>mb       创建一个存储桶或一个文件夹。<br>cat      显示文件和对象内容。<br>pipe     将一个STDIN重定向到一个对象或者文件或者STDOUT。<br>share    生成用于共享的URL。<br>cp       拷贝文件和对象。<br>mirror   给存储桶和文件夹做镜像。<br>find     基于参数查找文件。<br>diff     对两个文件夹或者存储桶比较差异。<br>rm       删除文件和对象。<br>events   管理对象通知。<br>watch    监听文件和对象的事件。<br>policy   管理访问策略。<br>session  为cp命令管理保存的会话。<br>config   管理mc配置文件。<br>update   检查软件更新。<br>version  输出版本信息。<br></code></pre></td></tr></table></figure><p>mac安装Minio客户端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">brew install minio/stable/mc<br></code></pre></td></tr></table></figure><p>添加hosts</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mc config host add local http://127.0.0.1:9000 xxxx xxxx<br></code></pre></td></tr></table></figure><p>查看 bucket</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mc ls local<br></code></pre></td></tr></table></figure><p>创建 bucket</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mc mb local/&lt;bucket&gt;<br></code></pre></td></tr></table></figure><p>给bucket赋予public权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mc policy public local/&lt;bucket&gt;<br></code></pre></td></tr></table></figure><h4 id="实例：Python上传图片并生成指定大小缩略图，保存到Minio服务器"><a href="#实例：Python上传图片并生成指定大小缩略图，保存到Minio服务器" class="headerlink" title="实例：Python上传图片并生成指定大小缩略图，保存到Minio服务器"></a>实例：Python上传图片并生成指定大小缩略图，保存到Minio服务器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># minio_server.py</span><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> current_app<br><span class="hljs-keyword">from</span> minio <span class="hljs-keyword">import</span> Minio<br><span class="hljs-keyword">from</span> minio.error <span class="hljs-keyword">import</span> ResponseError<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MinioServer</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;Minio Server&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.minio_url = current_app.config[<span class="hljs-string">&#x27;MINIO_URL&#x27;</span>]<br>        self.minio_admin = current_app.config[<span class="hljs-string">&#x27;MINIO_ADMIN&#x27;</span>]<br>        self.minio_access_key = current_app.config[<span class="hljs-string">&#x27;MINIO_ACCESS_KEY&#x27;</span>]<br>        self.minio_secret_key = current_app.config[<span class="hljs-string">&#x27;MINIO_SECRET_KEY&#x27;</span>]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">up_file</span>(<span class="hljs-params">self, new_filename, save_path, content_type</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;上传文件&quot;&quot;&quot;</span><br>        bucket = current_app.config[<span class="hljs-string">&#x27;MINIO_BUCKET&#x27;</span>]  <span class="hljs-comment"># 存储桶名</span><br>        minio_client = Minio(<br>            self.minio_admin,<br>            access_key=self.minio_access_key,<br>            secret_key=self.minio_secret_key,<br>            secure=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># 不启用https</span><br>        <span class="hljs-keyword">try</span>:<br>            minio_client.fput_object(<br>                bucket, new_filename, save_path, content_type=content_type)<br>        <span class="hljs-keyword">except</span> ResponseError <span class="hljs-keyword">as</span> error:<br>            print(error)<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;https://<span class="hljs-subst">&#123;self.minio_url&#125;</span>/<span class="hljs-subst">&#123;bucket&#125;</span>/<span class="hljs-subst">&#123;new_filename&#125;</span>&#x27;</span><br><br></code></pre></td></tr></table></figure><p>上传文件到minio服务器，并生成指定大小缩略图。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># upload_pic.py</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> werkzeug.utils <span class="hljs-keyword">import</span> secure_filename<br><span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> uuid1<br><br><span class="hljs-keyword">from</span> ..utils.minio_server <span class="hljs-keyword">import</span> MinioServer<br><span class="hljs-keyword">from</span> ..utils.thumbnail <span class="hljs-keyword">import</span> gen_thumbnail<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_picture</span>(<span class="hljs-params">file_stream</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成大小两张缩略图上传到Minio服务器&quot;&quot;&quot;</span><br>    filename = secure_filename(file_stream.filename)  <span class="hljs-comment"># 文件名</span><br>    content_type = file_stream.content_type  <span class="hljs-comment"># 文件类型</span><br>    save_path = os.path.join(<span class="hljs-string">&#x27;./&#x27;</span>, filename)<br>    file_stream.save(save_path)  <span class="hljs-comment"># 上传文件到本地</span><br>    uuid_now = uuid1()<br>    gen_thumbnail_pictures = gen_thumbnail(save_path)<br>    <span class="hljs-comment"># 将生成的大小缩略图上传minio</span><br>    thumbnail_list = []<br>    <span class="hljs-keyword">for</span> pic <span class="hljs-keyword">in</span> gen_thumbnail_pictures:<br>        file_prefix, file_extension = os.path.splitext(pic)  <span class="hljs-comment"># 获取文件前后缀</span><br>        split_tup = file_prefix.split(<span class="hljs-string">&#x27;_&#x27;</span>)<br>        width, height = split_tup[<span class="hljs-number">-2</span>], split_tup[<span class="hljs-number">-1</span>]<br>        new_filename = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;uuid_now&#125;</span>_<span class="hljs-subst">&#123;width&#125;</span>*<span class="hljs-subst">&#123;height&#125;</span><span class="hljs-subst">&#123;file_extension&#125;</span>&#x27;</span><br>        minio_server = MinioServer()<br>        url = minio_server.up_file(new_filename, pic, content_type)<br>        thumbnail_list.append(url)<br>    gen_thumbnail_pictures.append(save_path)<br>    <span class="hljs-comment"># 删除临时文件</span><br>    <span class="hljs-keyword">for</span> pic_temp <span class="hljs-keyword">in</span> gen_thumbnail_pictures:<br>        <span class="hljs-keyword">if</span> os.path.exists(pic_temp):<br>            os.remove(pic_temp)<br><br>    <span class="hljs-keyword">return</span> thumbnail_list<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># thumbnail.py</span><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Pool<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">thumbnail</span>(<span class="hljs-params">image_details</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定尺寸缩略图&quot;&quot;&quot;</span><br>    size, path = image_details<br>    image = Image.open(path)<br>    image.thumbnail(size)<br>    file_prefix, file_extension = os.path.splitext(path)  <span class="hljs-comment"># 分割文件前后缀</span><br>    save_path = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;file_prefix&#125;</span>_<span class="hljs-subst">&#123;size[<span class="hljs-number">0</span>]&#125;</span>_<span class="hljs-subst">&#123;size[<span class="hljs-number">1</span>]&#125;</span><span class="hljs-subst">&#123;file_extension&#125;</span>&#x27;</span><br>    image.save(save_path)<br>    <span class="hljs-keyword">return</span> save_path<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_thumbnail</span>(<span class="hljs-params">file_path</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成大小两个尺寸的缩略图&quot;&quot;&quot;</span><br>    sizes = [(<span class="hljs-number">1024</span>, <span class="hljs-number">656</span>), (<span class="hljs-number">600</span>, <span class="hljs-number">384</span>)]<br>    file_path = [file_path] * <span class="hljs-number">2</span><br>    <span class="hljs-comment"># 创建拥有5个进程数量的进程池</span><br>    pool = Pool(<span class="hljs-number">5</span>)<br>    results = pool.map(thumbnail, zip(sizes, file_path))<br>    pool.close()   <span class="hljs-comment"># 确保不会有新的进程加入pool</span><br>    pool.join()<br>    <span class="hljs-keyword">return</span> results<br><br></code></pre></td></tr></table></figure><p>如果要等比缩放，并且空缺地方填白。参考以下代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Pool<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">thumbnail</span>(<span class="hljs-params">image_details</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定尺寸缩略图,并将空缺部分填白&quot;&quot;&quot;</span><br>    size, path = image_details<br>    image = Image.open(path)<br>    aspect_width, aspect_height = size<br>    source_width, source_height = image.size<br>    <span class="hljs-comment"># 判断宽高比</span><br>    <span class="hljs-keyword">if</span> (source_width / source_height) &gt; (aspect_width / aspect_height):<br>        rate = aspect_width / source_width<br>    <span class="hljs-keyword">else</span>:<br>        rate = aspect_height / source_height<br>    rate = round(rate, <span class="hljs-number">1</span>)<br>    image = image.resize((int(source_width * rate), int(source_height * rate)))<br>    <span class="hljs-comment"># 填白</span><br>    result_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, [aspect_width, aspect_height], (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))<br>    result_image.paste(image, (int((aspect_width - image.size[<span class="hljs-number">0</span>]) / <span class="hljs-number">2</span>), int((aspect_height - image.size[<span class="hljs-number">1</span>]) / <span class="hljs-number">2</span>)))<br>    file_prefix, file_extension = os.path.splitext(path)  <span class="hljs-comment"># 分割文件前后缀</span><br>    save_path = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;file_prefix&#125;</span>_<span class="hljs-subst">&#123;image.size[<span class="hljs-number">0</span>]&#125;</span>_<span class="hljs-subst">&#123;image.size[<span class="hljs-number">1</span>]&#125;</span><span class="hljs-subst">&#123;file_extension&#125;</span>&#x27;</span><br>    result_image.save(save_path)<br>    <span class="hljs-keyword">return</span> save_path<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_thumbnail</span>(<span class="hljs-params">file_path</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成大小两个尺寸的缩略图&quot;&quot;&quot;</span><br>    sizes = [(<span class="hljs-number">1013</span>, <span class="hljs-number">650</span>), (<span class="hljs-number">600</span>, <span class="hljs-number">385</span>)]<br>    file_path = [file_path] * <span class="hljs-number">2</span><br>    <span class="hljs-comment"># 创建拥有5个进程数量的进程池</span><br>    pool = Pool(<span class="hljs-number">5</span>)<br>    results = pool.map(thumbnail, zip(sizes, file_path))<br>    pool.close()   <span class="hljs-comment"># 确保不会有新的进程加入pool</span><br>    pool.join()<br>    <span class="hljs-keyword">return</span> results<br></code></pre></td></tr></table></figure><p>本文参考文章 <a href="https://docs.min.io/">Minio官方文档</a> / <a href="https://github.com/minio/minio-py">Github Minio</a></p>]]></content>
    
    
    <categories>
      
      <category>Minio</category>
      
    </categories>
    
    
    <tags>
      
      <tag>minio</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SQLAlchemy快速上手</title>
    <link href="/Myblog/2019/03/16/SQLAlchemy%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/"/>
    <url>/Myblog/2019/03/16/SQLAlchemy%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/</url>
    
    <content type="html"><![CDATA[<h4 id="SQLAlchemy简介"><a href="#SQLAlchemy简介" class="headerlink" title="SQLAlchemy简介"></a>SQLAlchemy简介</h4><p>SQLAlchemy是<a href="http://baike.baidu.com/subview/21087/21087.htm">Python</a>编程语言下的一款ORM框架，该框架建立在数据库API之上，使用关系对象映射进行数据库操作，简言之便是：将对象转换成SQL，然后使用数据API执行SQL并获取执行结果。</p><p>SQLAlchemy本身无法操作数据库，其必须以来pymsql等第三方插件，从而实现对数据库的操作，格式如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># mysql</span><br>pymysql<br>    mysql+pymysql://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;dbname&gt;[?&lt;options&gt;]<br>      <br><span class="hljs-comment"># postgresql</span><br>psycopg2<br>postgresql+psycopg2://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;dbname&gt;<br></code></pre></td></tr></table></figure><h4 id="一-绑定数据库"><a href="#一-绑定数据库" class="headerlink" title="一. 绑定数据库"></a>一. 绑定数据库</h4><p>使用 Engine/ConnectionPooling/Dialect 进行数据库操作，Engine使用ConnectionPooling连接数据库，然后再通过Dialect执行SQL语句。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine<br>  <br>  <br>engine = create_engine(<span class="hljs-string">&quot;mysql+pymysql://root:123@127.0.0.1:3306/t1&quot;</span>, max_overflow=<span class="hljs-number">5</span>)<br>  <br> <br><span class="hljs-comment"># 执行SQL</span><br><span class="hljs-comment"># cur = engine.execute(&#x27;select * from hosts&#x27;)</span><br><span class="hljs-comment"># 获取第一行数据</span><br><span class="hljs-comment"># cur.fetchone()</span><br><span class="hljs-comment"># 获取第n行数据</span><br><span class="hljs-comment"># cur.fetchmany(3)</span><br><span class="hljs-comment"># 获取所有数据</span><br><span class="hljs-comment"># cur.fetchall()</span><br></code></pre></td></tr></table></figure><h4 id="二-ORM映射"><a href="#二-ORM映射" class="headerlink" title="二. ORM映射"></a>二. ORM映射</h4><p>使用 ORM/Schema Type/SQL Expression Language/Engine/ConnectionPooling/Dialect 所有组件对数据进行操作。根据类创建对象，对象转换成SQL，执行SQL。</p><h5 id="单表"><a href="#单表" class="headerlink" title="单表"></a>单表</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sa<br><br><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base<br><br><span class="hljs-comment"># 生成sqlORM基类</span><br>Base = declarative_base()<br>engine = sa.create_engine(<span class="hljs-string">&quot;mysql+pymysql://root:123@127.0.0.1:3306/t1&quot;</span>, max_overflow=<span class="hljs-number">5</span>)<br><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Customer</span>(<span class="hljs-params">Base</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;客户表&quot;&quot;&quot;</span><br>    __tablename__ = <span class="hljs-string">&#x27;tb_customer&#x27;</span><br><br>    id = sa.Column(sa.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>, comment=<span class="hljs-string">&#x27;id&#x27;</span>)<br>    key = sa.Column(sa.String(<span class="hljs-number">256</span>), comment=<span class="hljs-string">&#x27;key&#x27;</span>)<br>    no = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;客户号码&#x27;</span>)<br>    name = sa.Column(sa.String(<span class="hljs-number">1024</span>), comment=<span class="hljs-string">&#x27;个体或公司名字&#x27;</span>)<br>    name_2 = sa.Column(sa.String(<span class="hljs-number">1024</span>), comment=<span class="hljs-string">&#x27;个体或公司名字2&#x27;</span>)<br>    address = sa.Column(sa.String(<span class="hljs-number">1024</span>), comment=<span class="hljs-string">&#x27;公司注册地址&#x27;</span>)<br>    address_2 = sa.Column(sa.String(<span class="hljs-number">1024</span>), comment=<span class="hljs-string">&#x27;公司注册地址2&#x27;</span>)<br>    vat_registration_no = sa.Column(sa.String(<span class="hljs-number">256</span>), comment=<span class="hljs-string">&#x27;税号&#x27;</span>)<br>    post_code = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;邮政编码&#x27;</span>)<br>    county = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;国家&#x27;</span>)<br>    city = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;城市&#x27;</span>)<br>    country_region_code = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;所在国家地区代码&#x27;</span>)<br>    phone_no = sa.Column(sa.String(<span class="hljs-number">256</span>), comment=<span class="hljs-string">&#x27;固定电话&#x27;</span>)<br>    mobile_phone_no = sa.Column(sa.String(<span class="hljs-number">256</span>), comment=<span class="hljs-string">&#x27;手机&#x27;</span>)<br>    fax_no = sa.Column(sa.String(<span class="hljs-number">256</span>), comment=<span class="hljs-string">&#x27;传真&#x27;</span>)<br>    e_mail = sa.Column(sa.String(<span class="hljs-number">256</span>), comment=<span class="hljs-string">&#x27;邮箱&#x27;</span>)<br>    customer_price_group = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;&#x27;</span>)<br>    customer_disc_group = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;&#x27;</span>)<br>    vat_bus_posting_group = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;&#x27;</span>)<br>    payment_method_code = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;付款方式&#x27;</span>)<br>    language_code = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;语言&#x27;</span>)<br>    blocked = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;屏蔽&#x27;</span>)<br>    fecha_creacion = sa.Column(sa.DateTime, comment=<span class="hljs-string">&#x27;客户建立时间&#x27;</span>)<br>    last_date_modified = sa.Column(sa.DateTime, comment=<span class="hljs-string">&#x27;最后一次更改时间&#x27;</span>)<br><br>    <br>    <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_data</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;创建数据库&quot;&quot;&quot;</span><br>    Base.metadata.create_all(engine)<br>    <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">drop_db</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;删除数据库&quot;&quot;&quot;</span><br>    Base.metadata.drop_all(engine)  <br>    <br></code></pre></td></tr></table></figure><h5 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sa<br><br><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base<br><br><span class="hljs-comment"># 生成sqlORM基类</span><br>Base = declarative_base()<br>engine = sa.create_engine(<span class="hljs-string">&quot;mysql+pymysql://root:123@127.0.0.1:3306/t1&quot;</span>, max_overflow=<span class="hljs-number">5</span>)<br>Session = sa.orm.sessionmaker(bind=engine)<br>session = Session()<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Group</span>(<span class="hljs-params">Base</span>):</span><br>    __tablename__ = <span class="hljs-string">&#x27;group&#x27;</span><br>    nid = sa.Column(sa.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>)<br>    caption = sa.Column(sa.String(<span class="hljs-number">32</span>))<br>    <br>    <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">Base</span>):</span><br>    __tablename__ = <span class="hljs-string">&#x27;user&#x27;</span><br>    nid = sa.Column(sa.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>)<br>    username = sa.Column(sa.String(<span class="hljs-number">32</span>))<br>    group_id = sa.Column(sa.Integer, sa.ForeignKey(<span class="hljs-string">&#x27;group.nid&#x27;</span>))<br>    <span class="hljs-comment">#relationship：建立表与表之间的关系方法，此时：建立User表和Group表之间关系，并建立两表关系映射关系u</span><br>    group = sa.orm.relationship(<span class="hljs-string">&quot;Group&quot;</span>, backref=<span class="hljs-string">&#x27;user&#x27;</span>)<span class="hljs-comment">#此时user表示USER表中所有的用户</span><br>    <br>    <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">insert_one_data</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;插入一条数据&quot;&quot;&quot;</span><br>    session.add(Group(caption=<span class="hljs-string">&#x27;dba&#x27;</span>))<br>    session.commit()<br>    <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">insert_datas</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;插入多条数据&quot;&quot;&quot;</span><br>    session.add_all([<br>    User(username=<span class="hljs-string">&#x27;lhj1&#x27;</span>,group_id=<span class="hljs-number">1</span>),<br>    User(username=<span class="hljs-string">&#x27;lhj1&#x27;</span>,group_id=<span class="hljs-number">2</span>),<br>    User(username=<span class="hljs-string">&#x27;lhj1&#x27;</span>,group_id=<span class="hljs-number">2</span>)<br>    ]) <br>    session.commit()<br>    <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">select_table</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;查询数据&quot;&quot;&quot;</span><br>    session.query(User).filter(User.username==<span class="hljs-string">&#x27;lhj1&#x27;</span>).all()<br>    session.query(Users.name,Users.id).all()<br></code></pre></td></tr></table></figure><h5 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span>(<span class="hljs-params">Base</span>):</span><br>    __tablename__ = <span class="hljs-string">&#x27;parent&#x27;</span><br>    id = sa.Column(sa.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    child = sa.orm.relationship(<span class="hljs-string">&quot;Child&quot;</span>, uselist=<span class="hljs-literal">False</span>, back_populates=<span class="hljs-string">&quot;parent&quot;</span>)<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Child</span>(<span class="hljs-params">Base</span>):</span><br>    __tablename__ = <span class="hljs-string">&#x27;child&#x27;</span><br>    id = sa.Column(sa.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    parent_id = sa.Column(sa.Integer, sa.ForeignKey(<span class="hljs-string">&#x27;parent.id&#x27;</span>))<br>    parent = sa.orm.relationship(<span class="hljs-string">&quot;Parent&quot;</span>, back_populates=<span class="hljs-string">&quot;child&quot;</span>)<br></code></pre></td></tr></table></figure><h5 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sa<br><br><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base<br><br><span class="hljs-comment"># 生成sqlORM基类</span><br>Base = sa.declarative_base()<br>engine = create_engine(<span class="hljs-string">&quot;mysql+pymysql://root:123@127.0.0.1:3306/t1&quot;</span>, max_overflow=<span class="hljs-number">5</span>)<br>Session = sa.orm.sessionmaker(bind=engine)<br>session = Session()<br> <br><br>ServerToGroup = sa.Table(<br>    <span class="hljs-string">&quot;servertogroup&quot;</span>,<br>    Base.metadata,<br>    sa.Column(<span class="hljs-string">&quot;id&quot;</span>, sa.Integer, autoincrement=<span class="hljs-literal">True</span>, primary_key=<span class="hljs-literal">True</span>),<br>    sa.Column(<span class="hljs-string">&quot;server_id&quot;</span>, sa.Integer, sa.ForeignKey(<span class="hljs-string">&quot;server.id&quot;</span>), nullable=<span class="hljs-literal">False</span>),<br>    sa.Column(<span class="hljs-string">&quot;group_id&quot;</span>, sa.Integer, sa.ForeignKey(<span class="hljs-string">&quot;group.id&quot;</span>), nullable=<span class="hljs-literal">False</span>)<br>)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Group</span>(<span class="hljs-params">Base</span>):</span><br>    __tablename__ = <span class="hljs-string">&#x27;group&#x27;</span><br>    id = sa.Column(sa.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    name = sa.Column(sa.String(<span class="hljs-number">64</span>), unique=<span class="hljs-literal">True</span>, nullable=<span class="hljs-literal">False</span>)<br>    port = sa.Column(sa.Integer, default=<span class="hljs-number">22</span>)<br>    server = sa.orm.relationship(<span class="hljs-string">&quot;Server&quot;</span>, secondary=ServerToGroup, backref=<span class="hljs-string">&quot;group&quot;</span>)<br> <br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Server</span>(<span class="hljs-params">Base</span>):</span><br>    __tablename__ = <span class="hljs-string">&#x27;server&#x27;</span><br>    id = sa.Column(sa.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>)<br>    hostname = sa.Column(sa.String(<span class="hljs-number">64</span>), unique=<span class="hljs-literal">True</span>, nullable=<span class="hljs-literal">False</span>)<br><br></code></pre></td></tr></table></figure><blockquote><p>执行创建、修改、删除操作需要执行提交操作，对应create() / update() / delete() 方法，update()方法传字典。</p></blockquote><h4 id="三-高级方法运用"><a href="#三-高级方法运用" class="headerlink" title="三. 高级方法运用"></a>三. 高级方法运用</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> func, case, cast, Integer<br></code></pre></td></tr></table></figure><h5 id="cast"><a href="#cast" class="headerlink" title="cast"></a>cast</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">cast(ProductGroup.ordenation_no, Integer)<br></code></pre></td></tr></table></figure><blockquote><p>cast方法用于转换数据类型</p></blockquote><p>sql写法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">cast</span>(ordenation_no <span class="hljs-keyword">as</span> <span class="hljs-built_in">int</span>) <span class="hljs-keyword">from</span> product_group;<br></code></pre></td></tr></table></figure><blockquote><p>整型int或者integer；字符串varchar</p></blockquote><h5 id="concat-ws"><a href="#concat-ws" class="headerlink" title="concat_ws"></a>concat_ws</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">func.concat_ws(<span class="hljs-string">&#x27;,&#x27;</span>, Comment.id, Comment.content)<br></code></pre></td></tr></table></figure><blockquote><p>concat_ws方法可以把多列数据按照指定字符串拼接成一列</p></blockquote><p>sql写法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">concat_ws</span>(<span class="hljs-string">&#x27;,&#x27;</span>, <span class="hljs-keyword">id</span>, <span class="hljs-keyword">content</span>) <span class="hljs-keyword">from</span> <span class="hljs-keyword">comment</span>;<br></code></pre></td></tr></table></figure><h5 id="case"><a href="#case" class="headerlink" title="case"></a>case</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">case([(Comment.created_profile_photo.isnot(<span class="hljs-literal">None</span>), Comment.created_profile_photo)], else_=<span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><blockquote><p>case方法校验指定列数据分别输出</p></blockquote><p>sql写法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> (<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> created_profile_photo <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">then</span> description <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">from</span> <span class="hljs-keyword">comment</span>;<br></code></pre></td></tr></table></figure><blockquote><p>如果有多个条件，加多组when-then即可</p></blockquote><h5 id="array-agg"><a href="#array-agg" class="headerlink" title="array_agg"></a>array_agg</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">comment_sub = db.session.query(<br>     Comment.circle_id, func.array_agg(func.concat_ws(<br>           <span class="hljs-string">&#x27;,&#x27;</span>, Comment.id, Comment.created_name, Comment.comment_content,<br>           case([(Comment.created_profile_photo.isnot(<span class="hljs-literal">None</span>),Comment.created_profile_photo)], else_=<span class="hljs-string">&#x27;&#x27;</span>)<br>     )).label(<span class="hljs-string">&#x27;comment&#x27;</span>), func.count(<span class="hljs-string">&#x27;*&#x27;</span>).label(<span class="hljs-string">&#x27;comment_amount&#x27;</span>)).group_by(Comment.circle_id)<br></code></pre></td></tr></table></figure><blockquote><p>array_agg在group_by后，可以把多条数据组成一个数组输出</p></blockquote><h5 id="unnest"><a href="#unnest" class="headerlink" title="unnest"></a>unnest</h5><p>按照给定数组顺序查询输出：创建临时表，join查询输出。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">products = carouse.sharing_information.split(<span class="hljs-string">&#x27;,&#x27;</span>)<br>order_no_sub = db.session.query(func.unnest(products).label(<span class="hljs-string">&#x27;order_no&#x27;</span>)).subquery()<br>info = db.session.query(order_no_sub.c.order_no, Item.description).join(Item, order_no_sub.c.order_no == Item.no).all()<br></code></pre></td></tr></table></figure><blockquote><p>unnest方法传入数组对象，创建一个由数组内容组成的一列多行的临时表</p></blockquote><p>sql写法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">unnest</span>(<span class="hljs-string">&#x27;&#123;5,1,3,4&#125;&#x27;</span>::<span class="hljs-built_in">int</span>[]) i) l <span class="hljs-keyword">join</span> item <span class="hljs-keyword">on</span> l.i=item.id;<br>或者<br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> item, (<span class="hljs-keyword">select</span> <span class="hljs-keyword">unnest</span>(<span class="hljs-string">&#x27;&#123;5,1,3,4&#125;&#x27;</span>::<span class="hljs-built_in">int</span>[]) i) l <span class="hljs-keyword">where</span> l.i=item.id;<br></code></pre></td></tr></table></figure><ul><li><p><a href="https://golden-note.readthedocs.io/zh/latest/python/sqlalchemy/query.html">sqlalchemy对应方法参考文章</a></p></li><li><p><a href="https://docs.sqlalchemy.org/en/11/orm/query.html#sqlalchemy.orm.query.Query.__init__">官方query API</a></p></li><li><p><a href="https://www.cnblogs.com/lcj0703/p/5709551.html">参考文章</a></p></li></ul><h4 id="四-软删除查询"><a href="#四-软删除查询" class="headerlink" title="四. 软删除查询"></a>四. 软删除查询</h4><p>使用orm查询时自动过滤软删除字段deleted，支持<code>sqlalchemy</code>或者<code>flask_sqlalchemy</code>方式查询</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask_sqlalchemy <span class="hljs-keyword">import</span> SQLAlchemy, BaseQuery<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QueryWithSoftDelete</span>(<span class="hljs-params">BaseQuery</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    查询时过滤掉逻辑删除的数据</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    _with_deleted = <span class="hljs-literal">False</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):</span><br>        obj = super(QueryWithSoftDelete, cls).__new__(cls)<br>        obj._with_deleted = kwargs.pop(<span class="hljs-string">&#x27;_with_deleted&#x27;</span>, <span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">if</span> len(args) &gt; <span class="hljs-number">0</span>:<br>            super(QueryWithSoftDelete, obj).__init__(*args, **kwargs)<br>            <span class="hljs-keyword">return</span> obj.filter_by(<br>                deleted=<span class="hljs-literal">False</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> obj._with_deleted <span class="hljs-keyword">else</span> obj<br>        <span class="hljs-keyword">return</span> obj<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">with_deleted</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">return</span> self.__class__(<br>            db.class_mapper(self._mapper_zero().class_),<br>            session=db.session(),<br>            _with_deleted=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><br>        <span class="hljs-comment"># this calls the original query.get function from the base class</span><br>        <span class="hljs-keyword">return</span> super(QueryWithSoftDelete, self).get(*args, **kwargs)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><br>        <span class="hljs-comment"># the query.get method does not like it if there is a filter clause</span><br>        <span class="hljs-comment"># pre-loaded, so we need to implement it using a workaround</span><br>        obj = self.with_deleted()._get(*args, **kwargs)<br>        not_deleted = obj <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> self._with_deleted <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> obj.deleted<br>        <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">if</span> not_deleted <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>      <br>      <br>db = SQLAlchemy(query_class=QueryWithSoftDelete)    <span class="hljs-comment"># 使用db查询时过滤</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">db.Model</span>):</span><br><br>    <span class="hljs-string">&quot;&quot;&quot;用户表&quot;&quot;&quot;</span><br>    __tablename__ = <span class="hljs-string">&#x27;user&#x27;</span><br>    <br>    query_class = QueryWithSoftDelete    <span class="hljs-comment"># 直接使用flask_sqlalchemy查询过滤</span><br><br>    id = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    name = db.Column(db.String(id), comment=<span class="hljs-string">&quot;name&quot;</span>)<br></code></pre></td></tr></table></figure><blockquote><ul><li><code>__new__</code>：添加需要过滤的字段进行查询，对<code>join</code>和<code>outerjoin</code>都有效，但是不会对被<code>join</code>的表过滤。</li><li><code>get</code> ：针对<code>falsk_sqlalchemy.get</code>方法实现过滤。使用了另外一种方式实现，查询时不过滤，根据查询结果，如果已经软删除，则返回<code>None</code>。</li><li><code>BaseQuery</code>: 这里我们继承<code>flask_sqlalchemy.BaseQuery</code>，如果不需要使用<code>flask_sqlalchemy</code>实现的paginate等方法，继承对象替换为<code>sqlalchemy.orm.Query</code>即可。</li></ul></blockquote>]]></content>
    
    
    <categories>
      
      <category>SQLAlchemy</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SQLAlchemy</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Alembic快速上手</title>
    <link href="/Myblog/2019/03/16/Alembic%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/"/>
    <url>/Myblog/2019/03/16/Alembic%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/</url>
    
    <content type="html"><![CDATA[<h3 id="Alembic-数据库版本化控制"><a href="#Alembic-数据库版本化控制" class="headerlink" title="Alembic - 数据库版本化控制"></a>Alembic - 数据库版本化控制</h3><p>通常我们会将我们的代码放入到某个VCS（版本控制系统）中，进行可追溯的版本管理。一个项目除了代码，通常还会有一个数据库，这个数据库可能会随着项目的演进发生变化，甚至需要可以回滚到过去的某个状态，于是一些工具将数据库的版本化也纳入了管理。</p><p>Alembic 是 Sqlalchemy 的作者实现的一个数据库版本化管理工具，它可以对基于Sqlalchemy的Model与数据库之间的历史关系进行版本化的维护。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">pip install alembic<br></code></pre></td></tr></table></figure><h5 id="1-初始化"><a href="#1-初始化" class="headerlink" title="1. 初始化"></a>1. 初始化</h5><p>在项目根目录运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">alembic init &lt;ALEMBIC_DIR&gt;<br></code></pre></td></tr></table></figure><p>随后在项目目录会新增一个<code>&lt;ALEMBIC_DIR&gt;</code>目录和一个<code>alembic.ini</code>文件，结构如下。</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs applescript">alembic.ini  <span class="hljs-comment"># 提供了一些基本的配置</span><br>ALEMBIC_DIR/<br>    env.py <span class="hljs-comment"># 每次执行Alembic都会加载这个模块，主要提供项目Sqlalchemy Model 的连接</span><br>    README<br>    <span class="hljs-keyword">script</span>.py.mako  <span class="hljs-comment"># 迁移脚本生成模版</span><br>    versions/ <span class="hljs-comment"># 存放生成的迁移脚本目录</span><br></code></pre></td></tr></table></figure><h5 id="2-修改配置"><a href="#2-修改配置" class="headerlink" title="2. 修改配置"></a>2. 修改配置</h5><p>连接数据库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># alembic.ini</span><br><span class="hljs-comment"># Postgresql 配置</span><br>sqlalchemy.url = postgresql+psycopg2://user:<span class="hljs-keyword">pass</span>@<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">5432</span>/db<br></code></pre></td></tr></table></figure><p>修改元信息对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">target_metadata = <span class="hljs-literal">None</span><br>改为<br><br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> os.path <span class="hljs-keyword">import</span> abspath, dirname<br>sys.path.append(dirname(dirname(abspath(__file__))))<br><span class="hljs-keyword">from</span> modules.models <span class="hljs-keyword">import</span> Base<br>target_metadata = Base.metadata<br><br></code></pre></td></tr></table></figure><blockquote><p>1、其中在modules.models是模型对象；2、将项目路径添加到环境变量里面，才能导入包内模块。</p></blockquote><h5 id="3-创建模型"><a href="#3-创建模型" class="headerlink" title="3. 创建模型"></a>3. 创建模型</h5><p>创建<code>modules/models.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sa<br><br><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base<br><br><br>Base = declarative_base()<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostCode</span>(<span class="hljs-params">Base</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;邮政编码表&quot;&quot;&quot;</span><br>    __tablename__ = <span class="hljs-string">&#x27;tb_postcode&#x27;</span><br><br>    id = sa.Column(sa.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>, comment=<span class="hljs-string">&#x27;id&#x27;</span>)<br>    key = sa.Column(sa.String(<span class="hljs-number">256</span>), comment=<span class="hljs-string">&#x27;key&#x27;</span>)<br>    code = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;代号&#x27;</span>)<br>    county = sa.Column(sa.String(<span class="hljs-number">256</span>), comment=<span class="hljs-string">&#x27;国家&#x27;</span>)<br>    city = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;城市&#x27;</span>)<br>    country_region_code = sa.Column(sa.String(<span class="hljs-number">128</span>), comment=<span class="hljs-string">&#x27;地区代号&#x27;</span>)<br><br></code></pre></td></tr></table></figure><h5 id="4-初始化版本以及控制"><a href="#4-初始化版本以及控制" class="headerlink" title="4. 初始化版本以及控制"></a>4. 初始化版本以及控制</h5><p>生成数据库版本和生成迁移脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">alembic revision --autogenerate -m &#x27;initdb&#x27;<br></code></pre></td></tr></table></figure><blockquote><p>—autogenerate 自动生成迁移脚本，-m 标注版本</p></blockquote><p>升级和降级版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">alembic upgrade head # 升级到最新版本<br>alembic downgrade base # 还原到最初版本<br><br>alembic upgrade &lt;version&gt; # 升级到指定版本号<br>alembic downgrade &lt;version&gt; # 降级到指定版本号<br></code></pre></td></tr></table></figure><h4 id="Flask-Migrate"><a href="#Flask-Migrate" class="headerlink" title="Flask-Migrate"></a>Flask-Migrate</h4><p>具体操作参考 <a href="https://flask-migrate.readthedocs.io/en/latest/">文章</a></p>]]></content>
    
    
    <categories>
      
      <category>Alembic</category>
      
    </categories>
    
    
    <tags>
      
      <tag>alembic</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>全文检索</title>
    <link href="/Myblog/2019/01/23/%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2/"/>
    <url>/Myblog/2019/01/23/%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2/</url>
    
    <content type="html"><![CDATA[<h3 id="全文检索简介"><a href="#全文检索简介" class="headerlink" title="全文检索简介"></a>全文检索简介</h3><p>全文检索基于倒排索引进行查找数据。</p><ul><li>倒排索引：源于实际应用中需要根据属性的值来查找记录。这种索引表中的每一项都包括一个属性值和具有该属性值的各记录的地址。由于不是由记录来确定属性值，而是由属性值来确定记录的位置，因而称为倒排索引(inverted index) </li></ul><p><img src="https://stellae.gitee.io/myblog/images/images/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95.jpg"></p><p>全文检索如果要实现高并发，可以使用 ElasticSearch / Solr，使用ElasticSearch有很严重的版本兼容性问题，如果要使用最好使用2.x版本。</p><p>如果要求不高可以使用 Whoosh，中文分词用jieba，相对来说配置更加简单，也没有兼容性问题。</p><h3 id="ElasticSearch-analysis-ik-haystack"><a href="#ElasticSearch-analysis-ik-haystack" class="headerlink" title="ElasticSearch + analysis-ik + haystack"></a>ElasticSearch + analysis-ik + haystack</h3><ul><li><p>ElasticSearch 是基于Java开发的搜索引擎</p></li><li><p>analysis-ik用来做中文分词</p></li><li><p>haystack用于对接搜索引擎</p></li></ul><h4 id="1-docker安装elasticSearch服务器"><a href="#1-docker安装elasticSearch服务器" class="headerlink" title="1. docker安装elasticSearch服务器"></a>1. docker安装elasticSearch服务器</h4><p><code>docker run -d -p 9200:9200 -e &quot;discovery.type=single-node&quot; --name es elasticsearch:2.4.6</code></p><blockquote><p>说明： 9200端口用于访问；<code>discovery.type=single-node</code>指定单机模式</p></blockquote><h4 id="2-安装中文分词插件"><a href="#2-安装中文分词插件" class="headerlink" title="2. 安装中文分词插件"></a>2. 安装中文分词插件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it es /bin/bash<br>mkdir -r plugins/ik<br>cd plugins/ik<br>wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v1.10.6/elasticsearch-analysis-ik-1.10.6.zip<br></code></pre></td></tr></table></figure><p>解压并删除原文件，退出重启es</p><h4 id="3-使用haystack对接Elasticsearch"><a href="#3-使用haystack对接Elasticsearch" class="headerlink" title="3. 使用haystack对接Elasticsearch"></a>3. 使用haystack对接Elasticsearch</h4><p>Haystack为Django提供了模块化的搜索。它的特点是统一的，熟悉的API，可以让你在不修改代码的情况下使用不同的搜索后端（比如 Solr, Elasticsearch, Whoosh, Xapian 等等）。</p><p>我们在django中可以通过使用haystack来调用Elasticsearch搜索引擎。</p><p>1）安装 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install drf-haystack<br>pip install elasticsearch==<span class="hljs-number">2.4</span><span class="hljs-number">.1</span><br></code></pre></td></tr></table></figure><p>drf-haystack是为了在REST framework中使用haystack而进行的封装（如果在Django中使用haystack，则安装django-haystack即可）。 </p><p> 2）注册应用 </p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">INSTALLED_APPS = [<br>    <span class="hljs-string">&#x27;haystack&#x27;</span>,<br>]<br></code></pre></td></tr></table></figure><p>3）配置</p><p>在配置文件中配置haystack使用的搜索引擎后端</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Haystack</span><br>HAYSTACK_CONNECTIONS = &#123;<br>    <span class="hljs-string">&#x27;default&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;haystack.backends.elasticsearch_backend.ElasticsearchSearchEngine&#x27;</span>,<br>        <span class="hljs-string">&#x27;URL&#x27;</span>: <span class="hljs-string">&#x27;http://39.96.51.36:9200/&#x27;</span>,  <span class="hljs-comment"># 此处为elasticsearch运行的服务器ip地址，端口号固定为9200</span><br>        <span class="hljs-string">&#x27;INDEX_NAME&#x27;</span>: <span class="hljs-string">&#x27;fangtx&#x27;</span>,  <span class="hljs-comment"># 指定elasticsearch建立的索引库的名称</span><br>    &#125;,<br>&#125;<br><br><span class="hljs-comment"># 当添加、修改、删除数据时，自动生成索引</span><br>HAYSTACK_SIGNAL_PROCESSOR = <span class="hljs-string">&#x27;haystack.signals.RealtimeSignalProcessor&#x27;</span><br></code></pre></td></tr></table></figure><p>4）创建索引类 </p><p>通过创建索引类，来指明让搜索引擎对哪些字段建立索引，也就是可以通过哪些字段的关键字来检索数据。</p><p>在api应用中新建search_indexes.py文件，用于存放索引类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">搜索引擎索引类</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> haystack <span class="hljs-keyword">import</span> indexes<br><br><span class="hljs-keyword">from</span> common.models <span class="hljs-keyword">import</span> HouseInfo<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HouseInfoIndex</span>(<span class="hljs-params">indexes.SearchIndex, indexes.Indexable</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;房源全文检索索引&quot;&quot;&quot;</span><br><br>    text = indexes.CharField(document=<span class="hljs-literal">True</span>, use_template=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_model</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">return</span> HouseInfo<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index_queryset</span>(<span class="hljs-params">self, using=None</span>):</span><br>        <span class="hljs-keyword">return</span> self.get_model().objects.all()<br></code></pre></td></tr></table></figure><p>5）在templates目录中创建text字段使用的模板文件 </p><p>具体在templates/search/indexes/common/houseinfo_text.txt文件中定义 </p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">&#123;&#123; object.title &#125;&#125;<br>&#123;&#123; object.detail &#125;&#125;<br></code></pre></td></tr></table></figure><blockquote><p>说明：common为模型所在app；houseinfo_text.txt为对应查询模型</p></blockquote><p>6）手动生成初始索引 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">python manage.py rebuild_index<br><span class="hljs-comment"># python manage.py haystack_info 查看索引</span><br></code></pre></td></tr></table></figure><p>7）创建序列化器 </p><p>在api/serializers.py中创建haystack序列化器 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> drf_haystack.serializers <span class="hljs-keyword">import</span> HaystackSerializer<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HouseInfoSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span><br>        model = HouseInfo<br>        fields = <span class="hljs-string">&#x27;__all__&#x27;</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HouseInfoIndexSerializer</span>(<span class="hljs-params">HaystackSerializer</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;房源全文检索数据序列化器&quot;&quot;&quot;</span><br><br>    object = HouseInfoSerializer(read_only=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 指定数据来源</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span>(<span class="hljs-params">self, instance, validated_data</span>):</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span>(<span class="hljs-params">self, validated_data</span>):</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span><br>        index_classes = [HouseInfoIndex]  <span class="hljs-comment"># Model+Index</span><br>        fields = (<span class="hljs-string">&#x27;text&#x27;</span>, <span class="hljs-string">&#x27;object&#x27;</span>)<br></code></pre></td></tr></table></figure><p>通过上面的序列化类，返回的结果形式如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json">[<br>    &#123;<br>        <span class="hljs-attr">&quot;text&quot;</span>: <span class="hljs-string">&quot;华为 HUAWEI P10 Plus 6GB+128GB 钻雕蓝 移动联通电信4G手机 双卡双待\nwifi双天线设计！徕卡人像摄影！P10徕卡双摄拍照，低至2988元！\n11&quot;</span>,<br>        <span class="hljs-attr">&quot;object&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">11</span>,<br>            <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;华为 HUAWEI P10 Plus 6GB+128GB 钻雕蓝 移动联通电信4G手机 双卡双待&quot;</span>,<br>            <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-string">&quot;3788.00&quot;</span>,<br>            <span class="hljs-attr">&quot;default_image_url&quot;</span>: <span class="hljs-string">&quot;http://image.meiduo.site:8888/group1/M00/00/02/CtM3BVrRdG6AYdapAAcPaeOqMpA1594598&quot;</span>,<br>            <span class="hljs-attr">&quot;comments&quot;</span>: <span class="hljs-number">2</span><br>        &#125;<br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">&quot;text&quot;</span>: <span class="hljs-string">&quot;华为 HUAWEI P10 Plus 6GB+128GB 玫瑰金 移动联通电信4G手机 双卡双待\nwifi双天线设计！徕卡人像摄影！P10徕卡双摄拍照，低至2988元！\n14&quot;</span>,<br>        <span class="hljs-attr">&quot;object&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">14</span>,<br>            <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;华为 HUAWEI P10 Plus 6GB+128GB 玫瑰金 移动联通电信4G手机 双卡双待&quot;</span>,<br>            <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-string">&quot;3788.00&quot;</span>,<br>            <span class="hljs-attr">&quot;default_image_url&quot;</span>: <span class="hljs-string">&quot;http://image.meiduo.site:8888/group1/M00/00/02/CtM3BVrRdMSAaDUtAAVslh9vkK04466364&quot;</span>,<br>            <span class="hljs-attr">&quot;comments&quot;</span>: <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>]<br><br></code></pre></td></tr></table></figure><p>8）创建视图 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchViewSet</span>(<span class="hljs-params">HaystackViewSet</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;全文检索视图类&quot;&quot;&quot;</span><br>    index_models = [HouseInfo]   <span class="hljs-comment"># model</span><br>    serializer_class = HouseInfoIndexSerializer<br></code></pre></td></tr></table></figure><p>9）定义路由 </p><p>通过REST framework的router来定义路由 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework.routers <span class="hljs-keyword">import</span> DefaultRouter<br><span class="hljs-keyword">from</span> api.views <span class="hljs-keyword">import</span> SearchViewSet<br><br>router = DefaultRouter()<br>router.register(<span class="hljs-string">&#x27;search&#x27;</span>, SearchViewSet, base_name=<span class="hljs-string">&#x27;search&#x27;</span>)<br>urlpatterns += router.urls<br></code></pre></td></tr></table></figure><p>10）测试 </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1:8080</span>/api/search/?text=%E<span class="hljs-number">5</span>%<span class="hljs-number">9</span>C%B<span class="hljs-number">0</span>%E<span class="hljs-number">9</span>%<span class="hljs-number">93</span>%<span class="hljs-number">81</span><br></code></pre></td></tr></table></figure><p>到这里应该就神功大成了！</p>]]></content>
    
    
    <categories>
      
      <category>全文检索</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
      <tag>全文检索</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Djangorestframework</title>
    <link href="/Myblog/2019/01/16/Djangorestframework/"/>
    <url>/Myblog/2019/01/16/Djangorestframework/</url>
    
    <content type="html"><![CDATA[<h2 id="Djangorestframework使用"><a href="#Djangorestframework使用" class="headerlink" title="Djangorestframework使用"></a>Djangorestframework使用</h2><p>查看<a href="https://www.django.cn/course/show-20.html">Djangorestframework中文文档</a></p><p>补充：Django中使用模型查表，需要进行优化：</p><ul><li>查询后面加上only() / defer() - 只查/不查</li><li>查询关联关系时，如果不加上限定语句，会出现1+N现象，导致查询效率十分低下<ol><li>一对多：select_related(‘xxx’)</li><li>多对多：prefetch_related(‘xxx’)</li></ol></li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> djangorestframework<br></code></pre></td></tr></table></figure><h4 id="settings-py配置修改"><a href="#settings-py配置修改" class="headerlink" title="settings.py配置修改"></a>settings.py配置修改</h4><p>在工程目录中的settings.py文件的INSTALLED_APPS中需要添加rest_framework</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">INSTALLED_APPS</span> = [<br>    <span class="hljs-string">&#x27;rest_framework&#x27;</span>,<br>]<br></code></pre></td></tr></table></figure><h4 id="自定义序列化类"><a href="#自定义序列化类" class="headerlink" title="自定义序列化类"></a>自定义序列化类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> serializers<br><br><span class="hljs-keyword">from</span> common.models <span class="hljs-keyword">import</span> District<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DistrictSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span><br>        <span class="hljs-comment"># 指定序列化的模型</span><br>        model = District<br>        <span class="hljs-comment"># 序列化字段</span><br>        fields = (<span class="hljs-string">&#x27;distid&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>)<br>        <span class="hljs-comment"># 如果需要序列化所有字段</span><br>        <span class="hljs-comment"># fields = &#x27;__all__&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="序列化类中自定义序列化对象"><a href="#序列化类中自定义序列化对象" class="headerlink" title="序列化类中自定义序列化对象"></a>序列化类中自定义序列化对象</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> serializers<br><br><span class="hljs-keyword">from</span> common.models <span class="hljs-keyword">import</span> District<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DistrictDetailSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span><br>    <span class="hljs-comment"># 自定义序列化对象</span><br>    cities = serializers.SerializerMethodField()<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_cities</span>(<span class="hljs-params">district</span>):</span><br>        <span class="hljs-comment"># district代表传入的当前序列化对象</span><br>        <span class="hljs-comment"># 自定义函数名必须要叫对应的get_cities</span><br>        queryset = District.objects.filter(parent__distid=district.distid).only(<span class="hljs-string">&#x27;distid&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>)<br>        <span class="hljs-comment"># results = []</span><br>        <span class="hljs-comment"># for city in queryset:</span><br>        <span class="hljs-comment">#     results.append(DistrictSerializer(city).data)</span><br>        <span class="hljs-comment"># return results</span><br>        <span class="hljs-keyword">return</span> DistrictSerializer(queryset, many=<span class="hljs-literal">True</span>).data<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span><br>        model = District<br>        fields = (<span class="hljs-string">&#x27;distid&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;intro&#x27;</span>, <span class="hljs-string">&#x27;cities&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="返回接口数据"><a href="#返回接口数据" class="headerlink" title="返回接口数据"></a>返回接口数据</h4><h5 id="基于函数的视图-FBV-Function-Based-View"><a href="#基于函数的视图-FBV-Function-Based-View" class="headerlink" title="基于函数的视图 - FBV - Function-Based View"></a>基于函数的视图 - FBV - Function-Based View</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.views.decorators.cache <span class="hljs-keyword">import</span> cache_page<br><span class="hljs-keyword">from</span> rest_framework.decorators <span class="hljs-keyword">import</span> api_view, throttle_classes<br><span class="hljs-keyword">from</span> rest_framework.response <span class="hljs-keyword">import</span> Response<br><br><span class="hljs-keyword">from</span> common.models <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> api.queryset <span class="hljs-keyword">import</span> DistrictSerializer, DistrictDetailSerializer<br><br><br><span class="hljs-meta">@api_view([&#x27;GET&#x27;, &#x27;POST&#x27;]) # 指定视图函数支持方式，发送post请求免除csrf令牌</span><br><span class="hljs-meta">@cache_page(timeout=None, cache=&#x27;api&#x27;)   # cache=&#x27;api&#x27;指使用什么缓存</span><br><span class="hljs-meta">@throttle_classes(())   # 设置不被限流</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">provinces</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-comment"># 通过ORM框架从数据库中获取数据(资源)</span><br>    queryset = District.objects.filter(parent__isnull=<span class="hljs-literal">True</span>).only(<span class="hljs-string">&#x27;distid&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>)<br>    <span class="hljs-comment"># 通过自定义序列化类序列化数据</span><br>    serializer = DistrictSerializer(queryset, many=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 通过序列化器获得序列化之后的数据(字典或列表)，生成响应</span><br>    <span class="hljs-keyword">return</span> Response(serializer.data)<br><br><br><span class="hljs-meta">@api_view([&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="hljs-meta">@cache_page(timeout=None, cache=&#x27;api&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cities</span>(<span class="hljs-params">request, distid</span>):</span><br>    queryset = District.objects.filter(distid=distid).only(<span class="hljs-string">&#x27;distid&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>).first()<br>    serializer = DistrictDetailSerializer(queryset)<br>    <span class="hljs-keyword">return</span> Response(serializer.data)<br></code></pre></td></tr></table></figure><blockquote><p>说明：</p><ol><li><p><code>@api_view([&#39;GET&#39;, &#39;POST&#39;])</code>指定方式；</p></li><li><p><code>@cache_page(timeout=None, cache=&#39;api&#39;)</code>指定使用缓存和超时时间；</p></li><li><p><code>@throttle_classes(())</code>设置当前接口不被限流。</p></li></ol></blockquote><h5 id="基于类的视图-CBV-Class-Based-View"><a href="#基于类的视图-CBV-Class-Based-View" class="headerlink" title="基于类的视图 - CBV - Class-Based View"></a>基于类的视图 - CBV - Class-Based View</h5><ol><li>继承APIView及其子类(ListAPIView / CreateAPIView / …) </li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 视图函数</span><br>ListAPIView.as_view()<br></code></pre></td></tr></table></figure><ol start="2"><li>继承ModelViewSet / ReadOnlyModelViewSet - 视图函数</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 注册路由</span><br><span class="hljs-keyword">from</span> rest_framework.routers <span class="hljs-keyword">import</span> DefaultRouter<br><span class="hljs-keyword">from</span> api.views <span class="hljs-keyword">import</span> HouseTypeViewSet<br><br>router = DefaultRouter()<br>router.register(<span class="hljs-string">&#x27;housetypes&#x27;</span>, HouseTypeViewSet)<br>urlpatterns += router.urls<br></code></pre></td></tr></table></figure><p>实例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.utils.decorators <span class="hljs-keyword">import</span> method_decorator<br><span class="hljs-keyword">from</span> django.views.decorators.cache <span class="hljs-keyword">import</span> cache_page<br><span class="hljs-keyword">from</span> rest_framework.generics <span class="hljs-keyword">import</span> ListAPIView, CreateAPIView, UpdateAPIView, DestroyAPIView<br><span class="hljs-keyword">from</span> rest_framework.viewsets <span class="hljs-keyword">import</span> ModelViewSet<br><span class="hljs-keyword">from</span> rest_framework_extensions.cache.mixins <span class="hljs-keyword">import</span> CacheResponseMixin<br><br><span class="hljs-keyword">from</span> common.models <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> api.queryset <span class="hljs-keyword">import</span> DistrictSerializer, DistrictDetailSerializer, EstateDetailSerializer, HouseTypeSerializer<br><br><span class="hljs-comment"># @method_decorator(cache_page(timeout=30, cache=&#x27;api&#x27;), name=&#x27;get&#x27;)  # 将装饰函数的装饰器变成装饰类下对应方法的装饰器</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EstateView</span>(<span class="hljs-params">CacheResponseMixin,</span></span><br><span class="hljs-class"><span class="hljs-params">                 ListAPIView,</span></span><br><span class="hljs-class"><span class="hljs-params">                 CreateAPIView,</span></span><br><span class="hljs-class"><span class="hljs-params">                 UpdateAPIView,</span></span><br><span class="hljs-class"><span class="hljs-params">                 DestroyAPIView</span>):</span><br>    queryset = Estate.objects.all().prefetch_related(<span class="hljs-string">&#x27;agents&#x27;</span>).select_related(<span class="hljs-string">&#x27;district&#x27;</span>)<br>    serializer_class = EstateDetailSerializer<br><br><br><span class="hljs-comment"># @method_decorator(cache_page(timeout=30, cache=&#x27;api&#x27;), name=&#x27;list&#x27;)  # 将装饰函数的装饰器变成装饰类下对应方法的装饰器</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HouseTypeViewSet</span>(<span class="hljs-params">CacheResponseMixin, ModelViewSet</span>):</span><br>    queryset = HouseType.objects.all()<br>    serializer_class = HouseTypeSerializer<br>    pagination_class = <span class="hljs-literal">None</span>   <span class="hljs-comment"># 指定不分页</span><br></code></pre></td></tr></table></figure><blockquote><p>说明：</p><ol><li><p><code>@method_decorator(cache_page(timeout=30, cache=&#39;api&#39;), name=&#39;get&#39;)</code>将类下面的指定请求方法设置缓存;</p></li><li><p>继承<code>ListAPIView, CreateAPIView, UpdateAPIView, DestroyAPIView</code>的CBV，接口对应拥有查看，创建，更新，删除方法；</p></li><li><p>继承<code>ModelViewSet</code>的CBV，接口拥有所有方法。其它类自定查找。</p></li><li><p>继承<code>CacheResponseMixin</code>的CBV，指定使用缓存，需要安装<code>drf-extensions</code>库支持，并进行下面配置；</p></li><li><p><code>queryset，serializer_class</code>分别对应重写的序列化对象和类。</p></li></ol></blockquote><p>安装<code>pip install drf-extensions</code>，配置下文<code>REST_FRAMEWORK_EXTENSIONS</code>的信息。</p><h4 id="设置缓存"><a href="#设置缓存" class="headerlink" title="设置缓存"></a>设置缓存</h4><ul><li>Django - <code>@cache_page</code> /  <code>@method_decorator</code></li><li>drf-extensions</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-comment"># 配置DRF扩展来支持缓存API接口调用结果</span><br>REST_FRAMEWORK_EXTENSIONS = &#123;<br>    <span class="hljs-comment"># 设置缓存超时时间</span><br>    <span class="hljs-string">&#x27;DEFAULT_CACHE_RESPONSE_TIMEOUT&#x27;</span>: <span class="hljs-number">300</span>,<br>    <span class="hljs-comment"># 设置默认缓存</span><br>    <span class="hljs-string">&#x27;DEFAULT_USE_CACHE&#x27;</span>: <span class="hljs-string">&#x27;api&#x27;</span>,<br>    <span class="hljs-comment"># 配置默认缓存单个对象的key函数</span><br>    <span class="hljs-string">&#x27;DEFAULT_OBJECT_CACHE_KEY_FUNC&#x27;</span>: <span class="hljs-string">&#x27;rest_framework_extensions.utils.default_object_cache_key_func&#x27;</span>,<br>    <span class="hljs-comment"># 配置默认缓存对象列表的key函数</span><br>    <span class="hljs-string">&#x27;DEFAULT_LIST_CACHE_KEY_FUNC&#x27;</span>: <span class="hljs-string">&#x27;rest_framework_extensions.utils.default_list_cache_key_func&#x27;</span>,<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="分页和节流"><a href="#分页和节流" class="headerlink" title="分页和节流"></a>分页和节流</h4><p>配置信息只对CBV有效</p><p>节流需要使用redis - 将访问者IP设置为key</p><ul><li>全局分页和节流配置：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">REST_FRAMEWORK = &#123;<br>    <span class="hljs-comment"># 配置默认页面大小</span><br>    <span class="hljs-string">&#x27;PAGE_SIZE&#x27;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-comment"># 配置默认的分页类</span><br>    <span class="hljs-string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="hljs-string">&#x27;rest_framework.pagination.PageNumberPagination&#x27;</span>,<br>    <br>    <span class="hljs-comment"># 设置节流类型</span><br>    <span class="hljs-string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (<br>        <span class="hljs-string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,<br>        <span class="hljs-comment"># &#x27;rest_framework.throttling.UserRateThrottle&#x27;</span><br>    ),<br>    <span class="hljs-comment"># 设置节流频率</span><br>    <span class="hljs-string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;anon&#x27;</span>: <span class="hljs-string">&#x27;3/min&#x27;</span>,<br>        <span class="hljs-comment"># &#x27;user&#x27;: &#x27;10000/day&#x27;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>自定义限流：继承BaseThrottle - allow_request() / wait()</li><li>自定义分页：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework.pagination <span class="hljs-keyword">import</span> PageNumberPagination<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomPagination</span>(<span class="hljs-params">PageNumberPagination</span>):</span><br>    <span class="hljs-comment"># 默认每页大小</span><br>    page_size = <span class="hljs-number">10</span><br>    <span class="hljs-comment"># 接受请求参数</span><br>    page_size_query_param = <span class="hljs-string">&#x27;size&#x27;</span><br>    <span class="hljs-comment"># 最大每页大小</span><br>    max_page_size = <span class="hljs-number">50</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># CBV中设置字段</span><br>pagination_class = CustomPagination<br></code></pre></td></tr></table></figure><h4 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h4><p>安装第三方库<code>django-filter</code>，查看<a href="https://django-filter.readthedocs.io/en/master/guide/rest_framework.html">官文</a>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">INSTALLED_APPS = [<br><span class="hljs-string">&#x27;django_filters&#x27;</span>,<br>]<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># CBV设置字段</span><br><span class="hljs-keyword">from</span> django_filters.rest_framework <span class="hljs-keyword">import</span> DjangoFilterBackend<br><span class="hljs-keyword">from</span> rest_framework.filters <span class="hljs-keyword">import</span> OrderingFilter<br><br>filter_backends = (DjangoFilterBackend, OrderingFilter)   <span class="hljs-comment"># 过滤器 / 排序器</span><br>filter_fields = (<span class="hljs-string">&#x27;district&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>)   <span class="hljs-comment"># 过滤字段 - 精确匹配</span><br><span class="hljs-comment"># filter_class = EstateFilter    # 自定义过滤器过滤字段</span><br>ordering = (<span class="hljs-string">&#x27;-hot&#x27;</span>, <span class="hljs-string">&#x27;estateid&#x27;</span>)   <span class="hljs-comment"># 默认查询的排序</span><br>ordering_fields = (<span class="hljs-string">&#x27;hot&#x27;</span>, )      <span class="hljs-comment"># 指定可选排序字段</span><br></code></pre></td></tr></table></figure><p>自定义过滤 - 实现模糊匹配</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django_filters.rest_framework <span class="hljs-keyword">import</span> FilterSet, CharFilter, NumberFilter<br><br><span class="hljs-keyword">from</span> common.models <span class="hljs-keyword">import</span> Estate<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EstateFilter</span>(<span class="hljs-params">FilterSet</span>):</span><br>    name = CharFilter(lookup_expr=<span class="hljs-string">&#x27;startswith&#x27;</span>)   <span class="hljs-comment"># 支持以关键字开头的模糊查询</span><br>    district = NumberFilter(lookup_expr=<span class="hljs-string">&#x27;in&#x27;</span>)  <span class="hljs-comment"># 集合中查询</span><br>    <span class="hljs-comment"># min_price = NumberFilter(field_name=&quot;price&quot;, lookup_expr=&#x27;gte&#x27;) </span><br>    <span class="hljs-comment"># max_price = NumberFilter(field_name=&quot;price&quot;, lookup_expr=&#x27;lte&#x27;)</span><br>    <span class="hljs-comment"># 指定字段为price，不写默认和字段相同</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span><br>        model = Estate<br>        fields = (<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;district&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># CBV设置字段</span><br><span class="hljs-comment"># filter_fields = (&#x27;district&#x27;, &#x27;name&#x27;)   # 过滤字段 - 精确匹配</span><br>filter_class = EstateFilter    <span class="hljs-comment"># 自定义过滤器过滤字段</span><br></code></pre></td></tr></table></figure><h4 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h4><ul><li>FBV设置方式</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># FBV加装饰器</span><br><span class="hljs-keyword">from</span> rest_framework.decorators <span class="hljs-keyword">import</span> authentication_classes<br><br><span class="hljs-meta">@authentication_classes((CustomAuthentication, ))</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">estate</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework.authentication <span class="hljs-keyword">import</span> BaseAuthentication<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomAuthentication</span>(<span class="hljs-params">BaseAuthentication</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;身份认证&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authenticate</span>(<span class="hljs-params">self, request</span>):</span><br>        token = request.META.get(<span class="hljs-string">&#x27;HTTP_TOKEN&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)   <span class="hljs-comment"># 请求头中发送token字段</span><br>        <span class="hljs-comment"># token = request.GET.get(&#x27;token&#x27;, &#x27;&#x27;)    # 请求参数发送token字段</span><br>        <span class="hljs-keyword">if</span> token:<br>            user_token = UserToken.objects.filter(token=token).first()<br>            <span class="hljs-keyword">if</span> user_token:<br>                <span class="hljs-comment"># 这里需要返回二元组前者绑定request.user, request.auth</span><br>                <span class="hljs-keyword">return</span> user_token.user, user_token   <br>        <span class="hljs-keyword">raise</span> AuthenticationFailed(<span class="hljs-string">&#x27;请提供有效的用户身份标识&#x27;</span>)<br></code></pre></td></tr></table></figure><ul><li>CBV设置方式</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"> <span class="hljs-comment"># CBV设置字段</span><br>authentication_classes = (CustomAuthentication, )<br></code></pre></td></tr></table></figure><h4 id="权限验证"><a href="#权限验证" class="headerlink" title="权限验证"></a>权限验证</h4><ul><li>RBAC - Role-Based Access Control  基于角色的访问控制</li><li>ACL - Access Control List  访问控制列表</li></ul><p>这里我们采用RBAC模式，进行权限验证需要设计对应的权限表，下面是简单的权限表设计结构：</p><p><img src="https://stellae.gitee.io/myblog/images/images/TIM%E5%9B%BE%E7%89%8720190118145639.png"></p><p>复杂的权限表设计结构：</p><p><img src="https://stellae.gitee.io/myblog/images/images/TIM%E5%9B%BE%E7%89%8720190118145649.png"></p><ul><li>FBV设置方式</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># FBV加装饰器</span><br><span class="hljs-keyword">from</span> rest_framework.decorators <span class="hljs-keyword">import</span> permission_classes<br><br><span class="hljs-meta">@permission_classes((CustomAuthentication), )</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">estate</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework.permissions <span class="hljs-keyword">import</span> BasePermission<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomPermission</span>(<span class="hljs-params">BasePermission</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;自定义权限类&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">has_permission</span>(<span class="hljs-params">self, request, view</span>):</span><br>        <span class="hljs-keyword">if</span> getattr(request.user, <span class="hljs-string">&#x27;roles&#x27;</span>, <span class="hljs-literal">None</span>):<br>            <span class="hljs-keyword">for</span> role <span class="hljs-keyword">in</span> request.user.roles.all().prefetch_related(<span class="hljs-string">&#x27;privileges&#x27;</span>):<br>                <span class="hljs-keyword">for</span> priv <span class="hljs-keyword">in</span> role.privileges.all():<br>                    <span class="hljs-keyword">if</span> priv.method == request.method <span class="hljs-keyword">and</span> request.path.startswith(priv.url):<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><ul><li>CBV设置方式</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"> <span class="hljs-comment"># CBV设置字段</span><br>permission_classes = (CustomPermisson,)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>djangorestframework</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RESTful简述</title>
    <link href="/Myblog/2019/01/14/RESTful%E7%AE%80%E8%BF%B0/"/>
    <url>/Myblog/2019/01/14/RESTful%E7%AE%80%E8%BF%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="REST（Representational-State-Transfer-）"><a href="#REST（Representational-State-Transfer-）" class="headerlink" title="REST（Representational State Transfer ）"></a>REST（Representational State Transfer ）</h2><p>REST翻译是”表现层状态转化” ，是所有Web应用都应该遵守的架构设计指导原则。 </p><p><strong>REST核心: 资源， 状态转移， 统一接口</strong> </p><p><strong>资源:</strong> 是REST最明显的特征,是指对某类信息实体的抽象，资源是服务器上一个可命名的抽象概念，资源是以名词为核心来组织的，首先关注的是名词。</p><p><strong>状态转移:</strong> 是指客户端痛服务端进行交互的过程中，客户端能够通过对资源的表述，实现操作资源的目的</p><p><strong>统一接口:</strong> REST要求，必须通过统一的接口来对资源执行各种操作。对于每个资源只能执行一组有限的操作。 比如，客户端通过HTTP的4个请求方式(POST, GET, PUT, PATCH)来操作资源，也就意味着不管你的url是什么，不管请求的资源是什么但操作的资源接口都是统一的。</p><p>GET用来获取资源，POST用来新建资源（也可以用于更新资源），PUT(PATCH)用来更新资源，DELETE用来删除资源。 </p><p>本文参考阮一峰老师的文章：<a href="http://www.ruanyifeng.com/blog/2011/09/restful.html">《理解RESTful架构》</a> <a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">《RESTful API 设计指南》</a> <a href="http://www.ruanyifeng.com/blog/2018/10/restful-api-best-practices.html">《RESTful API 最佳实践》</a></p><h3 id="API设计"><a href="#API设计" class="headerlink" title="API设计"></a>API设计</h3><p>为移动端或者PC端设计网络API接口一个非常重要的原则是：<strong>根据业务实体而不是用户界面或操作来设计</strong>。如果API接口的设计是根据用户的操作或者界面上的功能设置来设计，随着需求的变更，用户界面也会进行调整，需要的数据也在发生变化，那么后端开发者就要不停的调整API，或者给一个API设计出多个版本，这些都会使项目的开发和维护成本增加。  </p><h4 id="1-API定义规范"><a href="#1-API定义规范" class="headerlink" title="1. API定义规范"></a>1. API定义规范</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>xxx.com<span class="hljs-regexp">/api/</span><br></code></pre></td></tr></table></figure><h4 id="2-路径"><a href="#2-路径" class="headerlink" title="2. 路径"></a>2. 路径</h4><p>在RESTful架构中，每个网址代表一种资源（resource），所以网址中不能有动词，只能有名词，而且所用的名词往往与数据库的表格名对应。一般来说，数据库中的表都是同种记录的”集合”（collection），所以API中的名词也应该使用复数。</p><p>举例来说，有一个API提供动物园（zoo）的信息，还包括各种动物和雇员的信息，则它的路径应该设计成下面这样。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>api.example.com<span class="hljs-regexp">/v1/</span>zoos<br><br>https:<span class="hljs-regexp">//</span>api.example.com<span class="hljs-regexp">/v1/</span>animals<br><br>https:<span class="hljs-regexp">//</span>api.example.com<span class="hljs-regexp">/v1/</span>employees<br></code></pre></td></tr></table></figure><h4 id="3-HTTP动词"><a href="#3-HTTP动词" class="headerlink" title="3. HTTP动词"></a>3. HTTP动词</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">GET</span>（<span class="hljs-keyword">SELECT</span>）：从服务器取出资源（一项或多项）。<br>POST（<span class="hljs-keyword">CREATE</span>）：在服务器新建一个资源。<br>PUT（<span class="hljs-keyword">UPDATE</span>）：在服务器更新资源（客户端提供改变后的完整资源）。<br>PATCH（<span class="hljs-keyword">UPDATE</span>）：在服务器更新资源（客户端提供改变的属性）。<br><span class="hljs-keyword">DELETE</span>（<span class="hljs-keyword">DELETE</span>）：从服务器删除资源。<br></code></pre></td></tr></table></figure><p>例子：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET /zoos：列出所有动物园<br><br>POST /zoos：新建一个动物园<br><br>GET <span class="hljs-regexp">/zoos/I</span>D：获取某个指定动物园的信息<br><br>PUT <span class="hljs-regexp">/zoos/I</span>D：更新某个指定动物园的信息（提供该动物园的全部信息）<br><br>PATCH <span class="hljs-regexp">/zoos/I</span>D：更新某个指定动物园的信息（提供该动物园的部分信息）<br><br><span class="hljs-keyword">DELETE</span> <span class="hljs-regexp">/zoos/I</span>D：删除某个动物园<br><br>GET <span class="hljs-regexp">/zoos/I</span>D/animals：列出某个指定动物园的所有动物<br><br><span class="hljs-keyword">DELETE</span> <span class="hljs-regexp">/zoos/I</span>D<span class="hljs-regexp">/animals/I</span>D：删除某个指定动物园的指定动物<br></code></pre></td></tr></table></figure><h4 id="4-filter过滤"><a href="#4-filter过滤" class="headerlink" title="4. filter过滤"></a>4. filter过滤</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">limit</span>=10：指定返回记录的数量<br>?<span class="hljs-attribute">offset</span>=10：指定返回记录的开始位置。<br>?<span class="hljs-attribute">page</span>=2&amp;per_page=100：指定第几页，以及每页的记录数。<br>?<span class="hljs-attribute">sortby</span>=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序。<br>?<span class="hljs-attribute">animal_type_id</span>=1：指定筛选条件<br></code></pre></td></tr></table></figure><h4 id="5-状态码"><a href="#5-状态码" class="headerlink" title="5. 状态码"></a>5. 状态码</h4><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">200 </span>OK - [<span class="hljs-keyword">GET</span>]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。<br><br><span class="hljs-symbol">201 </span>CREATED - [POST/<span class="hljs-keyword">PUT</span>/PATCH]：用户新建或修改数据成功。<br><br><span class="hljs-symbol">202 </span>Accepted - [*]：表示一个请求已经进入后台排队（异步任务）<br><br><span class="hljs-symbol">204 </span>NO CONTENT - [<span class="hljs-keyword">DELETE</span>]：用户删除数据成功。<br><br><span class="hljs-symbol">400 </span>INVALID REQUEST - [POST/<span class="hljs-keyword">PUT</span>/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。<br><br><span class="hljs-symbol">401 </span>Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。<br><br><span class="hljs-symbol">403 </span>Forbidden - [*] 表示用户得到授权（与<span class="hljs-number">401</span>错误相对），但是访问是被禁止的。<br><br><span class="hljs-symbol">404 </span><span class="hljs-keyword">NOT</span> FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。<br><br><span class="hljs-symbol">406 </span><span class="hljs-keyword">Not</span> Acceptable - [<span class="hljs-keyword">GET</span>]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。<br><br><span class="hljs-symbol">410 </span>Gone -[<span class="hljs-keyword">GET</span>]：用户请求的资源被永久删除，且不会再得到的。<br><br><span class="hljs-symbol">422 </span>Unprocesable entity - [POST/<span class="hljs-keyword">PUT</span>/PATCH] 当创建一个对象时，发生一个验证错误。<br><br><span class="hljs-symbol">500 </span>INTERNAL SERVER <span class="hljs-keyword">ERROR</span> - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。<br></code></pre></td></tr></table></figure><h4 id="6-返回结果"><a href="#6-返回结果" class="headerlink" title="6. 返回结果"></a>6. 返回结果</h4><p>服务器返回的数据格式，应该尽量使用JSON，避免使用XML。 </p><p>针对不同操作，服务器向用户返回的结果应该符合以下规范。 </p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET /collection：返回资源对象的列表（数组）<br>GET <span class="hljs-regexp">/collection/</span>resource：返回单个资源对象<br>POST /collection：返回新生成的资源对象<br>PUT <span class="hljs-regexp">/collection/</span>resource：返回完整的资源对象<br>PATCH <span class="hljs-regexp">/collection/</span>resource：返回完整的资源对象<br><span class="hljs-keyword">DELETE</span> <span class="hljs-regexp">/collection/</span>resource：返回一个空文档<br></code></pre></td></tr></table></figure><h3 id="文档撰写实例"><a href="#文档撰写实例" class="headerlink" title="文档撰写实例"></a>文档撰写实例</h3><p>一般我们撰写接口文档+提供模拟数据(给前端移动端提供假的数据接口)，可以选用以下工具<br><a href="http://rap2.taobao.org/">RAP2</a> / <a href="https://apizza.net/pro/#/">apizza</a> / Swagger-UI</p><p>下面以设计评论接口为例，简单说明接口文档应该如何撰写。 </p><ol><li><p><strong>GET</strong> <code>/comments/&#123;article-id&#125;</code></p><p>开发者：星辰</p><p>最后更新时间：2018年8月10日</p><p>维护者：银河</p><p>最后更新时间：2018年12月16日</p><p>标签：v 1.0</p><p>接口说明：获取指定文章的所有评论</p><p>使用帮助：默认返回20条数据，需要在请求头中设置身份标识（key）</p><p>请求参数：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">参数名  类型    是否必填  参数位置  说明     <br>page   整数       否     查询参数  页码，默认值1        <br>size  整数        否     查询参数  每次获取评论数量（10~100），默认值20 <br>key   字符串      是     请求头    用户的身份标识             <br></code></pre></td></tr></table></figure><p>响应信息：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JSON">&#123;<br>    <span class="hljs-attr">&quot;code&quot;</span>: <span class="hljs-number">10000</span>,<br>    <span class="hljs-attr">&quot;message&quot;</span>: <span class="hljs-string">&quot;获取评论成功&quot;</span>,<br>    <span class="hljs-attr">&quot;page&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;size&quot;</span>: <span class="hljs-number">10</span>,<br>    <span class="hljs-attr">&quot;totalPage&quot;</span>: <span class="hljs-number">35</span>,<br>    <span class="hljs-attr">&quot;contents&quot;</span>: [<br>        &#123;<br>            <span class="hljs-attr">&quot;userId&quot;</span>: <span class="hljs-number">1700095</span>,<br>            <span class="hljs-attr">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;星辰&quot;</span>,<br>            <span class="hljs-attr">&quot;pubDate&quot;</span>: <span class="hljs-string">&quot;2018年7月31日&quot;</span>,<br>            <span class="hljs-attr">&quot;content&quot;</span>: <span class="hljs-string">&quot;小编是不是有病呀&quot;</span>,<br>            <span class="hljs-comment">/* ... */</span><br>        &#125;,<br>        &#123;<br>        &quot;userId&quot;, 1995322,<br>            &quot;nickname&quot;: &quot;银河&quot;,<br>            &quot;pubDate&quot;: &quot;2018年8月2日&quot;,<br>            &quot;content&quot;: &quot;楼上说得好&quot;,<br>            <span class="hljs-comment">/* ... */</span><br>        &#125;<br>    ]<br>    <span class="hljs-comment">/* ... */</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>POST</strong> <code>/comments/&#123;article-id&#125;</code></p><p>开发者：星辰</p><p>最后更新时间：2018年8月10日</p><p>维护者：银河</p><p>最后更新时间：2018年11月30日</p><p>标签：v 1.2</p><p>接口说明：为指定的文章创建评论</p><p>使用帮助：暂无</p><p>请求参数：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">参数名</span>   <span class="hljs-string">类型   是否必填   参数位置   说明    </span><br><span class="hljs-attr">userId</span>  <span class="hljs-string">字符串    是       消息体   用户ID     </span><br><span class="hljs-attr">key</span>     <span class="hljs-string">字符串    是       请求头   用户的令牌 </span><br><span class="hljs-attr">content</span> <span class="hljs-string">字符串    是       消息体   评论的内容 </span><br></code></pre></td></tr></table></figure><p>响应信息：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JSON">&#123;<br>    <span class="hljs-attr">&quot;code&quot;</span>: <span class="hljs-number">10001</span>,<br>    <span class="hljs-attr">&quot;message&quot;</span>: <span class="hljs-string">&quot;创建评论成功&quot;</span>,<br>    <span class="hljs-attr">&quot;comment&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;pubDate&quot;</span>: <span class="hljs-string">&quot;2018年7月31日&quot;</span>,<br>        <span class="hljs-attr">&quot;content&quot;</span>: <span class="hljs-string">&quot;小编是不是有病呀&quot;</span><br>        <span class="hljs-comment">/* ... */</span><br>    &#125;<br>    <span class="hljs-comment">/* ... */</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>Restful</category>
      
    </categories>
    
    
    <tags>
      
      <tag>restful</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python实用功能</title>
    <link href="/Myblog/2019/01/11/Python%E5%AE%9E%E7%94%A8%E5%8A%9F%E8%83%BD/"/>
    <url>/Myblog/2019/01/11/Python%E5%AE%9E%E7%94%A8%E5%8A%9F%E8%83%BD/</url>
    
    <content type="html"><![CDATA[<p><strong>网站优化的两大定律：</strong></p><ul><li>第一定律：使用缓存 - 用空间换时间 - Redis/Memcached</li><li>第二定律：使用消息队列 - 能推迟做的事情不要马上做 - 削峰 - 上下游节点解耦合</li></ul><h4 id="配置日志功能"><a href="#配置日志功能" class="headerlink" title="配置日志功能"></a>配置日志功能</h4><p>在settings文件中配置日志信息</p><p>配置日志信息后可以在控制台看到其执行的sql语句。</p><p>日志级别：NOTSET &lt; DEBUG &lt; INFO &lt; WARNING &lt; ERROR &lt; FATAL</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python">LOGGING = &#123;<br>    <span class="hljs-string">&#x27;version&#x27;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&#x27;disable_existing_loggers&#x27;</span>: <span class="hljs-literal">False</span>,<br>    <span class="hljs-comment"># 配置日志格式化器</span><br>    <span class="hljs-string">&#x27;formatters&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;simple&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;format&#x27;</span>: <span class="hljs-string">&#x27;%(asctime)s %(module)s.%(funcName)s: %(message)s&#x27;</span>,<br>            <span class="hljs-string">&#x27;datefmt&#x27;</span>: <span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,<br>        &#125;,<br>        <span class="hljs-string">&#x27;verbose&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;format&#x27;</span>: <span class="hljs-string">&#x27;%(asctime)s %(levelname)s [%(process)d-%(threadName)s] &#x27;</span><br>                      <span class="hljs-string">&#x27;%(module)s.%(funcName)s line %(lineno)d: %(message)s&#x27;</span>,<br>            <span class="hljs-string">&#x27;datefmt&#x27;</span>: <span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,<br>        &#125;<br>    &#125;,<br>    <span class="hljs-comment"># 配置日志过滤器</span><br>    <span class="hljs-string">&#x27;filters&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;require_debug_true&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;()&#x27;</span>: <span class="hljs-string">&#x27;django.utils.log.RequireDebugTrue&#x27;</span>,<br>        &#125;,<br>    &#125;,<br>    <span class="hljs-comment"># 配置日志处理器</span><br>    <span class="hljs-string">&#x27;handlers&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;console&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-string">&#x27;logging.StreamHandler&#x27;</span>,<br>            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,<br>            <span class="hljs-string">&#x27;filters&#x27;</span>: [<span class="hljs-string">&#x27;require_debug_true&#x27;</span>],<br>            <span class="hljs-string">&#x27;formatter&#x27;</span>: <span class="hljs-string">&#x27;simple&#x27;</span>,<br>        &#125;,<br>        <span class="hljs-string">&#x27;file1&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-string">&#x27;logging.handlers.TimedRotatingFileHandler&#x27;</span>,<br>            <span class="hljs-string">&#x27;filename&#x27;</span>: <span class="hljs-string">&#x27;access.log&#x27;</span>,<br>            <span class="hljs-comment"># 日志切割方式 - W0 - 星期天切割</span><br>            <span class="hljs-string">&#x27;when&#x27;</span>: <span class="hljs-string">&#x27;W0&#x27;</span>,<br>            <span class="hljs-string">&#x27;backupCount&#x27;</span>: <span class="hljs-number">12</span>,<br>            <span class="hljs-string">&#x27;formatter&#x27;</span>: <span class="hljs-string">&#x27;simple&#x27;</span>,<br>            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;INFO&#x27;</span>,<br>        &#125;,<br>        <span class="hljs-string">&#x27;file2&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-string">&#x27;logging.handlers.TimedRotatingFileHandler&#x27;</span>,<br>            <span class="hljs-string">&#x27;filename&#x27;</span>: <span class="hljs-string">&#x27;error.log&#x27;</span>,<br>            <span class="hljs-comment"># 日志切割方式 - D - 每天一切割</span><br>            <span class="hljs-string">&#x27;when&#x27;</span>: <span class="hljs-string">&#x27;D&#x27;</span>,<br>            <span class="hljs-string">&#x27;backupCount&#x27;</span>: <span class="hljs-number">31</span>,<br>            <span class="hljs-string">&#x27;formatter&#x27;</span>: <span class="hljs-string">&#x27;verbose&#x27;</span>,<br>            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;WARNING&#x27;</span>,<br>        &#125;,<br>    &#125;,<br>    <span class="hljs-comment"># 配置日志器</span><br>    <span class="hljs-string">&#x27;loggers&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;django&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;handlers&#x27;</span>: [<span class="hljs-string">&#x27;console&#x27;</span>, <span class="hljs-string">&#x27;file1&#x27;</span>, <span class="hljs-string">&#x27;file2&#x27;</span>],<br>            <span class="hljs-string">&#x27;propagate&#x27;</span>: <span class="hljs-literal">True</span>,<br>            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,<br>        &#125;,<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DEBUG开发工具"><a href="#DEBUG开发工具" class="headerlink" title="DEBUG开发工具"></a>DEBUG开发工具</h4><p>如果希望在页面上看到SQL执行语句或者其他信息，可以把日志级别调整到WARNING，安装一个第三方库。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install django-debug-toolbar<br></code></pre></td></tr></table></figure><p>进行配置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># settings.py</span><br><br>INSTALLED_APPS = [<br>    <span class="hljs-string">&#x27;debug_toolbar&#x27;</span>,<br>]<br><br>DEBUG_TOOLBAR_CONFIG = &#123;<br>    <span class="hljs-string">&#x27;JQUERY_URL&#x27;</span>: <span class="hljs-string">&#x27;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&#x27;</span>,<br>    <span class="hljs-string">&#x27;SHOW_COLLAPSED&#x27;</span>: <span class="hljs-literal">True</span>,<br>    <span class="hljs-string">&#x27;SHOW_TOOLBAR_CALLBACK&#x27;</span>: <span class="hljs-keyword">lambda</span> x: <span class="hljs-literal">True</span>,<br>&#125;<br><br>MIDDLEWARE = [<br>    <span class="hljs-string">&#x27;debug_toolbar.middleware.DebugToolbarMiddleware&#x27;</span>,<br>]<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#urls.py</span><br><span class="hljs-comment"># 调试模式开启</span><br><br><span class="hljs-keyword">if</span> settings.DEBUG:<br>    <span class="hljs-keyword">import</span> debug_toolbar<br>    urlpatterns.insert(<span class="hljs-number">0</span>, path(<span class="hljs-string">&quot;__debug__/&quot;</span>, include(debug_toolbar.urls)))<br></code></pre></td></tr></table></figure><p>如果出现问题：<code>Throwing AttributeError: &#39;module&#39; object has no attribute &#39;getrusage&#39;</code></p><p>解决：重写<code>DEBUG_TOOLBAR_PANELS</code> 并禁用<code>&#39;debug_toolbar.panels.timer.TimerPanel&#39;</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#settings.py</span><br><br><span class="hljs-comment"># DEBUG_TOOLBAR页面配置</span><br>DEBUG_TOOLBAR_PANELS = (<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.versions.VersionsPanel&#x27;</span>,<br>    <span class="hljs-comment"># Throwing AttributeError: &#x27;module&#x27; object has no attribute &#x27;getrusage&#x27;,</span><br>    <span class="hljs-comment"># &#x27;debug_toolbar.panels.timer.TimerPanel&#x27;,</span><br>    <span class="hljs-string">&#x27;debug_toolbar.panels.settings.SettingsPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.headers.HeadersPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.request.RequestPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.sql.SQLPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.cache.CachePanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.staticfiles.StaticFilesPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.templates.TemplatesPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.signals.SignalsPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.logging.LoggingPanel&#x27;</span>,<br>    <span class="hljs-string">&#x27;debug_toolbar.panels.redirects.RedirectsPanel&#x27;</span>,<br>)<br></code></pre></td></tr></table></figure><h4 id="Django中配置Redis缓存"><a href="#Django中配置Redis缓存" class="headerlink" title="Django中配置Redis缓存"></a>Django中配置Redis缓存</h4><p>Django默认redis存放在mysql数据库，修改redis作为缓存存放数据。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python">CACHES = &#123;<br>    <span class="hljs-comment"># 默认缓存</span><br>    <span class="hljs-string">&#x27;default&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,<br>        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: [<br>            <span class="hljs-string">&#x27;redis://39.96.51.36:6379/0&#x27;</span>,<br>        ],<br>        <span class="hljs-string">&#x27;KEY_PREFIX&#x27;</span>: <span class="hljs-string">&#x27;fangtx&#x27;</span>,<br>        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,<br>            <span class="hljs-string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;max_connections&#x27;</span>: <span class="hljs-number">1000</span>,<br>            &#125;,<br>            <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        &#125;<br>    &#125;,<br>    <span class="hljs-comment"># 页面缓存</span><br>    <span class="hljs-string">&#x27;page&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,<br>        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: [<br>            <span class="hljs-string">&#x27;redis://39.96.51.36:6379/1&#x27;</span>,<br>        ],<br>        <span class="hljs-string">&#x27;KEY_PREFIX&#x27;</span>: <span class="hljs-string">&#x27;fangtx:page&#x27;</span>,<br>        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,<br>            <span class="hljs-string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;max_connections&#x27;</span>: <span class="hljs-number">500</span>,<br>            &#125;,<br>            <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        &#125;<br>    &#125;,<br>    <span class="hljs-comment"># 会话缓存, 设定会话放在redis中。</span><br>    <span class="hljs-string">&#x27;session&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,<br>        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: [<br>            <span class="hljs-string">&#x27;redis://39.96.51.36:6379/2&#x27;</span>,<br>        ],<br>        <span class="hljs-string">&#x27;KEY_PREFIX&#x27;</span>: <span class="hljs-string">&#x27;fangtx:session&#x27;</span>,<br>        <span class="hljs-string">&#x27;TIMEOUT&#x27;</span>: <span class="hljs-number">1209600</span>,<br>        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,<br>            <span class="hljs-string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;max_connections&#x27;</span>: <span class="hljs-number">2000</span>,<br>            &#125;,<br>            <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        &#125;<br>    &#125;,<br>    <span class="hljs-comment"># 接口数据缓存</span><br>    <span class="hljs-string">&#x27;api&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,<br>        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: [<br>            <span class="hljs-string">&#x27;redis:///39.96.51.36:6379/3&#x27;</span>,<br>        ],<br>        <span class="hljs-string">&#x27;KEY_PREFIX&#x27;</span>: <span class="hljs-string">&#x27;fangtx:api&#x27;</span>,<br>        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,<br>            <span class="hljs-string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;max_connections&#x27;</span>: <span class="hljs-number">500</span>,<br>            &#125;,<br>            <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        &#125;<br>    &#125;,<br>&#125;<br><span class="hljs-comment"># 基于缓存</span><br>SESSION_ENGINE = <span class="hljs-string">&#x27;django.contrib.sessions.backends.cache&#x27;</span><br>SESSION_CACHE_ALIAS = <span class="hljs-string">&#x27;session&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p>说明：<code>from django.core.cache import cache, caches </code>  其中cache拿到默认的缓存， caches[‘xxx’]拿到指定缓存，django封装的缓存调用方式(弱小但简单)，只能操作字符串类型；<code>from django_redis import  get_redis_connection </code>拿到原生的redis连接。</p></blockquote><h4 id="获取用户IP"><a href="#获取用户IP" class="headerlink" title="获取用户IP"></a>获取用户IP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_ip_address</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;获得请求的IP地址&quot;&quot;&quot;</span><br>    ip = request.META.get(<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>, <span class="hljs-literal">None</span>)<br>    <span class="hljs-keyword">return</span> ip <span class="hljs-keyword">or</span> request.META[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]<br></code></pre></td></tr></table></figure><blockquote><p>说明：<code>request.META[&#39;REMOTE_ADDR&#39;]</code> 拿到用户ip，但是上线之后，有可能nginx路由后，有可能拿到的是自己当前服务器的地址，所以先拿<code>request.META.get(&#39;HTTP_X_FORWARDED_FOR&#39;, None)</code> </p></blockquote><h4 id="文件下载功能"><a href="#文件下载功能" class="headerlink" title="文件下载功能"></a>文件下载功能</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote, unquote<br><span class="hljs-comment"># 将中文字符装换为百分号编码</span><br><br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse, StreamingHttpResponse<br><br><span class="hljs-comment"># 如果要动态生成PDF报表可以使用ReportLab三方库</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;下载文件&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># path = os.path.dirname(__file__)</span><br>    file_stream = open(<span class="hljs-string">&#x27;static/Git工作流程.pdf&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>)<br>    file_iter = iter(<span class="hljs-keyword">lambda</span>: file_stream.read(<span class="hljs-number">4096</span>), <span class="hljs-string">b&#x27;&#x27;</span>)     <span class="hljs-comment"># b&#x27;&#x27;为终止条件</span><br>    <span class="hljs-comment"># StreamingHttpResponse适合下载大文件，传入一个可迭代对象；content_type后加MIME类型，告诉浏览器文件类型。</span><br>    resp = StreamingHttpResponse(file_iter, content_type=<span class="hljs-string">&#x27;application/pdf&#x27;</span>)<br>    filename = quote(<span class="hljs-string">&#x27;Git工作流程.pdf&#x27;</span>)<br>    <span class="hljs-comment"># attachment附件下载 ； inline-内联打开</span><br>    resp[<span class="hljs-string">&#x27;content-disposition&#x27;</span>] = <span class="hljs-string">f&#x27;attachment; filename=&quot;<span class="hljs-subst">&#123;filename&#125;</span>&quot;&#x27;</span><br>    <span class="hljs-keyword">return</span> resp<br></code></pre></td></tr></table></figure><blockquote><p>说明：</p><p>MIME - Multi-purpose Internet Mail Extension 服务器通过指定MIME（content-type）告诉浏览器给的内容是什么性质的内容 </p><p>application/json ; text/xml ; application/pdf ; application/msword ; application/msexcel  </p><p>image/jpeg ; image/png ; image/gif ; image/webp ; </p><p>audio/wav ；video/mp4 ；</p><p>HTTP响应头 </p><p>content-disposition: inline; filename=”Git.pdf” </p><p>content-disposition: attachment; filename=”Git.pdf”  </p></blockquote><h4 id="导出excel报表"><a href="#导出excel报表" class="headerlink" title="导出excel报表"></a>导出excel报表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote, unquote<br><br><span class="hljs-keyword">import</span> xlwt<br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">from</span> backend.models <span class="hljs-keyword">import</span> Emp<br><br><br>PAGE_SIZE = <span class="hljs-number">10</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_style</span>(<span class="hljs-params">name, *, color=<span class="hljs-number">0</span>, bold=False, italic=False</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;字体函数&quot;&quot;&quot;</span><br>    style = xlwt.XFStyle()<br>    font = xlwt.Font()<br>    font.name = name<br>    font.colour_index = color<br>    font.bold = bold<br>    font.italic = italic<br>    style.font = font<br>    <span class="hljs-keyword">return</span> style<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">export_emp_excel</span>(<span class="hljs-params">request, page</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;导出excel报表&quot;&quot;&quot;</span><br>    workbook = xlwt.Workbook()<br>    sheet = workbook.add_sheet(<span class="hljs-string">&#x27;员工详细信息&#x27;</span>)<br>    titles = [<span class="hljs-string">&#x27;编号&#x27;</span>, <span class="hljs-string">&#x27;姓名&#x27;</span>, <span class="hljs-string">&#x27;职位&#x27;</span>, <span class="hljs-string">&#x27;主管&#x27;</span>, <span class="hljs-string">&#x27;工资&#x27;</span>, <span class="hljs-string">&#x27;部门&#x27;</span>]<br>    <span class="hljs-keyword">for</span> col, title <span class="hljs-keyword">in</span> enumerate(titles):<br>        sheet.write(<span class="hljs-number">0</span>, col, title)<br>    props = (<span class="hljs-string">&#x27;no&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;job&#x27;</span>, <span class="hljs-string">&#x27;mgr&#x27;</span>, <span class="hljs-string">&#x27;sal&#x27;</span>, <span class="hljs-string">&#x27;dept&#x27;</span>)<br>    <span class="hljs-comment"># 如果查询对象的同时还要查询它的关联对象，那么必须对自动生成的SQL语句进行优化，否则会引发1+N查询(程序性能低下并且数据库压力很大)</span><br>    <span class="hljs-comment"># 如果有多对一关联，需要用连接查询加载关联对象，那么可以用select_related()来加载</span><br>    <span class="hljs-comment"># 如果有多对多关联，需要用连接查询加载关联对象，那么可以用prefetch_related()来加载</span><br>    start, end = (page - <span class="hljs-number">1</span>) * PAGE_SIZE, page * PAGE_SIZE<br>    <span class="hljs-comment"># only()和defer()方法来进行SQL投影操作 - 只显示某些列/不显示</span><br>    emps = Emp.objects.all().only(*props).select_related(<span class="hljs-string">&#x27;mgr&#x27;</span>).\<br>               select_related(<span class="hljs-string">&#x27;dept&#x27;</span>).order_by(<span class="hljs-string">&#x27;-sal&#x27;</span>)[start: end]<br>    <span class="hljs-keyword">for</span> row, emp <span class="hljs-keyword">in</span> enumerate(emps):<br>        <span class="hljs-keyword">for</span> col, prop <span class="hljs-keyword">in</span> enumerate(props):<br>            val = getattr(emp, prop, <span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">if</span> isinstance(val, (Dept, Emp)):<br>                val = val.name<br>            sheet.write(row+<span class="hljs-number">1</span>, col, val, get_style(<span class="hljs-string">&#x27;&#x27;</span>, color=<span class="hljs-number">2</span>, bold=<span class="hljs-literal">True</span>))<br>    <span class="hljs-comment"># str - 只读字符串    StringIO - 可写字符串</span><br>    <span class="hljs-comment"># bytes - 只读字节串    BytesIO - 可写字节串</span><br>    buffer = BytesIO()<br>    <span class="hljs-comment"># 提取Excel表格</span><br>    workbook.save(buffer)<br>    <span class="hljs-comment"># 生成响应对象传输数据给浏览器</span><br>    resp = HttpResponse(buffer.getvalue(), content_type=<span class="hljs-string">&#x27;application/msexcel&#x27;</span>)<br>    filename = quote(<span class="hljs-string">&#x27;员工信息表.xls&#x27;</span>)<br>    resp[<span class="hljs-string">&#x27;content-disposition&#x27;</span>] = <span class="hljs-string">f&#x27;attachment; filename=&quot;<span class="hljs-subst">&#123;filename&#125;</span>&quot;&#x27;</span><br>    <span class="hljs-keyword">return</span> resp<br></code></pre></td></tr></table></figure><blockquote><p>说明：查询数据库操作应该加上only()和defer()，优化数据库性能；如果查询语句中有关联关系，用<code>select_related(&#39;mgr&#39;)</code>对SQL语句进行优化，不然会引发1+N查询，导致性能极其低下；BytesIO()是内存中可变字节区域。</p></blockquote><blockquote><p><code>select_related(&#39;xxx&#39;)</code> 是一对多的预加载；<code>prefetch_related(&#39;xxx&#39;)</code>是多对多的预加载。</p></blockquote><h4 id="生成word文档"><a href="#生成word文档" class="headerlink" title="生成word文档"></a>生成word文档</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> python-docx<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> docx<br><span class="hljs-keyword">from</span> docx.enum.text <span class="hljs-keyword">import</span> WD_PARAGRAPH_ALIGNMENT<br><span class="hljs-keyword">from</span> docx.shared <span class="hljs-keyword">import</span> Pt<br><span class="hljs-keyword">from</span> docx.oxml.ns <span class="hljs-keyword">import</span> qn<br><span class="hljs-keyword">from</span> docx.shared <span class="hljs-keyword">import</span> RGBColor<br><br><br>document = docx.Document()<br><br><span class="hljs-comment"># 设置全局字体</span><br>document.styles[<span class="hljs-string">&#x27;Normal&#x27;</span>].font.name = <span class="hljs-string">u&#x27;宋体&#x27;</span><br>document.styles[<span class="hljs-string">&#x27;Normal&#x27;</span>].font.size = Pt(<span class="hljs-number">14</span>)   <span class="hljs-comment"># 四号</span><br>document.styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]._element.rPr.rFonts.set(qn(<span class="hljs-string">&#x27;w:eastAsia&#x27;</span>), <span class="hljs-string">u&#x27;宋体&#x27;</span>)<br><br><span class="hljs-comment"># 设置页眉</span><br>section = document.sections[<span class="hljs-number">0</span>]<br>header = section.header<br>paragraph1 = header.paragraphs[<span class="hljs-number">0</span>]<br>paragraph1.alignment = WD_PARAGRAPH_ALIGNMENT.CENTER   <span class="hljs-comment"># 居中</span><br>t1 = paragraph1.add_run(<span class="hljs-string">&quot;广告监测系统&quot;</span>)<br>t1.underline = <span class="hljs-literal">True</span><br>t1.font.size = Pt(<span class="hljs-number">9</span>)   <span class="hljs-comment"># 小五</span><br><br><span class="hljs-comment"># 段落1</span><br>paragraph2 = document.add_paragraph()<br>paragraph2.paragraph_format.alignment = WD_PARAGRAPH_ALIGNMENT.CENTER<br>t2 = paragraph2.add_run(<span class="hljs-string">&quot;单一广告监测报告&quot;</span>)<br><span class="hljs-comment"># 设置字号</span><br>t2.font.size = Pt(<span class="hljs-number">36</span>)   <span class="hljs-comment"># 小初</span><br><span class="hljs-comment"># 加粗</span><br>t2.bold = <span class="hljs-literal">True</span><br><span class="hljs-comment"># 设置字体</span><br>t2.font.name = <span class="hljs-string">u&quot;隶书&quot;</span><br>t2._element.rPr.rFonts.set(qn(<span class="hljs-string">&#x27;w:eastAsia&#x27;</span>), <span class="hljs-string">u&quot;隶书&quot;</span>)<br><br><span class="hljs-comment"># 换行</span><br>document.add_paragraph(text=<span class="hljs-string">&#x27;&#x27;</span>, style=<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 换行</span><br><br><span class="hljs-comment"># 换页</span><br><span class="hljs-comment"># document.paragraphs[0].runs[0].add_break(docx.enum.text.WD_BREAK.PAGE)</span><br><br><span class="hljs-comment"># 段落2</span><br>paragraph3 = document.add_paragraph()<br><span class="hljs-comment"># 一个段落里面可以添加多个add_run</span><br>t3 = paragraph3.add_run(<span class="hljs-string">&quot;段落一，使用&quot;</span>)<br>t4 = paragraph3.add_run(<span class="hljs-string">&quot; 「全局字体」 &quot;</span>)<br><span class="hljs-comment"># 下划线</span><br>t4.underline = <span class="hljs-literal">True</span><br><span class="hljs-comment"># 设置RGB值</span><br>t4.font.color.rgb = RGBColor(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">238</span>)<br><br>document.save(<span class="hljs-string">&#x27;./docx-text.docx&#x27;</span>)<br><br></code></pre></td></tr></table></figure><blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#all_caps       =&gt;  全部大写字母</span><br><span class="hljs-comment">#bold           =&gt;  加粗</span><br><span class="hljs-comment">#color          =&gt;  字体颜色</span><br><span class="hljs-comment">#complex_script =&gt;  是否为“复杂代码”</span><br><span class="hljs-comment">#cs_bold        =&gt;  “复杂代码”加粗</span><br><span class="hljs-comment">#cs_italic      =&gt;  “复杂代码”斜体</span><br><span class="hljs-comment">#double_strike  =&gt;  双删除线</span><br><span class="hljs-comment">#emboss         =&gt;  文本以凸出页面的方式出现</span><br><span class="hljs-comment">#hidden         =&gt;  隐藏</span><br><span class="hljs-comment">#imprint        =&gt;  印记</span><br><span class="hljs-comment">#italic         =&gt;  斜体</span><br><span class="hljs-comment">#name           =&gt;  字体</span><br><span class="hljs-comment">#no_proof       =&gt;  不验证语法错误</span><br><span class="hljs-comment">#outline        =&gt;  显示字符的轮廓</span><br><span class="hljs-comment">#shadow         =&gt;  阴影</span><br><span class="hljs-comment">#small_caps     =&gt;  小型大写字母</span><br><span class="hljs-comment">#snap_to_grid   =&gt;  定义文档网格时对齐网络</span><br><span class="hljs-comment">#strike         =&gt;  删除线</span><br><span class="hljs-comment">#subscript      =&gt;  下标</span><br><span class="hljs-comment">#superscript    =&gt;  上标</span><br><span class="hljs-comment">#underline      =&gt;  下划线</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="生成临时文件"><a href="#生成临时文件" class="headerlink" title="生成临时文件"></a>生成临时文件</h4><p>Python内置tempfile库用户生成临时文件，使用完毕会自动销毁。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> tempfile <span class="hljs-keyword">import</span> TemporaryFile, NamedTemporaryFile<br><br>TemporaryFile(mode=<span class="hljs-string">&#x27;w+b&#x27;</span>, buffering=<span class="hljs-literal">None</span>, encoding=<span class="hljs-literal">None</span>, newline=<span class="hljs-literal">None</span>, suffix=<span class="hljs-literal">None</span>, prefix=<span class="hljs-literal">None</span>, dir=<span class="hljs-literal">None</span>, *, errors=<span class="hljs-literal">None</span>)<br><br>NamedTemporaryFile(mode=<span class="hljs-string">&#x27;w+b&#x27;</span>, buffering=<span class="hljs-literal">None</span>, encoding=<span class="hljs-literal">None</span>, newline=<span class="hljs-literal">None</span>, suffix=<span class="hljs-literal">None</span>, prefix=<span class="hljs-literal">None</span>, dir=<span class="hljs-literal">None</span>, delete=<span class="hljs-literal">True</span>, *, errors=<span class="hljs-literal">None</span>)<br><span class="hljs-comment"># TemporaryFile 和 NamedTemporaryFile 区别在于后者有名字，可以用&lt;object&gt;.name 查看临时文件存储路径</span><br></code></pre></td></tr></table></figure><ul><li>TemporaryFile</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>fp = TemporaryFile()<br><span class="hljs-meta">&gt;&gt;&gt; </span>fp.write(<span class="hljs-string">b&#x27;Hello world!&#x27;</span>)<br><span class="hljs-comment"># read data from file</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>fp.seek(<span class="hljs-number">0</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>fp.read()<br><span class="hljs-string">b&#x27;Hello world!&#x27;</span><br><span class="hljs-comment"># close the file, it will be removed</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>fp.close()<br></code></pre></td></tr></table></figure><ul><li>NamedTemporaryFile</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">with</span> NamedTemporaryFile(suffix=<span class="hljs-string">&#x27;.xlsx&#x27;</span>) <span class="hljs-keyword">as</span> ntf:<br>  <span class="hljs-comment"># 执行完上下文语句，会自动销毁临时文件</span><br>  ntf.write(<span class="hljs-string">b&#x27;123456&#x27;</span>)<br>  file_path = ntf.name    <span class="hljs-comment"># 临时文件存储绝对路径</span><br></code></pre></td></tr></table></figure><ul><li>相关坑点</li></ul><p><strong>经查证，用这种方式创建的临时文件，在linux系统里不关闭文件即可再次打开读取内容，但是在windows系统，不关闭就没有权限再次打开。另外，文件默认的是，一旦关闭，就会被自动清除。所以这里就有了一个矛盾：不关闭文件就没有打开的权限；关闭之后文件就不见了，更无法打开。</strong></p><p>要解决这个问题，我们需要三个关键步骤：</p><ol><li>修改NamedTemporaryFile的参数，让文件关闭后不会自动清理。</li><li>读取之前，先关闭。</li><li>为了不在电脑里留下垃圾，我们另写一行代码“手动”清理这个临时文件。</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> tempfile, json, os<br><br><br>data=[&#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;Jessica&#x27;</span>,<span class="hljs-string">&#x27;lang&#x27;</span>:(<span class="hljs-string">&#x27;Python&#x27;</span>,<span class="hljs-string">&#x27;English&#x27;</span>),<span class="hljs-string">&#x27;age&#x27;</span>:<span class="hljs-number">27</span>&#125;]<br>f=tempfile.NamedTemporaryFile(mode=<span class="hljs-string">&#x27;w&#x27;</span>,delete=<span class="hljs-literal">False</span>)<br><span class="hljs-comment">#注意上面一行，delete设置为False，就不会关闭文件后自动清理了</span><br>json.dump(data,f)<br>f.close()<br><span class="hljs-comment">#再次打开之前一定要先关闭</span><br><br>print(open(f.name,<span class="hljs-string">&#x27;r&#x27;</span>).read())<br>f.close()<br>os.remove(f.name)<br></code></pre></td></tr></table></figure><h4 id="前端报表Echarts"><a href="#前端报表Echarts" class="headerlink" title="前端报表Echarts"></a>前端报表Echarts</h4><p>获取自己所需要的报表：<a href="https://echarts.baidu.com/">Echarts官网</a></p><p>使用BootCND在线加载：<a href="https://www.bootcdn.cn/">BootCND官网</a></p><p>示例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ECharts<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 引入 echarts.js --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/echarts/4.2.0-rc.2/echarts-en.simple.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><br><span class="css">        <span class="hljs-selector-id">#main</span> &#123;</span><br>            width: 600px;<br>            height: 400px;<br>        &#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>&gt;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 为ECharts准备一个具备大小（宽高）的Dom --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;main&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript">        <span class="hljs-comment">// 获得绘图区域并初始化</span></span><br><span class="javascript">        <span class="hljs-keyword">var</span> myChart = echarts.init($(<span class="hljs-string">&#x27;#main&#x27;</span>)[<span class="hljs-number">0</span>]);</span><br><span class="javascript">        $.get(<span class="hljs-string">&#x27;/backend/agent_bar_data/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>&#123;</span><br><span class="javascript">            <span class="hljs-comment">// 指定图表的配置项和数据(ajax)</span></span><br><span class="javascript">            <span class="hljs-keyword">var</span> option = &#123;</span><br>                title: &#123;<br><span class="javascript">                    text: <span class="hljs-string">&#x27;ECharts 入门示例&#x27;</span></span><br>                &#125;,<br>                tooltip: &#123;&#125;,<br>                legend: &#123;<br><span class="javascript">                    data:[<span class="hljs-string">&#x27;销量&#x27;</span>]</span><br>                &#125;,<br>                xAxis: &#123;<br><span class="javascript">                    data: data[<span class="hljs-string">&#x27;names&#x27;</span>]</span><br>                &#125;,<br>                yAxis: &#123;&#125;,<br>                series: [&#123;<br><span class="javascript">                    name: <span class="hljs-string">&#x27;销量&#x27;</span>,</span><br><span class="javascript">                    type: <span class="hljs-string">&#x27;bar&#x27;</span>,</span><br><span class="javascript">                    data: data[<span class="hljs-string">&#x27;totals&#x27;</span>]</span><br>                &#125;]<br>            &#125;;<br><span class="javascript">            <span class="hljs-comment">// 使用刚指定的配置项和数据显示图表。</span></span><br>            myChart.setOption(option);<br>        &#125;)<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse, StreamingHttpResponse, JsonResponse<br><span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> render<br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> connections<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;index.html&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">agent_bar_data</span>(<span class="hljs-params">request</span>):</span><br>    names, totals = [], []<br>    <span class="hljs-keyword">with</span> connections[<span class="hljs-string">&#x27;default&#x27;</span>].cursor() <span class="hljs-keyword">as</span> cursor:<br>        cursor.execute(<span class="hljs-string">&#x27;select name, total from &#x27;</span><br>                       <span class="hljs-string">&#x27; (select agentid, count(agentid) as total &#x27;</span><br>                       <span class="hljs-string">&#x27; from tb_agent_estate group by agentid) t1 &#x27;</span><br>                       <span class="hljs-string">&#x27; inner join tb_agent t2 on t1.agentid=t2.agentid&#x27;</span>)<br>        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor.fetchall():<br>            <span class="hljs-comment"># fetchall()拿到查询结果，结果为元组</span><br>            names.append(row[<span class="hljs-number">0</span>])<br>            totals.append(row[<span class="hljs-number">1</span>])<br><br>    <span class="hljs-comment"># 如果data参数不是字典而是列表，还要加上safe=False参数</span><br>    <span class="hljs-comment"># 如果字典或列中有自定义对象，那么还需要通过encoder参数指定自定义对象如何做JSON序列化</span><br>    <span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;names&#x27;</span>:names, <span class="hljs-string">&#x27;totals&#x27;</span>: totals&#125;)<br></code></pre></td></tr></table></figure><blockquote><p>说明： 在django中想要执行原生的SQL语句，<code>from django.db import connections, connection</code> 其中<code>connection</code>拿到默认连接， <code>connections[&#39;xx&#39;]</code>拿到指定连接；</p></blockquote><h4 id="程序运行输出终端动画"><a href="#程序运行输出终端动画" class="headerlink" title="程序运行输出终端动画"></a>程序运行输出终端动画</h4><p>使用多线程，一个线程运行主程序，一个线程用于输出终端动画</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> itertools<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span>():</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">100</span>):<br>        time.sleep(<span class="hljs-number">10</span>)<br>        print(<span class="hljs-string">&#x27;\n&#x27;</span>, i)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> pool:<br>        future = pool.submit(test)<br>        <span class="hljs-comment"># 输出运行提示</span><br>        symbols = [<span class="hljs-string">&quot;.&quot;</span> * i + <span class="hljs-string">&quot; &quot;</span> * (<span class="hljs-number">4</span> - i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> itertools.cycle(symbols):<br>            <span class="hljs-keyword">if</span> future.done():<br>                print(<span class="hljs-string">&quot;success !&quot;</span>)<br>                <span class="hljs-keyword">break</span><br>            print(<span class="hljs-string">f&quot;\r请求中<span class="hljs-subst">&#123;i&#125;</span>&quot;</span>, end=<span class="hljs-string">&#x27;&#x27;</span>)       <span class="hljs-comment"># 等效: print(f&quot;\r请求中&#123;i&#125;\b&quot;) </span><br>            time.sleep(<span class="hljs-number">0.5</span>)<br>    <span class="hljs-comment"># future.result()  # 阻塞线程直到返回结果</span><br></code></pre></td></tr></table></figure><blockquote><p><code>\r</code> - 光标移动到本行首 ;  <code>\b</code> - 使当前光标向前回退一个位置</p></blockquote><h4 id="生成图片验证码"><a href="#生成图片验证码" class="headerlink" title="生成图片验证码"></a>生成图片验证码</h4><p>需要用到字体文件<code>&#39;Arial.ttf&#39;, &#39;Georgia.ttf&#39;, &#39;actionj.ttf&#39;</code>，存放在<code>/&lt;项目&gt;/static/fonts/</code>目录下。</p><p>captcha.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">图片验证码</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> ImageFilter<br><span class="hljs-keyword">from</span> PIL.ImageDraw <span class="hljs-keyword">import</span> Draw<br><span class="hljs-keyword">from</span> PIL.ImageFont <span class="hljs-keyword">import</span> truetype<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bezier</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;贝塞尔曲线&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.tsequence = tuple([t / <span class="hljs-number">20.0</span> <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> range(<span class="hljs-number">21</span>)])<br>        self.beziers = &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_bezier</span>(<span class="hljs-params">self, n</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制贝塞尔曲线&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">return</span> self.beziers[n]<br>        <span class="hljs-keyword">except</span> KeyError:<br>            combinations = pascal_row(n - <span class="hljs-number">1</span>)<br>            result = []<br>            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> self.tsequence:<br>                tpowers = (t ** i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n))<br>                upowers = ((<span class="hljs-number">1</span> - t) ** i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n - <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>))<br>                coefs = [c * a * b <span class="hljs-keyword">for</span> c, a, b <span class="hljs-keyword">in</span> zip(combinations,<br>                                                      tpowers, upowers)]<br>                result.append(coefs)<br>            self.beziers[n] = result<br>            <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Captcha</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;验证码&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, width, height, fonts=None, color=None</span>):</span><br>        self._image = <span class="hljs-literal">None</span><br>        self._fonts = fonts <span class="hljs-keyword">if</span> fonts <span class="hljs-keyword">else</span> \<br>            [os.path.join(os.path.join(os.path.dirname(os.path.dirname(__file__)), <span class="hljs-string">&#x27;static&#x27;</span>), <span class="hljs-string">&#x27;fonts&#x27;</span>, font)<br>             <span class="hljs-keyword">for</span> font <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;Arial.ttf&#x27;</span>, <span class="hljs-string">&#x27;Georgia.ttf&#x27;</span>, <span class="hljs-string">&#x27;actionj.ttf&#x27;</span>]]<br>        self._color = color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> random_color(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>, random.randint(<span class="hljs-number">220</span>, <span class="hljs-number">255</span>))<br>        self._width, self._height = width, height<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">instance</span>(<span class="hljs-params">cls, width=<span class="hljs-number">200</span>, height=<span class="hljs-number">75</span></span>):</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hasattr(Captcha, <span class="hljs-string">&quot;_instance&quot;</span>):<br>            cls._instance = cls(width, height)<br>        <span class="hljs-keyword">return</span> cls._instance<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">background</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制背景&quot;&quot;&quot;</span><br>        Draw(self._image).rectangle([(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), self._image.size],<br>                                    fill=random_color(<span class="hljs-number">230</span>, <span class="hljs-number">255</span>))<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">smooth</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;平滑图像&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> self._image.filter(ImageFilter.SMOOTH)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">curve</span>(<span class="hljs-params">self, width=<span class="hljs-number">4</span>, number=<span class="hljs-number">6</span>, color=None</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制曲线&quot;&quot;&quot;</span><br>        dx, height = self._image.size<br>        dx /= number<br>        path = [(dx * i, random.randint(<span class="hljs-number">0</span>, height))<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, number)]<br>        bcoefs = Bezier().make_bezier(number - <span class="hljs-number">1</span>)<br>        points = []<br>        <span class="hljs-keyword">for</span> coefs <span class="hljs-keyword">in</span> bcoefs:<br>            points.append(tuple(sum([coef * p <span class="hljs-keyword">for</span> coef, p <span class="hljs-keyword">in</span> zip(coefs, ps)])<br>                                <span class="hljs-keyword">for</span> ps <span class="hljs-keyword">in</span> zip(*path)))<br>        Draw(self._image).line(points, fill=color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> self._color, width=width)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">noise</span>(<span class="hljs-params">self, number=<span class="hljs-number">50</span>, level=<span class="hljs-number">2</span>, color=None</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制扰码&quot;&quot;&quot;</span><br>        width, height = self._image.size<br>        dx, dy = width / <span class="hljs-number">10</span>, height / <span class="hljs-number">10</span><br>        width, height = width - dx, height - dy<br>        draw = Draw(self._image)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(number):<br>            x = int(random.uniform(dx, width))<br>            y = int(random.uniform(dy, height))<br>            draw.line(((x, y), (x + level, y)),<br>                      fill=color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> self._color, width=level)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">text</span>(<span class="hljs-params">self, captcha_text, fonts, font_sizes=None, drawings=None, squeeze_factor=<span class="hljs-number">0.75</span>, color=None</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;绘制文本&quot;&quot;&quot;</span><br>        color = color <span class="hljs-keyword">if</span> color <span class="hljs-keyword">else</span> self._color<br>        fonts = tuple([truetype(name, size)<br>                       <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> fonts<br>                       <span class="hljs-keyword">for</span> size <span class="hljs-keyword">in</span> font_sizes <span class="hljs-keyword">or</span> (<span class="hljs-number">65</span>, <span class="hljs-number">70</span>, <span class="hljs-number">75</span>)])<br>        draw = Draw(self._image)<br>        char_images = []<br>        <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> captcha_text:<br>            font = random.choice(fonts)<br>            c_width, c_height = draw.textsize(c, font=font)<br>            char_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (c_width, c_height), (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br>            char_draw = Draw(char_image)<br>            char_draw.text((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), c, font=font, fill=color)<br>            char_image = char_image.crop(char_image.getbbox())<br>            <span class="hljs-keyword">for</span> drawing <span class="hljs-keyword">in</span> drawings:<br>                d = getattr(self, drawing)<br>                char_image = d(char_image)<br>            char_images.append(char_image)<br>        width, height = self._image.size<br>        offset = int((width - sum(int(i.size[<span class="hljs-number">0</span>] * squeeze_factor)<br>                                  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> char_images[:<span class="hljs-number">-1</span>]) -<br>                      char_images[<span class="hljs-number">-1</span>].size[<span class="hljs-number">0</span>]) / <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">for</span> char_image <span class="hljs-keyword">in</span> char_images:<br>            c_width, c_height = char_image.size<br>            mask = char_image.convert(<span class="hljs-string">&#x27;L&#x27;</span>).point(<span class="hljs-keyword">lambda</span> i: i * <span class="hljs-number">1.97</span>)<br>            self._image.paste(char_image,<br>                        (offset, int((height - c_height) / <span class="hljs-number">2</span>)),<br>                        mask)<br>            offset += int(c_width * squeeze_factor)<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">warp</span>(<span class="hljs-params">image, dx_factor=<span class="hljs-number">0.3</span>, dy_factor=<span class="hljs-number">0.3</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;图像扭曲&quot;&quot;&quot;</span><br>        width, height = image.size<br>        dx = width * dx_factor<br>        dy = height * dy_factor<br>        x1 = int(random.uniform(-dx, dx))<br>        y1 = int(random.uniform(-dy, dy))<br>        x2 = int(random.uniform(-dx, dx))<br>        y2 = int(random.uniform(-dy, dy))<br>        warp_image = Image.new(<br>            <span class="hljs-string">&#x27;RGB&#x27;</span>,<br>            (width + abs(x1) + abs(x2), height + abs(y1) + abs(y2)))<br>        warp_image.paste(image, (abs(x1), abs(y1)))<br>        width2, height2 = warp_image.size<br>        <span class="hljs-keyword">return</span> warp_image.transform(<br>            (width, height),<br>            Image.QUAD,<br>            (x1, y1, -x1, height2 - y2, width2 + x2, height2 + y2, width2 - x2, -y1))<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">offset</span>(<span class="hljs-params">image, dx_factor=<span class="hljs-number">0.1</span>, dy_factor=<span class="hljs-number">0.2</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;图像偏移&quot;&quot;&quot;</span><br>        width, height = image.size<br>        dx = int(random.random() * width * dx_factor)<br>        dy = int(random.random() * height * dy_factor)<br>        offset_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (width + dx, height + dy))<br>        offset_image.paste(image, (dx, dy))<br>        <span class="hljs-keyword">return</span> offset_image<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rotate</span>(<span class="hljs-params">image, angle=<span class="hljs-number">25</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;图像旋转&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> image.rotate(random.uniform(-angle, angle),<br>                            Image.BILINEAR, expand=<span class="hljs-number">1</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate</span>(<span class="hljs-params">self, captcha_text=<span class="hljs-string">&#x27;&#x27;</span>, fmt=<span class="hljs-string">&#x27;PNG&#x27;</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;生成验证码(文字和图片)&quot;&quot;&quot;</span><br>        self._image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (self._width, self._height), (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))<br>        self.background()<br>        self.text(captcha_text, self._fonts,<br>                  drawings=[<span class="hljs-string">&#x27;warp&#x27;</span>, <span class="hljs-string">&#x27;rotate&#x27;</span>, <span class="hljs-string">&#x27;offset&#x27;</span>])<br>        self.curve()<br>        self.noise()<br>        self.smooth()<br>        image_bytes = BytesIO()<br>        self._image.save(image_bytes, format=fmt)<br>        <span class="hljs-keyword">return</span> image_bytes.getvalue()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pascal_row</span>(<span class="hljs-params">n=<span class="hljs-number">0</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成Pascal三角第n行&quot;&quot;&quot;</span><br>    result = [<span class="hljs-number">1</span>]<br>    x, numerator = <span class="hljs-number">1</span>, n<br>    <span class="hljs-keyword">for</span> denominator <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, n // <span class="hljs-number">2</span> + <span class="hljs-number">1</span>):<br>        x *= numerator<br>        x /= denominator<br>        result.append(x)<br>        numerator -= <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> n &amp; <span class="hljs-number">1</span> == <span class="hljs-number">0</span>:<br>        result.extend(reversed(result[:<span class="hljs-number">-1</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        result.extend(reversed(result))<br>    <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">random_color</span>(<span class="hljs-params">start=<span class="hljs-number">0</span>, end=<span class="hljs-number">255</span>, opacity=<span class="hljs-number">255</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;获得随机颜色&quot;&quot;&quot;</span><br>    red = random.randint(start, end)<br>    green = random.randint(start, end)<br>    blue = random.randint(start, end)<br>    <span class="hljs-keyword">if</span> opacity <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> red, green, blue<br>    <span class="hljs-keyword">return</span> red, green, blue, opacity<br></code></pre></td></tr></table></figure><p>utils.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">工具函数</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><br><br>ALL_CHARS = <span class="hljs-string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_captcha_text</span>(<span class="hljs-params">length=<span class="hljs-number">4</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定长度的图片验证码文字&quot;&quot;&quot;</span><br>    code = StringIO()<br>    chars_len = len(ALL_CHARS)<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(length):<br>        index = random.randrange(chars_len)<br>        code.write(ALL_CHARS[index])<br>    <span class="hljs-keyword">return</span> code.getvalue()<br></code></pre></td></tr></table></figure><p>使用方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">from</span> common.captcha <span class="hljs-keyword">import</span> Captcha<br><span class="hljs-keyword">from</span> common.utils <span class="hljs-keyword">import</span> gen_captcha_text<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">captcha</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成验证码&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 随机验证码内容, 可以指定长度</span><br>    code_text = gen_captcha_text()<br>    <span class="hljs-comment"># 将验证码放入session缓存中</span><br>    request.session[<span class="hljs-string">&#x27;code_text&#x27;</span>] = code_text<br>    <span class="hljs-comment"># instance()指定验证码宽高； generate(code_text)生成验证码,返回图片二进制数据</span><br>    code_bytes = Captcha.instance().generate(code_text)<br>    <span class="hljs-keyword">return</span> HttpResponse(code_bytes, content_type=<span class="hljs-string">&#x27;image/png&#x27;</span>)<br></code></pre></td></tr></table></figure><p>想要在页面上直接显示出图片，可以将二进制图片利用base64编码成字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 修改以上代码</span><br>code_bytes = Captcha.instance().generate(code_text)<br>code_base64_str = base64.b64encode(code_bytes).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>:<span class="hljs-number">200</span>, <span class="hljs-string">&#x27;pic&#x27;</span>:code_base64_str&#125;)<br></code></pre></td></tr></table></figure><p>在src前添加data:image/jpeg;base64,+已经encode的二进制代码，就可以在网页端显示出图片</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;captcha_pic&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;data:image/gif;base64,R0lGODlhDwAPAKECAAAAzMzM/////wAAACwAAAAADwAPAAACIISPeQHsrZ5ModrLlN48CXF8m2iQ3YmmKqVlRtW4MLwWACH+H09wdGltaXplZCBieSBVbGVhZCBTbWFydFNhdmVyIQAAOw==&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;150&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;150&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h4 id="生成二维码"><a href="#生成二维码" class="headerlink" title="生成二维码"></a>生成二维码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO, BytesIO<br><br><span class="hljs-keyword">import</span> qrcode<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_qrcode</span>(<span class="hljs-params">data:bytes</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成二维码&quot;&quot;&quot;</span><br>    image = qrcode.make(data)<br>    buffer = BytesIO()<br>    image.save(buffer)<br>    <span class="hljs-keyword">return</span> buffer.getvalue()<br></code></pre></td></tr></table></figure><h4 id="脏话检测"><a href="#脏话检测" class="headerlink" title="脏话检测"></a>脏话检测</h4><p>基于脏话统计库匹配(非正则)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*-coding:utf-8-*-</span><br><span class="hljs-comment"># 敏感词文本文件 filtered_words.txt，里面的内容为以下内容，当用户输入敏感词语时，则打印出 ** is Legal，否则打印出 ** is not Legal</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SenseWord</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.filtered_set = set()  <span class="hljs-comment"># 统计已记录敏感词汇</span><br>        filtered_word = open(<span class="hljs-string">&#x27;./filtered_words.txt&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> filtered_word.readlines():<br>            self.filtered_set.add(line.strip())<br>        filtered_word.close()<br>        print(<span class="hljs-string">&#x27;非法字符串统计库: &#x27;</span>, end=<span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.filtered_set:<br>            print(item, end=<span class="hljs-string">&#x27; / &#x27;</span>)<br>        print()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_legal</span>(<span class="hljs-params">self, check_word</span>):</span><br>        <span class="hljs-keyword">if</span> check_word <span class="hljs-keyword">in</span> self.filtered_set:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    sense_word = SenseWord()<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        check_word = input(<span class="hljs-string">&#x27;请输入检查字符串: &#x27;</span>).strip()<br>        <span class="hljs-keyword">if</span> sense_word.is_legal(check_word):<br>            print(<span class="hljs-string">&#x27;[%s] is Legal!&#x27;</span> % check_word)<br>        <span class="hljs-keyword">else</span>:<br>            print(<span class="hljs-string">&#x27;[%s] is not legal!&#x27;</span> % check_word)<br></code></pre></td></tr></table></figure><p>filtered_words.txt</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs txt">北京<br>程序员<br>公务员<br>领导<br>牛比<br>牛逼<br>你娘<br>你妈<br>love<br>sex<br>jiangge<br></code></pre></td></tr></table></figure><h4 id="生成密码强度的伪随机值"><a href="#生成密码强度的伪随机值" class="headerlink" title="生成密码强度的伪随机值"></a>生成密码强度的伪随机值</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> secrets<br><span class="hljs-keyword">import</span> string<br><br>characters = string.ascii_letters + string.digits<br>bad_password = <span class="hljs-string">&#x27;&#x27;</span>.join(secrets.choice(characters) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>))<br>print(bad_password)<br><br><span class="hljs-string">&#x27;SRvM54Z1&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p>在这个例子中,我们导入了 <code>secrets</code> 模块和 <code>string</code> 模块. 然后用大写字母和数字组成了一个字符串. 最后使用 <code>secrets</code>模块的 <code>choice()</code> 方法随机地抽取出其中的字符,从而生成一个不够好的密码. 之所以说这个密码不够好是因为密码中没有特殊字符, 但实际上它已经要好过很多人使用的密码了. 还有读者指出,除此之外,这个密码也比较难记,所以很可能会被记录在纸上被人发现. 这当然也对,但是使用字典里的单词作为密码是非常不建议的,你最好习惯这种密码或者使用密码管理软件管理你的密码.</p></blockquote><h4 id="使用jwt生成token"><a href="#使用jwt生成token" class="headerlink" title="使用jwt生成token"></a>使用jwt生成token</h4><p>调用jwt库,生成json web token，其数据结构包括两部分： headers(标头)，payload(有效载体)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># headers 中一些固定参数名称的意义</span><br>headers = &#123;<br>    <span class="hljs-string">&quot;alg&quot;</span>: <span class="hljs-string">&quot;ES256&quot;</span>,<br>    <span class="hljs-string">&quot;kid&quot;</span>: <span class="hljs-string">&quot;ABC123DEFG&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li>jku: 发送JWK的地址；最好用HTTPS来传输</li><li>jwk: 就是之前说的JWK</li><li>kid: jwk的ID编号</li><li>x5u: 指向一组X509公共证书的URL</li><li>x5c: X509证书链</li><li>x5t：X509证书的SHA-1指纹</li><li>x5t：S256: X509证书的SHA-256指纹</li><li>typ: 在原本未加密的JWT的基础上增加了 JOSE 和 JOSE+ JSON。JOSE序列化后文会说及。适用于JOSE标头的对象与此JWT混合的情况。</li><li>crit: 字符串数组，包含声明的名称，用作实现定义的扩展，必须由 this-&gt;JWT的解析器处理。不常见。</li></ul></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># payload 中一些固定参数名称的意义, 同时可以在payload中自定义参数</span><br>payload = &#123;<br>    <span class="hljs-string">&quot;iss&quot;</span>: <span class="hljs-string">&quot;DEF123GHIJ&quot;</span>,<br>    <span class="hljs-string">&quot;iat&quot;</span>: time.time()<br> &#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li>iss  【issuer】发布者的url地址</li><li>sub 【subject】该JWT所面向的用户，用于处理特定应用，不是常用的字段</li><li>aud 【audience】接受者的url地址</li><li>exp 【expiration】 该jwt销毁的时间；unix时间戳</li><li>nbf  【not before】 该jwt的使用时间不能早于该时间；unix时间戳</li><li>iat   【issued at】 该jwt的发布时间；unix 时间戳</li><li>jti    【JWT ID】 该jwt的唯一ID编号</li></ul></blockquote><p>生成jwt_token</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># jwt.io 获得</span><br>keystring = <span class="hljs-string">&quot;&quot;&quot;-----BEGIN PRIVATE KEY-----</span><br><span class="hljs-string">MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgevZzL1gdAFr88hb2</span><br><span class="hljs-string">OF/2NxApJCzGCEDdfSp6VQO30hyhRANCAAQRWz+jn65BtOMvdyHKcvjBeBSDZH2r</span><br><span class="hljs-string">1RTwjmYSi9R/zpBnuQ4EiMnCqfMPWiZqB4QdbAd0E7oH50VpuZ1P087G</span><br><span class="hljs-string">-----END PRIVATE KEY-----&quot;&quot;&quot;</span><br><br>jwt_token = jwt.encode(payload,  <span class="hljs-comment"># payload, 有效载体</span><br>                       keystring,  <span class="hljs-comment"># 进行加密签名的密钥</span><br>                       algorithm=<span class="hljs-string">&quot;ES256&quot;</span>,  <span class="hljs-comment"># 指明签名算法方式, 默认是HS256</span><br>                       headers=headers  <span class="hljs-comment"># json web token 数据结构包含两部分, payload(有效载体), headers(标头)</span><br>                       ).decode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br></code></pre></td></tr></table></figure><blockquote><p>JWT 的签名算法有三种:</p><ol><li>对称加密HMAC【哈希消息验证码】 HS256/HS384/HS512 ,这种加密方式没有公钥,私钥之分, 也就是只有一个密钥, 这种加密方式适用于: 服务器将生成的jwt发送给接收方, 接收方将其返回给服务器, 服务器解析 jwt, 完成身份验证.</li><li>非对称加密RSASSA【RSA签名算法】RS256/RS384/RS512</li><li>ECDSA【椭圆曲线数据签名算法】 ES256/ES384/ES512</li></ol><p>不同签名算法使用的签名的密钥不同</p></blockquote><p>参考 <a href="https://jwt.io/">https://jwt.io/</a> </p><h4 id="使用secrets生成token"><a href="#使用secrets生成token" class="headerlink" title="使用secrets生成token"></a>使用secrets生成token</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">&gt;&gt;&gt;: secrets.token_bytes()<br><span class="hljs-string">b&#x27;\xd1Od\xe0\xe4\xf8Rn&lt;/U\xf4G\xdb\x08\xa8\x85\xeb\xba&gt;\x8cO\xa7XV\x1cb\xd6\x11\xa0\xcaK&#x27;</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>secrets.token_bytes(<span class="hljs-number">8</span>)<br><span class="hljs-string">b&#x27;\xfc,9y\xbe]\x0e\xfb&#x27;</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>secrets.token_hex(<span class="hljs-number">16</span>)<br><span class="hljs-string">&#x27;6cf3baf51c12ebfcbe26d08b6bbe1ac0&#x27;</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>secrets.token_urlsafe(<span class="hljs-number">16</span>)<br><span class="hljs-string">&#x27;5t_jLGlV8yp2Q5tolvBesQ&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p><code>token_bytes</code> 函数会返回一段随机的包含了n个字节的字节字符串. 我一开始没有指定要生成多少个字节,所以Python自动为我选择了一个合适的长度. 随后我又调用了一次这个函数并且明确指定了生成8个字节长度的字符串. 然后我们又试了一把 <code>token_hex</code> 函数, 它会返回一段随机的十六进制形式的字符串. 最后的 <code>token_urlsafe</code> 函数会返回一段随机的 URL安全的文本字符串. 其文本已经用 Base64 编码过了! 要注意,在实际使用中,你应该至少生成32字节长度的令牌才能够防止被暴力破解所攻破(<a href="https://docs.python.org/3.6/library/secrets.html#how-many-bytes-should-tokens-use">source</a>).</p></blockquote><h4 id="使用lru-cache缓存函数结果"><a href="#使用lru-cache缓存函数结果" class="headerlink" title="使用lru_cache缓存函数结果"></a>使用lru_cache缓存函数结果</h4><p><code>lru_cache</code> 使用LRU算法(最近最少使用)，对参数输入以及结果缓存。由于使用字典来缓存结果，因此函数的位置和关键字参数必须是可哈希的。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache<br><br><span class="hljs-meta">@lru_cache(maxsize=2)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func_wait</span>(<span class="hljs-params">x</span>):</span><br>    sleep(x)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    start_time = perf_counter()<br>    func_wait(<span class="hljs-number">0.5</span>)    <span class="hljs-comment"># 结果未缓存</span><br>    func_wait(<span class="hljs-number">1</span>)      <span class="hljs-comment"># 结果未缓存</span><br>    func_wait(<span class="hljs-number">0.5</span>)    <span class="hljs-comment"># 结果缓存</span><br>    func_wait(<span class="hljs-number">2</span>)      <span class="hljs-comment"># 结果未缓存</span><br>    func_wait(<span class="hljs-number">1</span>)      <span class="hljs-comment"># 结果未缓存</span><br>    print(<span class="hljs-string">f&#x27;it cost <span class="hljs-subst">&#123;perf_counter()-start_time&#125;</span>s&#x27;</span>)   <span class="hljs-comment"># 4.5s</span><br></code></pre></td></tr></table></figure><blockquote><ul><li><p>如果将<em>maxsize</em>设置为None，则将禁用LRU功能，并且缓存可以无限增长。</p></li><li><p>当<em>maxsize</em>为2的幂时，LRU功能表现最佳。</p></li><li><p>如果将<em>typed</em>设置为true，则将分别缓存不同类型的函数参数。例如，<code>f(3)</code>和<code>f(3.0)</code>将被视为具有不同结果的不同调用。默认为False</p></li></ul></blockquote><h4 id="本地配置文件读写"><a href="#本地配置文件读写" class="headerlink" title="本地配置文件读写"></a>本地配置文件读写</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> configparser<br><br><span class="hljs-comment"># 读取配置文件</span><br>config_path = os.path.abspath(os.path.join(os.path.join(__file__, <span class="hljs-string">&quot;../../..&quot;</span>), <span class="hljs-string">&quot;config/config.conf&quot;</span>))<br>conf = configparser.ConfigParser()<br><br><span class="hljs-comment"># 读取</span><br>conf.get(<span class="hljs-string">&quot;section&quot;</span>, <span class="hljs-string">&quot;visitors_browse_item_number&quot;</span>)   <span class="hljs-comment"># str</span><br><span class="hljs-comment"># 写入</span><br><span class="hljs-keyword">with</span> open(config_path, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>  conf.write(f)<br></code></pre></td></tr></table></figure><p>配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs conf">[section]<br>new_sale_timedelta &#x3D; 5<br>visitors_browse_item_number &#x3D; 20<br></code></pre></td></tr></table></figure><h4 id="手机短信验证码"><a href="#手机短信验证码" class="headerlink" title="手机短信验证码"></a>手机短信验证码</h4><p>调用第三方服务的方式：</p><ol><li>集成SDK - 安装第三方库</li><li>HTTP调用 - 访问URL，交换JSON数据</li></ol><p>调用三方平台的风险就是时间不可预估，但是我们的应用不能够因为三方平台而阻止， 所以通常调用三方平台而且不需要马上获得执行结果的场景都需要进行异步化的处理。</p><p>1、不考虑异步化处理的代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> django_redis <span class="hljs-keyword">import</span>  get_redis_connection<br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> JsonResponse<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">code_phone</span>(<span class="hljs-params">request, mobile</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;发送手机验证码&quot;&quot;&quot;</span><br>    cli = get_redis_connection(alias=<span class="hljs-string">&#x27;default&#x27;</span>)<br>    <span class="hljs-keyword">if</span> cli.get(<span class="hljs-string">f&#x27;mobile_code:<span class="hljs-subst">&#123;mobile&#125;</span>&#x27;</span>):<br>        <span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>: <span class="hljs-number">20000</span>, <span class="hljs-string">&#x27;msg&#x27;</span>: <span class="hljs-string">&#x27;请不要在120s内重复发送手机验证码&#x27;</span>&#125;)<br>    code = gen_mobile_code(length=<span class="hljs-number">6</span>)<br>    cli.set(<span class="hljs-string">f&#x27;mobile_code:<span class="hljs-subst">&#123;mobile&#125;</span>&#x27;</span>, code, ex=<span class="hljs-number">120</span>)<br>    result = send_mobile_code(code=code, mobile=mobile)<br>    <span class="hljs-keyword">return</span> JsonResponse(result)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_mobile_code</span>(<span class="hljs-params">code:str, mobile:str</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;调用手机短信三方接口-山东墨白&quot;&quot;&quot;</span><br>    templateId = <span class="hljs-string">&#x27;TP1801025&#x27;</span><br>    headers = &#123;<span class="hljs-string">&quot;Host&quot;</span>:<span class="hljs-string">&quot;mobai.market.alicloudapi.com&quot;</span>, <span class="hljs-string">&quot;Authorization&quot;</span>:<span class="hljs-string">&quot;APPCODE b9c8d60cf919439dab918dc1cb3c1638&quot;</span>&#125;<br>    url = <span class="hljs-string">f&#x27;http://mobai.market.alicloudapi.com/mobai_sms?param=code:<span class="hljs-subst">&#123;code&#125;</span>&amp;phone=<span class="hljs-subst">&#123;mobile&#125;</span>&amp;templateId=<span class="hljs-subst">&#123;templateId&#125;</span>&#x27;</span><br>    response = requests.post(url=url, headers=headers, timeout=<span class="hljs-number">5</span>)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> json.loads(response.text)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_mobile_code</span>(<span class="hljs-params">length=<span class="hljs-number">6</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定长度的手机验证码&quot;&quot;&quot;</span><br>    code = StringIO()<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(length):<br>        code.write(str(randint(<span class="hljs-number">0</span>, <span class="hljs-number">9</span>)))<br>    <span class="hljs-keyword">return</span> code.getvalue()<br></code></pre></td></tr></table></figure><p>2、异步化处理：使用 celery创建生产者和消费者，生产者放入消息队列中即可，消费者进行消费。这里使用redis的list类型做队列。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><span class="hljs-keyword">import</span> celery<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> django_redis <span class="hljs-keyword">import</span>  get_redis_connection<br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> JsonResponse<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">code_phone</span>(<span class="hljs-params">request, mobile</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;发送手机验证码&quot;&quot;&quot;</span><br>    cli = get_redis_connection(alias=<span class="hljs-string">&#x27;default&#x27;</span>)<br>    <span class="hljs-keyword">if</span> cli.get(<span class="hljs-string">f&#x27;mobile_code:<span class="hljs-subst">&#123;mobile&#125;</span>&#x27;</span>):<br>        <span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>: <span class="hljs-number">20000</span>, <span class="hljs-string">&#x27;msg&#x27;</span>: <span class="hljs-string">&#x27;请不要在120s内重复发送手机验证码&#x27;</span>&#125;)<br>    code = gen_mobile_code(length=<span class="hljs-number">6</span>)<br>    cli.set(<span class="hljs-string">f&#x27;mobile_code:<span class="hljs-subst">&#123;mobile&#125;</span>&#x27;</span>, code, ex=<span class="hljs-number">120</span>)<br>    <span class="hljs-comment"># 调用带有@app.task装饰器的函数，需要使用delay函数，让发送短信的函数延迟执行(将函数调用变成一条消息放到消息队列 - 消息的生产者)</span><br>    send_mobile_code.delay(code=code, mobile=mobile)<br>    <span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>: <span class="hljs-number">20000</span>, <span class="hljs-string">&#x27;msg&#x27;</span>: <span class="hljs-string">&#x27;短信验证码已经发出&#x27;</span>&#125;)<br><br><span class="hljs-comment"># 注册环境变量（注册Django配置文件）</span><br>os.environ.setdefault(<span class="hljs-string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="hljs-string">&#x27;Fangtx.settings&#x27;</span>)<br><span class="hljs-comment"># common.views模块名，broker消息代理(从哪里获取消息队列服务)</span><br>app = celery.Celery(<span class="hljs-string">&#x27;common.views&#x27;</span>, broker=<span class="hljs-string">&#x27;redis://:123456@39.96.51.36:6379/0&#x27;</span>)<br><span class="hljs-comment"># 读取Django项目的配置信息</span><br>app.config_from_object(<span class="hljs-string">&#x27;django.conf:settings&#x27;</span>)<br><br><span class="hljs-meta">@app.task</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_mobile_code</span>(<span class="hljs-params">code:str, mobile:str</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;调用手机短信三方接口-山东墨白&quot;&quot;&quot;</span><br>    templateId = <span class="hljs-string">&#x27;TP1801025&#x27;</span><br>    headers = &#123;<span class="hljs-string">&quot;Host&quot;</span>:<span class="hljs-string">&quot;mobai.market.alicloudapi.com&quot;</span>, <span class="hljs-string">&quot;Authorization&quot;</span>:<span class="hljs-string">&quot;APPCODE b9c8d60cf919439dab918dc1cb3c1638&quot;</span>&#125;<br>    url = <span class="hljs-string">f&#x27;http://mobai.market.alicloudapi.com/mobai_sms?param=code:<span class="hljs-subst">&#123;code&#125;</span>&amp;phone=<span class="hljs-subst">&#123;mobile&#125;</span>&amp;templateId=<span class="hljs-subst">&#123;templateId&#125;</span>&#x27;</span><br>    response = requests.post(url=url, headers=headers, timeout=<span class="hljs-number">5</span>)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> json.loads(response.text)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_mobile_code</span>(<span class="hljs-params">length=<span class="hljs-number">6</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;生成指定长度的手机验证码&quot;&quot;&quot;</span><br>    code = StringIO()<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(length):<br>        code.write(str(randint(<span class="hljs-number">0</span>, <span class="hljs-number">9</span>)))<br>    <span class="hljs-keyword">return</span> code.getvalue()<br></code></pre></td></tr></table></figure><blockquote><p>说明： </p><ol><li><code>@app.task</code> 装饰需要异步处理的任务，调用时需要加入delay()函数；</li><li>消费者使用<code>celery -A common.views worker -l info</code>  ; </li><li>如果celery需要读取django配置需要加上代码 <code>os.environ.setdefault(&#39;DJANGO_SETTINGS_MODULE&#39;, &#39;Fangtx.settings&#39;)</code>  <code>app.config_from_object(&#39;django.conf:settings&#39;)</code></li></ol></blockquote><p>问题：windows平台出现 <code>Celery ValueError: not enough values to unpack (expected 3, got 0)</code></p><p>解决：安装第三方库<code>pip install eventlet</code> 然后在命令后加<code>-P eventlet</code></p><h4 id="图灵机器人"><a href="#图灵机器人" class="headerlink" title="图灵机器人"></a>图灵机器人</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">from</span> urllib.request <span class="hljs-keyword">import</span> urlopen, Request<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> urlencode<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TuringChatMode</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-comment"># API接口地址</span><br>        self.turing_url = <span class="hljs-string">&#x27;http://www.tuling123.com/openapi/api?&#x27;</span><br>        <span class="hljs-comment"># AppKey密钥</span><br>        self.app_key = <span class="hljs-string">&#x27;82622364a28142878dd8ad634eec401c&#x27;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getTuringText</span>(<span class="hljs-params">self, text</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;获取聊天返回内容&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 用户IP</span><br>        user_ip = self.getHostIp()<br>        <span class="hljs-comment"># MAC地址</span><br>        mac_id = self.getMacId()<br>        <span class="hljs-comment"># 请求参数</span><br>        turing_url_data = dict(<br>            <span class="hljs-comment"># AppKey密钥</span><br>            key=self.app_key,<br>            <span class="hljs-comment"># 聊天请求内容</span><br>            info=text,<br>            <span class="hljs-comment"># 用户唯一标志（可以传IP地址或者MAC地址，或者其他的唯一标识）</span><br>            userid=mac_id<br>        )<br>        <span class="hljs-comment"># 发送聊天请求</span><br>        request = Request(self.turing_url + urlencode(turing_url_data))<br>        <span class="hljs-keyword">try</span>:<br>            w_data = urlopen(request)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> error_info:<br>            <span class="hljs-keyword">return</span> error_info<br>        response_text = w_data.read().decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        json_result = json.loads(response_text)<br>        <span class="hljs-keyword">return</span> json_result[<span class="hljs-string">&#x27;text&#x27;</span>]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getHostIp</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;获取用户IP&quot;&quot;&quot;</span><br>        socket_info = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br>        socket_info.connect((<span class="hljs-string">&#x27;8.8.8.8&#x27;</span>, <span class="hljs-number">80</span>))<br>        ip = socket_info.getsockname()[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">return</span> ip<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getMacId</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;获取MAC地址&quot;&quot;&quot;</span><br>        node = uuid.getnode()<br>        mac = uuid.UUID(int=node).hex[<span class="hljs-number">-12</span>:]<br>        <span class="hljs-keyword">return</span> mac<br><br><br><span class="hljs-comment"># 聊天程序主入口</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    print(<span class="hljs-string">&quot;您可以和机器人聊天了（退出请输入q）&quot;</span>)<br>    turing = TuringChatMode()<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        msg = input(<span class="hljs-string">&quot;\n我:&quot;</span>)<br>        <span class="hljs-comment"># 设定输入q，退出聊天。</span><br>        <span class="hljs-keyword">if</span> msg == <span class="hljs-string">&#x27;q&#x27;</span>:<br>            exit(<span class="hljs-string">&quot;聊天结束!&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            turing_data = turing.getTuringText(msg)<br>            print(<span class="hljs-string">&quot;机器人:&quot;</span>, turing_data)<br></code></pre></td></tr></table></figure><h4 id="发送Server酱微信通知"><a href="#发送Server酱微信通知" class="headerlink" title="发送Server酱微信通知"></a>发送Server酱微信通知</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><br>SERVER_CHAN_CONF = &#123;<br>    <span class="hljs-string">&quot;is_server_chan&quot;</span>: <span class="hljs-literal">True</span>,<br>    <span class="hljs-string">&quot;server_address&quot;</span>: <span class="hljs-string">&quot;https://sc.ftqq.com/&quot;</span>,<br>    <span class="hljs-string">&quot;secret&quot;</span>: <span class="hljs-string">&quot;SCU75107Tf7aa9efty6gbe5b26d5c483e6edf72c5e0d62b19cbf8&quot;</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_server_chan</span>(<span class="hljs-params">title=None, content=None</span>):</span><br><br>    secret = SERVER_CHAN_CONF[<span class="hljs-string">&quot;secret&quot;</span>].strip()<br>    server_address = SERVER_CHAN_CONF[<span class="hljs-string">&quot;server_address&quot;</span>].strip()<br>    <span class="hljs-keyword">if</span> SERVER_CHAN_CONF[<span class="hljs-string">&quot;is_server_chan&quot;</span>] <span class="hljs-keyword">and</span> all([secret, server_address]):<br>        <span class="hljs-keyword">try</span>:<br>            server_address += <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;secret&#125;</span>.send&#x27;</span><br>            params = &#123;<span class="hljs-string">&quot;text&quot;</span>: title, <span class="hljs-string">&quot;desp&quot;</span>: content&#125;<br>            response = requests.get(server_address, params).json()<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&quot;errno&quot;</span>] == <span class="hljs-number">0</span>:<br>                print(<span class="hljs-string">&quot;已下发 Server酱 微信通知, 请查收&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                print(response)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            print(<span class="hljs-string">u&quot;Server酱 配置有误 &#123;&#125;&quot;</span>.format(e))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;缺少必要参数&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    send_server_chan(<span class="hljs-string">&#x27;测试标题&#x27;</span>, <span class="hljs-string">&#x27;测试内容&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p><a href="http://sc.ftqq.com/">Server酱官网</a></p><h4 id="接入高德地图"><a href="#接入高德地图" class="headerlink" title="接入高德地图"></a>接入高德地图</h4><p><a href="https://lbs.amap.com/api/">高德地图开发文档</a></p><p>示例：地理/逆地理编码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">import</span> requests<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gaode_forward</span>(<span class="hljs-params">address</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;正向查找：输入位置返回经纬度&quot;&quot;&quot;</span><br>    key = <span class="hljs-string">&#x27;f618f239821683b024fbfa22c38f32ca&#x27;</span><br>    <span class="hljs-comment"># address = quote(address)</span><br>    response = requests.get(<span class="hljs-string">f&#x27;https://restapi.amap.com/v3/geocode/geo?key=<span class="hljs-subst">&#123;key&#125;</span>&amp;address=<span class="hljs-subst">&#123;address&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        result = json.loads(response.text)<br>        <span class="hljs-keyword">return</span> result<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gaode_backward</span>(<span class="hljs-params">x, y</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;逆向查找：通过经纬度查找位置&quot;&quot;&quot;</span><br>    key = <span class="hljs-string">&#x27;f618f239821683b024fbfa22c38f32ca&#x27;</span><br>    <span class="hljs-comment"># address = quote(address)</span><br>    response = requests.get(<span class="hljs-string">f&#x27;https://restapi.amap.com/v3/geocode/regeo?key=<span class="hljs-subst">&#123;key&#125;</span>&amp;location=<span class="hljs-subst">&#123;x&#125;</span>, <span class="hljs-subst">&#123;y&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> response.text<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-comment"># result = gaode_forward(&#x27;四川省成都市&#x27;)</span><br>    result = gaode_backward(<span class="hljs-number">104.076331</span>,<span class="hljs-number">30.623141</span>)<br>    print(result)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><blockquote><p>可以使用第三方封装的<a href="https://geocoder.readthedocs.io/">各平台地图SDK</a>。</p></blockquote><h4 id="云存储服务器"><a href="#云存储服务器" class="headerlink" title="云存储服务器"></a>云存储服务器</h4><p>可以选择第三方提供的云存储服务器：AWS/Qiniu/Bmob/OSS/LeanCloud</p><p>国内我们可以选择<a href="http://qiniu.com/">七牛</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 上传文件</span><br><span class="hljs-keyword">from</span> qiniu <span class="hljs-keyword">import</span> Auth, put_file, etag<br><br>access_key = <span class="hljs-string">&#x27;tmaN2Yd2jIzgy-XucHjWb5ezNBZDjGbAdwsCPR8j&#x27;</span><br>secret_key = <span class="hljs-string">&#x27;W6Mcu4Qj0_gbQAMwfXID5RyzLvFqwoCRKONrsJWr&#x27;</span><br><span class="hljs-comment">#构建鉴权对象</span><br>q = Auth(access_key, secret_key)<br><span class="hljs-comment">#要上传的空间</span><br>bucket_name = <span class="hljs-string">&#x27;data&#x27;</span><br><span class="hljs-comment">#上传到七牛后保存的文件名</span><br>key = <span class="hljs-string">&#x27;xxx.docx&#x27;</span><br><span class="hljs-comment">#生成上传 Token，可以指定过期时间等</span><br>token = q.upload_token(bucket_name, key, <span class="hljs-number">10</span>)<br><span class="hljs-comment">#要上传文件的本地路径</span><br>localfile = <span class="hljs-string">&#x27;./xxx.docx&#x27;</span><br>ret, info = put_file(token, key, localfile)<br>print(info)<br><span class="hljs-keyword">assert</span> ret[<span class="hljs-string">&#x27;key&#x27;</span>] == key<br><span class="hljs-keyword">assert</span> ret[<span class="hljs-string">&#x27;hash&#x27;</span>] == etag(localfile)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 下载文件</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> qiniu <span class="hljs-keyword">import</span> Auth<br><br>access_key = <span class="hljs-string">&#x27;tmaN2Yd2jIzgy-XucHjWb5ezNBZDjGbAdwsCPR8j&#x27;</span><br>secret_key = <span class="hljs-string">&#x27;W6Mcu4Qj0_gbQAMwfXID5RyzLvFqwoCRKONrsJWr&#x27;</span><br>q = Auth(access_key, secret_key)<br><span class="hljs-comment">#有两种方式构造base_url的形式</span><br>bucket_domain = <span class="hljs-string">&#x27;plodffopm.bkt.clouddn.com&#x27;</span><br><span class="hljs-comment">#上传到七牛后保存的文件名</span><br>key = <span class="hljs-string">&#x27;吕皓洁python开发工程师.docx&#x27;</span><br>base_url = <span class="hljs-string">&#x27;http://%s/%s&#x27;</span> % (bucket_domain, key)<br><br><span class="hljs-comment">#可以设置token过期时间</span><br>private_url = q.private_download_url(base_url, expires=<span class="hljs-number">3600</span>)<br><span class="hljs-comment"># print(private_url)</span><br>r = requests.get(private_url)<br><span class="hljs-keyword">assert</span> r.status_code == <span class="hljs-number">200</span><br><span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./222.docx&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(r.content)<br></code></pre></td></tr></table></figure><h4 id="snowflake算法"><a href="#snowflake算法" class="headerlink" title="snowflake算法"></a>snowflake算法</h4><p>Snowflake是Twitter提出来的一个算法，其目的是生成一个64bit的整数。</p><p><img src="https://stellae.gitee.io/myblog/images/images/1552472-20191115134418390-159822005.png"></p><ul><li><p>1bit:一般是符号位，不做处理</p></li><li><p>41bit:用来记录时间戳，这里可以记录69年，如果设置好起始时间比如今年是2018年，那么可以用到2089年，到时候怎么办？要是这个系统能用69年，我相信这个系统早都重构了好多次了。</p></li><li><p>10bit:10bit用来记录机器ID，总共可以记录1024台机器，一般用前5位代表数据中心，后面5位是某个数据中心的机器ID</p></li><li><p>12bit:循环位，用来对同一个毫秒之内产生不同的ID，12位可以最多记录4095个，也就是在同一个机器同一毫秒最多记录4095个，多余的需要进行等待下毫秒。<br>上面只是一个将64bit划分的标准，当然也不一定这么做，可以根据不同业务的具体场景来划分，比如下面给出一个业务场景：</p><ol><li>服务目前QPS10万，预计几年之内会发展到百万。</li><li>当前机器三地部署，上海，北京，深圳都有。</li><li>当前机器10台左右，预计未来会增加至百台。<br>这个时候我们根据上面的场景可以再次合理的划分62bit,QPS几年之内会发展到百万，那么每毫秒就是千级的请求，目前10台机器那么每台机器承担百级的请求，为了保证扩展，后面的循环位可以限制到1024，也就是2^10，那么循环位10位就足够了。</li><li>机器三地部署我们可以用3bit总共8来表示机房位置，当前的机器10台，为了保证扩展到百台那么可以用7bit 128来表示，时间位依然是41bit,那么还剩下64-10-3-7-41-1 = 2bit,还剩下2bit可以用来进行扩展。</li></ol></li></ul><p><img src="https://stellae.gitee.io/myblog/images/images/1552472-20191115134454552-13309564.png"></p><ul><li>时钟回拨<br> 因为机器的原因会发生时间回拨，我们的雪花算法是强依赖我们的时间的，如果时间发生回拨，有可能会生成重复的ID，在我们上面的nextId中我们用当前时间和上一次的时间进行判断，如果当前时间小于上一次的时间那么肯定是发生了回拨，算法会直接抛出异常.</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> logging<br><br><br><span class="hljs-comment"># 64位ID的划分</span><br>WORKER_ID_BITS = <span class="hljs-number">5</span><br>DATACENTER_ID_BITS = <span class="hljs-number">5</span><br>SEQUENCE_BITS = <span class="hljs-number">12</span><br><br><span class="hljs-comment"># 最大取值计算</span><br>MAX_WORKER_ID = <span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; WORKER_ID_BITS)  <span class="hljs-comment"># 2**5-1 0b11111</span><br>MAX_DATACENTER_ID = <span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; DATACENTER_ID_BITS)<br><br><span class="hljs-comment"># 移位偏移计算</span><br>WOKER_ID_SHIFT = SEQUENCE_BITS<br>DATACENTER_ID_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS<br>TIMESTAMP_LEFT_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS + DATACENTER_ID_BITS<br><br><span class="hljs-comment"># 序号循环掩码</span><br>SEQUENCE_MASK = <span class="hljs-number">-1</span> ^ (<span class="hljs-number">-1</span> &lt;&lt; SEQUENCE_BITS)<br><br><span class="hljs-comment"># Twitter元年时间戳</span><br>TWEPOCH = <span class="hljs-number">1288834974657</span><br><br><br>logger = logging.getLogger(<span class="hljs-string">&#x27;flask.app&#x27;</span>)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvalidSystemClock</span>(<span class="hljs-params">Exception</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    时钟回拨异常</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IdWorker</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    用于生成IDs</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, datacenter_id, worker_id, sequence=<span class="hljs-number">0</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        初始化</span><br><span class="hljs-string">        :param datacenter_id: 数据中心（机器区域）ID</span><br><span class="hljs-string">        :param worker_id: 机器ID</span><br><span class="hljs-string">        :param sequence: 序列号</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># sanity check</span><br>        <span class="hljs-keyword">if</span> worker_id &gt; MAX_WORKER_ID <span class="hljs-keyword">or</span> worker_id &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;worker_id值越界&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> datacenter_id &gt; MAX_DATACENTER_ID <span class="hljs-keyword">or</span> datacenter_id &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;datacenter_id值越界&#x27;</span>)<br><br>        self.worker_id = worker_id<br>        self.datacenter_id = datacenter_id<br>        self.sequence = sequence<br><br>        self.last_timestamp = <span class="hljs-number">-1</span>  <span class="hljs-comment"># 上次计算的时间戳</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_gen_timestamp</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成整数时间戳</span><br><span class="hljs-string">        :return:int timestamp</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> int(time.time() * <span class="hljs-number">1000</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_id</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取新ID</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        timestamp = self._gen_timestamp()<br><br>        <span class="hljs-comment"># 时钟回拨</span><br>        <span class="hljs-keyword">if</span> timestamp &lt; self.last_timestamp:<br>            logging.error(<span class="hljs-string">&#x27;clock is moving backwards. Rejecting requests until &#123;&#125;&#x27;</span>.format(self.last_timestamp))<br>            <span class="hljs-keyword">raise</span> InvalidSystemClock<br><br>        <span class="hljs-keyword">if</span> timestamp == self.last_timestamp:<br>            self.sequence = (self.sequence + <span class="hljs-number">1</span>) &amp; SEQUENCE_MASK<br>            <span class="hljs-keyword">if</span> self.sequence == <span class="hljs-number">0</span>:<br>                timestamp = self._til_next_millis(self.last_timestamp)<br>        <span class="hljs-keyword">else</span>:<br>            self.sequence = <span class="hljs-number">0</span><br><br>        self.last_timestamp = timestamp<br><br>        new_id = ((timestamp - TWEPOCH) &lt;&lt; TIMESTAMP_LEFT_SHIFT) | (self.datacenter_id &lt;&lt; DATACENTER_ID_SHIFT) | \<br>                 (self.worker_id &lt;&lt; WOKER_ID_SHIFT) | self.sequence<br>        <span class="hljs-keyword">return</span> new_id<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_til_next_millis</span>(<span class="hljs-params">self, last_timestamp</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        等到下一毫秒</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        timestamp = self._gen_timestamp()<br>        <span class="hljs-keyword">while</span> timestamp &lt;= last_timestamp:<br>            timestamp = self._gen_timestamp()<br>        <span class="hljs-keyword">return</span> timestamp<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    worker = IdWorker(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>)<br>    print(worker.get_id())<br></code></pre></td></tr></table></figure><blockquote><ul><li>datacenter_id:  数据中心（机器区域）ID</li><li>worker_id:  机器ID</li><li>sequence:  序列号</li></ul></blockquote>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>实用功能</tag>
      
      <tag>工具类</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Docker简易上手指南</title>
    <link href="/Myblog/2019/01/09/Docker%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E6%8C%87%E5%8D%97/"/>
    <url>/Myblog/2019/01/09/Docker%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<h3 id="Docker简介"><a href="#Docker简介" class="headerlink" title="Docker简介"></a>Docker简介</h3><p>软件开发中最为麻烦的事情可能就是配置环境了。由于用户使用的操作系统具有多样性，即便使用跨平台的开发语言（如Java和Python）都不能保证代码能够在各种平台下都可以正常的运转，而且可能在不同的环境下我们的软件需要依赖的其他软件包也是不一样的。</p><p>那么问题来了，我们再安装软件的时候可不可以把软件运行的环境一并安装？也就是说在安装软件的时候，我们是不是可以把原始环境一模一样地复制过来呢？</p><p>虚拟机（virtual machine）就是带环境安装的一种解决方案，它可以在一种操作系统里面运行另一种操作系统，比如在Windows系统里面运行Linux系统，在macOS上运行Windows，而应用程序对此毫无感知。使用过虚拟机的人都知道，虚拟机用起来跟真实系统一模一样，而对于虚拟机的宿主系统来说，虚拟机就是一个普通文件，不需要了就删掉，对宿主系统或者其他的程序并没有影响。但是虚拟机通常会占用较多的系统资源，启动和关闭也非常的缓慢，总之用户体验没有想象中的那么好。</p><p>Docker属于对Linux容器技术的一种封装，它提供了简单易用的容器使用接口，是目前最流行的 Linux 容器解决方案。Docker将应用程序与该程序的依赖打包在一个文件里面，运行这个文件，就会生成一个虚拟容器。程序在这个虚拟容器里运行，就好像在真实的物理机上运行一样。有了Docker就再也不用担心环境问题了。</p><p>每一个容器又是一个linux系统(Debian)。</p><p>目前，Docker主要用于几下几个方面：</p><ol><li>提供一次性的环境。</li><li>提供弹性的云服务（利用Docker很容易实现扩容和收缩）。</li><li>实践微服务架构（隔离真实环境在容器中运行多个服务）。</li></ol><h3 id="CentOS下的安装和使用"><a href="#CentOS下的安装和使用" class="headerlink" title="CentOS下的安装和使用"></a>CentOS下的安装和使用</h3><p>下面的讲解以CentOS为例，使用<a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/">Ubuntu</a>、<a href="https://docs.docker.com/docker-for-mac/install/">macOS</a>或<a href="https://docs.docker.com/docker-for-windows/install/">Windows</a>的用户可以通过点击链接了解这些平台下如何安装和使用Docker。</p><ol start="0"><li>确定操作系统内核版本（CentOS 7要求64位，内核版本3.10+；CentOS 6要求64位，内核版本2.6+）。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">uname -r<br></code></pre></td></tr></table></figure><ol><li>在CentOS下使用yum安装Docker并启动。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell">yum install docker-io -y<br>systemctl start docker<br></code></pre></td></tr></table></figure><ol start="2"><li>检视Docker的信息和版本。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker version<br>docker info<br></code></pre></td></tr></table></figure><ol start="3"><li>下载镜像文件</li></ol> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker pull &lt;name&gt;：&lt;版本&gt;<br><span class="hljs-meta">#</span><span class="bash"> 不指定版本默认为latest</span><br></code></pre></td></tr></table></figure><ol start="4"><li>创建容器。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker run &lt;image-id&gt;<br>docker run -p &lt;port1&gt;:&lt;port2&gt; &lt;name&gt;<br></code></pre></td></tr></table></figure><ol start="5"><li>查看镜像文件。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker image ls<br>docker images<br></code></pre></td></tr></table></figure><ol start="6"><li>删除镜像文件。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker rm &lt;name&gt;<br>docker rm -f &lt;name&gt;<br></code></pre></td></tr></table></figure><ol start="8"><li>查看正在运行容器。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker ps<br></code></pre></td></tr></table></figure><ol start="9"><li>停止运行的容器。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker stop &lt;container-id&gt;<br>docker stop &lt;name&gt;<br></code></pre></td></tr></table></figure><ol start="10"><li>启动运行容器。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker start &lt;container-id&gt;<br>docker start &lt;name&gt;<br></code></pre></td></tr></table></figure><ol start="11"><li>查看所有的容器。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker container ls -a<br></code></pre></td></tr></table></figure><ol start="12"><li>清空所有容器（慎用）。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker container prune<br></code></pre></td></tr></table></figure><p>对于那些不会自动终止的容器，就可以用下面的方式来停止。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker container kill &lt;container-id&gt;<br></code></pre></td></tr></table></figure><p>在Ubuntu（内核版本3.10+）下面安装和启动Docker，可以按照如下的步骤进行。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Shell">apt update<br>apt install docker-ce<br>service docker start<br></code></pre></td></tr></table></figure><p>在有必要的情况下，可以更换Ubuntu软件下载源来提升下载速度，具体的做法请参照<a href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/">https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/</a>。</p><p>安装Docker后，由于直接访问dockerhub下载镜像会非常缓慢，建议更换国内镜像，可以通过修改<code>/etc/docker/daemon.js</code>文件来做到。一般情况下，如果使用阿里云不需要更换。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&#123;<br><span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<br>        <span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span>,<br>        <span class="hljs-string">&quot;https://registry.docker-cn.com&quot;</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Docker实战"><a href="#Docker实战" class="headerlink" title="Docker实战"></a>Docker实战</h3><h4 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h4><p>Docker的使用肯定不止上面这点东西，但是有了这些知识之后，我们已经可以开始感受Docker的强大之处。下面我们就基于Docker来搭建HTTP服务器（Nginx）环境。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker container run -d -p 80:80 --rm --name mynginx nginx<br></code></pre></td></tr></table></figure><blockquote><p>说明：上面的参数<code>-d</code>表示守护进程；<code>-p</code>是用来映射容器的端口到宿主机的端口；<code>--rm</code>表示容器停止后自动删除容器，例如通过<code>docker container stop mynginx</code>以后，容器就没有了；<code>--name</code>是自定义容器的名字；<code>nginx</code>指定使用镜像。</p></blockquote><p>如果需要将自己的页面部署到Nginx上，可以使用容器的拷贝命令将当前文件夹下所有的文件和文件夹拷贝到容器的指定目录中。当然也可以从容器中拷贝文件到我们指定的路径下。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker container cp ./index.html mynginx:/usr/local/nginx/html<br></code></pre></td></tr></table></figure><p>如果不愿意拷贝文件也可以将文件夹映射到Nginx保存页面文件的目录。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker container run -d -p 80:80 --rm --name mynginx --volume &quot;$PWD/html&quot;:/usr/share/nginx/html nginx<br></code></pre></td></tr></table></figure><blockquote><p>说明：<code>--volume</code> 可以简写成<code>-v</code> ，将<code>:</code>前后的目录映射起来，这样可以实现数据和容器分离，不用担心删除容器后数据丢失的问题。</p></blockquote><h4 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h4><p>下载MySQL镜像。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker search mysql<br>docker pull mysql:5.7<br>docker images<br></code></pre></td></tr></table></figure><p>启动容器运行MySQL。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker run -d -p 3306:3306 --name mysql57 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7<br></code></pre></td></tr></table></figure><blockquote><p>说明：上面的参数<code>-d</code>表示守护进程；<code>-p</code>是用来映射容器的端口到宿主机的端口；<code>--name</code>是指定义容器的名字；<code>-e MYSQL_ROOT_PASSWORD=123456</code>指定数据库密码，默认用户为root；<code>mysql:5.7 </code>指定使用镜像</p></blockquote><p>这样我们就成功创建了一个mysql5.7，但是这样还不够完善，数据是存放在容器里面的。应该使用数据卷操作，在容器外存放数据。</p><p>1、创建存放数据目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p /root/mysql/conf<br>mkdir -p /root/mysql/data<br>cd /root/mysql/conf<br>vim mysqld.cnf<br><span class="hljs-meta">#</span><span class="bash"> 将下面内容写入配置文件</span><br>[mysqld]<br>pid-file=/var/run/mysqld/mysqld.pid<br>socket=/var/run/mysqld/mysqld.sock<br>datadir=/var/lib/mysql<br>log-error=/var/log/mysql/error.log<br>server-id=1<br>log-bin=/var/log/mysql/mysql-bin.log<br>expire_logs_days=30<br>max_binlog_size=256M<br>symbolic-links=0<br></code></pre></td></tr></table></figure><p>2、创建容器，映射目录。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d -p 3306:3306 -v /root/mysql/conf:/etc/mysql/mysql.conf.d -v /root/mysql/data:/var/lib/mysql --name mysql57 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7<br></code></pre></td></tr></table></figure><blockquote><p>说明： <code>-v</code> 映射文件夹，这样数据库的数据存放在/root/mysql/data中，容器删除也不会丢失数据。</p></blockquote><p>如果配置文件之前有错，需要清除之前的数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl restart docker<br>rm -rf /root/mysql/data/*<br></code></pre></td></tr></table></figure><p>问题：在使用MySQL 8.x时可能会遇到“error 2059: Authentication plugin ‘caching_sha2_password’ cannot be loaded”的问题，这是因为MySQL 8.x默认使用了名为“caching_sha2_password”的机制对用户口令进行了更好的保护，所以这里我们使用mysql 5.7版本，如果客户端没有更新有可能无法基于这种方式进行身份验证，可以按照下面的方式加以解决。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker exec -it mysql8-docker /bin/bash<br></code></pre></td></tr></table></figure><p>进入容器的交互式Shell之后，可以首先利用MySQL的客户端工具连接MySQL服务器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Shell">mysql -u root -p<br>Enter password:<br>Your MySQL connection id is 16<br>Server version: 8.0.12 MySQL Community Server - GPL<br>Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.<br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br>Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.<br><span class="hljs-meta">mysql&gt;</span><br></code></pre></td></tr></table></figure><p>接下来通过SQL来修改用户口令就可以了。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">user</span> <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-keyword">identified</span> <span class="hljs-keyword">with</span> mysql_native_password <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;123456&#x27;</span> <span class="hljs-keyword">password</span> <span class="hljs-keyword">expire</span> <span class="hljs-keyword">never</span>;<br></code></pre></td></tr></table></figure><p>当然，如果愿意你也可以查看一下用户表检查是否修改成功。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">use</span> mysql;<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>, host, <span class="hljs-keyword">plugin</span>, authentication_string <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> <span class="hljs-keyword">user</span>=<span class="hljs-string">&#x27;root&#x27;</span>;<br>+<span class="hljs-comment">------+-----------+-----------------------+-------------------------------------------+</span><br>| user | host      | plugin                | authentication_string                     |<br>+<span class="hljs-comment">------+-----------+-----------------------+-------------------------------------------+</span><br>| root | %         | mysql_native_password | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |<br>| root | localhost | mysql_native_password | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |<br>+<span class="hljs-comment">------+-----------+-----------------------+-------------------------------------------+</span><br>2 rows in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure><p>接下来就已经可以访问你的MySQL服务器啦，当然远程连接的时候不要忘了在防火墙上开启对应的端口。</p><h5 id="Mysql读写分离配置"><a href="#Mysql读写分离配置" class="headerlink" title="Mysql读写分离配置"></a>Mysql读写分离配置</h5><p>master进行写操作，slave进行读操作</p><p>创建<code>master</code>,<code>slave-1</code>,<code>slave-2</code>,<code>slave-3</code> 目录，建立子文件夹<code>conf/mysqld.cnf</code>和<code>data</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">├── master<br>│   ├── conf<br>│   ├── data<br>├── slave-1<br>│   ├── conf<br>│   ├── data<br>├── slave-2<br>│   ├── conf<br>│   ├── data<br>└── slave-3<br>    ├── conf<br>    ├── data<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[mysqld]<br>pid-file=/var/run/mysqld/mysqld.pid<br>socket=/var/run/mysqld/mysqld.sock<br>datadir=/var/lib/mysql<br>log-error=/var/log/mysql/error.log<br>server-id=11  # slave-11/12/13,master-1<br>log-bin=/var/log/mysql/mysql-bin.log<br>expire_logs_days=30<br>max_binlog_size=256M<br>symbolic-links=0<br><span class="hljs-meta">#</span><span class="bash"> 慢查询日志</span><br>slow_query_log=ON<br>slow_query_log_file=/usr/local/mysql/data/slow.log<br>long_query_time=1<br></code></pre></td></tr></table></figure><p>docker模拟一主带三从</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> mysql-master</span><br>docker run -d -p 3306:3306 -v /root/mysql/master/conf:/etc/mysql/mysql.conf.d -v /root/mysql/master/data:/var/lib/mysql --name mysql-master -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7<br><span class="hljs-meta">#</span><span class="bash"> mysql-slave-1</span><br>docker run -d -p 3307:3306 -v /root/mysql/slave-1/conf:/etc/mysql/mysql.conf.d -v /root/mysql/slave-1/data:/var/lib/mysql --name mysql-slave-1 -e MYSQL_ROOT_PASSWORD=123456 --link mysql-master:mysql-master mysql:5.7<br><span class="hljs-meta">#</span><span class="bash"> mysql-slave-2</span><br>docker run -d -p 3308:3306 -v /root/mysql/slave-2/conf:/etc/mysql/mysql.conf.d -v /root/mysql/slave-2/data:/var/lib/mysql --name mysql-slave-2 -e MYSQL_ROOT_PASSWORD=123456 --link mysql-master:mysql-master mysql:5.7<br><span class="hljs-meta">#</span><span class="bash"> mysql-slave-3</span><br>docker run -d -p 3309:3306 -v /root/mysql/slave-3/conf:/etc/mysql/mysql.conf.d -v /root/mysql/slave-3/data:/var/lib/mysql --name mysql-slave-3 -e MYSQL_ROOT_PASSWORD=123456 --link mysql-master:mysql-master mysql:5.7<br></code></pre></td></tr></table></figure><p>进入master数据库，创建奴隶用户和口令</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">grant</span> <span class="hljs-keyword">replication</span> <span class="hljs-keyword">slave</span> <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> <span class="hljs-string">&#x27;slave&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-keyword">identified</span> <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;iamslave&#x27;</span>;<br><span class="hljs-keyword">flush</span> <span class="hljs-keyword">privileges</span>;    <span class="hljs-comment"># 刷新使生效</span><br><span class="hljs-keyword">show</span> <span class="hljs-keyword">master</span> <span class="hljs-keyword">status</span>;  <span class="hljs-comment"># 查看文件和位置</span><br></code></pre></td></tr></table></figure><p>分别进入slave数据库，验证口令</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">reset</span> <span class="hljs-keyword">slave</span>;<br><span class="hljs-keyword">change</span> <span class="hljs-keyword">master</span> <span class="hljs-keyword">to</span> master_host=<span class="hljs-string">&#x27;mysql-master&#x27;</span>, master_user=<span class="hljs-string">&#x27;slave&#x27;</span>, master_password=<span class="hljs-string">&#x27;iamslave&#x27;</span>, master_log_file=<span class="hljs-string">&#x27;mysql-bin.000001&#x27;</span>, master_log_pos=<span class="hljs-number">590</span>;<br><span class="hljs-keyword">start</span> <span class="hljs-keyword">slave</span>;<br><span class="hljs-keyword">show</span> <span class="hljs-keyword">slave</span> <span class="hljs-keyword">status</span>\G   <span class="hljs-comment"># 查看奴隶状态</span><br></code></pre></td></tr></table></figure><p>这样数据库的主从就配置好了，现在只需要在程序中配置数据库连接以及路由即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># settings.py</span><br>DATABASES = &#123;<br>    <span class="hljs-string">&#x27;default&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>,<br>        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;120.77.222.217&#x27;</span>,<br>        <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-number">3306</span>,<br>        <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;fangtx&#x27;</span>,<br>        <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>,<br>        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        <span class="hljs-string">&#x27;TIME_ZONE&#x27;</span>: <span class="hljs-string">&#x27;Asia/Chongqing&#x27;</span>,<br>    &#125;,<br>    <span class="hljs-string">&#x27;slave1&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>,<br>        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;120.77.222.217&#x27;</span>,<br>        <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-number">3307</span>,<br>        <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;fangtx&#x27;</span>,<br>        <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>,<br>        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        <span class="hljs-string">&#x27;TIME_ZONE&#x27;</span>: <span class="hljs-string">&#x27;Asia/Chongqing&#x27;</span>,<br>    &#125;,<br>    <span class="hljs-string">&#x27;slave2&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>,<br>        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;120.77.222.217&#x27;</span>,<br>        <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-number">3308</span>,<br>        <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;fangtx&#x27;</span>,<br>        <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>,<br>        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        <span class="hljs-string">&#x27;TIME_ZONE&#x27;</span>: <span class="hljs-string">&#x27;Asia/Chongqing&#x27;</span>,<br>    &#125;,<br>    <span class="hljs-string">&#x27;slave3&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>,<br>        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;120.77.222.217&#x27;</span>,<br>        <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-number">3309</span>,<br>        <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;fangtx&#x27;</span>,<br>        <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>,<br>        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        <span class="hljs-string">&#x27;TIME_ZONE&#x27;</span>: <span class="hljs-string">&#x27;Asia/Chongqing&#x27;</span>,<br>    &#125;,<br>    <span class="hljs-string">&#x27;hrs&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>,<br>        <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;hrs&#x27;</span>,<br>        <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-number">3306</span>,<br>        <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>,<br>        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;120.77.222.217&#x27;</span>,<br>        <span class="hljs-string">&#x27;TIME_ZONE&#x27;</span>: <span class="hljs-string">&#x27;Asia/Chongqing&#x27;</span>,<br>    &#125;<br>&#125;<br><br>DATABASE_ROUTERS = [<br>    <span class="hljs-string">&#x27;common.routers.BackendRouter&#x27;</span>,<br>    <span class="hljs-string">&#x27;common.routers.MasterSlaveRouter&#x27;</span>,<br>]<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">数据库分库和主从复制的路由类</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> random<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BackendRouter</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;分库路由&quot;&quot;&quot;</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_read</span>(<span class="hljs-params">model, **hints</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Attempts to read auth models go to auth_db.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> model._meta.app_label == <span class="hljs-string">&#x27;hrs&#x27;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;hrs&#x27;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_write</span>(<span class="hljs-params">model, **hints</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Attempts to write auth models go to auth_db.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> model._meta.app_label == <span class="hljs-string">&#x27;hrs&#x27;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;hrs&#x27;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_relation</span>(<span class="hljs-params">obj1, obj2, **hints</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Allow relations if a model in the auth app is involved.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_migrate</span>(<span class="hljs-params">db, app_label, model_name=None, **hints</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Make sure the auth app only appears in the &#x27;auth_db&#x27;</span><br><span class="hljs-string">        database.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MasterSlaveRouter</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;主从复制路由&quot;&quot;&quot;</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_read</span>(<span class="hljs-params">model, **hints</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Attempts to read auth models go to auth_db.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> random.choice((<span class="hljs-string">&#x27;slave1&#x27;</span>, <span class="hljs-string">&#x27;slave2&#x27;</span>, <span class="hljs-string">&#x27;slave3&#x27;</span>))<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_write</span>(<span class="hljs-params">model, **hints</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Attempts to write auth models go to auth_db.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;default&#x27;</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_relation</span>(<span class="hljs-params">obj1, obj2, **hints</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Allow relations if a model in the auth app is involved.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_migrate</span>(<span class="hljs-params">db, app_label, model_name=None, **hints</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Make sure the auth app only appears in the &#x27;auth_db&#x27;</span><br><span class="hljs-string">        database.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><p>注意：master上进行数据修改会自动同步到slave上，反之是不行的。所以master上做写操作，slave分摊读操作。</p><h4 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h4><p>下载Redis镜像。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull redis<br></code></pre></td></tr></table></figure><h5 id="Redis配置一主带三从"><a href="#Redis配置一主带三从" class="headerlink" title="Redis配置一主带三从"></a>Redis配置一主带三从</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> master</span><br>docker run -d -p 6379:6379 --name redis-master redis:latest redis-server --requirepass 123456<br><span class="hljs-meta">#</span><span class="bash"> slaves</span><br>docker run -d --name redis-slave-1 --link redis-master:redis-master redis:latest redis-server --slaveof redis-master 6379 --masterauth 123456<br><br>docker run -d --name redis-slave-2 --link redis-master:redis-master redis:latest redis-server --slaveof redis-master 6379 --masterauth 123456<br><br>docker run -d --name redis-slave-3 --link redis-master:redis-master redis:latest redis-server --slaveof redis-master 6379 --masterauth 123456<br></code></pre></td></tr></table></figure><blockquote><p>说明：<code>--requirepass 123456</code>设置口令；<code>--link redis-master:redis-master</code>给容器指定一个网络别名，因为容器的内网ip地址有可能会变；<code>--slaveof redis-master 6379</code>配置主从；<code>--masterauth 123456</code>验证口令。</p></blockquote><p>进入容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it redis-master /bin/bash<br>redis-cli<br>info replication<br></code></pre></td></tr></table></figure><h4 id="安装Git私服"><a href="#安装Git私服" class="headerlink" title="安装Git私服"></a>安装Git私服</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d -p 8443:443 -p 8080:80 --name gitlab -v /root/gitlab/config:/etc/gitlab -v /root/gitlab/logs:/var/log/gitlab -v /root/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce:latest<br></code></pre></td></tr></table></figure><h3 id="Docker容器打包"><a href="#Docker容器打包" class="headerlink" title="Docker容器打包"></a>Docker容器打包</h3><p>如果我们能够在Docker中完成项目的部署，并且将整个部署好的容器打包成镜像文件进行分发和安装，这样就可以解决项目在多个节点上进行部署时可能遇到的麻烦，而且整个部署可以在很短的时间内完成。</p><ol><li><p>创建镜像文件。</p><p>将容器保存成镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker commit -m &quot;&lt;commit-info&gt;&quot; -a &quot;&lt;author-name&gt;&quot; &lt;container-name&gt; jackfrued/&lt;image-name&gt;<br></code></pre></td></tr></table></figure></li><li><p>镜像的导入和导出。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker save -o &lt;file-name&gt;.tar &lt;image-name&gt;:&lt;version&gt;<br>docker load -i &lt;file-name&gt;.tar<br></code></pre></td></tr></table></figure></li><li><p>推送到DockerHub服务器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker tag &lt;image-name&gt;:&lt;version&gt; jackfrued/&lt;name&gt;<br>docker login<br>docker push jackfrued/&lt;name&gt;<br></code></pre></td></tr></table></figure></li><li><p>容器之间的通信。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run --link &lt;container-name&gt;:&lt;alias-name&gt;<br></code></pre></td></tr></table></figure></li></ol><p><a href="https://mp.weixin.qq.com/s/fv8RXmSxhwZVW89VjqRf9w">Docker容器化部署Python应用</a></p>]]></content>
    
    
    <categories>
      
      <category>Docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>并发编程</title>
    <link href="/Myblog/2019/01/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    <url>/Myblog/2019/01/08/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<p><strong>并发编程分为</strong>：</p><ul><li>多线程</li><li>多进程</li><li>异步I/O</li></ul><p><strong>并发编程的主要作用</strong>：</p><ol><li>加速程序的执行</li><li>改善用户体验</li></ol><p><strong>什么情况应该采用并发编程</strong>：</p><p>耗时间的任务都尽可能独立的执行，而不要阻塞代码其他部分。</p><p><strong>线程和进程共享数据</strong>：</p><ul><li><p>线程间通信(共享数据)非常简单因为可以共享一个进程中的内存</p></li><li><p>进程间通信(共享数据)比较麻烦因为操作系统会保护分配给进程的内存</p><p>要实现多进程间的通信通常可以用系统管道、套接字、三方服务来实现<br>multiprocessing.Queue</p></li></ul><h4 id="一、多线程"><a href="#一、多线程" class="headerlink" title="一、多线程"></a>一、多线程</h4><h5 id="方法一：创建Thread对象"><a href="#方法一：创建Thread对象" class="headerlink" title="方法一：创建Thread对象"></a>方法一：创建Thread对象</h5><p>创建一个Thread对象指定target和args属性并通过start方法启动线程。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os, glob, time<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_image_list</span>(<span class="hljs-params">image_dir</span>):</span><br>    image_list = glob.glob(image_dir)<br>    <span class="hljs-keyword">return</span> image_list<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_thumbnail</span>(<span class="hljs-params">image_name</span>):</span><br>        filename, ext = os.path.splitext(image_name)<br>        filename = filename[filename.rfind(<span class="hljs-string">&#x27;\\&#x27;</span>) + <span class="hljs-number">1</span>:]<br>        <span class="hljs-keyword">for</span> size <span class="hljs-keyword">in</span> (<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>):<br>            outfile = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;filename&#125;</span>_<span class="hljs-subst">&#123;size&#125;</span>_<span class="hljs-subst">&#123;size&#125;</span>.png&#x27;</span><br>            image = Image.open(image_name)<br>            image.thumbnail((size, size))<br>            image.save(<span class="hljs-string">f&#x27;images_<span class="hljs-subst">&#123;size&#125;</span>/<span class="hljs-subst">&#123;outfile&#125;</span>&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    start = time.time()<br>    threads = []<br>    images_name_list = get_image_list(<span class="hljs-string">&#x27;./images/*&#x27;</span>)<br>    <span class="hljs-keyword">for</span> image_name <span class="hljs-keyword">in</span> images_name_list: <br>        t = Thread(target=gen_thumbnail, args=(image_name,))   <span class="hljs-comment"># 指定线程的任务和参数</span><br>        <span class="hljs-comment"># t = ThumbnailThread(image_name)</span><br>        t.start()<br>        threads.append(t)<br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:<br>        <span class="hljs-comment"># 阻塞，必须等到线程执行完</span><br>        t.join()<br>    end = time.time()<br>    print(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;end - start&#125;</span>s&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>补充：如果上面改成 <code>Thread(target=gen_thumbnail, args=(image_name,), daemon=True)</code>，这样线程就变成了守护线程，当主线程结束之后，会自动结束此线程。</p><p>守护线程：在系统停止运行时，不会因为线程还没有执行完而阻止系统停止。</p><h5 id="方法二：继承Thread类"><a href="#方法二：继承Thread类" class="headerlink" title="方法二：继承Thread类"></a>方法二：继承Thread类</h5><p>继承Thread类并重写run方法定义线程执行的任务。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os, glob, time<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThumbnailThread</span>(<span class="hljs-params">Thread</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, image_name</span>):</span><br>        self.image_name = image_name<br>        super().__init__()<br>        <span class="hljs-comment"># super().__init__(daemon=True)   守护进程</span><br><br>    <span class="hljs-comment"># 必须初始化父类__init__方法，程序才会自动调用run方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span><br>        filename, ext = os.path.splitext(self.image_name)<br>        filename = filename[filename.rfind(<span class="hljs-string">&#x27;\\&#x27;</span>) + <span class="hljs-number">1</span>:]<br>        <span class="hljs-keyword">for</span> size <span class="hljs-keyword">in</span> (<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>):<br>            outfile = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;filename&#125;</span>_<span class="hljs-subst">&#123;size&#125;</span>_<span class="hljs-subst">&#123;size&#125;</span>.png&#x27;</span><br>            image = Image.open(self.image_name)<br>            image.thumbnail((size, size))<br>            image.save(<span class="hljs-string">f&#x27;images_<span class="hljs-subst">&#123;size&#125;</span>/<span class="hljs-subst">&#123;outfile&#125;</span>&#x27;</span>)<br>            <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    start = time.time()<br>    threads = []<br>    images_name_list = get_image_list(<span class="hljs-string">&#x27;./images/*&#x27;</span>)<br>    <span class="hljs-keyword">for</span> image_name <span class="hljs-keyword">in</span> images_name_list: <br>        t = ThumbnailThread(image_name)<br>        t.start()<br>        threads.append(t)<br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:<br>        <span class="hljs-comment"># 阻塞，必须等到线程执行完</span><br>        t.join()<br>    end = time.time()<br>    print(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;end - start&#125;</span>s&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h5 id="方法三：创建线程池对象"><a href="#方法三：创建线程池对象" class="headerlink" title="方法三：创建线程池对象"></a>方法三：创建线程池对象</h5><p>创建线程池对象ThreadPoolExecutor通过submit来提交要执行的任务。<br>第三种方式可以通过Future对象的result方法在将来获得线程的执行结果，也可以通过done方法判定线程是否执行结束。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os, glob, time<br><br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_image_list</span>(<span class="hljs-params">image_dir</span>):</span><br>    image_list = glob.glob(image_dir)<br>    <span class="hljs-keyword">return</span> image_list<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_thumbnail</span>(<span class="hljs-params">image_name</span>):</span><br>        filename, ext = os.path.splitext(image_name)<br>        filename = filename[filename.rfind(<span class="hljs-string">&#x27;\\&#x27;</span>) + <span class="hljs-number">1</span>:]<br>        <span class="hljs-keyword">for</span> size <span class="hljs-keyword">in</span> (<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>):<br>            outfile = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;filename&#125;</span>_<span class="hljs-subst">&#123;size&#125;</span>_<span class="hljs-subst">&#123;size&#125;</span>.png&#x27;</span><br>            image = Image.open(image_name)<br>            image.thumbnail((size, size))<br>            image.save(<span class="hljs-string">f&#x27;images_<span class="hljs-subst">&#123;size&#125;</span>/<span class="hljs-subst">&#123;outfile&#125;</span>&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    futures = []<br>    start = time.time()<br>    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">30</span>) <span class="hljs-keyword">as</span> pool:<br>        images_name_list = get_image_list(<span class="hljs-string">&#x27;images/*&#x27;</span>)<br>        <span class="hljs-keyword">for</span> image_name <span class="hljs-keyword">in</span> images_name_list:<br>            <span class="hljs-comment"># submit是一个非阻塞式的方法，即便工作线程数已经用完，submit也会接受提交的任务。</span><br>            future = pool.submit(gen_thumbnail, image_name)<br>            futures.append(future)<br>    <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> futures:<br>        <span class="hljs-comment"># result()是一个阻塞式方法，如果线程还没有执行完，就会此处阻塞</span><br>        future.result()<br>    <span class="hljs-comment"># shutdown也是非阻塞式的方法，但是如果已经提交的执行完的任务没有执行完，线程池是不会停止工作的，shutdown之后不能提交任务。</span><br>    end = time.time()<br>    print(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;end-start&#125;</span>s&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h5 id="线程间资源竞争问题"><a href="#线程间资源竞争问题" class="headerlink" title="线程间资源竞争问题"></a>线程间资源竞争问题</h5><ul><li><p>多个线程竞争一个资源 - 保护临界资源 - 锁(threading.Lock/RLock)</p></li><li><p>多个线程竞争多个资源(线程数&gt;资源数) - 信号量(threading.Semaphore)</p></li><li><p>多个线程的调度 - 暂停线程执行/唤醒等待中的线程 - Condition (在lock的基础上)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 模拟银行存取钱：有钱则取，无钱等待 - 线程之间调度 -Condition</span><br><span class="hljs-keyword">import</span> threading<br><br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;账户&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, balance=<span class="hljs-number">0</span></span>):</span><br>        self.balance = balance<br>        lock = threading.Lock()<br>        self.condition = threading.Condition(lock)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deposit</span>(<span class="hljs-params">self, money</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;存钱&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> self.condition:<br>            new_balance = self.balance + money<br>            sleep(<span class="hljs-number">0.001</span>)<br>            self.balance = new_balance<br>            self.condition.notify_all()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">withdraw</span>(<span class="hljs-params">self, money</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;取钱&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> self.condition:<br>            <span class="hljs-keyword">while</span> money &gt; self.balance:<br>                <span class="hljs-comment"># 等待并释放掉锁</span><br>                print(<span class="hljs-string">&#x27;余额不足！&#x27;</span>)<br>                self.condition.wait()<br>            new_balance = self.balance - money<br>            sleep(<span class="hljs-number">0.001</span>)<br>            self.balance = new_balance<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_money</span>(<span class="hljs-params">account</span>):</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        money = randint(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>)<br>        account.deposit(money)<br>        print(threading.current_thread().name, <span class="hljs-string">&#x27;:&#x27;</span>, money, <span class="hljs-string">&#x27; --&gt; &#x27;</span>, account.balance)<br>        sleep(<span class="hljs-number">0.8</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sub_money</span>(<span class="hljs-params">account</span>):</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        money = randint(<span class="hljs-number">10</span>, <span class="hljs-number">30</span>)<br>        account.withdraw(money)<br>        print(threading.current_thread().name, <span class="hljs-string">&#x27;:&#x27;</span>, money, <span class="hljs-string">&#x27; &lt;-- &#x27;</span>, account.balance)<br>        sleep(<span class="hljs-number">1</span>)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    account = Account()<br>    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">100</span>) <span class="hljs-keyword">as</span> pool:<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">100</span>):<br>            pool.submit(add_money, account)<br>            pool.submit(sub_money, account)<br><br>    print(<span class="hljs-string">f&#x27;账户余额：<span class="hljs-subst">&#123;account.balance&#125;</span>元&#x27;</span>)<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure></li></ul><h4 id="二、多进程"><a href="#二、多进程" class="headerlink" title="二、多进程"></a>二、多进程</h4><p>多进程：多进程可以有效的解决GIL ( 全局解释器锁 ) 的问题，实现多进程主要的类是Process，其他辅助的类跟threading模块中的类似，进程间共享数据可以使用管道、套接字等，在multiprocessing模块中有一个Queue类，它基于管道和锁机制提供了多个进程共享的队列，可以让进程之间共享数据。</p><h5 id="方法一：-创建Process对象"><a href="#方法一：-创建Process对象" class="headerlink" title="方法一： 创建Process对象"></a>方法一： 创建Process对象</h5><p>使用方法 - 类似 - 多线程方法一</p><p><code>from multiprocessing import Process</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os, glob, time<br><br><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process<br><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_image_list</span>(<span class="hljs-params">image_dir</span>):</span><br>    image_list = glob.glob(image_dir)<br>    <span class="hljs-keyword">return</span> image_list<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_thumbnail</span>(<span class="hljs-params">image_name</span>):</span><br>        filename, ext = os.path.splitext(image_name)<br>        filename = filename[filename.rfind(<span class="hljs-string">&#x27;\\&#x27;</span>) + <span class="hljs-number">1</span>:]<br>        <span class="hljs-keyword">for</span> size <span class="hljs-keyword">in</span> (<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>):<br>            outfile = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;filename&#125;</span>_<span class="hljs-subst">&#123;size&#125;</span>_<span class="hljs-subst">&#123;size&#125;</span>.png&#x27;</span><br>            image = Image.open(image_name)<br>            image.thumbnail((size, size))<br>            image.save(<span class="hljs-string">f&#x27;images_<span class="hljs-subst">&#123;size&#125;</span>/<span class="hljs-subst">&#123;outfile&#125;</span>&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    start = time.time()<br>    processes = []<br>    images_name_list = get_image_list(<span class="hljs-string">&#x27;./images/*&#x27;</span>)<br>    <span class="hljs-keyword">for</span> image_name <span class="hljs-keyword">in</span> images_name_list: <br>        p = Process(target=gen_thumbnail, args=(image_name,))   <span class="hljs-comment"># 指定线程的任务和参数</span><br>        p.start()<br>        processes.append(p)<br>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:<br>        <span class="hljs-comment"># 阻塞，必须等到线程执行完</span><br>        p.join()<br>    end = time.time()<br>    print(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;end - start&#125;</span>s&#x27;</span>)<br></code></pre></td></tr></table></figure><h5 id="方法二：创建进程池对象"><a href="#方法二：创建进程池对象" class="headerlink" title="方法二：创建进程池对象"></a>方法二：创建进程池对象</h5><p>1.<code>from multiprocessing import Pool</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Pool, cpu_count<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_product_pic</span>(<span class="hljs-params">x</span>):</span><br>  <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>  <span class="hljs-keyword">with</span> Pool(<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> pool:<br>     pool.map(update_product_pic, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>])   <span class="hljs-comment"># 批量导入任务到进程</span><br>  pool.join()    <span class="hljs-comment"># 阻塞进程，直至任务完成</span><br><br></code></pre></td></tr></table></figure><blockquote><p>说明：1、进程数量最好与cpu核数相同(cpu_count)；2、使用pool.apply_async(update_product_pic, (1,))在windows环境上会报错，需要把进程池调用代码放<code>if __name__ == &#39;__main__&#39;:</code>里面，避免进程循环调用，不推荐使用此方法；3、pool.map方法如果主进程终止，那么任务进程也会终止</p></blockquote><p>2.使用方法 - 类似 - 多线程方法三</p><p><code>form concurrent.futures import ProcessPoolExecutor </code></p><h4 id="三、异步I-O"><a href="#三、异步I-O" class="headerlink" title="三、异步I/O"></a>三、异步I/O</h4><p>异步I/O(异步编程) - 只使用一个线程(单线程) 来处理用户请求，用户请求一旦被接纳，剩下的都是I/O操作，通过多路I/O复用也可以达到并发效果。这种做法与多线程相比，可以让CPU利用率更高，因为没有线程切换的开销。今天我们使用的 Redis 和 Node.js 就是单线程+异步I/O实现。</p><p>异步处理：从调度程序的任务队列中挑选任务，该调度程序以交叉的形式执行这些任务， 我们并不能保证任务将以某种顺序去执行，因为执行顺序取决于队列中的一项任务是否愿 意将CPU处理时间让位给另一项任务。异步任务通常通过多任务协作处理的方式来实现， 由于执行时间和顺序的不确定，因此需要通过回调式编程或者 future 对象来获取任务执行的结果。Python 3通过 asyncio 模块和 await 和 async 关键字（在Python 3.7中正式被 列为关键字）来支持异步处理。 </p><p>协程 (corouting) - 可以在需要时进行切换,相互协作的子程序</p><p>同步 –&gt;阻塞               异步 –&gt; 非阻塞 - 代码可以继续往下</p><h5 id="asyncio异步操作"><a href="#asyncio异步操作" class="headerlink" title="asyncio异步操作"></a>asyncio异步操作</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">num_generator</span>(<span class="hljs-params">m, n</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;指定范围的数字生成器&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> range(m, n + <span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prime_filter</span>(<span class="hljs-params">m, n</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;素数过滤器&quot;&quot;&quot;</span><br>    primes = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> num_generator(m, n):<br>        flag = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>, int(i ** <span class="hljs-number">0.5</span> + <span class="hljs-number">1</span>)):<br>            <span class="hljs-keyword">if</span> i % j == <span class="hljs-number">0</span>:<br>                flag = <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">if</span> flag:<br>            print(<span class="hljs-string">&#x27;Prime =&gt;&#x27;</span>, i)<br>            primes.append(i)<br><br>        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.001</span>)<br>    <span class="hljs-keyword">return</span> tuple(primes)<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">square_mapper</span>(<span class="hljs-params">m, n</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;平方映射器&quot;&quot;&quot;</span><br>    squares = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> num_generator(m, n):<br>        print(<span class="hljs-string">&#x27;Square =&gt;&#x27;</span>, i * i)<br>        squares.append(i * i)<br>        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.001</span>)<br>    <span class="hljs-keyword">return</span> squares<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;主函数&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 函数获得系统默认的事件循环 - 消息队列</span><br>    loop = asyncio.get_event_loop()<br>    <span class="hljs-comment"># 拿到future对象</span><br>    future = asyncio.gather(prime_filter(<span class="hljs-number">2</span>, <span class="hljs-number">100</span>), square_mapper(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>))<br>    <span class="hljs-comment"># future对象的add_done_callback可以添加执行完成时的回调函数</span><br>    future.add_done_callback(<span class="hljs-keyword">lambda</span> x: print(x.result()))<br>    <span class="hljs-comment"># loop对象的run_until_complete方法可以等待通过future对象获得协程执行结果</span><br>    loop.run_until_complete(future)<br>    loop.close()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>说明：当用async标识方法时，只是显示告诉编译器在该方法中await关键字可能会被用到，当执行到await关键字开始处于挂起的状态，直到异步动作执行完成才恢复。</p><p>如果想要得到更好的事件循环队列，可以使用第三方库<code>uvloop</code>(异步I/O事件循环)来实现，性能上远远高于系统默认的循环队列。</p><h5 id="aiohttp异步HTTP网络访问"><a href="#aiohttp异步HTTP网络访问" class="headerlink" title="aiohttp异步HTTP网络访问"></a>aiohttp异步HTTP网络访问</h5><p>示例：拿到对应网站的标题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-keyword">import</span> aiohttp<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fetch</span>(<span class="hljs-params">session, url</span>):</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url, ssl=<span class="hljs-literal">False</span>) <span class="hljs-keyword">as</span> resp:<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> resp.text()<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>(<span class="hljs-params">url, pattern</span>):</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>        html = <span class="hljs-keyword">await</span> fetch(session, url)<br>        <span class="hljs-keyword">return</span> pattern.search(html).group(<span class="hljs-string">&#x27;title&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pattern = re.compile(<span class="hljs-string">r&#x27;\&lt;title\&gt;(?P&lt;title&gt;.*)\&lt;\/title\&gt;&#x27;</span>)<br>    urls = (<span class="hljs-string">&#x27;https://www.python.org/&#x27;</span>,<br>            <span class="hljs-string">&#x27;https://git-scm.com/&#x27;</span>,<br>            <span class="hljs-string">&#x27;https://www.jd.com/&#x27;</span>,<br>            <span class="hljs-string">&#x27;https://www.taobao.com/&#x27;</span>,<br>            <span class="hljs-string">&#x27;https://www.douban.com/&#x27;</span>)<br>    loop = asyncio.get_event_loop()<br>    futures = asyncio.gather(*[main(url, pattern) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls])<br>    futures.add_done_callback(<span class="hljs-keyword">lambda</span> x: print(x.result()))<br>    loop.run_until_complete(futures)<br>    loop.close()<br><br></code></pre></td></tr></table></figure><h4 id="四、多线程、多进程、异步I-O区别"><a href="#四、多线程、多进程、异步I-O区别" class="headerlink" title="四、多线程、多进程、异步I/O区别"></a>四、多线程、多进程、异步I/O区别</h4><p>多线程因为GIL(全局解释器锁)的存在不能发挥CPU的多核特性，所以要想利用多核特性，只能使用多进程。对于计算密集型的任务，应该优先考虑多进程。</p><ul><li>使用多线程： <ol><li>程序需要维护许多共享的状态（尤其是可变状态）。Python中的列表、字典、 集合都是线程安全的，所以使用线程而不是进程维护共享状态的代价相对较小。</li><li>程序花费大量的时间执行I/O操作，没有太多并集计算的需求且不需要太多的内存占用。 </li></ol></li><li>使用多进程： <ol><li>程序执行计算密集型任务（如：字节码操作、数据处理、科学计算）。 </li><li>程序的输入可以并行的分成块，并且可以将运算结果合并。 </li><li>程序在内存使用方面没有任何限制且不强依赖于I/O操作（如：读写文件、套接字等）。</li></ol></li><li>使用异步I/O：<ol><li>程序执行请求操作，但是可能不会马上得到响应。</li></ol></li></ul><h4 id="五、Celery-异步任务"><a href="#五、Celery-异步任务" class="headerlink" title="五、Celery - 异步任务"></a>五、Celery - 异步任务</h4><p>异步化处理：使用 celery创建生产者和消费者，生产者放入消息队列中即可，消费者进行消费。这里使用redis的list类型做队列。 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> celery<br><br><span class="hljs-comment"># 注册环境变量（注册Django配置文件）</span><br>os.environ.setdefault(<span class="hljs-string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="hljs-string">&#x27;Fangtx.settings&#x27;</span>)<br><span class="hljs-comment"># common.views模块名，broker消息代理(从哪里获取消息队列服务)</span><br>app = celery.Celery(<span class="hljs-string">&#x27;common.views&#x27;</span>, broker=<span class="hljs-string">&#x27;redis://:123456@39.96.51.36:6379/0&#x27;</span>)<br><span class="hljs-comment"># 读取Django项目的配置信息</span><br>app.config_from_object(<span class="hljs-string">&#x27;django.conf:settings&#x27;</span>)<br><br><span class="hljs-meta">@app.task</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_mobile_code</span>(<span class="hljs-params">code:str, mobile:str</span>):</span><br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    send_mobile_code.delay(code=code, mobile=mobile)<br><br>main() <br></code></pre></td></tr></table></figure><blockquote><p>说明：</p><ol><li>[<code>@app.task](mailto:%60@app.task)</code> 装饰需要异步处理的任务，调用时需要加入delay()函数；</li><li>消费者使用<code>celery -A common.views worker -l info</code> ;</li><li>如果celery需要读取django配置需要加上代码 <code>os.environ.setdefault(&#39;DJANGO_SETTINGS_MODULE&#39;, &#39;Fangtx.settings&#39;)</code> <code>app.config_from_object(&#39;django.conf:settings&#39;)</code></li></ol></blockquote><p>问题：windows平台出现 <code>Celery ValueError: not enough values to unpack (expected 3, got 0)</code></p><p>解决：安装第三方库<code>pip install eventlet</code> 然后在命令后加<code>-P eventlet</code></p><h5 id="celery定时任务"><a href="#celery定时任务" class="headerlink" title="celery定时任务"></a>celery定时任务</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.task</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show_message</span>(<span class="hljs-params">content</span>):</span><br>    print(content)<br><br>app.conf.update(<br>    timezone=settings.TIME_ZONE,<br>    enable_utc=<span class="hljs-literal">True</span>,<br>    <span class="hljs-comment"># 定时任务要通过消息的生产者将其转换成队列中的消息</span><br>    <span class="hljs-comment"># celery -A common.utils beat -l info</span><br>    beat_schedule=&#123;<br>        <span class="hljs-string">&#x27;task_one&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;task&#x27;</span>: <span class="hljs-string">&#x27;common.utils.show_message&#x27;</span>,<br>            <span class="hljs-string">&#x27;schedule&#x27;</span>: crontab(),<br>            <span class="hljs-string">&#x27;args&#x27;</span>: (<span class="hljs-string">&#x27;hello,world! &#x27;</span>, )<br>        &#125;,<br>    &#125;,<br>)<br></code></pre></td></tr></table></figure><blockquote><p>说明：需要使用<code>celery -A common.utils beat -l info</code>起生产者，然后起消费者执行。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Celery</category>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>celery</tag>
      
      <tag>多线程</tag>
      
      <tag>多进程</tag>
      
      <tag>异步I/O</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>时间和日期模块</title>
    <link href="/Myblog/2019/01/05/%E6%97%B6%E9%97%B4%E5%92%8C%E6%97%A5%E6%9C%9F%E6%A8%A1%E5%9D%97/"/>
    <url>/Myblog/2019/01/05/%E6%97%B6%E9%97%B4%E5%92%8C%E6%97%A5%E6%9C%9F%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h2 id="time模块"><a href="#time模块" class="headerlink" title="time模块"></a>time模块</h2><p>time模块中的几种类型：</p><ul><li>时间戳：<code> 1547729670.5185406</code> - 距离 <code>1970-01-01 00：00：00 </code>时间的总秒数 </li><li>时间元组：<code>time.struct_time(tm_year=2016,   tm_mon=7, tm_mday=21, tm_hour=22,   tm_min=32,    tm_sec=51，tm_wday=3, tm_yday=203, tm_isdst=0)</code></li><li>英文显示：<code>&#39;Mon Jan 26 00:52:24 1970&#39; </code></li><li>格式化显示 ：<code>&#39;%Y-%m-%d %H:%M:%S&#39;</code></li></ul><p>先来看一下time模块的类型关系图：</p><p><img src="https://stellae.gitee.io/myblog/images/images/729678-20160721224411841-1867623708.png"></p><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p><code>time.time()</code> - 获取当前时间戳</p><p><code>time.localtime()</code> - 获取当前时间元组</p><p><code>time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime())</code>  - 获取当前格式化显示</p><h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><ol><li><p>时间戳 -&gt; 时间元组<br><code>time.localtime()</code> - 获取当前时间元组</p><p>时间元组可以进行运算，利用<code>days() / seconds() / total_seconds()</code>获取值，区别见下文</p></li><li><p>字符串 -&gt; 时间元组<br><code>time.strptime(str, &#39;%Y-%m-%d %H:%M:%S&#39;)</code></p></li><li><p>时间元组 -&gt; 英文显示<br><code>time.asctime()</code> </p></li><li><p>时间戳 -&gt; 英文显示<br><code>time.ctime()</code> </p></li><li><p>时间元组 -&gt; 格式化显示<br><code>time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime())</code>  - <code>strftime -&gt; str-format-time</code></p></li><li><p>格式化显示 -&gt; 时间元组</p><p><code>time.strptime(&#39;2019-1-18 10:10:24&#39;, &#39;%Y-%m-%d %H:%M:%S&#39;)</code> - <code>strptime -&gt; str-parse-time</code></p></li></ol><h2 id="datetime模块"><a href="#datetime模块" class="headerlink" title="datetime模块"></a>datetime模块</h2><p>datetime中的类型时间元组形式: <code>datetime.datetime(2019, 1, 17, 21, 37, 2, 766520)</code></p><h3 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h3><p><code>datetime.datetime.now()</code> - 获取当前时间元组</p><p><code>datetime.datetime.now().timestamp()</code> - 获取当前时间戳</p><p><code>datetime.datetime.now().strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)</code> - 获取当前格式化字符串</p><p><code>datetime.datetime.now().strftime(&#39;%x %X&#39;)</code> - 获取当前格式化字符串</p><h3 id="类型转换-1"><a href="#类型转换-1" class="headerlink" title="类型转换"></a>类型转换</h3><ol><li><p>时间元组 -&gt; 英文显示(ctime)</p><p><code>datetime.datetime.now().ctime()</code></p></li><li><p>时间元组 -&gt; 格式化显示</p><p><code>datetime.datetime.now().strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)</code></p></li><li><p>英文显示(ctime) -&gt; 时间元祖</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">datetime.datetime.strptime(&lt;ctime()&gt;, <span class="hljs-string">&quot;%a %b %d %H:%M:%S %Y&quot;</span>)<br></code></pre></td></tr></table></figure></li><li><p>字符串 -&gt; 时间元组</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">datetime.datetime.strptime(start_time, <span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)<br></code></pre></td></tr></table></figure></li></ol><p>time和datetime模块的类型关系图：</p><p><img src="https://stellae.gitee.io/myblog/images/images/124114320116241884464.jpg"></p><h2 id="python-dateutil模块"><a href="#python-dateutil模块" class="headerlink" title="python-dateutil模块"></a>python-dateutil模块</h2><p>日期解析器：能够将字符串转换为日期格式（datetime.datetime类型）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install python-dateutil<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> dateutil.parser <span class="hljs-keyword">import</span> parse<br>a = parse(<span class="hljs-string">&#x27;2017-10-01 12:12:12&#x27;</span>)<br>b = parse(<span class="hljs-string">&#x27;2013-3-4 10:10:10&#x27;</span>)<br>(a-b).days   <span class="hljs-comment"># 1672</span><br>(a-b).seconds   <span class="hljs-comment"># 7322</span><br>(a-b).total_seconds()   <span class="hljs-comment"># 144468122.0</span><br></code></pre></td></tr></table></figure><blockquote><p>说明：</p><ol><li><strong>days：</strong>来获取时间差的天数；</li><li><strong>seconds：</strong>来获取时间差中的秒数。注意，seconds获得的秒只是时间差中的小时、分钟和秒部分的和，并没有包含时间差的天数；</li><li><strong>total_seconds：</strong>来获取准确的时间差，并将时间差转换为秒。</li></ol></blockquote><h2 id="calendar模块"><a href="#calendar模块" class="headerlink" title="calendar模块"></a>calendar模块</h2><p>python中 的日历模块，可以方便的获取某天是周几，某月一共多少天等信息</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> calendar<br><br>calendar.prmonth(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>)    <span class="hljs-comment"># 打印某月日历</span><br>calendar.isleap(<span class="hljs-number">2019</span>)  <span class="hljs-comment"># 是否是闰年</span><br>calendar.weekheader(<span class="hljs-number">3</span>)  <span class="hljs-comment"># 返回一个包含周一到周天指定长度名称缩写的字符串</span><br>result = calendar.weekday(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>, <span class="hljs-number">10</span>)   <span class="hljs-comment"># 返回某天是星期几 (0-6)</span><br>result = calendar.monthrange(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>)<br><span class="hljs-comment"># 返回某月份第一天是星期几和这个月的天数  (4, 28) -&gt; (周五, 28天) </span><br></code></pre></td></tr></table></figure><p><a href="https://docs.python.org/zh-cn/3/library/calendar.html">calendar模块</a></p><h2 id="时间日期格式化符号"><a href="#时间日期格式化符号" class="headerlink" title="时间日期格式化符号"></a>时间日期格式化符号</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">%y 两位数的年份表示（<span class="hljs-number">00</span><span class="hljs-number">-99</span>）<br>%Y 四位数的年份表示（<span class="hljs-number">000</span><span class="hljs-number">-9999</span>）<br>%m 月份（<span class="hljs-number">01</span><span class="hljs-number">-12</span>）<br>%d 月内中的一天（<span class="hljs-number">0</span><span class="hljs-number">-31</span>）<br>%H <span class="hljs-number">24</span>小时制小时数（<span class="hljs-number">0</span><span class="hljs-number">-23</span>）<br>%I <span class="hljs-number">12</span>小时制小时数（<span class="hljs-number">01</span><span class="hljs-number">-12</span>）<br>%M 分钟数（<span class="hljs-number">00</span>=<span class="hljs-number">59</span>）<br>%S 秒（<span class="hljs-number">00</span><span class="hljs-number">-59</span>）<br>%a 本地简化星期名称<br>%A 本地完整星期名称<br>%b 本地简化的月份名称<br>%B 本地完整的月份名称<br>%c 本地相应的日期表示和时间表示<br>%j 年内的一天（<span class="hljs-number">001</span><span class="hljs-number">-366</span>）<br>%p 本地A.M.或P.M.的等价符<br>%U 一年中的星期数（<span class="hljs-number">00</span><span class="hljs-number">-53</span>）星期天为星期的开始<br>%w 星期（<span class="hljs-number">0</span><span class="hljs-number">-6</span>），星期天为星期的开始<br>%W 一年中的星期数（<span class="hljs-number">00</span><span class="hljs-number">-53</span>）星期一为星期的开始<br>%x 本地相应的日期表示<br>%X 本地相应的时间表示<br>%Z 当前时区的名称<br>%% %号本身<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>日期</tag>
      
      <tag>时间</tag>
      
      <tag>time</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>装饰器详解</title>
    <link href="/Myblog/2019/01/05/%E8%A3%85%E9%A5%B0%E5%99%A8%E8%AF%A6%E8%A7%A3/"/>
    <url>/Myblog/2019/01/05/%E8%A3%85%E9%A5%B0%E5%99%A8%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h4 id="一、基本概念"><a href="#一、基本概念" class="headerlink" title="一、基本概念"></a>一、基本概念</h4><p>用一个函数装饰另一个函数或类，装饰器函数的参数是被装饰的函数，返回一个装饰后的函数，当调用被装饰的函数时，其实执行的是装饰器中返回的函数,给他增加额外的功能，凡是需要这个额外的功能的地方，只需要加上装饰器即可，而不需要书写额外的代码。</p><p>给函数添加装饰器的语法，就是在函数前添加@函数</p><p>装饰器中放置的都是横切关注功能(cross-concern)，所谓横切关注功能就是很多地方都会用到，但是和正常业务没有必然联系。</p><p>装饰器实际上是实现了设计模式中的代理模式 - AOP(面向切面编程)</p><h4 id="二、装饰器的基本形式"><a href="#二、装饰器的基本形式" class="headerlink" title="二、装饰器的基本形式"></a>二、装饰器的基本形式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">record</span>(<span class="hljs-params">func</span>):</span><br>    <br><span class="hljs-meta">    @wraps(func)  # 保留函数本身的名字</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):</span><br>        <span class="hljs-comment"># 此处写装饰函数执行前的代码</span><br>        ret_value = func(*args, **kwargs)<br>        <span class="hljs-comment"># 此处写装饰函数执行后的代码</span><br>        <span class="hljs-keyword">return</span> ret_value<br><br>    <span class="hljs-keyword">return</span> wrapper <br><br><span class="hljs-comment"># 这里加了装饰器的函数，被调用的时候，实际上是调用的weapper函数</span><br><span class="hljs-meta">@record</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fac</span>(<span class="hljs-params">num</span>):</span><br><span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><h4 id="三、带参数的装饰器"><a href="#三、带参数的装饰器" class="headerlink" title="三、带参数的装饰器"></a>三、带参数的装饰器</h4><p>如果想要使用带参数的装饰器，需要再嵌套一层函数</p><p>示例一：计算函数运行时间</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> perf_counter, sleep<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">record</span>(<span class="hljs-params">output</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorate</span>(<span class="hljs-params">func</span>):</span><br><br><span class="hljs-meta">        @wraps(func)</span><br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):</span><br>            start = perf_counter()<br>            ret_value = func(*args, **kwargs)<br>            end = perf_counter()<br>            output(func.__name__, end - start)<br>            <span class="hljs-keyword">return</span> ret_value<br><br>        <span class="hljs-keyword">return</span> wrapper<br><br>    <span class="hljs-keyword">return</span> decorate<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">output_to_file</span>(<span class="hljs-params">fname, duration</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;输出到文件&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;log.txt&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>) <span class="hljs-keyword">as</span> file_stream:<br>        file_stream.write(<span class="hljs-string">&#x27;%s:%.3fs&#x27;</span>%(fname, duration))<br><br>        <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">output_to_console</span>(<span class="hljs-params">fname, duration</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;输出到控制台&quot;&quot;&quot;</span><br>    print(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;fname&#125;</span>: <span class="hljs-subst">&#123;duration&#125;</span>&#x27;</span>)<br><br>    <br><span class="hljs-meta">@record(output_to_file)   # 将函数作为参数传入，作为装饰器的参数</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    sleep(randint(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>示例二：如果代码出现某些异常重试一定次数，并且每次随机延迟一定时间。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">retry</span>(<span class="hljs-params">*, retry_time=<span class="hljs-number">3</span>, min_delay_time=<span class="hljs-number">0</span>, max_deplay_time=<span class="hljs-number">2</span>, errors=(<span class="hljs-params">Exception, </span>)</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">record</span>(<span class="hljs-params">func</span>):</span><br>        <br><span class="hljs-meta">        @wraps(func)</span><br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):</span><br>            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(retry_time):<br>                <span class="hljs-keyword">try</span>:<br>                    <span class="hljs-keyword">return</span> func(*args, **kwargs)<br>                <span class="hljs-keyword">except</span> errors:<br>                    print(<span class="hljs-string">&#x27;Network error. Please wait.&#x27;</span>)<br>                    sleep(randint(min_delay_time, max_deplay_time))<br><br>        <span class="hljs-keyword">return</span> wrapper<br><br>    <span class="hljs-keyword">return</span> record<br><br><br><span class="hljs-meta">@retry(retry_time=3, min_delay_time=1, max_deplay_time=2)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>():</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h4 id="四、装饰器装饰类"><a href="#四、装饰器装饰类" class="headerlink" title="四、装饰器装饰类"></a>四、装饰器装饰类</h4><p>使用装饰器实现单例模式 - 一个类只能创建唯一的对象</p><p>实现单例方法之一：装饰器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">singleton</span>(<span class="hljs-params">cls</span>):</span><br>    instances = &#123;&#125;<br>    <span class="hljs-comment"># 如果是多线程需要加上锁，不然单例会失效，可能同时创建很多个对象。</span><br>    lock = threading.Lock()<br><br><span class="hljs-meta">    @wraps(cls)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):</span><br>        <span class="hljs-keyword">if</span> cls <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> instances:<br>            <span class="hljs-comment"># 使用上下文语法，自动关闭锁。如果类里面有__enter__ / __exit__，就可以使用上下文语法</span><br>            <span class="hljs-keyword">with</span> lock:   <br>                <span class="hljs-keyword">if</span> cls <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> instances:<br>                    instances[cls] = cls(*args, **kwargs)<br>        <span class="hljs-keyword">return</span> instances[cls]<br><br>    <span class="hljs-keyword">return</span> wrapper<br><br><br><span class="hljs-meta">@singleton</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">President</span>():</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, country, name</span>):</span><br>        self.name = name<br>        self.country = country<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__str__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;self.country&#125;</span>: <span class="hljs-subst">&#123;self.name&#125;</span>&#x27;</span><br><br>p1 = President(<span class="hljs-string">&#x27;特朗普&#x27;</span>, <span class="hljs-string">&#x27;美国&#x27;</span>)<br>p2 = President(<span class="hljs-string">&#x27;奥巴马&#x27;</span>, <span class="hljs-string">&#x27;美国&#x27;</span>)<br>print(p1 == p2)<br>print(p1)<br>print(p2)<br><br><span class="hljs-comment"># output</span><br><span class="hljs-literal">True</span><br>特朗普: 美国<br>特朗普: 美国<br></code></pre></td></tr></table></figure><p><strong>补充</strong></p><p>实现单例方法之二：元类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">元 - meta</span><br><span class="hljs-string">元数据 - 描述数据的数据 - metadata</span><br><span class="hljs-string">元类 - 描述类的类 - metaclass - 继承自type</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Lock<br><br><span class="hljs-comment"># 实现单例</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SingletonMeta</span>(<span class="hljs-params">type</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;定义元类&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):</span><br>        cls.__instance = <span class="hljs-literal">None</span><br>        cls.lock = Lock()<br>        super().__init__(*args, **kwargs)  <span class="hljs-comment"># 执行这句的时候，会调用它本身的构造器</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):</span><br>        <span class="hljs-keyword">if</span> cls.__instance <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">with</span> cls.lock:<br>                <span class="hljs-keyword">if</span> cls.__instance <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    cls.__instance = super().__call__(*args, **kwargs)  <span class="hljs-comment"># 执行这句的时候，会调用它本身的构造器</span><br>        <span class="hljs-keyword">return</span> cls.__instance<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">President</span>(<span class="hljs-params">metaclass=SingletonMeta</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;总统类&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 这个类的行为会被元类的构造器接管</span><br>    <span class="hljs-comment"># 可以简单理解为：一个类指定元类后，这个类本身变成了元类的子类(不准确的理解，但是方便记忆)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, name, country</span>):</span><br>        self.name = name<br>        self.country = country<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>装饰器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>算法相关</title>
    <link href="/Myblog/2019/01/04/%E7%AE%97%E6%B3%95%E7%9B%B8%E5%85%B3/"/>
    <url>/Myblog/2019/01/04/%E7%AE%97%E6%B3%95%E7%9B%B8%E5%85%B3/</url>
    
    <content type="html"><![CDATA[<h3 id="一、查找和排序"><a href="#一、查找和排序" class="headerlink" title="一、查找和排序"></a>一、查找和排序</h3><h4 id="1、查找"><a href="#1、查找" class="headerlink" title="1、查找"></a>1、查找</h4><p>顺序查找</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">seq_search</span>(<span class="hljs-params">items: list, elem</span>) -&gt; int:</span><br>    <span class="hljs-string">&quot;&quot;&quot;顺序查找&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> index, item <span class="hljs-keyword">in</span> enumerate(items):<br>        <span class="hljs-keyword">if</span> item == elem:<br>            <span class="hljs-keyword">return</span> index<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br></code></pre></td></tr></table></figure><p>二分查找/折半查找</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bin_search</span>(<span class="hljs-params">items: list, elem</span>) -&gt; int:</span><br>    <span class="hljs-string">&quot;&quot;&quot;二分查找&quot;&quot;&quot;</span><br>    start, end = <span class="hljs-number">0</span>, len(items) - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> start &lt;= end:<br>        middle = (start + end) // <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> elem == items[middle]:<br>            <span class="hljs-keyword">return</span> middle<br>        <span class="hljs-keyword">elif</span> elem &gt; items[middle]:<br>            start = middle + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            end = middle - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br></code></pre></td></tr></table></figure><h4 id="2、排序"><a href="#2、排序" class="headerlink" title="2、排序"></a>2、排序</h4><p>经典排序方法主要有：冒泡排序、选择排序、归并排序、快速排序等等。</p><p><a href="https://www.cnblogs.com/onepixel/p/7674659.html">十大经典排序算法 (动图演示)</a></p><p><a href="https://visualgo.net/zh">数据结构和算法动态可视化 (Chinese)</a></p><h5 id="（1）冒泡排序"><a href="#（1）冒泡排序" class="headerlink" title="（1）冒泡排序"></a>（1）冒泡排序</h5><p>冒泡排序是一种简单的排序算法。它重复地走访过要排序的数列，一次比较两个元素，如果它们的顺序错误就把它们交换过来。走访数列的工作是重复地进行直到没有再需要交换，也就是说该数列已经排序完成。这个算法的名字由来是因为越小的元素会经由交换慢慢“浮”到数列的顶端。 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 函数设计要尽量做到无副作用(不影响调用者)</span><br><span class="hljs-comment"># *前面的参数叫位置参数，传参对号入座 ；*后面的参数叫命名关键字参数，传参必须给出参数名和值</span><br><span class="hljs-comment"># *args - 可变参数 - 元组； *kwargs - 关键字参数 - 字典</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bubble_sort</span>(<span class="hljs-params">origin_items:list, *, comp=lambda x, y: x &gt; y</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;冒泡排序 - O(n^2) : 两两比较，大的下沉，小的上浮&quot;&quot;&quot;</span><br>      items = origin_items[:]<br>      length = len(items)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(length - <span class="hljs-number">1</span>):<br>        swapped = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(length - <span class="hljs-number">1</span> - i):<br>            <span class="hljs-keyword">if</span> comp(items[j], items[j + <span class="hljs-number">1</span>]):<br>                swapped = <span class="hljs-literal">True</span><br>                items[j], items[j + <span class="hljs-number">1</span>] = items[j + <span class="hljs-number">1</span>], items[j]<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> swapped:<br>            <span class="hljs-keyword">break</span>  <span class="hljs-comment"># Stop iteration if the collection is sorted.</span><br>    <span class="hljs-keyword">return</span> items<br><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">optimize_bubble_sort</span>(<span class="hljs-params">origin_items, *, comp=lambda x, y: x &gt; y</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;冒泡排序优化版：正反进行，并且用Bool值记录是否已经排好&quot;&quot;&quot;</span>      <br>    items = origin_items[:]<br>    length = len(items)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(length - <span class="hljs-number">1</span>):<br>        swapped = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(i, length - <span class="hljs-number">1</span> - i):<br>            <span class="hljs-keyword">if</span> items[j] &gt; items[j + <span class="hljs-number">1</span>]:<br>                items[j], items[j + <span class="hljs-number">1</span>] = items[j + <span class="hljs-number">1</span>], items[j]<br>                swapped = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">if</span> swapped:<br>            swapped = <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(length - <span class="hljs-number">1</span> - i, i, <span class="hljs-number">-1</span>):<br>                <span class="hljs-keyword">if</span> items[j - <span class="hljs-number">1</span>] &gt; items[j]:<br>                    items[j - <span class="hljs-number">1</span>], items[j] = items[j], items[j - <span class="hljs-number">1</span>]<br>                    swapped = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> swapped:<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> items<br></code></pre></td></tr></table></figure><h5 id="（2）选择排序"><a href="#（2）选择排序" class="headerlink" title="（2）选择排序"></a>（2）选择排序</h5><p>选择排序(Selection-sort)是一种简单直观的排序算法。它的工作原理：首先在未排序序列中找到最小（大）元素，存放到排序序列的起始位置，然后，再从剩余未排序元素中继续寻找最小（大）元素，然后放到已排序序列的末尾。以此类推，直到所有元素均排序完毕。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">select_sort</span>(<span class="hljs-params">origin_items:list, comp=lambda x, y: x &lt; y</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    简单选择排序：每次从剩下的里面选最小的，依次把最小的元素放在第0,1,2...位置</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    items = origin_items[:]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(items) - <span class="hljs-number">1</span>):<br>        min_index = i<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(i + <span class="hljs-number">1</span>, len(items)):<br>            <span class="hljs-keyword">if</span> comp(items[j], items[min_index]):<br>                items[j], items[min_index] = items[min_index], items[j]<br>    <span class="hljs-keyword">return</span> items<br></code></pre></td></tr></table></figure><h5 id="（3）计数排序"><a href="#（3）计数排序" class="headerlink" title="（3）计数排序"></a>（3）计数排序</h5><p>计数排序不是基于比较的排序算法，其核心在于将输入的数据值转化为键存储在额外开辟的数组空间中。 作为一种线性时间复杂度的排序，计数排序要求输入的数据必须是有确定范围的整数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">counting_sort</span>(<span class="hljs-params">collection</span>):</span><br>    result = []<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> collection:<br>        <span class="hljs-keyword">return</span> result<br>    coll_max = max(collection)<br>    coll_min = min(collection)<br><br>    <span class="hljs-comment"># create the counting array</span><br>    counting_arr_length = coll_max + <span class="hljs-number">1</span> - coll_min<br>    counting_arr = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(counting_arr_length)]<br><br>    <span class="hljs-comment"># count how much a number appears in the collection</span><br>    <span class="hljs-keyword">for</span> number <span class="hljs-keyword">in</span> collection:<br>        counting_arr[number - coll_min] += <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">for</span> counter <span class="hljs-keyword">in</span> counting_arr:<br>        <span class="hljs-keyword">if</span> counter == <span class="hljs-number">0</span>:<br>            coll_min += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">continue</span><br>        result.extend([coll_min <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(counter)])<br>        coll_min += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> result<br></code></pre></td></tr></table></figure><h5 id="（4）插入排序"><a href="#（4）插入排序" class="headerlink" title="（4）插入排序"></a>（4）插入排序</h5><p>插入排序（Insertion-Sort）的算法描述是一种简单直观的排序算法。它的工作原理是通过构建有序序列，对于未排序数据，在已排序序列中从后向前扫描，找到相应位置并插入。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">insertion_sort</span>(<span class="hljs-params">collection</span>):</span><br><br>    <span class="hljs-keyword">for</span> loop_index <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, len(collection)):<br>        insertion_index = loop_index<br>        <span class="hljs-keyword">while</span> (<br>            insertion_index &gt; <span class="hljs-number">0</span><br>            <span class="hljs-keyword">and</span> collection[insertion_index - <span class="hljs-number">1</span>] &gt; collection[insertion_index]<br>        ):<br>            collection[insertion_index], collection[insertion_index - <span class="hljs-number">1</span>] = (<br>                collection[insertion_index - <span class="hljs-number">1</span>],<br>                collection[insertion_index],<br>            )<br>            insertion_index -= <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">return</span> collection<br></code></pre></td></tr></table></figure><h5 id="（5）希尔排序"><a href="#（5）希尔排序" class="headerlink" title="（5）希尔排序"></a>（5）希尔排序</h5><p>1959年Shell发明，第一个突破O(n2)的排序算法，是简单插入排序的改进版。它与插入排序的不同之处在于，它会优先比较距离较远的元素。希尔排序又叫缩小增量排序。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shell_sort</span>(<span class="hljs-params">collection</span>):</span><br>    <span class="hljs-comment"># Marcin Ciura&#x27;s gap sequence</span><br>    gaps = [<span class="hljs-number">701</span>, <span class="hljs-number">301</span>, <span class="hljs-number">132</span>, <span class="hljs-number">57</span>, <span class="hljs-number">23</span>, <span class="hljs-number">10</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>]<br><br>    <span class="hljs-keyword">for</span> gap <span class="hljs-keyword">in</span> gaps:<br>        i = gap<br>        <span class="hljs-keyword">while</span> i &lt; len(collection):<br>            temp = collection[i]<br>            j = i<br>            <span class="hljs-keyword">while</span> j &gt;= gap <span class="hljs-keyword">and</span> collection[j - gap] &gt; temp:<br>                collection[j] = collection[j - gap]<br>                j -= gap<br>            collection[j] = temp<br>            i += <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">return</span> collection<br></code></pre></td></tr></table></figure><h5 id="（6）桶排序"><a href="#（6）桶排序" class="headerlink" title="（6）桶排序"></a>（6）桶排序</h5><p>桶排序是计数排序的升级版。它利用了函数的映射关系，高效与否的关键就在于这个映射函数的确定。桶排序 (Bucket sort)的工作的原理：假设输入数据服从均匀分布，将数据分到有限数量的桶里，每个桶再分别排序（有可能再使用别的排序算法或是以递归方式继续使用桶排序进行排）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><span class="hljs-comment"># time complexity is O(n)</span><br><br>DEFAULT_BUCKET_SIZE = <span class="hljs-number">10</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bucket_sort</span>(<span class="hljs-params">my_list, bucket_size=DEFAULT_BUCKET_SIZE</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;桶排序&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> len(my_list) == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Please add some elements in the array.&quot;</span>)<br><br>    min_value, max_value = min(my_list), max(my_list)<br>    bucket_count = (max_value - min_value) // bucket_size + <span class="hljs-number">1</span>   <span class="hljs-comment"># 计算桶数量</span><br>    buckets = [[] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(int(bucket_count))]<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(my_list)):<br>        buckets[int((my_list[i] - min_value) // bucket_size)].append(my_list[i])<br><br>    <span class="hljs-keyword">return</span> sorted(<br>        [buckets[i][j] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(buckets)) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(len(buckets[i]))]<br>    )<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    collection = [randint(<span class="hljs-number">-20</span>, <span class="hljs-number">20</span>) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">1000</span>)]<br>    print(*bucket_sort(collection), sep=<span class="hljs-string">&#x27;,&#x27;</span>)<br><br></code></pre></td></tr></table></figure><h5 id="（7）归并排序"><a href="#（7）归并排序" class="headerlink" title="（7）归并排序"></a>（7）归并排序</h5><p>归并排序是建立在归并操作上的一种有效的排序算法。该算法是采用分治法（Divide and Conquer）的一个非常典型的应用。将已有序的子序列合并，得到完全有序的序列；即先使每个子序列有序，再使子序列段间有序。若将两个有序表合并成一个有序表，称为2-路归并。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">merge_sort</span>(<span class="hljs-params">items, comp=lambda x, y: x &lt;= y</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    归并排序 - O(n * log_2 n) - 高级排序算法</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> len(items) &lt; <span class="hljs-number">2</span>:<br>        <span class="hljs-keyword">return</span> items[:]<br>    mid = len(items) // <span class="hljs-number">2</span><br>    left = merge_sort(items[:mid])<br>    right = merge_sort(items[mid:])<br>    <span class="hljs-keyword">return</span> merge(left, right)<br><br><span class="hljs-comment"># 写法一：推荐</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">merge</span>(<span class="hljs-params">left, right</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;将两个有序列表合并成一个新的有序列表&quot;&quot;&quot;</span><br>    result = []<br>    <span class="hljs-keyword">while</span> left <span class="hljs-keyword">and</span> right:<br>        result.append((left <span class="hljs-keyword">if</span> left[<span class="hljs-number">0</span>] &lt;= right[<span class="hljs-number">0</span>] <span class="hljs-keyword">else</span> right).pop(<span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> result + left + right<br><br><span class="hljs-comment"># 写法二    </span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">merge</span>(<span class="hljs-params">items1, items2, comp=lambda x, y: x &lt;= y</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;合并：将两个有序列表合并成一个新的有序列表&quot;&quot;&quot;</span><br>    index1, index2 = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>    result = []<br>    <span class="hljs-keyword">while</span> index1 &lt; len(items1) <span class="hljs-keyword">and</span> index2 &lt; len(items2):<br>        <span class="hljs-keyword">if</span> comp(items1[index1], items2[index2]):<br>            result.append(items1[index1])<br>            index1 += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            result.append(items2[index2])<br>            index2 += <span class="hljs-number">1</span><br>    result += items1[index1:]<br>    result += items2[index2:]<br>    <span class="hljs-keyword">return</span> result<br></code></pre></td></tr></table></figure><h5 id="（8）快速排序"><a href="#（8）快速排序" class="headerlink" title="（8）快速排序"></a>（8）快速排序</h5><p>快速排序的基本思想：通过一趟排序将待排记录分隔成独立的两部分，其中一部分记录的关键字均比另一部分的关键字小，则可分别对这两部分记录继续进行排序，以达到整个序列有序。</p><p>方法一</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">quick_sort</span>(<span class="hljs-params">collection</span>):</span><br>    length = len(collection)<br>    <span class="hljs-keyword">if</span> length &lt;= <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> collection<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># Use the last element as the first pivot</span><br>        pivot = collection.pop()<br>        <span class="hljs-comment"># Put elements greater than pivot in greater list</span><br>        <span class="hljs-comment"># Put elements lesser than pivot in lesser list</span><br>        lesser, greater = [], []<br>        <span class="hljs-keyword">for</span> element <span class="hljs-keyword">in</span> collection:<br>            <span class="hljs-keyword">if</span> element &gt; pivot:<br>                greater.append(element)<br>            <span class="hljs-keyword">else</span>:<br>                lesser.append(element)<br>        <span class="hljs-keyword">return</span> quick_sort(lesser) + [pivot] + quick_sort(greater)<br></code></pre></td></tr></table></figure><p>方法二</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 快速排序 - 以枢轴为界将列表中的元素划分成两个部分，左边小，右边大。选择枢轴很重要</span><br><span class="hljs-comment"># 示例：排序过程</span><br><span class="hljs-comment"># 35, 97, 12, 68, 55, 73, 81, 40</span><br><span class="hljs-comment"># 35, 12, [40], 68, 55, 73, 81, 97</span><br><span class="hljs-comment"># [12], 35, [40], 68, 55, 73, 81, [97]</span><br><span class="hljs-comment"># [12], 35, [40], 55, [68], 73, 81, [97]</span><br><span class="hljs-comment"># [12], 35, [40], 55, [68], 73, [81], [97]</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">quick_sort</span>(<span class="hljs-params">origin_items, comp=lambda x, y: x &lt;= y</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;快速排序&quot;&quot;&quot;</span><br>    items = origin_items[:]<br>    _quick_sort(items, <span class="hljs-number">0</span>, len(items) - <span class="hljs-number">1</span>, comp)<br>    <span class="hljs-keyword">return</span> items<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_quick_sort</span>(<span class="hljs-params">items, start, end, comp</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;递归调用划分和排序&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> start &lt; end:<br>        pos = _partition(items, start, end, comp)<br>        _quick_sort(items, start, pos - <span class="hljs-number">1</span>, comp)<br>        _quick_sort(items, pos + <span class="hljs-number">1</span>, end, comp)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_partition</span>(<span class="hljs-params">items, start, end, comp</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;划分&quot;&quot;&quot;</span><br>    pivot = items[end]<br>    i = start - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(start, end):<br>        <span class="hljs-keyword">if</span> comp(items[j], pivot):<br>            i += <span class="hljs-number">1</span><br>            items[i], items[j] = items[j], items[i]<br>    items[i + <span class="hljs-number">1</span>], items[end] = items[end], items[i + <span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><blockquote><p>注意：快速排序对于有序的数组，时间复杂度会退化为O(n^2)。解决这个问题的办法可以是：每次选择标定点的时候，都随机选择。</p><p>但是上面的办法对于数组中有大量重复元素的情况时，依旧会造成左右分配不均衡，算法性能下降，解决办法是使用3个Partition</p></blockquote><p>快排算法(3个Partition)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> perf_counter<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">quick_sort_3partition</span>(<span class="hljs-params">sorting, left, right</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    :param sorting: 待排序列表</span><br><span class="hljs-string">    :param left: 开始下标</span><br><span class="hljs-string">    :param right: 结束下标</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> right &lt;= left:<br>        <span class="hljs-keyword">return</span><br>    a = index = left   <span class="hljs-comment"># a 始终是枢纽的位置   index 遍历位置</span><br>    b = right      <span class="hljs-comment"># 未排序最大下标</span><br>    pivot = sorting[left]   <span class="hljs-comment"># 枢纽值</span><br>    <span class="hljs-keyword">while</span> index &lt;= b:<br>        <span class="hljs-comment"># 将小于中轴值的元素放在列表前面</span><br>        <span class="hljs-keyword">if</span> sorting[index] &lt; pivot:<br>            <span class="hljs-comment"># 交换位置到枢纽左边，遍历下标推进</span><br>            sorting[a], sorting[index] = sorting[index], sorting[a]<br>            a += <span class="hljs-number">1</span><br>            index += <span class="hljs-number">1</span><br>        <span class="hljs-comment"># 将大于中轴值的元素放在列表后面</span><br>        <span class="hljs-keyword">elif</span> sorting[index] &gt; pivot:<br>            <span class="hljs-comment"># 交换位置到未排序最大位置，遍历下标不变</span><br>            sorting[b], sorting[index] = sorting[index], sorting[b]<br>            b -= <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># 遍历下标推进</span><br>            index += <span class="hljs-number">1</span><br>    <span class="hljs-comment"># 递归对左半部分进行快速排序</span><br>    quick_sort_3partition(sorting, left, a - <span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 递归对右半部分进行快速排序</span><br>    quick_sort_3partition(sorting, b + <span class="hljs-number">1</span>, right)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    unsorted = [randint(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">1000</span>)]<br>    start = perf_counter()<br>    quick_sort_3partition(unsorted, <span class="hljs-number">0</span>, len(unsorted) - <span class="hljs-number">1</span>)<br>    print(*unsorted, sep=<span class="hljs-string">&#x27;,&#x27;</span>)<br>    print(<span class="hljs-string">f&#x27;It cost <span class="hljs-subst">&#123;perf_counter() - start&#125;</span>s&#x27;</span>)<br><br></code></pre></td></tr></table></figure><h3 id="二、常用算法"><a href="#二、常用算法" class="headerlink" title="二、常用算法"></a>二、常用算法</h3><ul><li>穷举法 - 又称为暴力破解法，对所有的可能性进行验证，直到找到正确答案。 </li><li>贪婪法 - 在对问题求解时，总是做出在当前看来是最好的选择，不追求最优解，快速找到满意解。 </li><li>分治法 - 把一个复杂的问题分成两个或更多的相同或相似的子问题，再把子问题分成更小的子问题，直到可以直接求解的程度，最后将子问题的解进行合并得到原问题的解。 </li><li>回溯法 - 回溯法又称为试探法，按选优条件向前搜索，当搜索到某一步发现原先选择并不优或达不到目标时，就退回一步重新选择。 </li><li>动态规划 - 基本思想也是将待求解问题分解成若干个一问题，先求解并保存这些子问题的解，避免产生大量的重复运算。 </li></ul><h4 id="1、贪婪法"><a href="#1、贪婪法" class="headerlink" title="1、贪婪法"></a>1、贪婪法</h4><p>假设一偷有一个背包，最多能装20公斤赃物，他闯入一户人家，发现如下所示的物品。很显然，他不能把所有物品都装进背包，所以必须确定拿走哪些物品，留下哪些物品 。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python">输入：<br><span class="hljs-number">20</span> <span class="hljs-number">6</span><br>电脑 <span class="hljs-number">200</span> <span class="hljs-number">20</span><br>收音机 <span class="hljs-number">20</span> <span class="hljs-number">4</span><br>钟 <span class="hljs-number">175</span> <span class="hljs-number">10</span><br>花瓶 <span class="hljs-number">50</span> <span class="hljs-number">2</span><br>书 <span class="hljs-number">10</span> <span class="hljs-number">1</span><br>油画 <span class="hljs-number">90</span> <span class="hljs-number">9</span><br><span class="hljs-comment"># 贪婪法：不求寻找最优解，只需要去找到满意解(局部最优解)。</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Thing</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;可供小偷偷走的物品&quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, name, price, weight</span>):</span><br>        self.name = name<br>        self.price = price<br>        self.weight = weight<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">value</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;价值重量比&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> self.price / self.weight<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">input_thing</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;拿东西&quot;&quot;&quot;</span><br>    name, price, weight = input(<span class="hljs-string">&#x27;输入种类 价值 重量:&#x27;</span>).split()<br>    <span class="hljs-keyword">return</span> name, int(price), int(weight)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;主函数&quot;&quot;&quot;</span><br>    max_weight, num_of_things = map(int, input(<span class="hljs-string">&#x27;输入背包的容量和可偷物品数量:&#x27;</span>).split())<br>    list_result = []<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(num_of_things):<br>        list_result.append(Thing(*input_thing()))<br>    list_result.sort(key=<span class="hljs-keyword">lambda</span> x: x.value, reverse=<span class="hljs-literal">True</span>)<br>    totle_price, totle_weight = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> thing <span class="hljs-keyword">in</span> list_result:<br>        <span class="hljs-keyword">if</span> totle_weight + thing.weight &lt;= max_weight:<br>            print(<span class="hljs-string">f&#x27;小偷拿走了<span class="hljs-subst">&#123;thing.name&#125;</span>&#x27;</span>)<br>            totle_price += thing.price<br>            totle_weight += thing.weight<br>    print(<span class="hljs-string">f&#x27;总价值<span class="hljs-subst">&#123;totle_price&#125;</span>&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h4 id="2、分治法"><a href="#2、分治法" class="headerlink" title="2、分治法"></a>2、分治法</h4><p>归并算法和快排算法就是采用这种思想</p><h4 id="3、回溯法"><a href="#3、回溯法" class="headerlink" title="3、回溯法"></a>3、回溯法</h4><p>回溯法例子：骑士巡逻和迷宫寻路。 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 按选优条件向前搜索，当搜索到某一步， 发现原先选择并不优或达不到目标时，就退回一步重新选择。 </span><br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> os<br><br><br>SIZE = <span class="hljs-number">5</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_board</span>(<span class="hljs-params">board</span>):</span><br>    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> board:<br>        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> row:<br>            print(str(col).center(<span class="hljs-number">4</span>), end=<span class="hljs-string">&#x27;&#x27;</span>)<br>        print()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">patrol</span>(<span class="hljs-params">board, row, col, step=<span class="hljs-number">1</span></span>):</span><br>    <span class="hljs-keyword">if</span> row &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> row &lt; SIZE <span class="hljs-keyword">and</span> \<br>        col &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> col &lt; SIZE <span class="hljs-keyword">and</span> \<br>        board[row][col] == <span class="hljs-number">0</span>:<br>        board[row][col] = step<br>        time.sleep(<span class="hljs-number">0.5</span>)<br>        os.system(<span class="hljs-string">&#x27;cls&#x27;</span>)   <span class="hljs-comment"># 清除控制台显示</span><br>        print_board(board)<br>        <span class="hljs-keyword">if</span> step == SIZE * SIZE:  <br>            sys.exit(<span class="hljs-number">0</span>)<br>        patrol(board, row - <span class="hljs-number">2</span>, col - <span class="hljs-number">1</span>, step + <span class="hljs-number">1</span>)<br>        patrol(board, row - <span class="hljs-number">1</span>, col - <span class="hljs-number">2</span>, step + <span class="hljs-number">1</span>)<br>        patrol(board, row + <span class="hljs-number">1</span>, col - <span class="hljs-number">2</span>, step + <span class="hljs-number">1</span>)<br>        patrol(board, row + <span class="hljs-number">2</span>, col - <span class="hljs-number">1</span>, step + <span class="hljs-number">1</span>)<br>        patrol(board, row + <span class="hljs-number">2</span>, col + <span class="hljs-number">1</span>, step + <span class="hljs-number">1</span>)<br>        patrol(board, row + <span class="hljs-number">1</span>, col + <span class="hljs-number">2</span>, step + <span class="hljs-number">1</span>)<br>        patrol(board, row - <span class="hljs-number">1</span>, col + <span class="hljs-number">2</span>, step + <span class="hljs-number">1</span>)<br>        patrol(board, row - <span class="hljs-number">2</span>, col + <span class="hljs-number">1</span>, step + <span class="hljs-number">1</span>)<br>        board[row][col] = <span class="hljs-number">0</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    board = [[<span class="hljs-number">0</span>] * SIZE <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(SIZE)]<br>    patrol(board, SIZE - <span class="hljs-number">1</span>, SIZE - <span class="hljs-number">1</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h4 id="4、动态规划"><a href="#4、动态规划" class="headerlink" title="4、动态规划"></a>4、动态规划</h4><p>比如计算斐波那契数列，如果不采用动态规划思想，会有大量的重复运算，导致性能十分低下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager<br><br><br><span class="hljs-comment"># 动态规划 - 保存可能进行重复运算的中间结果(空间换时间)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fib</span>(<span class="hljs-params">n, dict_result=&#123;&#125;</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;斐波那契数列：优化&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">assert</span> n &gt;= <span class="hljs-number">0</span><br>    <span class="hljs-keyword">if</span> n <span class="hljs-keyword">in</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">return</span> dict_result[n]<br>    <span class="hljs-keyword">except</span> KeyError:<br>        dict_result[n] = fib(n - <span class="hljs-number">1</span>) + fib(n - <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">return</span> dict_result[n]<br><br><br><span class="hljs-comment"># 定义上下文管理器</span><br><span class="hljs-meta">@contextmanager</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">timer</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;计时&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        start = time.perf_counter()<br>        <span class="hljs-keyword">yield</span>    <span class="hljs-comment"># yield属于让步操作，让上下文语法中的代码优先执行。</span><br>    <span class="hljs-keyword">finally</span>:<br>        end = time.perf_counter()<br>        print(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;(end - start)&#125;</span>s&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>        <span class="hljs-keyword">with</span> timer():<br>            print(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;num&#125;</span>: <span class="hljs-subst">&#123;fib(num)&#125;</span>&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="三、数据序列化"><a href="#三、数据序列化" class="headerlink" title="三、数据序列化"></a>三、数据序列化</h3><p>序列化 - 将对象编程字节(bytes)或者字符序列(str) – 序列化 = 串行化 = 腌咸菜<br>反序列化 - 把字节序列或者字符序列还原成对象</p><p>python标准库对序列化的支持：<br>json - 字符形式的序列化<br>pickle - 字节形式的序列化<br>shelve - 不常用</p><h3 id="四、哈希摘要"><a href="#四、哈希摘要" class="headerlink" title="四、哈希摘要"></a>四、哈希摘要</h3><p>哈希摘要 - 数字签名/数字指纹 - 单向哈希函数(没有反函数不可逆)</p><p>现在主要有：MD5、SHA1 、SHA256、SHA512</p><p>MD5现在已经被破解，但是小型程序依旧可以使用，建议使用SHA256</p><p><strong>应用领域：</strong></p><ul><li>数据库中用户敏感信息需要保存成哈希摘要。</li><li>给数据生成数字签名，验证数据没有被篡改。</li><li>云存储服务的秒传功能(去重功能)。</li></ul><p>python计算摘要示例：</p><p>普通代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    hasher = hashlib.sha256()<br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./Python-3.7.2.tar.xz&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> file_stream:<br>        data = file_stream.read(<span class="hljs-number">4096</span>)<br>        <span class="hljs-keyword">while</span> data:<br>            hasher.update(data)<br>            data = file_stream.read(<span class="hljs-number">4096</span>)<br>    print(hasher.hexdigest())<br></code></pre></td></tr></table></figure><p>利用面向对象进行代码重构（优化）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StreamHasher</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    摘要生成器</span><br><span class="hljs-string">    @params:</span><br><span class="hljs-string">        algorithm - 哈希摘要算法</span><br><span class="hljs-string">        size - 每次读取字节</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, algorithm=<span class="hljs-string">&#x27;md5&#x27;</span>, size=<span class="hljs-number">4096</span></span>):</span><br><br>        self.size = size<br>        <span class="hljs-comment"># 用以下方法__import__可以动态加载模块，getattr可以拿到对象的属性。</span><br>        cls = getattr(__import__(<span class="hljs-string">&#x27;hashlib&#x27;</span>), algorithm.lower())<br>        self.hasher = cls()<br>        <span class="hljs-comment"># self.algorithm = algorithm.lower()</span><br>        <span class="hljs-comment"># if self.algorithm == &#x27;md5&#x27;:</span><br>        <span class="hljs-comment">#     self.hasher = hashlib.md5()</span><br>        <span class="hljs-comment"># elif self.algorithm == &#x27;sha1&#x27;:</span><br>        <span class="hljs-comment">#     self.hasher = hashlib.sha1()</span><br>        <span class="hljs-comment"># elif self.algorithm == &#x27;sha256&#x27;:</span><br>        <span class="hljs-comment">#     self.hasher = hashlib.sha256()</span><br>        <span class="hljs-comment"># elif self.algorithm == &#x27;sha512&#x27;:</span><br>        <span class="hljs-comment">#     self.hasher = hashlib.sha512()</span><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     raise ValueError(&#x27;不支持的哈希摘要算法&#x27;)</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hex_digest</span>(<span class="hljs-params">self, file_stream</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;生成十六进制的字符串摘要&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># data = file_stream.read(self.size)</span><br>        <span class="hljs-comment"># while data:</span><br>        <span class="hljs-comment">#     self.hasher.update(data)</span><br>        <span class="hljs-comment">#     data = file_stream.read(self.size)</span><br>        <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> iter(<span class="hljs-keyword">lambda</span>: file_stream.read(self.size), <span class="hljs-string">b&#x27;&#x27;</span>):<br>            <span class="hljs-comment"># iter() 能够生成一个迭代器</span><br>            <span class="hljs-comment"># b&#x27;&#x27; --&gt; 相当于一个哨兵，当迭代二进制数据为空时，停止迭代。</span><br>            self.hasher.update(data)<br>        <span class="hljs-keyword">return</span> self.hasher.hexdigest()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span>(<span class="hljs-params">self, file_stream</span>):</span><br>        <span class="hljs-comment"># 定义此魔术方法，可以使用对象，会自动调用此方法。</span><br>        <span class="hljs-keyword">return</span> self.hex_digest(file_stream)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    hasher = StreamHasher(algorithm=<span class="hljs-string">&#x27;sha256&#x27;</span>)<br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./Python-3.7.2.rar&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> file_stream:<br>        print(hasher.hex_digest(file_stream))<br>        <span class="hljs-comment"># print(hasher(file_stream)) </span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="五、加密和解密"><a href="#五、加密和解密" class="headerlink" title="五、加密和解密"></a>五、加密和解密</h3><ul><li>对称加密：加密和解密是同一个密钥 - DES/AES</li><li>非对称加密：加密和解密不是同一个密钥 - RSA</li></ul><p>python没有内置加密算法，可以使用第三方库 PyCrypto</p><p><code>pip install pycrypto</code></p><h4 id="1、AES算法"><a href="#1、AES算法" class="headerlink" title="1、AES算法"></a>1、AES算法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5<br><br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">from</span> Crypto <span class="hljs-keyword">import</span> Random<br><br><br><span class="hljs-comment"># AES的密钥，长度为32个字节</span><br>key = md5(<span class="hljs-string">&#x27;start&#x27;</span>.encode()).hexdigest()<br><span class="hljs-comment"># AES初始加密向量(随机生成)</span><br>iv = Random.new().read(AES.block_size)<br>print(<span class="hljs-string">&#x27;key:&#x27;</span>, key)<br>print(<span class="hljs-string">&#x27;iv:&#x27;</span>,  iv)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">aes_encrypt</span>(<span class="hljs-params">origin_message, key</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;AES加密&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># AES.MODE_CFB加密模式，CFB加密模式对加密内容没有长度限制</span><br>    cipher = AES.new(key, AES.MODE_CFB, iv)<br>    <span class="hljs-keyword">return</span> cipher.encrypt(origin_message)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">aes_decrypt</span>(<span class="hljs-params">encrypt_message, key</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;AES解密&quot;&quot;&quot;</span><br>    cipher = AES.new(key, AES.MODE_CFB, iv)<br>    <span class="hljs-keyword">return</span> cipher.decrypt(encrypt_message)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    origin_message = <span class="hljs-string">&#x27;hello world!&#x27;</span><br>    encrypt_message = aes_encrypt(origin_message, key)<br>    print(encrypt_message)<br>    origin_message = aes_decrypt(encrypt_message, key)<br>    print(origin_message.decode())<br></code></pre></td></tr></table></figure><blockquote><p>向量iv可以随机生成，但是要求为16个字节</p></blockquote><h4 id="2、RSA算法"><a href="#2、RSA算法" class="headerlink" title="2、RSA算法"></a>2、RSA算法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.PublicKey <span class="hljs-keyword">import</span> RSA<br><br>key_pair = RSA.generate(<span class="hljs-number">1024</span>)   <span class="hljs-comment"># 生成密钥对</span><br>pub_key = RSA.importKey(key_pair.publickey().exportKey())  <span class="hljs-comment"># 公钥对象</span><br>pri_key = RSA.importKey(key_pair.exportKey())   <span class="hljs-comment"># 私钥对象</span><br>message = <span class="hljs-string">&#x27;hello, world!&#x27;</span><br>data = pub_key.encrypt(message.encode(), <span class="hljs-literal">None</span>)  <span class="hljs-comment"># 加密需要转换成字节串</span><br>print(data)<br>de_message = pri_key.decrypt(data)<br>print(de_message.decode())<br></code></pre></td></tr></table></figure><p>本机通过RSA算法生成密钥对的话，需要安装<code>openssl</code>工具</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">创建私钥 <br>openssl genpkey -algorithm RSA -outform PEM -out private_key.pem<br><br>利用私钥生成共钥<br>openssl rsa -in private_key.pem -outform PEM -pubout -out public_key.pem<br><br>echo &quot;hello world&quot; &gt; plain.txt<br><br>加密<br>openssl rsautl -encrypt -inkey public_key.pem -pubin -in plain.txt -out encrypted.txt<br>解密<br>openssl rsautl -decrypt -inkey private_key.pem -in encrypted.txt -out decrypted.txt<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>排序</tag>
      
      <tag>算法</tag>
      
      <tag>哈希</tag>
      
      <tag>加密</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>单元测试</title>
    <link href="/Myblog/2019/01/02/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    <url>/Myblog/2019/01/02/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<p>单元测试 - 针对程序中最小的功能模块(函数和方法)的测试</p><p>测试方法：</p><ul><li>白盒测试：程序员自己写的测试</li><li>黑盒测试：测试人员或QA，不知道代码实现细节，只关注功能</li></ul><h4 id="编写测试用例"><a href="#编写测试用例" class="headerlink" title="编写测试用例"></a>编写测试用例</h4><p>使用python内置测试模块unittest</p><p>编写python单元测试 - 定义类继承TestCase，写测试方法(test_开头)</p><p>例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># test_example01.py</span><br><span class="hljs-keyword">from</span> unittest <span class="hljs-keyword">import</span> TestCase, main<br><br><span class="hljs-keyword">from</span> example01 <span class="hljs-keyword">import</span> seq_search, bin_search<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSearchFunction</span>(<span class="hljs-params">TestCase</span>):</span><br>    <br><span class="hljs-comment"># 执行每个测试函数之前都要执行的函数</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>):</span><br>self.data1 = [<span class="hljs-number">35</span>,<span class="hljs-number">97</span>,<span class="hljs-number">12</span>,<span class="hljs-number">68</span>,<span class="hljs-number">55</span>,<span class="hljs-number">73</span>,<span class="hljs-number">81</span>,<span class="hljs-number">40</span>]<br>self.data2 = [<span class="hljs-number">12</span>,<span class="hljs-number">35</span>,<span class="hljs-number">36</span>,<span class="hljs-number">75</span>,<span class="hljs-number">84</span>,<span class="hljs-number">85</span>,<span class="hljs-number">93</span>]<br><br><span class="hljs-comment"># 执行每个测试函数之后要执行的函数</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>):</span><br><span class="hljs-keyword">pass</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_seq_search</span>(<span class="hljs-params">self</span>):</span><br>self.assertEqual(<span class="hljs-number">0</span>, seq_search(self.data1, <span class="hljs-number">35</span>))<br>self.assertEqual(<span class="hljs-number">5</span>, seq_search(self.data1, <span class="hljs-number">73</span>))<br>self.assertEqual(<span class="hljs-number">6</span>, seq_search(self.data1, <span class="hljs-number">81</span>))<br>self.assertEqual(<span class="hljs-number">2</span>, seq_search(self.data1, <span class="hljs-number">12</span>))<br>self.assertEqual(<span class="hljs-number">-1</span>, seq_search(self.data1, <span class="hljs-number">99</span>))<br>self.assertEqual(<span class="hljs-number">-1</span>, seq_search(self.data1, <span class="hljs-number">3</span>))<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_bin_search</span>(<span class="hljs-params">self</span>):</span><br>self.assertEqual(<span class="hljs-number">1</span>, bin_search(self.data2, <span class="hljs-number">35</span>))<br>self.assertEqual(<span class="hljs-number">-1</span>, bin_search(self.data2, <span class="hljs-number">73</span>))<br>self.assertEqual(<span class="hljs-number">6</span>, bin_search(self.data2, <span class="hljs-number">93</span>))<br>self.assertEqual(<span class="hljs-number">0</span>, bin_search(self.data2, <span class="hljs-number">12</span>))<br>self.assertEqual(<span class="hljs-number">-1</span>, bin_search(self.data2, <span class="hljs-number">99</span>))<br>self.assertEqual(<span class="hljs-number">-1</span>, bin_search(self.data2, <span class="hljs-number">3</span>))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>main()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># example01.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">seq_search</span>(<span class="hljs-params">items: list, elem</span>) -&gt; int:</span><br><span class="hljs-string">&quot;&quot;&quot;顺序查找&quot;&quot;&quot;</span><br><span class="hljs-keyword">for</span> index, item <span class="hljs-keyword">in</span> enumerate(items):<br><span class="hljs-keyword">if</span> item == elem:<br><span class="hljs-keyword">return</span> index<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bin_search</span>(<span class="hljs-params">items: list, elem</span>) -&gt; int:</span><br><span class="hljs-string">&quot;&quot;&quot;二分查找&quot;&quot;&quot;</span><br>start, end = <span class="hljs-number">0</span> , len(items) <span class="hljs-number">-1</span><br><span class="hljs-keyword">while</span> start &lt;= end:<br>middle = (start + end) // <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> elem == items[middle]:<br><span class="hljs-keyword">return</span> middle<br><span class="hljs-keyword">elif</span> elem &gt; items[middle]:<br>start = middle + <span class="hljs-number">1</span><br><span class="hljs-keyword">elif</span> elem &lt; items[middle]:<br>end = middle - <span class="hljs-number">1</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br></code></pre></td></tr></table></figure><h4 id="执行单元测试"><a href="#执行单元测试" class="headerlink" title="执行单元测试"></a>执行单元测试</h4><ul><li><p>Python内置</p><ol><li>unittest.main()</li><li>python3 -m unittest &lt;文件名&gt;</li></ol></li><li><p>第三方库</p><p>自动检查执行单元测试</p><ul><li><p>pytest</p><p>安装 <code>pip install pytest pytest-cov</code></p><p>执行<code>pytest</code> 或者 查看测试详细信息<code>pytest -v --cov</code></p></li><li><p>nose2</p><p>安装 <code>pip install nose2 cov-core</code></p><p>执行<code>nose2</code> 或者 查看测试详细信息 <code>nose2 -v -C</code></p></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>单元测试</category>
      
    </categories>
    
    
    <tags>
      
      <tag>单元测试</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python操作Excel</title>
    <link href="/Myblog/2018/12/18/Python%E6%93%8D%E4%BD%9CExcel/"/>
    <url>/Myblog/2018/12/18/Python%E6%93%8D%E4%BD%9CExcel/</url>
    
    <content type="html"><![CDATA[<p>Python操作Excel主要用到xlrd和xlwt这两个库，即xlrd是读excel，xlwt是写excel的库。 </p><h4 id="Xlrd"><a href="#Xlrd" class="headerlink" title="Xlrd"></a>Xlrd</h4><p>xlrd主要是用来读取excel文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> xlrd<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">open_excel</span>():</span><br>    <span class="hljs-comment"># 打开文件</span><br>    workbook = xlrd.open_workbook(<span class="hljs-string">r&#x27;test.xls&#x27;</span>)<br>    <span class="hljs-comment"># 获取所有sheet名称</span><br>    sheet_names = workbook.sheet_names()<br>    count_sheet = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> sheet_name <span class="hljs-keyword">in</span> sheet_names:<br>        <span class="hljs-comment"># 通过名称拿到sheet对象</span><br>        sheet = workbook.sheet_by_name(sheet_name)<br>        <span class="hljs-comment"># 获取行数</span><br>        nrows = sheet.nrows<br>        <span class="hljs-comment"># ncols = sheet.ncols   # 获取列</span><br>        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> range(nrows):<br>            print(row + count_sheet * <span class="hljs-number">1000</span>)<br>            <span class="hljs-comment"># 拿到行的内容</span><br>            print(sheet.row_values(row))<br>        count_sheet += <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h4 id="Xlwt"><a href="#Xlwt" class="headerlink" title="Xlwt"></a>Xlwt</h4><p>xlwt 创建一个全新的excel文件,然后对这个文件进行写入内容以及保存。 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> xlwt<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write_excel</span>():</span><br>    <span class="hljs-comment"># 创建工作簿</span><br>    workbook = xlwt.Workbook()<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>):<br>        <span class="hljs-comment"># 添加对应的sheet</span><br>        sheet = workbook.add_sheet(<span class="hljs-string">&#x27;sheet %d&#x27;</span>%x)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<br>                <span class="hljs-comment"># 在（i，j）位置写入内容</span><br>                sheet.write(i,j, <span class="hljs-string">&#x27;%d + %d = %d&#x27;</span>%(i, j, i+j))<br>    <span class="hljs-comment"># 保存</span><br>    workbook.save(<span class="hljs-string">&#x27;test1.xls&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="Xlutils"><a href="#Xlutils" class="headerlink" title="Xlutils"></a>Xlutils</h4><p>xlutils 读入一个excel文件，然后进行修改或追加，不能操作xlsx，只能操作xls。  </p><p>xlutils库就像是xlrd库和xlwt库之间的一座桥梁，因此，xlutils库是依赖于xlrd和xlwt两个库的。 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append_excel</span>():</span><br>    workbook = xlrd.open_workbook(<span class="hljs-string">&#x27;./test1.xls&#x27;</span>)<br>    <span class="hljs-comment"># 然后使用xlutils.copy模块将xlrd.Book对象拷贝为一个xlwt.workbook对象</span><br>    wt = xlutils.copy.copy(workbook)<br>    sheet = wt.get_sheet(<span class="hljs-number">0</span>)<br>    sheet.write(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;change&#x27;</span>)<br>    wt.save(<span class="hljs-string">&#x27;test2.xls&#x27;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Excel</category>
      
    </categories>
    
    
    <tags>
      
      <tag>excel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Powerdesigner和逆向生成模型</title>
    <link href="/Myblog/2018/12/13/Powerdesigner%E5%92%8C%E9%80%86%E5%90%91%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/"/>
    <url>/Myblog/2018/12/13/Powerdesigner%E5%92%8C%E9%80%86%E5%90%91%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h4 id="利用Powerdesigner"><a href="#利用Powerdesigner" class="headerlink" title="利用Powerdesigner"></a>利用Powerdesigner</h4><p>首先利用Powerdesigner工具生成软件模型，导出sql数据</p><p>注意：中间表的表名需要在后面加’s’，方便后面Django项目识别。</p><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><p>导入sql，创建数据库对应表信息</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">source &lt;<span class="hljs-keyword">sql</span> <span class="hljs-type">path</span>&gt;<br></code></pre></td></tr></table></figure><h4 id="创建项目逆向生成模型"><a href="#创建项目逆向生成模型" class="headerlink" title="创建项目逆向生成模型"></a>创建项目逆向生成模型</h4><h5 id="一、创建Django项目"><a href="#一、创建Django项目" class="headerlink" title="一、创建Django项目"></a>一、创建Django项目</h5><p>连接对应数据库，配置好之后，使用命令逆向生成Django模型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python manage.py inspectdb &gt; app/models.py<br></code></pre></td></tr></table></figure><p>注意：生成模型中没有表与表之间的关系，需要手动添加</p><ul><li>如果Django能识别中间表</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 多对多关系</span><br>student = models.ManyToManyField(Student)<br><span class="hljs-comment"># 一对多关系</span><br>lesson = models.ForeignKey(lesson, null=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>添加关联关系</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 生成对象student和对象lesson</span><br>student.lesson.add(lesson)<br>lesson.student_set.add(student)<br></code></pre></td></tr></table></figure><ul><li>如果Django不能识别中间表</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">course = models.ManyToManyField(Course, through=<span class="hljs-string">&#x27;StudentCourses&#x27;</span>) <br><span class="hljs-comment"># through=&#x27;StudentCourse&#x27;指定中间表</span><br></code></pre></td></tr></table></figure><p>添加关联关系</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 生成对象student和对象lesson</span><br>student_lessons = StudentLessons(student=student, lesson=lesson)<br></code></pre></td></tr></table></figure><h5 id="二、创建Flask项目"><a href="#二、创建Flask项目" class="headerlink" title="二、创建Flask项目"></a>二、创建Flask项目</h5><p>确保连接数据库后，利用flask-sqlacodegen逆向生成SQLAlchemy模型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install flask-sqlacodegen<br>pip install pymysql<br></code></pre></td></tr></table></figure><p>使用命令生成模型，输出模型到app/models.py中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">flask-sqlacodegen --flask mysql+pymysql://root:<span class="hljs-number">123456</span>@localhost:<span class="hljs-number">3306</span>/maoyan  --outfile app/models.py<br></code></pre></td></tr></table></figure><h4 id="在线查看数据模型网站"><a href="#在线查看数据模型网站" class="headerlink" title="在线查看数据模型网站"></a>在线查看数据模型网站</h4><p>在线查看数据模型网站 <a href="http://www.dmanywhere.cn/">传送门</a></p>]]></content>
    
    
    <categories>
      
      <category>逆向生成模型</category>
      
    </categories>
    
    
    <tags>
      
      <tag>逆向生成模型</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Scrapy</title>
    <link href="/Myblog/2018/12/05/Scrapy/"/>
    <url>/Myblog/2018/12/05/Scrapy/</url>
    
    <content type="html"><![CDATA[<p><strong>Scrapy 是一个爬取效率高、扩展性强、跨平台运行的爬虫框架。</strong></p><p>scrapy支持提取数据的几种方式：</p><ul><li>CSS</li><li>XPATH</li><li>RE（正则） </li></ul><h4 id="安装Scrapy"><a href="#安装Scrapy" class="headerlink" title="安装Scrapy"></a>安装Scrapy</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install scrapy<br></code></pre></td></tr></table></figure><p>如果没有安装一些依赖库需要先安装</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install wheel<br>pip install lxml<br>pip install pypiwin32<br></code></pre></td></tr></table></figure><p>scrapy依赖twiste，进入<a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/">传送门</a>下载对应的twiste版本，下载python版本和位数对应的twiste版本，比如python3.6.5-32位则选择<code>Twisted‑18.9.0‑cp36‑cp36m‑win32.whl</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install Twisted‑<span class="hljs-number">18.9</span><span class="hljs-number">.0</span>‑cp36‑cp36m‑win32.whl<br></code></pre></td></tr></table></figure><h4 id="创建Scrapy项目"><a href="#创建Scrapy项目" class="headerlink" title="创建Scrapy项目"></a>创建Scrapy项目</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 创建一个scrapy项目，然后会有提示，进入项目创建蜘蛛文件</span><br>scrapy startproject project_name<br><span class="hljs-comment"># 创建蜘蛛文件</span><br>cd project_name<br>scrapy genspider example example.com  <span class="hljs-comment">#  蜘蛛名 域名</span><br></code></pre></td></tr></table></figure><h4 id="配置项目"><a href="#配置项目" class="headerlink" title="配置项目"></a>配置项目</h4><p>防止被爬网站的robots.txt起作用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># settings文件</span><br>ROBOTSTXT_OBEY = <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><p>设置保存为中文</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 保存为中文</span><br>FEED_EXPORT_ENCODING = <span class="hljs-string">&#x27;utf-8&#x27;</span><br></code></pre></td></tr></table></figure><p>运行项目</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">scrapy crawl spider<br><br><span class="hljs-comment"># 保存到文件 (csv, xml, pickle, marshal)</span><br>scrapy crawl spider -o spider.json<br></code></pre></td></tr></table></figure><p>或者可以起一个run.py文件，执行文件即可运行项目</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> scrapy <span class="hljs-keyword">import</span> cmdline<br><br># cmdline.<span class="hljs-keyword">execute</span>([<span class="hljs-string">&#x27;scrapy&#x27;</span>, <span class="hljs-string">&#x27;crawl&#x27;</span>, <span class="hljs-string">&#x27;cat&#x27;</span>])<br>cmdline.<span class="hljs-keyword">execute</span>(<span class="hljs-string">&#x27;scrapy crawl cat -o maoyan_top.json&#x27;</span>.split(<span class="hljs-string">&#x27; &#x27;</span>))<br></code></pre></td></tr></table></figure><h4 id="Scrapy项目实例（爬取数据保存到数据库）"><a href="#Scrapy项目实例（爬取数据保存到数据库）" class="headerlink" title="Scrapy项目实例（爬取数据保存到数据库）"></a>Scrapy项目实例（爬取数据保存到数据库）</h4><p>项目爬取数据存储方式分别为Json，Pymysql，Pymongo，MongoEngine</p><p>蜘蛛文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> scrapy<br><br><span class="hljs-keyword">from</span> day8.items <span class="hljs-keyword">import</span> Day8Item<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FootballSpider</span>(<span class="hljs-params">scrapy.Spider</span>):</span><br>    <span class="hljs-comment"># 蜘蛛名</span><br>    name = <span class="hljs-string">&#x27;spider&#x27;</span><br>    <span class="hljs-comment"># 域名</span><br>    allowed_domains = [<span class="hljs-string">&#x27;maoyan.com&#x27;</span>]<br>    <span class="hljs-comment"># 爬取开始网址</span><br>    start_urls = [<span class="hljs-string">&#x27;http://maoyan.com/board/4&#x27;</span>]<br><br>    <span class="hljs-comment"># 构造请求</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start_requests</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;发出请求，返回请求，方法自动调用&quot;&quot;&quot;</span><br>        headers = &#123;<br>            <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; 360SE)&#x27;</span>,<br>            <span class="hljs-string">&#x27;Accept&#x27;</span>: <span class="hljs-string">&#x27;application/json, text/plain, */*&#x27;</span>,<br>            <span class="hljs-string">&#x27;Accept-Encoding&#x27;</span>: <span class="hljs-string">&#x27;gzip, deflate, sdch&#x27;</span>,<br>            <span class="hljs-string">&#x27;Accept-Language&#x27;</span>: <span class="hljs-string">&#x27;zh-CN,zh;q=0.8,en;q=0.6,ja;q=0.4,zh-TW;q=0.2,mt;q=0.2&#x27;</span>,<br>            <span class="hljs-string">&#x27;Connection&#x27;</span>: <span class="hljs-string">&#x27;keep-alive&#x27;</span>,<br>            <span class="hljs-string">&#x27;X-Requested-With&#x27;</span>: <span class="hljs-string">&#x27;XMLHttpRequest&#x27;</span>,<br>            <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/x-www-form-urlencoded; charset=UTF-8&#x27;</span>,<br>        &#125;<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<br>            <span class="hljs-keyword">yield</span> scrapy.Request(url=<span class="hljs-string">&#x27;http://maoyan.com/board/4?offset=%d&#x27;</span> %(i * <span class="hljs-number">10</span>),<br>                                 headers=headers,<br>                                 method=<span class="hljs-string">&#x27;GET&#x27;</span>,<br>                                 callback=self.parse,<br>                                 )<br><br>    <span class="hljs-comment"># 解析响应</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse</span>(<span class="hljs-params">self, response</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;解析页面&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 支持css，xpath，re方式提取数据</span><br>        <span class="hljs-comment"># extract()可以将对象转换成列表</span><br>        <span class="hljs-comment"># extract_first()拿到第一个元素，和extract()[0]想过相同。</span><br>        title = response.selector.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;movie-item-info&quot;]/p[@class=&quot;name&quot;]/a/@title&#x27;</span>).extract()  <span class="hljs-comment"># 列表</span><br>        point_one = response.selector.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;movie-item-number score-num&quot;]/p/i[@class=&quot;integer&quot;]/text()&#x27;</span>).extract()<br>        point_two = response.selector.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;movie-item-number score-num&quot;]/p/i[@class=&quot;fraction&quot;]/text()&#x27;</span>).extract()<br>        point = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(point_one)):<br>            point_temp = str(point_one[i]) + str(point_two[i])<br>            point.append(point_temp)<br>        star = response.selector.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;movie-item-info&quot;]/p[@class=&quot;star&quot;]/text()&#x27;</span>).extract()<br>        releasetime = response.selector.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;movie-item-info&quot;]/p[@class=&quot;releasetime&quot;]/text()&#x27;</span>).extract()<br>        response.selector.xpath(<span class="hljs-string">&#x27;sdsdsd&#x27;</span>).extract_first()<br>        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(len(title)):<br>            item = Day8Item()<br>            item[<span class="hljs-string">&#x27;title&#x27;</span>] = title[index]<br>            item[<span class="hljs-string">&#x27;point&#x27;</span>] = point[index]<br>            item[<span class="hljs-string">&#x27;star&#x27;</span>] = star[index].strip()<br>            item[<span class="hljs-string">&#x27;releasetime&#x27;</span>] = releasetime[index]<br>            <span class="hljs-keyword">yield</span> item<br></code></pre></td></tr></table></figure><p>items.py文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> scrapy<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Day8Item</span>(<span class="hljs-params">scrapy.Item</span>):</span><br>    <span class="hljs-comment"># define the fields for your item here like:</span><br>    title = scrapy.Field()<br>    point = scrapy.Field()<br>    star = scrapy.Field()<br>    releasetime = scrapy.Field()<br></code></pre></td></tr></table></figure><p>pipelines.py文件</p><p>注意里面的方法文件名不能写错，对应方法scrapy会自动调用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">import</span>  pymysql<br><span class="hljs-keyword">import</span>  pymongo<br><span class="hljs-keyword">from</span> mongoengine <span class="hljs-keyword">import</span>  *<br><br><span class="hljs-keyword">from</span> day8.modles <span class="hljs-keyword">import</span> Movie<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaoyanMysqlPipeline</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;pymysql方式插入mysql&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, host, port, database, username, password</span>):</span><br>        self.host = host<br>        self.port = port<br>        self.database = database<br>        self.username = username<br>        self.password = password<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">from_crawler</span>(<span class="hljs-params">cls, crawler</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;返回数据，初始化实例&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> cls(host=crawler.settings.get(<span class="hljs-string">&quot;MYSQL_HOST&quot;</span>),<br>                    port=crawler.settings.get(<span class="hljs-string">&quot;MYSQL_PORT&quot;</span>),<br>                    username=crawler.settings.get(<span class="hljs-string">&quot;MYSQL_USERNAME&quot;</span>),<br>                    password=crawler.settings.get(<span class="hljs-string">&quot;MYSQL_PASSWORD&quot;</span>),<br>                    database=crawler.settings.get(<span class="hljs-string">&quot;MYSQL_DATABASE&quot;</span>),<br>                    )<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">open_spider</span>(<span class="hljs-params">self, spider</span>):</span><br>        self.db = pymysql.connect(host=self.host, port=self.port, user=self.username, db=self.database, password=self.password)<br>        self.cursor = self.db.cursor()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close_spider</span>(<span class="hljs-params">self, spider</span>):</span><br>        self.db.close()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_item</span>(<span class="hljs-params">self, item, spider</span>):</span><br>        sql = <span class="hljs-string">&#x27;insert into maoyan_top (title, point, star, releasetime) values (&quot;%s&quot;,&quot;%s&quot;,&quot;%s&quot;,&quot;%s&quot;)&#x27;</span>%(item[<span class="hljs-string">&#x27;title&#x27;</span>], item[<span class="hljs-string">&#x27;point&#x27;</span>], item[<span class="hljs-string">&#x27;star&#x27;</span>], item[<span class="hljs-string">&#x27;releasetime&#x27;</span>])<br>        self.cursor.execute(sql)<br>        self.db.commit()<br>        <span class="hljs-keyword">return</span> item<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaoyanPymongoPipeline</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;pymongo方式插入mongodb&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, database</span>):</span><br>        self.database = database<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">from_crawler</span>(<span class="hljs-params">cls, crawler</span>):</span><br>        <span class="hljs-keyword">return</span> cls(database=crawler.settings.get(<span class="hljs-string">&quot;MONGO_DB&quot;</span>),)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">open_spider</span>(<span class="hljs-params">self, spider</span>):</span><br>        self.client = pymongo.MongoClient()<br>        self.db = self.client[self.database]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close_spider</span>(<span class="hljs-params">self, spider</span>):</span><br>        self.client.close()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_item</span>(<span class="hljs-params">self, item, spider</span>):</span><br>        movie = &#123;&#125;<br>        movie[<span class="hljs-string">&#x27;title&#x27;</span>] = item[<span class="hljs-string">&#x27;title&#x27;</span>]<br>        movie[<span class="hljs-string">&#x27;point&#x27;</span>] = item[<span class="hljs-string">&#x27;point&#x27;</span>]<br>        movie[<span class="hljs-string">&#x27;star&#x27;</span>] = item[<span class="hljs-string">&#x27;star&#x27;</span>]<br>        movie[<span class="hljs-string">&#x27;releasetime&#x27;</span>] = item[<span class="hljs-string">&#x27;releasetime&#x27;</span>]<br>        self.db.maoyan.insert_one(movie)<br>        <span class="hljs-keyword">return</span> item<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaoyanMongoPipeline</span>(<span class="hljs-params">object</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;mongoengine操作模型方式插入mongodb&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, database</span>):</span><br>        self.database = database<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">from_crawler</span>(<span class="hljs-params">cls, crawler</span>):</span><br>        <span class="hljs-keyword">return</span> cls(database=crawler.settings.get(<span class="hljs-string">&quot;MONGO_DB&quot;</span>),)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">open_spider</span>(<span class="hljs-params">self, spider</span>):</span><br>        connect(self.database)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close_spider</span>(<span class="hljs-params">self, spider</span>):</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_item</span>(<span class="hljs-params">self, item, spider</span>):</span><br>        movie = Movie()<br>        movie.title = item[<span class="hljs-string">&#x27;title&#x27;</span>]<br>        movie.point = item[<span class="hljs-string">&#x27;point&#x27;</span>]<br>        movie.star = item[<span class="hljs-string">&#x27;star&#x27;</span>]<br>        movie.releasetime = item[<span class="hljs-string">&#x27;releasetime&#x27;</span>]<br>        movie.save()<br>        <span class="hljs-keyword">return</span> item<br></code></pre></td></tr></table></figure><p>modles.py文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> mongoengine <span class="hljs-keyword">import</span> *<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Movie</span>(<span class="hljs-params">Document</span>):</span><br>    title = StringField(max_length=<span class="hljs-number">256</span>)<br>    point = StringField(max_length=<span class="hljs-number">50</span>)<br>    star = StringField(max_length=<span class="hljs-number">256</span>)<br>    releasetime = StringField(max_length=<span class="hljs-number">128</span>)<br></code></pre></td></tr></table></figure><p>settings.py文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python">BOT_NAME = <span class="hljs-string">&#x27;day8&#x27;</span><br><br>SPIDER_MODULES = [<span class="hljs-string">&#x27;day8.spiders&#x27;</span>]<br>NEWSPIDER_MODULE = <span class="hljs-string">&#x27;day8.spiders&#x27;</span><br><br>ROBOTSTXT_OBEY = <span class="hljs-literal">False</span><br><br>ITEM_PIPELINES = &#123;<br>    <span class="hljs-comment"># 数字越小，优先级越高</span><br>    <span class="hljs-string">&#x27;day8.pipelines.MaoyanMysqlPipeline&#x27;</span>: <span class="hljs-number">300</span>,    <span class="hljs-comment"># Pymysql</span><br>    <span class="hljs-string">&#x27;day8.pipelines.MaoyanPymongoPipeline&#x27;</span>: <span class="hljs-number">500</span>,     <span class="hljs-comment"># Pymongo</span><br>    <span class="hljs-string">&#x27;day8.pipelines.MaoyanMongoPipeline&#x27;</span>: <span class="hljs-number">700</span>,    <span class="hljs-comment"># MongoEngine</span><br>&#125;<br><br><span class="hljs-comment"># 保存为中文</span><br>FEED_EXPORT_ENCODING = <span class="hljs-string">&#x27;utf-8&#x27;</span><br><br><span class="hljs-comment"># mysql_settings</span><br>MYSQL_HOST = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span><br>MYSQL_PORT = <span class="hljs-number">3306</span><br>MYSQL_USERNAME = <span class="hljs-string">&#x27;root&#x27;</span><br>MYSQL_PASSWORD = <span class="hljs-string">&#x27;123456&#x27;</span><br>MYSQL_DATABASE = <span class="hljs-string">&#x27;maoyan&#x27;</span><br><br><span class="hljs-comment"># mongo setting</span><br>MONGO_DB = <span class="hljs-string">&#x27;maoyan&#x27;</span><br></code></pre></td></tr></table></figure><p>run.py启动文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> scrapy <span class="hljs-keyword">import</span> cmdline<br><br><span class="hljs-comment"># cmdline.execute([&#x27;scrapy&#x27;, &#x27;crawl&#x27;, &#x27;cat&#x27;])</span><br>cmdline.execute(<span class="hljs-string">&#x27;scrapy crawl cat -o maoyan_top.json&#x27;</span>.split(<span class="hljs-string">&#x27; &#x27;</span>))<br></code></pre></td></tr></table></figure><h4 id="Scrapy保存图片"><a href="#Scrapy保存图片" class="headerlink" title="Scrapy保存图片"></a>Scrapy保存图片</h4><p>pipelines.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> scrapy <span class="hljs-keyword">import</span> Request<br><span class="hljs-keyword">from</span> scrapy.exceptions <span class="hljs-keyword">import</span> DropItem<br><span class="hljs-keyword">from</span> scrapy.pipelines.images <span class="hljs-keyword">import</span> ImagesPipeline<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZhankuImagePipeline</span>(<span class="hljs-params">ImagesPipeline</span>):</span><br><br>    <span class="hljs-comment"># 构造图片url请求</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_media_requests</span>(<span class="hljs-params">self, item, info</span>):</span><br>        <span class="hljs-keyword">yield</span> Request(item[<span class="hljs-string">&#x27;preview_url&#x27;</span>])<br><br>    <span class="hljs-comment"># 返回图片文件名</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">file_path</span>(<span class="hljs-params">self, request, response=None, info=None</span>):</span><br>        url = request.url<br>        file_name = url.split(<span class="hljs-string">&#x27;/&#x27;</span>)[<span class="hljs-number">-1</span>]<br>        <span class="hljs-keyword">return</span>  file_name<br><br>    <span class="hljs-comment"># 判断图片下载请求是否成功</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">item_completed</span>(<span class="hljs-params">self, results, item, info</span>):</span><br>        image_paths = [x[<span class="hljs-string">&#x27;path&#x27;</span>] <span class="hljs-keyword">for</span> ok, x <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span> ok]<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_paths:<br>            <span class="hljs-keyword">raise</span> DropItem(<span class="hljs-string">&#x27;Image Downloaded Failed&#x27;</span>)<br>        <span class="hljs-keyword">return</span> item<br></code></pre></td></tr></table></figure><p>settings文件中配置保存路径和开启管道</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">ITEM_PIPELINES = &#123;<br>   <span class="hljs-string">&#x27;zhancool.pipelines.ZhancoolImagePipeline&#x27;</span>: <span class="hljs-number">300</span>,<br>&#125;<br><span class="hljs-comment"># 图片保存路径</span><br>IMAGES_STORE = <span class="hljs-string">&#x27;./images&#x27;</span><br><br></code></pre></td></tr></table></figure><h4 id="Scrapy分布式"><a href="#Scrapy分布式" class="headerlink" title="Scrapy分布式"></a>Scrapy分布式</h4><p>不同的主机的调度器从共享队列中获取爬取队列。最好使用redis列表或有序集合，提供重复过滤，调度器会从redis队列中取没有爬取的继续爬取。</p><p>redis本身不支持分布式，安装scrapy-redis </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install scrapy-redis<br></code></pre></td></tr></table></figure><p>注意：爬取下来的数据不要存在本机，应该存放在共同的位置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># settings里面配置，即可实现分布式</span><br><span class="hljs-comment"># REDIS_URL中存放共享队列位置（目标redis）</span><br><br>SCHEDULER = <span class="hljs-string">&#x27;scrapy_redis.scheduler.Scheduler&#x27;</span><br>DUPEFILTER_CLASS = <span class="hljs-string">&#x27;scrapy_redis.dupefilter.RFPDupeFilter&#x27;</span><br><span class="hljs-comment"># redis://user:pass@hostname:9001</span><br>REDIS_URL = <span class="hljs-string">&#x27;redis://@10.7.153.176:6379&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spider</category>
      
    </categories>
    
    
    <tags>
      
      <tag>scrapy</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MongoDB</title>
    <link href="/Myblog/2018/12/04/MongoDB/"/>
    <url>/Myblog/2018/12/04/MongoDB/</url>
    
    <content type="html"><![CDATA[<h4 id="MongoDB特点"><a href="#MongoDB特点" class="headerlink" title="MongoDB特点"></a>MongoDB特点</h4><p>MongoDB 是一个介于关系数据库和非关系数据库之间的产品,是非关系数据库当中功能最丰富,最像关系数据库的。 </p><p>MongoDB最大的特点：它支持的查询语言非常强大,其语法有点类似于面向对象的查询语言, 几乎可以实现类似关系数据库单表查询的绝大部分功能。它是一个面向集合的,模式自由的文档型数据库。</p><p>1、 面向集合(Collection-Orented) </p><p>意思是数据被分组存储在数据集中, 被称为一个集合(Collenction)。每个集合在数据库中 都有一个唯一的标识名,并且可以包含无限数目的文档。集合的概念类似关系型数据库(RDBMS)里面的表(table),不同的是它不需要定义任何模式(schema)。 </p><p>2、 模式自由(schema-free) </p><p>存储在 MongoDB 数据库中的文件,我们不需要知道它的任何结构定义。提了这 么多次”无模式”或”模式自由”,它到是个什么概念呢?例如,下面两个记录可以存在于同一个集合里面:</p><p> {“welcome” : “Beijing”}</p><p> {“age” : 28} </p><p>3、 文档型意思是我们存储的数据是键-值对的集合,键是字符串,值可以是数据类型集合里的任意类型, 包括数组和文档. 文件存储格式为 BSON(一种 JSON 的扩展) </p><h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><p>1 网站数据:MongoDB 非常适合实时的插入,更新与查询,并具备网站实时数据存储所需的复制及高度伸缩性 </p><p>2 缓存:由于性能很高,MongoDB 也适合作为信息基础设施的缓存层。在系统重启之后, 由 MongoDB 搭建的持久化缓存层可以避免下层的数据源过载 </p><p>3 大尺寸,低价值的数据:使用传统的关系型数据库存储一些数据时可能会比较昂贵,在此之前,很 多时候程序员往往会选择传统的文件进行存储 </p><p>4 高伸缩性的场景:MongoDB 非常适合由数十或数百台服务器组成的数据库。MongoDB的路线图中已经包对 MapReduce 引擎的内置支持 </p><p>5 用于对象及 JSON 数据的存储:MongoDB 的 BSON 数据格式非常适合文档化格式的存储及查询 </p><h4 id="MongoDB使用语句"><a href="#MongoDB使用语句" class="headerlink" title="MongoDB使用语句"></a>MongoDB使用语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs mongodb">查看<br>show dbs<br>show colletions; <br><br>数据库并没有添加，当我们在给数据库中的集合插一条文档的时候就会自动创建一条文档、一个集合、一个数据库。<br>use newdb    <br><br>插入数据<br>db.users.insert(&#123;&quot;name&quot;: &#39;carmack&#39;&#125;)  <br><br>查询数据<br>db.users.find()<br>db.users.findOne(&#123;&quot;uid&quot;:2&#125;)<br><br>删除数据<br>db.users.remove(&#123;&quot;uid&quot;:2&#125;)<br><br>清空集合<br>db.users.remove(&#123;&#125;)<br><br>删除集合<br>db.users.drop()<br><br>更新文档<br>第一个文档为查询的文档，第二个文档为修改为什么文档, 后面的文档会覆盖我们要修改文档的整个内容<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;uname&quot;:&quot;jon&quot;&#125;)<br><br>使用修改器$inc更新<br>对uid为2的用户增加100块钱工资<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$inc&quot;:&#123;&quot;salary&quot;:100&#125;&#125;)<br>减100<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$inc&quot;:&#123;&quot;salary&quot;:-100&#125;&#125;)<br><br>添加一个字段$set修改器<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$set&quot;:&#123;&quot;age&quot;:18&#125;&#125;)<br><br>删除一个字段$unset修改器<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$unset&quot;:&#123;&quot;age&quot;:true&#125;&#125;)<br><br>数组的更新<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$push&quot;:&#123;&quot;email&quot;:&quot;a&quot;&#125;&#125;)<br><br>$pushAll在元组中增加多个元素,但是他不检查元素是否存在<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$pushAll&quot;:&#123;&quot;email&quot;:[&quot;a&quot;, &quot;b&quot;,&quot;c&quot;,&quot;d&quot;]&#125;&#125;)<br><br>$addToSet 往数组中添加一个不重复的元素<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$addToSet&quot;:&#123;&quot;email&quot;:&quot;d&quot;&#125;&#125;)<br><br>添加多个不重复的元素，这时候就得需要⽤到$eache操作符了<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$addToSet&quot;:&#123;&quot;email&quot;:&#123;&quot;$each&quot;:[&quot;e&quot;,&quot;g&quot;,&quot;f&quot;,&quot;d&quot;]&#125;&#125;&#125;)<br><br>删除数组元素<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$pop&quot;:&#123;&quot;email&quot;:-1&#125;&#125;) #从左侧删除一个元素<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$pop&quot;:&#123;&quot;email&quot;:1&#125;&#125;)#从右侧删除一个元素<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$pull&quot;:&#123;&quot;email&quot;:&quot;b&quot;&#125;&#125;) #删除数组内的指定一个元素<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$pullAll&quot;:&#123;&quot;email&quot;:[&quot;b&quot;,&quot;c&quot;]&#125;&#125;) #删除数组内指定的多个元<br><br>数组元素的更新<br>通过数组.下标修改<br>db.users.update(&#123;&quot;uid&quot;:2&#125;,&#123;&quot;$set&quot;:&#123;&quot;email.0&quot;:&quot;tim.qq.com&quot;&#125;&#125;)<br><br>等于 &#x3D;<br>db.users.find(&#123;&quot;salary&quot;:3000&#125;).pretty()<br>小于 &lt;<br>db.users.find(&#123;&quot;salary&quot;:&#123;$lt:3000&#125;&#125;).pretty()<br>小于等于 &lt;&#x3D;<br>db.users.find(&#123;&quot;salary&quot;:&#123;$lte:3000&#125;&#125;).pretty()<br>大于 &gt;<br>db.users.find(&#123;&quot;salary&quot;:&#123;$gt:3000&#125;&#125;).pretty()<br>大于等于 &gt;&#x3D;<br>db.users.find(&#123;&quot;salary&quot;:&#123;$gte:3000&#125;&#125;).pretty()<br>不等于 !&#x3D;<br>db.users.find(&#123;&quot;salary&quot;:&#123;$ne:3000&#125;&#125;).pretty()<br><br>MongoDB 的 find() 方法可以传入多个键(key)，每个键(key)以逗号隔开，即常规 SQL 的 AND 条件<br>db.users.find(&#123;&quot;id&quot;:2, &quot;sex&quot;: &quot;M&quot;&#125;).pretty()<br><br>MongoDB OR 条件语句使⽤了关键字 $or,语法格式如下：<br>db.users.find(&#123;$or: [&#123;key1: value1&#125;, &#123;key2:value2&#125;] &#125;).pretty()<br></code></pre></td></tr></table></figure><h4 id="pymongo"><a href="#pymongo" class="headerlink" title="pymongo"></a>pymongo</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install pymongo<br></code></pre></td></tr></table></figure><p>要使用pymongo最先应该做的事就是先连上运行中的 mongod，创建一个连接到mongod到客户端，并连接到数据库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pymongo <span class="hljs-keyword">import</span> MongoClient<br><br>client = MongoClient()<br><span class="hljs-comment"># 或者 client = MongoClient(“mongodb://127.0.0.1:27019”) ，不写默认连接本机</span><br>db = client.db1   <span class="hljs-comment"># 数据库一</span><br><span class="hljs-comment"># client[&#x27;db1&#x27;]</span><br><br><span class="hljs-comment"># 连接到对应的数据集：</span><br>coll = db.dataset<br><span class="hljs-comment"># 或者 db[&#x27;dataset&#x27;]</span><br></code></pre></td></tr></table></figure><p><strong>数据库操作</strong></p><ul><li>插入数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">insert_one(document)<br>insert_many(documents, ordered=<span class="hljs-literal">True</span>)<br><br>result = db.restaurants.insert_one(&#123;<br> “address”: &#123;<br>     “street”: “<span class="hljs-number">2</span> Avenue”,<br>     “zipcode”: “<span class="hljs-number">10075</span>”,<br>     “building”: “<span class="hljs-number">1480</span>”,<br>     “coord”: [<span class="hljs-number">-73.9557413</span>, <span class="hljs-number">40.7720266</span>]<br> &#125;<br>&#125;)<br>result = db.test.insert_many([&#123;‘x’: i&#125; <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>)])<br></code></pre></td></tr></table></figure><ul><li>查询数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># find 查询出来的是一个列表集合。</span><br>cursor = db.restaurants.find()<br><span class="hljs-keyword">for</span> document <span class="hljs-keyword">in</span> cursor:<br>print(document) <span class="hljs-comment"># 打印每条数据    </span><br><span class="hljs-comment"># 查询字段在最上层</span><br>cursor = db.restaurants.find(&#123;“borough”: “Manhattan”&#125;)<br>cursor = db.restaurants.find(&#123;“cuisine”: “Italian”, “address.zipcode”: “<span class="hljs-number">10075</span>”&#125;)<br><span class="hljs-comment"># 查询字段在内层嵌套中  </span><br>cursor = db.restaurants.find(&#123;“address.zipcode”: “<span class="hljs-number">10075</span>”&#125;)<br>cursor = db.restaurants.find(&#123;“grades.score”: &#123;“$gt”: <span class="hljs-number">30</span>&#125;&#125;)<br><span class="hljs-comment"># 将查询数据排序</span><br>cursor = db.restaurants.find().sort(“borough”)<br>cursor = db.restaurants.find().sort([(“borough”, pymongo.ASCENDING)])  <span class="hljs-comment"># 升序</span><br>cursor = db.restaurants.find().sort([(“borough”, pymongo.DESCENDING)])  <span class="hljs-comment"># 降序</span><br></code></pre></td></tr></table></figure><ul><li>更新数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 更新文档的函数有三个(不能更新_id字段)</span><br><br>返回结果是个一：UpdateResult ，如果查找到多个匹配，则只更新第一个！<br>update_one(filter, update, upsert=<span class="hljs-literal">False</span>)<br>result = db.restaurants.update_one(<br>&#123;“name”: “Juni”&#125;,<br> &#123;<br>     “$set”: &#123;<span class="hljs-string">&quot;cuisine&quot;</span>: <span class="hljs-string">&quot;American (New)&quot;</span>&#125;,<br>     “$currentDate”: &#123;“lastModified”: <span class="hljs-literal">True</span>&#125;<br> &#125;<br>)<br><br><span class="hljs-comment"># 查找到多少匹配，就更新多少。</span><br>update_many(filter, update, upsert=<span class="hljs-literal">False</span>)<br>result = db.restaurants.update_many(<br>     &#123;“address.zipcode”: “<span class="hljs-number">10016</span>”, “cuisine”: “Other”&#125;,<br>     &#123;<br>         “$set”: &#123;“cuisine”: “Category To Be Determined”&#125;,<br>         “$currentDate”: &#123;“lastModified”: <span class="hljs-literal">True</span>&#125;<br>     &#125;<br>)<br><br>replace_one(filter, replacement, upsert=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><ul><li>删除数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">删除一个<br>result = db.test.delete_one(&#123;<span class="hljs-string">&#x27;x&#x27;</span>: <span class="hljs-number">1</span>&#125;)<br><br>删除多个<br>result = db.restaurants.delete_many(&#123;<span class="hljs-string">&quot;borough&quot;</span>: <span class="hljs-string">&quot;Manhattan&quot;</span>&#125;)<br><br>删除全部<br>result = db.restaurants.delete_many(&#123;&#125;)<br><br>删除整个集合，是drop_collection()的别名<br>db.restaurants.drop()<br></code></pre></td></tr></table></figure><h4 id="MongoEngine"><a href="#MongoEngine" class="headerlink" title="MongoEngine"></a>MongoEngine</h4><p>创建并操作模型，间接对mongodb进行操作</p><p>使用情况见 –&gt; <a href="https://stellae.gitee.io/myblog/2018/12/05/Scrapy/">传送门</a></p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mongoDB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>代理IP</title>
    <link href="/Myblog/2018/12/03/%E4%BB%A3%E7%90%86IP/"/>
    <url>/Myblog/2018/12/03/%E4%BB%A3%E7%90%86IP/</url>
    
    <content type="html"><![CDATA[<h4 id="设置代理IP"><a href="#设置代理IP" class="headerlink" title="设置代理IP"></a>设置代理IP</h4><p>同一IP单位时间访问次数过多，容易导致被封IP，需要借助代理伪装IP进行爬取 </p><p>urllib，requests，selenium都可以设置代理</p><ul><li>urllib设置代理</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib.error <span class="hljs-keyword">import</span> URLError<br><span class="hljs-keyword">from</span> urllib.request <span class="hljs-keyword">import</span> ProxyHandler, build_opener<br><br>proxy = <span class="hljs-string">&#x27;58.53.128.83:3128&#x27;</span><br>proxy_handler = ProxyHandler (&#123;<br><span class="hljs-string">&#x27;http&#x27;</span>: <span class="hljs-string">&#x27;http://&#x27;</span> + proxy, <br><span class="hljs-string">&#x27;https&#x27;</span>: <span class="hljs-string">&#x27;https://&#x27;</span> + proxy<br>&#125;)<br><br>opener = build_opener(proxy_handler)<br>opener.addheaders = [(<span class="hljs-string">&#x27;User-Agent&#x27;</span>, <span class="hljs-string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1.2 Safari/605.1.15&#x27;</span>), <br>(<span class="hljs-string">&#x27;Accept-Encoding&#x27;</span>, <span class="hljs-string">&#x27;gzip, deflate&#x27;</span>)]<br><br><span class="hljs-keyword">try</span>:<br>response = opener.open(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>)<br><br>print(response.read().decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><span class="hljs-keyword">except</span> URLError <span class="hljs-keyword">as</span> e:<br>print(e.reason)<br></code></pre></td></tr></table></figure><ul><li>requests设置代理</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>proxy = <span class="hljs-string">&#x27;58.53.128.83:3128&#x27;</span><br>proxies = &#123;<br><span class="hljs-string">&#x27;http&#x27;</span>: <span class="hljs-string">&#x27;http://&#x27;</span> + proxy, <br><span class="hljs-string">&#x27;https&#x27;</span>: <span class="hljs-string">&#x27;https://&#x27;</span> + proxy<br>&#125;<br>headers = &#123;<br><span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1.2 Safari/605.1.15&#x27;</span><br>&#125;<br><br><span class="hljs-keyword">try</span>:<br>response = requests.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>, headers=headers, proxies=proxies)<br>print(response.text)<br><span class="hljs-keyword">except</span> requests.exceptions.ConnectionError <span class="hljs-keyword">as</span> e:<br>print(<span class="hljs-string">&#x27;Error&#x27;</span>, e.args)<br></code></pre></td></tr></table></figure><ul><li>selenium设置代理</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver<br><br>proxy = <span class="hljs-string">&#x27;58.53.128.83:3128&#x27;</span><br>chrome_options = webdriver.ChromeOptions()<br>chrome_options.add_argument(<span class="hljs-string">&#x27;--proxy-server=http://&#x27;</span> + proxy)<br>browser = webdriver.Chrome(chrome_options=chrome_options)<br>browser.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="获取免费IP"><a href="#获取免费IP" class="headerlink" title="获取免费IP"></a>获取免费IP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time, trip<br><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<br><br><br><span class="hljs-meta">@trip.coroutine</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_proxies</span>(<span class="hljs-params">pages=<span class="hljs-number">3</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;获取代理&quot;&quot;&quot;</span><br>    ip_list = []<br>    headers = &#123;<span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36&#x27;</span>&#125;<br>    <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, pages):<br>        resp = <span class="hljs-keyword">yield</span> trip.get(<span class="hljs-string">&#x27;https://www.xicidaili.com/nn&#x27;</span> + <span class="hljs-string">&#x27;/&#x27;</span> + str(page), headers=headers)<br>        soup = BeautifulSoup(resp.text, <span class="hljs-string">&#x27;lxml&#x27;</span>)<br>        all = soup.find_all(<span class="hljs-string">&#x27;tr&#x27;</span>, class_=<span class="hljs-string">&quot;odd&quot;</span>)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> all:<br>            t = i.find_all(<span class="hljs-string">&#x27;td&#x27;</span>)<br>            ip = t[<span class="hljs-number">1</span>].text+<span class="hljs-string">&#x27;:&#x27;</span>+t[<span class="hljs-number">2</span>].text<br>            ip_list.append(ip)<br>    <span class="hljs-keyword">raise</span> trip.Return(ip_list)<br><br><br><span class="hljs-meta">@trip.coroutine</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_proxy</span>(<span class="hljs-params">proxy</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;检测代理是否可用&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        r = <span class="hljs-keyword">yield</span> trip.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>, timeout=<span class="hljs-number">5</span>,<br>                           proxies=&#123;<span class="hljs-string">&#x27;http&#x27;</span>: proxy, <span class="hljs-string">&#x27;https&#x27;</span>: proxy&#125;)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;httpbin.org&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> r.text:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Invalid reply&#x27;</span>)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> trip.Return(proxy)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    proxies = <span class="hljs-keyword">yield</span> get_proxies()<br>    r = <span class="hljs-keyword">yield</span> [test_proxy(p) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> proxies]<br>    <span class="hljs-comment"># 过滤可用ip</span><br>    proxies_ip = filter(<span class="hljs-keyword">lambda</span> x: x, r)<br>    proxies_ip_list = list(proxies_ip)<br>    print(<span class="hljs-string">&#x27;Available IP:&#x27;</span>, proxies_ip_list)<br>    <br><span class="hljs-comment"># 运行时间</span><br>start_time = time.time()<br>trip.run(main)<br>print(<span class="hljs-string">f&#x27;run:<span class="hljs-subst">&#123;time.time() - start_time&#125;</span>s&#x27;</span>)<br></code></pre></td></tr></table></figure><blockquote><p>说明：使用了协程框架trip爬取西刺代理提供免费ip，并且检测是否可用。</p></blockquote><h4 id="代理池"><a href="#代理池" class="headerlink" title="代理池"></a>代理池</h4><p>提前筛选，保留可用的代理放在代理池中备用</p><p>主要分为：存储模块、获取模块、检测模块、接口模块</p><ul><li>存储模块： 存储抓取下来的代理，不重复，使用redis sorted set有序集合 </li><li>获取模块： 定时抓取各代理网站代理 </li><li>检测模块： 检测代理是否有效并设置分数，检测链接设为目标网站链接 </li><li>接口模块： 可提供代理接口 </li></ul><p>设置爬取代理ip分数规则：</p><p> 分数100为可用，定时循环检测每个代理使用情况，一旦检测到可用代理设置为100， 不可用时分数减1，分数减为0后移除 新获取的代理分数为10， 如测试可用，分数设为100，不可用分数减1，分数减为0后代理移除 </p><h4 id="付费代理"><a href="#付费代理" class="headerlink" title="付费代理"></a>付费代理</h4><p> 可以选择蘑菇代理、询代理独享代理、阿里布代理经典版、快代理等。</p><p>付费后调用接口即可，程序爬虫时使用本身ip，如果被封了则切换代理ip。</p><p>例如下面代码，付费后调用接口组装即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_page</span>():</span><br>    <span class="hljs-comment"># 代理url接口</span><br>    url = <span class="hljs-string">&quot;http://piping.mogumiao.com/proxy/api/get_ip_bs?appKey=12eb2c94244342f7a28e67361d030a9b&amp;count=1&amp;expiryDate=0&amp;format=1&amp;newLine=2&quot;</span><br>    headers =  &#123;<br>        <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; 360SE)&quot;</span> <br>    &#125;<br>    response = requests.get(url, headers=headers)<br>    <span class="hljs-comment"># print(response.status_code)</span><br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> response.json()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_proxies</span>():</span><br>    ip_json = get_page()<br>    print(ip_json)<br>    <span class="hljs-comment"># &#123;&quot;code&quot;:&quot;0&quot;,&quot;msg&quot;:[&#123;&quot;port&quot;:&quot;35058&quot;,&quot;ip&quot;:&quot;36.99.213.209&quot;&#125;]&#125;</span><br>    ip = ip_json[<span class="hljs-string">&#x27;msg&#x27;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;ip&#x27;</span>]<br>    port = ip_json[<span class="hljs-string">&#x27;msg&#x27;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;port&#x27;</span>]<br>    proxy = ip + <span class="hljs-string">&#x27;:&#x27;</span> + port<br><br>    proxies = &#123;<br>        <span class="hljs-string">&#x27;http&#x27;</span>: <span class="hljs-string">&#x27;http://&#x27;</span> + proxy, <br>        <span class="hljs-string">&#x27;https&#x27;</span>: <span class="hljs-string">&#x27;https://&#x27;</span> + proxy <br>    &#125;<br>    <span class="hljs-keyword">return</span> proxies<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    print(get_proxies())<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spider</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>验证码识别</title>
    <link href="/Myblog/2018/11/30/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/"/>
    <url>/Myblog/2018/11/30/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h3 id="常见验证码类型"><a href="#常见验证码类型" class="headerlink" title="常见验证码类型"></a>常见验证码类型</h3><h4 id="一、图形验证码（字母数字类）"><a href="#一、图形验证码（字母数字类）" class="headerlink" title="一、图形验证码（字母数字类）"></a>一、图形验证码（字母数字类）</h4><p><strong>使用工具</strong></p><ul><li><p>tesseerocr</p><p>识别率很低，一般不使用。</p></li><li><p>识别验证码平台（打码平台）</p><p>例如超级鹰，付费后调用其提供的接口即可。</p></li></ul><p><strong>例子</strong>：<a href="https://login.10086.cn/html/register/register.html">中国移动</a></p><p>思路：截取浏览器屏幕，从截取图片中截取验证码图片，保存后调用接口解决。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> selenium.common.exceptions <span class="hljs-keyword">import</span> TimeoutException<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver<br><span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By<br><span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait<br><span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-keyword">from</span> chaojiying <span class="hljs-keyword">import</span> main1<br><br>chrome_options = webdriver.ChromeOptions()<br><span class="hljs-comment"># chrome_options.add_argument(&#x27;--headless&#x27;)</span><br>browser = webdriver.Chrome(chrome_options=chrome_options)<br>browser.set_window_size(<span class="hljs-number">1400</span>, <span class="hljs-number">700</span>)<br>wait = WebDriverWait(browser, <span class="hljs-number">10</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_page</span>():</span><br>    url = <span class="hljs-string">&#x27;https://login.10086.cn/html/register/register.html&#x27;</span><br>    browser.get(url)<br>    html = browser.page_source<br>    <span class="hljs-keyword">return</span> html<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_full_screen</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;截屏&quot;&quot;&quot;</span><br>    browser.execute_script(<span class="hljs-string">&#x27;window.scrollTo(0,130)&#x27;</span>)<br>    full_screen = browser.get_screenshot_as_png()<br>    full_screen = Image.open(BytesIO(full_screen))<br>    <span class="hljs-keyword">return</span>  full_screen<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_position</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;取到验证码图片的位置&quot;&quot;&quot;</span><br>    img = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;.yzm_main #captchaImg&#x27;</span>)))<br>    location = img.location<br>    size = img.size<br>    print(location)<br>    print(size)<br>    x1 = location[<span class="hljs-string">&#x27;x&#x27;</span>]<br>    y1 = location[<span class="hljs-string">&#x27;y&#x27;</span>] - <span class="hljs-number">130</span><br>    x2 = x1 + size[<span class="hljs-string">&#x27;width&#x27;</span>]<br>    y2 = y1 + size[<span class="hljs-string">&#x27;height&#x27;</span>]<br>    <span class="hljs-keyword">return</span> (x1, y1, x2, y2)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_page</span>(<span class="hljs-params">html</span>):</span><br>    full_screen = get_full_screen()<br>    full_screen.save(<span class="hljs-string">&#x27;full_screen.png&#x27;</span>)<br>    x1, y1, x2, y2 = get_position()<br>    crop_img = full_screen.crop((x1, y1, x2, y2))<br>    <span class="hljs-comment"># 保存验证码</span><br>    crop_img.save(<span class="hljs-string">&#x27;crop.png&#x27;</span>)<br>    <span class="hljs-comment"># 调用接口</span><br>    captha_str = main1(<span class="hljs-string">&#x27;crop.png&#x27;</span>)<br>    <span class="hljs-comment"># 填写信息，执行操作</span><br>    loginName = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;#loginName&#x27;</span>)))<br>    newPassword = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;#newPassword&#x27;</span>)))<br>    newPasswordRepeat = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;#newPasswordRepeat&#x27;</span>)))<br>    inputCode = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;#inputCode&#x27;</span>)))<br>    regText_bg_new = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;#regText_bg_new&#x27;</span>)))<br>    regText_bg_person = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;#regText_bg_person&#x27;</span>)))<br>    regSub = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;#regSub&#x27;</span>)))<br>    loginName.send_keys(<span class="hljs-string">&#x27;867109272@qq.com&#x27;</span>)<br>    newPassword.send_keys(<span class="hljs-string">&#x27;asd12345678&#x27;</span>)<br>    newPasswordRepeat.send_keys(<span class="hljs-string">&#x27;asd12345678&#x27;</span>)<br>    inputCode.send_keys(captha_str)<br>    regText_bg_new.click()<br>    regText_bg_person.click()<br>    regSub.click()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    html = get_page()<br>    parse_page(html)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()      <br></code></pre></td></tr></table></figure><p>chaojiying.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># coding:utf-8</span><br><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Chaojiying_Client</span>(<span class="hljs-params">object</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, username, password, soft_id</span>):</span><br>        self.username = username<br>        password =  password.encode(<span class="hljs-string">&#x27;utf8&#x27;</span>)<br>        self.password = md5(password).hexdigest()<br>        self.soft_id = soft_id<br>        self.base_params = &#123;<br>            <span class="hljs-string">&#x27;user&#x27;</span>: self.username,<br>            <span class="hljs-string">&#x27;pass2&#x27;</span>: self.password,<br>            <span class="hljs-string">&#x27;softid&#x27;</span>: self.soft_id,<br>        &#125;<br>        self.headers = &#123;<br>            <span class="hljs-string">&#x27;Connection&#x27;</span>: <span class="hljs-string">&#x27;Keep-Alive&#x27;</span>,<br>            <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0)&#x27;</span>,<br>        &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">PostPic</span>(<span class="hljs-params">self, im, codetype</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        im: 图片字节</span><br><span class="hljs-string">        codetype: 题目类型 参考 http://www.chaojiying.com/price.html</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        params = &#123;<br>            <span class="hljs-string">&#x27;codetype&#x27;</span>: codetype,<br>        &#125;<br>        params.update(self.base_params)<br>        files = &#123;<span class="hljs-string">&#x27;userfile&#x27;</span>: (<span class="hljs-string">&#x27;ccc.jpg&#x27;</span>, im)&#125;<br>        r = requests.post(<span class="hljs-string">&#x27;http://upload.chaojiying.net/Upload/Processing.php&#x27;</span>, data=params, files=files, headers=self.headers)<br>        <span class="hljs-keyword">return</span> r.json()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ReportError</span>(<span class="hljs-params">self, im_id</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        im_id:报错题目的图片ID</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        params = &#123;<br>            <span class="hljs-string">&#x27;id&#x27;</span>: im_id,<br>        &#125;<br>        params.update(self.base_params)<br>        r = requests.post(<span class="hljs-string">&#x27;http://upload.chaojiying.net/Upload/ReportError.php&#x27;</span>, data=params, headers=self.headers)<br>        <span class="hljs-keyword">return</span> r.json()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main1</span>(<span class="hljs-params">urlstr</span>):</span><br>    chaojiying = Chaojiying_Client(<span class="hljs-string">&#x27;carmack&#x27;</span>, <span class="hljs-string">&#x27;Vff635241&#x27;</span>, <span class="hljs-string">&#x27;96001&#x27;</span>) <br>    im = open(urlstr, <span class="hljs-string">&#x27;rb&#x27;</span>).read()                                                 <br>    <span class="hljs-keyword">return</span> chaojiying.PostPic(im, <span class="hljs-number">1006</span>)[<span class="hljs-string">&#x27;pic_str&#x27;</span>]<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>chaojiying = Chaojiying_Client(<span class="hljs-string">&#x27;carmack&#x27;</span>, <span class="hljs-string">&#x27;Vff635241&#x27;</span>, <span class="hljs-string">&#x27;96001&#x27;</span>)<br>im = open(<span class="hljs-string">&#x27;big.jpeg&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>print(chaojiying.PostPic(im, <span class="hljs-number">9104</span>))<br></code></pre></td></tr></table></figure><h4 id="二、滑动验证码（滑动类）"><a href="#二、滑动验证码（滑动类）" class="headerlink" title="二、滑动验证码（滑动类）"></a>二、滑动验证码（滑动类）</h4><p><strong>例子：</strong><a href="https://passport.bilibili.com/login">哔哩哔哩</a></p><p>思路：1、模拟点击验证按钮。2、识别滑动缺口位置， 遍历没有缺口和有缺口两张图片，找出相同位置像素差距超过指定值得像素点，即缺口位置。3、模拟拖动滑块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver<br><span class="hljs-keyword">from</span> selenium.webdriver <span class="hljs-keyword">import</span> ActionChains<br><span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By<br><span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait<br><span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC<br><br>EMAIL = <span class="hljs-string">&#x27;394220162@qq.com&#x27;</span><br>PASSWORD = <span class="hljs-string">&#x27;vff635241&#x27;</span><br>BORDER = <span class="hljs-number">6</span><br>INIT_LEFT = <span class="hljs-number">60</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CrackBilibili</span>():</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.url = <span class="hljs-string">&#x27;https://passport.bilibili.com/login&#x27;</span><br>        self.browser = webdriver.Chrome()<br>        self.wait = WebDriverWait(self.browser, <span class="hljs-number">20</span>)<br>        self.email = EMAIL<br>        self.password = PASSWORD<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><br>        self.browser.close()<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_geetest_button</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取初始验证按钮</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        button = self.wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="hljs-string">&#x27;.gt_slider_knob.gt_show&#x27;</span>)))<br>        <span class="hljs-keyword">return</span> button<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_position</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取验证码位置</span><br><span class="hljs-string">        :return: 验证码位置元组</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        img = self.wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;.gt_cut_fullbg.gt_show&#x27;</span>)))<br>        time.sleep(<span class="hljs-number">2</span>)<br>        location = img.location<br>        size = img.size<br>        top, bottom, left, right = location[<span class="hljs-string">&#x27;y&#x27;</span>], location[<span class="hljs-string">&#x27;y&#x27;</span>] + size[<span class="hljs-string">&#x27;height&#x27;</span>], location[<span class="hljs-string">&#x27;x&#x27;</span>], location[<span class="hljs-string">&#x27;x&#x27;</span>] + size[<br>            <span class="hljs-string">&#x27;width&#x27;</span>]<br>        <span class="hljs-keyword">return</span> (top, bottom, left, right)<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_screenshot</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取网页截图</span><br><span class="hljs-string">        :return: 截图对象</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        screenshot = self.browser.get_screenshot_as_png()<br>        screenshot = Image.open(BytesIO(screenshot))<br>        <span class="hljs-keyword">return</span> screenshot<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_slider</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取滑块</span><br><span class="hljs-string">        :return: 滑块对象</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        slider = self.wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="hljs-string">&#x27;.gt_slider_knob.gt_show&#x27;</span>)))<br>        <span class="hljs-keyword">return</span> slider<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_geetest_image</span>(<span class="hljs-params">self, name=<span class="hljs-string">&#x27;captcha.png&#x27;</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取验证码图片</span><br><span class="hljs-string">        :return: 图片对象</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        top, bottom, left, right = self.get_position()<br>        print(<span class="hljs-string">&#x27;验证码位置&#x27;</span>, top, bottom, left, right)<br>        screenshot = self.get_screenshot()<br>        captcha = screenshot.crop((left, top, right, bottom))<br>        captcha.save(name)<br>        <span class="hljs-keyword">return</span> captcha<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">open</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        打开网页输入用户名密码</span><br><span class="hljs-string">        :return: None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        self.browser.get(self.url)<br>        <span class="hljs-comment"># email = self.wait.until(EC.presence_of_element_located((By.ID, &#x27;email&#x27;)))</span><br>        <span class="hljs-comment"># password = self.wait.until(EC.presence_of_element_located((By.ID, &#x27;password&#x27;)))</span><br>        <span class="hljs-comment"># email.send_keys(self.email)</span><br>        <span class="hljs-comment"># password.send_keys(self.password)</span><br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_gap</span>(<span class="hljs-params">self, image1, image2</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取缺口偏移量</span><br><span class="hljs-string">        :param image1: 不带缺口图片</span><br><span class="hljs-string">        :param image2: 带缺口图片</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        left = <span class="hljs-number">60</span><br>        print(<span class="hljs-string">&#x27;******大小*****&#x27;</span>)<br>        print(image1.size)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(left, image1.size[<span class="hljs-number">0</span>]):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(image1.size[<span class="hljs-number">1</span>]):<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.is_pixel_equal(image1, image2, i, j):<br>                    left = i<br>                    <span class="hljs-keyword">return</span> left<br>        <span class="hljs-keyword">return</span> left<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_pixel_equal</span>(<span class="hljs-params">self, image1, image2, x, y</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断两个像素是否相同</span><br><span class="hljs-string">        :param image1: 图片1</span><br><span class="hljs-string">        :param image2: 图片2</span><br><span class="hljs-string">        :param x: 位置x</span><br><span class="hljs-string">        :param y: 位置y</span><br><span class="hljs-string">        :return: 像素是否相同</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 取两个图片的像素点</span><br>        pixel1 = image1.load()[x, y]<br>        pixel2 = image2.load()[x, y]<br>        threshold = <span class="hljs-number">60</span><br>        <span class="hljs-keyword">if</span> abs(pixel1[<span class="hljs-number">0</span>] - pixel2[<span class="hljs-number">0</span>]) &lt; threshold <span class="hljs-keyword">and</span> abs(pixel1[<span class="hljs-number">1</span>] - pixel2[<span class="hljs-number">1</span>]) &lt; threshold <span class="hljs-keyword">and</span> abs(<br>                pixel1[<span class="hljs-number">2</span>] - pixel2[<span class="hljs-number">2</span>]) &lt; threshold:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_track</span>(<span class="hljs-params">self, distance</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        根据偏移量获取移动轨迹</span><br><span class="hljs-string">        :param distance: 偏移量</span><br><span class="hljs-string">        :return: 移动轨迹</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 移动轨迹</span><br>        track = []<br>        <span class="hljs-comment"># 当前位移</span><br>        current = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># 减速阈值</span><br>        mid = distance * <span class="hljs-number">4</span> / <span class="hljs-number">5</span><br>        <span class="hljs-comment"># 计算间隔</span><br>        t = <span class="hljs-number">0.2</span><br>        <span class="hljs-comment"># 初速度</span><br>        v = <span class="hljs-number">0</span><br>        <br>        <span class="hljs-keyword">while</span> current &lt; distance:<br>            <span class="hljs-keyword">if</span> current &lt; mid:<br>                <span class="hljs-comment"># 加速度为正2</span><br>                a = <span class="hljs-number">2</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># 加速度为负3</span><br>                a = <span class="hljs-number">-3</span><br>            <span class="hljs-comment"># 初速度v0</span><br>            v0 = v<br>            <span class="hljs-comment"># 当前速度v = v0 + at</span><br>            v = v0 + a * t<br>            <span class="hljs-comment"># 移动距离x = v0t + 1/2 * a * t^2</span><br>            move = v0 * t + <span class="hljs-number">1</span> / <span class="hljs-number">2</span> * a * t * t<br>            <span class="hljs-comment"># 当前位移</span><br>            current += move<br>            <span class="hljs-comment"># 加入轨迹</span><br>            track.append(round(move))<br>        <span class="hljs-keyword">return</span> track<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">move_to_gap</span>(<span class="hljs-params">self, slider, track</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        拖动滑块到缺口处</span><br><span class="hljs-string">        :param slider: 滑块</span><br><span class="hljs-string">        :param track: 轨迹</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        ActionChains(self.browser).click_and_hold(slider).perform()<br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> track:<br>            ActionChains(self.browser).move_by_offset(xoffset=x, yoffset=<span class="hljs-number">0</span>).perform()<br>        time.sleep(<span class="hljs-number">0.5</span>)<br>        ActionChains(self.browser).release().perform()<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        登录</span><br><span class="hljs-string">        :return: None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        submit = self.wait.until(EC.element_to_be_clickable((By.CLASS_NAME, <span class="hljs-string">&#x27;login-btn&#x27;</span>)))<br>        submit.click()<br>        time.sleep(<span class="hljs-number">10</span>)<br>        print(<span class="hljs-string">&#x27;登录成功&#x27;</span>)<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">crack</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-comment"># 输入用户名密码</span><br>        self.open()<br>        <span class="hljs-comment"># 点击验证按钮</span><br>        button = self.get_geetest_button()<br>        print(button)<br>        time.sleep(<span class="hljs-number">3</span>)<br>        ActionChains(self.browser).move_to_element(button).perform()<br>        time.sleep(<span class="hljs-number">3</span>)<br>        <span class="hljs-comment"># # 获取验证码图片(没有缺口的图)</span><br>        image1 = self.get_geetest_image(<span class="hljs-string">&#x27;captcha1.png&#x27;</span>)<br>        <span class="hljs-comment"># 点按呼出缺口</span><br>        slider = self.get_slider()<br>        slider.click()<br>        time.sleep(<span class="hljs-number">4</span>)<br>        <span class="hljs-comment"># 获取带缺口的验证码图片</span><br>        image2 = self.get_geetest_image(<span class="hljs-string">&#x27;captcha2.png&#x27;</span>)<br>        <span class="hljs-comment"># 获取缺口位置</span><br>        gap = self.get_gap(image1, image2)<br>        print(<span class="hljs-string">&#x27;缺口位置&#x27;</span>, gap)<br>        <span class="hljs-comment"># 减去缺口位移</span><br>        gap -= BORDER<br>        <span class="hljs-comment"># 获取移动轨迹</span><br>        track = self.get_track(gap)<br>        print(<span class="hljs-string">&#x27;滑动轨迹&#x27;</span>, track)<br>        <span class="hljs-comment"># 拖动滑块</span><br>        self.move_to_gap(slider, track)<br>        <br>        <span class="hljs-comment"># 验证结点里面是否包含此文字</span><br>        success = self.wait.until(<br>            EC.text_to_be_present_in_element((By.CLASS_NAME, <span class="hljs-string">&#x27;gt_info_type&#x27;</span>), <span class="hljs-string">&#x27;验证通过:&#x27;</span>))<br>        print(success)<br>        <br>        <span class="hljs-comment"># # 失败后重试</span><br>        <span class="hljs-comment"># if not success:</span><br>        <span class="hljs-comment">#     self.crack()</span><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     self.login()</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    crack = CrackBilibili()<br>    crack.crack()<br><br></code></pre></td></tr></table></figure><h4 id="三、点击验证码（旋转图片类）"><a href="#三、点击验证码（旋转图片类）" class="headerlink" title="三、点击验证码（旋转图片类）"></a>三、点击验证码（旋转图片类）</h4><p><strong>例子</strong>：<a href="http://www.1kkk.com/vipindex/">极速漫画</a></p><p>思路：1、拿到验证图片，暴力获取一定数量的原图。2、发现原图别分成了很多小图，于是切割成小图进行存储。3、对小图片进行去重操作，并将结果旋转至正方向。4、模拟点击图片验证码，遍历本地图片库，进行对比即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;__author__ = 星辰&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC<br><span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By<br><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver<br><span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait<br><br><span class="hljs-keyword">from</span> compare_helper <span class="hljs-keyword">import</span> get_compare<br><br>chrome_options = webdriver.ChromeOptions()<br><span class="hljs-comment"># chrome_options.add_argument(&#x27;--headless&#x27;)</span><br>browser = webdriver.Chrome(chrome_options=chrome_options)<br>browser.set_window_size(<span class="hljs-number">1400</span>, <span class="hljs-number">700</span>)<br>wait = WebDriverWait(browser, <span class="hljs-number">10</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_page</span>(<span class="hljs-params">image_count</span>):</span><br>    url = <span class="hljs-string">&#x27;http://www.1kkk.com/image3.ashx?t=1543563331000&#x27;</span> + str(image_count)<br>    response = requests.get(url)<br>    <span class="hljs-keyword">return</span> response.content<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_big_image</span>(<span class="hljs-params">image_content, image_count</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;下载原版大图&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./big_pic/%d.png&#x27;</span>%image_count, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(image_content)<br>    print(<span class="hljs-string">&#x27;正在下载第 %d 张大图!&#x27;</span>%image_count)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">crop_small_image</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;切割成小图&quot;&quot;&quot;</span><br>    count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">300</span>):<br>        count += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./big_pic/%d.png&#x27;</span>%count, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                image = Image.open(BytesIO(f.read()))<br>                width, height = image.size<br>                width_new = width / <span class="hljs-number">4</span><br>                <span class="hljs-comment"># 切四张小图</span><br>                image.crop((<span class="hljs-number">0</span>,<span class="hljs-number">0</span>, width_new, width_new)).save(<span class="hljs-string">&#x27;./small_pic/%d-1.png&#x27;</span>%count)<br>                image.crop((width_new, <span class="hljs-number">0</span>, width_new*<span class="hljs-number">2</span>, width_new)).save(<span class="hljs-string">&#x27;./small_pic/%d-2.png&#x27;</span> % count)<br>                image.crop((width_new*<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, width_new*<span class="hljs-number">3</span>, width_new)).save(<span class="hljs-string">&#x27;./small_pic/%d-3.png&#x27;</span> % count)<br>                image.crop((width_new*<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, width_new*<span class="hljs-number">4</span>, width_new)).save(<span class="hljs-string">&#x27;./small_pic/%d-4.png&#x27;</span> % count)<br>        <span class="hljs-keyword">except</span> Exception:<br>            <span class="hljs-keyword">continue</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_big_image</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;下载足够多大图作为本地库&quot;&quot;&quot;</span><br>    image_count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">300</span>):<br>        image_count += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">try</span>:<br>            image_content = get_page(image_count)<br>            save_big_image(image_content, image_count)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e :<br>            print(<span class="hljs-string">&#x27;第%d张下载失败！&#x27;</span>%image_count)<br>            <span class="hljs-keyword">continue</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">del_repeat</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;将small_pic复制内容至small_pic_result，分别执行遍历和删除操作&quot;&quot;&quot;</span><br>    print(<span class="hljs-string">&#x27;开始去重&#x27;</span>)<br>    del_count = <span class="hljs-number">0</span><br>    list_image_name = os.listdir(<span class="hljs-string">&#x27;./small_pic&#x27;</span>)<br>    <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(len(list_image_name)):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 原图比较</span><br>            <span class="hljs-keyword">for</span> index_temp <span class="hljs-keyword">in</span> range(index+<span class="hljs-number">1</span>,len(list_image_name)):<br>                score = get_compare(<span class="hljs-string">&#x27;./small_pic/%s&#x27;</span>%list_image_name[index], <span class="hljs-string">&#x27;./small_pic/%s&#x27;</span>%list_image_name[index_temp])<br>                <span class="hljs-keyword">if</span> int(score) &gt;= <span class="hljs-number">85</span>:<br>                    os.remove(<span class="hljs-string">&#x27;./small_pic_result/%s&#x27;</span>%list_image_name[index_temp])<br>                    del_count += <span class="hljs-number">1</span><br>                    print(<span class="hljs-string">&#x27;删除%d张图片&#x27;</span>%del_count)<br><br>            <span class="hljs-comment"># 旋转三次，继续去重</span><br>            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>):<br>                img = Image.open(<span class="hljs-string">&#x27;./small_pic/%s&#x27;</span>%list_image_name[index])<br>                img_new = img.rotate(<span class="hljs-number">90</span>)<br>                img_new.save(<span class="hljs-string">&#x27;./small_pic/%s&#x27;</span>%list_image_name[index])<br>                <span class="hljs-keyword">for</span> index_temp <span class="hljs-keyword">in</span> range(index+<span class="hljs-number">1</span>,len(list_image_name)):<br>                    score = get_compare(<span class="hljs-string">&#x27;./small_pic/%s&#x27;</span>%list_image_name[index], <span class="hljs-string">&#x27;./small_pic/%s&#x27;</span>%list_image_name[index_temp])<br>                    <span class="hljs-keyword">if</span> int(score) &gt;= <span class="hljs-number">85</span>:<br>                        os.remove(<span class="hljs-string">&#x27;./small_pic_result/%s&#x27;</span>%list_image_name[index_temp])<br>                        del_count += <span class="hljs-number">1</span><br>                        print(<span class="hljs-string">&#x27;删除%d张图片&#x27;</span>%del_count)<br>        <span class="hljs-keyword">except</span> Exception:<br>            <span class="hljs-keyword">continue</span><br>    print(<span class="hljs-string">&#x27;本次去重%d张图片.&#x27;</span>%del_count)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_page</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;解析页面，实现验证&quot;&quot;&quot;</span><br>    url = <span class="hljs-string">&#x27;http://www.1kkk.com/vipindex/&#x27;</span><br>    browser.get(url)<br>    time.sleep(<span class="hljs-number">2</span>)<br>    avatar = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;.header-avatar&#x27;</span>)))<br>    avatar.click()<br>    time.sleep(<span class="hljs-number">2</span>)<br>    <span class="hljs-comment"># 用户名</span><br>    txt_name = wait.until(EC.presence_of_element_located((By.XPATH, <span class="hljs-string">&#x27;//div[@class=&quot;form-wrap&quot;]/p/input[@name=&quot;txt_name&quot;]&#x27;</span>)))<br>    <span class="hljs-comment"># 密码</span><br>    password = wait.until(EC.presence_of_element_located((By.XPATH, <span class="hljs-string">&#x27;//div[@class=&quot;form-wrap&quot;]/p/input[@name=&quot;txt_password&quot;]&#x27;</span>)))<br>    <span class="hljs-comment"># 登录</span><br>    btnLogin = wait.until(EC.presence_of_element_located((By.XPATH, <span class="hljs-string">&#x27;//p/button[@id=&quot;btnLogin&quot;]&#x27;</span>)))<br>    <span class="hljs-comment"># 获取验证图片对象列表</span><br>    rotate_backgrounds = wait.until(EC.presence_of_all_elements_located((By.XPATH, <span class="hljs-string">&#x27;//div[@class=&quot;form-wrap&quot;]/div/div[@class=&quot;rotate-background&quot;]&#x27;</span>)))<br>    <span class="hljs-comment"># 第一张图片验证码的坐标</span><br>    x1 = rotate_backgrounds[<span class="hljs-number">0</span>].location[<span class="hljs-string">&#x27;x&#x27;</span>]<br>    y1 = rotate_backgrounds[<span class="hljs-number">0</span>].location[<span class="hljs-string">&#x27;y&#x27;</span>]<br>    <span class="hljs-comment"># 每一张图片验证码的尺寸</span><br>    height = rotate_backgrounds[<span class="hljs-number">0</span>].size[<span class="hljs-string">&#x27;height&#x27;</span>]<br>    width = rotate_backgrounds[<span class="hljs-number">0</span>].size[<span class="hljs-string">&#x27;width&#x27;</span>]<br><br>    <span class="hljs-comment"># 保存页面大图</span><br>    big_image = browser.get_screenshot_as_png()<br>    big_image = Image.open(BytesIO(big_image))<br>    big_image.save(<span class="hljs-string">&#x27;./Verify_Image/big_image.png&#x27;</span>)<br>    <span class="hljs-comment"># 切割四个小图,每个小图中间间隙2像素</span><br>    big_image.crop((x1, y1, x1+width, y1+height)).save(<span class="hljs-string">&#x27;./Verify_Image/small_image_1.png&#x27;</span>)<br>    big_image.crop((x1+(width+<span class="hljs-number">2</span>), y1, x1 + width*<span class="hljs-number">2</span>+<span class="hljs-number">2</span>, y1 + height)).save(<span class="hljs-string">&#x27;./Verify_Image/small_image_2.png&#x27;</span>)<br>    big_image.crop((x1+(width+<span class="hljs-number">2</span>)*<span class="hljs-number">2</span>, y1, x1 + width*<span class="hljs-number">3</span>+<span class="hljs-number">4</span>, y1 + height)).save(<span class="hljs-string">&#x27;./Verify_Image/small_image_3.png&#x27;</span>)<br>    big_image.crop((x1+(width+<span class="hljs-number">2</span>)*<span class="hljs-number">3</span>, y1, x1 + width*<span class="hljs-number">4</span>+<span class="hljs-number">6</span>, y1 + height)).save(<span class="hljs-string">&#x27;./Verify_Image/small_image_4.png&#x27;</span>)<br><br>    <span class="hljs-comment"># 与本地库比较，得出需要点击次数</span><br>    click_times = rotate_and_click()<br>    print(<span class="hljs-string">&#x27;需要点击次数为：&#x27;</span>)<br>    print(click_times)<br><br>    <span class="hljs-comment"># 开始验证</span><br>    time.sleep(<span class="hljs-number">1</span>)<br>    print(<span class="hljs-string">&#x27;开始验证...&#x27;</span>)<br>    txt_name.send_keys(<span class="hljs-string">&#x27;867109273@qq.com&#x27;</span>)<br>    password.send_keys(<span class="hljs-string">&#x27;123456&#x27;</span>)<br>    <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(len(click_times)):<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(click_times[index]):<br>            rotate_backgrounds[index].click()<br>    btnLogin.click()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rotate_and_click</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;将验证码与本地库比较得出旋转次数&quot;&quot;&quot;</span><br>    print(<span class="hljs-string">&#x27;开始匹配需要点击次数，请稍安勿躁！&#x27;</span>)<br>    click_time = []   <span class="hljs-comment"># 记录每张图片点击次数</span><br>    image_list_name = os.listdir(<span class="hljs-string">&#x27;./Verify_Image&#x27;</span>)<br>    image_list_name_located = os.listdir(<span class="hljs-string">&#x27;./small_pic_result&#x27;</span>)<br>    <span class="hljs-keyword">for</span> image <span class="hljs-keyword">in</span> image_list_name:<br>        time = <span class="hljs-number">0</span><br>        flag = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">for</span> wtf <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>):<br>            <span class="hljs-keyword">if</span> wtf != <span class="hljs-number">0</span>:<br>                Image.open(<span class="hljs-string">&#x27;./Verify_Image/%s&#x27;</span> % image).rotate(<span class="hljs-number">-90</span>).save(<span class="hljs-string">&#x27;./Verify_Image/%s&#x27;</span> % image)<br>                time += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">for</span> image_temp <span class="hljs-keyword">in</span> image_list_name_located:<br>                score = get_compare(<span class="hljs-string">&#x27;./Verify_Image/%s&#x27;</span> % image, <span class="hljs-string">&#x27;./small_pic_result/%s&#x27;</span> % image_temp)<br>                <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">92</span>:<br>                    click_time.append(time)<br>                    flag = <span class="hljs-literal">True</span><br>                    <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> flag:<br>                <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span>  click_time<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-comment"># 下载原版大图</span><br>    <span class="hljs-comment"># get_big_image()</span><br>    <span class="hljs-comment"># 一个原版图切割成4个小图</span><br>    <span class="hljs-comment"># crop_small_image()</span><br>    <span class="hljs-comment"># 去重操作</span><br>    <span class="hljs-comment"># del_repeat()</span><br>    <span class="hljs-comment"># 自动识别图片验证码，解析页面</span><br>    parse_page()<br>    print(<span class="hljs-string">&#x27;自动验证成功！&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>文件compare_helper.py可以将两张图片传入进行算法对比，返回值越高，图片相似程度越高，满分100</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!C:/Python27</span><br><span class="hljs-comment">#coding=utf-8</span><br> <br><span class="hljs-comment"># from pytesser import *</span><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image,ImageEnhance,ImageFilter<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> fnmatch<br><span class="hljs-keyword">import</span> re,time<br> <br><span class="hljs-keyword">import</span> urllib, random<br> <br> <br><span class="hljs-comment">#import hashlib  </span><br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getGray</span>(<span class="hljs-params">image_file</span>):</span><br>   tmpls=[]<br>   <span class="hljs-keyword">for</span> h <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>,  image_file.size[<span class="hljs-number">1</span>]):<span class="hljs-comment">#h</span><br>      <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, image_file.size[<span class="hljs-number">0</span>]):<span class="hljs-comment">#w</span><br>         tmpls.append( image_file.getpixel((w,h))  )<br>          <br>   <span class="hljs-keyword">return</span> tmpls<br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getAvg</span>(<span class="hljs-params">ls</span>):</span><span class="hljs-comment">#获取平均灰度值</span><br>   <span class="hljs-keyword">return</span> sum(ls)/len(ls)<br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getMH</span>(<span class="hljs-params">a,b</span>):</span><span class="hljs-comment">#比较100个字符有几个字符相同</span><br>   dist = <span class="hljs-number">0</span>;<br>   <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>,len(a)):<br>      <span class="hljs-keyword">if</span> a[i]==b[i]:<br>         dist=dist+<span class="hljs-number">1</span><br>   <span class="hljs-keyword">return</span> dist<br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getImgHash</span>(<span class="hljs-params">fne</span>):</span><br>   image_file = Image.open(fne) <span class="hljs-comment"># 打开</span><br>   image_file=image_file.resize((<span class="hljs-number">12</span>, <span class="hljs-number">12</span>))<span class="hljs-comment">#重置图片大小我12px X 12px</span><br>   image_file=image_file.convert(<span class="hljs-string">&quot;L&quot;</span>)<span class="hljs-comment">#转256灰度图</span><br>   Grayls=getGray(image_file)<span class="hljs-comment">#灰度集合</span><br>   avg=getAvg(Grayls)<span class="hljs-comment">#灰度平均值</span><br>   bitls=<span class="hljs-string">&#x27;&#x27;</span><span class="hljs-comment">#接收获取0或1</span><br>   <span class="hljs-comment">#除去变宽1px遍历像素</span><br>   <span class="hljs-keyword">for</span> h <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,  image_file.size[<span class="hljs-number">1</span>]<span class="hljs-number">-1</span>):<span class="hljs-comment">#h</span><br>      <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, image_file.size[<span class="hljs-number">0</span>]<span class="hljs-number">-1</span>):<span class="hljs-comment">#w</span><br>         <span class="hljs-keyword">if</span> image_file.getpixel((w,h))&gt;=avg:<span class="hljs-comment">#像素的值比较平均值 大于记为1 小于记为0</span><br>            bitls=bitls+<span class="hljs-string">&#x27;1&#x27;</span><br>         <span class="hljs-keyword">else</span>:<br>            bitls=bitls+<span class="hljs-string">&#x27;0&#x27;</span><br>   <span class="hljs-keyword">return</span> bitls<br><span class="hljs-string">&#x27;&#x27;&#x27;         </span><br><span class="hljs-string">   m2 = hashlib.md5()   </span><br><span class="hljs-string">   m2.update(bitls)</span><br><span class="hljs-string">   print m2.hexdigest(),bitls</span><br><span class="hljs-string">   return m2.hexdigest()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_compare</span>(<span class="hljs-params">filename1, filename2</span>):</span><br>   a=getImgHash(filename1)<span class="hljs-comment">#图片地址自行替换</span><br>   b=getImgHash(filename2)<br>   compare=getMH(a,b)<br>   <span class="hljs-keyword">return</span> compare<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>   filename1 = <span class="hljs-string">&#x27;./small_pic/30-1.png&#x27;</span><br>   filename2 = <span class="hljs-string">&#x27;./small_pic/32-2.png&#x27;</span><br>   compare = get_compare(filename1, filename2)<br>   print(compare)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spider</category>
      
    </categories>
    
    
    <tags>
      
      <tag>验证码</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Selenium爬取动态渲染页面</title>
    <link href="/Myblog/2018/11/29/Selenium%E7%88%AC%E5%8F%96%E5%8A%A8%E6%80%81%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2/"/>
    <url>/Myblog/2018/11/29/Selenium%E7%88%AC%E5%8F%96%E5%8A%A8%E6%80%81%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2/</url>
    
    <content type="html"><![CDATA[<p><strong>模拟浏览器操作爬取页面</strong></p><h4 id="安装Selenium"><a href="#安装Selenium" class="headerlink" title="安装Selenium"></a>安装Selenium</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> selenium<br></code></pre></td></tr></table></figure><h4 id="安装ChromeDriver"><a href="#安装ChromeDriver" class="headerlink" title="安装ChromeDriver"></a>安装ChromeDriver</h4><p>查看浏览器版本，在<a href="https://npm.taobao.org/mirrors/chromedriver">传送门</a>中下载对应的驱动，配置环境变量后使用</p><p>执行命令，查看是否成功：</p><p>成功后，会自动打开浏览器。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver<br>chrome_options = webdriver.ChromeOptions()<br>brower = webdriver.Chrome(chrome_options=chrome_options)<br></code></pre></td></tr></table></figure><p>无头浏览器，不会打开浏览器。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 无头浏览器</span><br>chrome_options = webdriver.ChromeOptions()<br>chrome_options.add_argument(<span class="hljs-string">&#x27;--headless&#x27;</span>)<br>brower = webdriver.Chrome(chrome_options=chrome_options)<br></code></pre></td></tr></table></figure><h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><p>不同浏览器加载驱动方式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用chrome浏览器</span><br>browser = webdriver.Chrome()<br><span class="hljs-comment"># 使用Firefox浏览器</span><br>browser = webdriver.Firefox()<br><span class="hljs-comment"># 使用Edge浏览器</span><br>browser = webdriver.Edge()<br><span class="hljs-comment"># 使用Phantom浏览器</span><br>browser = webdriver.PhatomJS()<br><span class="hljs-comment"># 使用Safari浏览器</span><br>browser = webdriver.Safari()<br></code></pre></td></tr></table></figure><p><strong>基本用法</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 访问页面</span><br>browser.get(<span class="hljs-string">&#x27;https://www.mkv99.com/vod-detail-id-9462.html&#x27;</span>)<br><span class="hljs-comment"># 获取渲染后的页面内容</span><br>print(browser.page_source)<br><span class="hljs-comment"># 获取当前网址</span><br>print(browser.current_url)<br><span class="hljs-comment"># 获取浏览器cookie</span><br>print(browser.get_cookies())<br><br><span class="hljs-comment"># 根据id获取单个节点</span><br>input1 = browser.find_element_by_id(<span class="hljs-string">&#x27;key&#x27;</span>)<br><span class="hljs-comment"># 获取节点属性</span><br>print(input1.get_attribute(<span class="hljs-string">&#x27;id&#x27;</span>))<br><br><span class="hljs-comment"># 用css选择器获取单个节点</span><br>input2 = browser.find_element_by_css_selector(<span class="hljs-string">&#x27;.dwon2&#x27;</span>)<br><span class="hljs-comment"># 获取节点的坐标</span><br>print(input2.location)<br><span class="hljs-comment"># 获取节点的宽高</span><br>print(input2.size)<br><br><span class="hljs-comment"># 用xpath方法获取单个节点</span><br>input3 = browser.find_element_by_xpath(<span class="hljs-string">&#x27;//*[@id=&quot;key&quot;]&#x27;</span>)<br>print(input3.id)<br><br><span class="hljs-comment"># 根据name获取单个节点</span><br>input4 = browser.find_element_by_name(<span class="hljs-string">&#x27;file&#x27;</span>)<br><span class="hljs-comment"># print(input4.tag_name)</span><br><br><span class="hljs-comment"># 根据链接文字获取单个节点</span><br>input5 = browser.find_element_by_link_text(<span class="hljs-string">&#x27;京东生鲜&#x27;</span>)  <span class="hljs-comment"># 名称对应</span><br>input6 = browser.find_element_by_partial_link_text(<span class="hljs-string">&#x27;生鲜&#x27;</span>)  <span class="hljs-comment"># 包含关键字即可</span><br><span class="hljs-comment"># # 获取节点文本值</span><br>print(input5.text)<br>print(input6.text)<br></code></pre></td></tr></table></figure><p><strong>selenium.webdriver.common.by.By</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By<br><br><span class="hljs-comment"># 选择不同的解析方式</span><br>CLASS_NAME = <span class="hljs-string">&#x27;class name&#x27;</span><br>CSS_SELECTOR = <span class="hljs-string">&#x27;css selector&#x27;</span><br>ID = <span class="hljs-string">&#x27;id&#x27;</span><br>LINK_TEXT = <span class="hljs-string">&#x27;link text&#x27;</span><br>NAME = <span class="hljs-string">&#x27;name&#x27;</span><br>PARTIAL_LINK_TEXT = <span class="hljs-string">&#x27;partial link text&#x27;</span><br>TAG_NAME = <span class="hljs-string">&#x27;tag name&#x27;</span><br>XPATH = <span class="hljs-string">&#x27;xpath&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>动作链</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> selenium.webdriver <span class="hljs-keyword">import</span> ActionChains<br><br>*ActionChains方法 *<br>click(on_element=<span class="hljs-literal">None</span>) ——单击鼠标左键<br>click_and_hold(on_element=<span class="hljs-literal">None</span>) ——点击鼠标左键，不松开<br>context_click(on_element=<span class="hljs-literal">None</span>) ——点击鼠标右键<br>double_click(on_element=<span class="hljs-literal">None</span>) ——双击鼠标左键<br>drag_and_drop(source, target) ——拖拽到某个元素然后松开<br>drag_and_drop_by_offset(source, xoffset, yoffset) ——拖拽到某个坐标然后松开<br>key_down(value, element=<span class="hljs-literal">None</span>) ——按下某个键盘上的键<br>key_up(value, element=<span class="hljs-literal">None</span>) ——松开某个键<br>move_by_offset(xoffset, yoffset) ——鼠标从当前位置移动到某个坐标<br>move_to_element(to_element) ——鼠标移动到某个元素<br>move_to_element_with_offset(to_element, xoffset, yoffset) ——移动到距某个元素（左上角坐<br>标）多少距离的位置<br>perform() ——执行链中的所有动作<br>release(on_element=<span class="hljs-literal">None</span>) ——在某个元素位置松开鼠标左键<br>send_keys(*keys_to_send) ——发送某个键到当前焦点的元素<br>send_keys_to_element(element, *keys_to_send) ——发送某个键到指定元素<br></code></pre></td></tr></table></figure><p>动作链例子：模拟拖动物体到特定位置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f2</span>(<span class="hljs-params">browser</span>):</span><br>browser.get(<span class="hljs-string">&#x27;http://www.runoob.com/try/try.php?filename=jqueryui-api-droppable&#x27;</span>)<br><span class="hljs-comment"># 切换到指定iframe</span><br>browser.switch_to.frame(<span class="hljs-string">&#x27;iframeResult&#x27;</span>)<br>source = browser.find_element_by_css_selector(<span class="hljs-string">&#x27;#draggable&#x27;</span>)<br>target = browser.find_element_by_css_selector(<span class="hljs-string">&#x27;#droppable&#x27;</span>)<br><span class="hljs-comment"># 动作链</span><br>actions = ActionChains(browser)<br><span class="hljs-comment"># 将选定的源移动到目标的位置</span><br>actions.drag_and_drop(source, target)<br><span class="hljs-comment"># 执行</span><br>actions.perform()<br>    browser.close()<br></code></pre></td></tr></table></figure><h4 id="完整实例"><a href="#完整实例" class="headerlink" title="完整实例"></a>完整实例</h4><p>爬取京东网页数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;__author__ = 星辰&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver<br><span class="hljs-keyword">from</span> selenium.common.exceptions <span class="hljs-keyword">import</span> TimeoutException<br><span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By<br><span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait<br><span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> pymysql<br><br>chrome_options = webdriver.ChromeOptions()<br><span class="hljs-comment"># 加载驱动</span><br>browser = webdriver.Chrome(chrome_options=chrome_options)<br><br><span class="hljs-comment"># 设置浏览器尺寸</span><br>browser.set_window_size(<span class="hljs-number">1400</span>, <span class="hljs-number">700</span>)<br><span class="hljs-comment"># 显式等待 针对某个节点的等待</span><br>wait = WebDriverWait(browser, <span class="hljs-number">5</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_page</span>(<span class="hljs-params">page</span>):</span><br>    <span class="hljs-keyword">if</span> page == <span class="hljs-number">1</span>:<br>        url = <span class="hljs-string">&#x27;https://www.jd.com&#x27;</span><br>        browser.get(url)<br><br>        <span class="hljs-comment"># 输入跳转</span><br>        input = wait.until(<br>            EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;#key&#x27;</span>)))<br>        input.clear()<br>        input.send_keys(<span class="hljs-string">&#x27;毛衣&#x27;</span>)<br>        print(browser.current_url)<br><br>        <span class="hljs-comment"># 点击</span><br>        submit = wait.until(<br>            EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="hljs-string">&#x27;#search button.button&#x27;</span>)))<br>        submit.click()<br>        time.sleep(<span class="hljs-number">2</span>)<br>        print(browser.current_url)<br><br>    <span class="hljs-keyword">if</span> page &gt; <span class="hljs-number">1</span>:<br>        input = wait.until(<br>            EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;.page.clearfix .input-txt&#x27;</span>)))<br>        input.clear()<br>        input.send_keys(page)<br><br>        submit = wait.until(<br>            EC.presence_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">&#x27;.page.clearfix .btn.btn-default&#x27;</span>))<br>        )<br>        submit.click()<br>        time.sleep(<span class="hljs-number">1</span>)<br>        print(browser.current_url)<br><br>    <span class="hljs-comment"># 滑动滚动条，将页面最大高度分成16份，每次滑动一步。</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):<br>        str_js = <span class="hljs-string">&#x27;var step = document.body.scrollHeight / 16; window.scrollTo(0, step * %d)&#x27;</span> % (i + <span class="hljs-number">1</span>)<br>        browser.execute_script(str_js)<br>        time.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> browser.page_source<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_page</span>(<span class="hljs-params">page_source</span>):</span><br>    <span class="hljs-comment"># 通过xpath解析</span><br>    html = etree.HTML(page_source)<br>    result_page = []<br>    gl_items = html.xpath(<span class="hljs-string">&#x27;//li[@class=&quot;gl-item&quot;]&#x27;</span>)<br>    <span class="hljs-keyword">for</span> gl_item <span class="hljs-keyword">in</span> gl_items:<br>        <span class="hljs-keyword">try</span>:<br>            result = &#123;&#125;<br>            img_src = <span class="hljs-string">&#x27;https:&#x27;</span> + gl_item.xpath(<span class="hljs-string">&#x27;.//div[@class=&quot;p-img&quot;]/a/img/@src&#x27;</span>)[<span class="hljs-number">0</span>]<br>            price = gl_item.xpath(<span class="hljs-string">&#x27;.//div[@class=&quot;p-price&quot;]/strong/i/text()&#x27;</span>)[<span class="hljs-number">0</span>]<br>            title = <span class="hljs-string">&#x27;&#x27;</span>.join(gl_item.xpath(<span class="hljs-string">&#x27;./div[@class=&quot;gl-i-wrap&quot;]/div[@class=&quot;p-name p-name-type-2&quot;]/a/em/text()&#x27;</span>))<br>            title_link = gl_item.xpath(<span class="hljs-string">&#x27;./div[@class=&quot;gl-i-wrap&quot;]/div[@class=&quot;p-name p-name-type-2&quot;]/a/@href&#x27;</span>)[<span class="hljs-number">0</span>]<br>            data_sku = gl_item.xpath(<span class="hljs-string">&#x27;./@data-sku&#x27;</span>)[<span class="hljs-number">0</span>]<br>            shop = gl_item.xpath(<span class="hljs-string">&#x27;.//div[@class=&quot;p-shop&quot;]/span/a/text()&#x27;</span>)[<span class="hljs-number">0</span>]<br>            shop_link = <span class="hljs-string">&#x27;https:&#x27;</span> + gl_item.xpath(<span class="hljs-string">&#x27;.//div[@class=&quot;p-shop&quot;]/span/a/@href&#x27;</span>)[<span class="hljs-number">0</span>]<br>            result[<span class="hljs-string">&#x27;img_src&#x27;</span>] = img_src<br>            result[<span class="hljs-string">&#x27;price&#x27;</span>] = price<br>            result[<span class="hljs-string">&#x27;title&#x27;</span>] = title<br>            result[<span class="hljs-string">&#x27;title_link&#x27;</span>] = title_link<br>            result[<span class="hljs-string">&#x27;data_sku&#x27;</span>] = data_sku<br>            result[<span class="hljs-string">&#x27;shop&#x27;</span>] = shop<br>            result[<span class="hljs-string">&#x27;shop_link&#x27;</span>] = shop_link<br>            result_page.append(result)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">return</span> result_page<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_all_page</span>():</span><br>    list_result_all = []<br>    <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">51</span>):<br>        print(<span class="hljs-string">&#x27;当前在%d页&#x27;</span>%page)<br>        html = get_page(page)<br>        result_page = parse_page(html)<br>        print(result_page)<br>        list_result_all.extend(result_page)<br>        print(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">40</span>)<br>    print(<span class="hljs-string">&#x27;爬取结果：&#x27;</span>,end=<span class="hljs-string">&#x27;&#x27;</span>)<br>    print(list_result_all)<br>    print(<span class="hljs-string">&#x27;总共%d条数据&#x27;</span>%(len(list_result_all)))<br>    <span class="hljs-keyword">return</span> list_result_all<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_json</span>(<span class="hljs-params">list_result_all</span>):</span><br>    json_text = json.dumps(list_result_all, ensure_ascii=<span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./jd.json&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(json_text)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_mysql</span>():</span><br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./jd.json&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        data = f.read()<br>    data = json.loads(data)<br>    conn = pymysql.connect(host=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, port=<span class="hljs-number">3306</span>, user=<span class="hljs-string">&#x27;root&#x27;</span>, password=<span class="hljs-string">&#x27;123456&#x27;</span>, db=<span class="hljs-string">&#x27;lhj&#x27;</span>)<br>    cursor = conn.cursor()<br>    <span class="hljs-keyword">for</span> info <span class="hljs-keyword">in</span> data:<br>        img_src = info[<span class="hljs-string">&#x27;img_src&#x27;</span>]<br>        price = info[<span class="hljs-string">&#x27;price&#x27;</span>]<br>        title = info[<span class="hljs-string">&#x27;title&#x27;</span>]<br>        title_link = info[<span class="hljs-string">&#x27;title_link&#x27;</span>]<br>        data_sku = info[<span class="hljs-string">&#x27;data_sku&#x27;</span>]<br>        shop = info[<span class="hljs-string">&#x27;shop&#x27;</span>]<br>        shop_link = info[<span class="hljs-string">&#x27;shop_link&#x27;</span>]<br>        sql = <span class="hljs-string">&#x27;insert into jd (img_src, price, title, title_link, data_sku, shop, shop_link) values (&quot;%s&quot;,&quot;%s&quot;,&quot;%s&quot;,&quot;%s&quot;,&quot;%s&quot;,&quot;%s&quot;,&quot;%s&quot;)&#x27;</span> % (img_src, price, title, title_link, data_sku, shop, shop_link) <br>        cursor.execute(sql)<br>    conn.commit()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    print(<span class="hljs-string">&#x27;开始爬取&#x27;</span>)<br>    list_result_all = parse_all_page()<br>    print(<span class="hljs-string">&#x27;存为json数据&#x27;</span>)<br>    save_json(list_result_all)<br>    print(<span class="hljs-string">&#x27;存到数据库&#x27;</span>)<br>    save_mysql()<br>    print(<span class="hljs-string">&#x27;爬取结束&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spider</category>
      
    </categories>
    
    
    <tags>
      
      <tag>爬虫</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>爬虫基础</title>
    <link href="/Myblog/2018/11/26/%E7%88%AC%E8%99%AB%E5%9F%BA%E7%A1%80/"/>
    <url>/Myblog/2018/11/26/%E7%88%AC%E8%99%AB%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><p>爬虫就是获取网页并提取和保存信息的自动化程序</p><h4 id="HTTP基本原理"><a href="#HTTP基本原理" class="headerlink" title="HTTP基本原理"></a>HTTP基本原理</h4><h5 id="URI和URL"><a href="#URI和URL" class="headerlink" title="URI和URL"></a>URI和URL</h5><p>URI (Uniform Resource Identifier) 统一资源标志符</p><p>URL(Universal Resource Locator) 统一资源定位符 </p><h5 id="HTTP和HTTPS"><a href="#HTTP和HTTPS" class="headerlink" title="HTTP和HTTPS"></a>HTTP和HTTPS</h5><p>HTTP (Hyper Text Transfer Protocol)  超文本传输协议</p><p>HTTPS (Hyper Text Transfer Protocol over Secure Socket Layer) HTTP加入SSL层，传输内容通过SSL加密 </p><ul><li>安全通道保证数据传输安全 </li><li>确认网站真实性 </li></ul><h5 id="HTTP请求过程"><a href="#HTTP请求过程" class="headerlink" title="HTTP请求过程"></a>HTTP请求过程</h5><p>用浏览器开发者工具观察网络请求过程 </p><p><strong>请求头</strong></p><p>一个典型的适于于爬取数据的伪造请求头如下所示：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">“Proxy-Connection”: “keep-alive”, <br>“Pragma”: “no-cache”, <br>“Cache-Control”: “no-cache”, <br>“User-Agent”: “Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">6.3</span>; WOW64) AppleWebKit/<span class="hljs-number">537.36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">52.0</span><span class="hljs-number">.2743</span><span class="hljs-number">.116</span> Safari/<span class="hljs-number">537.36</span>”, <br>“Accept”: “texthtml,applicationxhtml+xml,applicationxml;q=<span class="hljs-number">0.9</span>,imagewebp,/;q=<span class="hljs-number">0.8</span>”, <br>“DNT”: “<span class="hljs-number">1</span>”, <br>“Accept-Encoding”: “gzip, deflate, sdch”, <br>“Accept-Language”: “zh-CN,zh;q=<span class="hljs-number">0.8</span>,en-US;q=<span class="hljs-number">0.6</span>,en;q=<span class="hljs-number">0.4</span>”, <br>“Referer”: “https:<span class="hljs-comment">//www.baidu.com/s? </span><br>wd=%BC%<span class="hljs-number">96</span>%E7%A0%<span class="hljs-number">81</span>&amp;rsv_spt=<span class="hljs-number">1</span>&amp;rsv_iqid=<span class="hljs-number">0x9fcbc99a0000b5d7</span>&amp;issp=<span class="hljs-number">1</span>&amp;f=<span class="hljs-number">8</span>&amp;rsv_ bp=<span class="hljs-number">1</span>&amp;rsv_idx=<span class="hljs-number">2</span>&amp;ie=utf<span class="hljs-number">-8</span>&amp;rqlang=cn&amp;tn=baiduhome_pg&amp;rsv_enter=<span class="hljs-number">0</span>&amp;oq=If-None- Match&amp;inputT=<span class="hljs-number">7282</span>&amp;rsv_t=<span class="hljs-number">3001</span>MlX2aUzape9perXDW%<span class="hljs-number">2</span>FezcxiDTWU4Bt%<span class="hljs-number">2</span>FciwbikdOLQHYY98rhPyD2LDNevDKyLLg2&amp;rsv_pq=c4163a510000b68a&amp;rsv_sug3=<span class="hljs-number">24</span>&amp;rsv_sug1=<span class="hljs-number">14</span> &amp;rsv_sug7=<span class="hljs-number">100</span>&amp;rsv_sug2=<span class="hljs-number">0</span>&amp;rsv_sug4=<span class="hljs-number">7283</span>”, <br>“Accept-Charset”: “gb2312,gbk;q=<span class="hljs-number">0.7</span>,utf<span class="hljs-number">-8</span>;q=<span class="hljs-number">0.7</span>,*;q=<span class="hljs-number">0.7</span>”,<br></code></pre></td></tr></table></figure><p><strong>请求体</strong></p><p>POST请求体有内容，GET请求，请求体为空 </p><p>设置Request Header Content-Type </p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">application/x-www-form-urlencoded 表单数据 <br>multipart/form-data 表单文件上传 <br>application/<span class="hljs-type">json</span> 序列化<span class="hljs-type">json</span>数据 <br><span class="hljs-type">text</span>/<span class="hljs-type">xml</span> <span class="hljs-type">xml</span>数据 <br></code></pre></td></tr></table></figure><h4 id="urllib库"><a href="#urllib库" class="headerlink" title="urllib库"></a>urllib库</h4><p>urllib是基于http的高层库，它有以下四个主要功能：</p><ol><li>request处理客户端的请求 </li><li>response处理服务端的响应 </li><li>parse会解析url </li><li>主要用来识别网站的robots.txt文件，用得较少 </li></ol><p>获取响应信息</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取网页内容</span><br><span class="hljs-keyword">import</span> urllib.request<br>response = urllib.request.urlopen(<span class="hljs-string">&#x27;http://www.baidu.com/&#x27;</span>)<br>html = response.read().decode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>print(html)<br><span class="hljs-comment"># 取响应状态码和头信息</span><br>print(response.status)<br>print(response.getheaders())<br>print(response.getheader(<span class="hljs-string">&quot;Server&quot;</span>))<br></code></pre></td></tr></table></figure><p>设置超时时间</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.request<br>response = urllib.request.urlopen(<span class="hljs-string">&quot;http://2018.sina.com.cn/&quot;</span>, timeout=<span class="hljs-number">1</span>)<br>html = response.read().decode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>print(html)<br></code></pre></td></tr></table></figure><p>设置请求头和参数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib <span class="hljs-keyword">import</span> request, parse<br>url = <span class="hljs-string">&quot;http://2018.sina.com.cn/&quot;</span><br>headers = &#123;<br> <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; 360SE)&quot;</span>,<br> <span class="hljs-string">&quot;Host&quot;</span>: <span class="hljs-string">&quot;2018.sina.com.cn&quot;</span>,<br>&#125;<br>dict = &#123;<br> <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Question&quot;</span><br>&#125;<br>data = bytes(parse.urlencode(dict), encoding=<span class="hljs-string">&quot;utf8&quot;</span>)<br>req = request.Request(url=url, data=data, headers=headers, method=<span class="hljs-string">&quot;GET&quot;</span>)<br>response = request.urlopen(req)<br>print(response.read().decode(<span class="hljs-string">&quot;utf-8&quot;</span>))<br></code></pre></td></tr></table></figure><p>异常处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib <span class="hljs-keyword">import</span> request, error<br><span class="hljs-keyword">try</span>:<br> response = request.urlopen(<span class="hljs-string">&quot;https://cuiqingcai.com/index.htm&quot;</span>)<br><span class="hljs-keyword">except</span> error.URLError <span class="hljs-keyword">as</span> e:<br> print(e.reason)<br></code></pre></td></tr></table></figure><h4 id="Requests库"><a href="#Requests库" class="headerlink" title="Requests库"></a>Requests库</h4><p>pip install requests</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>r = requests.get(<span class="hljs-string">&quot;http://www.baidu.com&quot;</span>)<br>print(r.status_code) <span class="hljs-comment"># 状态码</span><br>print(r.text) <span class="hljs-comment"># 内容</span><br>print(r.content) <span class="hljs-comment"># 内容</span><br>print(r.cookies) <br></code></pre></td></tr></table></figure><p>例子：爬取猫眼top100信息。（利用<strong>正则</strong>抓取信息）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span>  re<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_content</span>(<span class="hljs-params">url</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;获取url内容&quot;&quot;&quot;</span><br>    headers = &#123;<br>        <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; 360SE)&quot;</span>,<br>    &#125;<br>    response = requests.get(url, headers=headers)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span>  response.text<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_one_page</span>(<span class="hljs-params">html</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;获取一个页面信息&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 取出序号</span><br>    <span class="hljs-comment"># re.S去除空白， ()中的内容为抓取内容</span><br>    pattern = re.compile(<span class="hljs-string">&#x27;&lt;i class=&quot;board-index.*?&quot;&gt;(.*?)&lt;/i&gt;&#x27;</span>, re.S)<br>    num_items = re.findall(pattern, html)<br><br>    <span class="hljs-comment"># 主演</span><br>    pattern = re.compile(<span class="hljs-string">&#x27;&lt;p class=&quot;star&quot;&gt;(.*?)&lt;/p&gt;&#x27;</span>, re.S)<br>    actor_items = re.findall(pattern, html)<br><br>    <span class="hljs-comment"># 取出标题</span><br>    pattern = re.compile(<span class="hljs-string">&#x27;&lt;p class=&quot;name&quot;.*?&lt;a.*?title=&quot;(.*?)&quot;&#x27;</span>, re.S)<br>    title_items = re.findall(pattern, html)<br><br>    <span class="hljs-comment"># 取出上映时间</span><br>    pattern = re.compile(<span class="hljs-string">&#x27;&lt;p class=&quot;releasetime&quot;&gt;(.*?)&lt;/p&gt;&#x27;</span>, re.S)<br>    dates = re.findall(pattern, html)<br><br>    <span class="hljs-comment"># 取出评分</span><br>    pattern = re.compile(<span class="hljs-string">&#x27;&lt;i class=&quot;integer&quot;&gt;(.*?)&lt;/i&gt;.*?&lt;i class=&quot;fraction&quot;&gt;(.*?)&lt;/i&gt;&#x27;</span>, re.S)<br>    point_items = re.findall(pattern, html)<br><br>    <span class="hljs-comment"># 取出链接</span><br>    pattern = re.compile(<span class="hljs-string">&#x27;&lt;img data-src=(.*?) alt=.*?class=&quot;board-img&quot; /&gt;&#x27;</span>, re.S)<br>    src_items = re.findall(pattern, html)<br><br>    list_info = []<br>    <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(len(actor_items)):<br>        dict = &#123;&#125;<br>        dict[<span class="hljs-string">&#x27;num&#x27;</span>] = num_items[index]<br>        dict[<span class="hljs-string">&#x27;title&#x27;</span>] = title_items[index]<br>        dict[<span class="hljs-string">&#x27;actor&#x27;</span>] = actor_items[index].strip()<br>        dict[<span class="hljs-string">&#x27;date&#x27;</span>] = dates[index]<br>        dict[<span class="hljs-string">&#x27;point&#x27;</span>] = <span class="hljs-string">&#x27;&#x27;</span>.join(point_items[index])<br>        dict[<span class="hljs-string">&#x27;src&#x27;</span>] = src_items[index].split(<span class="hljs-string">&#x27;&quot;&#x27;</span>)[<span class="hljs-number">1</span>]<br>        list_info.append(dict)<br>    <span class="hljs-keyword">return</span> list_info<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_all_pages</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;获取所有页面信息&quot;&quot;&quot;</span><br>    page = <span class="hljs-number">0</span><br>    list_result = []<br>    <span class="hljs-keyword">while</span> page &lt;= <span class="hljs-number">90</span>:<br>        url = <span class="hljs-string">&#x27;http://maoyan.com/board/4?offset=%d&#x27;</span> % page<br>        html = get_content(url)<br>        <span class="hljs-comment"># print(html)</span><br>        result = get_one_page(html)<br>        list_result.extend(result)<br>        page += <span class="hljs-number">10</span><br>    save_json(list_result)<br>    <span class="hljs-keyword">return</span> list_result<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write_images</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;保存图片在本地&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> get_all_pages():<br>        cover_url = item[<span class="hljs-string">&#x27;src&#x27;</span>]<br>        file_name = cover_url.split(<span class="hljs-string">&#x27;@&#x27;</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">&#x27;/&#x27;</span>)[<span class="hljs-number">-1</span>]<br>        print(file_name)<br>        headers = &#123;<br>            <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; 360SE)&quot;</span>,<br>        &#125;<br>        response = requests.get(cover_url, headers=headers)<br>        <span class="hljs-keyword">if</span> response.status_code==<span class="hljs-number">200</span>:<br>            <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./imgs/%s&#x27;</span>%file_name, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                f.write(response.content)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_json</span>(<span class="hljs-params">result_list</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;将json格式数据保存在本地&quot;&quot;&quot;</span><br>    json_text = json.dumps(result_list, ensure_ascii=<span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./maoyan.json&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(json_text)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    result = get_all_pages()<br>    print(result)<br>    write_images()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>当页面为ajax动态加载，并且加载方式为post时，我们可以用模拟Form Data提交数据，拿到想要的内容。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;__author__ = 星辰&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">from</span> mongo_helper <span class="hljs-keyword">import</span> insert_youyaoqi_data<br><br>headers = &#123;<br>    <span class="hljs-string">&#x27;Referer&#x27;</span>: <span class="hljs-string">&#x27;http://www.u17.com/comic_list/th99_gr99_ca99_ss99_ob0_ac0_as0_wm0_co99_ct99_p1.html?order=2&#x27;</span>,<br>    <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36&#x27;</span>,<br>    <span class="hljs-string">&#x27;Host&#x27;</span>: <span class="hljs-string">&#x27;www.u17.com&#x27;</span><br>&#125;<br>url = <span class="hljs-string">&#x27;http://www.u17.com/comic/ajax.php?mod=comic_list&amp;act=comic_list_new_fun&amp;a=get_comic_list&#x27;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_page</span>(<span class="hljs-params">page</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;拿到页面数据&quot;&quot;&quot;</span><br>    session = requests.Session()<br>    postdata = &#123;<br>        <span class="hljs-string">&#x27;data[group_id]&#x27;</span>: <span class="hljs-string">&#x27;no&#x27;</span>,<br>        <span class="hljs-string">&#x27;data[theme_id]&#x27;</span>: <span class="hljs-string">&#x27;no&#x27;</span>,<br>        <span class="hljs-string">&#x27;data[is_vip]&#x27;</span>: <span class="hljs-string">&#x27;no&#x27;</span>,<br>        <span class="hljs-string">&#x27;data[accredit]&#x27;</span>: <span class="hljs-string">&#x27;no&#x27;</span>,<br>        <span class="hljs-string">&#x27;data[color]&#x27;</span>: <span class="hljs-string">&#x27;no&#x27;</span>,<br>        <span class="hljs-string">&#x27;data[comic_type]&#x27;</span>: <span class="hljs-string">&#x27;no&#x27;</span>,<br>        <span class="hljs-string">&#x27;data[series_status]&#x27;</span>: <span class="hljs-string">&#x27;no&#x27;</span>,<br>        <span class="hljs-string">&#x27;data[order]&#x27;</span>: <span class="hljs-number">2</span>,<br>        <span class="hljs-string">&#x27;data[page_num]&#x27;</span>: page,<br>        <span class="hljs-string">&#x27;data[read_mode]&#x27;</span>: <span class="hljs-string">&#x27;no&#x27;</span><br>    &#125;<br>    response = session.post(url, data=postdata, headers=headers)<br>    <span class="hljs-keyword">if</span> response.status_code==<span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span>  response.text<br>    <span class="hljs-keyword">return</span>  <span class="hljs-literal">None</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_all_page</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;拿到所有页面的数据&quot;&quot;&quot;</span><br>    result_list = []<br>    page = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> page &lt;= <span class="hljs-number">410</span>:<br>        <span class="hljs-keyword">try</span>:<br>            result = get_page(page)<br>            result = json.loads(result)<br>        <span class="hljs-keyword">except</span> Exception:<br>            print(<span class="hljs-string">&#x27;爬取出错，开始重试！&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br>        result = result[<span class="hljs-string">&#x27;comic_list&#x27;</span>]<br>        result_list.extend(result)<br>        <span class="hljs-comment"># 存到mongoDB中</span><br>        insert_youyaoqi_data(result)<br>        print(<span class="hljs-string">&#x27;第&#x27;</span>, page, <span class="hljs-string">&#x27;页&#x27;</span>)<br>        print(result)<br>        print(<span class="hljs-string">&#x27;*&#x27;</span> * <span class="hljs-number">50</span>)<br>        page += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> result_list<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    get_all_page()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># mongo_helper.py</span><br><span class="hljs-keyword">import</span> pymongo<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">insert_youyaoqi_data</span>(<span class="hljs-params">result_dict</span>):</span><br>    client = pymongo.MongoClient()<br>    db = client.youyaoqi<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> result_dict:<br>        db.youyaoqi.insert_one(i)<br></code></pre></td></tr></table></figure><h3 id="爬虫解析库的使用"><a href="#爬虫解析库的使用" class="headerlink" title="爬虫解析库的使用"></a>爬虫解析库的使用</h3><h4 id="1、XPath"><a href="#1、XPath" class="headerlink" title="1、XPath"></a>1、XPath</h4><p>XML Path Language XML 路径语言</p><p>安装lxml库 (支持HTML和XML解析，支持XPath解析方式） </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install lxml<br></code></pre></td></tr></table></figure><p><strong>语法</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><br><span class="hljs-comment"># 取页面HTML</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_one_page</span>():</span><br>url = <span class="hljs-string">&quot;https://www.douban.com/group/explore&quot;</span><br>headers =  &#123;<br><span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; 360SE)&quot;</span> <br>&#125;<br>response = requests.get(url, headers=headers)<br><span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>text = response.content.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><span class="hljs-keyword">return</span> text<br><span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-comment"># 解析页面</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_with_xpath</span>(<span class="hljs-params">html</span>):</span><br>    <span class="hljs-comment"># 获取对象</span><br>etree_html = etree.HTML(html)<br>print(etree_html)<br><br><span class="hljs-comment"># 匹配所有节点 //*</span><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//*&#x27;</span>)<br>print(result)<br>print(len(result))<br><br><span class="hljs-comment"># 匹配所有子节点 //a     文本获取：text()</span><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//a/text()&#x27;</span>)<br>print(result)<br><br><span class="hljs-comment"># 查找元素子节点 /</span><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//div/p/text()&#x27;</span>)<br>print(result)<br><br><span class="hljs-comment"># 查找元素所有子孙节点 //</span><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;channel-item&quot;] | //span[@class=&quot;pubtime&quot;]/../span/a/text()&#x27;</span>)<br>print(result)<br><br><span class="hljs-comment"># 父节点 ..</span><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//span[@class=&quot;pubtime&quot;]/../span/a/text()&#x27;</span>)<br>print(result)<br><br><span class="hljs-comment"># 属性匹配 [@class=&quot;xxx&quot;]</span><br><span class="hljs-comment"># 文本匹配 text() 获取所有文本//text()</span><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;article&quot;]//text()&#x27;</span>)<br>print(result)<br><br><span class="hljs-comment"># 属性获取 @href</span><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;article&quot;]/div/div/@class&#x27;</span>)[<span class="hljs-number">0</span>]<br>result = etree_html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;bd&quot;]/h3/a/@href&#x27;</span>)<br>print(result)<br><br><span class="hljs-comment"># 属性多值匹配 contains(@class &#x27;xx&#x27;)</span><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//div[contains(@class, &quot;grid-16-8&quot;)]//div[@class=&quot;likes&quot;]/text()[1]&#x27;</span>)<br>print(result)<br><br><span class="hljs-comment"># 多属性匹配 or, and, mod, //book | //cd, + - * div = != &lt; &gt; &lt;= &gt;=</span><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//span[@class=&quot;pubtime&quot; and contains(text(), &quot;11:&quot;)]/text()&#x27;</span>)<br>print(result)<br><br><span class="hljs-comment"># 按序选择 [1] [last()] [poistion() &lt; 3] [last() -2]</span><br><span class="hljs-comment"># 节点轴</span><br><span class="hljs-comment"># //li/ancestor::*  所有祖先节点</span><br><span class="hljs-comment"># //li/ancestor::div div这个祖先节点</span><br><span class="hljs-comment"># //li/attribute::* attribute轴，获取li节点所有属性值</span><br><span class="hljs-comment"># //li/child::a[@href=&quot;link1.html&quot;]  child轴，获取直接子节点</span><br><span class="hljs-comment"># //li/descendant::span 获取所有span类型的子孙节点</span><br><span class="hljs-comment"># //li/following::* 选取文档中当前节点的结束标记之后的所有节点</span><br><span class="hljs-comment"># //li/following-sibling::*     选取当前节点之后的所用同级节点</span><br><br><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;channel-item&quot;][1]/following-sibling::*&#x27;</span>)<br>print(result)<br>print(len(result))<br><br>result = etree_html.xpath(<span class="hljs-string">&#x27;//div[contains(@class, &quot;channel-group-rec&quot;)]//div[@class=&quot;title&quot;]/following::*[1]/text()&#x27;</span>)<br>print(result)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>html = get_one_page()<br><span class="hljs-comment"># print(html)</span><br>parse_with_xpath(html)<br><br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>main()<br></code></pre></td></tr></table></figure><h4 id="2、Beautiful-Soup"><a href="#2、Beautiful-Soup" class="headerlink" title="2、Beautiful Soup"></a>2、Beautiful Soup</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip3 install beautifulsoup4<br></code></pre></td></tr></table></figure><p>解析器 </p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Python 标准库 <span class="hljs-constructor">BeautifulSoup(<span class="hljs-params">html</span>, “<span class="hljs-params">html</span>.<span class="hljs-params">parser</span>”)</span> 速度一般，容错能力好 <br>lxml HTML解析器 <span class="hljs-constructor">BeautifulSoup(<span class="hljs-params">html</span>, “<span class="hljs-params">lxml</span>”)</span> 速度快，容错好 <br>lxml xml解析器 <span class="hljs-constructor">BeautifulSoup(<span class="hljs-params">markup</span>, “<span class="hljs-params">xml</span>”)</span> 速度快，唯一支持xml<br>xml html5lib <span class="hljs-constructor">BeautifulSoup(<span class="hljs-params">markup</span>, “<span class="hljs-params">html5lib</span>”)</span> 容错性高，速度慢 <br></code></pre></td></tr></table></figure><p>引入BeautifulSoup </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<br></code></pre></td></tr></table></figure><p><strong>获取方法</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">soup = BeautifulSoup(html, <span class="hljs-string">&quot;lxml&quot;</span>)   <span class="hljs-comment"># 试用lxml解析器构造beautifulsoup</span><br>print(soup.prettify())     <span class="hljs-comment"># 取网页缩进格式化输出</span><br>soup.title.string   <span class="hljs-comment"># 取出head中title内容</span><br>soup.head           <span class="hljs-comment"># 获取head</span><br>soup.p              <span class="hljs-comment"># 获取节点</span><br>soup.title.name     <span class="hljs-comment"># 获取节点的名字</span><br>soup.img.attrs[<span class="hljs-string">&quot;src&quot;</span>]    <span class="hljs-comment"># 获取节点特定属性</span><br>soup.p[<span class="hljs-string">&quot;class&quot;</span>]          <span class="hljs-comment"># 获取节点特定属性</span><br>soup.p.attrs             <span class="hljs-comment"># 获取节点所有属性</span><br>soup.p.string            <span class="hljs-comment"># 获取节点包含的内容</span><br></code></pre></td></tr></table></figure><p><strong>嵌套选择</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># soup的节点都为 bs4.element.Tag类型,可以继续选择</span><br>print(soup.head.title.string)<br></code></pre></td></tr></table></figure><p><strong>关联选择</strong></p><p>有些元素没有特征定位，可以先选择有办法定位的，然后以这个节点为准选择它的子节点、父节点、兄弟节点等。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">print(soup.p.contents) <span class="hljs-comment"># 取p节点下面所有子节点列表</span><br>print(soup.p.descendants) <span class="hljs-comment">#取p节点所有子孙节点</span><br>print(soup.a.parent) <span class="hljs-comment"># 取父节点</span><br>print(soup.a.parents) <span class="hljs-comment"># 取所有祖先节点</span><br>print(soup.a.next_sibling) <span class="hljs-comment"># 同级下一节点</span><br>print(soup.a.previous_sibling) <span class="hljs-comment"># 同级上一节点</span><br>print(soup.a.next_siblings) <span class="hljs-comment"># 同级所有后面节点</span><br>print(soup.a.previous_siblings) <span class="hljs-comment"># 同级所有前面节点</span><br>print(list(soup.a.parents)[<span class="hljs-number">0</span>].attrs[<span class="hljs-string">&#x27;class&#x27;</span>])<br></code></pre></td></tr></table></figure><p><strong>方法选择器</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">print(soup.find_all(name=<span class="hljs-string">&quot;ul&quot;</span>))<br><span class="hljs-keyword">for</span> ul <span class="hljs-keyword">in</span> soup.find_all(name=<span class="hljs-string">&quot;ul&quot;</span>):<br>print(ul.find_all(name=<span class="hljs-string">&quot;li&quot;</span>))<br><span class="hljs-keyword">for</span> li <span class="hljs-keyword">in</span> ul.find_all(name=<span class="hljs-string">&quot;li&quot;</span>):<br>print(li.string)<br>soup.find_all(attrs=&#123;<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;list-1&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><p><strong>css选择器</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">soup.select(<span class="hljs-string">&#x27;.panel .panel_heading&#x27;</span>)<br>soup.select(<span class="hljs-string">&#x27;ul li&#x27;</span>)<br>soup.select(<span class="hljs-string">&#x27;#id1 .element&#x27;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spider</category>
      
    </categories>
    
    
    <tags>
      
      <tag>爬虫</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask-项目上线</title>
    <link href="/Myblog/2018/11/23/Flask-%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF/"/>
    <url>/Myblog/2018/11/23/Flask-%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF/</url>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在CentOS中Flask的项目部署和Django项目部署有异曲同工之效, 包括数据库的配置，远程设置访问,python3的安装都是相同的。在部署Flask项目的时候，可以借鉴Django部署的部分配置。<a href="https://stellae.gitee.io/myblog/2018/11/09/Django%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF/">传送门</a>) </p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>在服务器中首先需要完成以下五步基础环境搭建，才能开始部署操作：</p><p>步骤1：创建安装环境文件夹、配置信息文件夹、日志信息文件夹、项目代码文件夹。</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">命令：<span class="hljs-keyword">mkdir</span> <span class="hljs-keyword">conf</span> logs env src<br></code></pre></td></tr></table></figure><p>步骤2：上传项目代码到src文件夹中 </p><p>修改项目中的数据库配置。</p><p>步骤3：创建虚拟环境，并安装项目所需要的包 </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">安装：yum install python-virtualenv<br>创建：virtualenv --no-site-packages -p <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/python3/</span>bin/python3 xxenv<br><br>安装包： 指定虚拟环境中的pip3 install -r 指定项目中的requerement.txt文件<br></code></pre></td></tr></table></figure><p>步骤4：安装redis </p><p>如果使用了redis就配置</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">安装：yum <span class="hljs-keyword">install</span> redis<br>启动：redis-<span class="hljs-keyword">server</span><br>访问：redis-cli<br></code></pre></td></tr></table></figure><p>步骤5：配置conf中的flask-nginx.conf文件和flask-uwsgi.ini文件</p><p>flask-nginx.conf内容如下：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs gradle">server &#123;<br>listen    <span class="hljs-number">80</span>;<br>    server_name <span class="hljs-number">120.78</span>.<span class="hljs-number">83.46</span> localhost;<br><br>    access_log <span class="hljs-regexp">/root/</span>logs/access.log;<br>    error_log <span class="hljs-regexp">/root/</span>logs/error.log;<br><br>    location / &#123;<br>      <span class="hljs-keyword">include</span> uwsgi_params;<br>        uwsgi_pass <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8891</span>;<br><br>    &#125;<br>    # <span class="hljs-keyword">static</span><br>    location <span class="hljs-regexp">/static/</span> &#123;<br>         alias <span class="hljs-regexp">/root/</span>src<span class="hljs-regexp">/iHome/</span><span class="hljs-keyword">static</span>/;<br>         expires <span class="hljs-number">30</span>d;<br>     &#125;<br>    # media<br>     location <span class="hljs-regexp">/media/</span> &#123;<br>         alias <span class="hljs-regexp">/root/</span>src<span class="hljs-regexp">/iHome/</span><span class="hljs-keyword">static</span><span class="hljs-regexp">/media/</span>;<br>     &#125;    <br>&#125;<br></code></pre></td></tr></table></figure><p>注意：这里如果配置static和media目录的话，代码把这些静态文件解析交给nginx处理，这样可能会出现访问被拒绝的问题，需要去nginx.conf文件中把用户改为root。或者不配置static和media目录，这样flask可以自行进行解析。</p><p>flask-uwsgi.ini内容如下：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[uwsgi]</span><br><span class="hljs-attr">master</span> = <span class="hljs-literal">true</span><br><span class="hljs-attr">socket</span> = <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8891</span><br><span class="hljs-attr">processes</span> = <span class="hljs-number">4</span><br><span class="hljs-attr">chdir</span> = /root/src/iHome<br><span class="hljs-attr">pythonpath</span> = /root/env/iHome/bin/python3<br><span class="hljs-attr">module</span> = app:app<br><span class="hljs-attr">logto</span> = /root/logs/uwsgi.log<br></code></pre></td></tr></table></figure><blockquote><p>第一个 app 指明 py 文件，第二个 app 指明 Flask 实例</p></blockquote><p>步骤6：修改总的nginx.conf文件，并重启 </p><p>在/etc/nginx/nginx.conf文件中加入自定的flask-nginx.conf文件。 </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">引入方式为： inlucde 指定自定义<span class="hljs-regexp">/root/</span>conf/flask-nginx.conf的路径；<br></code></pre></td></tr></table></figure><p>重启nginx命令，以及相关的命令： </p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs smali">启动：<span class="hljs-keyword"> system</span>ctl start nginx<br>暂停：<span class="hljs-keyword"> system</span>ctl stop nginx<br>重启：<span class="hljs-keyword"> system</span>ctl restart nginx<br>查看状态：<span class="hljs-keyword"> system</span>ctl status nginx<br></code></pre></td></tr></table></figure><h4 id="1-测试环境中部署方式"><a href="#1-测试环境中部署方式" class="headerlink" title="1. 测试环境中部署方式"></a>1. 测试环境中部署方式</h4><p>在测试环境中使用启动命令直接运行项目：</p><p>启动命令：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">指定虚拟环境下的python3 指定manage.py路径 runserver -h <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> -p <span class="hljs-number">80</span> -d<br></code></pre></td></tr></table></figure><p>如：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/root/</span>env<span class="hljs-regexp">/iHome/</span>bin<span class="hljs-regexp">/python3 /</span>root<span class="hljs-regexp">/src/i</span>Home/manage.py runserver -h <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> -p <span class="hljs-number">80</span> -d<br></code></pre></td></tr></table></figure><h4 id="2-正式环境中部署方式"><a href="#2-正式环境中部署方式" class="headerlink" title="2. 正式环境中部署方式"></a>2. 正式环境中部署方式</h4><p><strong>方法一：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install gevent==<span class="hljs-number">1.4</span><span class="hljs-number">.0</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> monkey<br><span class="hljs-keyword">from</span> gevent.pywsgi <span class="hljs-keyword">import</span> WSGIServer<br><br>monkey.patch_all()<br>http_server = WSGIServer((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, int(<span class="hljs-number">5000</span>)), app)<br>http_server.serve_forever()<br></code></pre></td></tr></table></figure><blockquote><p>app: flask app</p></blockquote><p><strong>方法二：</strong></p><p>在正式环境中使用nginx+uwsgi进行部署，安装nginx的方式在部署Django中已经讲解清楚了，如有不清楚，请点击 <a href="https://stellae.gitee.io/myblog/2018/11/09/Django%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF/">传送门</a> </p><p>在正式环境中启动分以下三步骤：</p><p>步骤1：在manage.py启动文件中，添加访问首页的路由地址，如下所示：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># 启动首页地址</span><br>@app.route(<span class="hljs-string">&#x27;/&#x27;</span>)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">home_index</span><span class="hljs-params">()</span></span><span class="hljs-symbol">:</span><br><span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;house.index&#x27;</span>))<br></code></pre></td></tr></table></figure><p>步骤2：启动nginx</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">systemctl restart nginx</span><br></code></pre></td></tr></table></figure><p>步骤3：启动uwsgi</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">指定虚拟环境中uwsgi的路径 <span class="hljs-comment">--ini 指定xxuwsgi.ini路径</span><br></code></pre></td></tr></table></figure><p>如：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/root/</span>env<span class="hljs-regexp">/iHome/</span>bin<span class="hljs-regexp">/uwsgi --ini /</span>root<span class="hljs-regexp">/conf/</span>flask-uwsgi.ini<br></code></pre></td></tr></table></figure><blockquote><p>如果需要在后台执行，加参数 <code>-d</code> 即可</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask-缓存机制</title>
    <link href="/Myblog/2018/11/18/Flask-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/"/>
    <url>/Myblog/2018/11/18/Flask-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="HTTP缓存机制在Flask的实现"><a href="#HTTP缓存机制在Flask的实现" class="headerlink" title="HTTP缓存机制在Flask的实现"></a>HTTP缓存机制在Flask的实现</h3><p>HTTP缓存头的参数包括：</p><ul><li>Cache-Control（用于本地缓存）</li><li>Expires（用于本地缓存）</li><li>Last-Modified(协商缓存)</li><li>Etag(协商缓存)。</li></ul><h4 id="1-HTTP缓存头"><a href="#1-HTTP缓存头" class="headerlink" title="1.HTTP缓存头"></a>1.HTTP缓存头</h4><p><strong>（1）Cache_Control</strong></p><p>指定请求和响应遵循的缓存机制。在请求消息或响应消息中设置Cache- Control并不会修改另一个消息处理过程中的缓 存处理过程。</p><ul><li>请求时的缓存指令包括no-cache、no-store、max-age、max-stale、min-fresh、only-if- cached；</li><li>响应消息中的指令包括public、private、no-cache、no-store、no-transform、must- revalidate、proxy-revalidate、max-age。</li></ul><p><strong>（2）Expires</strong></p><p>是一个绝对时间，作用与cache-control的max-age相类似，表示资源信息失效的时间。</p><p><strong>（3）Last-Modified</strong></p><p>被访问的资源的最近一次更改时间(http1.0)</p><p><strong>（4）ETag</strong></p><p>资源的一个唯一标志（http1.1），通过这个标识，可以实现客户端与服务端的协商机制。它的作用与Last-Modified是相类似的。</p><p><strong>事实上，上述四者的实现机制上，可以归纳为：</strong></p><ul><li>cache-control/Expires：资源有效时间定义机制</li><li>Last-Modified/ETag：资源更新传输协商机制</li></ul><h4 id="2-HTTP缓存机制"><a href="#2-HTTP缓存机制" class="headerlink" title="2.HTTP缓存机制"></a>2.HTTP缓存机制</h4><p><strong>（1）cache-control/Expires：资源有效时间定义机制</strong></p><p>最好的请求是不必与服务器进行通信的请求：通过响应的本地副本，我们可以避免所有的网络延迟以及数据传输的数据成本。为此，HTTP 规范允许服务器返回 <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">一系列不同的 Cache-Control 指令</a>，控制浏览器或者其他中继缓存如何缓存某个响应以及缓存多长时间。</p><p><strong>参数说明：</strong></p><ul><li><p>no-cache和 no-store<br> no-cache表示必须先与服务器确认返回的响应是否被更改，然后才能使用该响应来满足后续对同一个网址的请求。因此，如果存在合适的验证令牌 (ETag)，no-cache 会发起往返通信来验证缓存的响应，如果资源未被更改，可以避免下载。相比之下，no-store更加简单，直接禁止浏览器和所有中继缓存存储返回的任何版本的响应 - 例如：一个包含个人隐私数据或银行数据的响应。每次用户请求该资源时，都会向服务器发送一个请求，每次都会下载完整的响应。</p></li><li><p>public和private<br> 如果响应被标记为public，即使有关联的 HTTP 认证，甚至响应状态码无法正常缓存，响应也可以被缓存。大多数情况下，public不是必须的，因为明确的缓存信息（例如max-age）已表示 响应可以被缓存。相比之下，浏览器可以缓存private响应，但是通常只为单个用户缓存，因此，不允许任何中继缓存对其进行缓存 - 例如，用户浏览器可以缓存包含用户私人信息的 HTML 网页，但是 CDN 不能缓存。</p></li><li><p>max-age<br> 该指令指定从当前请求开始，允许获取的响应被重用的最长时间（单位为秒） - 例如：max-age=60表示响应可以再缓存和重用 60 秒。</p></li><li><p>expires<br> Cache-Control 头在 HTTP/1.1 规范中定义，取代了之前用来定义响应缓存策略的头（例如 Expires）。当前的所有浏览器都支持 Cache-Control，因此，使用它就够了。</p></li><li><p>cache-control</p><p>在请求端和服务端的命令相互独立，cache-control不会因为请求设置的值而修改响应设置，反之亦然。这里考虑到一种场景，响应头中设置了一定的缓存时间，然而请求端仍然需要获取最新结果，则将请求头的缓存设置中加上“max-age=0”，则强制服务端响应这个请求。</p></li></ul><p><strong>（2）Last-Modified/ETag：资源更新传输协商机制</strong></p><ul><li><p>Last-Modified</p><p>在浏览器第一次请求某一个URL时，服务器端的返回状态会是200，内容是你请求的资源，同时有一个Last-Modified的属性标记此文件在服务期端最后被修改的时间，格式类似这样:</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">Last-Modified: Fri, <span class="hljs-number">12</span> May <span class="hljs-number">2006</span> <span class="hljs-number">18</span>:<span class="hljs-number">53</span>:<span class="hljs-number">33</span> GMT<br></code></pre></td></tr></table></figure><p>客户端第二次请求此URL时，根据 HTTP 协议的规定，浏览器会向服务器传送 If-Modified-Since 报头，询问该时间之后文件是否有被修改过:</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">If-Modified-Since: Fri, <span class="hljs-number">12</span> May <span class="hljs-number">2006</span> <span class="hljs-number">18</span>:<span class="hljs-number">53</span>:<span class="hljs-number">33</span> GMT<br></code></pre></td></tr></table></figure><p>如果服务器端的资源没有变化，则自动返回 HTTP 304 （Not Changed.）状态码，内容为空，这样就节省了传输数据量。当服务器端代码发生改变或者重启服务器时，则重新发出资源，返回和第一次请求时类似。从而保证不向客户端重复发出资源，也保证当服务器有变化时，客户端能够得到最新的资源。</p></li><li><p>ETag</p><p>HTTP 协议规格说明定义ETag为“被请求变量的实体值” 。另一种说法是，ETag是一个可以与Web资源关联的记号（token）。典型的Web资源可以一个Web页，但也可能是JSON或XML文档。服务器单独负责判断记号是什么及其含义，并在HTTP响应头中将其传送到客户端，以下是服务器端返回的格式：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">ETag:</span> <span class="hljs-string">&quot;50b1c1d4f775c61:df3&quot;</span><br></code></pre></td></tr></table></figure><p>客户端的查询更新格式是这样的：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart">If-None-<span class="hljs-built_in">Match</span>: W/<span class="hljs-string">&quot;50b1c1d4f775c61:df3&quot;</span><br></code></pre></td></tr></table></figure><p>如果ETag没改变，则返回状态304然后不返回，这也和Last-Modified一样。</p></li></ul><h4 id="3-基于Flask实现-cache-control"><a href="#3-基于Flask实现-cache-control" class="headerlink" title="3.基于Flask实现 cache-control"></a>3.基于Flask实现 cache-control</h4><p>此扩展本身不提供任何缓存。其唯一目的是在响应上设置Cache-Control和相关的HTTP标头，以便您所在辖区中评估Cache-Control标头（例如Varnish Cache）的客户端，中间代理或反向代理为您进行缓存。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install Flask-CacheControl<br></code></pre></td></tr></table></figure><p>Example</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># init</span><br><span class="hljs-keyword">from</span> flask_cachecontrol <span class="hljs-keyword">import</span> FlaskCacheControl, cache, cache_for, dont_cache<br><br>flask_cache_control = FlaskCacheControl()<br>flask_cache_control.init_app(app)<br><br><span class="hljs-comment"># route</span><br><span class="hljs-meta">@app.route(&#x27;/&#x27;)</span><br><span class="hljs-meta">@cache_for(hours=3)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index_view</span>():</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index_template&#x27;</span>)<br><br><span class="hljs-meta">@app.route(&#x27;/stats&#x27;)</span><br><span class="hljs-meta">@cache(max_age=3600, public=True)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stats_view</span>():</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;stats_template&#x27;</span>)<br><br><span class="hljs-meta">@app.route(&#x27;/dashboard&#x27;)</span><br><span class="hljs-meta">@dont_cache()</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dashboard_view</span>():</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;dashboard_template&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="4-基于Flask实现-ETag-Last-Modified"><a href="#4-基于Flask实现-ETag-Last-Modified" class="headerlink" title="4.基于Flask实现 ETag/Last-Modified"></a>4.基于Flask实现 ETag/Last-Modified</h4><p>ETag没有flask扩展包，这里有一篇<a href="http://flask.pocoo.org/snippets/95/">官方的文章</a>介绍实现方法。对方法总结一下：</p><ul><li>给flask.response.set_etag()做一个猴子补丁（Monkeypatching）。</li><li>猴子补丁的内容为，校验请求包的“IF-MATCH”与“IF-NONE-MATCH”信息（即请求包的ETag字段），如果不合法则直接返回错误；如果合法，则执行校验etag，将本次新生成的etag码与请求包中的“IF-NONE-MATCH”码相匹配，则抛出“NotModified”异常（执行304状态码及空包返回），如果不匹配，则进行全数据返回且包含了新的ETag信息。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">_old_set_etag = werkzeug.ETagResponseMixin.set_etag<br><span class="hljs-meta">@functools.wraps(werkzeug.ETagResponseMixin.set_etag)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_new_set_etag</span>(<span class="hljs-params">self, etag, weak=False</span>):</span><br>    <span class="hljs-comment"># only check the first time through; when called twice</span><br>    <span class="hljs-comment"># we&#x27;re modifying</span><br>    <span class="hljs-keyword">if</span> (hasattr(flask.g, <span class="hljs-string">&#x27;condtnl_etags_start&#x27;</span>) <span class="hljs-keyword">and</span><br>                               flask.g.condtnl_etags_start):<br>        <span class="hljs-keyword">if</span> flask.request.method <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;PUT&#x27;</span>, <span class="hljs-string">&#x27;DELETE&#x27;</span>, <span class="hljs-string">&#x27;PATCH&#x27;</span>):<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> flask.request.if_match:<br>                <span class="hljs-keyword">raise</span> PreconditionRequired<br>            <span class="hljs-keyword">if</span> etag <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> flask.request.if_match:<br>                flask.abort(<span class="hljs-number">412</span>)<br>        <span class="hljs-keyword">elif</span> (flask.request.method == <span class="hljs-string">&#x27;GET&#x27;</span> <span class="hljs-keyword">and</span><br>              flask.request.if_none_match <span class="hljs-keyword">and</span><br>              etag <span class="hljs-keyword">in</span> flask.request.if_none_match):<br>            <span class="hljs-keyword">raise</span> NotModified<br>        flask.g.condtnl_etags_start = <span class="hljs-literal">False</span><br>    _old_set_etag(self, etag, weak)<br>werkzeug.ETagResponseMixin.set_etag = _new_set_etag<br></code></pre></td></tr></table></figure><ul><li>校验ETag的行为在API的响应代码中执行。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">app = flask.Flask(__name__)<br>d = &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-string">&#x27;This is &quot;a&quot;.\n&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-string">&#x27;This is &quot;b&quot;.\n&#x27;</span>&#125;<br><span class="hljs-meta">@app.route(&#x27;/&lt;path&gt;&#x27;,</span><br>           methods = [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;PUT&#x27;</span>, <span class="hljs-string">&#x27;DELETE&#x27;</span>, <span class="hljs-string">&#x27;PATCH&#x27;</span>])<br><span class="hljs-meta">@conditional</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">view</span>(<span class="hljs-params">path</span>):</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># SHA1 should generate well-behaved etags</span><br>        etag = hashlib.sha1(d[path]).hexdigest()<br>        <span class="hljs-keyword">if</span> flask.request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>            response = flask.make_response(d[path])<br>            response.set_etag(etag)<br>        <span class="hljs-keyword">else</span>:<br>            response = flask.Response(status=<span class="hljs-number">204</span>)<br>            <span class="hljs-keyword">del</span> response.headers[<span class="hljs-string">&#x27;content-type&#x27;</span>]<br>            response.set_etag(etag)<br>            <span class="hljs-keyword">if</span> flask.request.method == <span class="hljs-string">&#x27;DELETE&#x27;</span>:<br>                <span class="hljs-keyword">del</span> d[path]<br>                <span class="hljs-keyword">del</span> response.headers[<span class="hljs-string">&#x27;etag&#x27;</span>]<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> flask.request.method == <span class="hljs-string">&#x27;PUT&#x27;</span>:<br>                    d[path] = flask.request.data<br>                <span class="hljs-keyword">else</span>: <span class="hljs-comment"># (PATCH)</span><br>                    <span class="hljs-comment"># lame PATCH technique</span><br>                    d[path] += flask.request.data<br>             response.set_etag(hashlib.sha1(d[path])<br>                                      .hexdigest())<br>        <span class="hljs-keyword">return</span> response<br>    <span class="hljs-keyword">except</span> KeyError:<br>        flask.abort(<span class="hljs-number">404</span>)<br>app.run()<br></code></pre></td></tr></table></figure><p><a href="https://www.jianshu.com/p/41773c3e4e56">参考文章</a> / <a href="https://github.com/twiebe/Flask-CacheControl">Flask-CacheControl</a> / <a href="https://www.runoob.com/http/http-header-fields.html">HTTP响应头</a></p><h3 id="数据库缓存在Flask的实现"><a href="#数据库缓存在Flask的实现" class="headerlink" title="数据库缓存在Flask的实现"></a>数据库缓存在Flask的实现</h3><p>安装Flask-Cache</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install Flask-Cache<br></code></pre></td></tr></table></figure><h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask.ext.cache <span class="hljs-keyword">import</span> Cache<br><br>app = Flask(__name__)<br><span class="hljs-comment"># Check Configuring Flask-Cache section for more details</span><br>cache = Cache(app,config=&#123;<span class="hljs-string">&#x27;CACHE_TYPE&#x27;</span>: <span class="hljs-string">&#x27;simple&#x27;</span>&#125;)<br><br><span class="hljs-meta">@app.route(&quot;/get_info&quot;)</span><br><span class="hljs-meta">@cache.cached(timeout=30, key_prefix=&quot;get_info&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_info</span>():</span><br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;no cache!&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;it is ok!&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>timeout设置过期时间；key_prefix设置cache_key，不设置此值默认使用path.request；unless接受一个bool值，设置为True不会使用缓存机制</p></blockquote><h4 id="Flask-Cache支持缓存类型"><a href="#Flask-Cache支持缓存类型" class="headerlink" title="Flask-Cache支持缓存类型"></a>Flask-Cache支持缓存类型</h4><ul><li><strong>null</strong>：无缓存。相关配置项如下：</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">CACHE_ARGS</span>在缓存类实例化过程中解包和传递的可选列表<br><span class="hljs-keyword">CACHE_OPTIONS</span>可选字典在缓存类实例化期间传递<br></code></pre></td></tr></table></figure><ul><li><strong>simple</strong>：使用本地python字典进行存储(Werkzeug)，这不是线程安全的。相关配置项如下：</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">CACHE_DEFAULT_TIMEOUT</span>默认过期/超时时间，单位为秒<br><span class="hljs-built_in">CACHE_THRESHOLD</span>缓存的最大条目数<br><span class="hljs-built_in">CACHE_ARGS</span>在缓存类实例化过程中解包和传递的可选列表<br><span class="hljs-built_in">CACHE_OPTIONS</span>可选字典在缓存类实例化期间传递<br></code></pre></td></tr></table></figure><ul><li><strong>filesystem</strong>：使用文件系统来存储缓存的值。相关配置项如下：</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">CACHE_DEFAULT_TIMEOUT</span>默认过期/超时时间，单位为秒<br><span class="hljs-built_in">CACHE_DIR</span>存储缓存的目录<br><span class="hljs-built_in">CACHE_THRESHOLD</span>缓存的最大条目数<br><span class="hljs-built_in">CACHE_ARGS</span>在缓存类实例化过程中解包和传递的可选列表<br><span class="hljs-built_in">CACHE_OPTIONS</span>可选字典在缓存类实例化期间传递<br></code></pre></td></tr></table></figure><ul><li><strong>memcached</strong>：使用memcached服务器作为缓存后端，支持pylibmc或memcache或Google应用程序引擎memcache库。相关配置项如下：</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">CACHE_DEFAULT_TIMEOUT</span>默认过期/超时时间，单位为秒<br><span class="hljs-built_in">CACHE_KEY_PREFIX</span>设置cache_key的前缀<br><span class="hljs-built_in">CAHCE_MEMCACHED_SERVERS</span>服务器地址的列表或元组<br><span class="hljs-built_in">CACHE_ARGS</span>在缓存类实例化过程中解包和传递的可选列表<br><span class="hljs-built_in">CACHE_OPTIONS</span>可选字典在缓存类实例化期间传递<br></code></pre></td></tr></table></figure><ul><li><strong>redis</strong>：使用Redis作为缓存后端。相关配置项如下：</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">CACHE_DEFAULT_TIMEOUT</span>默认过期/超时时间，单位为秒<br><span class="hljs-built_in">CACHE_KEY_PREFIX</span>设置cache_key的前缀<br><span class="hljs-built_in">CACHE_REDIS_HOST</span>redis地址<br><span class="hljs-built_in">CACHE_REDIS_PORT</span>redis端口<br><span class="hljs-built_in">CACHE_REDIS_PASSWORD</span>redis密码<br><span class="hljs-built_in">CACHE_REDIS_DB</span>使用哪个库<br><span class="hljs-built_in">CACHE_REDIS_URL</span>连接到Redis服务器的URL。示例redis:<span class="hljs-comment">//user:password@localhost:6379/2</span><br><span class="hljs-built_in">CACHE_ARGS</span>在缓存类实例化过程中解包和传递的可选列表<br><span class="hljs-built_in">CACHE_OPTIONS</span>可选字典在缓存类实例化期间传递<br></code></pre></td></tr></table></figure><p><strong>Example for Redis</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask.ext.cache <span class="hljs-keyword">import</span> Cache<br><br>app = Flask(__name__)<br><span class="hljs-comment"># Check Configuring Flask-Cache section for more details</span><br>cache = Cache(app,config=&#123;<span class="hljs-string">&#x27;CACHE_TYPE&#x27;</span>: <span class="hljs-string">&#x27;redis&#x27;</span>,<br>                          <span class="hljs-string">&#x27;CACHE_REDIS_URL&#x27;</span>: <span class="hljs-string">&#x27;redis://user:password@localhost:6379/2&#x27;</span>&#125;)<br><br><span class="hljs-meta">@app.route(&quot;/get_info&quot;)</span><br><span class="hljs-meta">@cache.cached(timeout=30, key_prefix=&quot;get_info&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_info</span>():</span><br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;no cache!&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;it is ok!&quot;</span><br></code></pre></td></tr></table></figure><p><a href="http://www.pythondoc.com/flask-cache/">Flask-Cache</a></p>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>缓存</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask-Compress</title>
    <link href="/Myblog/2018/11/17/Flask-Compress/"/>
    <url>/Myblog/2018/11/17/Flask-Compress/</url>
    
    <content type="html"><![CDATA[<h4 id="Flask-Compress"><a href="#Flask-Compress" class="headerlink" title="Flask-Compress"></a>Flask-Compress</h4><p>安装flask-compress第三方包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install flask-compress<br></code></pre></td></tr></table></figure><h4 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask_compress <span class="hljs-keyword">import</span> Compress<br><br><br>app = Flask(__name__)<br><span class="hljs-comment"># 开启gzip</span><br>Compress(app)<br><span class="hljs-comment"># 配置最小压缩大小</span><br>app.config[<span class="hljs-string">&#x27;COMPRESS_MIN_SIZE&#x27;</span>] = <span class="hljs-number">1024</span><br><span class="hljs-comment"># 配置压缩等级</span><br>app.config[<span class="hljs-string">&#x27;COMPRESS_LEVEL&#x27;</span>] = <span class="hljs-number">6</span><br><span class="hljs-comment"># only compress json type</span><br>app.config[<span class="hljs-string">&#x27;COMPRESS_MIMETYPES&#x27;</span>] = [<span class="hljs-string">&#x27;application/json&#x27;</span>]<br><br></code></pre></td></tr></table></figure><blockquote><p>Flask-Compress做的事情就是，向app中插入自己的after_request方法，在这个after_request方法中进行数据压缩，after_response中主要的代码，根据各种参数判断要不要做压缩，压缩完了设置encoding等参数。</p><p>COMPRESS_LEVEL，这个参数是控制压缩级别，就是gzip的压缩级别，1-9，1的压缩速度最快，压缩率最小，9 反之，默认值是6。</p></blockquote><p>除了Flask-Compress，常用的压缩方法还有配置nigix。</p><p><a href="https://www.jianshu.com/p/0e8cd091e2da">参考文章</a></p>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>gzip</tag>
      
      <tag>compress</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask-代理HTTP请求</title>
    <link href="/Myblog/2018/11/16/Flask-%E4%BB%A3%E7%90%86HTTP%E8%AF%B7%E6%B1%82/"/>
    <url>/Myblog/2018/11/16/Flask-%E4%BB%A3%E7%90%86HTTP%E8%AF%B7%E6%B1%82/</url>
    
    <content type="html"><![CDATA[<h3 id="添加-HTTP-Method-Overrides"><a href="#添加-HTTP-Method-Overrides" class="headerlink" title="添加 HTTP Method Overrides"></a>添加 HTTP Method Overrides</h3><p>某些 HTTP 代理不支持任意的 HTTP 方法或更新的 HTTP 方法（比如 PATCH）。 这种情况下，通过另一种完全违背协议的 HTTP 方法来“代理” HTTP 方法是可行的。</p><p>这个方法使客户端发出 HTTP POST 请求并设置 <code>X-HTTP-Method-Override</code> 标头的值为想要的 HTTP 方法（比如 <code>PATCH</code> ）。</p><p>这很容易通过一个 HTTP 中间件来完成:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HTTPMethodOverrideMiddleware</span>(<span class="hljs-params">object</span>):</span><br>    allowed_methods = frozenset([<br>        <span class="hljs-string">&#x27;GET&#x27;</span>,<br>        <span class="hljs-string">&#x27;HEAD&#x27;</span>,<br>        <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-string">&#x27;DELETE&#x27;</span>,<br>        <span class="hljs-string">&#x27;PUT&#x27;</span>,<br>        <span class="hljs-string">&#x27;PATCH&#x27;</span>,<br>        <span class="hljs-string">&#x27;OPTIONS&#x27;</span><br>    ])<br>    bodyless_methods = frozenset([<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;HEAD&#x27;</span>, <span class="hljs-string">&#x27;OPTIONS&#x27;</span>, <span class="hljs-string">&#x27;DELETE&#x27;</span>])<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, app</span>):</span><br>        self.app = app<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span>(<span class="hljs-params">self, environ, start_response</span>):</span><br>        method = environ.get(<span class="hljs-string">&#x27;HTTP_X_HTTP_METHOD_OVERRIDE&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).upper()<br>        <span class="hljs-keyword">if</span> method <span class="hljs-keyword">in</span> self.allowed_methods:<br>            <span class="hljs-comment"># method = method.encode(&#x27;ascii&#x27;, &#x27;replace&#x27;)</span><br>            environ[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] = method<br>        <span class="hljs-keyword">if</span> method <span class="hljs-keyword">in</span> self.bodyless_methods:<br>            environ[<span class="hljs-string">&#x27;CONTENT_LENGTH&#x27;</span>] = <span class="hljs-string">&#x27;0&#x27;</span><br>        <span class="hljs-keyword">return</span> self.app(environ, start_response)<br></code></pre></td></tr></table></figure><p>在 Flask 中使用它的必要步骤见下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><br>app = Flask(__name__)<br>app.wsgi_app = HTTPMethodOverrideMiddleware(app.wsgi_app)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask-代码功能拆分</title>
    <link href="/Myblog/2018/11/16/Flask-%E4%BB%A3%E7%A0%81%E5%8A%9F%E8%83%BD%E6%8B%86%E5%88%86/"/>
    <url>/Myblog/2018/11/16/Flask-%E4%BB%A3%E7%A0%81%E5%8A%9F%E8%83%BD%E6%8B%86%E5%88%86/</url>
    
    <content type="html"><![CDATA[<p>为了便于管理，应该把代码拆分成以下几个板块</p><h4 id="manage-py"><a href="#manage-py" class="headerlink" title="manage.py"></a>manage.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask_script <span class="hljs-keyword">import</span> Manager<br><br><span class="hljs-keyword">from</span> user.views <span class="hljs-keyword">import</span> blue<br><span class="hljs-keyword">from</span> util.config <span class="hljs-keyword">import</span> Config<br><span class="hljs-keyword">from</span> util.function <span class="hljs-keyword">import</span> init_ext<br><br>app = Flask(__name__)<br><br><span class="hljs-comment"># 蓝图</span><br>app.register_blueprint(blueprint=blue, url_prefix=<span class="hljs-string">&#x27;/user&#x27;</span>)<br><span class="hljs-comment"># 配置文件</span><br>app.config.from_object(Config)<br><span class="hljs-comment"># 初始化第三方库</span><br>init_ext(app)<br><br>manage = Manager(app)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    manage.run()<br></code></pre></td></tr></table></figure><h4 id="util文件下包含文件config-function-setting"><a href="#util文件下包含文件config-function-setting" class="headerlink" title="util文件下包含文件config, function, setting"></a>util文件下包含文件config, function, setting</h4><h5 id="config-py-配置文件"><a href="#config-py-配置文件" class="headerlink" title="config.py - 配置文件"></a>config.py - 配置文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> util.function <span class="hljs-keyword">import</span> get_mysql_database<br><span class="hljs-comment"># from util.function import &quot;mysql+pymysql://root:123456@localhost:3306/flask&quot;</span><br><span class="hljs-keyword">from</span> util.settings <span class="hljs-keyword">import</span> DATABASE<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>():</span><br>    <span class="hljs-comment"># 邮箱配置</span><br>    MAIL_SERVER = <span class="hljs-string">&quot;smtp.163.com&quot;</span>  <span class="hljs-comment"># 邮箱服务器</span><br>    MAIL_PORT = <span class="hljs-number">465</span>  <span class="hljs-comment"># 设置邮箱端口为465，默认为25，由于阿里云禁止了25端口，所以需要修改</span><br>    MAIL_USE_SSL = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 163邮箱需要开启SSL</span><br>    MAIL_USERNAME = <span class="hljs-string">&quot;lhj_96@163.com&quot;</span>  <span class="hljs-comment"># 邮箱</span><br>    MAIL_PASSWORD = <span class="hljs-string">&quot;xxxxx&quot;</span>  <span class="hljs-comment"># 授权码</span><br><br>    <span class="hljs-comment"># 数据库的配置</span><br>    SQLALCHEMY_DATABASE_URI = get_mysql_database(DATABASE)<br>    SQLALCHEMY_TRACK_MODIFICATIONS = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 不写会有警告信息</span><br><br></code></pre></td></tr></table></figure><h5 id="function-py-初始化文件"><a href="#function-py-初始化文件" class="headerlink" title="function.py - 初始化文件"></a>function.py - 初始化文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask_mail <span class="hljs-keyword">import</span> Mail<br><br><span class="hljs-keyword">from</span> user.models <span class="hljs-keyword">import</span> db<br><br>mail = Mail()<br><br><span class="hljs-comment"># 初始化</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_ext</span>(<span class="hljs-params">app</span>):</span><br>    mail.init_app(app)<br>    db.init_app(app)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_mysql_database</span>(<span class="hljs-params">database</span>):</span><br>    <span class="hljs-comment"># 组装数据库格式&quot;mysql+pymysql://root:123456@localhost:3306/flask&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#123;&#125;+&#123;&#125;://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;&#x27;</span>.format(database[<span class="hljs-string">&#x27;DIALECT&#x27;</span>],<br>                                           database[<span class="hljs-string">&#x27;DRIVER&#x27;</span>],<br>                                           database[<span class="hljs-string">&#x27;USER&#x27;</span>],<br>                                           database[<span class="hljs-string">&#x27;PASSWORD&#x27;</span>],<br>                                           database[<span class="hljs-string">&#x27;HOST&#x27;</span>],<br>                                           database[<span class="hljs-string">&#x27;PORT&#x27;</span>],<br>                                           database[<span class="hljs-string">&#x27;DB&#x27;</span>])<br></code></pre></td></tr></table></figure><p>settings.py - 配置文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">DATABASE = &#123;<br>    <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>,<br>    <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>    <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-number">3306</span>,<br>    <span class="hljs-string">&#x27;DB&#x27;</span>: <span class="hljs-string">&#x27;flask&#x27;</span>,<br>    <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;localhost&#x27;</span>,<br>    <span class="hljs-string">&#x27;DIALECT&#x27;</span>: <span class="hljs-string">&#x27;mysql&#x27;</span>,<br>    <span class="hljs-string">&#x27;DRIVER&#x27;</span>: <span class="hljs-string">&#x27;pymysql&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>想要更好的组织 flask 项目结构可以参考 <a href="https://spacewander.github.io/explore-flask-zh/4-organizing_your_project.html">文章</a></p>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask-文件上传和邮件发送</title>
    <link href="/Myblog/2018/11/15/Flask-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8C%E9%82%AE%E4%BB%B6%E5%8F%91%E9%80%81/"/>
    <url>/Myblog/2018/11/15/Flask-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8C%E9%82%AE%E4%BB%B6%E5%8F%91%E9%80%81/</url>
    
    <content type="html"><![CDATA[<h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--up_load.html--&gt;</span><br><br>&#123;% block content %&#125;<br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br>    上传图片：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span>  <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;img&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;提交&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br>&#123;% endblock %&#125;<br></code></pre></td></tr></table></figure><p>视图函数中实现存储</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> render_template<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">from</span> user.modles <span class="hljs-keyword">import</span> UploadImg, db<br><br><br><span class="hljs-meta">@blueprint.route(&#x27;/upload&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">up_img</span>():</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;upload.html&#x27;</span>)<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br><br>        <span class="hljs-comment"># 保存图片到本地</span><br>        upload_img = request.files.get(<span class="hljs-string">&#x27;img&#x27;</span>)<br>        BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__))) <span class="hljs-comment"># 项目路径</span><br>        MEDIA_ROOT = os.path.join(os.path.join(BASE_DIR, <span class="hljs-string">&#x27;static&#x27;</span>),<span class="hljs-string">&#x27;media&#x27;</span>)  <span class="hljs-comment"># 媒体文件路径</span><br>        path = os.path.join(MEDIA_ROOT, upload_img.filename) <span class="hljs-comment"># 上传路径</span><br>        upload_img.save(path)   <span class="hljs-comment"># 保存到对应路径下</span><br><br>        <span class="hljs-comment"># 保存图片名到数据库,使用时组装路径</span><br>        up_img  = UploadImg()<br>        upload_path = upload_img.filename<br>        up_img.img = upload_path<br>        db.session.add(up_img)<br>        db.session.commit()<br><br><br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;img.html&#x27;</span>, img=up_img.img)<br></code></pre></td></tr></table></figure><p>说明：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">os.path.abspath(__file__) -- 获取当前绝对路径<br>os.path.dirname(&lt;path&gt;) -- 上一级目录<br>os.path.join() -- 拼接路径<br></code></pre></td></tr></table></figure><h4 id="邮件发送"><a href="#邮件发送" class="headerlink" title="邮件发送"></a>邮件发送</h4><p>在程序中经常使用到邮件发送功能，如何使用flask进行邮件发送呢？Flask是一个扩展性极强的框架，在Flask核心代码上可以自由的扩展功能。比如邮件发送功能，就有flask-mail库，使用该库可以简单的实现邮件发送功能。 </p><h5 id="开启邮件发送功能"><a href="#开启邮件发送功能" class="headerlink" title="开启邮件发送功能"></a>开启邮件发送功能</h5><p>我们使用163的电子邮箱服务器作为发送邮件者，所以需要开启客户端授权码，并设置授权码。 </p><h5 id="安装flask-mail库实现邮件发送功能"><a href="#安装flask-mail库实现邮件发送功能" class="headerlink" title="安装flask-mail库实现邮件发送功能"></a>安装flask-mail库实现邮件发送功能</h5><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> flask-mail<br></code></pre></td></tr></table></figure><h5 id="功能实现（单一文件实现）"><a href="#功能实现（单一文件实现）" class="headerlink" title="功能实现（单一文件实现）"></a>功能实现（单一文件实现）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask_mail <span class="hljs-keyword">import</span>  Mail, Message<br><br><br>app.config[<span class="hljs-string">&quot;MAIL_SERVER&quot;</span>] = <span class="hljs-string">&quot;smtp.163.com&quot;</span> <span class="hljs-comment"># 邮箱服务器</span><br>app.config[<span class="hljs-string">&quot;MAIL_PORT&quot;</span>] = <span class="hljs-number">465</span>  <span class="hljs-comment"># 设置邮箱端口为465，默认为25</span><br>app.config[<span class="hljs-string">&quot;MAIL_USE_SSL&quot;</span>] = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 163邮箱需要开启SSL</span><br>app.config[<span class="hljs-string">&quot;MAIL_USERNAME&quot;</span>] = <span class="hljs-string">&quot;lhj_96@163.com&quot;</span> <span class="hljs-comment"># 邮箱</span><br>app.config[<span class="hljs-string">&quot;MAIL_PASSWORD&quot;</span>] = <span class="hljs-string">&quot;XXXX&quot;</span>  <span class="hljs-comment"># 授权码</span><br><br>main = Mail(app)<br><br><br><span class="hljs-meta">@app.route(&#x27;/send_mail&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_mail</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;subject-主题，sender-发送方， recipients-接收方&quot;&quot;&quot;</span><br>    msg = Message(subject=<span class="hljs-string">&#x27;测试邮件标题&#x27;</span>, sender=<span class="hljs-string">&#x27;lhj_96@163.com&#x27;</span>, recipients=[<span class="hljs-string">&#x27;1195044963@qq.com&#x27;</span>])<br>    msg.body = <span class="hljs-string">&#x27;测试邮件内容&#x27;</span><br>    mail.send(msg)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;seccessful&#x27;</span><br></code></pre></td></tr></table></figure><p>设置的参数定义如下：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ada">MAIL_SERVER: 电子邮件服务器的主机名或IP地址， 默认为localhost<br>MAIL_PORT: 电子邮件服务器的端口，默认为<span class="hljs-number">25</span><br>MAIL_USE_TLS： 启用传输层安全协议，默认为<span class="hljs-literal">False</span><br>MAIL_USE_SSL： 启用安全套接层协议， 默认为<span class="hljs-literal">False</span><br>MAIL_USERNAME： 邮件账户的用户名<br>MAIL_PASSWORD：邮件账户的密码，为在<span class="hljs-number">163</span>中设置的授权码<br></code></pre></td></tr></table></figure><h5 id="功能实现（拆分实现）"><a href="#功能实现（拆分实现）" class="headerlink" title="功能实现（拆分实现）"></a>功能实现（拆分实现）</h5><p>manage.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask_script <span class="hljs-keyword">import</span> Manager<br><br><span class="hljs-keyword">from</span> user.views <span class="hljs-keyword">import</span> blue<br><span class="hljs-keyword">from</span> util.config <span class="hljs-keyword">import</span> Config<br><span class="hljs-keyword">from</span> util.function <span class="hljs-keyword">import</span> init_ext<br><br>app = Flask(__name__)<br><br><span class="hljs-comment"># 蓝图</span><br>app.register_blueprint(blueprint=blue, url_prefix=<span class="hljs-string">&#x27;/user&#x27;</span>)<br><span class="hljs-comment"># 配置文件</span><br>app.config.from_object(Config)<br><span class="hljs-comment"># 初始化第三方库</span><br>init_ext(app)<br><br>manage = Manager(app)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    manage.run()<br></code></pre></td></tr></table></figure><p>config.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> util.function <span class="hljs-keyword">import</span> <span class="hljs-string">&quot;mysql+pymysql://root:123456@localhost:3306/flask&quot;</span><br><span class="hljs-keyword">from</span> util.settings <span class="hljs-keyword">import</span> DATABASE<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>():</span><br>    <span class="hljs-comment"># 邮箱配置</span><br>    MAIL_SERVER = <span class="hljs-string">&quot;smtp.163.com&quot;</span>  <span class="hljs-comment"># 邮箱服务器</span><br>    MAIL_PORT = <span class="hljs-number">465</span>  <span class="hljs-comment"># 设置邮箱端口为465，默认为25，由于阿里云禁止了25端口，所以需要修改</span><br>    MAIL_USE_SSL = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 163邮箱需要开启SSL</span><br>    MAIL_USERNAME = <span class="hljs-string">&quot;lhj_96@163.com&quot;</span>  <span class="hljs-comment"># 邮箱</span><br>    MAIL_PASSWORD = <span class="hljs-string">&quot;xxxx&quot;</span>  <span class="hljs-comment"># 授权码</span><br></code></pre></td></tr></table></figure><p>function.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask_mail <span class="hljs-keyword">import</span> Mail<br><br><span class="hljs-keyword">from</span> user.models <span class="hljs-keyword">import</span> db<br><br>mail = Mail()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_ext</span>(<span class="hljs-params">app</span>):</span><br>    mail.init_app(app)<br>    db.init_app(app)<br><br></code></pre></td></tr></table></figure><p>views.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask_mail <span class="hljs-keyword">import</span> Message<br><br><span class="hljs-keyword">from</span> util.function <span class="hljs-keyword">import</span> mail<br><br><br>blue = Blueprint(<span class="hljs-string">&#x27;user&#x27;</span>, __name__)<br><br><span class="hljs-meta">@blue.route(&#x27;/send_mail&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_mail</span>():</span><br>    msg = Message(subject=<span class="hljs-string">&#x27;测试邮件标题&#x27;</span>, sender=<span class="hljs-string">&#x27;lhj_96@163.com&#x27;</span>, recipients=[<span class="hljs-string">&#x27;1195044963@qq.com&#x27;</span>])<br>    msg.body = <span class="hljs-string">&#x27;测试邮件内容&#x27;</span><br>    mail.send(msg)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;seccessful&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask-钩子和表单</title>
    <link href="/Myblog/2018/11/15/Flask-%E9%92%A9%E5%AD%90%E5%92%8C%E8%A1%A8%E5%8D%95/"/>
    <url>/Myblog/2018/11/15/Flask-%E9%92%A9%E5%AD%90%E5%92%8C%E8%A1%A8%E5%8D%95/</url>
    
    <content type="html"><![CDATA[<h3 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h3><p>flask中具有四种钩子被做成了修饰器,我们在后端可以进行调用做相关的操作，使用钩子函数时，我们需要借助flask的全局变量g，g作为中间变量,在钩子函数和视图函数中间传递数据，我们先引入全局变量g </p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> g<br></code></pre></td></tr></table></figure><p>可以给 <strong>g</strong> 绑定属性，用于在全局传递数据</p><h4 id="before-first-request"><a href="#before-first-request" class="headerlink" title="before_first_request"></a>before_first_request</h4><p>注册一个函数,在处理第一个请求之前运行. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.before_first_request</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">before_first_request</span>():</span><br>    print(<span class="hljs-string">&#x27;before_first_request&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="before-request"><a href="#before-request" class="headerlink" title="before_request"></a>before_request</h4><p>在每个请求之前注册一个要运行的函数, 每一次请求都会执行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.before_request</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">before_request</span>():</span><br>    print(<span class="hljs-string">&#x27;before_request&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="after-request"><a href="#after-request" class="headerlink" title="after_request"></a>after_request</h4><p>在每个请求之后注册一个要运行的函数, 每次请求都会执行. 需要接收一个 Response 类的对象作为参数 并返回一个新的Response 对象 或者 直接返回接受到的Response 对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.after_request</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">after_request</span>(<span class="hljs-params">response</span>):</span><br>    print(<span class="hljs-string">&#x27;after_request&#x27;</span>)<br>    <span class="hljs-keyword">return</span> response<br></code></pre></td></tr></table></figure><h4 id="teardown-request"><a href="#teardown-request" class="headerlink" title="teardown_request"></a>teardown_request</h4><p>注册一个函数在每个请求的末尾运行，不管是否有异常, 每次请求的最后都会执行.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.teardown_request</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">teardown_request</span>(<span class="hljs-params">exception</span>):</span><br>    print(<span class="hljs-string">&#x27;teardown_request&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="表单"><a href="#表单" class="headerlink" title="表单"></a>表单</h3><p>在Flask项目开发中针对提交表单的校验，可以使用Flask-WTF扩展库进行快速的字段校验，也可以进行页面快速渲染，并提供跨站请求伪造的保护功能。 </p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> flask-wtf<br></code></pre></td></tr></table></figure><p>form表单验证</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 导入扩展类</span><br><span class="hljs-keyword">from</span> flask_wtf <span class="hljs-keyword">import</span> FlaskForm<br><span class="hljs-comment"># 导入验证字段</span><br><span class="hljs-keyword">from</span> wtforms <span class="hljs-keyword">import</span> StringField, PasswordField, SubmitField, ValidationError<br><span class="hljs-comment"># 导入表单验证（必填/密码是否一致）</span><br><span class="hljs-keyword">from</span> wtforms.validators <span class="hljs-keyword">import</span> DataRequired, EqualTo<br><br><span class="hljs-keyword">from</span> user.models <span class="hljs-keyword">import</span> User<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RegisterForm</span>(<span class="hljs-params">FlaskForm</span>):</span><br><br>    username = StringField(<span class="hljs-string">&#x27;用户名&#x27;</span>, validators=[DataRequired()])<br>    pw = PasswordField(<span class="hljs-string">&#x27;密码&#x27;</span>, validators=[DataRequired()])<br>    pw2 = PasswordField(<span class="hljs-string">&#x27;确认密码&#x27;</span>, validators=[DataRequired(),<br>                      EqualTo(<span class="hljs-string">&#x27;pw&#x27;</span>,<span class="hljs-string">&#x27;密码不一致&#x27;</span>)])<br>    submit = SubmitField(<span class="hljs-string">&#x27;提交&#x27;</span>)<br><br>    <span class="hljs-comment"># 会自动调用验证username,从field.data中取值</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_username</span>(<span class="hljs-params">self, field</span>):</span><br>        <span class="hljs-comment"># 验证用户是否注册</span><br>        <span class="hljs-keyword">if</span> User.query.filter_by(username=field.data).first():<br>            <span class="hljs-keyword">raise</span> ValidationError(<span class="hljs-string">&#x27;用户已经注册！&#x27;</span>)<br>        <span class="hljs-keyword">if</span> len(field.data) &lt; <span class="hljs-number">3</span> :<br>            <span class="hljs-keyword">raise</span> ValidationError(<span class="hljs-string">&#x27;密码长度小于3字符!&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p>view视图函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Blueprint, request, redirect, url_for, render_template<br><span class="hljs-comment"># 加密和解密函数</span><br><span class="hljs-keyword">from</span> werkzeug.security <span class="hljs-keyword">import</span> generate_password_hash, check_password_hash<br><br><span class="hljs-keyword">from</span> user.form <span class="hljs-keyword">import</span> RegisterForm<br><span class="hljs-keyword">from</span> user.models <span class="hljs-keyword">import</span> db, User<br><br><br><span class="hljs-meta">@blue.route(&#x27;/register/&#x27;, methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">register</span>():</span><br>    form = RegisterForm()<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;register.html&#x27;</span>, form=form)<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-comment"># 判断表单中的数据是否验证通过</span><br>        <span class="hljs-keyword">if</span> form.validate_on_submit():<br>            user = User()<br>            user.username = form.username.data<br>            <span class="hljs-comment"># 利用哈希函数进行加密</span><br>            user.password = generate_password_hash(form.pw.data)<br>            db.session.add(user)<br>            db.session.commit()<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;user.login&#x27;</span>))<br><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;register.html&#x27;</span>, form=form)<br></code></pre></td></tr></table></figure><h5 id="加密-解密"><a href="#加密-解密" class="headerlink" title="加密/解密"></a>加密/解密</h5><p>利用flask自带加密和解密函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> werkzeug.security <span class="hljs-keyword">import</span> generate_password_hash, check_password_hash<br><br><span class="hljs-comment"># 加密</span><br>hash_password = generate_password_hash(<span class="hljs-string">&#x27;123456&#x27;</span>)<br><span class="hljs-comment"># 解密 --&gt;    pwhash--密文， password--明文 | 验证成功返回True</span><br>check_password_hash(pwhash, password)  <br></code></pre></td></tr></table></figure><h5 id="模板展示"><a href="#模板展示" class="headerlink" title="模板展示"></a>模板展示</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs html">1. 定义字段名: &#123;&#123; form.字段.label &#125;&#125;<br>2. 定义input输入框: &#123;&#123; form.字段 &#125;&#125;<br>3. 展示错误信息: &#123;&#123; form.errors.字段 &#125;&#125;<br>4. 跨站请求伪造: &#123;&#123; form.csrf_token &#125;&#125;<br><br>例如：<br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>    &#123;&#123; form.csrf_token &#125;&#125;<br>    &#123;&#123; form.username.label &#125;&#125;：&#123;&#123; form.username &#125;&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    &#123;&#123; form.pw.label &#125;&#125;：&#123;&#123; form.pw &#125;&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    &#123;&#123; form.pw2.label &#125;&#125;：&#123;&#123; form.pw2 &#125;&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    &#123;&#123; form.submit &#125;&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br>&#123;&#123; form.errors.username &#125;&#125;<br>&#123;&#123; form.errors.pw &#125;&#125;<br>&#123;&#123; form.errors.pw2 &#125;&#125;<br></code></pre></td></tr></table></figure><h5 id="常见字段类型"><a href="#常见字段类型" class="headerlink" title="常见字段类型"></a>常见字段类型</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">字段类型        说明<br>StringField     普通文本字段<br>PasswordField 密码文本字段<br>SubmitField     提交按钮<br>HiddenField     隐藏文本字段<br>TextAreaField 多行文本字段<br>DateField     文本字段，datetime.date格式<br>DateTimeField 文本字段，datetime.datetime格式<br>IntegerField 文本字段，整数类型<br>FloatField        文本字段，小数类型<br>BooleanField 复选框，值为<span class="hljs-literal">True</span>或<span class="hljs-literal">False</span><br>RadioField        单选框<br>SelectField       下拉列表<br>FileField      文件上传字段<br></code></pre></td></tr></table></figure><h5 id="验证器"><a href="#验证器" class="headerlink" title="验证器"></a>验证器</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">验证器                 说明<br>DataRequired确保字段有值(并且<span class="hljs-keyword">if</span>判断为真)<br>Email        邮箱地址<br>IPAddress    IPv4的IP地址<br>Length        规定字符长度<br>NumberRange 输入数值的范围<br>EqualTo        验证两个字段的一致性<br>URL            有效的URL<br>Regexp        正则验证<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask-模型</title>
    <link href="/Myblog/2018/11/14/Flask-%E6%A8%A1%E5%9E%8B/"/>
    <url>/Myblog/2018/11/14/Flask-%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<p>Flask默认并没有提供任何数据库操作的API</p><p>我们可以选择任何适合自己项目的数据库来使用</p><p>SQLAlchemy是一个很强大的关系型数据库框架，支持多种数据库后台。SQLAlchemy提供了高层ORM，也提供了使用数据库原生SQL的低层功能。</p><p>ORM：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">将对对象的操作转换为原生<span class="hljs-keyword">SQL</span><br>优点<br>易用性，可以有效减少重复<span class="hljs-keyword">SQL</span><br>性能损耗少<br>设计灵活，可以轻松实现复杂查询<br>移植性好<br></code></pre></td></tr></table></figure><h3 id="模型定义"><a href="#模型定义" class="headerlink" title="模型定义"></a>模型定义</h3><p>安装flask-sqlalchemy和pymysql</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> flask-sqlalchemy<br>pip <span class="hljs-keyword">install</span> pymysql<br></code></pre></td></tr></table></figure><p>应用models.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask_sqlalchemy <span class="hljs-keyword">import</span>  SQLAlchemy<br><br>db = SQLAlchemy()<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">db.Model</span>):</span><br>    id = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>)<br>    username = db.Column(db.String(<span class="hljs-number">10</span>), unique=<span class="hljs-literal">True</span>)<br>    password = db.Column(db.String(<span class="hljs-number">100</span>), unique=<span class="hljs-literal">True</span>)<br><br>    __tablename__ = <span class="hljs-string">&#x27;user&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">其中：<br><br><span class="hljs-type">Integer</span>表示创建的s_id字段的类型为整形，<br>primary_key表示是否为主键<br>String表示该字段为字符串<br><span class="hljs-keyword">unique</span>表示该字段唯一<br>nullable表示字段是否为空<br><span class="hljs-keyword">default</span>表示默认值<br>autoincrement表示是否自增<br></code></pre></td></tr></table></figure><p>数据库连接的格式</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sqf">dialect+<span class="hljs-built_in">driver</span>:<span class="hljs-comment">//username:password@host:port/database</span><br><br>dialect数据库实现<br><span class="hljs-built_in">driver</span>数据库的驱动<br></code></pre></td></tr></table></figure><p>配置文件修改</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> app.modles <span class="hljs-keyword">import</span> db<br><br><span class="hljs-comment"># 数据库的配置</span><br>app.config[<span class="hljs-string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="hljs-string">&quot;mysql+pymysql://root:123456@localhost:3306/flask&quot;</span><br>app.config[<span class="hljs-string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="hljs-literal">False</span>   <span class="hljs-comment"># 不写会有警告信息</span><br><span class="hljs-comment"># 初始化app和db</span><br>db.init_app(app)<br></code></pre></td></tr></table></figure><p>迁徙生成表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> app.modles <span class="hljs-keyword">import</span> db<br><br><span class="hljs-meta">@blue.route(&#x27;/&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_db</span>():</span><br>    <span class="hljs-comment"># 第一次迁移模型，创建表</span><br>    db.create_all()<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;创建模型成功&#x27;</span><br><br></code></pre></td></tr></table></figure><p>删除表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.route(&#x27;/drop_db/&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">drop_db</span>():</span><br>    <span class="hljs-comment"># 删除模型</span><br>    db.drop_all()<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;删除模型成功&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="数据库迁移"><a href="#数据库迁移" class="headerlink" title="数据库迁移"></a>数据库迁移</h3><p>在flask中也有migrate操作，它能跟踪模型的变化，并将变化映射到数据库中。</p><ol><li>安装migrate</li></ol><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> flask-migrate<br></code></pre></td></tr></table></figure><ol start="2"><li>配置migrate</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask_migrate <span class="hljs-keyword">import</span> Migrate, MigrateCommand<br><br>migrate = Migrate(app, db)<br><br>manage.add_command(<span class="hljs-string">&#x27;db&#x27;</span>, MigrateCommand)<br></code></pre></td></tr></table></figure><ol start="3"><li>操作</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">python manage.py db init       初始化数据库,会创建一个migations文件夹,并且在迁移时会在数据库中生成一个alembic_version表<br>python manage.py db migrate    生成迁移文件<br>python manage.py db upgrade    执行迁移文件中的升级<br>python manage.py db downgrade  执行迁移文件中的降级<br>python manage.py db --help     帮助文档<br></code></pre></td></tr></table></figure><h3 id="模型的CRUD操作"><a href="#模型的CRUD操作" class="headerlink" title="模型的CRUD操作"></a>模型的CRUD操作</h3><ul><li>添加</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.session</span><span class="hljs-selector-class">.add</span>(对象1)<br><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.session</span><span class="hljs-selector-class">.add_all</span>(<span class="hljs-selector-attr">[对象1,对象2,...]</span>)<br><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.session</span><span class="hljs-selector-class">.commit</span>()<br></code></pre></td></tr></table></figure><p><strong>第一种方式</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.route(&#x27;/add_stu&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_stu</span>():</span><br>    <span class="hljs-comment"># 插入数据</span><br>    stu = Student()<br>    stu.s_name = <span class="hljs-string">&#x27;小明&#x27;</span><br>    <span class="hljs-comment"># 向数据库发出insert语句，但是由于事务原因，当提交commit时，才会生效</span><br>    db.session.add(stu)<br>    db.session.commit()<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;创建学生成功！&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>第二种方式</strong></p><p>可以在模型文件中将提交语句<strong>封装成方法</strong>，后面的操作都可以对应封装成方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save</span>(<span class="hljs-params">self</span>):</span><br>    db.session.add(self)<br>    db.session.commit()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.route(&#x27;/add_stu&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_stu</span>():</span><br>    <span class="hljs-comment"># 插入数据</span><br>    stu = Student()<br>    stu.s_name = <span class="hljs-string">&#x27;小明&#x27;</span><br>    stu.save()<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;创建学生成功！&#x27;</span><br></code></pre></td></tr></table></figure><ul><li>删除</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.route(&#x27;/add_stu&#x27;, methods=[&#x27;DELETE&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">del_stu</span>():</span><br>    <span class="hljs-comment"># 删除数据</span><br>    stu = Student.query.filter(Student.s_name==<span class="hljs-string">&#x27;小花&#x27;</span>).first()<br>    db.session.delete(stu)<br>    db.session.commit()<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;删除学生成功&#x27;</span><br></code></pre></td></tr></table></figure><ul><li>更新</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.route(&#x27;/up_stu&#x27;, methods=[&#x27;PATCH&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">up_stu</span>():</span><br>    <span class="hljs-comment"># 第一种方式</span><br>    stu = Student.query.filter(Student.s_name==<span class="hljs-string">&#x27;小花&#x27;</span>).first()<br>    stu.s_name = <span class="hljs-string">&#x27;小明&#x27;</span><br>    db.session.add(stu)<br>    db.session.commit()<br>    <br>    <span class="hljs-comment"># 第二种方式，使用update</span><br>    Student.query.filter(Student.s_name==<span class="hljs-string">&#x27;小明&#x27;</span>).update(&#123;<span class="hljs-string">&#x27;s_name&#x27;</span>:<span class="hljs-string">&#x27;小花&#x27;</span>&#125;)<br>    <span class="hljs-comment"># Student.query.filter(Student.s_name==&#x27;小明&#x27;).update(&#123;&#x27;s_name&#x27;:&#x27;小花&#x27;&#125;, synchronize_session=False)</span><br>    db.session.commit()<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;更新学生成功&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p>说明：update和delete操作是指定synchronize_session=False不同步更新session； synchronize_session= fetch 更新之前进行查询，获取最新的更新对象。</p></blockquote><ul><li><p>查询</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">Student.query.filter_by(s_name=<span class="hljs-string">&#x27;小明&#x27;</span>).first() <br>Student.query.filter(Student.s_name==<span class="hljs-string">&#x27;小明&#x27;</span>).first()  <br><span class="hljs-comment"># get()方法获取主键所在行的对象，获取不到返回空</span><br>Student.query.get(<span class="hljs-number">1</span>)  <br></code></pre></td></tr></table></figure><p>all（）：查询所有结果，返回列表</p><p>first（）：返回对象</p><p>注意：不能写all().first() – 列表没有first()方法</p></li></ul><p>  <strong>使用运算符进行查询</strong></p><p>  获取查询集</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">filter(类名.属性.运算符(<span class="hljs-string">&#x27;xxx&#x27;</span>))<br>filter(类名.属性 数学运算符 值)<br></code></pre></td></tr></table></figure><p>  运算符：</p>  <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">contains： 包含<br>startswith：以什么开始<br>endswith：以什么结束<br>like：模糊    %：代表一个或者多个字符。    _：代表一个字符。<br>in_：在范围内<br>__gt__: 大于<br>__ge__：大于等于<br>__lt__：小于<br>__le__：小于等于<br><br>例如：<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>query.filter(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>s_age.<span class="hljs-constructor">__lt__(15)</span>)<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>query.filter(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>s_name.startswith(<span class="hljs-character">&#x27;张&#x27;</span>))<br>Student = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>query.order<span class="hljs-constructor">_by(Student.<span class="hljs-params">id</span>.<span class="hljs-params">desc</span>()</span>).all<span class="hljs-literal">()</span>  # 以id降序排序<br></code></pre></td></tr></table></figure><p>  筛选：</p>  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">offset</span><span class="hljs-params">(n)</span></span>                         结果跳过n个信息<br><span class="hljs-function"><span class="hljs-title">limit</span><span class="hljs-params">(n)</span></span>                          得到结果的n个值<br>order_by（<span class="hljs-string">&#x27;-id&#x27;</span>）                  以 id 降序排序 <br><span class="hljs-function"><span class="hljs-title">get</span><span class="hljs-params">()</span></span>                             获取主键所在行的对象，获取不到返回空<br><span class="hljs-function"><span class="hljs-title">first</span><span class="hljs-params">()</span></span>                           得到结果的第一个值<br><span class="hljs-function"><span class="hljs-title">paginate</span><span class="hljs-params">(page, per_page)</span></span>          分页，下面会详细说明<br></code></pre></td></tr></table></figure><p>  paginate()属性说明：</p>   <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros">items      当前页面中的记录<br>query      分页的源查询<br>page       当前页数<br>prev_num   上一页的页数<br>next_num   下一页的页数<br>has_prev   如果有上一页，返回<span class="hljs-literal">False</span><br>has_next   如果有下一页，返回<span class="hljs-literal">True</span><br>pages      查询得到的总页数<br>per_page   每页显示的记录数量<br>total      查询返回的记录总数<br><br></code></pre></td></tr></table></figure><p>  后端数据处理：</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 方法一：手动实现分页，使用offset和limit</span><br>page = int(request.args.get(<span class="hljs-string">&#x27;page&#x27;</span>, <span class="hljs-number">1</span>))<br>stus = Student.query.offset((page<span class="hljs-number">-1</span>)*<span class="hljs-number">5</span>).limit(<span class="hljs-number">5</span>)<br><br><span class="hljs-comment"># 方法二： 使用切片[:]</span><br>s_page = (page - <span class="hljs-number">1</span>)*<span class="hljs-number">5</span><br>e_page = page * <span class="hljs-number">5</span><br>stus = Student.query.all()[s_page: e_page]<br><br><span class="hljs-comment"># 方法三：使用paginate -- 推荐</span><br>page = request.args.get(<span class="hljs-string">&#x27;page&#x27;</span>,<span class="hljs-number">1</span>)<br>paginates = Student.query.paginate(int(page),<span class="hljs-number">3</span>)<br>stus = paginates.items<br></code></pre></td></tr></table></figure><pre><code>前端数据展示：</code></pre>  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html">&#123;% for stu in stus %&#125;<br>    ID:&#123;&#123; stu.id &#125;&#125;<br>    姓名:&#123;&#123; stu.s_name &#125;&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>&#123;% endfor %&#125;<br><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>当前一共&#123;&#123; paginates.pages &#125;&#125;页<br>&#123;% if paginates.has_prev %&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&#123;&#123; url_for(&#x27;user.sel_stu&#x27;) &#125;&#125;?page=&#123;&#123; paginates.prev_num &#125;&#125;&quot;</span>&gt;</span>上一页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>&#123;% endif %&#125;<br>&#123;% for i in range(1, paginates.pages+1) %&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&#123;&#123; url_for(&#x27;user.sel_stu&#x27;) &#125;&#125;?page=&#123;&#123; i &#125;&#125;&quot;</span>&gt;</span>&#123;&#123; i &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>&#123;% endfor %&#125;<br>&#123;% if paginates.has_next %&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&#123;&#123; url_for(&#x27;user.sel_stu&#x27;) &#125;&#125;?page=&#123;&#123; paginates.next_num &#125;&#125;&quot;</span>&gt;</span>下一页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>&#123;% endif %&#125;<br></code></pre></td></tr></table></figure><p>  逻辑运算：</p>  <figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> and_, not_, or_<br><br>与<br>and_<br>filter(and_(条件<span class="hljs-number">1</span>,条件<span class="hljs-number">2</span>…))<br><br>或<br>or_<br>filter(or_(条件<span class="hljs-number">1</span>,条件<span class="hljs-number">2</span>…))<br><br>非<br>not_<br>filter(not_(条件<span class="hljs-number">1</span>),条件<span class="hljs-number">2</span>…)<br></code></pre></td></tr></table></figure><h3 id="模型对应关系"><a href="#模型对应关系" class="headerlink" title="模型对应关系"></a>模型对应关系</h3><h4 id="一对多（1：N）"><a href="#一对多（1：N）" class="headerlink" title="一对多（1：N）"></a>一对多（1：N）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>(<span class="hljs-params">db.Model</span>):</span><br>    id = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>)<br>    s_name = db.Column(db.String(<span class="hljs-number">10</span>), unique=<span class="hljs-literal">True</span>, nullable=<span class="hljs-literal">False</span>)<br>    gender = db.Column(db.Boolean, default=<span class="hljs-number">1</span>)<br>    grade_id = db.Column(db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;grade.id&#x27;</span>), nullable=<span class="hljs-literal">False</span>)   <br><br>    __tablename__=<span class="hljs-string">&#x27;student&#x27;</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Grade</span>(<span class="hljs-params">db.Model</span>):</span><br>    id = db.Column(db.Integer, primary_key = <span class="hljs-literal">True</span>, autoincrement = <span class="hljs-literal">True</span>)<br>    g_name = db.Column(db.String(<span class="hljs-number">10</span>), nullable=<span class="hljs-literal">False</span>, unique=<span class="hljs-literal">True</span>)<br>    student = db.relationship(<span class="hljs-string">&#x27;Student&#x27;</span>, backref=<span class="hljs-string">&#x27;g&#x27;</span>)<br><br>    __tablename__ = <span class="hljs-string">&#x27;grade&#x27;</span><br><br></code></pre></td></tr></table></figure><ul><li>学生指定班级(正向查询)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">stu = Student.query.filter(Student.s_name==<span class="hljs-string">&#x27;乔峰&#x27;</span>).first()<br>grade = stu.g<br></code></pre></td></tr></table></figure><ul><li>班级指定学生(反向查询)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">grade = Grade.query.get(<span class="hljs-number">2</span>)<br>student = grade.student<br></code></pre></td></tr></table></figure><h4 id="多对多（N-M）"><a href="#多对多（N-M）" class="headerlink" title="多对多（N:M）"></a>多对多（N:M）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>(<span class="hljs-params">db.Model</span>):</span><br>    id = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>)<br>    s_name = db.Column(db.String(<span class="hljs-number">10</span>), unique=<span class="hljs-literal">True</span>, nullable=<span class="hljs-literal">False</span>)<br>    gender = db.Column(db.Boolean, default=<span class="hljs-number">1</span>)<br>    grade_id = db.Column(db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;grade.id&#x27;</span>), nullable=<span class="hljs-literal">False</span>)<br><br>    __tablename__=<span class="hljs-string">&#x27;student&#x27;</span><br><br><span class="hljs-comment"># 中间表</span><br>s_c = db.Table(<span class="hljs-string">&#x27;s_c&#x27;</span>,<br>               db.Column(<span class="hljs-string">&#x27;s_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;student.id&#x27;</span>)),<br>                db.Column(<span class="hljs-string">&#x27;c_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;course.id&#x27;</span>))<br>               )<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Course</span>(<span class="hljs-params">db.Model</span>):</span><br>    id = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>, autoincrement=<span class="hljs-literal">True</span>)<br>    c_name = db.Column(db.String(<span class="hljs-number">10</span>), nullable=<span class="hljs-literal">True</span>, unique=<span class="hljs-literal">True</span>)<br>    student = db.relationship(<span class="hljs-string">&#x27;Student&#x27;</span>, secondary=s_c, backref=<span class="hljs-string">&#x27;cou&#x27;</span>)<br><br>    __tablename__ = <span class="hljs-string">&#x27;course&#x27;</span><br></code></pre></td></tr></table></figure><p>添加/删除关联关系</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">stu = Student.query.get(s_id)<br>cou = Course.query.get(cou_id)<br><br><span class="hljs-comment"># 两种方式添加关联关系 -- 正向/反向</span><br>stu.cou.append(cou)<br>cou.student.append(stu)<br><br><span class="hljs-comment"># 删除关联关系 -- 正向/反向</span><br>stu.cou.remove(cou)<br>cou.student.append(stu)<br><br><span class="hljs-comment"># 提交 -- 成功后会在中间表中添加对应关系</span><br>db.session.commit()<br></code></pre></td></tr></table></figure><ul><li>学生指定课程(正向查询)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">stu.cou <span class="hljs-comment">#得到一个学生对应的课程列表</span><br><br>stu.cou[<span class="hljs-number">0</span>].c_name<br></code></pre></td></tr></table></figure><ul><li>课程指定学生(反向查询)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">cou.student <span class="hljs-comment"># 得到一个课程对应的学生列表</span><br><br>cou.student[<span class="hljs-number">0</span>].s_name<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask-Session和Cookie</title>
    <link href="/Myblog/2018/11/13/Flask-Session%E5%92%8CCookie/"/>
    <url>/Myblog/2018/11/13/Flask-Session%E5%92%8CCookie/</url>
    
    <content type="html"><![CDATA[<h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><h4 id="存放-–-gt-客户端"><a href="#存放-–-gt-客户端" class="headerlink" title="存放 –&gt; 客户端"></a>存放 –&gt; 客户端</h4><p>创建： </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">Cookie是通过服务器创建的Response来创建的<br><br>设置：set_cookie(<span class="hljs-string">&#x27;key&#x27;</span>, value, max_ages=<span class="hljs-string">&#x27;&#x27;</span>, expires=<span class="hljs-string">&#x27;&#x27;</span>)<br><br>删除, 有三种删除方式<br><br><span class="hljs-number">1.</span> 直接清空浏览器的cookie<br><span class="hljs-number">2.</span> delete_cookie(<span class="hljs-string">&#x27;key&#x27;</span>) 直接使用delete_cookie函数<br><span class="hljs-number">3.</span> set_cookie(<span class="hljs-string">&#x27;key&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,expires=<span class="hljs-number">0</span>) 重新设置key的值为空，过期时间为<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>获取： </p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vbscript">在每次请求中，url都会向服务器传递<span class="hljs-built_in">Request</span>，在<span class="hljs-built_in">request</span>中可以获取到cookie的信息<br><span class="hljs-built_in">request</span>.cookies.<span class="hljs-keyword">get</span>(<span class="hljs-comment">&#x27;name&#x27;)</span><br></code></pre></td></tr></table></figure><p>例子1，设置cookie： </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-meta">@blue.route(&#x27;/setcookie/&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_cookie</span>():</span><br>    temp = render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>)<br>    response = make_response(temp)<br>outdate=datetime.datetime.today() + datetime.timedelta(days=<span class="hljs-number">30</span>)<br><span class="hljs-comment"># 设置cookie中的name的存在时长，设置为30天才过期  </span><br>    response.set_cookie(<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;cocoococo&#x27;</span>,expires=outdate)<br>    <span class="hljs-keyword">return</span> response<br></code></pre></td></tr></table></figure><p>例子2，删除cookie中的值 :</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.route(&#x27;/setcookie/&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_cookie</span>():</span><br>    temp = render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>)<br>    response = make_response(temp)<br><span class="hljs-comment"># 第一种方式，通过set_cookie去删除</span><br>    response.set_cookie(<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,expires=<span class="hljs-number">0</span>)<br><span class="hljs-comment"># 第二种方式，del_cookie删除</span><br>response.del_cookie(<span class="hljs-string">&#x27;name&#x27;</span>)<br>    <span class="hljs-keyword">return</span> response<br></code></pre></td></tr></table></figure><p>例子3，获取cookie中的值 :</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.route(&#x27;/getcookie/&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_cookie</span>():</span><br>    name=request.cookies.get(<span class="hljs-string">&#x27;name&#x27;</span>)  <br>    <span class="hljs-keyword">return</span> name<br></code></pre></td></tr></table></figure><h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><h4 id="存放-–-gt-服务器端"><a href="#存放-–-gt-服务器端" class="headerlink" title="存放 –&gt; 服务器端"></a>存放 –&gt; 服务器端</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> <span class="hljs-keyword">session</span><br></code></pre></td></tr></table></figure><p>设置cookie</p><figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gml">session[<span class="hljs-string">&#x27;user_id&#x27;</span>] = <span class="hljs-symbol">id</span><br></code></pre></td></tr></table></figure><p>读取session</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">result</span> = session[<span class="hljs-string">&#x27;key&#x27;</span>] ：如果内容不存在，将会报异常<br><span class="hljs-attr">result</span> = session.get(<span class="hljs-string">&#x27;key&#x27;</span>) ：如果内容不存在，将返回None<br></code></pre></td></tr></table></figure><p>删除session</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">session.<span class="hljs-keyword">pop</span>(<span class="hljs-string">&#x27;key&#x27;</span>)<br></code></pre></td></tr></table></figure><p>清空session中所有数据</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">session.<span class="hljs-built_in">clear</span>()<br></code></pre></td></tr></table></figure><p>设置加密的secret_key</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 设置加密的复杂程度</span><br><span class="hljs-attr">app.secret_key</span> = <span class="hljs-string">&#x27;qazxswedcvfrtgbnhyujmkiolp&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="存放-–-gt-数据库"><a href="#存放-–-gt-数据库" class="headerlink" title="存放 –&gt; 数据库"></a>存放 –&gt; 数据库</h4><p>flask-session是flask框架的session组件</p><p>该组件则将支持session保存到多个地方</p><p>如： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">redis：保存数据的一种工具，五大类型。非关系型数据库<br><br>memcached<br><br>mongodb<br><br>sqlalchmey：那数据存到数据库表里面<br></code></pre></td></tr></table></figure><p>安装</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">pip <span class="hljs-keyword">install</span> flask-<span class="hljs-keyword">session</span><br></code></pre></td></tr></table></figure><p>如果指定存session的类型为redis的话，需要安装redis </p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> redis<br></code></pre></td></tr></table></figure><p>设置：</p><p>代码本身没有任何变化，只是session的存储位置会自动保存在redis中，可以通过浏览器中的session取到数据库中的存储的值。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> flask_session <span class="hljs-keyword">import</span> Session<br><span class="hljs-keyword">import</span> redis<br><br><span class="hljs-comment"># 配置session存储数据库</span><br>app.config[<span class="hljs-string">&#x27;SESSION_TYPE&#x27;</span>] = <span class="hljs-string">&#x27;redis&#x27;</span><br>app.config[<span class="hljs-string">&#x27;SESSION_REDIS&#x27;</span>] = redis.Redis(host=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, port=<span class="hljs-number">6379</span>)<br><span class="hljs-comment"># 第一种：初始化flask对象app</span><br>Session(app)<br><span class="hljs-comment"># 第二种：初始化flask对象app</span><br><span class="hljs-comment"># sess = Session()</span><br><span class="hljs-comment"># sess.init_app(app)</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flask基础</title>
    <link href="/Myblog/2018/11/12/Flask%E5%9F%BA%E7%A1%80/"/>
    <url>/Myblog/2018/11/12/Flask%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h3 id="一-Flask介绍"><a href="#一-Flask介绍" class="headerlink" title="一. Flask介绍"></a>一. Flask介绍</h3><h4 id="1-Flask介绍"><a href="#1-Flask介绍" class="headerlink" title="1. Flask介绍"></a>1. Flask介绍</h4><p>Flask是一个基于Python实现的web开发的<strong>微</strong>框架</p><p><a href="http://docs.jinkan.org/docs/flask/">中文文档地址</a></p><p><a href="http://flask.pocoo.org/extensions">flask扩展三方库</a></p><h3 id="二-安装Flask"><a href="#二-安装Flask" class="headerlink" title="二. 安装Flask"></a>二. 安装Flask</h3><h4 id="1-虚拟环境搭建"><a href="#1-虚拟环境搭建" class="headerlink" title="1.虚拟环境搭建"></a>1.虚拟环境搭建</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs applescript">virtualenv <span class="hljs-comment">--no-site-packages flaskenv</span><br><br>激活windows下虚拟环境<br>cd Scripts<br><span class="hljs-built_in">activate</span><br></code></pre></td></tr></table></figure><h4 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> flask<br></code></pre></td></tr></table></figure><h3 id="三-基于Flask的最小的应用"><a href="#三-基于Flask的最小的应用" class="headerlink" title="三. 基于Flask的最小的应用"></a>三. 基于Flask的最小的应用</h3><p>创建hello.py文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(&#x27;/&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hello_world</span>():</span><br><span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Hello World&#x27;</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>app.run()<br></code></pre></td></tr></table></figure><p>运行：python hello.py </p><h4 id="1-初始化"><a href="#1-初始化" class="headerlink" title="1. 初始化"></a>1. 初始化</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><br>app = Flask(__name__)<br></code></pre></td></tr></table></figure><p>Flask类构造函数唯一需要的参数就是应用程序的主模块或包。对于大多数应用程序，Python的__name__变量就是那个正确的、你需要传递的值。Flask使用这个参数来确定应用程序的根目录，这样以后可以相对这个路径来找到资源文件。</p><h4 id="2-路由"><a href="#2-路由" class="headerlink" title="2. 路由"></a>2. 路由</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@app</span>.route(<span class="hljs-string">&#x27;/&#x27;</span>)<br></code></pre></td></tr></table></figure><p>客户端例如web浏览器发送 请求 给web服务，进而将它们发送给Flask应用程序实例。应用程序实例需要知道对于各个URL请求需要运行哪些代码，所以它给Python函数建立了一个URLs映射。这些在URL和函数之间建立联系的操作被称之为 路由 。</p><p>在Flask应程序中定义路由的最便捷的方式是通过显示定义在应用程序实例之上的app.route装饰器，注册被装饰的函数来作为一个路由。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.route(&#x27;/xxx/&lt;int:id&gt;/&#x27;)</span><br><span class="hljs-comment"># 路由匹配规则</span><br><span class="hljs-comment"># 语法：&lt;选择器：参数名&gt;</span><br><br>string 字符串(默认)<br>int 整形<br>float 浮点型<br>path 接受路径，接收的时候是str，/也当做字符串的一个字符<br>uuid 只接受uuid字符串<br>any 可以同时指定多种路径，进行限定<br></code></pre></td></tr></table></figure><h4 id="3-服务启动"><a href="#3-服务启动" class="headerlink" title="3. 服务启动"></a>3. 服务启动</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>app.<span class="hljs-builtin-name">run</span>()<br></code></pre></td></tr></table></figure><p>run()中参数有如下：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">debug</span> 是否开启调试模式，开启后修改python的代码会自动重启<br><br>port 启动指定服务器的端口号<br><br>host主机，默认是127.0.0.1<br></code></pre></td></tr></table></figure><h3 id="四-修改启动方式，使用命令行参数启动服务"><a href="#四-修改启动方式，使用命令行参数启动服务" class="headerlink" title="四. 修改启动方式，使用命令行参数启动服务"></a>四. 修改启动方式，使用命令行参数启动服务</h3><p>因为我们启动方式不可能写在代码中，所以需要修改启动方法，让命令行中可以启动服务。</p><h4 id="1-安装插件"><a href="#1-安装插件" class="headerlink" title="1. 安装插件"></a>1. 安装插件</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">pip install flask-<span class="hljs-keyword">script</span><br></code></pre></td></tr></table></figure><p>调整代码 <code>manager = Manager(app=&#39;自定义的flask对象&#39;) </code></p><p>启动的地方<code>manager.run()</code></p><h4 id="2-启动命令"><a href="#2-启动命令" class="headerlink" title="2. 启动命令"></a>2. 启动命令</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python hellow<span class="hljs-selector-class">.py</span> runserver -h 地址 -<span class="hljs-selector-tag">p</span> 端口 -d -r<br></code></pre></td></tr></table></figure><p>说明：-h表示地址。-p表示端口。-d表示debug模式。-r表示自动重启</p><h3 id="五、蓝图"><a href="#五、蓝图" class="headerlink" title="五、蓝图"></a>五、蓝图</h3><h4 id="1-安装蓝图"><a href="#1-安装蓝图" class="headerlink" title="1.安装蓝图"></a>1.安装蓝图</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> flask_blueprint<br></code></pre></td></tr></table></figure><p>第一步，生成蓝图对象，使用蓝图对象管理路由（自定义视图函数）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Blueprint, redirect, url_for, request<br><br><span class="hljs-comment"># 第一步，生成蓝图对象，使用蓝图对象管理路由</span><br>app_bluepring = Blueprint(<span class="hljs-string">&#x27;app&#x27;</span>, __name__)<br><br><br><span class="hljs-meta">@app_bluepring.route(&#x27;/student/&lt;int:id&gt;/&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">student</span>(<span class="hljs-params">id</span>):</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;学号为%d的学霸&#x27;</span>% id<br><br><span class="hljs-meta">@app_bluepring.route(&#x27;/redirect/&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">redirect_url</span>():</span><br>    <span class="hljs-comment"># 传参</span><br>    <span class="hljs-comment"># Django写法: HttpResponseRedirect(reverse(&#x27;namespace:name&#x27;))</span><br>    <span class="hljs-comment"># Flask写法： redirect(url_for(&#x27;蓝图名称.跳转的函数名&#x27;， key=value))</span><br>    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;app.student&#x27;</span>, id=<span class="hljs-number">100</span>))<br></code></pre></td></tr></table></figure><p>第二步，注册蓝图(在执行文件注册蓝图)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask_script <span class="hljs-keyword">import</span> Manager<br><br><span class="hljs-keyword">from</span> app.views <span class="hljs-keyword">import</span> app_bluepring<br><br>app = Flask(__name__)<br><br><span class="hljs-comment"># 第二步，注册蓝图</span><br>app.register_blueprint(blueprint=app_bluepring, url_prefix=<span class="hljs-string">&#x27;/app&#x27;</span>)<br><br><span class="hljs-comment"># 使用Manager管理app对象</span><br>manage = Manager(app)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    manage.run()<br></code></pre></td></tr></table></figure><h3 id="六、响应请求"><a href="#六、响应请求" class="headerlink" title="六、响应请求"></a>六、响应请求</h3><h4 id="1-请求"><a href="#1-请求" class="headerlink" title="1.请求"></a>1.请求</h4><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vbscript"><span class="hljs-built_in">request</span>请求：<br><br>获取<span class="hljs-keyword">get</span>请求:<span class="hljs-built_in">request</span>.args<br>获取post请求:<span class="hljs-built_in">request</span>.form<br>获取上传文件:<span class="hljs-built_in">request</span>.files<br>获取路径:<span class="hljs-built_in">request</span>.path<br>请求方式:<span class="hljs-built_in">request</span>.method<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app_bluepring.route(&#x27;/hello&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hello</span>():</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-comment"># 获取get提交请求传递的参数：request.args</span><br>        <span class="hljs-comment"># request.args.get(key)或request.arg[key]</span><br>        <span class="hljs-comment"># request.args.getlist(key)可以取多个值</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;我是get请求。&#x27;</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-comment"># 获取post提交请求传递的参数：request.form</span><br>        <span class="hljs-comment"># request.form.get(key)或request.form[key]</span><br>        <span class="hljs-comment"># request.form.getlist(key)可以取多个值</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;我是post请求。&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="2-响应"><a href="#2-响应" class="headerlink" title="2.响应"></a>2.响应</h4><p>响应是后端产生返回给前端（浏览器）</p><p>创建方法： </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> make_response<br><br><span class="hljs-meta">@app_bluepring.route(&#x27;/make_response/&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_my_response</span>():</span><br>    res = make_response(<span class="hljs-string">&#x27;&lt;h2&gt;你是真的帅！&lt;/h2&gt;&#x27;</span>)<br>    <span class="hljs-comment"># 响应绑定cookie。 set_cookie/delete_cookie</span><br>    <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure><p>状态码：</p><p>格式：make_response(data，code)，其中data是返回的数据内容，code是状态码。<br>一般不写，默认状态码为200</p><h3 id="七、传参"><a href="#七、传参" class="headerlink" title="七、传参"></a>七、传参</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 第一种</span><br>&lt;a href=&quot;&#123;&#123; url_for(&#x27;user.sel_stu&#x27;) &#125;&#125;?page=&#123;&#123; i &#125;&#125;&quot;&gt;&#123;&#123; i &#125;&#125;&lt;/a&gt;<br><span class="hljs-comment"># 第二种</span><br>&lt;a href=&quot;&#123;&#123; url_for(&#x27;user.cous&#x27;, id=stu.id) &#125;&#125;&quot;&gt;添加学生课程&lt;/a&gt;<br></code></pre></td></tr></table></figure><h3 id="八、异常抛出和捕获"><a href="#八、异常抛出和捕获" class="headerlink" title="八、异常抛出和捕获"></a>八、异常抛出和捕获</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> <span class="hljs-keyword">abort</span><br></code></pre></td></tr></table></figure><h4 id="1-异常抛出"><a href="#1-异常抛出" class="headerlink" title="1.异常抛出"></a>1.异常抛出</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app_bluepring.route(&#x27;/abort_a/&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">abort_a</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;除数为0抛出异常&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        a = request.form.get(<span class="hljs-string">&#x27;a&#x27;</span>)<br>        b = request.form.get(<span class="hljs-string">&#x27;b&#x27;</span>)<br>        c = int(a)/int(b)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;%s/%s=%s&#x27;</span> % (a, b, c)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-comment"># 异常抛出</span><br>        abort(<span class="hljs-number">500</span>)<br></code></pre></td></tr></table></figure><h4 id="2-异常捕获"><a href="#2-异常捕获" class="headerlink" title="2.异常捕获"></a>2.异常捕获</h4><p>捕获异常处理：errorhandler(状态码)，定义的函数中要包含一个参数，用于接收异常信息 </p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ruby">@app_bluepring.errorhandler(<span class="hljs-number">500</span>)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">error_handler</span><span class="hljs-params">(error)</span></span><span class="hljs-symbol">:</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Exception is %s&#x27;</span>% error<br></code></pre></td></tr></table></figure><h3 id="九、渲染页面"><a href="#九、渲染页面" class="headerlink" title="九、渲染页面"></a>九、渲染页面</h3><p>导入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> render_template<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login</span>():</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;login.html&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="十、模板页面"><a href="#十、模板页面" class="headerlink" title="十、模板页面"></a>十、模板页面</h3><p>加载方式</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--第一种加载方式--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/static/css/style.css/&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!--第二种加载方式--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;css/style.css/&#x27;) &#125;&#125;&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>给页面传递参数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@blue.route(&#x27;/temp/&#x27;, methods=[&#x27;get&#x27;])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">temp</span>():</span><br>    content = [<span class="hljs-string">&#x27;Python&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;Java&#x27;</span>, <span class="hljs-string">&#x27;C++&#x27;</span>]<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;temp.html&#x27;</span>, title=<span class="hljs-string">&#x27;模板语法&#x27;</span>, content=content)<br></code></pre></td></tr></table></figure><p>页面加载</p><ul><li>django中循环计数为forloop.counter</li><li>flask中循环计数为loop.index</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html">&#123;% for i in content %&#125;<br>    &#123;% if loop.index == 1 %&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; i &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    &#123;% else %&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>&#123;&#123; i &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span><br>    &#123;% endif %&#125;<br>&#123;% endfor %&#125;<br></code></pre></td></tr></table></figure><h5 id="宏定义"><a href="#宏定义" class="headerlink" title="宏定义"></a>宏定义</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs html">   <span class="hljs-comment">&lt;!--宏定义 - 声明函数 --&gt;</span><br>   &#123;% macro hello() %&#125;<br>       <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello, World!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>   &#123;% endmacro %&#125;<br><br>   <span class="hljs-comment">&lt;!--调用--&gt;</span><br>   &#123;&#123; hello() &#125;&#125;<br><br>  <br><span class="hljs-comment">&lt;!--也可以进行传参--&gt;</span><br>   &#123;% macro hello(name) %&#125;<br>       <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello, &#123;&#123; name &#125;&#125;!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>   &#123;% endmacro %&#125;<br><br>   &#123;&#123; hello(&#x27;world&#x27;) &#125;&#125;<br><br></code></pre></td></tr></table></figure><p><strong>创建function.html页面存放宏定义函数，其他页面可以进行导入(function页面中不能有网站的基础架构)。</strong></p><p>导入格式：</p><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs clojure">&#123;% from &#x27;function.html&#x27; import hello %&#125;<br><br>&#123;&#123; hello() &#125;&#125;<br></code></pre></td></tr></table></figure><p>过滤器使用和django类似</p>]]></content>
    
    
    <categories>
      
      <category>Flask</category>
      
    </categories>
    
    
    <tags>
      
      <tag>flask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django-国际化</title>
    <link href="/Myblog/2018/11/09/Django-%E5%9B%BD%E9%99%85%E5%8C%96/"/>
    <url>/Myblog/2018/11/09/Django-%E5%9B%BD%E9%99%85%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<p>所谓的国际化，是指使用不同语言的用户在访问同一个网站页面时能够看到符合其自身语言的文本页面。 用户可以选择对应的语言浏览网页。</p><h4 id="配置setting-py"><a href="#配置setting-py" class="headerlink" title="配置setting.py"></a>配置setting.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">LANGUAGES = (<br>    (<span class="hljs-string">&#x27;en&#x27;</span>, (<span class="hljs-string">&#x27;English&#x27;</span>)),<br>    (<span class="hljs-string">&#x27;zh-hans&#x27;</span>, (<span class="hljs-string">&#x27;中文简体&#x27;</span>)),<br>    (<span class="hljs-string">&#x27;zh-hant&#x27;</span>, (<span class="hljs-string">&#x27;中文繁體&#x27;</span>)),<br>)<br><br>MIDDLEWARE = [<br>    <span class="hljs-string">&#x27;django.middleware.locale.LocaleMiddleware&#x27;</span>,   <span class="hljs-comment"># 添加此行</span><br>]<br><br><span class="hljs-comment"># 翻译文件所在目录，需要手工创建</span><br>LOCALE_PATHS = (<br>    os.path.join(BASE_DIR, <span class="hljs-string">&#x27;locale&#x27;</span>),<br>)<br></code></pre></td></tr></table></figure><h4 id="在视图中标识需要翻译的文本"><a href="#在视图中标识需要翻译的文本" class="headerlink" title="在视图中标识需要翻译的文本"></a>在视图中标识需要翻译的文本</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.utils.translation <span class="hljs-keyword">import</span> ugettext <span class="hljs-keyword">as</span> _<br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">from</span> django.utils <span class="hljs-keyword">import</span> translation<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_view</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-comment"># 切换所使用的语言</span><br>    user_language = <span class="hljs-string">&#x27;zh_hans&#x27;</span><br>    <span class="hljs-comment"># user_language = &#x27;zh_hant&#x27;</span><br>    <span class="hljs-comment"># user_language = &#x27;en&#x27;</span><br>    <span class="hljs-comment"># user_language = &#x27;ja&#x27;</span><br>    translation.activate(user_language)<br><br>    <span class="hljs-comment"># 做标识需要翻译的文本</span><br>    output = _(<span class="hljs-string">&quot;Welcome to my site.&quot;</span>)<br>    output2 = _(<span class="hljs-string">&quot;name&quot;</span>)<br>    <span class="hljs-keyword">return</span> HttpResponse(output + output2)<br></code></pre></td></tr></table></figure><h4 id="在模板中表示需要翻译的文本"><a href="#在模板中表示需要翻译的文本" class="headerlink" title="在模板中表示需要翻译的文本"></a>在模板中表示需要翻译的文本</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html">&#123;% load i18n %&#125;<br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>&#123;% trans &quot;This is the title.&quot; %&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="blocktrans模板标签"><a href="#blocktrans模板标签" class="headerlink" title="blocktrans模板标签"></a>blocktrans模板标签</h4><p>与上面的模板标签不同，blocktrans标签允许你通过使用占位符来标记由文字和可变内容组成的复杂句子进行翻译，如下例所示：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">&#123;% blocktrans %&#125;This string will have &#123;&#123; value &#125;&#125; inside.&#123;% endblocktrans %&#125;<br></code></pre></td></tr></table></figure><h4 id="本地化"><a href="#本地化" class="headerlink" title="本地化"></a>本地化</h4><p>建立语言文件是通过<code>django-admin makemessages</code>命令完成的。  在项目的根目录下，也就是包含manage.py的目录下，运行下面的命令，会生成对应目录，进行手工翻译即可。 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">python manage.py makemessages -l zh_hans<br>python manage.py makemessages -l en<br>python manage.py makemessages -l zh_hant<br><br><span class="hljs-comment"># 更新所有</span><br>python manage.py makemessages --all<br></code></pre></td></tr></table></figure><p><strong>注意：在Windows下，需要提前安装GNU gettext工具！点击<a href="https://mlocati.github.io/articles/gettext-iconv-windows.html">传送门</a>安装，如果命令不成功，需要重启终端使用</strong></p><p>生成文件内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">msgid <span class="hljs-string">&quot;Welcome to my site.&quot;</span><br>msgstr <span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure><p>其中msgstr填写对应语言即可。</p><h4 id="编译语言文件"><a href="#编译语言文件" class="headerlink" title="编译语言文件"></a>编译语言文件</h4><p>Django将自动搜索所有的.po文件，将它们都翻译成.mo文件，这样加载速度会更快</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">django-admin compilemessages<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>国际化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django项目上线</title>
    <link href="/Myblog/2018/11/09/Django%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF/"/>
    <url>/Myblog/2018/11/09/Django%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF/</url>
    
    <content type="html"><![CDATA[<h3 id="安装MariaDB"><a href="#安装MariaDB" class="headerlink" title="安装MariaDB"></a>安装MariaDB</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">yum -y <span class="hljs-keyword">install</span> mariadb mariadb-<span class="hljs-keyword">server</span><br></code></pre></td></tr></table></figure><p>安装完成MariaDB，首先启动MariaDB </p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">systemctl <span class="hljs-literal">start</span> mariadb<br></code></pre></td></tr></table></figure><p>设置开机启动 </p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">systemctl <span class="hljs-builtin-name">enable</span> mariadb<br></code></pre></td></tr></table></figure><p>设置密码</p><p>命令: <code>mysql_secure_installation </code></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Enter <span class="hljs-keyword">current</span> <span class="hljs-keyword">password</span> <span class="hljs-keyword">for</span> root:&lt;–初次运行直接回车<br><br>设置密码<br><br><span class="hljs-keyword">Set</span> root <span class="hljs-keyword">password</span>? [Y/n] &lt;– 是否设置root用户密码，输入y并回车或直接回车<br><br><span class="hljs-built_in">New</span> <span class="hljs-keyword">password</span>: &lt;– 设置root用户的密码<br>Re-enter <span class="hljs-built_in">new</span> <span class="hljs-keyword">password</span>: &lt;– 再输入一次你设置的密码<br><br>其他配置<br><br>Remove anonymous users? [Y/n] &lt;– 是否删除匿名用户，回车<br><br>Disallow root <span class="hljs-keyword">login</span> remotely? [Y/n] &lt;–是否禁止root远程登录,回车,<br><br>Remove test <span class="hljs-keyword">database</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">access</span> <span class="hljs-keyword">to</span> it? [Y/n] &lt;– 是否删除test数据库，回车<br><br>Reload privilege <span class="hljs-keyword">tables</span> now? [Y/n] &lt;– 是否重新加载权限表，回车<br><br>初始化MariaDB完成，接下来测试登录<br><br>mysql -u root -p<br></code></pre></td></tr></table></figure><h4 id="开启远程连接"><a href="#开启远程连接" class="headerlink" title="开启远程连接"></a>开启远程连接</h4><p>在mysql数据库中的user表中可以看到默认是只能本地连接的，所有可以添加一个新的用户，该用户可以远程访问 </p><h4 id="1-创建用户"><a href="#1-创建用户" class="headerlink" title="1. 创建用户"></a>1. 创建用户</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 先使用数据库</span><br>use mysql;<br><br><span class="hljs-comment"># 针对ip可以访问</span><br>create<span class="hljs-built_in"> user </span><span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;192.168.10.10&#x27;</span> identified by <span class="hljs-string">&#x27;password&#x27;</span>;<br><br><span class="hljs-comment">#全部ip可以访问</span><br> create<span class="hljs-built_in"> user </span><span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&#x27;password&#x27;</span>;<br></code></pre></td></tr></table></figure><h4 id="2-授权"><a href="#2-授权" class="headerlink" title="2. 授权"></a>2. 授权</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment"># 给用户最大权限</span><br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">privileges</span> <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-keyword">identified</span> <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;password&#x27;</span>;<br><br><span class="hljs-comment"># 给部分权限(test 数据库)</span><br><br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">privileges</span> <span class="hljs-keyword">on</span> test.* <span class="hljs-keyword">to</span> <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-keyword">identified</span> <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;password&#x27;</span> <span class="hljs-keyword">with</span> <span class="hljs-keyword">grant</span> <span class="hljs-keyword">option</span>;<br><br><span class="hljs-comment"># 刷新权限表</span><br><span class="hljs-keyword">flush</span> <span class="hljs-keyword">privileges</span>;<br><br><span class="hljs-comment"># 查看</span><br><span class="hljs-keyword">show</span> <span class="hljs-keyword">grants</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>;<br></code></pre></td></tr></table></figure><p>接下来就可以在远程的数据库可视化工具中直接访问该服务器中的mysql了。 </p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 访问数据库</span><br><span class="hljs-attribute">mysql</span> -u root -p<br></code></pre></td></tr></table></figure><h3 id="安装python3-6"><a href="#安装python3-6" class="headerlink" title="安装python3.6"></a>安装python3.6</h3><p>在centos中，系统默认只提供python2.7的版本，但是项目我们使用的python3.6的版本。所有我们自己安装python3 </p><h4 id="安装Python3的方法"><a href="#安装Python3的方法" class="headerlink" title="安装Python3的方法"></a>安装Python3的方法</h4><p>首先安装依赖包</p><p>安装Python3.6所需要的依赖包：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">yum</span> -y groupinstall <span class="hljs-string">&quot;Development tools&quot;</span><br><br><span class="hljs-attribute">yum</span> -y install zlib-devel bzip<span class="hljs-number">2</span>-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel db<span class="hljs-number">4</span>-devel libpcap-devel xz-devel<br></code></pre></td></tr></table></figure><p>安装Python3.7还需额外安装依赖包：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> libffi-devel -y<br></code></pre></td></tr></table></figure><p>然后根据自己需求下载不同版本的Python3，我下载的是Python3.6.2 </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>www.python.org<span class="hljs-regexp">/ftp/</span>python<span class="hljs-regexp">/3.6.2/</span>Python-<span class="hljs-number">3.6</span>.<span class="hljs-number">2</span>.tar.xz<br><br>然后解压压缩包，进入该目录，安装Python3<br><br>tar -xvJf  Python-<span class="hljs-number">3.6</span>.<span class="hljs-number">2</span>.tar.xz<br>cd Python-<span class="hljs-number">3.6</span>.<span class="hljs-number">2</span><br>.<span class="hljs-regexp">/configure --prefix=/u</span>sr<span class="hljs-regexp">/local/</span>python3<br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure><p>最后创建软链接 </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">ln -s <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/python3/</span>bin<span class="hljs-regexp">/python3 /u</span>sr<span class="hljs-regexp">/bin/</span>python3<br><br>ln -s <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/python3/</span>bin<span class="hljs-regexp">/pip3 /u</span>sr<span class="hljs-regexp">/bin/</span>pip3<br></code></pre></td></tr></table></figure><h3 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h3><h4 id="1-安装virtualenv"><a href="#1-安装virtualenv" class="headerlink" title="1. 安装virtualenv"></a>1. 安装virtualenv</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> python-virtualenv<br></code></pre></td></tr></table></figure><h4 id="2-创建虚拟环境"><a href="#2-创建虚拟环境" class="headerlink" title="2. 创建虚拟环境"></a>2. 创建虚拟环境</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">virtualenv --no-site-packages -p <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/python3/</span>bin/python3 freshenv<br><br><span class="hljs-comment"># 进入虚拟环境，激活虚拟环境</span><br>source &lt;目录&gt;<span class="hljs-regexp">/bin/</span>activate<br></code></pre></td></tr></table></figure><h4 id="3-安装环境需要的包"><a href="#3-安装环境需要的包" class="headerlink" title="3. 安装环境需要的包"></a>3. 安装环境需要的包</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 创建文本文件，写入需要安装的包，用一下命令安装虚拟环境需要的包</span><br><span class="hljs-regexp">/home/</span>env<span class="hljs-regexp">/freshenv/</span>bin/pip3 install -r reqyirement.txt <br></code></pre></td></tr></table></figure><h3 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h3><p>项目部署结构：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">├── conf  <span class="hljs-comment"># 配置文件</span><br>├── <span class="hljs-keyword">env</span>   <span class="hljs-comment"># 虚拟环境</span><br>├── logs  <span class="hljs-comment"># 日志信息</span><br>├── media <span class="hljs-comment"># 媒体文件（公共资源目录）</span><br>└── src  <span class="hljs-comment"># 代码文件</span><br></code></pre></td></tr></table></figure><p>出现问题：Django的项目中，在工程目录下settings.py文件中有一个DEBUG=True参数，如果DEBUG=False则会出现js,css，img无法加载的情况出现。 </p><p>原因如下：</p><p>Django框架仅在开发模式下提供静态文件服务。当我开启DEBUG模式时，Django内置的服务器是提供静态文件的服务的，所以css等文件访问都没有问题，但是关闭DEBUG模式后，Django便不提供静态文件服务了。想一想这是符合Django的哲学的：这部分事情标准服务器都很擅长，就让服务器去做吧！</p><h4 id="1-测试环境中部署方式"><a href="#1-测试环境中部署方式" class="headerlink" title="1. 测试环境中部署方式"></a>1. 测试环境中部署方式</h4><p>在测试环境中一般都直接使用python manage.py runserver 0.0.0.0:80的方式去运行项目（python：指定虚拟环境python路径， manage.py也最好指定绝对路径）。其中就涉及到DEBUG=False的修改，静态目录的修改等，具体修改如下： </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">a) 修改settings.py配置文件中的DEBUG=<span class="hljs-literal">False</span>模式，修改ALLOEWD_HOST=[<span class="hljs-string">&#x27;*&#x27;</span>]<br><br>b) 修改工程目录下的urls.py<br><br><span class="hljs-keyword">from</span> django.views.static <span class="hljs-keyword">import</span> serve<br><span class="hljs-keyword">from</span> fresh_shop  <span class="hljs-keyword">import</span> settings<br><br><span class="hljs-keyword">from</span> goods <span class="hljs-keyword">import</span> views<br><span class="hljs-keyword">from</span> fresh_shop.settings <span class="hljs-keyword">import</span> MEDIA_ROOT, MEDIA_URL<br><br>urlpatterns = [<br>    url(<span class="hljs-string">r&#x27;^admin/&#x27;</span>, admin.site.urls),<br>    url(<span class="hljs-string">r&#x27;^axf/&#x27;</span>, include(<span class="hljs-string">&#x27;axf.urls&#x27;</span>, namespace=<span class="hljs-string">&#x27;axf&#x27;</span>)),<br><br><span class="hljs-comment"># 增加以下的url路由</span><br><span class="hljs-comment"># 添加index页面，并且设置为路由不能被屏蔽</span><br>    url(<span class="hljs-string">r&#x27;^static/(?P&lt;path&gt;.*)$&#x27;</span>, serve, &#123;<span class="hljs-string">&quot;document_root&quot;</span>: settings.STATICFILES_DIRS[<span class="hljs-number">0</span>]&#125;),<br>url(<span class="hljs-string">r&#x27;^media/(?P&lt;path&gt;.*)$&#x27;</span>, serve, &#123;<span class="hljs-string">&quot;document_root&quot;</span>: settings.MEDIA_ROOT&#125;),<br>url(<span class="hljs-string">r&#x27;^$&#x27;</span>, views.index),<br><br><br>    url(<span class="hljs-string">r&#x27;^$&#x27;</span>, views.home)<br>]<br></code></pre></td></tr></table></figure><h4 id="2-正式环境中部署方式"><a href="#2-正式环境中部署方式" class="headerlink" title="2. 正式环境中部署方式"></a>2. 正式环境中部署方式</h4><p>正式环境中部署为nginx+uwsgi来部署django项目 </p><h4 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> nginx<br></code></pre></td></tr></table></figure><p>运行nginx</p><p>Nginx不会自行启动。要运行Nginx</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">systemctl <span class="hljs-literal">start</span> nginx<br></code></pre></td></tr></table></figure><p>nginx的运行命令： </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">systemctl status nginx 查看nginx的状态<br>systemctl start<span class="hljs-regexp">/stop/</span>enable<span class="hljs-regexp">/disable nginx 启动/</span>关闭<span class="hljs-regexp">/设置开机启动/</span>禁止开机启动<br></code></pre></td></tr></table></figure><p>创建目录<code>/home/conf</code></p><p>添加freshnginx.conf和freshuwsgi.ini文件</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>     <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>     <span class="hljs-attribute">server_name</span> <span class="hljs-number">120.78.83.46</span> localhost;<br><br>     <span class="hljs-comment"># 日志</span><br>     <span class="hljs-attribute">access_log</span> /home/logs/access.log;<br>     <span class="hljs-attribute">error_log</span> /home/logs/error.log;<br><br> <span class="hljs-comment"># 端口8890用于nginx和uwsgi交互</span><br>     <span class="hljs-attribute">location</span> / &#123;<br>         <span class="hljs-attribute">include</span> uwsgi_params;<br>         <span class="hljs-attribute">uwsgi_pass</span> <span class="hljs-number">127.0.0.1:8890</span>;<br>     &#125;<br>     <span class="hljs-comment"># static</span><br>     <span class="hljs-attribute">location</span> /static/ &#123;<br>         <span class="hljs-attribute">alias</span> /home/src/fresh_shop/static/;<br>         <span class="hljs-attribute">expires</span> <span class="hljs-number">30d</span>;<br>     &#125;<br>     <span class="hljs-comment"># media</span><br>     <span class="hljs-attribute">location</span> /media/ &#123;<br>         <span class="hljs-attribute">alias</span> /home/media/;<br>     &#125;<br><br> &#125;<br></code></pre></td></tr></table></figure><p>修改nginx配置文件让自己写的配置文件生效</p><p><code>vim /etc/nginx/nginx.conf</code></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 在37行添加</span><br>include <span class="hljs-regexp">/home/</span>conf/freshnginx.conf;<br></code></pre></td></tr></table></figure><h4 id="配置uwsgi"><a href="#配置uwsgi" class="headerlink" title="配置uwsgi"></a>配置uwsgi</h4><h5 id="安装uwsgi"><a href="#安装uwsgi" class="headerlink" title="安装uwsgi"></a>安装uwsgi</h5><p>在虚拟环境中安装uwsgi</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/home/</span>env<span class="hljs-regexp">/freshenv/</span>bin/pip3 install uwsgi<br></code></pre></td></tr></table></figure><p>配置项目代码，配置<code>uwsgi.ini</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[uwsgi]</span><br><span class="hljs-comment"># 守护进程</span><br><span class="hljs-attr">master</span> = <span class="hljs-literal">true</span><br><br><span class="hljs-comment"># 进程个数</span><br><span class="hljs-attr">processes</span> = <span class="hljs-number">4</span><br><br><span class="hljs-comment"># 项目地址</span><br><span class="hljs-attr">chdir</span> = /home/src/fresh_shop<br><br><span class="hljs-comment"># python路径</span><br><span class="hljs-attr">pythonpath</span> = /home/env/freshenv/bin/python3<br><br><span class="hljs-comment"># 第一个 app 指明 py 文件，第二个 app 指明 Flask 实例</span><br><span class="hljs-attr">module</span> = app:app<br><br><span class="hljs-comment"># 和nginx通信地址:端口</span><br><span class="hljs-attr">socket</span> = <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8890</span><br><br><span class="hljs-comment"># 日志文件地址</span><br><span class="hljs-attr">logto</span> = /home/logs/freshuwsgi.log<br></code></pre></td></tr></table></figure><h3 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h3><p>重启nginx后执行以下代码即可</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/home/</span>env<span class="hljs-regexp">/freshenv/</span>bin/uwsgi --ini freshnginx.ini<br></code></pre></td></tr></table></figure><blockquote><p>如果需要后台运行，加上参数<code>-d</code> 即可。</p></blockquote><h3 id="配置HTTPS"><a href="#配置HTTPS" class="headerlink" title="配置HTTPS"></a>配置HTTPS</h3><ol><li><p>申请安装证书</p></li><li><p>查看阿里云安装指南，复制配置文件信息到服务器进行修改(如：nginx)</p><p>修改全局配置文件（<code>/etc/nginx/nginx.conf</code>），包含局部配置文件（<code>/root/project/conf/nginx.conf</code>）。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs shell">server &#123;<br>    listen      80;<br>    server_name _;<br>    access_log /root/project/logs/access.log;<br>    error_log /root/project/logs/error.log;<br>    location / &#123;<br>        include uwsgi_params;<br>        uwsgi_pass 172.17.31.4:8000;<br>    &#125;<br>    location /static/ &#123;<br>        alias /root/project/stat/;<br>        expires 30d;<br>    &#125;<br>&#125;<br>server &#123;<br>    listen      443;<br>    server_name _;<br>    ssl         on;<br>    access_log /root/project/logs/access.log;<br>    error_log /root/project/logs/error.log;<br>    ssl_certificate     /root/project/conf/1758481_lvhaojie.xyz.pem;<br>    ssl_certificate_key /root/project/conf/1758481_lvhaojie.xyz.key;<br>    ssl_session_timeout 5m;<br>    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;<br>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br>    ssl_prefer_server_ciphers on;<br>    location / &#123;<br>        include uwsgi_params;<br>        uwsgi_pass 172.17.31.4:8000;<br>    &#125;<br>    location /static/ &#123;<br>        alias /root/project/stat/;<br>        expires 30d;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在项目配置文件中添加对应Https信息</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 保持HTTPS连接的时间</span><br>SECURE_HSTS_SECONDS = <span class="hljs-number">3600</span><br>SECURE_HSTS_INCLUDE_SUBDOMAINS = <span class="hljs-literal">True</span><br>SECURE_HSTS_PRELOAD = <span class="hljs-literal">True</span><br><br><span class="hljs-comment"># 自动重定向到安全连接</span><br>SECURE_SSL_REDIRECT = <span class="hljs-literal">True</span><br><br><span class="hljs-comment"># 避免浏览器自作聪明推断内容类型</span><br>SECURE_CONTENT_TYPE_NOSNIFF = <span class="hljs-literal">True</span><br><br><span class="hljs-comment"># 避免跨站脚本攻击</span><br>SECURE_BROWSER_XSS_FILTER = <span class="hljs-literal">True</span><br><br><span class="hljs-comment"># COOKIE只能通过HTTPS进行传输</span><br>SESSION_COOKIE_SECURE = <span class="hljs-literal">True</span><br>CSRF_COOKIE_SECURE = <span class="hljs-literal">True</span><br><br><span class="hljs-comment"># 防止点击劫持攻击手段 - 修改HTTP协议响应头</span><br><span class="hljs-comment"># 当前网站是不允许使用&lt;iframe&gt;标签进行加载的</span><br>X_FRAME_OPTIONS = <span class="hljs-string">&#x27;DENY&#x27;</span><br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django-权限控制</title>
    <link href="/Myblog/2018/10/31/Django-%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/"/>
    <url>/Myblog/2018/10/31/Django-%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="Django的权限项"><a href="#Django的权限项" class="headerlink" title="Django的权限项"></a>Django的权限项</h3><p>Django用permission对象存储权限项，每个model默认都有三个permission，即add model, change model和delete model。例如，定义一个名为学生Student模型，当迁移表后，会在auth_permission中自动创建相应的三个permission：add_student, change_student和delete_student。Django还允许自定义permission。</p><h4 id="自定义权限"><a href="#自定义权限" class="headerlink" title="自定义权限"></a>自定义权限</h4><p>在自定义模型的Meta元中添加permissions参数 </p><p>在models.py中自定义权限</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> AbstractUser<br><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyUser</span>(<span class="hljs-params">AbstractUser</span>):</span><br>    <span class="hljs-comment"># 扩展django自带的auth_user表。可以自定义新的增的字段</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span><br>        <span class="hljs-comment"># django默认给每个模型初始化三个权限</span><br>        <span class="hljs-comment"># 默认的是change、delete、add权限</span><br>        permissions = (<br>            (<span class="hljs-string">&#x27;add_my_user&#x27;</span>, <span class="hljs-string">&#x27;新增用户权限&#x27;</span>),<br>            (<span class="hljs-string">&#x27;change_my_user_username&#x27;</span>, <span class="hljs-string">&#x27;修改用户名权限&#x27;</span>),<br>            (<span class="hljs-string">&#x27;change_my_user_password&#x27;</span>, <span class="hljs-string">&#x27;修改用户密码权限&#x27;</span>),<br>            (<span class="hljs-string">&#x27;all_my_user&#x27;</span>, <span class="hljs-string">&#x27;查看用户权限&#x27;</span>)<br>        )<br></code></pre></td></tr></table></figure><p>并在settings.py文件中添加如下设置： </p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 告诉django，User模型修改为自定义的模型</span><br><span class="hljs-attr">AUTH_USER_MODEL</span> = <span class="hljs-string">&#x27;permissions.MyUser&#x27;</span><br></code></pre></td></tr></table></figure><p>注意：在数据库的auth_permission表中，会新增权限，包括自带的对Users管理的权限，和自定义的四个权限。</p><h4 id="添加-删除权限"><a href="#添加-删除权限" class="headerlink" title="添加/删除权限"></a>添加/删除权限</h4><p>采用直接分配权限的方法，给用户添加额外的权限既用户表Users和权限Permission模型以及中间表user_permission之间的关联关系。用户Users模型和权限Permission之间是ManyToManyField()多对多关联关系，关联字段为user_permission。</p><p><strong>语法：</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">其中<span class="hljs-selector-tag">xxx</span>的关联字段可以进行查看<br><br>添加权限：<span class="hljs-selector-tag">user</span>对象<span class="hljs-selector-class">.xxx</span><span class="hljs-selector-class">.add</span>(<span class="hljs-selector-tag">permission</span>对象1, <span class="hljs-selector-tag">permission</span>对象2)<br>删除权限：<span class="hljs-selector-tag">user</span>对象<span class="hljs-selector-class">.xxx</span><span class="hljs-selector-class">.remove</span>(<span class="hljs-selector-tag">permission</span>对象1, <span class="hljs-selector-tag">permission</span>对象2)<br>清空权限：<span class="hljs-selector-tag">user</span>对象<span class="hljs-selector-class">.xxx</span><span class="hljs-selector-class">.clear</span>()<br></code></pre></td></tr></table></figure><p><strong>案例一：</strong>创建用户 - 添加权限:add() - 删除权限:remove()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_user_permission</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-comment"># 1.创建用户</span><br>        user = MyUser.objects.create_user(username=<span class="hljs-string">&#x27;星辰&#x27;</span>, password=<span class="hljs-string">&#x27;123456&#x27;</span>)<br><br>        <span class="hljs-comment"># 2.指定刚创建的用户，并分配权限（新增用户权限，查看用户权限）</span><br>        permissions = Permission.objects.filter(codename__in=[<span class="hljs-string">&#x27;add_my_user&#x27;</span>, <span class="hljs-string">&#x27;all_my_user&#x27;</span>])<br>        <span class="hljs-keyword">for</span> permission <span class="hljs-keyword">in</span> permissions:<br>            <span class="hljs-comment"># 添加权限</span><br>            user.user_permissions.add(permission)<br><br>        <span class="hljs-comment"># 3. 删除刚创建的用户的新增用户权限：all_my_user</span><br>        permission_delete = Permission.objects.filter(codename=<span class="hljs-string">&#x27;all_my_user&#x27;</span>).first()<br>        <span class="hljs-comment"># 删除权限</span><br>        user.user_permissions.remove(permission_delete)<br><br>        <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">&#x27;创建用户成功！新增两条权限，并删除了其中一条权限&#x27;</span>)<br></code></pre></td></tr></table></figure><p><strong>案例二：</strong>用户名为lhj用户，有查看用户列表的权限，才能访问主页</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@permission</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-comment"># 用户名为lhj用户，有查看用户列表的权限，才能访问如下视图函数</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;index.html&#x27;</span>)<br>        <br></code></pre></td></tr></table></figure><p>function.py中定义装饰器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-keyword">from</span> permissions.models <span class="hljs-keyword">import</span> MyUser<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">permission</span>(<span class="hljs-params">func</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check</span>(<span class="hljs-params">request</span>):</span><br>        <span class="hljs-comment"># 获取用户</span><br>        user = MyUser.objects.filter(username=<span class="hljs-string">&#x27;lhj&#x27;</span>).first()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:<br>            <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">&#x27;没有查找到对应用户&#x27;</span>)<br>        perm = user.user_permissions.filter(codename=<span class="hljs-string">&#x27;all_my_user&#x27;</span>).first()  <span class="hljs-comment"># 比较用户是否有对应权限</span><br>        <span class="hljs-keyword">if</span> perm:<br>            <span class="hljs-keyword">return</span> func(request)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">&#x27;没有对应的权限&#x27;</span>)<br>    <span class="hljs-keyword">return</span> check<br></code></pre></td></tr></table></figure><h4 id="自定义查询权限"><a href="#自定义查询权限" class="headerlink" title="自定义查询权限"></a>自定义查询权限</h4><p>视图函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show_user_permission</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-comment"># 查看对应用户的权限</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-comment"># 获取对应用户，交给前端显示</span><br>        users = MyUser.objects.filter(username=<span class="hljs-string">&#x27;lhj&#x27;</span>).first()<br>        <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;permission.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;users&#x27;</span>:users&#125;)<br></code></pre></td></tr></table></figure><p>permission.html文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs html">&#123;% extends &#x27;base.html&#x27; %&#125;<br><br>&#123;% block content %&#125;<br>    <span class="hljs-comment">&lt;!--通过用户查询组，组查询权限--&gt;</span><br>    &#123;# 在前端取数据，用all代替all(), 用0代替第一个元素 #&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>通过用户直接查找权限<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br>    &#123;% for user in users.groups.all.0.permissions.all %&#125;<br>        &#123;&#123; user.codename &#125;&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    &#123;% endfor %&#125;<br><br>    <span class="hljs-comment">&lt;!--通过用户直接查找权限--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>通过用户直接查找权限<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    &#123;% for user in users.user_permissions.all %&#125;<br>        &#123;&#123; user.codename &#125;&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    &#123;% endfor %&#125;<br><br>&#123;% endblock %&#125;<br></code></pre></td></tr></table></figure><p><strong>补充：</strong>当提交表单时，为了防止被劫持，会进行CSRF令牌验证，所以应该在form表单中加上以下内容,提交时会自动进行CSRF令牌验证，该令牌每次随机产生，并且只能使用一次。</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">csrf_token</span></span> %&#125;</span><br></code></pre></td></tr></table></figure><h4 id="Django自带查询权限方法"><a href="#Django自带查询权限方法" class="headerlink" title="Django自带查询权限方法"></a>Django自带查询权限方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"> <span class="hljs-comment"># 拿到当前登录系统用户</span><br>user = request.user<br><br><span class="hljs-comment"># 获取当前用户对于的组权限</span><br>user.get_group_permissions()<br><br><span class="hljs-comment"># 获取当前用户所有的权限</span><br>user.get_all_permissions()<br><br><span class="hljs-comment"># 判断是否有某个权限</span><br>user.has_perm(<span class="hljs-string">&#x27;perm)  # perm ==&gt; &#x27;</span>应用名.权限<span class="hljs-string">&#x27;</span><br><span class="hljs-string">user.has_perms(&#x27;</span>perm_list<span class="hljs-string">&#x27;)   # perm_list ==&gt; &#x27;</span>应用名.权限集合<span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="Django自带权限验证装饰器"><a href="#Django自带权限验证装饰器" class="headerlink" title="Django自带权限验证装饰器"></a>Django自带权限验证装饰器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># django自带的权限验证,如果有对应权限，才能访问，否则返回到登录页面，在settings.py文件中定义返回页面</span><br><span class="hljs-meta">@permission_required(&#x27;对应权限&#x27;)  # 对应权限 ==&gt; 应用名.权限(permissions.add_my_user) </span><br></code></pre></td></tr></table></figure><p>settings.py文件中自定权限验证不通过的返回页面</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 登录验证/权限验证不通过，则跳转地址</span><br>LOGIN_URL = <span class="hljs-string">&#x27;/permissions/login/&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django-日志</title>
    <link href="/Myblog/2018/10/30/Django-%E6%97%A5%E5%BF%97/"/>
    <url>/Myblog/2018/10/30/Django-%E6%97%A5%E5%BF%97/</url>
    
    <content type="html"><![CDATA[<h3 id="日志-logging模块"><a href="#日志-logging模块" class="headerlink" title="日志 - logging模块"></a>日志 - logging模块</h3><h4 id="logging的组成"><a href="#logging的组成" class="headerlink" title="logging的组成"></a>logging的组成</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">Loggers</span><br><br><span class="hljs-attribute">Handlers</span><br><br><span class="hljs-attribute">Filters</span><br><br><span class="hljs-attribute">Formatters</span><br></code></pre></td></tr></table></figure><p>logging模块可以收集记录错误，警告等调试信息，在程序中可以捕获这些信息，并且甚至可以将错误的重要信息等都可以通过邮件发送给开发者</p><p>1.Loggers</p><p>Logger 为日志系统的入口。每个logger 是一个具名的容器，可以向它写入需要处理的消息。</p><p>每个logger 都有一个日志级别。日志级别表示该logger 将要处理的消息的严重性。</p><p>Python 定义以下几种日志级别：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">DEBUG</span>：用于调试目的的底层系统信息<br><br><span class="hljs-keyword">INFO</span>：普通的系统信息<br><br><span class="hljs-built_in">WARNING</span>：表示出现一个较小的问题。<br><br>ERROR：表示出现一个较大的问题。<br><br>CRITICAL：表示出现一个致命的问题。<br></code></pre></td></tr></table></figure><p>日志级别等级CRITICAL &gt; ERROR &gt; WARNING &gt; INFO &gt; DEBUG &gt; NOTSET </p><p>2.Handlers</p><p>Handler 决定如何处理logger 中的每条消息。它表示一个特定的日志行为。</p><p>与logger 一样，handler 也有一个日志级别。如果消息的日志级别小于handler 的级别，handler 将忽略该消息。</p><p>Logger 可以有多个handler，而每个handler 可以有不同的日志级别。</p><p>3.Filters</p><p>Filter 用于对从logger 传递给handler 的日志记录进行额外的控制。</p><p>4.Formatters</p><p>日志记录需要转换成文本。</p><p>Formatter 表示文本的格式。Fomatter 通常由包含日志记录属性的Python 格式字符串组成；</p><p>你也可以编写自定义的fomatter 来实现自己的格式。</p><h4 id="配置日志"><a href="#配置日志" class="headerlink" title="配置日志"></a>配置日志</h4><p>创建logs文件夹，用于存放日志（以后一般工作时，日志文件是单独存放的）</p><p>settings.py文件中配置LOGGING日志信息：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 配置日志</span><br>LOGGING = &#123;<br>    <span class="hljs-string">&#x27;version&#x27;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-comment"># True表示禁用日志</span><br>    <span class="hljs-string">&#x27;disable_existing_loggers&#x27;</span>: <span class="hljs-literal">False</span>,<br>    <span class="hljs-comment"># 指定写入到日志文件中的日志格式</span><br>    <span class="hljs-string">&#x27;formatters&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;default&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;format&#x27;</span>: <span class="hljs-string">&#x27;%(name)s %(asctime)s %(message)s&#x27;</span><br>        &#125;,<br>    &#125;,<br>    <span class="hljs-string">&#x27;handlers&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;console&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;INFO&#x27;</span>,<br>            <span class="hljs-string">&#x27;filename&#x27;</span>: <span class="hljs-string">&#x27;%s/log.txt&#x27;</span> % os.path.join(BASE_DIR, <span class="hljs-string">&#x27;logs&#x27;</span>),<br>            <span class="hljs-string">&#x27;formatter&#x27;</span>: <span class="hljs-string">&#x27;default&#x27;</span>,<br>            <span class="hljs-comment"># 当日志文件大于5M，则做自动备份</span><br>            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-string">&#x27;logging.handlers.RotatingFileHandler&#x27;</span>,<br>            <span class="hljs-string">&#x27;maxBytes&#x27;</span>: <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>,<br><br>        &#125;<br>    &#125;,<br>    <span class="hljs-string">&#x27;loggers&#x27;</span>:&#123;<br>        <span class="hljs-string">&#x27;&#x27;</span>:&#123;<br>            <span class="hljs-string">&#x27;handlers&#x27;</span>:[<span class="hljs-string">&#x27;console&#x27;</span>],<br>            <span class="hljs-string">&#x27;level&#x27;</span>:<span class="hljs-string">&#x27;INFO&#x27;</span><br>        &#125;,<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>注意：loggers的level的级别一定要大于handlers的级别，否则handlers会忽略掉该信息的。 </p><p><strong>定义日志处理的中间件，进行日志的打印处理</strong></p><p>定义日志中间件logMiddleware.py文件，定义LoggingMiddleware类，该类继承MiddlewareMixin，并重构process_request和proccess_response方法： </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogginMiddleware</span>(<span class="hljs-params">MiddlewareMixin</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_request</span>(<span class="hljs-params">self, request</span>):</span><br>        <span class="hljs-comment"># 记录当前请求访问服务器的时间，请求参数和内容等</span><br>        request.init_time = time.time()<br>        request.init_body = request.body<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_response</span>(<span class="hljs-params">self, request, response</span>):</span><br><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 记录返回相应的时间和访问服务器的时间差，记录返回状态码等</span><br>            times = time.time() - request.init_time<br>            <span class="hljs-comment"># 响应状态码</span><br>            code = response.status_code<br>            <span class="hljs-comment"># 响应内容</span><br>            res_body = response.content<br>            <span class="hljs-comment"># 请求内容</span><br>            req_body = request.init_body<br><br>            <span class="hljs-comment"># 日志信息</span><br>            msg = <span class="hljs-string">&#x27;%s %s %s %s&#x27;</span> % (times, code, res_body, req_body)<br><br>            <span class="hljs-comment"># 写入日志</span><br>            logging.info(msg)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logging.critical(<span class="hljs-string">&#x27;log error, Exception: %s&#x27;</span> % e)<br><br>        <span class="hljs-keyword">return</span> response<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django-分页</title>
    <link href="/Myblog/2018/10/30/Django-%E5%88%86%E9%A1%B5/"/>
    <url>/Myblog/2018/10/30/Django-%E5%88%86%E9%A1%B5/</url>
    
    <content type="html"><![CDATA[<h3 id="分页显示"><a href="#分页显示" class="headerlink" title="分页显示"></a>分页显示</h3><p>视图函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.core.paginator <span class="hljs-keyword">import</span> Paginator<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">articles</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-comment"># 一般获取页数通过url传递参数，以?page=2的形式</span><br>        <span class="hljs-comment"># 如果get拿不到对应的参数，就取第二个参数</span><br>        page = request.GET.get(<span class="hljs-string">&#x27;page&#x27;</span>, <span class="hljs-number">1</span>)<br>        <br>        <span class="hljs-comment"># 查询所有文章对象并进行分页</span><br>        articles = Article.objects.all()<br>        <span class="hljs-comment"># 将所有文章进行分页，每一页最多4条数据</span><br>        paginator = Paginator(articles, <span class="hljs-number">4</span>)<br>        <span class="hljs-comment"># 获取第一页文章信息</span><br>        art = paginator.page(page)<br>        <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;arts.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;art&#x27;</span>:art&#125;)<br></code></pre></td></tr></table></figure><p>方法Paginator（）有两个参数，第一个是查询目标集合，第二个是每页多少条数据。</p><p><code>arts.html</code>文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs html">&#123;% extends &#x27;base.html&#x27; %&#125;<br><br>&#123;% block content %&#125;<br>    &#123;% for n in art %&#125;<br>        标题：&#123;&#123; n.title &#125;&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>        描述&#123;&#123; n.desc &#125;&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>        图片：<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/media/&#123;&#123; n.img &#125;&#125;&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br>    &#123;% endfor %&#125;<br><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>    &#123;% if art.has_previous %&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&#123;% url &#x27;user:articles&#x27; %&#125;?page=&#123;&#123; art.previous_page_number &#125;&#125;&quot;</span>&gt;</span>上一页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    &#123;% endif %&#125;<br><br>    &#123;% for i in art.paginator.page_range %&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&#123;% url &#x27;user:articles&#x27; %&#125;?page=&#123;&#123; i &#125;&#125;&quot;</span>&gt;</span>&#123;&#123; i &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    &#123;% endfor %&#125;<br><br>    &#123;% if art.has_next %&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&#123;% url &#x27;user:articles&#x27; %&#125;?page=&#123;&#123; art.next_page_number &#125;&#125;&quot;</span>&gt;</span>下一页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    &#123;% endif %&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br>&#123;% endblock %&#125;<br></code></pre></td></tr></table></figure><p>说明：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">art</span><span class="hljs-selector-class">.has_previous</span> <span class="hljs-selector-tag">-</span> 有上一页返回<span class="hljs-selector-tag">True</span><br><span class="hljs-selector-tag">art</span><span class="hljs-selector-class">.has_next</span> <span class="hljs-selector-tag">-</span> 有下一页返回<span class="hljs-selector-tag">True</span><br><span class="hljs-selector-tag">art</span><span class="hljs-selector-class">.previous_page_number</span> <span class="hljs-selector-tag">-</span> 返回上一页的页码<br><span class="hljs-selector-tag">art</span><span class="hljs-selector-class">.next_page_number</span> <span class="hljs-selector-tag">-</span> 返回下一页的页码<br><span class="hljs-selector-tag">art</span><span class="hljs-selector-class">.number</span> <span class="hljs-selector-tag">-</span> 返回当前页码<br><span class="hljs-selector-tag">art</span><span class="hljs-selector-class">.paginator</span><span class="hljs-selector-class">.page_range</span> <span class="hljs-selector-tag">-</span> 返回页码的<span class="hljs-selector-tag">range</span>函数（比如一共5页，返回<span class="hljs-selector-tag">range</span>（1,6））<br><span class="hljs-selector-tag">art</span><span class="hljs-selector-class">.paginator</span><span class="hljs-selector-class">.num_pages</span> <span class="hljs-selector-tag">-</span> 返回最大页码<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django-文件上传</title>
    <link href="/Myblog/2018/10/30/Django-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
    <url>/Myblog/2018/10/30/Django-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/</url>
    
    <content type="html"><![CDATA[<p>创建文件目录media</p><p>配置<code>setting.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 配置media路径</span><br>MEDIA_URL = <span class="hljs-string">&#x27;/media/&#x27;</span><br>MEDIA_ROOT = os.path.join(BASE_DIR, <span class="hljs-string">&#x27;media&#x27;</span>)<br></code></pre></td></tr></table></figure><p>案例：</p><p>定义模型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span>(<span class="hljs-params">models.Model</span>):</span><br>    title = models.CharField(max_length=<span class="hljs-number">20</span>)<br>    desc = models.CharField(max_length=<span class="hljs-number">150</span>)   <span class="hljs-comment"># 描述</span><br>    img = models.ImageField(upload_to=<span class="hljs-string">&#x27;article&#x27;</span>)  <span class="hljs-comment"># 上传文件是文件存放位置（在media下）</span><br>    create_time = models.DateTimeField(auto_now_add=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span><br>        db_table = <span class="hljs-string">&#x27;article&#x27;</span><br></code></pre></td></tr></table></figure><p>视图函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_article</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-comment"># 添加图片</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;article.html&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-comment"># 获取数据</span><br>        <span class="hljs-comment"># POST可以拿到title和desc，但是文件需要在FILES里面拿到</span><br>        img = request.FILES.get(<span class="hljs-string">&#x27;img&#x27;</span>)<br>        title = request.POST.get(<span class="hljs-string">&#x27;title&#x27;</span>)<br>        desc = request.POST.get(<span class="hljs-string">&#x27;desc&#x27;</span>)<br><br>        <span class="hljs-comment"># 添加到数据库，但是文件在数据库中存储是存储的路径</span><br>        Article.objects.create(img=img,<br>                               title=title,<br>                               desc=desc)<br><br>        <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">&#x27;上传图片成功！&#x27;</span>)<br>    <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show_article</span>(<span class="hljs-params">request, id</span>):</span><br>    <span class="hljs-comment"># 展示图片</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&quot;GET&quot;</span>:<br>        article = Article.objects.get(pk=id)<br>        <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;show_article.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;article&#x27;</span>:article&#125;)<br>        <br></code></pre></td></tr></table></figure><p>html文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs html"># article.html<br>&#123;% extends &#x27;base.html&#x27;%&#125;<br><br>&#123;% block title %&#125;<br>    上传<br>&#123;% endblock %&#125;<br><br>&#123;% block content %&#125;<br>    &#123;# 上传图片时，图片类型设置为file，form表单添加属性enctype=&quot;multipart/form-data #&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br>        文章标题：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>        文章描述：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;desc&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>        图片：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;img&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;提交&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br>&#123;% endblock %&#125;<br><br># show_article.html<br>&#123;% extends &#x27;base.html&#x27; %&#125;<br><br>&#123;% block title %&#125;<br>    展示图片<br>&#123;% endblock %&#125;<br><br>&#123;% block content %&#125;<br>    图片标题：&#123;&#123; article.title &#125;&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    图片描述：&#123;&#123; article.desc &#125;&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    图片：<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/media/&#123;&#123; article.img &#125;&#125;&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span> <br>&#123;# 但是默认加载不到这个静态目录，需要在urls.py中进行配置 #&#125;<br>&#123;% endblock %&#125;<br><br></code></pre></td></tr></table></figure><p><code>urls.py</code>文件配置</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">from</span> django.contrib.staticfiles.urls <span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span><br><br><span class="hljs-keyword">from</span> day06.settings <span class="hljs-keyword">import</span> MEDIA_URL, MEDIA_ROOT<br><br><span class="hljs-comment"># 将media文件夹解析为静态文件夹</span><br><span class="hljs-comment"># django在debug为True的情况下，就可以访问media文件夹下的内容</span><br>urlpatterns += <span class="hljs-keyword">static</span>(MEDIA_URL, document_root=MEDIA_ROOT)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django-middleware</title>
    <link href="/Myblog/2018/10/29/Django-middleware/"/>
    <url>/Myblog/2018/10/29/Django-middleware/</url>
    
    <content type="html"><![CDATA[<h3 id="中间件Middleware描述"><a href="#中间件Middleware描述" class="headerlink" title="中间件Middleware描述"></a>中间件Middleware描述</h3><p>中间件：</p><p>1.是一个轻量级的，底层的插件，可以介入Django的请求和响应的过程（面向切面编程) </p><p>2.中间件的本质就是一个python类 </p><p>注意：中间件是帮助我们在视图函数执行之前和执行之后都可以做一些额外的操作，它本质上就是一个自定义类，类中定义了几个方法，Django框架会在请求的特定的时间去执行这些方法。 </p><h3 id="Django1-8以前使用方法"><a href="#Django1-8以前使用方法" class="headerlink" title="Django1.8以前使用方法"></a>Django1.8以前使用方法</h3><p>在Django项目中，在<code>settings.py</code>中可以查看到已经定义好的中间件，并加入我们自定义的两个中间件。 </p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">MIDDLEWARE</span> = [<br>    <span class="hljs-string">&#x27;django.middleware.security.SecurityMiddleware&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.contrib.sessions.middleware.SessionMiddleware&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.middleware.common.CommonMiddleware&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.middleware.csrf.CsrfViewMiddleware&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.contrib.auth.middleware.AuthenticationMiddleware&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.contrib.messages.middleware.MessageMiddleware&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.middleware.clickjacking.XFrameOptionsMiddleware&#x27;</span>,<br>   <br>    <span class="hljs-string">&#x27;utils.middleware.TestMiddlware1&#x27;</span>,  <span class="hljs-comment"># 加载中间件TestMiddlware1</span><br>    <span class="hljs-string">&#x27;utils.middleware.TestMiddlware2&#x27;</span>,  <span class="hljs-comment"># 加载中间件TestMiddlware2</span><br>]<br></code></pre></td></tr></table></figure><p>每个中间件是一个独立的类，有以下几个方法：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-number">1.</span> process<span class="hljs-constructor">_request(<span class="hljs-params">self</span>, <span class="hljs-params">request</span>)</span><br>执行时机在django接收到request之后, 但仍未解析出url以确定运行哪个视图函数view之前<br><br><span class="hljs-number">2.</span> process<span class="hljs-constructor">_view(<span class="hljs-params">self</span>, <span class="hljs-params">request</span>, <span class="hljs-params">view_func</span>, <span class="hljs-params">view_args</span>, <span class="hljs-params">view_kwargs</span>)</span><br>执行时机在django执行完request预处理函数并确定待执行的view之后, 但在视图函数view之前<br>request: HttpRequest对象<br>view_fun: 是django将要调用的视图函数, 是真实的函数对象本身<br>view_args: 将传入view的位置参数列表, 不包括request参数<br>view_kwargs: 将传入view的字典参数<br><br><span class="hljs-number">3.</span> process<span class="hljs-constructor">_response(<span class="hljs-params">self</span>, <span class="hljs-params">request</span>, <span class="hljs-params">response</span>)</span><br>该方法必须返回HttpResponse对象, 可以是原来的, 也可以是修改后的<br><br>调用时机在django执行完view函数并生成response之后, 该中间件能修改response的内容, 常见用途比如压缩内容<br>request是request对象<br>response是从view中返回的response对象<br><br><span class="hljs-number">4.</span> process<span class="hljs-constructor">_exception(<span class="hljs-params">self</span>, <span class="hljs-params">request</span>, <span class="hljs-params">exception</span>)</span><br>默认不主动调用，该方法只有在request处理过程中出了问题并且view函数抛出了一个未捕获的异常才会被调用, 可以用来发送错误通知, 将相关信息输出到日志文件, 或者甚至尝试从错误中自动恢复<br>参数包括request对象, 还有view函数抛出的异常对象<span class="hljs-keyword">exception</span><br>必须返回None或HttpResponse对象<br><br><span class="hljs-number">5.</span> process<span class="hljs-constructor">_template_response(<span class="hljs-params">self</span>, <span class="hljs-params">request</span>, <span class="hljs-params">response</span>)</span><br>默认不主动调用，在视图执行render<span class="hljs-literal">()</span>返回后进行调用，必须返回None或HttpResponse对象<br></code></pre></td></tr></table></figure><p>创建utils目录，创建<code>__init__.py</code>和<code>middleware.py</code>文件</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"># middleware.py<br><span class="hljs-keyword">from</span> django.utils.deprecation <span class="hljs-keyword">import</span> MiddlewareMixin<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-symbol">TestMiddleware1</span>(<span class="hljs-symbol">MiddlewareMixin</span>):<br><br>    <span class="hljs-symbol">def</span> <span class="hljs-symbol">process_request</span>(<span class="hljs-symbol">self, <span class="hljs-symbol">request</span></span>):<br>        <span class="hljs-symbol">print</span>(&#x27;<span class="hljs-symbol">process_request1</span>&#x27;)<br>        # 继续执行视图函数<br>        <span class="hljs-symbol">return</span> <span class="hljs-symbol">None</span><br><br>    <span class="hljs-symbol">def</span> <span class="hljs-symbol">process_response</span>(<span class="hljs-symbol">self, <span class="hljs-symbol">request</span>, <span class="hljs-symbol">response</span></span>):<br>        <span class="hljs-symbol">print</span>(&#x27;<span class="hljs-symbol">process_response1</span>&#x27;)<br>        # 返回响应<br>        <span class="hljs-symbol">return</span> <span class="hljs-symbol">response</span><br><br><br><span class="hljs-symbol">class</span> <span class="hljs-symbol">TestMiddleware2</span>(<span class="hljs-symbol">MiddlewareMixin</span>):<br><br>    <span class="hljs-symbol">def</span> <span class="hljs-symbol">process_request</span>(<span class="hljs-symbol">self, <span class="hljs-symbol">request</span></span>):<br>        <span class="hljs-symbol">print</span>(&#x27;<span class="hljs-symbol">process_request2</span>&#x27;)<br>        # 继续执行视图函数<br>        <span class="hljs-symbol">return</span> <span class="hljs-symbol">None</span><br><br>    <span class="hljs-symbol">def</span> <span class="hljs-symbol">process_response</span>(<span class="hljs-symbol">self, <span class="hljs-symbol">request</span>, <span class="hljs-symbol">response</span></span>):<br>        <span class="hljs-symbol">print</span>(&#x27;<span class="hljs-symbol">process_response2</span>&#x27;)<br>        # 返回响应<br>        <span class="hljs-symbol">return</span> <span class="hljs-symbol">response</span><br><br></code></pre></td></tr></table></figure><p>案例：利用中间件做登录验证，但是会出现重定向次数过多的问题，所以需要屏蔽掉不需要进行登录验证的url地址。并且给request.user赋值为当前登录系统用户成为全局变量，再每个页面都可以使用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponseRedirect<br><span class="hljs-keyword">from</span> django.urls <span class="hljs-keyword">import</span> reverse<br><span class="hljs-keyword">from</span> django.utils.deprecation <span class="hljs-keyword">import</span> MiddlewareMixin<br><br><span class="hljs-keyword">from</span> user.models <span class="hljs-keyword">import</span> UserToken<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestMiddleware1</span>(<span class="hljs-params">MiddlewareMixin</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_request</span>(<span class="hljs-params">self, request</span>):</span><br>        <span class="hljs-comment"># 做登录验证</span><br>        <span class="hljs-comment"># 屏蔽掉不需要进行这些功能的url,屏蔽掉登录和注册的url，不需要做登录验证</span><br>        not_check = [<span class="hljs-string">&#x27;/user/login/&#x27;</span>,<span class="hljs-string">&#x27;/user/register/&#x27;</span>]<br>        path = request.path<br>        <span class="hljs-keyword">if</span> path <span class="hljs-keyword">in</span> not_check:<br>            <span class="hljs-comment"># 不继续执行以下登录验证的代码，直接执行视图函数</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>        token = request.COOKIES.get(<span class="hljs-string">&#x27;token&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> token:<br>            <span class="hljs-keyword">return</span> HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:login&#x27;</span>))<br>        user_token = UserToken.objects.filter(t_token=token).first()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_token:<br>            <span class="hljs-comment"># token标识符有误，挑战到登录页面</span><br>            <span class="hljs-keyword">return</span> HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:login&#x27;</span>))<br><br>        <span class="hljs-comment">#  给全局request对象修改user属性值，赋值为当前登录的系统用户</span><br>        <span class="hljs-comment"># 赋值后，user就是全局变量，在每个页面都可以使用</span><br>        request.user = user_token.user<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><h3 id="Django1-8以后官方推荐写法"><a href="#Django1-8以后官方推荐写法" class="headerlink" title="Django1.8以后官方推荐写法"></a>Django1.8以后官方推荐写法</h3><p>Django1.8以后，官方推荐中间件的写法和装饰器的写法保持了统一</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">中间件-拦截过滤器模式(代理模式， AOP)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment"># 如果要捕获异常用try语句即可</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">block_sms_middleware</span>(<span class="hljs-params">get_resp</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">middleware</span>(<span class="hljs-params">request, *args, **kwargs</span>):</span><br>        <span class="hljs-comment"># 在请求时要做的事情</span><br>    resp = get_resp(request, *args, **kwargs)<br>    <span class="hljs-comment"># 在响应时需要做的事情</span><br>        <span class="hljs-keyword">return</span> resp<br>    <span class="hljs-keyword">return</span> middleware<br></code></pre></td></tr></table></figure><p>最后在settings里面添加好自己的装饰器即可。</p>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django-Cookie和Session</title>
    <link href="/Myblog/2018/10/26/Django-Cookie%E5%92%8CSession/"/>
    <url>/Myblog/2018/10/26/Django-Cookie%E5%92%8CSession/</url>
    
    <content type="html"><![CDATA[<h3 id="登录验证问题"><a href="#登录验证问题" class="headerlink" title="登录验证问题"></a>登录验证问题</h3><p>产生问题：登录一个页面时，如果没有登录，访问页面时应该跳转到注册页面；如果登录成功，才可以正常访问页面。</p><p>访问：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">没登录情况： GET http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span><span class="hljs-regexp">/index/</span> ==&gt; login.html<br>登录情况： GET http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span><span class="hljs-regexp">/index/</span> ==&gt; index.html<br></code></pre></td></tr></table></figure><p>解决思路：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-number">1.</span>注册<br><span class="hljs-number">2.</span>登录成功（给一个标识符）<br>（<span class="hljs-number">1</span>）登录向页面的cookie中添加标识符<br>res = <span class="hljs-constructor">HttpResponseRedirect(<span class="hljs-params">reverse</span>(&#x27;<span class="hljs-params">user</span>:<span class="hljs-params">index</span>&#x27;)</span>)<br>res.set<span class="hljs-constructor">_cookies(<span class="hljs-params">key</span>, <span class="hljs-params">value</span>, <span class="hljs-params">max_age</span>（存活时间）)</span><br>（<span class="hljs-number">2</span>）向后端的usertoken表中存入这个标识符和登录的用户<br><span class="hljs-number">3.</span>访问任何的路由，先校验你的标识符是否正确，如果正确就访问，否则拒绝访问，跳转到注册页面，注册成功后登录可以获得随机的一个标识符。<br><span class="hljs-number">4.</span>使用的是闭包（装饰器）- 修饰登录和注销<br><span class="hljs-number">5.</span>注销<br>（<span class="hljs-number">1</span>）删除页面cookie中的标识符：delete<span class="hljs-constructor">_cookie(<span class="hljs-params">key</span>)</span><br>（<span class="hljs-number">2</span>）删除后端usertoken表中标识符对应的那一条数据<br><br></code></pre></td></tr></table></figure><h3 id="方案一：Cookie-自定义"><a href="#方案一：Cookie-自定义" class="headerlink" title="方案一：Cookie(自定义)"></a>方案一：Cookie(自定义)</h3><p>案例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login</span>(<span class="hljs-params">request</span>):</span><br><span class="hljs-comment"># 登录</span><br><span class="hljs-comment"># 验证登录完整性</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;login.html&#x27;</span>)<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        user = request.POST.get(<span class="hljs-string">&#x27;user&#x27;</span>)<br>        password = request.POST.get(<span class="hljs-string">&#x27;password&#x27;</span>)<br>        <span class="hljs-comment"># 验证完整性</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> all([user, password]):<br>            msg = <span class="hljs-string">&#x27;请填写完整的登录信息&#x27;</span><br>            <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;login.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;msg&#x27;</span>:msg&#125;)<br>        <span class="hljs-comment"># 验证用户是否注册</span><br>        user =  User.objects.filter(u_user=user).first()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:<br>            msg = <span class="hljs-string">&#x27;该用户没有注册&#x27;</span><br>            <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;login.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;msg&#x27;</span>:msg&#125;)<br>        <span class="hljs-comment"># 校验密码</span><br>        <span class="hljs-keyword">if</span> password != user.u_password:<br>            msg = <span class="hljs-string">&#x27;密码不正确&#x27;</span><br>            <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;login.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;msg&#x27;</span>:msg&#125;)<br>        res = HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:index&#x27;</span>))<br><br>        <span class="hljs-comment"># 生成随机的token（25位）</span><br>        token = <span class="hljs-string">&#x27;&#x27;</span><br>        s = <span class="hljs-string">&#x27;1234567890qazxswedcvfrtgbnhyujmkiolp&#x27;</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">25</span>):<br>        <span class="hljs-comment"># random.choice方法每次在序列中随机选一个数</span><br>            token += random.choice(s)<br>        <br>        <span class="hljs-comment"># 浏览器中设置cookie</span><br>        <span class="hljs-comment"># 设置cookie，set_cookie(key, value, max_age（存活时间）)</span><br>        res = HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:index&#x27;</span>))<br>        res.set_cookie(<span class="hljs-string">&#x27;token&#x27;</span>, token, max_age=<span class="hljs-number">6000</span>)<br><br><br>        <span class="hljs-comment"># 在数据库中存token值</span><br>        user_token = UserToken.objects.filter(user=user).first()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_token:<br>            UserToken.objects.create(t_token=token, user=user)<br>        <span class="hljs-keyword">else</span>:<br>            user_token.token=token<br>            user_token.save()<br><br>        <span class="hljs-keyword">return</span> res<br>        <br><span class="hljs-comment"># 注销时清除浏览器的cookie和数据库的token        </span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">logout</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-comment"># 1、删除cookie</span><br>        res = HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:login&#x27;</span>))<br>        res.delete_cookie(<span class="hljs-string">&#x27;token&#x27;</span>)<br>        <span class="hljs-comment"># 2、删除UserToken中的数据</span><br>        token = request.COOKIES.get(<span class="hljs-string">&#x27;token&#x27;</span>)<br>        UserToken.objects.filter(t_token=token).delete()<br><br>        <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure><h3 id="装饰器（闭包）"><a href="#装饰器（闭包）" class="headerlink" title="装饰器（闭包）"></a>装饰器（闭包）</h3><p>装饰器三个条件:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1</span>、外层函数套内层函数<br><span class="hljs-number">2</span>、内层函数调用外层函数的参数<br><span class="hljs-number">3</span>、外层函数返回内层函数<br><br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><br><span class="hljs-comment"># 大致结构：</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">record</span>(<span class="hljs-params">func</span>):</span><br><br><span class="hljs-meta">    @wraps(func)</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):</span><br><span class="hljs-comment"># 被装饰函数之前执行的代码</span><br>        ret_value = func(*args, **kwargs)<br>    <span class="hljs-comment"># 被装饰函数之后执行的代码</span><br>        <span class="hljs-keyword">return</span> ret_value<br><br>    <span class="hljs-keyword">return</span> wrapper <br></code></pre></td></tr></table></figure><p>装饰器案例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 装饰器</span><br><span class="hljs-keyword">from</span> django.urls <span class="hljs-keyword">import</span> reverse<br><br><span class="hljs-keyword">from</span> user.models <span class="hljs-keyword">import</span> UserToken<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login_required</span>(<span class="hljs-params">func</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_login</span>(<span class="hljs-params">request</span>):</span><br>        <span class="hljs-comment"># func是被login_required装饰的函数</span><br>        token = request.COOKIES.get(<span class="hljs-string">&#x27;token&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> token:<br>            <span class="hljs-keyword">return</span> HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:login&#x27;</span>))<br>        user_token = UserToken.objects.filter(t_token=token).first()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_token:<br>            <span class="hljs-comment"># token标识符有误，挑战到登录页面</span><br>            <span class="hljs-keyword">return</span> HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:login&#x27;</span>))<br>        <span class="hljs-keyword">return</span> func(request)<br><br>    <span class="hljs-keyword">return</span> check_login<br>    <br><span class="hljs-comment"># 被装饰函数</span><br><span class="hljs-meta">@login_required</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render(request,  <span class="hljs-string">&#x27;index.html&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="方案二：Cookie-Django自带"><a href="#方案二：Cookie-Django自带" class="headerlink" title="方案二：Cookie(Django自带)"></a>方案二：Cookie(Django自带)</h3><p>案例：</p><p>创建<code>forms.py</code>文件，用来对form表单数据进行验证</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django <span class="hljs-keyword">import</span> forms<br><span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> User<br><span class="hljs-comment"># User是django自带的表，数据库中为表auth_user</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRegister</span>(<span class="hljs-params">forms.Form</span>):</span><br>    name = forms.CharField(max_length=<span class="hljs-number">10</span>, min_length=<span class="hljs-number">2</span>, required=<span class="hljs-literal">True</span>, error_messages=&#123;<span class="hljs-string">&#x27;required&#x27;</span>:<span class="hljs-string">&#x27;姓名必填&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;min_length&#x27;</span>:<span class="hljs-string">&#x27;用户名最短2个字符&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;max_length&#x27;</span>:<span class="hljs-string">&#x27;用户名最长10个字符&#x27;</span>&#125;)<br>    pw = forms.CharField(max_length=<span class="hljs-number">20</span>, min_length=<span class="hljs-number">6</span>, required=<span class="hljs-literal">True</span>, error_messages=&#123;<span class="hljs-string">&#x27;required&#x27;</span>:<span class="hljs-string">&#x27;密码必填&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;min_length&#x27;</span>:<span class="hljs-string">&#x27;密码最短6个字符&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;max_length&#x27;</span>:<span class="hljs-string">&#x27;密码最长20个字符&#x27;</span>&#125;)<br>    pw2 = forms.CharField(max_length=<span class="hljs-number">20</span>, min_length=<span class="hljs-number">6</span>, required=<span class="hljs-literal">True</span>, error_messages=&#123;<span class="hljs-string">&#x27;required&#x27;</span>:<span class="hljs-string">&#x27;确认密码必填&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;min_length&#x27;</span>:<span class="hljs-string">&#x27;密码最短6个字符&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;max_length&#x27;</span>:<span class="hljs-string">&#x27;密码最长20个字符&#x27;</span>&#125;)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clean</span>(<span class="hljs-params">self</span>):</span><br>        user = User.objects.filter(username=self.cleaned_data.get(<span class="hljs-string">&#x27;name&#x27;</span>))<br>        pw = self.cleaned_data.get(<span class="hljs-string">&#x27;pw&#x27;</span>)<br>        pw2 = self.cleaned_data.get(<span class="hljs-string">&#x27;pw2&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> user:<br>        <span class="hljs-comment"># 抛出异常</span><br>            <span class="hljs-keyword">raise</span> forms.ValidationError(&#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;用户已经注册&#x27;</span>&#125;)<br>        <span class="hljs-keyword">if</span> pw != pw2:<br>            <span class="hljs-keyword">raise</span>  forms.ValidationError(&#123;<span class="hljs-string">&#x27;pw&#x27;</span>:<span class="hljs-string">&#x27;两次输入密码不同！&#x27;</span>&#125;)<br>        <span class="hljs-keyword">return</span> self.cleaned_data<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserLogin</span>(<span class="hljs-params">forms.Form</span>):</span><br>    name = forms.CharField(max_length=<span class="hljs-number">10</span>, min_length=<span class="hljs-number">2</span>, required=<span class="hljs-literal">True</span>, error_messages=&#123;<span class="hljs-string">&#x27;required&#x27;</span>:<span class="hljs-string">&#x27;姓名必填&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;min_length&#x27;</span>:<span class="hljs-string">&#x27;姓名最短2个字符&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;max_length&#x27;</span>:<span class="hljs-string">&#x27;姓名最长10个字符&#x27;</span>&#125;)<br>    pw = forms.CharField(max_length=<span class="hljs-number">20</span>, min_length=<span class="hljs-number">6</span>, required=<span class="hljs-literal">True</span>, error_messages=&#123;<span class="hljs-string">&#x27;required&#x27;</span>:<span class="hljs-string">&#x27;密码必填&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;min_length&#x27;</span>:<span class="hljs-string">&#x27;密码最短6个字符&#x27;</span>,<br>                                                                                       <span class="hljs-string">&#x27;max_length&#x27;</span>:<span class="hljs-string">&#x27;密码最长20个字符&#x27;</span>&#125;)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clean</span>(<span class="hljs-params">self</span>):</span><br>        user = User.objects.filter(username=self.cleaned_data.get(<span class="hljs-string">&#x27;name&#x27;</span>))<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:<br>            <span class="hljs-keyword">raise</span> forms.ValidationError(&#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;该账号没有注册&#x27;</span>&#125;)<br><br>        <span class="hljs-keyword">return</span> self.cleaned_data<br></code></pre></td></tr></table></figure><p><code>views.py</code>文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.contrib.auth.decorators <span class="hljs-keyword">import</span> login_required<br><span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> User<br><span class="hljs-keyword">from</span> django.contrib <span class="hljs-keyword">import</span> auth<br><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponseRedirect<br><span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> render<br><span class="hljs-keyword">from</span> django.urls <span class="hljs-keyword">import</span> reverse<br><br><span class="hljs-keyword">from</span> user.forms <span class="hljs-keyword">import</span> UserRegister,UserLogin<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">register</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-comment"># 注册</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;register.html&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        data = request.POST<br>        <span class="hljs-comment"># 校验form表单传递的参数</span><br>        form = UserRegister(data)<br>        <span class="hljs-keyword">if</span> form.is_valid():<br>            <span class="hljs-comment"># 使用django自带的User，导入django.contrib.auth.models</span><br>            User.objects.create_user(username=form.cleaned_data.get(<span class="hljs-string">&#x27;name&#x27;</span>), password=form.cleaned_data.get(<span class="hljs-string">&#x27;pw&#x27;</span>))<br>            <span class="hljs-keyword">return</span> HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:login&#x27;</span>))<br><br>        <span class="hljs-keyword">else</span>:<br>            error = form.errors<br>            <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;register.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;error&#x27;</span>:error&#125;)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-comment"># 登录</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;login.html&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        data = request.POST<br>        form = UserLogin(data)<br>        <span class="hljs-comment"># 如果验证通过form.is_valid()值为True，否则为False</span><br>        <span class="hljs-keyword">if</span> form.is_valid():<br>            <span class="hljs-comment"># 使用auth.authenticate获取对象，使用随机标识符也叫做签名token</span><br>            user = auth.authenticate(username=form.cleaned_data.get(<span class="hljs-string">&#x27;name&#x27;</span>), password=form.cleaned_data.get(<span class="hljs-string">&#x27;pw&#x27;</span>))<br>            <span class="hljs-keyword">if</span> user:<br>                <span class="hljs-comment"># 登录，向request.user属性赋值，赋值为登录系统的用户对象</span><br>                <span class="hljs-comment"># 1、向页面的cookie中设置sessionid值（标识符）</span><br>                <span class="hljs-comment"># 2、向django_session表中设置对应的值</span><br>                auth.login(request, user)<br>                <span class="hljs-keyword">return</span> HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:index&#x27;</span>))<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;login.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;msg&#x27;</span>:<span class="hljs-string">&#x27;密码错误&#x27;</span>&#125;)<br><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;login.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;errors&#x27;</span>:form.errors&#125;)<br><br><span class="hljs-comment"># 使用django自带的装饰器(验证用户是否登录)</span><br><span class="hljs-meta">@login_required</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;index.html&#x27;</span>)<br><br><span class="hljs-meta">@login_required</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">logout</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        auth.logout(request)<br>        <span class="hljs-keyword">return</span> HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:login&#x27;</span>))<br></code></pre></td></tr></table></figure><p>注：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 自己设置token时，可以导入以下方法来加密和解密</span><br><span class="hljs-keyword">from</span> django.contrib.auth.hashers <span class="hljs-keyword">import</span> make_password, check_password<br></code></pre></td></tr></table></figure><h3 id="方案三：Session-会话保持-Django自带"><a href="#方案三：Session-会话保持-Django自带" class="headerlink" title="方案三：Session(会话保持) - Django自带"></a>方案三：Session(会话保持) - Django自带</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">cookie和<span class="hljs-keyword">session</span>存放位置<br>cookie：存放在客户端<br><span class="hljs-keyword">session</span>：存放在服务端<br></code></pre></td></tr></table></figure><ul><li>登录时</li></ul><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># 向cookie中设置sessionid值</span><br><span class="hljs-meta"># 向django_session表中存sessionid值</span><br>request.session[<span class="hljs-string">&#x27;user_id&#x27;</span>] = user.id<br><span class="hljs-keyword">return</span> HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:index&#x27;</span>))<br></code></pre></td></tr></table></figure><ul><li>装饰器验证是否登录</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login_required</span>(<span class="hljs-params">func</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_login</span>(<span class="hljs-params">request</span>):</span><br>        <span class="hljs-keyword">try</span>:<br>            request.session[<span class="hljs-string">&#x27;user_id&#x27;</span>]<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> HttpResponseRedirect(reverse(<span class="hljs-string">&#x27;user:login&#x27;</span>))<br>        <span class="hljs-keyword">return</span> func(request)<br><br>    <span class="hljs-keyword">return</span> check_login<br></code></pre></td></tr></table></figure><ul><li>注销时删除设置的user_id</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">del</span> <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.session</span><span class="hljs-selector-attr">[<span class="hljs-string">&#x27;user_id&#x27;</span>]</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django模板和继承以及过滤器</title>
    <link href="/Myblog/2018/10/25/Django%E6%A8%A1%E6%9D%BF%E5%92%8C%E7%BB%A7%E6%89%BF%E4%BB%A5%E5%8F%8A%E8%BF%87%E6%BB%A4%E5%99%A8/"/>
    <url>/Myblog/2018/10/25/Django%E6%A8%A1%E6%9D%BF%E5%92%8C%E7%BB%A7%E6%89%BF%E4%BB%A5%E5%8F%8A%E8%BF%87%E6%BB%A4%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h3 id="管理urls"><a href="#管理urls" class="headerlink" title="管理urls"></a>管理urls</h3><p>每个应用定义自己的urls.py</p><ol><li>在项目urls.py中定义</li></ol><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">urlpatterns = [<br>    path(<span class="hljs-string">&#x27;&lt;应用名&gt;/&#x27;</span>, <span class="hljs-keyword">include</span>((<span class="hljs-string">&#x27;&lt;应用名&gt;.urls&#x27;</span>, <span class="hljs-string">&#x27;&lt;应用名&gt;&#x27;</span>), namespace=<span class="hljs-string">&#x27;&lt;应用名&gt;&#x27;</span>))<br>]<br></code></pre></td></tr></table></figure><ol start="2"><li>在应用中创建urls.py</li></ol><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> django.conf.urls <span class="hljs-keyword">import</span> url<br><span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> views<br><br><br>urlpatterns = [<br>    path(<span class="hljs-string">&#x27;index/&#x27;</span>, views.<span class="hljs-keyword">index</span>, <span class="hljs-type">name</span>=<span class="hljs-string">&#x27;index&#x27;</span>),<br><br>]<br></code></pre></td></tr></table></figure><h3 id="定义html模板"><a href="#定义html模板" class="headerlink" title="定义html模板"></a>定义html模板</h3><p><code>base.html</code> - 模板</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="xml">语法： </span><br><span class="xml">标签：  </span><span class="hljs-template-tag">&#123;% <span class="hljs-name">tag</span> %&#125;</span><span class="xml"> </span><span class="hljs-template-tag">&#123;% <span class="hljs-name">endtag</span> %&#125;</span><br><span class="xml">变量：  </span><span class="hljs-template-variable">&#123;&#123; a &#125;&#125;</span><br><br><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span></span><br><span class="xml">        </span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> title %&#125;</span><br><span class="xml">        </span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><br><span class="xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="xml">    </span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> content %&#125;</span><br><span class="xml">    </span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p><code>index.html</code> - 应用模板</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">extends</span></span> &#x27;base.html&#x27; %&#125;</span><span class="xml">  -- 继承</span><br><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> title %&#125;</span><br><span class="xml">    我是首页</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><br><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> content %&#125;</span><br><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>成都吴彦祖<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><br></code></pre></td></tr></table></figure><p>引入父模板之间的内容</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> js %&#125;</span><br><span class="xml"></span><span class="hljs-comment">&#123;# 注解 #&#125;</span><br><span class="xml">    <span class="hljs-comment">&lt;!--引入父模板block js中的内容--&gt;</span></span><br><span class="xml">    </span><span class="hljs-template-variable">&#123;&#123; block.super &#125;&#125;</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><br></code></pre></td></tr></table></figure><p>注释</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs twig"><span class="xml">单行注释</span><br><span class="xml"><span class="hljs-comment">&lt;!--这里是注释--&gt;</span>   查看源代码能看到</span><br><span class="hljs-comment">&#123;# 这里是注释 #&#125;</span><span class="xml">   查看源代码不能看到</span><br><span class="xml">多行注释</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name">comment</span> %&#125;</span><span class="xml">      查看源代码不能看到</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name">endcomment</span> %&#125;</span><br></code></pre></td></tr></table></figure><h3 id="引入CSS-JS"><a href="#引入CSS-JS" class="headerlink" title="引入CSS/JS"></a>引入CSS/JS</h3><p>添加文件夹static，添加子文件夹css和js，在css文件夹里面写入文件</p><p><code>settings.py</code>中添加</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 定义静态的路由</span><br><span class="hljs-attr">STATIC_URL</span> = <span class="hljs-string">&#x27;/static/&#x27;</span><br><span class="hljs-comment"># 指定静态目录static的地址</span><br><span class="hljs-attr">STATICFILES_DIRS</span> = [<br>    os.path.join(BASE_DIR, <span class="hljs-string">&#x27;static&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 第一种</span><br>&lt;link <span class="hljs-attribute">href</span>=<span class="hljs-string">&quot;static/css/index.css&quot;</span> <span class="hljs-attribute">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span>&gt;<br><span class="hljs-comment"># 第二种</span><br> &#123;% load static %&#125;<br> &lt;link <span class="hljs-attribute">href</span>=<span class="hljs-string">&quot;&#123;% static &#x27;css/index.css&#x27;&#125;&quot;</span> <span class="hljs-attribute">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><p>循环中使用<code>forloop.counter</code>计数</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="xml">&#123;% for stu in stus %&#125;</span><br><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span></span><br><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">forloop.counter</span> &#125;&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">stu.id</span> &#125;&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">stu.s_name</span> &#125;&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">stu.s_age</span> &#125;&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br><span class="xml">&#123;% endfor %&#125;</span><br><span class="xml"># counter从1开始打印序号，counter0从零开始的排序，revcounter反转排序，revcounter0反转</span><br><span class="xml"># forloop.first 循环第一次打印True，其余False；  forloop.last 循环最后一次打印True</span><br></code></pre></td></tr></table></figure><p>条件语句</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="xml"># 第一种</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">if</span></span> forloop.counter == 1 %&#125;</span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">em</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color:red;&quot;</span>&gt;</span></span><span class="hljs-template-variable">&#123;&#123; stu.s_name &#125;&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span></span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">else</span></span> %&#125;</span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123; stu.s_name &#125;&#125;</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endif</span></span> %&#125;</span><br><span class="xml"># 第二种</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">ifequal</span></span> forloop.counter 1 %&#125;</span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">em</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color:red;&quot;</span>&gt;</span></span><span class="hljs-template-variable">&#123;&#123; stu.s_name &#125;&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span></span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">else</span></span> %&#125;</span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123; stu.s_name &#125;&#125;</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endifequal</span></span> %&#125;</span><br></code></pre></td></tr></table></figure><h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><p><strong>一个好用的技巧</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">&#123;% widthratio a b c %&#125;<br>widthratio需要三个参数，它会使用 参数<span class="hljs-number">1</span>/参数<span class="hljs-number">2</span>*参数<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p>例子：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode">比如需要相乘<span class="hljs-symbol">n1</span>、<span class="hljs-symbol">n2</span><br>&#123;<span class="hljs-meta">%</span> widthratio <span class="hljs-symbol">n1</span> <span class="hljs-number">1</span> <span class="hljs-symbol">n2</span> <span class="hljs-meta">%</span>&#125;<br></code></pre></td></tr></table></figure><p>常用过滤器：</p><ul><li>safe - 阻止自动转义，原样输出</li><li>date - 时间格式显示</li><li>add - 加</li><li>lower - 变成全小写</li><li>upper - 变成全大写</li></ul><p>例子：</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">stu.s_age</span> | add:1&#125;&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>  # 加1操作 </span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">stu.create_time</span> | date:&#x27;Y-m-s H:m:s&#x27; &#125;&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>   #时间格式显示</span><br><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">content_h2</span> |safe &#125;&#125;</span><span class="xml">   # 原样输出</span><br></code></pre></td></tr></table></figure><p>Django內建过滤器大全</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="xml">1、add ：将value的值增加2。使用形式为：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | add:2 &#125;&#125;</span><span class="xml">。</span><br><span class="xml">2、addslashes：在value中的引号前增加反斜线。使用形式为：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | addslashes &#125;&#125;</span><span class="xml">。</span><br><span class="xml">3、capfirst：value的第一个字符转化成大写形式。使用形式为：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | capfirst &#125;&#125;</span><span class="xml">。</span><br><span class="xml">4、cut：从给定value中删除所有arg的值。使用形式为：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | cut:arg&#125;&#125;</span><span class="xml">。</span><br><span class="xml">5、date: 格式化时间格式。使用形式为：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | date:&quot;Y-m-d H:m:s&quot; &#125;&#125;</span><br><span class="xml">6、default：如果value是False，那么输出使用缺省值。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | default: <span class="hljs-string">&quot;nothing&quot;</span> &#125;&#125;</span><span class="xml">。例如，如果value是“”，那么输出将是nothing</span><br><span class="xml">7、default_if_none：如果value是None，那么输出将使用缺省值。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | default_if_none:&quot;nothing&quot; &#125;&#125;</span><span class="xml">，例如，如果value是None，那么输出将是nothing</span><br><span class="xml">8、dictsort：如果value的值是一个字典，那么返回值是按照关键字排序的结果</span><br><span class="xml">使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | dictsort:&quot;name&quot;&#125;&#125;</span><span class="xml">，例如，</span><br><span class="xml">如果value是：</span><br><span class="xml">[&#123;&#x27;name&#x27;: &#x27;python&#x27;&#125;,&#123;&#x27;name&#x27;: &#x27;java&#x27;&#125;,&#123;&#x27;name&#x27;: &#x27;c++&#x27;&#125;,]</span><br><span class="xml">那么，输出是：</span><br><span class="xml">[&#123;&#x27;name&#x27;: &#x27;c++&#x27;&#125;,&#123;&#x27;name&#x27;: &#x27;java&#x27;&#125;,&#123;&#x27;name&#x27;: &#x27;python&#x27;&#125;, ]</span><br><span class="xml">9、dictsortreversed：如果value的值是一个字典，那么返回值是按照关键字排序的结果的反序。使用形式：与dictsort过滤器相同。</span><br><span class="xml">10、divisibleby：如果value能够被arg整除，那么返回值将是True。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | divisibleby:arg&#125;&#125;</span><span class="xml">，如果value是9，arg是3，那么输出将是True</span><br><span class="xml">11、escape：替换value中的某些字符，以适应HTML格式。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | escape&#125;&#125;</span><span class="xml">。例如，<span class="hljs-tag">&lt; 转化为 &amp;<span class="hljs-attr">lt</span>;&gt;</span> 转化为 <span class="hljs-symbol">&amp;gt;</span>&#x27; 转化为  <span class="hljs-symbol">&amp;#39;</span>&quot; 转化为  <span class="hljs-symbol">&amp;quot;</span></span><br><span class="xml">13、filesizeformat：格式化value，使其成为易读的文件大小。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | filesizeformat &#125;&#125;</span><span class="xml">。例如：13KB，4.1MB等。</span><br><span class="xml">14、first：返回列表/字符串中的第一个元素。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | first &#125;&#125;</span><br><span class="xml">16、iriencode：如果value中有非ASCII字符，那么将其进行转化成URL中适合的编码，如果value已经进行过URLENCODE，改操作就不会再起作用。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | iriencode&#125;&#125;</span><br><span class="xml">17、join：使用指定的字符串连接一个list，作用如同python的str.join(list)。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | join:&quot;arg&quot;&#125;&#125;</span><span class="xml">，如果value是[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]，arg是&#x27;//&#x27;那么输出是a//b//c</span><br><span class="xml">18、last：返回列表/字符串中的最后一个元素。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | last &#125;&#125;</span><br><span class="xml">19、length：返回value的长度。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | length &#125;&#125;</span><br><span class="xml">20、length_is：如果value的长度等于arg的时候返回True。使用形式：</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">value</span> | length_is:&quot;arg&quot;&#125;&#125;</span><span class="xml">。例如：如果value是[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]，arg是3，那么返回True</span><br><span class="xml">21、linebreaks：value中的&quot;\n&quot;将被<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>替代，并且整个value使用<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>包围起来。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span>|linebreaks&#125;&#125;</span><br><span class="xml">22、linebreaksbr：value中的&quot;\n&quot;将被<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>替代。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> |linebreaksbr&#125;&#125;</span><br><span class="xml">23、linenumbers：显示的文本，带有行数。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | linenumbers&#125;&#125;</span><br><span class="xml">24、ljust：在一个给定宽度的字段中，左对齐显示value。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | ljust&#125;&#125;</span><br><span class="xml">25、center：在一个给定宽度的字段中，中心对齐显示value。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | center&#125;&#125;</span><br><span class="xml">26、rjust：：在一个给定宽度的字段中，右对齐显示value。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | rjust&#125;&#125;</span><br><span class="xml">27、lower：将一个字符串转换成小写形式。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | lower&#125;&#125;</span><br><span class="xml">30、random：从给定的list中返回一个任意的Item。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | random&#125;&#125;</span><br><span class="xml">31、removetags：删除value中tag1,tag2....的标签。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | removetags:&quot;tag1 tag2 tag3...&quot;&#125;&#125;</span><br><span class="xml">32、safe：当系统设置autoescaping打开的时候，该过滤器使得输出不进行escape转换。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | safe&#125;&#125;</span><br><span class="xml">33、safeseq：与safe基本相同，但有一点不同的就是：safe是针对字符串，而safeseq是针对多个字符串组成的sequence</span><br><span class="xml">34、slice：与python语法中的slice相同。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">some_list</span> | slice:&quot;2&quot;&#125;&#125;</span><br><span class="xml">37、striptags：删除value中的所有HTML标签.使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | striptags&#125;&#125;</span><br><span class="xml">38、time：格式化时间输出。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | time:&quot;H:i&quot;&#125;&#125;</span><span class="xml">或者</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | time&#125;&#125;</span><br><span class="xml">39、title：转换一个字符串成为title格式。</span><br><span class="xml">40、truncatewords：将value切成truncatewords指定的单词数目。使用形式：</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span> | truncatewords:2&#125;&#125;</span><span class="xml">。例如，如果value是Joel is a slug 那么输出将是：Joel is ...</span><br><span class="xml">42、upper：转换一个字符串为大写形式</span><br><span class="xml">43、urlencode：将一个字符串进行URLEncode</span><br><span class="xml">46、wordcount：返回字符串中单词的数目</span><br></code></pre></td></tr></table></figure><h3 id="页面跳转"><a href="#页面跳转" class="headerlink" title="页面跳转"></a>页面跳转</h3><p>第一种</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="xml"># 地址是硬编码</span><br><span class="xml">return HttpResponseRedirect(&#x27;/app/index/&#x27;)</span><br><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/app/edit_stu/</span></span></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">stu.id</span> &#125;&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span>&gt;</span>编辑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>第二种</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"># 使用反向解析reverse(<span class="hljs-string">&#x27;namespace:name&#x27;</span>)<br># 应用中include使用参数<span class="hljs-keyword">namespace</span>，<span class="hljs-symbol">url</span>使用<span class="hljs-symbol">name</span><br><span class="hljs-symbol">return</span> <span class="hljs-symbol">HttpResponseRedirect</span>(<span class="hljs-symbol">reverse</span>(&#x27;<span class="hljs-symbol">dj</span>:<span class="hljs-symbol">all</span>&#x27;))<br><br>&lt;<span class="hljs-symbol">a</span> <span class="hljs-symbol">href</span>=&quot;&#123;% url <span class="hljs-string">&#x27;dy:edit&#x27;</span> stu.id %&#125;<span class="hljs-string">&quot;&gt;编辑&lt;/a&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django模型关联关系</title>
    <link href="/Myblog/2018/10/24/Django%E6%A8%A1%E5%9E%8B%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB/"/>
    <url>/Myblog/2018/10/24/Django%E6%A8%A1%E5%9E%8B%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB/</url>
    
    <content type="html"><![CDATA[<h3 id="模型关联关系"><a href="#模型关联关系" class="headerlink" title="模型关联关系"></a>模型关联关系</h3><p>  1、一对一：OneToOneField</p>  <figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># 已知a对象，查找b对象：a.b</span><br><span class="hljs-comment"># 已知b对象，查找a对象：b.a ，其中a名称变成小写</span><br><span class="hljs-built_in">class</span> A:<br><span class="hljs-built_in">name</span> = xxx<br>...<br>b = models.OneToOneField(B)  <span class="hljs-comment"># 一对一可以写在任意一个模型中</span><br><br><span class="hljs-built_in">class</span> B:<br><span class="hljs-built_in">name</span> = xxx<br>...<br></code></pre></td></tr></table></figure><p>  例子：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># models.py文件</span><br>class StudentInfo(models.Model):<br>    phone = models.CharField(<span class="hljs-attribute">max_length</span>=11, <span class="hljs-attribute">null</span>=<span class="hljs-literal">True</span>)<br>   <span class="hljs-built_in"> address </span>= models.CharField(<span class="hljs-attribute">max_length</span>=100)<br>    # OneToOneField - 指定一对一的关联关系,该字段定义在任何一个模型中都可以<br>    stu = models.OneToOneField(Student)<br><br>    class Meta:<br>        db_table = <span class="hljs-string">&#x27;student_info&#x27;</span><br>        <br><span class="hljs-comment"># views.py文件</span><br><span class="hljs-comment"># 1、a.b</span><br>def sel_stu_by_info(request):<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        # 知道手机号码12334567，找人<br>        <span class="hljs-builtin-name">info</span> = StudentInfo.objects.<span class="hljs-builtin-name">get</span>(<span class="hljs-attribute">phone</span>=<span class="hljs-string">&#x27;12334567&#x27;</span>)<br>        student = info.stu<br>        stu_info = f<span class="hljs-string">&#x27;姓名:&#123;student.s_name&#125;,年龄:&#123;student.s_age&#125;&#x27;</span><br>        return HttpResponse(stu_info)<br><br><span class="hljs-comment"># 2、b.a</span><br>def sel_info_by_stu(request):<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        # 通过学生查询拓展表信息<br>        stu = Student.objects.<span class="hljs-builtin-name">get</span>(<span class="hljs-attribute">s_name</span>=<span class="hljs-string">&#x27;辰辰&#x27;</span>)<br>        # 第一种<br>        <span class="hljs-builtin-name">info</span> = StudentInfo.objects.filter(<span class="hljs-attribute">stu_id</span>=stu.id)<br>        <span class="hljs-builtin-name">info</span> = StudentInfo.objects.filter(<span class="hljs-attribute">stu</span>=stu)<br>        <br>        # 第二种,学生对象.关联的模型名的小写<br>        <span class="hljs-builtin-name">info</span> = stu.studentinfo<br>        <br>        return HttpResponse(<span class="hljs-string">&#x27;通过学生查询查找拓展表的信息&#x27;</span>)<br></code></pre></td></tr></table></figure><p>2、一对多：ForeignKey</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># 已知a对象，查找b对象: a.b</span><br><span class="hljs-comment"># 已知b对象，查找b对象: b.a_set</span><br><span class="hljs-built_in">class</span> A:<br><span class="hljs-built_in">name</span> = xxx<br>b = models.ForeignKey(B) <span class="hljs-comment"># 多对一中能写在多对应的模型中</span><br><br><span class="hljs-built_in">class</span> B:<br><span class="hljs-built_in">name</span> = xxx<br></code></pre></td></tr></table></figure><p>例子：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># models.py文件</span><br>class Grade(models.Model):<br>    g_name = models.CharField(<span class="hljs-attribute">max_length</span>=10, <span class="hljs-attribute">unique</span>=<span class="hljs-literal">True</span>)<br><br>    class Meta:<br>        db_table = <span class="hljs-string">&#x27;grade&#x27;</span><br><br>class Student(models.Model):<br>    # 定义s_name字段，varchar类型，最长不超过6字符，唯一<br>    s_name = models.CharField(<span class="hljs-attribute">max_length</span>=6, <span class="hljs-attribute">unique</span>=<span class="hljs-literal">True</span>)<br>    # 定义s_age字段，int类型, 默认长度18<br>    s_age = models.IntegerField(<span class="hljs-attribute">default</span>=18)<br>    # 定义s_gender字段， int：类型<br>    s_gender = models.BooleanField(<span class="hljs-attribute">default</span>=1)<br>    # 定义创建时间<br>    create_time = models.DateTimeField(<span class="hljs-attribute">auto_now_add</span>=<span class="hljs-literal">True</span>, <span class="hljs-attribute">null</span>=<span class="hljs-literal">True</span>) # 创建时赋予时间，以后不修改<br>    # 定义修改时间<br>    operate_time = models.DateTimeField(<span class="hljs-attribute">auto_now</span>=<span class="hljs-literal">True</span>, <span class="hljs-attribute">null</span>=<span class="hljs-literal">True</span>) # 每次修改赋予新的时间<br>    # 定义语文成绩<br>    chinese = models.DecimalField(<span class="hljs-attribute">decimal_places</span>=1,max_digits=4, <span class="hljs-attribute">null</span>=<span class="hljs-literal">True</span>)<br>    # 定义数学成绩<br>    math = models.DecimalField(<span class="hljs-attribute">decimal_places</span>=1, <span class="hljs-attribute">max_digits</span>=4, <span class="hljs-attribute">null</span>=<span class="hljs-literal">True</span>)<br>    # 一对多的模型，只能把外键定义在多的一遍<br>    grade = models.ForeignKey(Grade, <span class="hljs-attribute">null</span>=<span class="hljs-literal">True</span>)<br><br>    class Meta:<br>        # 定义模型迁移到数据库中时的表名<br>        # 表名是student<br>        db_table = <span class="hljs-string">&#x27;student&#x27;</span><br>        <br><span class="hljs-comment"># views.py文件</span><br>def sel_stu_grade(request):<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>    <br>        # 1、通过学生查找班级 - a.b<br>        stu = Student.objects.filter(<span class="hljs-attribute">s_name</span>=<span class="hljs-string">&#x27;老王&#x27;</span>).first()<br>        grade = stu.grade<br>        grade_info = f<span class="hljs-string">&#x27;姓名：&#123;stu.s_name&#125;, 班级：&#123;grade.g_name&#125;&#x27;</span><br>        return HttpResponse(grade_info)<br><br>        # 2、通过班级查找学生 - b.a_set <br>        grade = Grade.objects.filter(<span class="hljs-attribute">g_name</span>=<span class="hljs-string">&#x27;艺术&#x27;</span>).first()<br>        students = grade.student_set.all()<br>        <span class="hljs-builtin-name">print</span>(students)<br>        return HttpResponse(<span class="hljs-string">&#x27;查询所有对应班级信息&#x27;</span>)<br></code></pre></td></tr></table></figure><p>  3、多对多：ManyToManyField</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"># 已知a对象，查找b对象: a.b<br># 已知b对象，查找b对象: b.a_set<br># add - 添加 ； remove - 删除<br><span class="hljs-keyword">class</span> <span class="hljs-symbol">A:</span><br><span class="hljs-symbol">name</span> = <span class="hljs-symbol">xxx</span><br><span class="hljs-symbol">b</span> = <span class="hljs-symbol">ManyToManyField</span>(<span class="hljs-symbol">B</span>) # 多对多中能写在任意一个模型中<br><br><span class="hljs-symbol">class</span> <span class="hljs-symbol">B:</span><br><span class="hljs-symbol">name</span> = <span class="hljs-symbol">xxx</span><br></code></pre></td></tr></table></figure><p>例子：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># models.py</span><br>class Course(models.Model):<br>    c_name = models.CharField(<span class="hljs-attribute">max_length</span>=10, <span class="hljs-attribute">null</span>=<span class="hljs-literal">True</span>)<br>    # 多对多字段<br>    stu = models.ManyToManyField(Student)<br><br>    class Meta:<br>        db_table = <span class="hljs-string">&#x27;course&#x27;</span><br><br><span class="hljs-comment"># views.py文件</span><br>def add_stu_course(request):<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        cous = Course.objects.all()<br>        return render(request, <span class="hljs-string">&#x27;course.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;cous&#x27;</span>:cous&#125;)<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        # 获取课程id和学生id<br>        c_id = request.POST.<span class="hljs-builtin-name">get</span>(<span class="hljs-string">&#x27;cous_id&#x27;</span>)<br>        s_id = request.GET.<span class="hljs-builtin-name">get</span>(<span class="hljs-string">&#x27;stu_id&#x27;</span>)<br><br>        stu = Student.objects.<span class="hljs-builtin-name">get</span>(<span class="hljs-attribute">pk</span>=s_id)<br>        # 设置学生和课程的关联关系<br>        course = Course.objects.<span class="hljs-builtin-name">get</span>(<span class="hljs-attribute">pk</span>=c_id)<br>        stu.course_set.<span class="hljs-builtin-name">add</span>(course) # 添加<br>        # <span class="hljs-builtin-name">add</span> ==&gt;&gt; <span class="hljs-builtin-name">remove</span>() 删除<br>        return HttpResponse(<span class="hljs-string">&#x27;选课成功!&#x27;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django基础</title>
    <link href="/Myblog/2018/10/22/Django%E5%9F%BA%E7%A1%80/"/>
    <url>/Myblog/2018/10/22/Django%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h3 id="MVC-Mode-View-Controller"><a href="#MVC-Mode-View-Controller" class="headerlink" title="MVC(Mode View Controller)"></a>MVC(Mode View Controller)</h3><p>Model: 即数据存取层。用于封装于应用程序的业务逻辑相关的数据，以及对数据的处理。说白了就是模型对象负责在数据库中存取数据</p><p>View: 即表现层。负责数据的显示和呈现。渲染的html页面给用户，或者返回数据给用户。</p><p>Controller: 即业务逻辑层。负责从用户端收集用户的输入，进行业务逻辑处理，包括向模型中发送数据，进行CRUD操作。</p><h3 id="Django的模式简介-MVT模式"><a href="#Django的模式简介-MVT模式" class="headerlink" title="Django的模式简介 - MVT模式"></a>Django的模式简介 - MVT模式</h3><p>严格来说，Django的模式应该是MVT模式，本质上和MVC没什么区别，也是各组件之间为了保持松耦合关系，只是定义上有些许不同。</p><p>Model： 负责业务与数据库(ORM)的对象</p><p>View： 负责业务逻辑并适当调用Model和Template</p><p>Template: 负责把页面渲染展示给用户</p><p>注意： Django中还有一个url分发器，也叫作路由。主要用于将url请求发送给不同的View处理，View在进行相关的业务逻辑处理。</p><h3 id="安装虚拟环境"><a href="#安装虚拟环境" class="headerlink" title="安装虚拟环境"></a>安装虚拟环境</h3><h5 id="安装virtualenv"><a href="#安装virtualenv" class="headerlink" title="安装virtualenv"></a>安装virtualenv</h5><p><code>pip install  virtualenv</code></p><h5 id="创建虚拟环境"><a href="#创建虚拟环境" class="headerlink" title="创建虚拟环境"></a>创建虚拟环境</h5><p>进入你需要创建虚拟环境的目录</p><p><code>virtualenv --no-site-packages djenv</code></p><p>参数说明：<code>--no-site-packages</code>获得一个纯净的Python虚拟环境，<code>-p + &lt;版本路径&gt;</code>指定python版本</p><h5 id="进入-退出env"><a href="#进入-退出env" class="headerlink" title="进入/退出env"></a>进入/退出env</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">进入 cd djenv<span class="hljs-regexp">/Scripts/</span>文件夹    再使用activate命令<br>退出 deactivate<br></code></pre></td></tr></table></figure><h3 id="安装Django"><a href="#安装Django" class="headerlink" title="安装Django"></a>安装Django</h3><p><code>python3.6 + django</code></p><p>安装django</p><p><code>pip install django</code></p><p>安装数据库驱动</p><p><code>pip install pymysql</code></p><h3 id="创建Django项目"><a href="#创建Django项目" class="headerlink" title="创建Django项目"></a>创建Django项目</h3><p>在虚拟环境下</p><p><code>django-admin startproject &lt;文件名&gt;</code></p><p>用pycharm打开项目，并使用创建好的虚拟环境</p><ul><li><p>Django目录结构：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs css">.<br>├── <span class="hljs-selector-tag">day01</span><br>│   ├── __<span class="hljs-selector-tag">init__</span><span class="hljs-selector-class">.py</span> <br>│   ├── <span class="hljs-selector-tag">settings</span><span class="hljs-selector-class">.py</span> <br>│   ├── <span class="hljs-selector-tag">urls</span><span class="hljs-selector-class">.py</span><br>│   └── <span class="hljs-selector-tag">wsgi</span><span class="hljs-selector-class">.py</span><br>└── <span class="hljs-selector-tag">manage</span><span class="hljs-selector-class">.py</span> <span class="hljs-selector-tag">-</span> 工具集管理入口<br></code></pre></td></tr></table></figure></li><li><p>终端启动:</p><p><code>python manage.py runserver 0.0.0.0:8080</code></p><p>修改manage.py 中：</p><p><code>LANGUAGE_CODE = &#39;zh-hans&#39;</code> - 字体</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 避免出现插入时间出现偏移</span><br><span class="hljs-comment"># 设置时区(东八区)</span><br><span class="hljs-attr">TIME_ZONE</span> = <span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span><br><span class="hljs-attr">USE_TZ</span> = <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><p><code>ALLOWED_HOSTS = [&#39;*&#39;]</code></p><p>启动添加0.0.0.0表示允许所有ip访问</p></li></ul><h3 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h3><ul><li><p>修改<code>manager.py</code>文件</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs 1c">DATABASES = &#123;<br>  &#x27;default&#x27;: &#123;<br>      &#x27;ENGINE&#x27;: &#x27;django.db.backends.mysql&#x27;,<br>      &#x27;NAME&#x27;: &#x27;dj6&#x27;,<br>      &#x27;USER&#x27;: &#x27;root&#x27;,<br>      &#x27;PASSWORD&#x27;: &#x27;<span class="hljs-number">123456</span>&#x27;,<br>      &#x27;HOST&#x27;: &#x27;127.0.0.1&#x27;,<br>      &#x27;PORT&#x27;: <span class="hljs-number">3306</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>修改<code>__init__.py</code>文件</p><p>因为python3不能直接连接数据库</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-keyword">import</span> pymysql<br><br><span class="hljs-title">pymysql</span>.install_as_MySQLdb()<br></code></pre></td></tr></table></figure></li></ul><ul><li><p>映射模型到数据库中(自动创建一些表)</p><p><code>python manage.py migrate</code></p></li><li><p>创建超级管理员</p><p><code>createsuperuser</code></p></li></ul><h3 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h3><ul><li>创建应用</li></ul><p><code>python manage.py startapp &lt;app_name&gt;</code></p><p>执行上面的命令会创建<app_name>目录，结构如下：</p><ul><li><code>__init__.py</code>：一个空文件，告诉 Python 这个目录应该被认为是一个 Python 包。</li><li><code>admin.py</code>：可以用来注册模型，让Django自动创建管理界面。</li><li><code>apps.py</code>：当前应用的配置。</li><li><code>migrations</code>：存放与模型有关的数据库迁移信息。<ul><li><code>__init__.py</code>：一个空文件，告诉 Python 这个目录应该被认为是一个 Python 包。</li></ul></li><li><code>models.py</code>：存放应用的数据模型，即实体类及其之间的关系（MVC/MVT中的M）。</li><li><code>tests.py</code>：包含测试应用各项功能的测试类和测试函数。</li><li><code>views.py</code>：处理请求并返回响应的函数（MVC中的C，MVT中的V）。</li></ul><p>在<code>settings</code>里面<code>INSTALLED_APPS</code>添加<app_name>字段</p><h4 id="简单调试"><a href="#简单调试" class="headerlink" title="简单调试"></a>简单调试</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> views<br><br># <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8080</span>/hello<br>path(<span class="hljs-string">&#x27;hello/&#x27;</span>, views.hello),<br></code></pre></td></tr></table></figure><ul><li>响应函数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> HttpResponse<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hello</span>(<span class="hljs-params">request</span>):</span><br>    <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">&#x27;Hello,Deathfeeling.&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nix">class Student(models.Model):<br>    <span class="hljs-comment"># 定义s_name字段，varchar类型，最长不超过6字符，唯一</span><br>    <span class="hljs-attr">s_name</span> = models.CharField(<span class="hljs-attr">max_length=6,</span> <span class="hljs-attr">unique=True)</span><br>    <span class="hljs-comment"># 定义s_age字段，int类型, 默认长度18</span><br>    <span class="hljs-attr">s_age</span> = models.IntegerField(<span class="hljs-attr">default=18)</span><br>    <span class="hljs-comment"># 定义s_gender字段， int：类型</span><br>    <span class="hljs-attr">s_gender</span> = models.BooleanField(<span class="hljs-attr">default=1)</span><br>    <span class="hljs-comment"># 定义创建时间</span><br>    <span class="hljs-attr">create_time</span> = models.DateTimeField(<span class="hljs-attr">auto_now_add=True,</span> <span class="hljs-attr">null=True)</span> <span class="hljs-comment"># 创建时赋予时间，以后不修改</span><br>    <span class="hljs-comment"># 定义修改时间</span><br>    <span class="hljs-attr">operate_time</span> = models.DateTimeField(<span class="hljs-attr">auto_now=True,</span> <span class="hljs-attr">null=True)</span> <span class="hljs-comment"># 每次修改赋予新的时间</span><br><br>    class Meta:<br>        <span class="hljs-comment"># 定义模型迁移到数据库中时的表名</span><br>        <span class="hljs-comment"># 表名是student</span><br>        <span class="hljs-attr">db_table</span> = &#x27;student&#x27;<br></code></pre></td></tr></table></figure><h4 id="迁移"><a href="#迁移" class="headerlink" title="迁移"></a>迁移</h4><p><code>python manage.py makemigrations</code> 生成迁移文件</p><p><code>python manage.py migrate</code> 迁移表</p><p>数据库中会生成对应创建的表</p><h4 id="模型的CRUD"><a href="#模型的CRUD" class="headerlink" title="模型的CRUD"></a>模型的CRUD</h4><h6 id="配置url"><a href="#配置url" class="headerlink" title="配置url"></a>配置url</h6><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> views<br><br>path(<span class="hljs-string">&#x27;create_stu/&#x27;</span>, views.create_stu),<br></code></pre></td></tr></table></figure><p>其他类似</p><h6 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h6><p>执行该方法的时候，插入数据</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_stu</span><span class="hljs-params">(request)</span></span><span class="hljs-symbol">:</span><br>    <span class="hljs-comment"># 第一种方式：创建学生</span><br>    <span class="hljs-comment"># stu = Student()</span><br>    <span class="hljs-comment"># stu.s_name = &#x27;Deathfeeling&#x27;</span><br>    <span class="hljs-comment"># stu.s_age = 18</span><br>    <span class="hljs-comment"># stu.save()</span><br><br>    <span class="hljs-comment"># 第二种方式 - 推荐</span><br>    Student.objects.create(s_name=<span class="hljs-string">&#x27;小王&#x27;</span>, s_age=<span class="hljs-number">19</span>)<br><br>    <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">&#x27;创建成功！&#x27;</span>)<br></code></pre></td></tr></table></figure><h6 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h6><ul><li>配置url</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">path</span><span class="hljs-params">(<span class="hljs-string">&#x27;sel_stu/&#x27;</span>, views.sel_stu)</span></span>,<br></code></pre></td></tr></table></figure><ul><li><p>查询</p><ul><li><p>查询所有</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sel_stu</span><span class="hljs-params">(request)</span></span><span class="hljs-symbol">:</span><br><span class="hljs-comment"># 实现查询 </span><br>    stus = Student.objects.all() <span class="hljs-comment"># 查询所有对象的信息</span><br></code></pre></td></tr></table></figure></li><li><p>过滤 - filter() : first() 获取第一个,last() 获取最后一个</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 查询到指定的对象的信息</span><br><span class="hljs-attr">stus</span> = Student.objects.filter(s_name=<span class="hljs-string">&#x27;星辰&#x27;</span>)<br></code></pre></td></tr></table></figure></li><li><p>get() - 容易出错，所以不推荐使用。</p><p>注意：1、条件不满足获取不到数据，报错；2、条件返回数据多个，报错。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">stus = Student.objects.<span class="hljs-builtin-name">get</span>(<span class="hljs-attribute">s_name</span>=<span class="hljs-string">&#x27;星辰&#x27;</span>)<br></code></pre></td></tr></table></figure></li><li><p>模糊查询</p><ul><li><p>包含</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">stus</span> = Student.objects.filter(s_name__contains=<span class="hljs-string">&#x27;王&#x27;</span>)<br></code></pre></td></tr></table></figure></li><li><p>以*开始</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta"># s_name__startswith=<span class="hljs-string">&#x27;*&#x27;</span></span><br></code></pre></td></tr></table></figure></li><li><p>以*结束</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta"># s_name__endswith=<span class="hljs-string">&#x27;*&#x27;</span></span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>大于等于gt/gte 小于等于lt/lte</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">stus</span> = Student.objects.filter(s_age__gt=<span class="hljs-number">19</span>)<br></code></pre></td></tr></table></figure></li><li><p>排序 - order_by()</p><ul><li><p>升序</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">stus = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>objects.order<span class="hljs-constructor">_by(&#x27;<span class="hljs-params">id</span>&#x27;)</span><br></code></pre></td></tr></table></figure></li><li><p>降序</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">stus = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>objects.order<span class="hljs-constructor">_by(&#x27;-<span class="hljs-params">id</span>&#x27;)</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>查询不满足条件的数据 - exclude()</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">stus</span> = Student.objects.exclude(s_age=<span class="hljs-number">19</span>)<br></code></pre></td></tr></table></figure></li><li><p>统计个数 - count(), len()</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">stus_count = stus.count()<br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(stus_count)</span></span><br></code></pre></td></tr></table></figure></li><li><p>values() - 返回列表嵌套字典</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">stus_values</span> = stus.values()<br></code></pre></td></tr></table></figure></li><li><p>id=pk</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">stus</span> = Student.objects.filter(id=<span class="hljs-number">2</span>)<br><span class="hljs-attr">stus</span> = Student.objects.filter(pk=<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure></li><li><p>或条件 - Q() - 对应包</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">stus = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>objects.filter(<span class="hljs-constructor">Q(<span class="hljs-params">s_age</span>=20)</span> <span class="hljs-pattern-match">| <span class="hljs-constructor">Q(<span class="hljs-params">s_gender</span>=0)</span>)</span><br></code></pre></td></tr></table></figure></li><li><p>且条件</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">stus = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>objects.filter(<span class="hljs-constructor">Q(<span class="hljs-params">s_age</span>=20)</span> &amp; <span class="hljs-constructor">Q(<span class="hljs-params">s_gender</span>=1)</span>)<br>stus = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>objects.filter(<span class="hljs-constructor">Q(<span class="hljs-params">s_age</span>=20)</span>, <span class="hljs-constructor">Q(<span class="hljs-params">s_gender</span>=1)</span>)<br></code></pre></td></tr></table></figure></li><li><p>非条件</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">stus = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>objects.filter(~<span class="hljs-constructor">Q(<span class="hljs-params">s_age</span>=20)</span>)<br></code></pre></td></tr></table></figure></li><li><p>比较 - F() - 和Q()是一个包，导入即可</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 查询语文成绩比数学成绩大的学生信息</span><br><span class="hljs-attr">stus</span> = Student.objects.filter(chinese__gt=F(<span class="hljs-string">&#x27;math&#x27;</span>))<br></code></pre></td></tr></table></figure></li></ul></li></ul><h6 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h6><ul><li><p>配置url</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">path</span><span class="hljs-params">(<span class="hljs-string">&#x27;del_stu/&#x27;</span>, views.del_stu)</span></span>,<br></code></pre></td></tr></table></figure></li><li><p>删除</p></li></ul><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">del_stu</span><span class="hljs-params">(request)</span></span><span class="hljs-symbol">:</span><br>    <span class="hljs-comment"># 删除</span><br>    Student.objects.filter(s_name=<span class="hljs-string">&#x27;small唐&#x27;</span>).delete()<br>    <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">&#x27;删除成功！&#x27;</span>)<br></code></pre></td></tr></table></figure><h6 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h6><ul><li>配置url</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">path</span><span class="hljs-params">(<span class="hljs-string">&#x27;update_stu/&#x27;</span>, views.update_stu)</span></span>,<br></code></pre></td></tr></table></figure><ul><li>更新</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">def update_stu(request):<br>    # 第一种方法<br>    stu = Student.objects.filter(<span class="hljs-attribute">s_name</span>=<span class="hljs-string">&#x27;小明&#x27;</span>).first()<br>    # Student.objects.<span class="hljs-builtin-name">get</span>(<span class="hljs-attribute">s_name</span>=<span class="hljs-string">&#x27;小明&#x27;</span>)<br>    stu.s_name = <span class="hljs-string">&#x27;小花&#x27;</span><br>    stu.save(<br>    <br>    # 第二种方法 - 推荐<br>    Student.objects.filter(<span class="hljs-attribute">s_name</span>=<span class="hljs-string">&#x27;小花&#x27;</span>).update(s_name=&#x27;小明&#x27;)<br>    return HttpResponse(<span class="hljs-string">&#x27;修改成功！&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="添加templates"><a href="#添加templates" class="headerlink" title="添加templates"></a>添加templates</h3><p>添加url</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">path</span><span class="hljs-params">(<span class="hljs-string">&#x27;all_stu/&#x27;</span>, views.all_stu)</span></span>,<br></code></pre></td></tr></table></figure><p>响应函数</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">all_stu</span><span class="hljs-params">(request)</span></span><span class="hljs-symbol">:</span><br>    <span class="hljs-comment"># 获取所有学生信息</span><br>    stus = Student.objects.all()<br>    <span class="hljs-comment"># 返回页面</span><br>    <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">&#x27;stus.html&#x27;</span>, &#123;<span class="hljs-string">&#x27;students&#x27;</span><span class="hljs-symbol">:stus</span>&#125;)<br></code></pre></td></tr></table></figure><p>项目根目录下添加templates文件夹，在设置文件中修改：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-string">&#x27;DIRS&#x27;</span>: [<span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.join(BASE_DIR, <span class="hljs-string">&#x27;templates&#x27;</span>)],<br></code></pre></td></tr></table></figure><p>说明：<code>os.path.join(BASE_DIR, &#39;templates&#39;)</code>表示项目根目录下的tempates文件夹。</p><p>添加stus.html文件</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">for</span></span> stu <span class="hljs-keyword">in</span> students %&#125;</span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>姓名：</span><span class="hljs-template-variable">&#123;&#123; stu.s_name &#125;&#125;</span><span class="xml">，年龄：</span><span class="hljs-template-variable">&#123;&#123; stu.s_age &#125;&#125;</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Django</category>
      
    </categories>
    
    
    <tags>
      
      <tag>django</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis使用指南</title>
    <link href="/Myblog/2018/10/18/Redis%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"/>
    <url>/Myblog/2018/10/18/Redis%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<p>网络优化的两大定律：</p><p>1、缓存 - 用空间换取时间 - Redis / Memcached</p><p>2、削峰 - 能推迟的事情都不要马上处理 - RabbitMQ / RocketMQ</p><hr><p><strong>Redis一般用于做高速缓存</strong></p><p>Redis放的应该是体量不大的热点数据</p><p>热(点)数据 - 经常被访问的数据</p><p>冷数据 - 不经常被访问的数据</p><h3 id="安装Redis-Remote-Dictionary-Server"><a href="#安装Redis-Remote-Dictionary-Server" class="headerlink" title="安装Redis(Remote Dictionary Server)"></a>安装Redis(Remote Dictionary Server)</h3><p>源码构建安装</p><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">拷贝redis.conf文件到用户主目录</span><br><span class="hljs-attr">vim</span> <span class="hljs-string">redis.conf</span><br><span class="hljs-attr">bind</span> <span class="hljs-string">修改成自己的内网地址</span><br><span class="hljs-meta">端口默认</span> <span class="hljs-string">6379</span><br><span class="hljs-attr">requirepass</span> <span class="hljs-string">demo 取消注释，设置口令</span><br><span class="hljs-comment"># Redis可以实现数据的持久化存储，即将数据保存到磁盘上。 </span><br><span class="hljs-comment"># Redis的持久化存储提供两种方式：RDB与AOF</span><br><span class="hljs-attr">appendonly</span> <span class="hljs-string">yes 打开AOF模式</span><br></code></pre></td></tr></table></figure><h3 id="启动Redis服务"><a href="#启动Redis服务" class="headerlink" title="启动Redis服务"></a>启动Redis服务</h3><p><code>redis-server redis.conf &gt; redis.log &amp;</code>  </p><p>说明：输入重定向到redis.log中 ， &amp; 后台运行</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@aliyun ~]# redis-cli -h 主机(内网ip) -a 口令<br>172.18.6.69:6379&gt; auth demo    <br><span class="hljs-comment"># 验证口令</span><br>OK<br>172.18.6.69:6379&gt; ping<br><span class="hljs-comment"># 检验连接是否成功</span><br>PONG<br></code></pre></td></tr></table></figure><p>现在只能连接自己服务器的redis，因为连接的是内网。</p><p>如果希望连接别人的redis，或者自己开放redis，需要防火墙添加端口,重启防火墙并且连接公网ip。</p><p><strong>停止redis可以杀掉进程，或者查找jobs后台运行程序终止</strong></p><p><code>redis-benchmark -h 172.18.6.69</code> 基准测试，可以查看服务器性能</p><h3 id="Redis数据类型"><a href="#Redis数据类型" class="headerlink" title="Redis数据类型"></a>Redis数据类型</h3><p><strong>五大数据类型：</strong></p><p><strong>1、字符串类型（String）</strong></p><p><strong>2、哈希表（Hash）：用来保存对象</strong></p><p><strong>3、列表（List）- 栈，队列</strong></p><p><strong>4、集合（Set）：可以去重</strong></p><p><strong>5、有序集合（SortedSet）：适合做排行榜</strong></p><h3 id="Python连接redis"><a href="#Python连接redis" class="headerlink" title="Python连接redis"></a>Python连接redis</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import redis<br><br>def main():<br>   <span class="hljs-built_in"> client </span>= redis.StrictRedis(<span class="hljs-attribute">host</span>=<span class="hljs-string">&#x27;120.78.83.46&#x27;</span>, <span class="hljs-attribute">port</span>=6379, <span class="hljs-attribute">password</span>=<span class="hljs-string">&#x27;demo&#x27;</span>)<br>    client.<span class="hljs-builtin-name">set</span>(<span class="hljs-string">&#x27;time&#x27;</span>, <span class="hljs-string">&#x27;time&#x27;</span>)<br>    client.expire(<span class="hljs-string">&#x27;time&#x27;</span>, 150)<br>    # client.<span class="hljs-builtin-name">set</span>(<span class="hljs-string">&#x27;lvhaojie&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(20):<br>        client.incr(<span class="hljs-string">&#x27;lvhaojie&#x27;</span>)<br>    <span class="hljs-builtin-name">print</span>(client.<span class="hljs-builtin-name">get</span>(<span class="hljs-string">&#x27;lvhaojie&#x27;</span>))<br>    <span class="hljs-builtin-name">print</span>(client.ttl(<span class="hljs-string">&#x27;time&#x27;</span>))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="Pipeline-and-Transation"><a href="#Pipeline-and-Transation" class="headerlink" title="Pipeline and Transation"></a>Pipeline and Transation</h3><h4 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h4><p>Redis是建立在TCP协议基础上的CS架构，客户端client对redis server采取请求响应的方式交互。</p><p>设想这样的一个场景，你要批量的执行一系列redis命令，例如执行100次get key，这时你要向redis请求100次+获取响应100次。如果能一次性将100个请求提交给redis server，执行完成之后批量的获取相应，只需要向redis请求1次，然后批量执行完命令，一次性结果，性能是不是会好很多呢？</p><p>答案是肯定的，节约的时间是客户端client和服务器redis server之间往返网络延迟的时间。某些客户端（java和python）提供了一种叫做pipeline的编程模式用来解决批量提交请求的方式。</p><p><strong>pipeline使用场景：网络延迟高时，批量执行，性能提升明显。</strong> </p><p>当网络延迟低（本机）：使用pipeline批量执行，性能提升不明显。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> redis<br><span class="hljs-keyword">import</span> time<br><br>r = redis.Redis(host=<span class="hljs-string">&#x27;10.93.84.53&#x27;</span>, port=<span class="hljs-number">6379</span>, password=<span class="hljs-string">&#x27;bigdata123&#x27;</span>)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">try_pipeline</span>():</span><br>    start = time.time()<br>    <span class="hljs-keyword">with</span> r.pipeline(transaction=<span class="hljs-literal">False</span>) <span class="hljs-keyword">as</span> p:<br>        p.sadd(<span class="hljs-string">&#x27;seta&#x27;</span>, <span class="hljs-number">1</span>).sadd(<span class="hljs-string">&#x27;seta&#x27;</span>, <span class="hljs-number">2</span>).srem(<span class="hljs-string">&#x27;seta&#x27;</span>, <span class="hljs-number">2</span>).lpush(<span class="hljs-string">&#x27;lista&#x27;</span>, <span class="hljs-number">1</span>).lrange(<span class="hljs-string">&#x27;lista&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>)<br>        p.execute()   <span class="hljs-comment"># execute返回命令执行结果列表</span><br>    <span class="hljs-keyword">print</span> time.time() - start<br></code></pre></td></tr></table></figure><blockquote><p>说明：1、使用pipeline时命令可以连着写，也可以分开写。2、pipeline实现基于redis协议<strong>RESP(redis序列化协议)</strong></p></blockquote><h4 id="Transation"><a href="#Transation" class="headerlink" title="Transation"></a>Transation</h4><p>pipeline不仅仅用来批量的提交命令，还用来实现事务transation。</p><p>细心的你可能发现了，使用transaction与否不同之处在与创建pipeline实例的时候，transaction是否打开，默认是打开的。</p><p>Demo - 模拟秒杀商品</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> redis<br><span class="hljs-keyword">from</span> redis <span class="hljs-keyword">import</span> WatchError<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ProcessPoolExecutor<br><br>r = redis.Redis(host=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, port=<span class="hljs-number">6379</span>)<br><br><br><span class="hljs-comment"># 减库存函数, 循环直到减库存完成，如果库存充足, 减库存成功, 返回True；库存不足, 减库存失败, 返回False</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decr_stock</span>():</span><br>    <span class="hljs-comment"># python中redis事务是通过pipeline的封装实现的</span><br>    <span class="hljs-keyword">with</span> r.pipeline() <span class="hljs-keyword">as</span> pipe:<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-comment"># watch方法监视对应键, multi后如果该key被其他客户端改变, 事务操作会抛出WatchError异常</span><br>                pipe.watch(<span class="hljs-string">&#x27;stock:count&#x27;</span>)<br>                count = int(pipe.get(<span class="hljs-string">&#x27;stock:count&#x27;</span>))<br>                <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span>:  <span class="hljs-comment"># 有库存</span><br>                    pipe.multi()   <span class="hljs-comment"># 事务开始</span><br>                    pipe.decr(<span class="hljs-string">&#x27;stock:count&#x27;</span>)<br>                    <span class="hljs-comment"># execute将指令推送，返回命令执行结果列表</span><br>                    <span class="hljs-keyword">print</span> pipe.execute()[<span class="hljs-number">0</span>]<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">except</span> WatchError, ex:<br>                <span class="hljs-comment"># 打印WatchError异常, 观察被watch锁住的情况</span><br>                <span class="hljs-keyword">print</span> ex<br>                pipe.unwatch()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span>():</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment"># 没有库存就退出</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> decr_stock():<br>            <span class="hljs-keyword">break</span><br><br><span class="hljs-comment"># 实验开始，设置库存为100</span><br>r.set(<span class="hljs-string">&quot;stock:count&quot;</span>, <span class="hljs-number">100</span>)<br><br><span class="hljs-comment"># 多进程模拟多个客户端提交</span><br><span class="hljs-keyword">with</span> ProcessPoolExecutor(max_workers=<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> pool:<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<br>        pool.submit(worker)<br></code></pre></td></tr></table></figure><blockquote><p>说明：1、当遇到执行错误时，redis放过这种错误，保证事务执行完成。这里要注意此问题，与mysql中事务不同，<strong>redis事务遇到执行错误的时候，不会进行回滚，而是简单的放过了，并保证其他的命令正常执行。</strong>；2、使用discard方法：放弃事务并清空事务队列。</p></blockquote><h3 id="主从复制（读写分离）"><a href="#主从复制（读写分离）" class="headerlink" title="主从复制（读写分离）"></a>主从复制（读写分离）</h3><p>master可读可写，slave只读。</p><ul><li><p>master不用修改任何配置</p></li><li><p>slave修改两条配置:</p></li></ul><p><code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></p><p><code>slaveauth &lt;master口令&gt;</code></p><p>重启服务</p><p><code>redis-server redis.conf</code></p><h3 id="启动哨兵"><a href="#启动哨兵" class="headerlink" title="启动哨兵"></a>启动哨兵</h3><p>redis安装目录下拷贝sentinel.conf文件，再进行修改</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs smali">bind &lt;内网地址&gt;<br>sentinel<span class="hljs-built_in"> monitor </span>mymaster &lt;masterIP&gt; &lt;master端口&gt; &lt;投票数量&gt;<br><span class="hljs-keyword">.</span>..&lt;修改认定下线时间&gt;<br><span class="hljs-keyword">.</span>..&lt;恢复超时时间&gt;<br></code></pre></td></tr></table></figure><p>启动哨兵：</p><p><code>redis-server sentinel.conf --sentinel</code></p><p>一些内置hash算法库</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-built_in">import</span> hashlib<br><span class="hljs-comment"># 哈希函数(散列函数) - MD5 / SHA1 / SHA256</span><br><span class="hljs-comment"># 哈希摘要 / 数字签名</span><br><span class="hljs-attr">key</span> = hashlib.md5(&lt;二进制数据&gt;).hexdigest()<br><span class="hljs-comment"># 根据数据内容生成唯一一个key，用来作为存入数据库的key值。</span><br><br><span class="hljs-built_in">import</span> base64 <span class="hljs-comment"># 将二进制转换成字符串</span><br><span class="hljs-comment"># BASE64编码: 0-9 a-z A-Z + /</span><br><br><span class="hljs-built_in">import</span> zlib <span class="hljs-comment"># 压缩</span><br></code></pre></td></tr></table></figure><h3 id="Python连接redis（哨兵模式）"><a href="#Python连接redis（哨兵模式）" class="headerlink" title="Python连接redis（哨兵模式）"></a>Python连接redis（哨兵模式）</h3><p>我们可以事先封装好连接redis哨兵模式的工具类，方便使用。具体方式如下</p><p>redis_sentinel_url.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> namedtuple<br><span class="hljs-keyword">import</span> urllib.parse <span class="hljs-keyword">as</span> urlparse<br><span class="hljs-keyword">import</span> redis.sentinel<br><br>_string_types = str<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">iteritems</span>(<span class="hljs-params">d</span>):</span><br>    <span class="hljs-keyword">return</span> d.items()<br><br><br>SentinelUrlParseResult = namedtuple(<br>    <span class="hljs-string">&#x27;SentinelUrlParseResult&#x27;</span>,<br>    [<span class="hljs-string">&#x27;hosts&#x27;</span>, <span class="hljs-string">&#x27;sentinel_options&#x27;</span>, <span class="hljs-string">&#x27;client_options&#x27;</span>, <span class="hljs-string">&#x27;default_client&#x27;</span>])<br><br>DefaultClient = namedtuple(<span class="hljs-string">&#x27;DefaultClient&#x27;</span>, [<span class="hljs-string">&#x27;type&#x27;</span>, <span class="hljs-string">&#x27;service&#x27;</span>])<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_sentinel_url</span>(<span class="hljs-params">url, sentinel_options=None, client_options=None</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Parse a URL listing sentinel options.</span><br><span class="hljs-string">    :param url: redis+sentinel://host:port[,host2:port2,...][/service_name[/db]][?socket_timeout=0.1]</span><br><span class="hljs-string">    :param sentinel_options: default sentinel options as dict, the ones in url always win</span><br><span class="hljs-string">    :param client_options: default client options as dict, the ones in url always win</span><br><span class="hljs-string">    :return: SentinelUrlParseResult</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">if</span> isinstance(url, _string_types):<br>        url = urlparse.urlparse(url)<br><br>    <span class="hljs-keyword">if</span> url.scheme != <span class="hljs-string">&#x27;redis+sentinel&#x27;</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;Unsupported scheme: &#123;&#125;&#x27;</span>.format(url.scheme))<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_host</span>(<span class="hljs-params">s</span>):</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-keyword">in</span> s:<br>            host, port = s.split(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-number">1</span>)<br>            port = int(port)<br>        <span class="hljs-keyword">else</span>:<br>            host = s<br>            port = <span class="hljs-number">26379</span><br><br>        <span class="hljs-keyword">return</span> host, port<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;@&#x27;</span> <span class="hljs-keyword">in</span> url.netloc:<br>        auth, hostspec = url.netloc.split(<span class="hljs-string">&#x27;@&#x27;</span>, <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">else</span>:<br>        auth = <span class="hljs-literal">None</span><br>        hostspec = url.netloc<br><br>    <span class="hljs-keyword">if</span> auth <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-keyword">in</span> auth:<br>        _, password = auth.split(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">else</span>:<br>        password = <span class="hljs-literal">None</span><br><br>    hosts = [parse_host(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> hostspec.split(<span class="hljs-string">&#x27;,&#x27;</span>)]<br><br>    global_option_types = &#123;<br>        <span class="hljs-string">&#x27;min_other_sentinels&#x27;</span>: int,<br>        <span class="hljs-string">&#x27;db&#x27;</span>: int,<br>        <span class="hljs-string">&#x27;service&#x27;</span>: str,<br>        <span class="hljs-string">&#x27;client_type&#x27;</span>: str,<br>    &#125;<br><br>    option_types = &#123;<br>        <span class="hljs-string">&#x27;socket_timeout&#x27;</span>: float,<br>        <span class="hljs-string">&#x27;socket_connect_timeout&#x27;</span>: float,<br>    &#125;<br><br>    sentinel_url_options = &#123;&#125;<br>    <span class="hljs-keyword">if</span> sentinel_options:<br>        sentinel_url_options.update(sentinel_options)<br>    url_options = &#123;&#125;<br>    <span class="hljs-keyword">if</span> client_options:<br>        url_options.update(client_options)<br><br>    <span class="hljs-keyword">if</span> password <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        url_options[<span class="hljs-string">&#x27;password&#x27;</span>] = password<br><br>    <span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">in</span> iteritems(urlparse.parse_qs(url.query)):<br>        <span class="hljs-keyword">if</span> name <span class="hljs-keyword">in</span> global_option_types:<br>            option_name = name<br>            option_store = url_options<br>            option_type = global_option_types[option_name]<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> name.startswith(<span class="hljs-string">&#x27;sentinel_&#x27;</span>):<br>                option_name = name[<span class="hljs-number">9</span>:]<br>                option_store = sentinel_url_options<br>            <span class="hljs-keyword">else</span>:<br>                option_name = name<br>                option_store = url_options<br><br>            <span class="hljs-keyword">if</span> option_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> option_types:<br>                <span class="hljs-keyword">continue</span><br><br>            option_type = option_types[option_name]<br><br>        <span class="hljs-keyword">if</span> len(value) &gt; <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;Multiple values specified for &#123;&#125;&#x27;</span>.format(name))<br><br>        option_store[option_name] = option_type(value[<span class="hljs-number">0</span>])<br><br>    path = url.path<br>    <span class="hljs-keyword">if</span> path.startswith(<span class="hljs-string">&#x27;/&#x27;</span>):<br>        path = path[<span class="hljs-number">1</span>:]<br>    <span class="hljs-keyword">if</span> path == <span class="hljs-string">&#x27;&#x27;</span>:<br>        path_parts = []<br>    <span class="hljs-keyword">else</span>:<br>        path_parts = path.split(<span class="hljs-string">&#x27;/&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;service&#x27;</span> <span class="hljs-keyword">in</span> url_options:<br>        service_name = url_options.pop(<span class="hljs-string">&#x27;service&#x27;</span>)<br>    <span class="hljs-keyword">elif</span> len(path_parts) &gt;= <span class="hljs-number">1</span>:<br>        service_name = path_parts[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">else</span>:<br>        service_name = <span class="hljs-literal">None</span><br><br>    client_type = url_options.pop(<span class="hljs-string">&#x27;client_type&#x27;</span>, <span class="hljs-string">&#x27;master&#x27;</span>)<br>    <span class="hljs-keyword">if</span> client_type <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;master&#x27;</span>, <span class="hljs-string">&#x27;slave&#x27;</span>):<br>        <span class="hljs-keyword">raise</span> ValueError(<br>            <span class="hljs-string">&#x27;Client type must be either master or slave, got &#123;!r&#125;&#x27;</span>)<br><br>    default_client = DefaultClient(client_type, service_name)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;db&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> url_options:<br>        <span class="hljs-keyword">if</span> len(path_parts) &gt;= <span class="hljs-number">2</span>:<br>            url_options[<span class="hljs-string">&#x27;db&#x27;</span>] = int(path_parts[<span class="hljs-number">1</span>])<br>        <span class="hljs-keyword">else</span>:<br>            url_options[<span class="hljs-string">&#x27;db&#x27;</span>] = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">return</span> SentinelUrlParseResult(hosts, sentinel_url_options, url_options,<br>                                  default_client)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">connect</span>(<span class="hljs-params">url,</span></span><br><span class="hljs-function"><span class="hljs-params">            sentinel_class=redis.sentinel.Sentinel,</span></span><br><span class="hljs-function"><span class="hljs-params">            sentinel_options=None,</span></span><br><span class="hljs-function"><span class="hljs-params">            client_class=redis.Redis,</span></span><br><span class="hljs-function"><span class="hljs-params">            client_options=None</span>):</span><br>    parsed_url = urlparse.urlparse(url)<br>    <span class="hljs-keyword">if</span> parsed_url.scheme <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;redis&#x27;</span>, <span class="hljs-string">&#x27;rediss&#x27;</span>, <span class="hljs-string">&#x27;unix&#x27;</span>, <span class="hljs-string">&#x27;redis+sentinel&#x27;</span>]:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;Unsupported redis URL scheme: &#123;&#125;&#x27;</span>.format(<br>            parsed_url.scheme))<br>    <span class="hljs-keyword">if</span> sentinel_options <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        sentinel_options = &#123;&#125;<br>    <span class="hljs-keyword">if</span> client_options <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        client_options = &#123;&#125;<br>    <span class="hljs-keyword">if</span> parsed_url.scheme != <span class="hljs-string">&#x27;redis+sentinel&#x27;</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, client_class.from_url(url, **client_options)<br>    sentinel_url = parse_sentinel_url(<br>        url, sentinel_options=sentinel_options, client_options=client_options)<br>    sentinel_kwargs = &#123;&#125;<br>    <span class="hljs-keyword">if</span> sentinel_url.client_options.get(<span class="hljs-string">&#x27;password&#x27;</span>):<br>        sentinel_kwargs[<span class="hljs-string">&#x27;password&#x27;</span>] = sentinel_url.client_options.get(<span class="hljs-string">&#x27;password&#x27;</span>)<br>    sentinel = sentinel_class(<br>        sentinel_url.hosts,<br>        sentinel_kwargs=sentinel_kwargs <span class="hljs-keyword">or</span> <span class="hljs-literal">None</span>,<br>        socket_timeout=<span class="hljs-number">0.5</span>,<br>        **sentinel_url.client_options)<br>    client = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">if</span> sentinel_url.default_client:<br>        <span class="hljs-keyword">if</span> sentinel_url.default_client.type == <span class="hljs-string">&#x27;master&#x27;</span>:<br>            client = sentinel.master_for(<br>                sentinel_url.default_client.service, redis_class=client_class, **sentinel_url.client_options)<br>        <span class="hljs-keyword">else</span>:<br>            client = sentinel.slave_for(<br>                sentinel_url.default_client.service, redis_class=client_class, **sentinel_url.client_options)<br><br>    <span class="hljs-keyword">return</span> sentinel, client<br></code></pre></td></tr></table></figure><blockquote><p>超时时间：socket_timeout=0.5</p></blockquote><p>redis_connection.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> .redis_sentinel_url <span class="hljs-keyword">import</span> connect<br><span class="hljs-keyword">from</span> .config <span class="hljs-keyword">import</span> Config<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">redis_conn</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;redis连接&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> connect(Config.REDIS_URL)<br></code></pre></td></tr></table></figure><p>config.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">from</span> starlette.config <span class="hljs-keyword">import</span> Config <span class="hljs-keyword">as</span> EnvConfig<br><br>config = EnvConfig(<span class="hljs-string">&quot;/etc/config/.env&quot;</span>)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>:</span><br>    REDIS_URL = config(<br>      <span class="hljs-string">&quot;REDIS_URL&quot;</span>,<br>      default=<span class="hljs-string">&quot;redis+sentinel://:password@host:26379/mymaster/4&quot;</span>,<br>    )<br></code></pre></td></tr></table></figure><blockquote><p>如果没有密码换成这样写就可以<code>redis+sentinel://host:26379/mymaster/4</code></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">redis = redis_conn()[<span class="hljs-number">-1</span>]<br>redis.set(<span class="hljs-string">&quot;redis-key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>)<br></code></pre></td></tr></table></figure><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li>原生redis使用 - 查看<a href="http://www.redisdoc.com/">Redis中文文档 </a>或者 <a href="http://www.runoob.com/redis/redis-keys.html">菜鸟教程</a> 里面有详细的使用说明</li><li><a href="https://mp.weixin.qq.com/s/lkQsOsqY3m4V_SCGksI_BQ">redis开发规范</a> / <a href="https://redis.io/topics/protocol">redis协议规范</a></li><li><a href="https://www.cnblogs.com/wang-yc/p/5693288.html">python3中对redis指令封装</a></li><li><a href="https://www.cnblogs.com/kangoroo/p/7647052.html">Redis Pipeline and Transation</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pymysql</title>
    <link href="/Myblog/2018/10/17/PyMysql/"/>
    <url>/Myblog/2018/10/17/PyMysql/</url>
    
    <content type="html"><![CDATA[<h4 id="一、pip安装模块"><a href="#一、pip安装模块" class="headerlink" title="一、pip安装模块"></a>一、pip安装模块</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vim">pip install -i http<span class="hljs-variable">s:</span>//pypi.doubanio.<span class="hljs-keyword">com</span>/simple pymysql<br><br># 如果希望pip安装时自动从国内特定网址下载，可以设置全局设置，在用户主目录下新建pip文件夹，再新建pip.ini文件，写入<span class="hljs-built_in">index</span>-url=http<span class="hljs-variable">s:</span>//pypi.doubanio.<span class="hljs-keyword">com</span>/simple即可<br><br>以后则可以直接pip install pymysql 会自动从指定网址下载。<br></code></pre></td></tr></table></figure><h4 id="二、操作数据库流程"><a href="#二、操作数据库流程" class="headerlink" title="二、操作数据库流程"></a>二、操作数据库流程</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import pymysql<br><br>def main():<br><span class="hljs-literal">no</span> = int(input(<span class="hljs-string">&#x27;部门编号：&#x27;</span>))<br>name = input(<span class="hljs-string">&#x27;部门名称：&#x27;</span>)<br>location = input(<span class="hljs-string">&#x27;部门所在地：&#x27;</span>)<br><br>    # 1、创建数据库连接<br>    conn = pymysql.connect(<span class="hljs-attribute">host</span>=<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-attribute">port</span>=3306, <span class="hljs-attribute">db</span>=<span class="hljs-string">&#x27;hrs&#x27;</span>, <span class="hljs-attribute">user</span>=<span class="hljs-string">&#x27;root&#x27;</span>, <span class="hljs-attribute">password</span>=<span class="hljs-string">&#x27;123456&#x27;</span>, <span class="hljs-attribute">charset</span>=<span class="hljs-string">&#x27;utf8&#x27;</span>)<br>    # 可以添加<span class="hljs-attribute">autocommit</span>=<span class="hljs-literal">True</span>:执行sql语句会自动提交<br>    # 可以添加<span class="hljs-attribute">cursorclass</span>=pymysql.cursors.DictCursor:把cursor返回结果变成一个字典<br>    try:<br>        # 2、创建游标对象<br>        with conn.cursor() as cursor:<br>            # 3、向数据库服务器发出sql语句<br>            result = cursor.execute(<span class="hljs-attribute">query</span>=<span class="hljs-string">&#x27;insert into tbdept values (%s,%s,%s)&#x27;</span>, args=(<span class="hljs-literal">no</span>, name, location))<br>            # result = cursor.execute(<span class="hljs-string">&#x27;insert into tbdept values (%(no)s,%(name)s,%(location)s)&#x27;</span>, &#123;<span class="hljs-string">&#x27;no&#x27;</span>:no, <span class="hljs-string">&#x27;name&#x27;</span>:name, <span class="hljs-string">&#x27;location&#x27;</span>:location&#125;) # 另一种写法<br>            <br>            <span class="hljs-keyword">if</span> result == 1:<br>                <span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;删除成功！&#x27;</span>)<br>            conn.commit() # 4、提交操作（默认开启了事务）<br>    finally:<br>        # 确保数据库关闭<br>        conn.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>删除和修改操作类似。</p><h4 id="三、数据库查询操作"><a href="#三、数据库查询操作" class="headerlink" title="三、数据库查询操作"></a>三、数据库查询操作</h4><p>Python查询Mysql使用 fetchone() 方法获取单条数据, 使用fetchall() 方法获取多条数据。</p><ul><li><strong>fetchone():</strong> 该方法获取下一个查询结果集。结果集是一个对象</li><li>**fetchmany(n):**接收指定的n条返回结果行</li><li>**fetchall(): **接收全部的返回结果行</li><li><strong>rowcount:</strong> 这是一个只读属性，并返回执行execute()方法后影响的行数。</li></ul><p><strong>查询操作：</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;__author__ = 星辰&quot;</span><span class="hljs-string">&quot;&quot;</span><br>import pymysql<br>class Dept():<br>    def __init__(self, <span class="hljs-literal">no</span>, name, location):<br>        self.<span class="hljs-literal">no</span> = <span class="hljs-literal">no</span><br>        self.name = name<br>        self.location = location<br><br>def main():<br>    conn = pymysql.connect(<span class="hljs-attribute">host</span>=<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-attribute">port</span>=3306, <span class="hljs-attribute">db</span>=<span class="hljs-string">&#x27;hrs&#x27;</span>, <span class="hljs-attribute">user</span>=<span class="hljs-string">&#x27;root&#x27;</span>,<br>                           <span class="hljs-attribute">password</span>=<span class="hljs-string">&#x27;123456&#x27;</span>, <span class="hljs-attribute">charset</span>=<span class="hljs-string">&#x27;utf8&#x27;</span>,autocommit=True,<br>                           <span class="hljs-attribute">cursorclass</span>=pymysql.cursors.DictCursor)<br>    try:<br>        with conn.cursor() as cursor:<br>            cursor.execute(<span class="hljs-string">&#x27;select dno as no, dname as name, dloc as location from tbdept&#x27;</span>)<br>            <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor.fetchall():<br>                # <span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;部门：%s&#x27;</span>%row[<span class="hljs-string">&#x27;no&#x27;</span>])<br>                # <span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;名称：%s&#x27;</span> % row[<span class="hljs-string">&#x27;name&#x27;</span>])<br>                # <span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;所在地：%s&#x27;</span> % row[<span class="hljs-string">&#x27;location&#x27;</span>])<br>                # <span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * 30)<br><br>                dept = Dept(**row)  # **row 拆分字典<br>                <span class="hljs-builtin-name">print</span>(dept.<span class="hljs-literal">no</span>, <span class="hljs-attribute">end</span>=<span class="hljs-string">&#x27;\t&#x27;</span>)<br>                <span class="hljs-builtin-name">print</span>(dept.name, <span class="hljs-attribute">end</span>=<span class="hljs-string">&#x27;\t&#x27;</span>)<br>                <span class="hljs-builtin-name">print</span>(dept.location)<br><br>    finally:<br>        conn.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pymysql</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pgsql常用方法指南</title>
    <link href="/Myblog/2018/10/15/pgsql%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95%E6%8C%87%E5%8D%97/"/>
    <url>/Myblog/2018/10/15/pgsql%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<p>自从MySQL被Oracle收购以后，<a href="https://www.postgresql.org/">PostgreSQL</a>逐渐成为开源关系型数据库的首选。数据库设计参考文章<a href="https://developer.aliyun.com/article/709387">阿里云数据库设计规范</a>，本文用于记录工作学习中遇到的相关业务及处理方法。</p><h3 id="命令行工具"><a href="#命令行工具" class="headerlink" title="命令行工具"></a>命令行工具</h3><p>使用命令行连接<code>pgsql</code>数据库，可以使用工具<code>pgcli</code> 或者 <code>pgsql</code>，前者提示更好，使用方式也类似。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">brew <span class="hljs-keyword">install</span> pgcli<br>brew <span class="hljs-keyword">install</span> postgresql@<span class="hljs-number">12</span>   <span class="hljs-comment">-- 指定pg版本</span><br></code></pre></td></tr></table></figure><ul><li>连接pgsql</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">pgsql -U &lt;username&gt; -d &lt;dbname&gt; -h &lt;hostname&gt; -p &lt;port&gt;<br><span class="hljs-comment">-- pgcli -U &lt;username&gt; -d &lt;dbname&gt; -h &lt;hostname&gt; -p &lt;port&gt;</span><br></code></pre></td></tr></table></figure><ul><li>执行sql</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">pgsql -U &lt;username&gt; -d &lt;dbname&gt; -h &lt;hostname&gt; -p &lt;port&gt; -f &lt;f.sql&gt;<br></code></pre></td></tr></table></figure><ul><li>导出sql</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">pg_dump -U &lt;username&gt; -d &lt;dbname&gt; -h &lt;hostname&gt; -p &lt;port&gt; -f &lt;f.sql&gt;<br></code></pre></td></tr></table></figure><blockquote><p>添加<code>-t</code>参数可以导出指定表</p></blockquote><p>连接成功之后，控制台命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">\?：查看psql命令列表<br>\h：查看SQL命令的解释，比如\h select<br>\l：列出所有数据库<br>\c [database_name]：连接其他数据库<br>\d：列出当前数据库的所有表格<br>\d [table_name]：列出某一张表格的结构<br>\du：列出所有用户<br>\e：打开文本编辑器<br>\conninfo：列出当前数据库和连接的信息<br></code></pre></td></tr></table></figure><h3 id="创建用户及授权"><a href="#创建用户及授权" class="headerlink" title="创建用户及授权"></a>创建用户及授权</h3><ul><li>创建用户</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span> <span class="hljs-string">&#x27;test&#x27;</span> <span class="hljs-keyword">with</span> <span class="hljs-keyword">password</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure><ul><li>增加组用户及其权限</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">grant</span> &lt;<span class="hljs-keyword">role</span>&gt; <span class="hljs-keyword">to</span> &lt;group_name&gt;;<br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">test</span> <span class="hljs-keyword">to</span> postgres;      <span class="hljs-comment">-- 添加成员test到postgress组</span><br></code></pre></td></tr></table></figure><ul><li>为组中用户撤销成员关系</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">revoke</span> &lt;<span class="hljs-keyword">role</span>&gt; <span class="hljs-keyword">from</span> &lt;group_name&gt;;<br><span class="hljs-keyword">revoke</span> <span class="hljs-keyword">test</span> <span class="hljs-keyword">from</span> postgres;     <span class="hljs-comment">-- 撤销postgres组成员test</span><br></code></pre></td></tr></table></figure><ul><li>授权</li></ul><p>授予用户db所有权限</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">grant</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">privileges</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">database</span> testdb <span class="hljs-keyword">to</span> <span class="hljs-keyword">test</span>; <br></code></pre></td></tr></table></figure><p>授予用户public schema下所有表的读写权限</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">grant</span> <span class="hljs-keyword">usage</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">schema</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">test</span>;  // 授予查询权限<br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">privileges</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">tables</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">schema</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">test</span>;<br></code></pre></td></tr></table></figure><p>设置用户权限为只读</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">user</span> readonly <span class="hljs-keyword">set</span> default_transaction_read_only=<span class="hljs-keyword">on</span>;<br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">tables</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">schema</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">to</span> readonly;<br></code></pre></td></tr></table></figure><ul><li>创建db</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> testdb;<br><span class="hljs-comment">-- create database testdb owner test;</span><br></code></pre></td></tr></table></figure><ul><li>修改db所属用户</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> testdb owner <span class="hljs-keyword">to</span> <span class="hljs-keyword">test</span>;<br></code></pre></td></tr></table></figure><h3 id="数据字典导出"><a href="#数据字典导出" class="headerlink" title="数据字典导出"></a>数据字典导出</h3><ul><li>pgsql版本</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>(<span class="hljs-keyword">select</span> relname <span class="hljs-keyword">as</span> <span class="hljs-keyword">comment</span> <span class="hljs-keyword">from</span> pg_class <span class="hljs-keyword">where</span> <span class="hljs-keyword">oid</span>=a.attrelid) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;表名&quot;</span>,<br>a.attname <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;字段&quot;</span>,<br>format_type(a.atttypid,a.atttypmod) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;类型&quot;</span>,<br>(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> pg_constraint <span class="hljs-keyword">where</span> conrelid = a.attrelid <span class="hljs-keyword">and</span> conkey[<span class="hljs-number">1</span>]=attnum <span class="hljs-keyword">and</span> contype=<span class="hljs-string">&#x27;p&#x27;</span>)&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;是&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;否&#x27;</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;主键约束&quot;</span>,<br>(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> pg_constraint <span class="hljs-keyword">where</span> conrelid = a.attrelid <span class="hljs-keyword">and</span> conkey[<span class="hljs-number">1</span>]=attnum <span class="hljs-keyword">and</span> contype=<span class="hljs-string">&#x27;u&#x27;</span>)&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;是&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;否&#x27;</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;唯一约束&quot;</span>,<br>(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> pg_constraint <span class="hljs-keyword">where</span> conrelid = a.attrelid <span class="hljs-keyword">and</span> conkey[<span class="hljs-number">1</span>]=attnum <span class="hljs-keyword">and</span> contype=<span class="hljs-string">&#x27;f&#x27;</span>)&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;是&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;否&#x27;</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;外键约束&quot;</span>,<br>(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> a.attnotnull=<span class="hljs-literal">true</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;是&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;否&#x27;</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;是否为空&quot;</span>,<br>col_description(a.attrelid,a.attnum) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;备注&quot;</span><br><span class="hljs-keyword">from</span> pg_attribute a<br><span class="hljs-keyword">where</span> attstattarget=<span class="hljs-number">-1</span> <span class="hljs-keyword">and</span> attrelid <span class="hljs-keyword">in</span> <br>     (<span class="hljs-keyword">select</span> <span class="hljs-keyword">oid</span> <span class="hljs-keyword">from</span> pg_class <span class="hljs-keyword">where</span> relname <span class="hljs-keyword">in</span><br>               (<span class="hljs-keyword">select</span> relname <span class="hljs-keyword">from</span> pg_class <span class="hljs-keyword">where</span> relkind =<span class="hljs-string">&#x27;r&#x27;</span> <span class="hljs-keyword">and</span> relname = <span class="hljs-string">&#x27;user&#x27;</span>))<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-string">&quot;表名&quot;</span>, a.attnum;<br></code></pre></td></tr></table></figure><blockquote><p>导出所有表则修改为<code>relname like &#39;%&#39;</code></p></blockquote><h3 id="数据库时区"><a href="#数据库时区" class="headerlink" title="数据库时区"></a>数据库时区</h3><p>修改某个数据库的时区</p><ul><li>全局参数</li></ul><p>修改配置文件<code>postgresql.conf</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">timezone</span>=<span class="hljs-string">&#x27;PRC&#x27;</span><br></code></pre></td></tr></table></figure><ul><li>数据库级别配置</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> hubble <span class="hljs-keyword">set</span> timezone=<span class="hljs-string">&#x27;PRC&#x27;</span>;    <span class="hljs-comment"># +08</span><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> hubble <span class="hljs-keyword">set</span> timezone=<span class="hljs-string">&#x27;UTC&#x27;</span>;    <span class="hljs-comment"># +00</span><br></code></pre></td></tr></table></figure><p>检查数据库配置</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> pg_db_role_setting ;<br><br> setdatabase | setrole |  setconfig               <br><span class="hljs-comment">-------------+---------+----------------</span><br>       14930 |       0 | &#123;TimeZone=UTC&#125;<br></code></pre></td></tr></table></figure><h3 id="修改ID自增"><a href="#修改ID自增" class="headerlink" title="修改ID自增"></a>修改ID自增</h3><p>默认情况下，pgsql中id自增使用的序列(SEQUENCE)都是按照<code>表名_字段名_seq</code>命名。</p><ul><li>查询sequence</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> category_id_seq;<br></code></pre></td></tr></table></figure><ul><li>创建sequence</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">SEQUENCE</span> category_id_seq <span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> <span class="hljs-number">300</span><br><span class="hljs-keyword">INCREMENT</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> <span class="hljs-keyword">NO</span> <span class="hljs-keyword">MINVALUE</span> <span class="hljs-keyword">NO</span> MAXVALUE <span class="hljs-keyword">CACHE</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><blockquote><ul><li><code>category_id_seq</code>为自定义sequence名称，以300为初始值自增，每次自增1，不设置最小值和最大值，<code>cache</code> 为1</li></ul></blockquote><ul><li>修改sequence</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">sequence</span> category_id_seq restart <span class="hljs-keyword">with</span> <span class="hljs-number">400</span>;<br>// or -&gt; select setval(&#x27;category_id_seq&#x27;, 400);<br></code></pre></td></tr></table></figure><ul><li>将sequence作用于字段上</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">category</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">nextval</span>(<span class="hljs-string">&#x27;category_id_seq&#x27;</span>);<br></code></pre></td></tr></table></figure><ul><li>编写脚本批量更新所有表的自增id值</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;select setval(&#x27;&#x27;&#x27;</span> || tablename || <span class="hljs-string">&#x27;_id_seq&#x27;&#x27;,  (select max(id) + 1 from &quot;&#x27;</span> || tablename || <span class="hljs-string">&#x27;&quot;));&#x27;</span><br>  <span class="hljs-keyword">from</span> pg_tables<br> <span class="hljs-keyword">where</span> schemaname = <span class="hljs-string">&#x27;public&#x27;</span>;<br></code></pre></td></tr></table></figure><blockquote><p>生成sql脚本语句，放入数据库执行即可</p></blockquote><h3 id="批量修改某值递增"><a href="#批量修改某值递增" class="headerlink" title="批量修改某值递增"></a>批量修改某值递增</h3><p>修改所有<code>source_id</code>为空的值，按照某值递增</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> <span class="hljs-string">&quot;order&quot;</span> <span class="hljs-keyword">set</span> <span class="hljs-string">&quot;source_id&quot;</span>=<span class="hljs-keyword">nextval</span>(<span class="hljs-string">&#x27;order_source_id_seq&#x27;</span>) <span class="hljs-keyword">where</span> <span class="hljs-string">&quot;source_id&quot;</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure><blockquote><p>创建一个<code>sequence</code>，设置值为自己想要的值即可</p></blockquote><h3 id="修改字段约束及类型"><a href="#修改字段约束及类型" class="headerlink" title="修改字段约束及类型"></a>修改字段约束及类型</h3><ul><li>Add field</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> &lt;<span class="hljs-keyword">table</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">add</span> <span class="hljs-keyword">column</span> &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">name</span>&gt; &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">type</span>&gt; <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure><ul><li>Modify field type</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> &lt;<span class="hljs-keyword">table</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">type</span> &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">type</span>&gt;;<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> &lt;<span class="hljs-keyword">table</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">type</span> &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">type</span>&gt; <span class="hljs-keyword">using</span> &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">name</span>&gt;::&lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">type</span>&gt;;<br><span class="hljs-comment">-- using name::text</span><br></code></pre></td></tr></table></figure><blockquote><ul><li><code>using</code>: 指定如何转换</li></ul></blockquote><ul><li>Delete field </li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> &lt;<span class="hljs-keyword">table</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">drop</span> <span class="hljs-keyword">column</span> &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">name</span>&gt;;<br></code></pre></td></tr></table></figure><ul><li><p>Add unique</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> &lt;<span class="hljs-keyword">table</span> <span class="hljs-keyword">name</span>&gt;  <span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> &lt;<span class="hljs-keyword">constraint</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">unique</span> (&lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">name</span>&gt;);<br></code></pre></td></tr></table></figure></li><li><p>Drop unique</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> &lt;<span class="hljs-keyword">table</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">drop</span> <span class="hljs-keyword">constraint</span> &lt;<span class="hljs-keyword">constraint</span> <span class="hljs-keyword">name</span>&gt;;<br></code></pre></td></tr></table></figure></li><li><p>Add not null</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> &lt;<span class="hljs-keyword">table</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">set</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure><ul><li>Drop not null -&gt; nullable</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> &lt;<span class="hljs-keyword">table</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> &lt;<span class="hljs-keyword">field</span> <span class="hljs-keyword">name</span>&gt; <span class="hljs-keyword">drop</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure><h3 id="on-conflict"><a href="#on-conflict" class="headerlink" title="on-conflict"></a>on-conflict</h3><p>如果id重复，则修改对应信息</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <br>law_category (<br>    <span class="hljs-string">&quot;id&quot;</span>,<br>    <span class="hljs-string">&quot;created_time&quot;</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>,<br>    <span class="hljs-string">&quot;parent&quot;</span>,<br>    <span class="hljs-string">&quot;order&quot;</span>) <br><span class="hljs-keyword">values</span> (<span class="hljs-number">4</span>, <span class="hljs-keyword">now</span>(), <span class="hljs-string">&#x27;test22222&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">22</span>)<br><span class="hljs-keyword">on</span> conflict (<span class="hljs-keyword">id</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">update</span><br><span class="hljs-keyword">set</span> <span class="hljs-string">&quot;order&quot;</span>=EXCLUDED.order+<span class="hljs-number">1</span>, <span class="hljs-string">&quot;name&quot;</span>=excluded.name;<br></code></pre></td></tr></table></figure><blockquote><ul><li><code>on conflict (id)</code>只能作用在唯一(UNIQUE)的字段上</li><li><code>excluded</code>代表插入的数据源</li></ul></blockquote><h3 id="删除所有表"><a href="#删除所有表" class="headerlink" title="删除所有表"></a>删除所有表</h3><p>有些时候我们可能需要清空某个db或者schema下面的所有表，<strong>当然进行这个操作之前一定要考虑清楚是否需要这样做！</strong></p><p>最简单的方式</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">CASCADE</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span>;<br><span class="hljs-comment">-- 如果您使用的是 PostgreSQL 9.3 或更高版本，则可能还需要恢复默认授权。</span><br><span class="hljs-comment">-- GRANT ALL ON SCHEMA public TO postgres;</span><br><span class="hljs-comment">-- GRANT ALL ON SCHEMA public TO public;</span><br></code></pre></td></tr></table></figure><p>编写删除脚本，再去执行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;drop table &quot;&#x27;</span> || tablename || <span class="hljs-string">&#x27;&quot; cascade;&#x27;</span> <span class="hljs-keyword">from</span> pg_tables;<br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;drop table if exists &quot;&#x27;</span> || tablename || <span class="hljs-string">&#x27;&quot; cascade;&#x27;</span> <span class="hljs-keyword">from</span> pg_tables;<br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;drop table if exists &quot;&#x27;</span> || tablename || <span class="hljs-string">&#x27;&quot; cascade;&#x27;</span> <br>  <span class="hljs-keyword">from</span> pg_tables<br> <span class="hljs-keyword">where</span> schemaname = <span class="hljs-string">&#x27;public&#x27;</span>; <br></code></pre></td></tr></table></figure><h3 id="PL-pgsql-的循环语句"><a href="#PL-pgsql-的循环语句" class="headerlink" title="PL/pgsql 的循环语句"></a>PL/pgsql 的循环语句</h3><p>PL/pgSQL是一种块结构的语言。 函数定义的所有文本都必须是一个块（<em>block</em>）。 可以用下面的方法定义一个块：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">[ &lt;&lt;label&gt;&gt; ]<br>[ <span class="hljs-keyword">DECLARE</span><br>    declarations ]<br><span class="hljs-keyword">BEGIN</span><br>    statements<br><span class="hljs-keyword">END</span> [ label ];<br></code></pre></td></tr></table></figure><p>当我们需要重复执行某些<code>sql</code>语句时，就需要用到 PL/pgSQL 循环语句，包括：<code>LOOP</code>，<code>WHILE</code> 和 <code>FOR</code> 循环，语法如下：</p><ul><li>LOOP语句</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">&lt;&lt;label&gt;&gt;<br>LOOP<br>   Statements;<br>   EXIT [&lt;&lt;label&gt;&gt;] WHEN condition;<br><span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<br></code></pre></td></tr></table></figure><ul><li>WHILE循环</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">[ &lt;&lt;label&gt;&gt; ]<br>WHILE condition LOOP<br>   statements;<br><span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<br></code></pre></td></tr></table></figure><ul><li>FOR循环</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">[ &lt;&lt;label&gt;&gt; ]<br>FOR counter IN 1..5 LOOP<br>   RAISE NOTICE &#x27;Counter: %&#x27;, counter;<br><span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<br><span class="hljs-comment">--------------------------------------</span><br>[ &lt;&lt;label&gt;&gt; ]<br>FOR target IN query LOOP<br>    statements<br><span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span> [ label ];<br></code></pre></td></tr></table></figure><blockquote><p><code>FOR counter IN 1..5 LOOP</code> ： 前闭后闭</p><p>如果希望降序，替换成：<code>FOR counter IN REVERSE 5..1 LOOP</code></p></blockquote><p>例子一：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DO</span> $$<br><span class="hljs-keyword">DECLARE</span><br>    test_name <span class="hljs-built_in">text</span>;<br>    target record;<br><span class="hljs-keyword">BEGIN</span> <br>    <span class="hljs-keyword">FOR</span> target <span class="hljs-keyword">IN</span>  <br>    <span class="hljs-keyword">select</span> <span class="hljs-keyword">unnest</span>(<span class="hljs-built_in">array</span>[<span class="hljs-string">&#x27;120000&#x27;</span>,<span class="hljs-string">&#x27;110000&#x27;</span>]) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;c&quot;</span><br>  <span class="hljs-keyword">LOOP</span><br>        test_name := <span class="hljs-string">&#x27;test_&#x27;</span> || target.<span class="hljs-string">&quot;c&quot;</span>;<br>        <span class="hljs-keyword">execute</span> <span class="hljs-string">&#x27;select count(*) from &#x27;</span> || test_name || <span class="hljs-string">&#x27;;&#x27;</span>;<br>    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<br><span class="hljs-keyword">END</span> $$;<br></code></pre></td></tr></table></figure><p>例子二:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> test_function()<br><span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">void</span><br><span class="hljs-keyword">AS</span> $$<br><span class="hljs-keyword">DECLARE</span><br>    mv_name <span class="hljs-built_in">varchar</span>;<br>    country_block_name varchar;<br>        target record;<br><span class="hljs-keyword">BEGIN</span><br><span class="hljs-keyword">FOR</span> target <span class="hljs-keyword">IN</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">unnest</span>(<span class="hljs-built_in">array</span>[<span class="hljs-string">&#x27;ES&#x27;</span>, <span class="hljs-string">&#x27;IT&#x27;</span>, <span class="hljs-string">&#x27;PT&#x27;</span>]) <span class="hljs-keyword">as</span> code<br><span class="hljs-keyword">LOOP</span><br>    mv_name := <span class="hljs-keyword">concat</span>(<span class="hljs-string">&#x27;mv_&#x27;</span>, <span class="hljs-keyword">lower</span>(target.code), <span class="hljs-string">&#x27;_item_info&#x27;</span>);<br>    country_block_name := &#x27;&#123;&quot;ES&quot;: &quot;producto_venta_EspaUa&quot;,<br>                            &quot;IT&quot;: &quot;producto_venta_Italia&quot;,<br>                            &quot;PT&quot;: &quot;producto_venta_Portugal&quot;&#125;&#x27;::json-&gt;upper(target.code);<br>        <span class="hljs-keyword">execute</span> <span class="hljs-string">&#x27;select count(*) from &#x27;</span> || country_block_name || <span class="hljs-string">&#x27;;&#x27;</span>;<br><span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<br><span class="hljs-keyword">END</span> ;<br>$$ LANGUAGE plpgsql;<br></code></pre></td></tr></table></figure><ul><li><a href="http://www.postgres.cn/docs/9.4/plpgsql-structure.html">PL/pgSQL的结构</a></li><li><a href="https://pg.sjk66.com/stored-procedure/loop.html">PL/pgSQL循环语句</a></li></ul><h3 id="trigger触发器"><a href="#trigger触发器" class="headerlink" title="trigger触发器"></a>trigger触发器</h3><p>创建方法<code>upd_timestamp()</code>，并创建<code>trigger</code>应用到表对应列上</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- set updated_at trigger</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> upd_timestamp() <span class="hljs-keyword">returns</span> <span class="hljs-keyword">trigger</span> <span class="hljs-keyword">as</span><br>$$<br><span class="hljs-keyword">begin</span><br>    new.updated_at = <span class="hljs-keyword">now</span>();<br>    return new;<br><span class="hljs-keyword">end</span><br>$$<br><span class="hljs-keyword">language</span> plpgsql;<br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> advertiser_updated_trigger <span class="hljs-keyword">before</span> <span class="hljs-keyword">update</span> <span class="hljs-keyword">on</span> advertiser <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">procedure</span> upd_timestamp();  <br><span class="hljs-comment"># create trigger advertiser_updated_trigger before update on advertiser for each row when (new.name is distinct from old.name) execute procedure upd_timestamp();   # name字段发生变化时触发</span><br></code></pre></td></tr></table></figure><blockquote><p><code>advertiser_updated_trigger</code>: 为<code>trigger</code>名称，<code>advertiser</code>为表名</p><p><code>new, old, tg_op </code>： 都是trigger中内置的属性，分别代表<code>新实例，旧实例，事件类型</code>，<code> tp_op =&gt; &#39;INSERT&#39;/&#39;UPDATE&#39;/&#39;DELETE&#39;</code></p><p><code>before</code>: 指触发器执行时间，还有<code>after</code> ，注意: <code>before</code>：(<code>insert</code>、<code>update</code>)可以对<code>new</code>进行修改，<code>after</code>不能对<code>new</code>进行修改，两者都不能修改<code>old</code>数据。</p><p><code>update</code>: 指触发器的事件，还有<code>insert</code> /  <code>update</code>  / <code>delete</code>，同时使用多个事件，使用<code>or</code>连接</p><p><code>on table</code>: 针对<strong>表</strong>触发，还可以针对<strong>列</strong>触发<code>of field1, field2 on table</code></p><p><code>for each row </code>: 指触发器类型，还有<code>for each statement</code></p><blockquote><ul><li>触发器的 <code>for each row</code> 属性是可选的，如果选中，当操作修改时每行调用一次</li><li>选中<code>for each statement</code>，不管修改了多少行，每个语句标记的触发器执行一次</li></ul></blockquote><p><code>when &lt;condition&gt;</code>: 触发条件</p></blockquote><p>删除创建方法和触发器</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> advertiser_updated_trigger <span class="hljs-keyword">ON</span> advertiser;<br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">FUNCTION</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> upd_timestamp;<br></code></pre></td></tr></table></figure><h3 id="snowflake-分布式唯一ID"><a href="#snowflake-分布式唯一ID" class="headerlink" title="snowflake (分布式唯一ID)"></a>snowflake (分布式唯一ID)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> global_id_sequence;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> id_generator(<span class="hljs-keyword">OUT</span> <span class="hljs-keyword">result</span> <span class="hljs-built_in">bigint</span>) <span class="hljs-keyword">AS</span> $$<br><span class="hljs-keyword">DECLARE</span><br>    our_epoch <span class="hljs-built_in">bigint</span> := <span class="hljs-number">1314220021721</span>;<br>    seq_id bigint;<br>    now_millis bigint;<br>    <span class="hljs-comment">-- the id of this DB shard, must be set for each</span><br>    <span class="hljs-comment">-- schema shard you have - you could pass this as a parameter too</span><br>    shard_id int := 1;<br><span class="hljs-keyword">BEGIN</span><br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">nextval</span>(<span class="hljs-string">&#x27;global_id_sequence&#x27;</span>) % <span class="hljs-number">1024</span> <span class="hljs-keyword">INTO</span> seq_id;<br><br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">FLOOR</span>(<span class="hljs-keyword">EXTRACT</span>(EPOCH <span class="hljs-keyword">FROM</span> clock_timestamp()) * <span class="hljs-number">1000</span>) <span class="hljs-keyword">INTO</span> now_millis;<br>    result := (now_millis - our_epoch) &lt;&lt; 23;<br>    result := result | (shard_id &lt;&lt; 10);<br>    result := result | (seq_id);<br>    <span class="hljs-comment">-- result := result::text;</span><br><span class="hljs-keyword">END</span>;<br>$$ LANGUAGE PLPGSQL;<br></code></pre></td></tr></table></figure><blockquote><p>如果需要返回字符串格式，加上最后一句</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">users</span>(<br>  <span class="hljs-keyword">id</span> <span class="hljs-built_in">bigint</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> id_generator(),<br>  email <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">unique</span>,<br>  <span class="hljs-keyword">first</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),<br>  <span class="hljs-keyword">last</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>)<br>)<br></code></pre></td></tr></table></figure><h3 id="递归树型结构查询层级"><a href="#递归树型结构查询层级" class="headerlink" title="递归树型结构查询层级"></a>递归树型结构查询层级</h3><p>示例：以id为节点关系</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> demo.tree_data;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> demo.tree_data (<br>    <span class="hljs-keyword">id</span> <span class="hljs-built_in">integer</span>,<br>    code <span class="hljs-built_in">text</span>,<br>    pid <span class="hljs-built_in">integer</span>,<br>    <span class="hljs-keyword">sort</span> <span class="hljs-built_in">integer</span><br>);<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> demo.tree_data <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;中国&#x27;</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> demo.tree_data <span class="hljs-keyword">values</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;四川&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> demo.tree_data <span class="hljs-keyword">values</span>(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;云南&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> demo.tree_data <span class="hljs-keyword">values</span>(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;成都&#x27;</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> demo.tree_data <span class="hljs-keyword">values</span>(<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;绵阳&#x27;</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);    <br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> demo.tree_data <span class="hljs-keyword">values</span>(<span class="hljs-number">6</span>, <span class="hljs-string">&#x27;武侯区&#x27;</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> demo.tree_data <span class="hljs-keyword">values</span>(<span class="hljs-number">7</span>, <span class="hljs-string">&#x27;昆明&#x27;</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">with</span> <span class="hljs-keyword">recursive</span> cte <span class="hljs-keyword">as</span><br>(<br>  <span class="hljs-comment">-- 先查询root节点  </span><br>  <span class="hljs-keyword">select</span><br>    <span class="hljs-keyword">id</span>, code, pid, <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">as</span> pcode,<br>    code <span class="hljs-keyword">as</span> branch<br>  <span class="hljs-keyword">from</span>  demo.tree_data <span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">1</span><br>  <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span><br>  <span class="hljs-comment">-- 通过cte递归查询root节点的直接子节点  </span><br>  <span class="hljs-keyword">select</span><br>    origin.id, origin.code, cte.id <span class="hljs-keyword">as</span> pid, cte.code <span class="hljs-keyword">as</span> pcode,<br>    cte.branch || <span class="hljs-string">&#x27;~&#x27;</span> || origin.code<br>  <span class="hljs-keyword">from</span> cte<br>  <span class="hljs-keyword">join</span> demo.tree_data <span class="hljs-keyword">as</span> origin <span class="hljs-keyword">on</span> origin.pid = cte.id<br>)<br><span class="hljs-keyword">select</span><br>  <span class="hljs-keyword">id</span>,code, pid, pcode, branch, <br>  <span class="hljs-comment">-- 通过计算分隔符的个数，模拟计算出树形的深度</span><br>  (<span class="hljs-keyword">length</span>(branch)-<span class="hljs-keyword">length</span>(<span class="hljs-keyword">replace</span>(branch, <span class="hljs-string">&#x27;~&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>))) <span class="hljs-keyword">as</span> lvl<br><span class="hljs-keyword">from</span> cte;<br><br><span class="hljs-comment">-- </span><br> id |  code  | pid | pcode |        branch         | lvl<br><span class="hljs-comment">----+--------+-----+-------+-----------------------+-----</span><br>  1 | 中国   |     |      | 中国                 |   0<br>  2 | 四川   |   1 | 中国  | 中国~四川            |   1<br>  3 | 云南   |   1 | 中国  | 中国~云南            |   1<br>  4 | 成都   |   2 | 四川  | 中国~四川~成都        |   2<br>  5 | 绵阳   |   2 | 四川  | 中国~四川~绵阳        |   2<br>  7 | 昆明   |   3 | 云南  | 中国~云南~昆明        |   2<br>  6 | 武侯区 |   4 | 成都  | 中国~四川~成都~武侯区   |   3<br></code></pre></td></tr></table></figure><p>例一：通过编码作为关联关系</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">&quot;public&quot;</span>.<span class="hljs-string">&quot;area&quot;</span> (<br>    <span class="hljs-string">&quot;id&quot;</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">nextval</span>(<span class="hljs-string">&#x27;area_id_seq&#x27;</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>    <span class="hljs-string">&quot;name&quot;</span> <span class="hljs-built_in">text</span>,<br>    <span class="hljs-string">&quot;code&quot;</span> <span class="hljs-built_in">text</span>,<br>    <span class="hljs-string">&quot;lft&quot;</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span>,<br>    <span class="hljs-string">&quot;rgt&quot;</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span>,<br>    <span class="hljs-string">&quot;customized&quot;</span> <span class="hljs-built_in">boolean</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;parent&quot;</span> <span class="hljs-built_in">text</span>,<br>    <span class="hljs-keyword">CONSTRAINT</span> <span class="hljs-string">&quot;area_pkey&quot;</span> PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">&quot;id&quot;</span>)<br>) <span class="hljs-keyword">WITH</span> (oids = <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">with</span> <span class="hljs-keyword">recursive</span> cte <span class="hljs-keyword">as</span><br>      (<br>        <span class="hljs-comment">-- query the root node first</span><br>        <span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>, code, <span class="hljs-keyword">parent</span>, <span class="hljs-keyword">name</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">as</span> branch <span class="hljs-keyword">from</span> area <span class="hljs-keyword">where</span> code = <span class="hljs-string">&#x27;110&#x27;</span><br>        <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span><br>        <span class="hljs-comment">-- recursively query the direct child nodes of the root node through cte</span><br>        <span class="hljs-keyword">select</span> o.id, o.code, cte.code, o.name, cte.branch || <span class="hljs-string">&#x27;~&#x27;</span> || o.name <span class="hljs-keyword">from</span> cte <span class="hljs-keyword">join</span> area <span class="hljs-keyword">as</span> o <span class="hljs-keyword">on</span> o.parent = cte.code<br>      )<br>      <span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>, code, <span class="hljs-keyword">parent</span>, <span class="hljs-keyword">name</span>, branch, (<span class="hljs-keyword">length</span>(branch)-<span class="hljs-keyword">length</span>(<span class="hljs-keyword">replace</span>(branch, <span class="hljs-string">&#x27;~&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>))) <span class="hljs-keyword">as</span> lvl <span class="hljs-keyword">from</span> cte;<br></code></pre></td></tr></table></figure><blockquote><p><strong>注意：递归中字段必须使用text类型，也可在查询重强制类型转换</strong></p></blockquote><p>例二：转换为节点关系为ID</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">with</span> <span class="hljs-keyword">recursive</span> cte <span class="hljs-keyword">as</span><br>(<br>        <span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>, lft, rgt, code::<span class="hljs-built_in">text</span>, <span class="hljs-keyword">parent</span>::<span class="hljs-built_in">text</span>, <span class="hljs-literal">null</span> <span class="hljs-keyword">as</span> parent_id, <span class="hljs-string">&quot;name&quot;</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">&quot;name&quot;</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> branch <span class="hljs-keyword">from</span> area <span class="hljs-keyword">where</span> code = <span class="hljs-string">&#x27;110&#x27;</span><br>        <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span><br>        <span class="hljs-keyword">select</span> o.id, o.lft, o.rgt, o.code::<span class="hljs-built_in">text</span>, cte.code::<span class="hljs-built_in">text</span>, cte.id::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> parent_id, o.name, cte.branch || <span class="hljs-string">&#x27;~&#x27;</span> || o.name <span class="hljs-keyword">from</span> cte<br>        <span class="hljs-keyword">join</span> area <span class="hljs-keyword">as</span> o <span class="hljs-keyword">on</span> o.parent::<span class="hljs-built_in">text</span> = cte.code::<span class="hljs-built_in">text</span><br>)<br><span class="hljs-keyword">select</span><br>        <span class="hljs-keyword">id</span>,<br>        <span class="hljs-keyword">now</span>() <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;created_time&quot;</span>,<br>        <span class="hljs-string">&quot;name&quot;</span>,<br>        code,<br>        <span class="hljs-literal">null</span> <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;longitude&quot;</span>,<br>    <span class="hljs-literal">null</span> <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;latitude&quot;</span>,<br>        lft,<br>    rgt,<br>    ((<span class="hljs-keyword">length</span>(branch) - <span class="hljs-keyword">length</span>(<span class="hljs-keyword">replace</span>(branch, <span class="hljs-string">&#x27;~&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>))) + <span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> <span class="hljs-keyword">level</span>,<br>      <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;tree_id&quot;</span>,<br>        parent_id::<span class="hljs-built_in">int</span><br><span class="hljs-keyword">from</span><br>        cte<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span><br>        lft<br></code></pre></td></tr></table></figure><blockquote><p>使用类型转换</p></blockquote><p><a href="https://juejin.im/post/6844904061414670350">参考</a></p><h3 id="物化视图"><a href="#物化视图" class="headerlink" title="物化视图"></a>物化视图</h3><p>PostgreSQL中的物化视图像视图一样使用了规则系统，但是以一种类表的形式保留了结果。物化视图不能直接被更新，并且用于创建物化视图的查询的存储方式和视图查询的存储方式完全相同。</p><p>使用物化视图能够有效解决复杂的视图查询慢的问题，缺点是数据不实时，需要一个定时任务定期刷新数据。</p><ul><li>创建物化视图</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">语法：<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">MATERIALIZED</span> <span class="hljs-keyword">VIEW</span> table_name<br>    [ (column_name [, ...] ) ]<br>    [ <span class="hljs-keyword">WITH</span> ( storage_parameter [= <span class="hljs-keyword">value</span>] [, ... ] ) ]<br>    [ <span class="hljs-keyword">TABLESPACE</span> tablespace_name ]<br>    <span class="hljs-keyword">AS</span> <span class="hljs-keyword">query</span><br>    [ <span class="hljs-keyword">WITH</span> [ <span class="hljs-keyword">NO</span> ] <span class="hljs-keyword">DATA</span> ]<br><br>例子：<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">materialized</span> <span class="hljs-keyword">view</span> view_country_m <span class="hljs-keyword">as</span><br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> country <span class="hljs-keyword">where</span> is_show=<span class="hljs-literal">true</span>;<br><br></code></pre></td></tr></table></figure><ul><li>刷新物化视图数据</li></ul><p>1、<strong>全量刷新</strong>：默认为全量刷新，将会使用更少的资源并且完成地更迅速，但是<strong>物化视图将保留在不可扫描的状态，直至刷新完成。</strong></p><p>2、<strong>增量刷新</strong>：参数<code>CONCURRENTLY</code>(version &gt;=9.4)，将当前视图表中的数据和query中的数据做一个join操作，然后才将差量做填充。增量刷新会比全量刷新更耗费资源并且更慢，在物化视图上有至少一个UNIQUE索引才能使用，但是不会阻止物化视图被扫描</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">语法：<br>REFRESH MATERIALIZED VIEW [ CONCURRENTLY ] name<br>    [ <span class="hljs-keyword">WITH</span> [ <span class="hljs-keyword">NO</span> ] <span class="hljs-keyword">DATA</span> ]<br><br>例子：<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> <span class="hljs-keyword">index</span> view_country_code_index <span class="hljs-keyword">on</span> view_country_m(code);<br>refresh materialized view concurrently view_country_m<br></code></pre></td></tr></table></figure><blockquote><ul><li><code>concurrently</code> 参数为增量刷新数据</li><li>定期刷新可以参考<a href="https://www.kankanzhijian.com/2018/08/11/pg_cron_and_materialized_view/">文章</a></li></ul></blockquote><ul><li>删除物化视图</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">语法：<br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">MATERIALIZED</span> <span class="hljs-keyword">VIEW</span> [ <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> ] <span class="hljs-keyword">name</span> [, ...] [ <span class="hljs-keyword">CASCADE</span> | RESTRICT ]<br><br>例子：<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">materialized</span> <span class="hljs-keyword">view</span> view_country_m ;<br></code></pre></td></tr></table></figure><blockquote><p>Tip: <code>DROP MATERIALIZED VIEW</code> 删除已存在的物化视图。要执行该命令必须是该物化视图的所有者。</p></blockquote><p><strong>注意！使用物化视图生成的表字段默认都是允许为空，并且不能做修改。如果有特殊需求，可以在物化视图的基础上，新建其复制表，这样就可以正常添加索引和设置字段约束，如下所示：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 复制表结构和数据</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-string">&quot;cmv_es_item_info&quot;</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">table</span> <span class="hljs-string">&quot;mv_es_item_info&quot;</span>;   <br><span class="hljs-comment">-- 设置主键和约束字段</span><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-string">&quot;cmv_es_item_info&quot;</span> <span class="hljs-keyword">add</span> primary <span class="hljs-keyword">key</span> (<span class="hljs-string">&quot;id&quot;</span>);<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-string">&quot;cmv_es_item_info&quot;</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> <span class="hljs-string">&quot;no&quot;</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure><p>这样我们就可以对表<code>cmv_es_item_info</code> 进行相关操作。这里还有一个问题，物化视图更新数据时，我们需要对应更新复制表数据。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">truncate</span> cmv_es_item_info;<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> cmv_es_item_info <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> mv_es_item_info;<br><span class="hljs-keyword">end</span>;<br></code></pre></td></tr></table></figure><blockquote><p>在一个事务内删除数据，并且从原表插入数据到新表。</p></blockquote><h3 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h3><p>当数据达到千万级甚至更高时，数据查询就会比较耗时了，这时我们可以利用表分区来提升查询性能。</p><p>创建分区有两种方式：(1)、DeclarativePartitioning定义分区表；(2)、使用表继承(Inheritance)方式定义分区表。我们使用第一种即可满足大部分业务场景。一般如果可以直接查询子表，查询效率会比查询主表要好。</p><blockquote><ul><li><p>使用表继承(Inheritance)方式定义分区表，见文章：<a href="https://www.modb.pro/db/11324">PostgreSQL-12分区表详解</a> \ <a href="http://www.postgres.cn/docs/13/ddl-partitioning.html">postgres表分区</a></p></li><li><p>pgsql同样支持多级分区，见文章：<a href="https://www.cnblogs.com/Richard2014/p/9930612.html">pgsql多级分区</a></p></li></ul></blockquote><ol><li>创建分区主表(partition by range)，指定范围的数据落入指定的分区(前闭后开)，pg10引入。</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 创建主表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> area_statistics (<br>    <span class="hljs-keyword">id</span> <span class="hljs-built_in">serial</span>,<br>    area_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<br>    area_name <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<br>    area_level <span class="hljs-built_in">smallint</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<br>    <span class="hljs-string">&quot;type&quot;</span> <span class="hljs-built_in">smallint</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<br>    category_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<br>    category_name <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<br>    record_time <span class="hljs-built_in">date</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<br>    edition_total <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>,<br>    illegal_edition_total <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>,<br>    amount <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>,<br>    illegal_amount <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>,<br>    <span class="hljs-keyword">duration</span> <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>,<br>    illegal_duration <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span><br>) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">range</span>(area_id);<br><span class="hljs-comment">-- 添加主表索引</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> area_statistics_area_id_index <span class="hljs-keyword">on</span> area_statistics(area_id);<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> area_statistics_type_index <span class="hljs-keyword">on</span> area_statistics(<span class="hljs-string">&quot;type&quot;</span>);<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> area_statistics_category_id_index <span class="hljs-keyword">on</span> area_statistics(category_id);<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> area_statistics_record_time_index <span class="hljs-keyword">on</span> area_statistics(record_time);<br><span class="hljs-comment">-- 创建子表</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">&quot;area_statistics_1&quot;</span>  <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> area_statistics <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-number">0</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-number">10</span>);<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">&quot;area_statistics_2&quot;</span>  <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> area_statistics <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-number">10</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-number">20</span>);<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">&quot;area_statistics_default&quot;</span> <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> area_statistics <span class="hljs-keyword">DEFAULT</span>;<br></code></pre></td></tr></table></figure><blockquote><ul><li>在 PostgreSQL 10 中，分区上的索引需要基于各个分区手动创建，而不能基于分区的父表创建索引。PostgreSQL 11 可以基于分区表创建索引。分区表上的索引并不会创建一个物理上的索引，而是为每个分区上的索引创建一个模板。也就是说，如果在分区表上创建了一个索引，PostgreSQL 自动为每个分区创建具有相同属性的索引。</li><li>FROM (0) TO (10)  -&gt; 取0-9</li></ul></blockquote><ol start="2"><li>创建分区主表(partition by list)，当列值等于某个特定值的时候，落入指定的分区。pg10引入。</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> sale_order<br>(<br>order_no    <span class="hljs-built_in">integer</span>,   <br>amount      <span class="hljs-built_in">decimal</span>(<span class="hljs-number">5</span>,<span class="hljs-number">2</span>),<br>country     <span class="hljs-built_in">varchar</span>(<span class="hljs-number">20</span>)<br>) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">LIST</span>(country);<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> europe_order<br> <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> sale_order <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;germany&#x27;</span>, <span class="hljs-string">&#x27;sweden&#x27;</span>);<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> default_order<br> <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> sale_order <span class="hljs-keyword">DEFAULT</span>;<br></code></pre></td></tr></table></figure><p>3.. 创建分区主表(parition by hash)，pg11引入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 插入数据时，对列o_w_id取余，结果等于0,1,2,3，行数据分别落入分区orders_p1, orders_p2, orders_p3，orders_p4。</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> orders (<br>  o_w_id      <span class="hljs-built_in">integer</span>     <span class="hljs-keyword">notnull</span>,<br>  o_d_id      <span class="hljs-built_in">integer</span>     <span class="hljs-keyword">notnull</span>,<br>  o_id        <span class="hljs-built_in">integer</span>     <span class="hljs-keyword">notnull</span>,<br>  o_c_id      <span class="hljs-built_in">integer</span>,<br>  o_carrier_id <span class="hljs-built_in">integer</span>,<br>  o_ol_cnt    <span class="hljs-built_in">integer</span>,<br>  o_all_local <span class="hljs-built_in">integer</span>,<br>  o_entry_d   <span class="hljs-built_in">timestamp</span><br>)PARTITIONBY <span class="hljs-keyword">HASH</span> (o_w_id);<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_p1 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> orders<br>    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (MODULUS <span class="hljs-number">4</span>, <span class="hljs-keyword">REMAINDER</span> <span class="hljs-number">0</span>);<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_p2 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> orders<br>    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (MODULUS <span class="hljs-number">4</span>, <span class="hljs-keyword">REMAINDER</span> <span class="hljs-number">1</span>);<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_p3 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> orders<br>    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (MODULUS <span class="hljs-number">4</span>, <span class="hljs-keyword">REMAINDER</span> <span class="hljs-number">2</span>);<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_p4 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> orders<br>    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (MODULUS <span class="hljs-number">4</span>, <span class="hljs-keyword">REMAINDER</span> <span class="hljs-number">3</span>);<br></code></pre></td></tr></table></figure><ul><li>插入测试数据</li></ul><p>随机生成插入2亿条测试数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DO</span> $$<br><span class="hljs-keyword">BEGIN</span><br>   <span class="hljs-keyword">FOR</span> counter <span class="hljs-keyword">IN</span> <span class="hljs-number">0.</span><span class="hljs-number">.19999</span> <span class="hljs-keyword">LOOP</span><br>         <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> area_statistics<br>        <span class="hljs-keyword">SELECT</span> <br>            generate_series(<span class="hljs-number">1</span> + counter * <span class="hljs-number">10000</span> , <span class="hljs-number">10000</span> * (counter + <span class="hljs-number">1</span>) ) <span class="hljs-keyword">as</span> <span class="hljs-keyword">id</span>,<br>            int4(random()*<span class="hljs-number">100</span>) <span class="hljs-keyword">as</span> area_id,<br>            <span class="hljs-keyword">concat</span>(<span class="hljs-string">&#x27;AREA_&#x27;</span>, <span class="hljs-keyword">chr</span>(int4(random()*<span class="hljs-number">26</span>)+<span class="hljs-number">65</span>)) <span class="hljs-keyword">as</span> area_name, <br>            int4(random()*<span class="hljs-number">2</span>) + <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> area_level,<br>            int4(random()*<span class="hljs-number">2</span>) + <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;type&quot;</span>,<br>            int4(random()*<span class="hljs-number">100</span>) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;category_id&quot;</span>,<br>            <span class="hljs-keyword">concat</span>(<span class="hljs-string">&#x27;CATEGORG_&#x27;</span>, <span class="hljs-keyword">chr</span>(int4(random()*<span class="hljs-number">26</span>)+<span class="hljs-number">65</span>)) <span class="hljs-keyword">as</span> <span class="hljs-string">&quot;category_name&quot;</span>,<br>            <span class="hljs-string">&#x27;2020-01-01&#x27;</span>::<span class="hljs-built_in">timestamp</span> + (int4(random()*<span class="hljs-number">365</span>) || <span class="hljs-string">&#x27; day&#x27;</span>)::<span class="hljs-built_in">interval</span>  <span class="hljs-keyword">as</span> record_time,<br>            int4(random()*<span class="hljs-number">10</span>) + <span class="hljs-number">11</span> <span class="hljs-keyword">as</span> edition_total,<br>            int4(random()*<span class="hljs-number">10</span>) <span class="hljs-keyword">as</span> illegal_edition_total,<br>            int4(random()*<span class="hljs-number">10</span>) + <span class="hljs-number">50</span> <span class="hljs-keyword">as</span> amount,<br>            int4(random()*<span class="hljs-number">20</span>) <span class="hljs-keyword">as</span> illegal_amount,<br>            int4(random()*<span class="hljs-number">1000</span>) + <span class="hljs-number">500</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">duration</span>,<br>            int4(random()*<span class="hljs-number">500</span>) <span class="hljs-keyword">as</span> illegal_duration;<br>   <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<br><span class="hljs-keyword">END</span>; $$<br></code></pre></td></tr></table></figure><ul><li><a href="https://zhuanlan.zhihu.com/p/110927990?utm_source=wechat_session&utm_medium=social&utm_oi=871331077594152960">实战 PostgreSQL 分区表</a></li><li><a href="https://www.modb.pro/db/11324">PostgreSQL-12分区表详解</a></li><li><a href="http://www.postgres.cn/docs/13/ddl-partitioning.html">postgres表分区</a></li><li><a href="https://www.cnblogs.com/Richard2014/p/9930612.html">pgsql多级分区</a></li></ul><h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>事务隔离级别从低到高分别是：<strong>读未提交、读已提交、可重复读、可并行化</strong>。 mysql默认隔离级别为：可重复读，pgsql默认隔离级别为：读已提交。</p><p>不同事务隔离级别可能会导致以下情况：</p><ul><li><p>脏读：读取到其他事务未提交的数据。设置到【读已提交】以上事务级别避免脏读</p></li><li><p>不可重复读：同一个事务同一个查询语句，在其他事务中修改数据提交之后，总能查询到最新的数据，设置到【可重复读】以上事务级别可避免。</p></li><li><p>幻读：幻读与可重复读都是读到其他事务已提交的数据，只是针对点不同，幻读针对insert和delete，后者针对update，设置到【可并行化】可避免出现幻读。</p></li></ul><table><thead><tr><th align="center"></th><th align="center">脏读</th><th align="center">不可重复读</th><th align="center">幻读</th></tr></thead><tbody><tr><td align="center">读未提交</td><td align="center">可能</td><td align="center">可能</td><td align="center">可能</td></tr><tr><td align="center">读已提交</td><td align="center">不可能</td><td align="center">可能</td><td align="center">可能</td></tr><tr><td align="center">可重复读</td><td align="center">不可能</td><td align="center">不可能</td><td align="center">可能</td></tr><tr><td align="center">可并行化</td><td align="center">不可能</td><td align="center">不可能</td><td align="center">不可能</td></tr></tbody></table><p>事务隔离级别越高，对数据库的开销越大，性能会收到很大的影响，并发也会减少，一般根据业务情况设置合适的即可。</p><ul><li><a href="https://learnku.com/articles/40258">彻底搞懂 MySQL 事务的隔离级别</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pgsql</tag>
      
      <tag>sql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux简易上手指南</title>
    <link href="/Myblog/2018/10/08/Linux%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E6%8C%87%E5%8D%97/"/>
    <url>/Myblog/2018/10/08/Linux%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<p>计算机网络分层架构模型<br>Internet — TCP/IP协议族<br>TCP — Transfer Control Protocol - 传输控制协议<br>UDP — User Datagram Protocol - 用户数据报协议<br>IP — Internet Protocol - 网际协议</p><p>TCP/IP模型<br>应用层（定义应用级的协议） - HTTP、SMTP、POP3、FTP、SSH、ICQ/QQ……<br>传输层（端到端传输数据） - TCP/UDP……<br>网络层/网际层（寻址和路由） - IP/ICMP……<br>物理链路层（数据分帧+校验） - 冗余校验码……</p><h3 id="Linux基本操作"><a href="#Linux基本操作" class="headerlink" title="Linux基本操作"></a>Linux基本操作</h3><h4 id="简单使用命令"><a href="#简单使用命令" class="headerlink" title="简单使用命令"></a>简单使用命令</h4><p><a href="http://www.runoob.com/linux/linux-command-manual.html">Linux命令大全</a><br>查看手册 – <strong>man + 命令</strong> or  <strong>命令 –help</strong></p><ul><li>clear 清屏</li><li>w / last /who /  who am i  获取登录信息</li><li>ps 查看进程</li><li>kill （kill -9 ） 杀死进程（强行杀死进程）</li><li>adduser 创建用户</li><li>userdel 删除用户</li><li>su 切换用户</li><li>cd 切换</li><li>pwd 查看当前路径</li><li>ls 查看文件和文件夹</li><li>history  查看历史命令（！编号：执行对应编号的命令）</li><li>mkdir 创建文件夹</li><li>rmdir 删除空文件夹</li><li>cp 复制文件和目录</li><li>rm 删除</li><li>touch 创建文件修改文件最后访问时间</li><li>mv 移动或者改名</li><li>echo 回声</li><li>head/tail 查看文件开头/结尾</li><li>less/more 分屏查看文件</li><li>wc 统计行数，单词，字节</li><li>sort <file>排序</li><li>uniq <file> 去重（相邻行）</li><li>alias 别名（alias rmd=”rm -rf”）</li><li>unalias 取消别名</li><li>diff 比较</li><li>vim -d 比较（详细）</li><li>ln<br>硬链接 - 文件的引用，只要引用数不为零，文件就一直存在，相当于分身（ln）。<br>软链接 - 相当于文件的快捷方式（ln - s）。</li><li>“&gt;” 输出重定向</li><li>“&gt;&gt;” 追加输出重定向</li><li>“2&gt;” 错误输出重定向</li><li>“&lt;” 输入重定向</li><li>“|” 管道（进程间通信）- 把前一个进程的输出作为后一个进程的输入</li></ul><p>系统计时任务：crontab</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">*    *    *    *    *<br>-    -    -    -    -<br>|    |    |    |    |<br>|    |    |    |    |<br>|    |    |    |    +----- day of week (0 - 7) (Sunday=0 or 7)<br>|    |    |    +---------- month (1 - 12)<br>|    |    +--------------- day of month (1 - 31)<br>|    +-------------------- hour (0 - 23)<br>+------------------------- min (0 - 59)<br></code></pre></td></tr></table></figure><h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><p><strong>注册环境变量：</strong></p><p>用户环境变量位置：<code>~/.bash_profile</code></p><p>系统环境变量：<code>/etc/bashrc</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">PATH=$PATH:&lt;自定义路径&gt;<br>export PATH<br></code></pre></td></tr></table></figure><h4 id="服务和防火墙"><a href="#服务和防火墙" class="headerlink" title="服务和防火墙"></a>服务和防火墙</h4><p>启动、关闭、重启服务和查看服务状态<br>systemctl start <name><br>systemctl stop <name><br>systemctl restart <name><br>systemctl status <name><br>systemctl enable <name> 开启开机自启动<br>systemctl disable <name> 关闭开机自启动<br>低版本使用service命令：<br>service <name> start</p><p>常用的防火墙服务有firewall和iptables<br>systemctl start firewalld 开启防火墙<br>firewall-cmd –add-service=httpd  开启服务<br>firewall-cmd –permanent –add-port=443/tcp 永久开启 开启端口<br>firewall-cmd –query-port=443/tcp 查看端口是否开启<br>firewall-cmd –query-service=httpd 查看服务是否开启<br>再重启防火墙生效</p><p>top - 按CPU占用率从高到低排列进程</p><p>如果需要把运行中的进程终止掉 - Ctrl + C<br>如果需要把运行中的进程放在后台 - Ctrl + Z<br>中止输入 - Ctrl + D</p><p>执行命令时在命令后面加上&amp;符号，就可以把命令置于后台运行<br>jobs - 查看后台进程<br>bg %编号 - 把后台暂停的进程运行<br>fg %编号 - 把后台进程在前台运行</p><h3 id="Linux系统安装软件"><a href="#Linux系统安装软件" class="headerlink" title="Linux系统安装软件"></a>Linux系统安装软件</h3><ul><li>使用包管理工具进行安装 yum / rpm<br>yum search <name> 搜索<br>yum -y install <name1>  安装<br>yum -y remove <name2> 卸载<br>yum info <name> 查看信息<br>yum update <name> 更新<br>yum list installed  查看目前安装的所有软件<br>systemctl start nginx 启动服务</li><li>源代码构建安装<br>wget  -&gt;  gunzip  -&gt; tar -xvf  -&gt;  make &amp;&amp; make install  -&gt; export PATH …（一次性） 或者 修改.bash_profile配置环境变量</li></ul><p>压缩文件<br>-gz文件 —-gzip 压缩 / gunzip 解压缩<br>-xz文件 —- xz -z压缩 / xz -d 解压缩</p><h3 id="源代码构建安装实战"><a href="#源代码构建安装实战" class="headerlink" title="源代码构建安装实战"></a>源代码构建安装实战</h3><h4 id="CentOS安装python3-7"><a href="#CentOS安装python3-7" class="headerlink" title="CentOS安装python3.7"></a>CentOS安装python3.7</h4><p><strong>源码安装</strong><br>1、wget <a href="https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tgz">https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tgz</a><br>2、解压缩<br>gunzip Python-3.7.0.tgz<br>3、解归档<br>tar -xvf Python-3.7.0.tar<br>4、安装底层依赖库<br><code>yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel libffi-devel</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">一般是c语言源代码，所以需要安装gcc编译器，比如git需要安装这些<br>yum install -y gcc curl libcurl-devel zlib-devel<br></code></pre></td></tr></table></figure><p>5、安装前的配置<br>cd Python-3.7.0 进入目录，指定安装路径<br><code>./configure --prefix=/usr/local/python3 --enable-optimizations</code><br>6、构建安装<br>make &amp;&amp; make install<br>7、配置PATH环境变量（一次性的）<br>export PATH=$PATH:/usr/local/python3/bin<br>8、注册软连接（符合链接）– 非必要<br>ln -s /usr/local/python3/bin/python3 /usr/bin/python3<br>硬链接 - 文件的引用，只要引用数不为零，文件就一直存在，相当于分身（ln）<br>软链接 - 相当于文件的快捷方式（ln - s）</p><h3 id="vim文本编辑器"><a href="#vim文本编辑器" class="headerlink" title="vim文本编辑器"></a>vim文本编辑器</h3><p>三种模式：命令模式、编辑模式、末行模式</p><ul><li>末行模式</li></ul><p>1、： + 命令</p><ul><li><p>set nu / set nonu   查看行号</p></li><li><p>syntax on（默认）/syntax off（关闭） 高亮显示</p></li><li><p>set autoindent  自动对齐</p></li><li><p>set ts=4  制表键为4个空格</p></li><li><p>set ruler 显示光标所在位置</p></li><li><p>set encoding=utf-8  编码方式</p></li><li><p>set fileencoding=uft-8  文件编码方式</p></li></ul><p>查找和替换<br><code>：1,$s/旧/新/gice</code> （$代表到最后，s代表替换，g-全局模式，i-忽略大小写，c-确认模式，e-忽略错误）</p><p>2、/ + 正则表达式 —搜索<br>n - 正向搜索<br>N - 反向搜索<br>3、？ + 正则表达式 - 反向搜索</p><ul><li>命令模式<br>hjkl / HML / 0$ / w - 移动光标<br>ctrl + e / ctrl + y / ctrl + f / ctrl + b 翻页<br>yy复制 / p粘贴 / dd删除 / u撤销 / ctrl + r取消撤销<br>ctrl + x –&gt; ctrl + o 代码提示</li></ul><p>拆分窗口<br>：vs 垂直拆分<br>：sp 水平拆分<br>  ctrl +w –&gt; ctrl +w 窗口切换光标<br>：wqa 全部窗口保存退出</p><h3 id="分享一个“自慰神器”"><a href="#分享一个“自慰神器”" class="headerlink" title="分享一个“自慰神器”"></a>分享一个“自慰神器”</h3><p>可以在启动配置文件里面添加shell语句<br><code>~/.bash_profile</code>  这里修改只有root才能看到<br><code>/etc/profile</code> 这里修改，登录的用户都能看到<br>下面是添加的代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">username=`whoami`<br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$username</span>&quot;</span> = <span class="hljs-string">&quot;root&quot;</span> ]<br><span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;热烈欢迎『洁帅大大』登录阿里云服务器，阿里云全体员工在此全体起立，鼓掌！！！&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;您是超级管理员，掌控雷电，为非作歹，无所不能~~&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请爸爸输入名字:&quot;</span> realname<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;热烈欢迎『<span class="hljs-variable">$realname</span>』登录阿里云服务器，阿里云全体员工在此起立，鼓掌！！！&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;记住，你只是一个普通用户！&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">fi</span><br><br></code></pre></td></tr></table></figure><p>效果：<br>超级用户登录：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Last login: Fri Oct 12 16:49:49 2018 <span class="hljs-keyword">from</span> 125.70.30.209<br><br>Welcome <span class="hljs-keyword">to</span> Alibaba Cloud Elastic Compute<span class="hljs-built_in"> Service </span>!<br><br>热烈欢迎『洁帅大大』登录阿里云服务器，阿里云全体员工在此全体起立，鼓掌！！！<br><br>您是超级管理员，掌控雷电，为非作歹，无所不能~~<br><br>[root@aliyun ~]# <br></code></pre></td></tr></table></figure><p>普通用户登录：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elixir">请爸爸输入名字<span class="hljs-symbol">:</span>星辰<br>热烈欢迎『星辰』登录阿里云服务器，阿里云全体员工在此起立，鼓掌！！！<br>记住，你只是一个普通用户！<br><br>[stellae<span class="hljs-variable">@aliyun</span> ~]<span class="hljs-variable">$ </span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git基础命令</title>
    <link href="/Myblog/2018/09/30/Git/"/>
    <url>/Myblog/2018/09/30/Git/</url>
    
    <content type="html"><![CDATA[<p>Git是一个版本控制工具 – 分布式的版本控制系统</p><p>Mercury – python开发的版本控制软件</p><p>配置邮箱和用户名<br>git config –global user.name <user><br>git config –global user.email <email></p><h4 id="Git常用操作"><a href="#Git常用操作" class="headerlink" title="Git常用操作"></a>Git常用操作</h4><ul><li>git init – 初始化 – 将一个文件夹初始化成git本地仓库</li><li>git add <file>  -  将文件添加到暂存区</li><li>git reset HEAD <file>  -  将文件从暂存区移除</li><li>git checkout – <file>  -  将暂存区的文件恢复到工作区</li><li>git status  -  查看暂存区的状态</li><li>git commit  -  将暂存区的内容提交到本地仓库</li><li>git branch - 查看当前分支</li><li>git checkout -b <branch_name> 创建分支并切换</li><li>git log  -  查看提交日志（当前版本之前的版本）</li><li>git reflog  -  查看日志（所有的版本）</li><li>git reset <id>  -  回到指定版本</li><li>git reset –soft HEAD～1 - 撤销commit，不会修改代码，数量代表撤销次数</li><li>git HEAD^  -  回到上一个版本</li><li>git clone - 克隆</li><li>git push - 推 / 上传</li><li>git pull - 拉 / 下载</li><li>git fetch - 取</li><li>git rebase - 变基</li></ul><h4 id="代码托管平台-用别人提供的Git服务器"><a href="#代码托管平台-用别人提供的Git服务器" class="headerlink" title="代码托管平台  -  用别人提供的Git服务器"></a>代码托管平台  -  用别人提供的Git服务器</h4><p>全球最大的代码托管平台  -  github.com<br>国内  - gitee.com  /  coding.net</p><p>一般公司里面会自己用gitlab搭建自己的git私服</p><p>创建git项目后，需要对项目进行初始版本更新，比如生成<code> .gitignore</code>文件，它可以忽略一些不被纳入版本控制的文件，一般我们可以在 <code>https://www.gitignore.io/</code>网站中生成专业的忽略文件信息，输入对应的语言和工具即可。并且把master设置为保护状态。</p><p>在开发过程中如果要同步master分支上他人提交的工作成果，可以使用以下两种方式：</p><ol><li>git pull origin master</li><li>git fetch / git rebase master<br>如果有冲突，可以选择接受/保留/手动合并<br>git rebase –continue 继续变基<br>git rebase –abort 放弃变基</li></ol><h4 id="Git的规范流程-分支管理策略"><a href="#Git的规范流程-分支管理策略" class="headerlink" title="Git的规范流程(分支管理策略)"></a>Git的规范流程(分支管理策略)</h4><p>如果不清楚，可以阅读阮一峰老师的<a href="http://www.ruanyifeng.com/blog/2015/12/git-workflow.html">Git 工作流程</a></p><p>注意：绝对不允许在master分支上直接做开发</p><ul><li>Git-flow</li></ul><p>两个长线分支：master / develop</p><p>三个短线分支： hotfix / feature / release</p><ul><li>Github-flow</li></ul><p>一般我们采用Github-flow规范流程</p><ol><li>克隆项目到本地并基于master分支创建自己的工作分支。<ul><li>git clone &lt;仓库的URL&gt;</li><li>git clone -o &lt;远端服务器名&gt; &lt;仓库的URL&gt;</li><li>git branch -a 查看所有分支</li><li>git branch &lt;分支名&gt; 创建 / git checkout -b &lt;分支名&gt; 创建并切换</li></ul></li><li>在自己的分支上做开发并实施本地版本控制。<ul><li>git add .</li><li>git status 查看工作区和暂存区的区别</li><li>git commit -m ‘’</li><li>git log –graph –abbrev-commit</li></ul></li><li>将自己的分支推送到服务器。<ul><li>git push origin &lt;分支名&gt;:&lt;服务器上的分支名&gt;</li></ul></li><li>发起一次合并请求，合并工作成果到master分支(线上完成)</li><li>项目管理者和测试人员会分别审查和测试代码，然后决定是否接受合并请求。</li></ol><p>在开发过程中如果要同步master分支上他人提交的工作成果，可以使用以下两种方式：</p><ol><li>git pull origin master</li><li>git fetch / git rebase master<br>如果有冲突，可以选择接受/保留/手动合并<br>git rebase –continue 继续变基<br>git rebase –abort 放弃变基</li></ol><ul><li>Gitlab-flow</li></ul>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ajax</title>
    <link href="/Myblog/2018/09/29/ajax/"/>
    <url>/Myblog/2018/09/29/ajax/</url>
    
    <content type="html"><![CDATA[<p>ajax = Asynchronous + JavaScript + And +  XML（现在XML慢慢已经被JSON取代）</p><p>Asynchronous：异步请求（没有中断浏览器的用户体验）从服务器获取数据。</p><p>JSON ： 通过DOM操作对页面进行局部刷新</p><p>ajax作用：异步加载数据 + 局部刷新页面</p><p>效果一：利用api查看美女图片</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;beauty&quot;</span>&gt;</span>换一组<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/jquery/1.12.2/jquery.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript">$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">$(<span class="hljs-string">&quot;#beauty&quot;</span>).on(<span class="hljs-string">&quot;click&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">$(<span class="hljs-string">&quot;a&quot;</span>).empty();</span><br><span class="javascript"><span class="hljs-keyword">var</span> url = <span class="hljs-string">&quot;http://api.tianapi.com/meinv/?key=3cedb24a8f5af4277b3de0b9c841e1d6&amp;num=20&quot;</span></span><br><span class="javascript">$.getJSON(url,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jsonOBJ</span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; jsonOBJ.newslist.length ; i += <span class="hljs-number">1</span>)&#123;</span><br><span class="javascript">$(<span class="hljs-built_in">document</span>.body).append(</span><br><span class="javascript">$(<span class="hljs-string">&quot;&lt;a&gt;&quot;</span>).html(jsonOBJ.newslist[i].title+<span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>).attr(<span class="hljs-string">&quot;href&quot;</span>,jsonOBJ.newslist[i].picUrl).attr(<span class="hljs-string">&quot;width&quot;</span>,<span class="hljs-string">&quot;400&quot;</span>)</span><br><br>);<br>&#125;<br>&#125;);<br>&#125;);<br>&#125;);<br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>效果二：api-周公解梦</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>周公解梦在线版<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span>&gt;</span><br><span class="css"><span class="hljs-selector-id">#main</span>&#123;</span><br>position: absolute;<br>margin: 100px 200px;<br>float: left;<br>width: 800px;<br>height: 400px;<br>border: solid black;<br>&#125;<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;main&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>解梦：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;输入您想查询梦的关键字&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;text&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;confirm&quot;</span>&gt;</span>查询<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>解析：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/jquery/1.12.2/jquery.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><br><span class="javascript">$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">$(<span class="hljs-string">&quot;#confirm&quot;</span>).on(<span class="hljs-string">&quot;click&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-keyword">var</span> content = $(<span class="hljs-string">&quot;#text&quot;</span>).val().trim();</span><br>if (content.length&gt;0)&#123;<br><br><span class="javascript"><span class="hljs-comment">//getJSON方法</span></span><br><span class="javascript"><span class="hljs-comment">//var str1 = encodeURIComponent(content,&quot;utf-8&quot;);</span></span><br><span class="javascript"><span class="hljs-comment">//var url = &quot;http://api.tianapi.com/txapi/dream/?key=3cedb24a8f5af4277b3de0b9c841e1d6&amp;word=&quot; + str1;</span></span><br><span class="javascript"><span class="hljs-comment">//$.getJSON(url,function(jsonOBJ)&#123;</span></span><br><span class="javascript"><span class="hljs-comment">//$(&quot;#main&gt;p&quot;).empty();</span></span><br><span class="javascript"><span class="hljs-comment">//if (jsonOBJ.code == 250)&#123;</span></span><br><span class="javascript"><span class="hljs-comment">//alert(&quot;未检索到相关信息！&quot;)；</span></span><br><span class="javascript"><span class="hljs-comment">//&#125;else&#123;</span></span><br><span class="javascript"><span class="hljs-comment">//$(&quot;#main&quot;).append($(&quot;&lt;p&gt;&quot;).text(jsonOBJ.newslist[0].result))；</span></span><br><span class="javascript"><span class="hljs-comment">//&#125;</span></span><br><span class="javascript"><span class="hljs-comment">//&#125;);</span></span><br><br><span class="javascript"><span class="hljs-comment">//ajax方法</span></span><br><span class="javascript">$.ajax(&#123;</span><br><span class="javascript"><span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">&quot;http://api.tianapi.com/txapi/dream/&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;get&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;data&quot;</span>:&#123;</span><br><span class="javascript"><span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;3cedb24a8f5af4277b3de0b9c841e1d6&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;word&quot;</span>:content</span><br>&#125;,<br><span class="javascript"><span class="hljs-string">&quot;dataType&quot;</span>: <span class="hljs-string">&quot;json&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jsonOBJ</span>)</span>&#123;</span><br>if (jsonOBJ.code == 250) &#123;<br><span class="javascript">alert(<span class="hljs-string">&quot;未检索到相关信息！&quot;</span>);</span><br><span class="javascript">&#125;<span class="hljs-keyword">else</span>&#123;</span><br><span class="javascript">$(<span class="hljs-string">&quot;#main&quot;</span>).append($(<span class="hljs-string">&quot;&lt;p&gt;&quot;</span>).text(jsonOBJ.newslist[<span class="hljs-number">0</span>].result));</span><br>&#125;<br>&#125;<br><br>&#125;);<br>&#125;<br><br><br>&#125;);<br>&#125;);<br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>Bootstrap响应式布局<br><a href="http://www.bootcss.com/">Bootstrap</a></p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ajax</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jQuery</title>
    <link href="/Myblog/2018/09/28/jQuery/"/>
    <url>/Myblog/2018/09/28/jQuery/</url>
    
    <content type="html"><![CDATA[<p>口号：Write Less Do More</p><hr><p>1.解决了浏览器兼容性问题<br>2.封装了常用的操作，用更少的代码做更多的事。</p><h5 id="引入jQuery"><a href="#引入jQuery" class="headerlink" title="引入jQuery"></a>引入jQuery</h5><p>1.使用自己项目中的jquery.min.js。<br>2.使用CDN服务器上的jQuery文件。</p><h5 id="如何使用jQuery"><a href="#如何使用jQuery" class="headerlink" title="如何使用jQuery"></a>如何使用jQuery</h5><p>jQuery对象的本质是一个伪数组</p><ul><li>有length属性</li><li>可以通过下标获取数据</li></ul><p><strong>window.jQuery属性  –&gt; $</strong></p><p><strong>1、$函数的参数是一个函数 - 传入的函数是页面加载完成之后要执行的回调函数</strong></p><p><strong>2、$函数的参数是选择器字符串 - 获得页面上的标签而且转换成JQuery对象。</strong><br>说明：为什么要获取jQuery对象 - 因为jQuery对象有更多封装好的方法可供调用。</p><ul><li>绑定/反绑定：on()/off()/one()</li><li>获取/修改标签内容：text()/html()</li><li>获取/修改标签属性：attr(name, value)</li><li>添加子节点：append()后 / prepend()前面</li><li>删除/清空节点：remove() / empty()</li><li>修改样式表：css({‘color’:’red’,……}) - 修改多个样式  （一个参数是读样式，两个是修改样式）</li><li>获取节点：parent() / children() / prev() /next() <ul><li>后两个是兄弟节点</li></ul></li></ul><p><strong>3、$函数的参数是标签字符串 - 创建标签并且返回对应的jQuery对象。</strong></p><p><strong>4、$函数的参数是原生JS对象 - 将原生JS对象转换成JQuery对象。</strong></p><ul><li>如果bar是一个jQuery对象 可以通过bar[0] / bar.get[0]</li></ul><p>四种$使用方法例子：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><br><span class="javascript">$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteItem</span>(<span class="hljs-params">evt</span>)</span>&#123;</span><br><span class="javascript">$(evt.target).parent().remove();</span><br>&#125;<br><span class="javascript">$(<span class="hljs-string">&quot;#fruits a&quot;</span>).on(<span class="hljs-string">&quot;click&quot;</span>,deleteItem);</span><br><span class="javascript">$(<span class="hljs-string">&quot;#ok&quot;</span>).on(<span class="hljs-string">&quot;click&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-keyword">var</span> fruitName = $(<span class="hljs-string">&quot;#container input[name=fruit]&quot;</span>).val().trim();</span><br>if (fruitName.length &gt; 0)&#123;<br><span class="javascript">$(<span class="hljs-string">&quot;#fruits&quot;</span>).append($(<span class="hljs-string">&quot;&lt;li&gt;&quot;</span>).text(fruitName).append($(<span class="hljs-string">&quot;&lt;a&gt;&quot;</span>).text(<span class="hljs-string">&quot;x&quot;</span>).attr(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;javascript:viod(0);&quot;</span>).on(<span class="hljs-string">&quot;click&quot;</span>,deleteItem)));</span><br>&#125;<br>&#125;);<br>&#125;);<br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>具体jQuery用法可以参考：<a href="http://www.runoob.com/manual/jquery/">jQuery API 手册</a></p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jQuery</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JS修改元素标签</title>
    <link href="/Myblog/2018/09/27/JS%E4%BF%AE%E6%94%B9%E5%85%83%E7%B4%A0%E6%A0%87%E7%AD%BE/"/>
    <url>/Myblog/2018/09/27/JS%E4%BF%AE%E6%94%B9%E5%85%83%E7%B4%A0%E6%A0%87%E7%AD%BE/</url>
    
    <content type="html"><![CDATA[<p><strong>根据拿到元素访问其他节点</strong><br>元素访问子节点 - children<br>元素访问父节点 - parentNode<br>元素访问兄弟节点 - previousSibling / nextSibling</p><h3 id="JS中拿到元素的的一些操作"><a href="#JS中拿到元素的的一些操作" class="headerlink" title="JS中拿到元素的的一些操作"></a>JS中拿到元素的的一些操作</h3><h4 id="1、修改元素样式"><a href="#1、修改元素样式" class="headerlink" title="1、修改元素样式"></a>1、修改元素样式</h4><p><code>var closeBtn = document.getElementById(&quot;closeBtn&quot;);</code><br><strong>可以直接对closeBtn对元素样式进行操作</strong><br><code>closeBtn.parentNode.style.display = &quot;none&quot;; //关闭父节点的显示</code><br>区别：<br><code>closeBtn.parentNode.style.visibility = &quot;hidden&quot;; //隐藏父节点，但是位置还占着</code></p><h4 id="2、读取元素样式"><a href="#2、读取元素样式" class="headerlink" title="2、读取元素样式"></a>2、读取元素样式</h4><p>读样式方法，通过<code>document.defaultView.getComputedStyle()</code>来读取样式。</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs maxima"><span class="hljs-built_in">var</span> ad = document.getElementById(<span class="hljs-string">&quot;ad&quot;</span>);<br><span class="hljs-built_in">var</span> currentStyle = document.defaultView.getComputedStyle(ad);<br>consle.<span class="hljs-built_in">log</span>(currentStyle.<span class="hljs-built_in">width</span>)<br>consle.<span class="hljs-built_in">log</span>(currentStyle.<span class="hljs-built_in">height</span>)<br></code></pre></td></tr></table></figure><p>流氓广告– 无法关闭，点击后广告变大</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span>&gt;</span><br>*&#123;<br>margin: 0;<br>padding: 0;<br>&#125;<br><span class="css"><span class="hljs-selector-id">#ad</span>&#123;</span><br><span class="css"><span class="hljs-selector-tag">background-color</span><span class="hljs-selector-pseudo">:blueviolet</span>;</span><br>float: right;<br>right: 0;<br>position: fixed;<br>width: 200px;<br>height: 200px;<br>&#125;<br><span class="css"><span class="hljs-selector-id">#ad</span> <span class="hljs-selector-tag">button</span>&#123;</span><br>float: right;<br>&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;ad&quot;</span>&gt;</span><br>这里是广告<br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;closeBtn&quot;</span>&gt;</span>关闭<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript"><span class="hljs-keyword">var</span> closeBtn = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;closeBtn&quot;</span>);</span><br><span class="javascript">closeBtn.addEventListener(<span class="hljs-string">&quot;click&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-comment">//拿到元素的style属性只能进行修改,不能读取</span></span><br><span class="javascript"><span class="hljs-comment">//closeBtn.parentNode.style.display = &quot;none&quot;; //点击关闭按钮关闭广告</span></span><br><span class="javascript"><span class="hljs-comment">//closeBtn.parentNode.style.visibility = &quot;hidden&quot;; //隐藏div，但是位置还占着</span></span><br><br><span class="javascript"><span class="hljs-comment">//读样式方法，通过得到的currentStyle来读取样式。</span></span><br><span class="javascript"><span class="hljs-keyword">var</span> ad = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;ad&quot;</span>);</span><br><span class="javascript"><span class="hljs-keyword">var</span> currentStyle = <span class="hljs-built_in">document</span>.defaultView.getComputedStyle(ad);</span><br><span class="javascript"><span class="hljs-comment">//点击广告变大</span></span><br><span class="javascript">ad.style.width = (<span class="hljs-built_in">parseInt</span>(currentStyle.width) + <span class="hljs-number">20</span>) + <span class="hljs-string">&quot;px&quot;</span>;</span><br><span class="javascript">ad.style.height = (<span class="hljs-built_in">parseInt</span>(currentStyle.height) + <span class="hljs-number">20</span>) + <span class="hljs-string">&quot;px&quot;</span>;</span><br>&#125;);<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="3、删除"><a href="#3、删除" class="headerlink" title="3、删除"></a>3、删除</h4><p><strong>必须父元素操作，才能删除子元素</strong><br><code>ul.removeChild(li);  //删除子标签li</code></p><h4 id="4、添加"><a href="#4、添加" class="headerlink" title="4、添加"></a>4、添加</h4><p><strong>必须是父元素才能对子元素进行添加操作</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">var div = document.create<span class="hljs-constructor">Element(<span class="hljs-string">&quot;div&quot;</span>)</span>; <span class="hljs-comment">// 创建元素,然后对创建的元素进行操作</span><br>divFather.append<span class="hljs-constructor">Child(<span class="hljs-params">div</span>)</span>;    <span class="hljs-comment">//添加子标签(加在最后)</span><br>divFather.insert<span class="hljs-constructor">Before(<span class="hljs-params">div</span>,位置)</span>;   <span class="hljs-comment">//添加子标签（指定位置）</span><br></code></pre></td></tr></table></figure><p>练习</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span>&gt;</span><br>*&#123;<br>margin: 0;<br>padding: 0;<br>&#125;<br><span class="css"><span class="hljs-selector-id">#main</span>&#123;</span><br>width: 800px;<br>height: 400px;<br>margin: 10px auto;<br><span class="css"><span class="hljs-selector-tag">border</span><span class="hljs-selector-pseudo">:black</span> <span class="hljs-selector-tag">solid</span>;</span><br>overflow: hidden;<br>&#125;<br><span class="css"><span class="hljs-selector-id">#button1</span>&#123;</span><br>width: 50px;<br>height: 30px;<br>font-size: 18px;<br>margin-left: 300px;<br>&#125;<br><span class="css"><span class="hljs-selector-id">#button2</span>&#123;</span><br>width: 50px;<br>height: 30px;<br>font-size: 18px;<br><span class="css"><span class="hljs-selector-tag">margin-left</span><span class="hljs-selector-pseudo">:500px</span>;</span><br>&#125;<br><span class="css"><span class="hljs-selector-id">#main</span> <span class="hljs-selector-tag">div</span>&#123;</span><br>width: 80px;<br><span class="css"><span class="hljs-selector-tag">height</span><span class="hljs-selector-pseudo">:80px</span>;</span><br><span class="css"><span class="hljs-selector-tag">float</span><span class="hljs-selector-pseudo">:left</span>;</span><br>&#125;<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;main&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;button1&quot;</span>&gt;</span>添加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;button2&quot;</span>&gt;</span>闪烁<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript"><span class="hljs-keyword">var</span> main = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;main&quot;</span>);</span><br><span class="javascript"><span class="hljs-keyword">var</span> button1 = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;button1&quot;</span>);</span><br><span class="javascript"><span class="hljs-keyword">var</span> button2 = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;button2&quot;</span>);</span><br><span class="javascript"><span class="hljs-keyword">var</span> flag = <span class="hljs-literal">true</span>;</span><br><span class="javascript"><span class="hljs-keyword">var</span> glint1 = <span class="hljs-number">0</span>;</span><br><span class="javascript">button1.addEventListener(<span class="hljs-string">&quot;click&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-keyword">var</span> div1 = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&quot;div&quot;</span>);</span><br>div1.style.backgroundColor = randomColor();<br>main.insertBefore(div1,main.firstChild);<br>&#125;)<br><br><span class="javascript">button2.addEventListener(<span class="hljs-string">&quot;click&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br>if (flag)&#123;<br><span class="javascript">glint1 = <span class="hljs-built_in">setInterval</span>(glint,<span class="hljs-number">200</span>);</span><br><span class="javascript">&#125;<span class="hljs-keyword">else</span>&#123;</span><br><span class="javascript"><span class="hljs-built_in">clearInterval</span>(glint1);</span><br>&#125;<br><span class="javascript">button2.innerHTML = flag?<span class="hljs-string">&quot;暂停&quot;</span>:<span class="hljs-string">&quot;闪烁&quot;</span>;</span><br>flag = !flag;<br>&#125;);<br><br><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">glint</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-keyword">var</span> divAll = <span class="hljs-built_in">document</span>.querySelectorAll(<span class="hljs-string">&quot;#main div&quot;</span>);</span><br><span class="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i&lt;divAll.length; i+=<span class="hljs-number">1</span>)&#123;</span><br>divAll[i].style.backgroundColor = randomColor();<br>&#125;;<br>&#125;<br><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">randomColor</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-keyword">var</span> red = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">Math</span>.random()*<span class="hljs-number">256</span>);</span><br><span class="javascript"><span class="hljs-keyword">var</span> green = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">Math</span>.random()*<span class="hljs-number">256</span>);</span><br><span class="javascript"><span class="hljs-keyword">var</span> blue = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">Math</span>.random()*<span class="hljs-number">256</span>);</span><br><span class="javascript"><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;rgb(&quot;</span> + red + <span class="hljs-string">&quot;, &quot;</span> + green + <span class="hljs-string">&quot;, &quot;</span> + blue + <span class="hljs-string">&quot;)&quot;</span>;</span><br>&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>效果：<br><img src="https://upload-images.jianshu.io/upload_images/13692175-2b40b5307ea1def2.gif?imageMogr2/auto-orient/strip"></p><hr><p><strong>练习</strong><br>1、鼠标按住拖动效果</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span>&gt;</span><br><span class="css"><span class="hljs-selector-id">#div1</span>&#123;</span><br>width: 100px;<br>height: 100px;<br><span class="css"><span class="hljs-selector-tag">background-color</span>: <span class="hljs-selector-id">#5F9EA0</span>;</span><br>position: absolute;<br>left: 0px;<br>top: 0px;<br>&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;div1&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript"><span class="hljs-keyword">var</span> div1 = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;div1&quot;</span>);</span><br><span class="javascript"><span class="hljs-keyword">var</span> originalX = <span class="hljs-number">0</span>;</span><br><span class="javascript"><span class="hljs-keyword">var</span> originalY = <span class="hljs-number">0</span>;</span><br><span class="javascript"><span class="hljs-keyword">var</span> flag = <span class="hljs-literal">false</span>;</span><br><br><span class="javascript">div1.addEventListener(<span class="hljs-string">&quot;mousedown&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>)</span>&#123;</span><br><span class="javascript">originalX = evt.clientX - div1.offsetLeft;   <span class="hljs-comment">//记录事件发生的鼠标到left的距离</span></span><br>originalY = evt.clientY - div1.offsetTop;<br><span class="javascript">flag = <span class="hljs-literal">true</span>;</span><br>&#125;);<br><br><br><span class="javascript">div1.addEventListener(<span class="hljs-string">&quot;mousemove&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>)</span>&#123;</span><br>if (flag)&#123;<br><span class="javascript">div1.style.left = (evt.clientX - originalX)+<span class="hljs-string">&quot;px&quot;</span>;</span><br><span class="javascript">div1.style.top = (evt.clientY - originalY)+<span class="hljs-string">&quot;px&quot;</span>;</span><br>&#125;<br>&#125;);<br><br><br><span class="javascript">div1.addEventListener(<span class="hljs-string">&quot;mouseup&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>)</span>&#123;</span><br><span class="javascript">flag = <span class="hljs-literal">false</span>;</span><br>&#125;);<br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>效果：<br><img src="https://upload-images.jianshu.io/upload_images/13692175-dd84fe2eeccd1c48.gif?imageMogr2/auto-orient/strip"></p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JS中的事件处理</title>
    <link href="/Myblog/2018/09/26/JS%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86/"/>
    <url>/Myblog/2018/09/26/JS%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h3 id="一、JavaScript中的事件处理"><a href="#一、JavaScript中的事件处理" class="headerlink" title="一、JavaScript中的事件处理"></a>一、JavaScript中的事件处理</h3><h5 id="1、在标签上使用onXXX属性来进行事件绑定（不推荐使用）"><a href="#1、在标签上使用onXXX属性来进行事件绑定（不推荐使用）" class="headerlink" title="1、在标签上使用onXXX属性来进行事件绑定（不推荐使用）"></a>1、在标签上使用onXXX属性来进行事件绑定（不推荐使用）</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;sayHello()&quot;</span>&gt;</span>按钮1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sayHello</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">alert(<span class="hljs-string">&quot;Hello!&quot;</span>);</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2、通过代码获取标签绑定onXXX属性（不推荐使用）"><a href="#2、通过代码获取标签绑定onXXX属性（不推荐使用）" class="headerlink" title="2、通过代码获取标签绑定onXXX属性（不推荐使用）"></a>2、通过代码获取标签绑定onXXX属性（不推荐使用）</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;button1&quot;</span>&gt;</span>按钮1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript"><span class="hljs-keyword">var</span> button1 = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;button1&quot;</span>);</span><br><span class="javascript">button1.textContent = <span class="hljs-string">&quot;点我呀！&quot;</span>;</span><br>button1.onclick = sayHello;<br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sayHello</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">alert(<span class="hljs-string">&quot;Hello!&quot;</span>);</span><br>&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="3、通过diamante获取标签然后使用addEventListener绑定事件（推荐）"><a href="#3、通过diamante获取标签然后使用addEventListener绑定事件（推荐）" class="headerlink" title="3、通过diamante获取标签然后使用addEventListener绑定事件（推荐）"></a>3、通过diamante获取标签然后使用addEventListener绑定事件（推荐）</h5><p>方法一：内部JS</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;button1&quot;</span>&gt;</span>按钮1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript"><span class="hljs-keyword">var</span> button1 = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;button1&quot;</span>);</span><br><span class="javascript"><span class="hljs-comment">//判断因为IE浏览器低版本不兼容</span></span><br>if (button1.addEventListener)&#123;<br><span class="javascript">button1.textContent = <span class="hljs-string">&quot;点我呀！&quot;</span>;</span><br><span class="javascript">button1.addEventListener(<span class="hljs-string">&quot;click&quot;</span>,sayHello);</span><br><span class="javascript">button1.addEventListener(<span class="hljs-string">&quot;click&quot;</span>,sayGoodbye);</span><br><span class="javascript">button1.addEventListener(<span class="hljs-string">&quot;click&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">button1.removeEventListener(<span class="hljs-string">&quot;click&quot;</span>,sayHello); <span class="hljs-comment">//移除事件监听</span></span><br><span class="javascript">button1.removeEventListener(<span class="hljs-string">&quot;click&quot;</span>,sayGoodbye);</span><br>&#125;)<br><span class="javascript">&#125;<span class="hljs-keyword">else</span>&#123; </span><br><span class="javascript"><span class="hljs-comment">//低版本IE浏览器使用的代码</span></span><br><span class="javascript">button1.attachEvent(<span class="hljs-string">&quot;onclick&quot;</span>,sayHello);</span><br><span class="javascript">button1.attachEvent(<span class="hljs-string">&quot;onclick&quot;</span>,sayGoodbye);</span><br><span class="javascript">button1.attachEvent(<span class="hljs-string">&quot;click&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">button1.detachEvent(<span class="hljs-string">&quot;onclick&quot;</span>,sayHello); <span class="hljs-comment">//移除事件监听</span></span><br><span class="javascript">button1.detachEvent(<span class="hljs-string">&quot;onclick&quot;</span>,sayGoodbye);</span><br>&#125;)<br>&#125;<br><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sayHello</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">alert(<span class="hljs-string">&quot;Hello!&quot;</span>);</span><br>&#125;<br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sayGoodbye</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">alert(<span class="hljs-string">&quot;Goodbye！&quot;</span>)</span><br>&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>````<br>方法二：外部封装JS函数<br></code></pre></td></tr></table></figure><!DOCTYPE html><html>    <head>        <meta charset="utf-8" />        <title></title>    </head>    <body>        <button id="button1">按钮1</button><pre><code>    &lt;script src=&quot;js/new_file.js&quot;&gt;&lt;/script&gt;    &lt;script type=&quot;text/javascript&quot;&gt;        var button1 = document.getElementById(&quot;button1&quot;);        // 绑定事件的回调函数（callback function）        // 你知道事件发生的时候，但是不知道事件什么时候发生，只是进行绑定。        bind(button1, &quot;click&quot;, sayHello);        bind(button1, &quot;click&quot;, sayGoodbye);        bind(button1, &quot;click&quot;, function()&#123;            onbind(button1, &quot;click&quot;, sayHello);        &#125;)        function sayHello()&#123;            alert(&quot;Hello!&quot;);        &#125;        function sayGoodbye()&#123;            alert(&quot;Goodbye！&quot;)        &#125;    &lt;/script&gt;&lt;/body&gt;</code></pre></html><p>//js文件<br>function bind(elem, event, fn){<br>    if (elem.addEventListener){<br>        elem.addEventListener(event, fn);<br>    }else{<br>        elem.attachEvent(“on” + event, fn);<br>    }<br>}</p><p>function onbind(elem, event, fn){<br>    if (elem.removeEventListener){<br>        elem.removeEventListener(event, fn);<br>    }else{<br>        elem.detachShader(“on” + event, fn);<br>    }<br>}</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><br>*<span class="hljs-strong">*在事件回调函数中获取事件源（易错点）*</span><span class="hljs-strong">*</span><br></code></pre></td></tr></table></figure><!DOCTYPE html><html>    <head>        <meta charset="UTF-8">        <title></title>    </head>    <body>        <div id="buttons">            <button>button1</button>            <button>button2</button>            <button>button3</button>            <button>button4</button>            <button>button5</button>        </div><pre><code>    &lt;script src=&quot;js/javascript.js&quot;&gt;&lt;/script&gt;    &lt;script type=&quot;text/javascript&quot;&gt;        var buttons = document.querySelectorAll(&quot;#buttons&gt;button&quot;);        for (var i = 0; i&lt;buttons.length; i+=1)&#123;        //如果希望在事件回调函数中获得事件源        //应该通过事件对象的target属性去获取事件源                    bind(buttons[i], &quot;click&quot;, function(evt)&#123;                   //取事件源不能用下标去获取                evt = evt || window.event; //兼容ie代码                evt.target.textContent = &quot;欧耶&quot;;            &#125;)        &#125;    &lt;/script&gt;&lt;/body&gt;</code></pre></html><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs clean"><br>### 二、事件回调函数和事件对象<br><br>绑定事件监听器的函数都需要传入事件的回调函数，程序员因为事件发生的时候要做什么，但是不知道什么时候发生，所以传入一个函数在将来发生事件的时候，由事件调用，这种就叫回调函数。<br><br>回调函数的第一个参数代表事件对象（封装了和事件相关的所有信息），对于低版本的IE，可以通过window.event来获取事件对象。<br><br>**事件对象的属性和方法：**<br>**<span class="hljs-number">1</span>、target / srcElement(IE) - 事件源（引发事件的标签）**<br><br>**<span class="hljs-number">2</span>、阻止事件的默认行为，比如：a标签  --&gt; preventDefault()**<br></code></pre></td></tr></table></figure><pre><code>                if (evt.preventDefault)&#123;                    evt.preventDefault();                &#125;else&#123;                    evt.returnValue = false; //兼容ie                &#125;</code></pre><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><br>**<span class="hljs-number">3</span>、事件的捕获和冒泡**<br>**事件冒泡   内 --&gt; 外（子代--&gt;父代）（默认 <span class="hljs-literal">false</span>）<br>事件捕获   外 --&gt; 内 （<span class="hljs-literal">true</span>）**<br><br>停止事件传播（捕获和冒泡） -- `stopPropagation()`<br>IE浏览器只有冒泡 -- `cancelBubble = <span class="hljs-literal">true</span>`<br><br>**猜数字游戏（网页版）**<br></code></pre></td></tr></table></figure><!DOCTYPE html><html>    <head>        <meta charset="UTF-8">        <title></title><pre><code>&lt;/head&gt;&lt;body&gt;    &lt;input type=&quot;number&quot; id=&quot;input&quot; placeholder=&quot;猜0~10的数字&quot;/&gt;    &lt;input type=&quot;button&quot; id=&quot;confirm&quot; value=&quot;确定&quot;&gt;        &lt;script type=&quot;text/javascript&quot;&gt;        var count = 0;        var num = parseInt(Math.random()*11);        var guess = document.getElementById(&quot;input&quot;);        var confirm = document.getElementById(&quot;confirm&quot;);        confirm.addEventListener(&quot;click&quot;, guess_number);        // 判断回车        guess.addEventListener(&quot;keydown&quot;,function(evt)&#123;            evt = evt || window.event;            if (evt.keyCode == 13 || evt.which == 13)&#123;                guess_number();            &#125;        &#125;)        function guess_number()&#123;            var thyAnswer = parseInt(guess.value);            count += 1;            if (thyAnswer &gt; num)&#123;                alert(&quot;大了大了~&quot;);            &#125;else if(thyAnswer &lt; num)&#123;                alert(&quot;小了小了~&quot;);            &#125;else if(thyAnswer == num)&#123;                alert(&quot;恭喜你猜对了，一共猜了&quot;+count+&quot;次！&quot;);                confirm.disabled = true; //禁止按钮                guess.disabled = true;  //禁止输入框            &#125;            guess.value = &quot;&quot;;  //清除文本框内容            guess.focus();  //获得焦点        &#125;    &lt;/script&gt;&lt;/body&gt;</code></pre></html><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">效果：<br>![](https:<span class="hljs-regexp">//u</span>pload-images.jianshu.io<span class="hljs-regexp">/upload_images/</span><span class="hljs-number">13692175</span>-<span class="hljs-number">79</span>cbfa53d85b8dd7.gif?imageMogr2<span class="hljs-regexp">/auto-orient/</span>strip)<br><br><span class="hljs-comment">### 三、JS中创建对象常用方法</span><br><span class="hljs-number">1</span>、<br>![](https:<span class="hljs-regexp">//u</span>pload-images.jianshu.io<span class="hljs-regexp">/upload_images/</span><span class="hljs-number">13692175</span>-<span class="hljs-number">6</span>f215fff8a7c4b3e.png?imageMogr2<span class="hljs-regexp">/auto-orient/</span>strip%<span class="hljs-number">7</span>CimageView2<span class="hljs-regexp">/2/</span>w/<span class="hljs-number">1240</span>)<br><br><span class="hljs-number">2</span>、<br>![](https:<span class="hljs-regexp">//u</span>pload-images.jianshu.io<span class="hljs-regexp">/upload_images/</span><span class="hljs-number">13692175</span>-<span class="hljs-number">4</span>cf4b1ab7a84ffe4.png?imageMogr2<span class="hljs-regexp">/auto-orient/</span>strip%<span class="hljs-number">7</span>CimageView2<span class="hljs-regexp">/2/</span>w/<span class="hljs-number">1240</span>)<br><br><br>----<br>**练习**<br><br>一.图片<span class="hljs-number">3</span>s自动切换，鼠标事件触发停止切换。<br></code></pre></td></tr></table></figure><!DOCTYPE html><html>    <head>        <meta charset="UTF-8">        <title></title>        <style type="text/css">            #span{                color: #008000;                text-align: center;                font-size: 20px;            }            #pic{                margin-left: 120px;            }        </style>    </head>    <body>        <p id="span">每3s切换一次图片,鼠标放上停止切换，离开时继续切换</p><br/>        <img src="img/slide-1.jpg" id="pic"/><pre><code>    &lt;script type=&quot;text/javascript&quot;&gt;        var slipeImg = document.getElementById(&quot;pic&quot;);        var timer = setInterval(slipe,3000);        var count = 1;        slipeImg.addEventListener(&quot;mouseover&quot;,overSlipe);        slipeImg.addEventListener(&quot;mouseout&quot;,outSlipe);        function overSlipe()&#123;            clearInterval(timer);        &#125;        function outSlipe()&#123;            timer = setInterval(slipe,3000);        &#125;        function slipe()&#123;            if (count == 4)&#123;                count = 1                slipeImg.src=&quot;img/slide-&quot; + count + &quot;.jpg&quot;;            &#125;else&#123;                count += 1;                slipeImg.src=&quot;img/slide-&quot; + count + &quot;.jpg&quot;;            &#125;        &#125;    &lt;/script&gt;&lt;/body&gt;</code></pre></html><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">效果：<br>![](https:<span class="hljs-regexp">//u</span>pload-images.jianshu.io<span class="hljs-regexp">/upload_images/</span><span class="hljs-number">13692175</span>-<span class="hljs-number">0</span>a06e5337ed46f3b.gif?imageMogr2<span class="hljs-regexp">/auto-orient/</span>strip)<br><br>二、实现上题的功能的前提下，点击小图标可以切换到对应的图片<br></code></pre></td></tr></table></figure><!DOCTYPE html><html>    <head>        <meta charset="UTF-8">        <title></title>        <style type="text/css">            #pic{                margin-left: 450px;            }            #pic_small{                margin-left: 460px;                }        </style>    </head>    <body><pre><code>    &lt;img src=&quot;img/pic1.jpg&quot; id=&quot;pic&quot;/&gt;    &lt;div id=&quot;pic_small&quot;&gt;        &lt;img src=&quot;img/thumb-1.jpg&quot; id=&quot;small1&quot;/&gt;        &lt;img src=&quot;img/thumb-2.jpg&quot; id=&quot;small2&quot;/&gt;        &lt;img src=&quot;img/thumb-3.jpg&quot; id=&quot;small3&quot;/&gt;    &lt;/div&gt;    &lt;script type=&quot;text/javascript&quot;&gt;        var slipeImg = document.getElementById(&quot;pic&quot;);        var timer = setInterval(slipe,3000);        var count = 1;        slipeImg.addEventListener(&quot;mouseover&quot;,overSlipe);        slipeImg.addEventListener(&quot;mouseout&quot;,outSlipe);        var thumbs = document.querySelectorAll(&quot;#pic_small&gt;img&quot;);        thumbs[0].addEventListener(&quot;click&quot;,fun1);        thumbs[1].addEventListener(&quot;click&quot;,fun2);        thumbs[2].addEventListener(&quot;click&quot;,fun3);        function fun1()&#123;            slipeImg.src=&quot;img/pic1.jpg&quot;;        &#125;        function fun2()&#123;            slipeImg.src=&quot;img/pic2.jpg&quot;;        &#125;            function fun3()&#123;            slipeImg.src=&quot;img/pic3.jpg&quot;;        &#125;        function overSlipe()&#123;            clearInterval(timer);        &#125;        function outSlipe()&#123;            timer = setInterval(slipe,1000);        &#125;        function slipe()&#123;            if (count == 3)&#123;                count = 1                slipeImg.src=&quot;img/pic&quot; + count + &quot;.jpg&quot;;            &#125;else&#123;                count += 1;                slipeImg.src=&quot;img/pic&quot; + count + &quot;.jpg&quot;;            &#125;        &#125;    &lt;/script&gt;&lt;/body&gt;</code></pre></html><pre><code>效果：![](https://upload-images.jianshu.io/upload_images/13692175-73334813bdef8410.gif?imageMogr2/auto-orient/strip)</code></pre>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Window对象</title>
    <link href="/Myblog/2018/09/25/Window%E5%AF%B9%E8%B1%A1/"/>
    <url>/Myblog/2018/09/25/Window%E5%AF%B9%E8%B1%A1/</url>
    
    <content type="html"><![CDATA[<p><strong>随机数产生方式</strong><br><code>parseInt(Math.random()*100 + 1)//parseInt取整  Math.random()取0-1(不包括1)的随机数</code></p><p><strong>window对象</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">//window可以不写，默认为window对象。</span><br><span class="hljs-selector-tag">alert</span>() / <span class="hljs-selector-tag">prompt</span>() / <span class="hljs-selector-tag">confirm</span>() / <span class="hljs-selector-tag">close</span>()<br>警告框 / 输入框 / 确认框 / 关闭<br><span class="hljs-selector-tag">window</span><span class="hljs-selector-class">.setInterval</span>(delayGo,<span class="hljs-number">5000</span>);<span class="hljs-comment">//setInterval周期执行，时间单位毫秒。</span><br><span class="hljs-selector-tag">window</span><span class="hljs-selector-class">.setTimeout</span>(delayGo,<span class="hljs-number">1000</span>); <span class="hljs-comment">//只调用一次，但是一般用于函数递归，setTimeout更加灵活。</span><br><span class="hljs-selector-tag">clearInterval</span>()  /  <span class="hljs-selector-tag">clearTimeout</span>() <span class="hljs-comment">//清除计时器</span><br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">window.document - 文档对象<br>window.location - 浏览器地址栏<br><span class="hljs-regexp">//</span>location.hostname 返回 web 主机的域名<br><span class="hljs-regexp">//</span>location.pathname 返回当前页面的路径和文件名<br><span class="hljs-regexp">//</span>location.port 返回 web 主机的端口 （<span class="hljs-number">80</span> 或 <span class="hljs-number">443</span>）<br><span class="hljs-regexp">//</span>location.protocol 返回所使用的 web 协议（http:<span class="hljs-regexp">//</span> 或 https:<span class="hljs-regexp">//</span>）<br>window.history - 历史记录<br><span class="hljs-regexp">//</span>history.back() - 与在浏览器点击后退按钮相同<br><span class="hljs-regexp">//</span>history.forward() - 与在浏览器中点击向前按钮相同<br><span class="hljs-regexp">//</span>history.go(n) - 前进或者后退n步<br>window.navigator - 浏览器<br><span class="hljs-regexp">//</span>navigator.appCodeName - 浏览器代号<br><span class="hljs-regexp">//</span>navigator.appName - 浏览器名称<br><span class="hljs-regexp">//</span> navigator.appVersion - 浏览器版本<br>window.screen - 屏幕<br><span class="hljs-regexp">//</span>screen.availWidth - 可用的屏幕宽度<br><span class="hljs-regexp">//</span>screen.availHeight - 可用的屏幕高度<br><span class="hljs-regexp">//</span>screen.colorDepth - 色深<br><span class="hljs-regexp">//</span>screen.pixelDepth - 分辨率<br></code></pre></td></tr></table></figure><p><strong>拿到html元素(document对象)</strong></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">&quot;#welcome&quot;</span>)<span class="hljs-comment">//通过选择器拿元素</span><br><span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelectorAll</span>() <span class="hljs-comment">//选择器拿到多个元素，返回列表</span><br><span class="hljs-built_in">document</span>.getElementById()<span class="hljs-comment">//根据id拿元素</span><br><span class="hljs-built_in">document</span>.getElementsByClassName()<span class="hljs-comment">//根据类名拿元素，返回为列表</span><br><span class="hljs-built_in">document</span>.getElementsByTagName()<span class="hljs-comment">//根据标签名拿元素，返回为列表</span><br></code></pre></td></tr></table></figure><p><strong>写入到html元素</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">//div -- 特定标签对应的变量</span><br><span class="hljs-selector-tag">div</span><span class="hljs-selector-class">.innerHTML</span> <span class="hljs-comment">//能解释 html 代码</span><br><span class="hljs-selector-tag">div</span><span class="hljs-selector-class">.textContent</span> <span class="hljs-comment">//里面只能放文本，代码原样输入</span><br></code></pre></td></tr></table></figure><p><strong>其他知识</strong></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Math.<span class="hljs-built_in">random</span>（）随机产生<span class="hljs-number">0</span>~<span class="hljs-number">1</span>的随机数（前闭后开）<br><span class="hljs-built_in">parseInt</span>（）取整<br><span class="hljs-built_in">parseFloat</span>（）取小数<br></code></pre></td></tr></table></figure><p>使用匿名函数并且调用它的方法<br><img src="https://upload-images.jianshu.io/upload_images/13692175-f0428746b42705ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><h4 id="一、网页上显示当前时间"><a href="#一、网页上显示当前时间" class="headerlink" title="一、网页上显示当前时间"></a>一、网页上显示当前时间</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript"><span class="hljs-keyword">var</span> days = [<span class="hljs-string">&quot;日&quot;</span>,<span class="hljs-string">&quot;一&quot;</span>,<span class="hljs-string">&quot;二&quot;</span>,<span class="hljs-string">&quot;三&quot;</span>,<span class="hljs-string">&quot;四&quot;</span>,<span class="hljs-string">&quot;五&quot;</span>,<span class="hljs-string">&quot;六&quot;</span>];</span><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showTime</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();</span><br><span class="javascript"><span class="hljs-keyword">var</span> year = now.getFullYear();</span><br><span class="javascript"><span class="hljs-keyword">var</span> month = now.getMonth() + <span class="hljs-number">1</span>;</span><br><span class="javascript"><span class="hljs-keyword">var</span> date = now.getDate();</span><br><span class="javascript"><span class="hljs-keyword">var</span> hour = now.getHours();</span><br><span class="javascript"><span class="hljs-keyword">var</span> minute = now.getMinutes();</span><br><span class="javascript"><span class="hljs-keyword">var</span> second = now.getSeconds();</span><br><span class="javascript"><span class="hljs-keyword">var</span> day = now.getDay();</span><br><span class="javascript"><span class="hljs-keyword">var</span> div = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;time&quot;</span>);  <span class="hljs-comment">//得到id为指定的div标签</span></span><br><span class="javascript">div.innerHTML = year + <span class="hljs-string">&quot;年&quot;</span> + </span><br><span class="javascript">(month &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">&quot;0&quot;</span>:<span class="hljs-string">&quot;&quot;</span>) + month + <span class="hljs-string">&quot;月&quot;</span> + </span><br><span class="javascript">(date &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">&quot;0&quot;</span>:<span class="hljs-string">&quot;&quot;</span>)+ date + <span class="hljs-string">&quot;日&amp;nbsp;&quot;</span> +</span><br><span class="javascript">(hour &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">&quot;0&quot;</span>:<span class="hljs-string">&quot;&quot;</span>)+ hour + <span class="hljs-string">&quot;:&quot;</span> +</span><br><span class="javascript">(second &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">&quot;0&quot;</span>:<span class="hljs-string">&quot;&quot;</span>)+ second + <span class="hljs-string">&quot;&amp;nbsp;星期&quot;</span> + days[day];</span><br><span class="javascript"><span class="hljs-comment">//div.innerHTML 标签里面的html代码</span></span><br><span class="javascript"><span class="hljs-comment">//div.textContent 里面只能放文本，代码原样输入</span></span><br>&#125;<br><span class="javascript">showTime()  <span class="hljs-comment">//网页开始没有显示时间，先执行一遍。</span></span><br><span class="javascript"><span class="hljs-built_in">window</span>.setInterval(showTime,<span class="hljs-number">1000</span>) <span class="hljs-comment">//设置时间周期，每1000毫秒执行一次</span></span><br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>效果：<br><img src="https://upload-images.jianshu.io/upload_images/13692175-d63ea9852c0b3870.gif?imageMogr2/auto-orient/strip"></p><h4 id="二、网页跑马灯"><a href="#二、网页跑马灯" class="headerlink" title="二、网页跑马灯"></a>二、网页跑马灯</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml">        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;welcome&quot;</span>&gt;</span>欢迎来到Deathfeeling的博客。<span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript">            <span class="hljs-keyword">var</span> str1 = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;welcome&quot;</span>)</span><br><span class="javascript"><span class="hljs-comment">//          document.querySelector(&quot;#welcome&quot;)//通过选择器拿元素</span></span><br><span class="javascript"><span class="hljs-comment">//          document.querySelectorAll() //选择器拿到多个元素，返回列表</span></span><br><span class="javascript"><span class="hljs-comment">//          document.getElementById()//根据id拿元素</span></span><br><span class="javascript"><span class="hljs-comment">//          document.getElementsByClassName()//根据类名拿元素，返回为列表</span></span><br><span class="javascript"><span class="hljs-comment">//          document.getElementsByTagName()//根据标签名拿元素，返回为列表</span></span><br><span class="javascript">            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showStr</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript">                <span class="hljs-keyword">var</span> str = str1.textContent;</span><br><span class="javascript">                str = str.substring(<span class="hljs-number">1</span>) + str.charAt(<span class="hljs-number">0</span>);<span class="hljs-comment">//substring-取字串  charAt-取字符</span></span><br>                str1.innerHTML = str;<br>            &#125;<br>            showStr();<br><span class="javascript">            <span class="hljs-built_in">window</span>.setInterval(showStr,<span class="hljs-number">800</span>);</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>效果：<br><img src="https://stellae.gitee.io/myblog/images/images/paomadeng.gif"></p><h4 id="三、网页延时跳转"><a href="#三、网页延时跳转" class="headerlink" title="三、网页延时跳转"></a>三、网页延时跳转</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;counter&quot;</span> &gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>秒以后自动跳转到百度……<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript"><span class="hljs-keyword">var</span> countdown = <span class="hljs-number">5</span>;</span><br><span class="javascript"><span class="hljs-keyword">var</span> span = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;counter&quot;</span>);</span><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delayGo</span>(<span class="hljs-params"></span>)</span>&#123;</span><br>countdown -= 1;<br>if (countdown == 0)&#123;<br><span class="javascript">location.href = <span class="hljs-string">&quot;http://www.baidu.com&quot;</span>;</span><br><span class="javascript">&#125;<span class="hljs-keyword">else</span>&#123;</span><br>span.textContent = countdown;<br><span class="javascript"><span class="hljs-built_in">setTimeout</span>(delayGo,<span class="hljs-number">1000</span>); <span class="hljs-comment">//只调用一次，所以重新调用（setTimeout更加灵活）</span></span><br>&#125;<br><br>&#125;<br><span class="javascript"><span class="hljs-built_in">window</span>.setTimeout(delayGo,<span class="hljs-number">1000</span>); <span class="hljs-comment">//setTimeout只执行一次</span></span><br><span class="javascript"><span class="hljs-comment">//window.setInterval(delayGo,5000);//setInterval周期执行</span></span><br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>效果：<br><img src="https://upload-images.jianshu.io/upload_images/13692175-c232cd3cb20fdfd5.gif?imageMogr2/auto-orient/strip"></p><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a><strong>练习</strong></h2><p>制作一个程序，随机抽取班级名单，已经抽取到的同学不会继续会抽取</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span>&gt;</span><br><span class="css"><span class="hljs-selector-id">#name</span>&#123;</span><br>text-align: center;<br>height: 250px;<br>width: 600px;<br>line-height: 250px;<br>color: darkgoldenrod;<br>font-size: 90px;<br><span class="css"><span class="hljs-selector-tag">background-color</span>: <span class="hljs-selector-id">#4169E1</span>;</span><br>margin: 170px auto 20px auto;<br>&#125;<br><span class="css"><span class="hljs-selector-id">#begin</span>&#123;</span><br>height: 80px;<br>width: 170px;<br><span class="css"><span class="hljs-selector-tag">color</span><span class="hljs-selector-pseudo">:crimson</span>;</span><br><span class="css"><span class="hljs-selector-tag">background-color</span><span class="hljs-selector-pseudo">:darkgrey</span>;</span><br>font-size: 50px;<br>display: block;<br>margin: 0px auto;<br>&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;name&quot;</span>&gt;</span>点击&quot;开始&quot;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;begin()&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;begin&quot;</span>&gt;</span>开始<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript"><span class="hljs-keyword">var</span> namelist = [<span class="hljs-string">&quot;曹晓芹&quot;</span>,<span class="hljs-string">&quot;吕耐芯&quot;</span>,<span class="hljs-string">&quot;魏世强&quot;</span>,<span class="hljs-string">&quot;樊振霖&quot;</span>,<span class="hljs-string">&quot;何羽&quot;</span>,<span class="hljs-string">&quot;龙汉&quot;</span>,<span class="hljs-string">&quot;吴亮&quot;</span>,<span class="hljs-string">&quot;邓森中&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;冉钊&quot;</span>,<span class="hljs-string">&quot;曾德浴&quot;</span>,<span class="hljs-string">&quot;李萌&quot;</span>,<span class="hljs-string">&quot;江秀成&quot;</span>,<span class="hljs-string">&quot;李祥&quot;</span>,<span class="hljs-string">&quot;王磊&quot;</span>,<span class="hljs-string">&quot;刘彦材&quot;</span>,<span class="hljs-string">&quot;陈虹州&quot;</span>,<span class="hljs-string">&quot;唐宏进&quot;</span>,<span class="hljs-string">&quot;王建平&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;李俊橙&quot;</span>,<span class="hljs-string">&quot;于梦娇&quot;</span>,<span class="hljs-string">&quot;王龙&quot;</span>,<span class="hljs-string">&quot;刘诗意&quot;</span>,<span class="hljs-string">&quot;殷安好&quot;</span>,<span class="hljs-string">&quot;刘欢&quot;</span>,<span class="hljs-string">&quot;任思宇&quot;</span>,<span class="hljs-string">&quot;廖鸿业&quot;</span>,<span class="hljs-string">&quot;吕皓洁&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;李飞江&quot;</span>,<span class="hljs-string">&quot;巫岷骏&quot;</span>,<span class="hljs-string">&quot;张坤&quot;</span>,<span class="hljs-string">&quot;唐小富&quot;</span>];</span><br><span class="javascript"><span class="hljs-keyword">var</span> name_now = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;name&quot;</span>);</span><br><span class="javascript"><span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;</span><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getName</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-keyword">var</span> num = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">Math</span>.random()*namelist.length);</span><br>if (count &gt; 400)&#123;<br>name_now.textContent = namelist[num];<br>count = 0;<br>namelist.splice(num,1);<br><span class="javascript">&#125;<span class="hljs-keyword">else</span>&#123;</span><br>name_now.textContent = namelist[num];<br>count += 10;<br><span class="javascript"><span class="hljs-built_in">window</span>.setTimeout(getName,count);</span><br>&#125;<br>if (!namelist.length)&#123;<br><span class="javascript"><span class="hljs-built_in">window</span>.alert(<span class="hljs-string">&quot;全部随机完，已进行复位~&quot;</span>)</span><br><span class="javascript">namelist = [<span class="hljs-string">&quot;曹晓芹&quot;</span>,<span class="hljs-string">&quot;吕耐芯&quot;</span>,<span class="hljs-string">&quot;魏世强&quot;</span>,<span class="hljs-string">&quot;樊振霖&quot;</span>,<span class="hljs-string">&quot;何羽&quot;</span>,<span class="hljs-string">&quot;龙汉&quot;</span>,<span class="hljs-string">&quot;吴亮&quot;</span>,<span class="hljs-string">&quot;邓森中&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;冉钊&quot;</span>,<span class="hljs-string">&quot;曾德浴&quot;</span>,<span class="hljs-string">&quot;李萌&quot;</span>,<span class="hljs-string">&quot;江秀成&quot;</span>,<span class="hljs-string">&quot;李祥&quot;</span>,<span class="hljs-string">&quot;王磊&quot;</span>,<span class="hljs-string">&quot;刘彦材&quot;</span>,<span class="hljs-string">&quot;陈虹州&quot;</span>,<span class="hljs-string">&quot;唐宏进&quot;</span>,<span class="hljs-string">&quot;王建平&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;李俊橙&quot;</span>,<span class="hljs-string">&quot;于梦娇&quot;</span>,<span class="hljs-string">&quot;王龙&quot;</span>,<span class="hljs-string">&quot;刘诗意&quot;</span>,<span class="hljs-string">&quot;殷安好&quot;</span>,<span class="hljs-string">&quot;刘欢&quot;</span>,<span class="hljs-string">&quot;任思宇&quot;</span>,<span class="hljs-string">&quot;廖鸿业&quot;</span>,<span class="hljs-string">&quot;吕皓洁&quot;</span>,</span><br><span class="javascript"><span class="hljs-string">&quot;李飞江&quot;</span>,<span class="hljs-string">&quot;巫岷骏&quot;</span>,<span class="hljs-string">&quot;张坤&quot;</span>,<span class="hljs-string">&quot;唐小富&quot;</span>];</span><br>&#125;<br>&#125;<br><br><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">begin</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="javascript"><span class="hljs-built_in">window</span>.setTimeout(getName,count);</span><br>&#125;<br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>效果：<br><img src="https://upload-images.jianshu.io/upload_images/13692175-dd7ce64617f1fb42.gif?imageMogr2/auto-orient/strip"></p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Window</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaScript</title>
    <link href="/Myblog/2018/09/21/JavaScript/"/>
    <url>/Myblog/2018/09/21/JavaScript/</url>
    
    <content type="html"><![CDATA[<h3 id="一、JS介绍"><a href="#一、JS介绍" class="headerlink" title="一、JS介绍"></a>一、JS介绍</h3><h5 id="1、什么是JS"><a href="#1、什么是JS" class="headerlink" title="1、什么是JS"></a>1、什么是JS</h5><p>javaScripy = ECMAScript(js语法) + BOM - window(浏览器对象模型) + DOM - document(文档对象模型)<br>js 是 javascript 的缩写，是一门专门用来控制网页内容的行为的脚本语言。<br>js 就是 web 标准中的行为标准。</p><h5 id="2、在哪儿写-JS-代码"><a href="#2、在哪儿写-JS-代码" class="headerlink" title="2、在哪儿写 JS 代码"></a>2、在哪儿写 JS 代码</h5><p>1、写在标签的内容（写在标签的行为相关的属性中，比如按钮的onclicked）。</p><p>2、写在 script 标签中（script标签可以放在html 的任何位置，但是一般放在head或者body中）。</p><p>3、写在外部的 js 文件中</p><p>导入</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;js/new_file.js&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="3、js-能做些什么事情"><a href="#3、js-能做些什么事情" class="headerlink" title="3、js 能做些什么事情"></a>3、js 能做些什么事情</h5><p>1、js 可以在网页中插入html 代码。<br>2、可以修改标签的内容。<br>3、修改标签的样式。</p><h3 id="二、JS基础语法"><a href="#二、JS基础语法" class="headerlink" title="二、JS基础语法"></a>二、JS基础语法</h3><h5 id="1、注释"><a href="#1、注释" class="headerlink" title="1、注释"></a>1、注释</h5><p>单行注释：单行注释前面加‘//’<br>多行注释：<br>/<em>这是多行注释<br>\</em>这是注释的第二行<br>*/</p><h5 id="2、标识符"><a href="#2、标识符" class="headerlink" title="2、标识符"></a>2、标识符</h5><p>要求是由数字、字母、下划线和 $符 组成，数字不能开头。<br><code>var h1</code></p><h5 id="3、基本数据类型。"><a href="#3、基本数据类型。" class="headerlink" title="3、基本数据类型。"></a>3、基本数据类型。</h5><p>注意：JS中大小写敏感，没有元组和集合。</p><p><strong>常规</strong><br>Number：数字（包含所有数字）<br>Boolean（布尔类型）<br>String（字符串）<br>Array（数组）<br>Object（对象）</p><p><strong>特殊</strong><br>NaN（不存在的数字）<br>null（空，一般用来清空变量中的内容）<br>undefined（变量没有赋值时，默认是undefined）<br>console.log（）   //在控制台打印内容</p><h5 id="4、字面量"><a href="#4、字面量" class="headerlink" title="4、字面量"></a>4、字面量</h5><p>Number字面量：所有的数字（支持科学技术法，不支持复数）。</p><p>Boolean字面量：true、false（小写）。</p><p>String字面量：单引号或者双引号包围的字符集，支持转义字符（和python相同）。</p><p>Array字面量：相当于python中的列表。</p><p>Object对象字面量：相当于python中的‘字典+对象’<br>注意：key相当于属性，value相当于属性的值。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">var dict = &#123;a:<span class="hljs-number">100</span>, name:<span class="hljs-number">200</span>&#125;<br>console.log(dict)<br></code></pre></td></tr></table></figure><p>typeof()查看数据类型。</p><h5 id="5、js中的语句"><a href="#5、js中的语句" class="headerlink" title="5、js中的语句"></a>5、js中的语句</h5><p>1、一条语句结束后可以写分号，也可以不写，但是一行要写多行就必须写分号。<br>2、js中没有缩进的语法要求，需要代码的时候使用{}</p><h5 id="6、js中变量的声明"><a href="#6、js中变量的声明" class="headerlink" title="6、js中变量的声明"></a>6、js中变量的声明</h5><p><strong>(1)、var声明变量的关键字。</strong><br><code>var 变量名</code> 或者 <code>var 变量=初值</code><br><strong>(2)、变量名：标识符</strong><br>不能是js中的关键字；驼峰式命名（第一个单词的首字母小写，后面每个单词首字母大写），见名知义<br><code>var age ;  var name</code><br><code>var age1 = 10, name ,studyId</code><br>一个变量存储多种类型的值。</p><h5 id="7、js-中的运算符"><a href="#7、js-中的运算符" class="headerlink" title="7、js 中的运算符"></a>7、js 中的运算符</h5><p>包含：数学运算符、比较运算符、逻辑运算符、赋值元素运算符、三目运算符。</p><p><strong>数学运算符</strong>：+、-、<em>、/、%、\</em>*(js7才有)、++（自加1）、–（自减1）<br>注意：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">b</span> = a++：在赋值时先赋值，再加一<br><span class="hljs-attr">b</span> = ++a：先加<span class="hljs-number">1</span>，再赋值。 <br></code></pre></td></tr></table></figure><p><strong>比较运算符</strong>：&gt;,&lt;,==,&gt;=,&lt;=,!=,===,!==,&gt;==,&lt;==.<br>结果都是布尔值。<br>==：是否相等（判断值是否相等）<br>===：是否完全相等（判断值和类型是否相等）<br><img src="https://upload-images.jianshu.io/upload_images/13692175-4d0ef2be2285b4e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p><strong>逻辑运算符</strong><br>&amp;&amp;（与）、||（或）、！（非）</p><p><strong>赋值运算符</strong><br>=，+=，-=，*=，/=，%=，%=……</p><p><strong>三目运算符 – ？：</strong><br>语法：<br><code>表达式1?值1:值2</code> —&gt;  判断表达式1的值是否为真，为真整个运算的结果就是值1，否则值2.</p><p>运算顺序：数学&gt;比较&gt;逻辑&gt;三目&gt;赋值</p><h5 id="8、js中的分支语句"><a href="#8、js中的分支语句" class="headerlink" title="8、js中的分支语句"></a>8、js中的分支语句</h5><p><strong>if语句</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">if</span>(条件语句<span class="hljs-number">1</span>)&#123;<br>  代码段<span class="hljs-number">1</span><br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(条件语句<span class="hljs-number">2</span>)&#123;<br>  代码段<span class="hljs-number">2</span><br>&#125;<span class="hljs-keyword">else</span>&#123;<br>  代码段<span class="hljs-number">3</span><br>&#125;<br></code></pre></td></tr></table></figure><p>执行过程：先判断条件语句1是否为true，为true就执行代码段1，再判断条件2……</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span> = <span class="hljs-number">2</span><br><span class="hljs-function"><span class="hljs-title">if</span><span class="hljs-params">(!(a%<span class="hljs-number">2</span>)</span></span>)&#123;<br>console.log(<span class="hljs-string">&#x27;偶数&#x27;</span>)<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>console.log(<span class="hljs-string">&#x27;奇数&#x27;</span>)<br>&#125;<br><br>偶数<br></code></pre></td></tr></table></figure><p><strong>swith语句</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">switch</span>(表达式)&#123;<br><span class="hljs-keyword">case</span> 值<span class="hljs-number">1</span>:&#123;<br>代码段<span class="hljs-number">1</span><br>&#125;<br><span class="hljs-keyword">case</span> 值<span class="hljs-number">2</span>:&#123; <br>代码段<span class="hljs-number">2</span><br>&#125;<br>···<br><span class="hljs-keyword">default</span>:&#123;<br><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行过程：先计算表达式的值，然后用这个值去和后边case关键字后面的值一一对比，找到第一个和表达式的值相等的case，然后将这个case作为入口，依次执行这个case后边所有的代码。直到遇到switch和break结束。如果没有找到和表达式的值相等的case就执行default后面的代码。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs typescript">练习一：打印星期<br><span class="hljs-keyword">var</span> week = <span class="hljs-number">4</span><br><span class="hljs-keyword">switch</span>(week)&#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;星期天&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;星期一&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;星期二&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;星期三&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;星期四&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;星期五&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;星期六&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><br>练习二：输入成绩查看分数划分<br><span class="hljs-keyword">var</span> score = <span class="hljs-number">3</span><br><span class="hljs-keyword">switch</span>(score)&#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;不及格&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;及格&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;良好&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;良好&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">9</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;优秀&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">10</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;优秀&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">default</span>:&#123;<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;输入不正确！&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="9、循环"><a href="#9、循环" class="headerlink" title="9、循环"></a>9、循环</h5><p>js中的循环结构分为：for循环和while循环。<br><strong>for-in循环</strong></p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">for</span> <span class="hljs-keyword">var</span> 变量 <span class="hljs-keyword">in</span> 序列&#123;<br>循环体<br>&#125;<br></code></pre></td></tr></table></figure><p>执行过程：依次从序列中取元素中对应的索引值，每取一个执行一次循环体。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-tag">var</span> str = <span class="hljs-string">&#x27;abcd&#x27;</span><br><span class="hljs-keyword">for</span> (<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">in</span> str)&#123;<br>console.log(str[i])<br>&#125;<br><span class="hljs-comment">//遍历字符串和数组，取对应的下边，遍历对象，取对应的属性名</span><br>a<br>b<br>c<br>d<br></code></pre></td></tr></table></figure><p><strong>for循环</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">for</span>(表达式<span class="hljs-number">1</span>；表达式<span class="hljs-number">2</span>；表达式<span class="hljs-number">3</span>)&#123;<br>  循环体<br>&#125;<br></code></pre></td></tr></table></figure><p>执行过程：先执行表达式1，再判断表达式2的结果是否为true，如果为true，就执行循环体，执行完循环体再执行循环体3，然后再判断表达式2的结果是否为true，直到表达式2的结果为false为止。</p><p><strong>while循环</strong></p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">while</span>（条件语句）&#123;<br>  循环体<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>do - while循环</strong></p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">do</span>&#123;<br>  循环体<br>&#125;<span class="hljs-keyword">while</span>（条件语句）<br></code></pre></td></tr></table></figure><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-built_in">var</span> <span class="hljs-keyword">sum</span> = <span class="hljs-number">0</span><br><span class="hljs-built_in">var</span> i = <span class="hljs-number">1</span><br><span class="hljs-keyword">do</span>&#123;<br><span class="hljs-keyword">sum</span> += i<br>i++<br>&#125;<span class="hljs-keyword">while</span>(i&lt;=<span class="hljs-number">100</span>)<br>console.<span class="hljs-keyword">log</span>(<span class="hljs-keyword">sum</span>)<br></code></pre></td></tr></table></figure><h5 id="10、函数"><a href="#10、函数" class="headerlink" title="10、函数"></a>10、函数</h5><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-keyword">function</span> <span class="hljs-title">函数名（参数列表）&#123;</span><br>  函数体<br>&#125;<br></code></pre></td></tr></table></figure><p>函数调用时要保证每个参数都有值！不支持不定长参数。<br>js中函数如果没有返回值，那么返回值是undefined</p><p>逗号表达式：如果多个表达式之间用逗号隔开，整个表达式的结果是最后那个值。</p><p>注意：js中不能同时返回多个值（因为不支持元组）</p><p>js中，函数也可以作为变量</p><p> <strong>函数的另外一种声明方式</strong></p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">var</span> 变量 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(参数列表)</span></span>&#123;<br>  函数体<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="11、数据类型"><a href="#11、数据类型" class="headerlink" title="11、数据类型"></a>11、数据类型</h5><p>new 类型名（值）  –&gt;  可以将其他类型的数据转换成相应类型的值。<br><strong>a、数字类型 – Number</strong>：所有的数字类型。<br><strong>b、布尔 – Boolean</strong>：true和false<br><code>var bool = new Boolean（&quot;a&quot;） //true</code><br>总结：所有为0为空的转换成布尔是false，NaN，null，undefined都是false<br><strong>c、字符串 – String</strong></p><ul><li>获取单个字符：通过字符串[下标]</li><li>js中下标只支持0~长度-1，不支持负值。并且不支持切片</li><li>获取字符串长度：<strong>字符串.length</strong></li><li>运算符：比较和加操作<br>如果其他的数据类型和字符串相加，都是现把其他数据类型转换成字符串，然后做字符串的拼接操作。</li></ul><p><strong>d、数组</strong><br>有序，可变的，元素类型可以是任意的数据</p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSS布局</title>
    <link href="/Myblog/2018/09/19/CSS%E5%B8%83%E5%B1%80/"/>
    <url>/Myblog/2018/09/19/CSS%E5%B8%83%E5%B1%80/</url>
    
    <content type="html"><![CDATA[<h4 id="一、标准流"><a href="#一、标准流" class="headerlink" title="一、标准流"></a>一、标准流</h4><p>标准流：浏览器对标签默认的布局方式就是标准流。<br><strong>标准流布局原则：</strong></p><ul><li><p>块级标签：<br>a、块级标签一个占一行（不管标签的宽度是否是浏览器宽度）<br>b、默认宽度是父标签的宽度，默认高度是内容的高度。<br>c、直接设置宽高<strong>有效</strong></p></li><li><p>行内标签：<br>a、多个行内标签可以一行显示。<br>b、默认宽高是内容的宽高。<br>c、直接设置宽高<strong>无效。</strong></p></li><li><p>行内块标签：<br>a、多个行内块标签可以在一行显示。<br>b、默认宽高是内容的宽高。<br>c、直接设置宽高<strong>有效。</strong></p></li></ul><p><strong>display属性：转换标签的性质</strong><br>block：块级<br>inline：行内<br>inline-block：行内块</p><p>注意：行内块和其他标签之间默认会有个间隙，而且无法消除，所以一般不建议使用。</p><h4 id="二、浮动-–-float"><a href="#二、浮动-–-float" class="headerlink" title="二、浮动 – float"></a>二、浮动 – float</h4><p>通过给float属性赋值为 left 或者 right 来让标签浮动。浮动会让标签脱流，脱流后原来的标准流布局方式不适用了。<br><code>float:left;</code> 按照浏览器的左上角为起点。<br><code>float:right</code>按照浏览器的右上角为起点。</p><p>浮动的目的：让竖着显示的可以横着来（针对块）</p><p><strong>浮动的效果：<br>一行可以显示多个；默认的宽高是内容的大小；可以设置宽度和高度</strong></p><p>注意事项：<br>a、如果同一级的标签，后面的需要浮动，前面的也需要浮动，否则可能会出现一些显示问题。<br>b、浮动的标签不占位置，不浮动的占位置。</p><p><strong>利用浮动产生文字环绕效果</strong><br>结论：被环绕的标签浮动，文字对应的标签不浮动。</p><p><strong>清除浮动</strong>：不是将标签的浮动给去掉，而是清除因为浮动而产生的高度塌陷的问题。</p><p><strong>高度塌陷</strong>：在文档流中，父元素的高度默认是被子元素撑开的，也就是子元素多高，父元素就多高。<br>但是当为子元素设置浮动以后，子元素会完全脱离文档流，此时将会导致子元素无法撑起父元素的高度，导致父元素的高度塌陷。<br>由于父元素的高度塌陷了，则父元素下的所有元素都会向上移动，这样将会导致页面布局混乱。</p><p><strong>高度塌陷产生原因</strong>：父标签不浮动，子标签浮动，并且不设置父标签的高度，就会产生高度塌陷问题。</p><p>解决方案：<br>1、在后面添加一个div空盒子，设置样式为clear：both</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">&lt;<span class="hljs-keyword">div</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;&quot;</span> style=<span class="hljs-string">&quot;clear: both;&quot;</span>&gt;<br>&lt;/<span class="hljs-keyword">div</span>&gt;<br></code></pre></td></tr></table></figure><p>2、给父标签添加样式，设置overflow的值为hidden。</p><p>3、万能清除法</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-id">#father</span><span class="hljs-selector-pseudo">:after</span>&#123;<br><span class="hljs-attribute">display</span>: block;<br><span class="hljs-attribute">clear</span>: both;<br><span class="hljs-attribute">content</span>: <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-attribute">visibility</span>: hidden;<br><span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;<br><br>&#125;<br><span class="hljs-selector-id">#father</span>&#123;<br><span class="hljs-attribute">zoom</span>: <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="三、定位"><a href="#三、定位" class="headerlink" title="三、定位"></a>三、定位</h4><p>CSS中可以通过left，right，bottom，top属性来设置标签上下左右的距离。但是要通过position属性设置参考对象。</p><p><strong>absolute</strong>：相对第一个非static/initial(默认值)父标签进行定位。</p><p><strong>relative</strong>：相对于自己在标准流中的位置来定位。（当标签本身不希望去定位，只是想让自己的子标签可以相对自己定位时使用。）</p><p><strong>fixed</strong>：相对于浏览器定位。（滚动时位置相对于浏览器不变）</p><p><strong>sticky</strong>：当网页的内容不超过一屏（不滚动），按照标准流定位；超过一屏就相对浏览器定位。</p><p>initial：默认值，没有相对定位。</p><p><strong>技巧：当遇到某个方向的定位无效时，可以尝试让标签浮动然后定位。</strong></p><h4 id="四、盒子模型"><a href="#四、盒子模型" class="headerlink" title="四、盒子模型"></a>四、盒子模型</h4><p>html中所有可见的标签都是一个盒子模型：包括长和宽决定的content、padding、border、margin。<br>其中content、padding、border是可见的，margin是不可见的。<br><img src="https://upload-images.jianshu.io/upload_images/13692175-934c0a4ce5c85c94.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p><strong>1、content（内容）</strong>：设置width 和height影响的就是内容部分的大小。添加子标签、内容都是放在内容部分的。</p><p><strong>2、padding（内边距）</strong>：内容外围，可见部分，如果标签有背景颜色，那么这个部分的颜色和内容一致。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html">padding-left: 20px;<br>padding:10px; /*所有*/<br>padding:10px 20px; /*上下和作业*/<br>padding:10px 20px 30px 40px; /*顺时针*/<br></code></pre></td></tr></table></figure><p><strong>3、border（边框）</strong>：border在padding的外围，如果没有padding，就在内容的外围，可以设置颜色。<br><code>border:宽度 风格 颜色</code><br>样式：solid（实线）、dashde（虚线）、dotted（点划线）double（双线）</p><p><strong>4、margin（外边距）</strong>：不可见。主要用来占位。</p><h4 id="五、其他常用属性"><a href="#五、其他常用属性" class="headerlink" title="五、其他常用属性"></a>五、其他常用属性</h4><p><strong>1、字体相关属性</strong></p><ul><li>字体颜色：color</li><li>字体大小：font-size</li><li>字体名：font-family</li><li>字体加粗：font-weight：bolder（更粗的）、bold（加粗）、normal（常规）、100-900</li><li>字体倾斜：font-style：italic、oblique、normal</li></ul><p><strong>2、文本修饰 – text-decoration</strong><br>none：取消修饰<br>underline：下划线<br>overline：上划线<br>line-through：删除线</p><p><strong>3、对齐方式</strong><br>text-align：left、right、center（文字水平方向居中）</p><p>margin：0px auto;（水平居中）<br>一行内容在垂直方向居中，可以通过将line-height的值设置为父标签的height值。（垂直居中）</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html">height:40px;<br>line-height:40px;<br></code></pre></td></tr></table></figure><p><strong>4、首行缩进 – text-indent</strong><br><code>text-indent:2em</code><br>em代表一个空格的长度</p><p><strong>5、字间距 – letter-spacing</strong><br><code>letter-spacing:2em</code></p><p><strong>6、背景图片</strong><br>格式：<code>babackground-image:图片地址、是否平铺 x方向坐标 y方向的坐标 颜色</code><br>no-repeat/repeat/repeat-x/repeat-y(不平铺、平铺、x方向平铺、y方向平铺)</p><p><code>background-image: url(img/beauty.png) no-repeat center center yellow;</code>   center表示在水平或者垂直方向居中。<br>默认图片不够时，背景图片会平铺。</p><p><strong>7、设置圆角</strong></p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs maxima"><span class="hljs-built_in">border</span>-<span class="hljs-built_in">radius</span>: 20px;<br><span class="hljs-built_in">border</span>-bottom-left-<span class="hljs-built_in">radius</span>: 20px;<br></code></pre></td></tr></table></figure><h4 id="六、补充"><a href="#六、补充" class="headerlink" title="六、补充"></a>六、补充</h4><p><strong>制作网页首页title图标</strong><br><img src="https://upload-images.jianshu.io/upload_images/13692175-f71a7cb24ddba76e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p><strong>一般写网页前一定要先将标签默认的margin值和padding值关闭。</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html">*&#123; <br>  margin:0;<br>  padding:0;<br>  position:relative;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>实现元素居中</strong><br><a href="https://www.cnblogs.com/zhouhuan/p/vertical_center.html">CSS中垂直居中的11种方式</a><br><a href="https://www.w3cplus.com/css/elements-horizontally-center-with-css.html">CSS中元素6种水平居中</a></p><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a><strong>练习</strong></h2><p>HTML代码</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>京东-欢迎登录<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;css/test.css&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;logo&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;img/logo.png&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;logo_test&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span>&gt;</span>欢迎登录<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;q&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;img/q-icon.png&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;q1&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;id1&quot;</span>&gt;</span>登录页面，调查问卷<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;tiaowen&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;background-color: blanchedalmond;&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span>依据《网络安全法》，为保障您的账户安全和正常使用，请尽快完成手机号验证！ 新版《京东隐私政策》已上线，将更有利于保护您的个人隐私。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;bgpic&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;img/bg.png&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;1280px&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;login&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;background-color:white;&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;d01&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span>京东不会以任何理由要求您转账汇款，谨防诈骗。<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;login1&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;5&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;saoma&quot;</span>&gt;</span>扫码登录<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;login2&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;5&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;denglu&quot;</span>&gt;</span>账户登录<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;forget&quot;</span>&gt;</span>忘记密码<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;qq&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!--&lt;div id=&quot;qq_img&quot;&gt;--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;img/qq.png&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;float: left;&quot;</span>/&gt;</span><br><span class="hljs-comment">&lt;!--&lt;/div&gt;--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;qq1&quot;</span>&gt;</span>QQ<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;img/weixin.png&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vx1&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vx2&quot;</span>&gt;</span>微信<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;img/right.png&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;zhuce01&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;3&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;zhuce02&quot;</span>&gt;</span>立即注册<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;img/user.png&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user01&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;邮箱/用户名/已验证手机&quot;</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;img/password_icon.png&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;密码&quot;</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;form_login&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;登录&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p1&quot;</span>&gt;</span>关于我们 <span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu1&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p2&quot;</span>&gt;</span>联系我们 <span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu2&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p3&quot;</span>&gt;</span>人才招聘 <span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu3&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p4&quot;</span>&gt;</span>商家入驻 <span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu4&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p5&quot;</span>&gt;</span>广告服务<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu5&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p6&quot;</span>&gt;</span>手机京东<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu6&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p7&quot;</span>&gt;</span>友情链接<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu7&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p8&quot;</span>&gt;</span>销售联盟<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu8&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p9&quot;</span>&gt;</span>京东社区<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu9&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p10&quot;</span>&gt;</span>京东公益<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;shu10&quot;</span>&gt;</span>丨<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p11&quot;</span>&gt;</span>English Site<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p12&quot;</span>&gt;</span>Copyright © 2004-2018  京东JD.com 版权所有<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>CSS代码</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">body</span>&#123;<br><span class="hljs-attribute">margin</span>: <span class="hljs-number">0px</span>;<br>&#125;<br><span class="hljs-selector-id">#zhuce02</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#vx2</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#qq1</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#forget</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#id1</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p1</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p2</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p3</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p4</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p5</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p6</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-tag">vp7</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p8</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p9</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p10</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#p11</span><span class="hljs-selector-pseudo">:hover</span>&#123;<br><span class="hljs-attribute">color</span>: red;<br><span class="hljs-attribute">text-decoration</span>: underline;<br>&#125;<br><span class="hljs-selector-id">#logo</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">130px</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">24px</span>;<br>&#125;<br><span class="hljs-selector-id">#logo_test</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">320px</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">45px</span>;<br><span class="hljs-attribute">font-size</span>: <span class="hljs-number">25px</span>;<br>&#125;<br><span class="hljs-selector-id">#q</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">992px</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">75px</span>;<br>&#125;<br><span class="hljs-selector-id">#q1</span>&#123;<br><span class="hljs-attribute">position</span>: relative;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">30px</span>;<br><span class="hljs-attribute">top</span>:-<span class="hljs-number">22px</span>;<br><span class="hljs-attribute">font-size</span>: <span class="hljs-number">13px</span>;<br>&#125;<br><span class="hljs-selector-id">#tiaowen</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;<br><span class="hljs-attribute">font-size</span>: <span class="hljs-number">13px</span>;<br>&#125;<br><span class="hljs-selector-id">#bgpic</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">143px</span>;<br>&#125;<br><span class="hljs-selector-id">#login</span>&#123;<br><span class="hljs-attribute">position</span>: relative;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">348px</span>;<br><span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">850px</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">148px</span>;<br>&#125;<br><span class="hljs-selector-id">#d01</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;<br><span class="hljs-attribute">padding</span>: <span class="hljs-number">0px</span> <span class="hljs-number">42px</span>;<br><span class="hljs-attribute">line-height</span>: <span class="hljs-number">10px</span>;<br><span class="hljs-attribute">background-color</span>: blanchedalmond;<br><span class="hljs-attribute">text-align</span>: center;<br>&#125;<br><span class="hljs-selector-id">#login1</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">50px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">50px</span>;<br>&#125;<br><span class="hljs-selector-id">#login2</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">50px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">210px</span>;<br>&#125;<br><span class="hljs-selector-id">#forget</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">225px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">260px</span>;<br><span class="hljs-attribute">font-size</span>: <span class="hljs-number">10px</span>;<br>&#125;<br><br><span class="hljs-selector-id">#user</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">280px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">890px</span>;<br>&#125;<br><span class="hljs-selector-id">#user01</span>&#123;<br><span class="hljs-attribute">position</span>: relative;<br><span class="hljs-attribute">top</span>: -<span class="hljs-number">14px</span>;<br><span class="hljs-attribute">left</span>: -<span class="hljs-number">7px</span>;<br><span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">230px</span>;<br>&#125;<br><span class="hljs-selector-id">#password</span>&#123;<br><span class="hljs-attribute">position</span>: relative;<br><span class="hljs-attribute">top</span>: -<span class="hljs-number">14px</span>;<br><span class="hljs-attribute">left</span>: -<span class="hljs-number">7px</span>;<br><span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">230px</span>;<br>&#125;<br><span class="hljs-selector-id">#form_login</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>:<span class="hljs-number">150px</span>;<br><span class="hljs-attribute">left</span>: -<span class="hljs-number">30px</span>;<br><span class="hljs-attribute">height</span>: <span class="hljs-number">34px</span>;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">270px</span>;<br><span class="hljs-attribute">margin-left</span>: <span class="hljs-number">28px</span>;<br><span class="hljs-attribute">margin-right</span>: <span class="hljs-number">28px</span>;<br><span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">229</span>,<span class="hljs-number">56</span>,<span class="hljs-number">60</span>);<br>&#125;<br><span class="hljs-selector-id">#qq</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">19px</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">360px</span>;<br>&#125;<br><span class="hljs-selector-id">#qq1</span>&#123;<br><span class="hljs-attribute">float</span>: left; <br><span class="hljs-attribute">position</span>:absolute; <br><span class="hljs-attribute">left</span>: <span class="hljs-number">25px</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">5px</span>;<br>&#125;<br><span class="hljs-selector-id">#vx1</span>&#123;<br><span class="hljs-attribute">float</span>: left; <br><span class="hljs-attribute">position</span>:absolute; <br><span class="hljs-attribute">left</span>: <span class="hljs-number">52px</span>;<br>&#125;<br><span class="hljs-selector-id">#vx2</span>&#123;<br><span class="hljs-attribute">float</span>: left; <br><span class="hljs-attribute">position</span>:absolute; <br><span class="hljs-attribute">left</span>: <span class="hljs-number">80px</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">5px</span>;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">50px</span>;<br>&#125;<br><span class="hljs-selector-id">#zhuce01</span>&#123;<br><span class="hljs-attribute">float</span>: left; <br><span class="hljs-attribute">position</span>:absolute; <br><span class="hljs-attribute">left</span>: <span class="hljs-number">200px</span>;<br>&#125;<br><span class="hljs-selector-id">#zhuce02</span>&#123;<br><span class="hljs-attribute">float</span>: left; <br><span class="hljs-attribute">position</span>:absolute; <br><span class="hljs-attribute">left</span>: <span class="hljs-number">226px</span>;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">2px</span>;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;<br>&#125;<br><span class="hljs-selector-id">#saoma</span><span class="hljs-selector-pseudo">:hover</span>,<span class="hljs-selector-id">#denglu</span><span class="hljs-selector-pseudo">:hover</span>&#123;<br><span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">229</span>,<span class="hljs-number">56</span>,<span class="hljs-number">60</span>);<br><span class="hljs-attribute">font-weight</span>:bold ;<br>&#125;<br><br><span class="hljs-selector-id">#p1</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">200px</span>;<br><br>&#125;<br><span class="hljs-selector-id">#shu1</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">260px</span>;<br>&#125;<br><span class="hljs-selector-id">#p2</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">280px</span>;<br>&#125;<br><span class="hljs-selector-id">#shu2</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">340px</span>;<br>&#125;<br><span class="hljs-selector-id">#p3</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">360px</span>;<br>&#125;<br><span class="hljs-selector-id">#shu3</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">420px</span>;<br>&#125;<br><span class="hljs-selector-id">#p4</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">440px</span>;<br>&#125;<br><span class="hljs-selector-id">#shu4</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">500px</span>;<br>&#125;<br><span class="hljs-selector-id">#p5</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">520px</span>;<br>&#125;<br><span class="hljs-selector-id">#shu5</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">580px</span>;<br>&#125;<br><span class="hljs-selector-id">#p6</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">600px</span>;<br>&#125;<br><span class="hljs-selector-id">#shu6</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">660px</span>;<br>&#125;<br><span class="hljs-selector-id">#p7</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">680px</span>;<br>&#125;<br><span class="hljs-selector-id">#shu7</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">740px</span>;<br>&#125;<br><span class="hljs-selector-id">#p8</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">760px</span>;<br>&#125;<br><span class="hljs-selector-id">#shu8</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">820px</span>;<br>&#125;<br><span class="hljs-selector-id">#p9</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">840px</span>;<br>&#125;<br><span class="hljs-selector-id">#shu9</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">900px</span>;<br>&#125;<br><span class="hljs-selector-id">#p10</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">920px</span>;<br>&#125;<br><span class="hljs-selector-id">#shu10</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">980px</span>;<br>&#125;<br><span class="hljs-selector-id">#p11</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">605px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">1000px</span>;<br>&#125;<br><span class="hljs-selector-id">#p12</span>&#123;<br><span class="hljs-attribute">position</span>: absolute;<br><span class="hljs-attribute">top</span>: <span class="hljs-number">630px</span>;<br><span class="hljs-attribute">left</span>: <span class="hljs-number">505px</span>;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>效果如下<br><img src="https://upload-images.jianshu.io/upload_images/13692175-b93533a5aeaeccfd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSS基础</title>
    <link href="/Myblog/2018/09/18/CSS%E5%9F%BA%E7%A1%80/"/>
    <url>/Myblog/2018/09/18/CSS%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h4 id="一、表单标签"><a href="#一、表单标签" class="headerlink" title="一、表单标签"></a>一、表单标签</h4><p><strong>表单标签 – form</strong></p><p>表单标签是用来收集用户信息的，是一个容器。<br>可以将收集到的数据，通过method对应的方式，去发送请求。（发送给action对应的接口）</p><h5 id="input标签"><a href="#input标签" class="headerlink" title="input标签"></a>input标签</h5><p>单标签</p><p><strong>A、文本输入框和密码输入框（type = text，password）</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!--a、文本输入框--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>账号<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;账号&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入账号&quot;</span> <span class="hljs-attr">maxlength</span>=<span class="hljs-string">&quot;8&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>密码<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;passwd&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入密码&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;提交&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure><p>（1）、type属性：决定input标签的样式。text（默认）：文本输入框；password：用于输入密码隐藏。<br>（2）、name属性：区分不同的input对应的值，对标签的显示没有影响。<br>（3）、value属性：input标签中的值，提交input中的数据给服务器的时候，是以name = value来提交的。（文本输入框中输入的内容就是value的值）。<br>（4）、placeholder属性：占位符（输入框的提示信息）。<br>（5）、maxlength属性：约束输入最大位数。</p><p><strong>B、单选按钮（type = radio）</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;radio&quot; <span class="hljs-type">name</span>=&quot;sex&quot; <span class="hljs-keyword">value</span>=&quot;boy&quot; checked=&quot;&quot; /&gt;&lt;span&gt;男&lt;/span&gt;<br>&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;radio&quot; <span class="hljs-type">name</span>=&quot;sex&quot; <span class="hljs-keyword">value</span>=&quot;girl&quot; /&gt;&lt;span&gt;女&lt;/span&gt;<br></code></pre></td></tr></table></figure><p>（1）、value：设置这个按钮选中提交的值。<br>（2）、name值：如果多个按钮只能选中一个，那么这些按钮的name值必须一致。<br>（3）、一组（name值一样）单选按钮在提交的时候只提交被选中的按钮的name和value值。<br>（4）、checked：默认初始选择一个。</p><p><strong>C、复选框（type = checkbox）</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;form action=&quot;&quot; <span class="hljs-keyword">method</span>=&quot;post&quot;&gt;<br>&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;checkbox&quot; <span class="hljs-type">name</span>=&quot;habby&quot; <span class="hljs-keyword">value</span>=&quot;篮球&quot;/&gt;&lt;span&gt;篮球&lt;/span&gt;<br>&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;checkbox&quot; <span class="hljs-type">name</span>=&quot;habby&quot; <span class="hljs-keyword">value</span>=&quot;乒乓球&quot;/&gt;&lt;span&gt;乒乓球&lt;/span&gt;<br>&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;checkbox&quot; <span class="hljs-type">name</span>=&quot;habby&quot; <span class="hljs-keyword">value</span>=&quot;羽毛球&quot;/&gt;&lt;span&gt;羽毛球&lt;/span&gt;<br>&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;checkbox&quot; <span class="hljs-type">name</span>=&quot;habby&quot; <span class="hljs-keyword">value</span>=&quot;网球&quot;/&gt;&lt;span&gt;网球&lt;/span&gt;<br>&lt;/form&gt;<br></code></pre></td></tr></table></figure><p>同一组name值必须一样</p><p><strong>D、普通按钮（type = button）</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;button&quot; <span class="hljs-type">name</span>=&quot;&quot; <span class="hljs-keyword">value</span>=&quot;登录&quot; /&gt;<br></code></pre></td></tr></table></figure><p><strong>E、提交按钮（type = submit）</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;submit&quot; <span class="hljs-type">name</span>=&quot;&quot; id=&quot;&quot; <span class="hljs-keyword">value</span>=&quot;提交&quot; /&gt;<br></code></pre></td></tr></table></figure><p>自动将当前form中设置了name属性的input标签的值，通过method的方式，提交给action对应的接口。</p><p><strong>F、重置按钮（type = reset）</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;reset&quot; <span class="hljs-type">name</span>=&quot;&quot; id=&quot;&quot; <span class="hljs-keyword">value</span>=&quot;重置&quot; /&gt;<br></code></pre></td></tr></table></figure><p>将form标签中的input标签所有值恢复初始状态。</p><p><strong>G、文件域（type = file）</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=&quot;file&quot; <span class="hljs-type">name</span>=&quot;&quot; id=&quot;&quot; <span class="hljs-keyword">value</span>=&quot;&quot; /&gt;<br></code></pre></td></tr></table></figure><p>选择本地文件</p><h4 id="二、下拉菜单标签"><a href="#二、下拉菜单标签" class="headerlink" title="二、下拉菜单标签"></a>二、下拉菜单标签</h4><p><strong>下拉菜单标签 – select</strong><br>下拉和多行文本域可以放在form标签里面用于收集信息。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;<span class="hljs-keyword">select</span> <span class="hljs-type">name</span>=&quot;city&quot;&gt;<br>&lt;optgroup label=&quot;四川省&quot;&gt;   <br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;成都&quot; selected=&quot;selected&quot;&gt;成都&lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;德阳&quot;&gt;德阳&lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;眉山&quot;&gt;眉山&lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;乐山&quot;&gt;乐山&lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;泸州&quot;&gt;泸州&lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;/optgroup&gt;<br>&lt;optgroup label=&quot;广东省&quot;&gt;   <br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;深圳&quot;&gt;深圳&lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;广州&quot;&gt;广州&lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;中山&quot;&gt;中山&lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;佛山&quot;&gt;佛山 &lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;<span class="hljs-keyword">option</span> <span class="hljs-keyword">value</span>=&quot;东莞&quot;&gt;东莞&lt;/<span class="hljs-keyword">option</span>&gt;<br>&lt;/optgroup&gt;<br>&lt;/<span class="hljs-keyword">select</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>下拉菜单标签 – select</strong><br>一个select标签对应一个下拉菜单，分组用optgroup属性设置，选项要通过option来列举。selected用来选择默认选项。</p><h4 id="三、多行文本域"><a href="#三、多行文本域" class="headerlink" title="三、多行文本域"></a>三、多行文本域</h4><p><strong>多行文本域 – textarea</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;textarea <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;message&quot;</span> <span class="hljs-attribute">maxlength</span>=<span class="hljs-string">&quot;200&quot;</span> <span class="hljs-attribute">placeholder</span>=<span class="hljs-string">&quot;输入你想写的文字&quot;</span> <span class="hljs-attribute">cols</span>=<span class="hljs-string">&quot;40&quot;</span>&gt;&lt;/textarea&gt;<br></code></pre></td></tr></table></figure><p>（1）、name提交数据对应的名字。<br>（2）、rows：默认一屏的行数。<br>（3）、cols：默认的列数。<br>（4）、placeholder：设置占位符。<br>（5）、disabled：禁用。</p><h4 id="四、div-和-span-标签"><a href="#四、div-和-span-标签" class="headerlink" title="四、div 和 span 标签"></a>四、div 和 span 标签</h4><p><strong>div 和 span 标签是空白标签，没有语意。</strong></p><ul><li>div是块级标签（一行只能放一个标签）</li><li>span是行内标签（一行可以放多个标签）</li></ul><p>块级标签：一个标签占一行<br><code>h1-6 , p , ol , table, hr </code><br>行内标签：一行可以多个标签<br> <code>img , a , input , select , textarea</code></p><h4 id="五、CSS基础"><a href="#五、CSS基础" class="headerlink" title="五、CSS基础"></a>五、CSS基础</h4><p>CSS是web标准中的表现标准，用来规定网页上内容的布局和样式（CSS又叫样式表）。<br>目前广泛使用的是CSS3。</p><h5 id="1、CSS用法"><a href="#1、CSS用法" class="headerlink" title="1、CSS用法"></a>1、CSS用法</h5><ul><li><p>固定语法：</p><ul><li>选择器{ 属性1：属性值1 ； 属性2：属性值2；…… }<br>A、选择器：确认样式的对象。<br>B、属性：固定支持和拥有的，顺序任意。<br>C、属性值：<br>(1).数值：<br>用来表示大小，后面必须跟单位px（像素）或者%（所占百分比）<br>(2).颜色：<br>颜色对应的英语单词<br>/ #加R-G-B对应的16进制的值（一个颜色值对应2位16进制值）<br>直接用RGB值：rgb（R，G，B），rgba（R，G，B，Alpha-透明度） R,G,B范围是0~255，Alpha范围0~1</li></ul></li><li><p>常见属性<br>color ， background-color ，width ， height， font-size ……</p></li></ul><p><strong>A、内联样式表</strong><br>将样式表写在标签的style属性中（每个可见的标签都有style属性）。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;background-color: cornflowerblue;color: red;&quot;</span>&gt;</span>这是CSS样式表<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>B、内部样式表</strong><br>将样式表写在 head标签的 style标签里面。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span>&gt;</span><br>h1&#123;<br>background-color: skyblue;<br>color: saddlebrown;<br>&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我是标题1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我是标题2<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>C、外部样式表</strong><br>将样式表写在一个CSS文件中，然后再把head标签中通过 link标签导入。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;link <span class="hljs-attribute">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attribute">type</span>=<span class="hljs-string">&quot;text/css&quot;</span> <span class="hljs-attribute">href</span>=<span class="hljs-string">&quot;css/form.css&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><p>注意：不管在什么情况下，内联样式表的优先级最高。内部和外部样式表执行越后，优先级越高。</p><h5 id="2、常用选择器"><a href="#2、常用选择器" class="headerlink" title="2、常用选择器"></a>2、常用选择器</h5><p>（1）标签/元素选择器：直接将标签名作为选择器，同时选中网页中所有同类型的标签。<br><code>a&#123;&#125;  ---  选中所有a标签</code></p><p>（2）id 选择器：通过在id属性值前面加#，就构成了id选择器。选中 id 等于对应值得标签。<br>id 属性：所有的标签都有 id 属性。<br><code>#p1&#123;&#125;   ---   选中 id 值是 p1 的标签</code></p><p>（3）class选择器：通过在class 属性值前加 .（点） ，就构成了类选择器。选中class等于对应的值的标签。<br><code>&lt;h1 class=&quot;c1&quot;&gt;我是class选择器&lt;/h1&gt;</code><br><code>.c1&#123;&#125;   ---   选中所有class的值是c1的标签</code></p><p>（4）群组选择器：多个单独的选择器之间使用逗号隔开。选中所有的单独的选择器<br><code>a，p，#p1，.c1&#123;&#125;  ---   选中所有对应的标签</code></p><p>（5）包含选择器：多个选择器之间使用空格隔开。依次往下寻找，直到最后一个选择器。<br><code>div .c1 p&#123;&#125;   ---   选中div标签中的class值为c1标签中的p标签。</code></p><p>（6）通配符*：直接将*作为选择器。选中当前页面中所有的标签。<br><code>*&#123;&#125;   ---   选中所有标签，包括body标签</code></p><p>（7）父子选择器：a&gt;b{}<br>（8）兄弟选择器：a~b{}<br>（9）相邻兄弟选择器：a+b{}<br>（10）属性选择器：a[b = c] </p><h5 id="3、伪类选择器"><a href="#3、伪类选择器" class="headerlink" title="3、伪类选择器"></a>3、伪类选择器</h5><p>前面的元素选择器、id选择器、class选择器选中的都是标签。而伪类选择器选中的是标签的某个状态，一般使用于超链接和按钮等。<br><strong>（1）、语法：</strong><br><code>标签：状态&#123;&#125;</code><br>说明：<br>link：初始状态<br>visited：访问后的状态<br>active：被激活对应的状态（鼠标点击时）<br>hover：鼠标悬停在标签上的状态<br>focus：成为焦点（输入框中用的比较多）</p><p>标签：可以通过不同的选择器去选中。</p><p><strong>（2）、爱恨原则：LoVeHAte – 先爱后恨</strong><br>如果想要给一个标签同时给link\visited\hover\active中的两个或者两个以上的状态设置样式，必须遵守爱恨原则。不遵守可能会出问题。</p><h5 id="4、选择器的优先级"><a href="#4、选择器的优先级" class="headerlink" title="4、选择器的优先级"></a>4、选择器的优先级</h5><p><strong>(1)、就近原则</strong><br><strong>(2)、具体性原则</strong><br>id&gt;类&gt;标签[…]&gt;标签&gt;通配符<br>**(3)、重要性原则**<br><code>color:red  !important;</code></p><p>通过不同的选择器选中了同一个标签，谁的优先级高就谁有效。权重值大 –&gt; 高优先级<br>权重值相同时，后写的选择器优先级高。</p><p>权重值<br>伪类选择器：0001<br>通配符：0001<br>元素选择器：0001<br>class选择器：0010<br>id选择器：0100<br>群组选择器：看单独每一个的权重。<br>包含选择器：多个选择器的权重和。</p><p>注意：不管选择器的权重有多高，内联样式的优先级都是最高的。</p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Web前端</title>
    <link href="/Myblog/2018/09/17/Web%E5%89%8D%E7%AB%AF/"/>
    <url>/Myblog/2018/09/17/Web%E5%89%8D%E7%AB%AF/</url>
    
    <content type="html"><![CDATA[<h3 id="web标准"><a href="#web标准" class="headerlink" title="web标准"></a>web标准</h3><p>web前端的内容：HTML、CSS、JavaScript</p><p>web标准（万维网指定的）中规定HTML是结构标准，CSS是表现标准，JS是行为标准。</p><ul><li>HTML结构标准：规定了网页上能够显示的内容，比如显示文字、图片、视频、Flash、按钮、输入框等…</li><li>CSS表现标准：规定了网页的内容的布局和样式，比如内容该显示在什么位置，内容是什么颜色、大小等…</li><li>JS行为标准：规定网页的内容在什么情况下发生什么样的变化（动态变化）。</li></ul><h3 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h3><p>HTML又叫超文本标记语言（不同于编程语言）</p><p>H5：<br>狭义 –&gt; 指html第5个大的版本<br>广义 –&gt; 指的是 html5 + CSS3 +JavaScript</p><h5 id="1、HTML文件结构-（由不同的标签组成）"><a href="#1、HTML文件结构-（由不同的标签组成）" class="headerlink" title="1、HTML文件结构 （由不同的标签组成）"></a>1、HTML文件结构 （由不同的标签组成）</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>内容可见<br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="2、HTML中的标签"><a href="#2、HTML中的标签" class="headerlink" title="2、HTML中的标签"></a>2、HTML中的标签</h5><p>网页中的内容就是通过HTML中不同的标签（标记）来确定。<br>标签语法：<br><strong>a、双标签（常规标签）</strong>：<br><code>&lt;标签名 属性1=属性值1 属性2=属性值2 ……&gt; 标签内容 &lt;/标签名&gt;</code><br><strong>b、单标签</strong>：<br><code>&lt;标签名 属性1=属性值1 属性2=属性值2 ……&gt; </code><br>或者<br><code>&lt;标签名 属性1=属性值1 属性2=属性值2 ……/&gt;</code></p><p>说明：<br>**&lt;&gt;, &lt;/&gt;<strong>：固定写法，html中所有的标签都是写在&lt;&gt;中的。<br>**标签名</strong>：不是随便命名的，而是一些固定的值。例如p标签，a标签，h1标签……<br><strong>属性</strong>：属性放在开始标签中，属性名和值之间用 = 连接，多个属性之间用空格隔开。属性可以是自定义属性，也可以是标签自带属性。<br><strong>标签内容</strong>：双标签才存在标签内容，标签内容可以是任何东西。<br>**&lt;/&gt;**：结束标签，单标签没有一个单独的结束标签。</p><h5 id="3、基本语法"><a href="#3、基本语法" class="headerlink" title="3、基本语法"></a>3、基本语法</h5><p>HTML语法中大小写不敏感。<br>文件名命名要求：由字母和数字组成，但是数字不开头，一般用小写字母。网站首页一般是 index.html</p><p>**<!DOCTYPE html>**：用来说明当前html文件使用的版本。其中 html 代表 html5 。 </p><h5 id="4、head标签"><a href="#4、head标签" class="headerlink" title="4、head标签"></a>4、head标签</h5><p>head标签：里面的内容一般是不可见的，一般做一些网页设置性的操作。</p><p>head标签中的内容：meta标签、title标签、link标签、style标签、script标签、base标签</p><h5 id="5、body标签"><a href="#5、body标签" class="headerlink" title="5、body标签"></a>5、body标签</h5><p>body标签：里面的内容一般是可见的，是网页中的主体</p><p><strong>h1标签</strong><br>范围：h1 - h6<br><code>&lt;h1&gt;我是标题1&lt;/h1&gt;</code></p><p><strong>段落</strong><br><code>&lt;p&gt;文字段落&lt;/p&gt;</code><br>注意：html中的文字是不会因为手动的回车和空格以及缩进产生空白效果。</p><p>可以通过一些特殊的符号来产生一些特殊的效果：<br>&amp;nbsp;  –&gt;  空格<br>&lt;br/&gt;  –&gt;  强制换行<br>&lt;hr&gt;  –&gt;  水平线</p><p><strong>文字效果</strong></p><ul><li><strong>加粗</strong><br>b标签：单纯在样式上进行加粗<br>strong标签：除了将文字加粗显示外，还有强调的意义。</li><li><strong>倾斜</strong><br>i标签：倾斜<br>em标签：倾斜，有强调作用</li></ul><p><strong>列表</strong><br>ul–无序列表</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>语文<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>数学<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>英语<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ol–有序列表</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>北京<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>成都<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>大连<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span><br></code></pre></td></tr></table></figure><p>dl–自定义列表</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">dl</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dt</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">dt</span>&gt;</span><br><span class="hljs-comment">&lt;!--对列表进行分组--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br><span class="hljs-comment">&lt;!--分组下的内容--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dt</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">dt</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span>one<span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span>two<span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dl</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>图片</strong><br>img标签  –&gt;  单标签</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;img/guidao.jpg&quot;</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;鬼刀&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;加载失败&quot;</span>/&gt;</span><br><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">src属性：图片地址</span><br><span class="hljs-comment">title属性：鼠标放上去显示信息</span><br><span class="hljs-comment">alt属性：用来设置图片加载失败的时候的提示信息</span><br><span class="hljs-comment">--&gt;</span><br></code></pre></td></tr></table></figure><p><strong>超链接</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs html">href属性<br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://www.baidu.com&quot;</span>&gt;</span>百度<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span>刷新<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#1&quot;</span>&gt;</span>第一张<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">  href属性：跳转到目标对应的地址</span><br><span class="hljs-comment">  如果href属性值为空，对应是刷新功能</span><br><span class="hljs-comment">  选择器：可以跳转到对应位置（在之前标签设置id值）</span><br><span class="hljs-comment">  </span><br><span class="hljs-comment">        --&gt;</span><br>target属性<br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_self&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--默认当前页面刷新出指定内容--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-comment">&lt;!--创建一个新的页面，在新的页面中刷新出指定内容--&gt;</span><br></code></pre></td></tr></table></figure><p><strong>表格</strong><br>table标签、tr标签、td标签、th标签</p><p>快捷创建表格：table&gt;tr<em>n&gt;tr</em>m 然后tab补全。<br>创建一个n行m列的表格</p><p>表格边框为1处理：边框设置为0，表格颜色和单元格颜色不同即可。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">border</span>=<span class="hljs-string">&quot;1&quot;</span> <span class="hljs-attr">bordercolor</span>=<span class="hljs-string">&quot;red&quot;</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">&quot;aquamarine&quot;</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;center&quot;</span> <span class="hljs-attr">cellspacing</span>=<span class="hljs-string">&quot;1&quot;</span> <span class="hljs-attr">cellpadding</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>成绩表<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>成绩<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>是否留级<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>星辰<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>90<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>否<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>云落<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>85<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>否<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">table：表格整体</span><br><span class="hljs-comment">border：表格边框宽度</span><br><span class="hljs-comment">bordercolor：表格颜色</span><br><span class="hljs-comment">bgcolor：背景颜色</span><br><span class="hljs-comment">cellspacing：单元格和单元格之间的间隙</span><br><span class="hljs-comment">cellpadding：单元格和内容之间的间隙</span><br><span class="hljs-comment">      tr：行</span><br><span class="hljs-comment">      td：单元格</span><br><span class="hljs-comment">      th：表头</span><br><span class="hljs-comment">      align：设置对齐方式（可以作用于表，行，单元格）</span><br><span class="hljs-comment">      --&gt;</span><br></code></pre></td></tr></table></figure><p><strong>复杂表格的过程：</strong><br>先确定表格最多有多少行，再确定每行有多少个单元格再确定每个单元格是否有合并现象，如果有就设置单元格的colspan属性，如果有列合并就设置单元格rowspan属性。</p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>内存管理</title>
    <link href="/Myblog/2018/09/14/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    <url>/Myblog/2018/09/14/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h4 id="一、python中变量的赋值"><a href="#一、python中变量的赋值" class="headerlink" title="一、python中变量的赋值"></a>一、python中变量的赋值</h4><p>掌握：<br>（1）、数字、字符串、布尔值的缓存<br>（2）、垃圾回收机制中的引用计数机制</p><p>python中所有的数据都是对象，所有的变量都是对象的引用。</p><p>python对数字、字符串和布尔对象进行缓存，让不同的变量赋同样值的这些对象，给得地址是同样的地址。</p><p>总结：<br>1、给一个变量赋值的时候，赋的是数字、字符串、布尔的时候，会先在缓存中看是否存在这个值，若有直接将值对应的地址赋给变量。没有就在缓存中开辟空间存储数据，然后返回地址。<br>2、给一个变量赋值的时候，赋的是除了数字、字符串、布尔以外的值，就直接在内存中开辟空间存储值，返回地址。</p><p>一个变量存了一个对象的地址，那么这个变量就是这个对象的引用。</p><h4 id="二、python中的内存管理"><a href="#二、python中的内存管理" class="headerlink" title="二、python中的内存管理"></a>二、python中的内存管理</h4><p>C的内存管理机制：手动<br>java/oc/python等：拥有一套属于自己的自动内存管理机制。</p><p>1、python通过垃圾回收机制来对内存进行管理的：不定时对程序中的对象进行检测，看是否需要回收（将对象的内存释放）。看是否需要回收旧看对象的引用计数是否为0，为0就回收。</p><p>2、引用计数<br>python中的每个对象在创建的时候就会有一个属性叫引用计数，对应的值是 0 。当对象被引用一次，其引用计数就会加 1 。 当对象的引用减少一个，其引用计数就会减 1 。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> getrefcount<br><br>object1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]<br>object2 = object1<br>a = [object1, <span class="hljs-number">2</span>]<br>print(getrefcount(object1))  #查看引用计数<br># getrefcount函数本身会对查看的对象进行一次引用<br><br><span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><h4 id="三、垃圾回收机制"><a href="#三、垃圾回收机制" class="headerlink" title="三、垃圾回收机制"></a>三、垃圾回收机制</h4><p>垃圾回收机制并不是一旦产生引用计数为 0 的对象就马上回收。而是不定时的对整个程序中的所有对象进行检测，检测对象为 0 才回收。</p><p>检测时间：当当前程序所有的对象引用计数变化的次数达到它的阈值才会对对象进行检测。</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gauss">import gc <br><span class="hljs-meta"># 获取垃圾回收临界值</span><br><span class="hljs-keyword">print</span>(gc.<span class="hljs-built_in">get_threshold</span>())<br><span class="hljs-meta"># 修改垃圾回收临界值</span><br><span class="hljs-keyword">print</span>(gc.<span class="hljs-built_in">set_threshold</span>(<span class="hljs-number">500</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>))<br></code></pre></td></tr></table></figure><h4 id="四、循环引用"><a href="#四、循环引用" class="headerlink" title="四、循环引用"></a>四、循环引用</h4><p><strong>python的垃圾回收机制能够自动解决因为循环引用而导致的内存泄漏问题。</strong></p><p>python里面自动解决循环引用问题引用的其他的引用对象</p><p>检测的时候如果对象（object_i）的引用计数不是0，就备份引用计数值（count_i），去找到引用对象的对象（object_j），然后将（object_j）的引用计数（count_j）减1，如果（count_j）减1后的值是0，那么（count_i）的值就减1，如果减完后的（count_i）的值也是0，那么（object_j）也销毁。</p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>内存管理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>多线程基础</title>
    <link href="/Myblog/2018/09/13/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/"/>
    <url>/Myblog/2018/09/13/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<ul><li><p>进程：正在运行的一个程序，每个进程相互独立，并且运行在其专用且受保护的内存空间里面的。</p></li><li><p>线程：一个进程要想执行任务，必须得有线程（每个进程至少有一个线程），一个进程所有任务都在线程中执行。</p></li><li><p>主线程：每个进程默认有一个线程，这个线程叫主线程。默认情况下，所有的代码都是在主线程中执行的。</p></li><li><p>子线程：一个进程可以有多个线程。除了主线程以外，其他线程需要手动添加。</p></li></ul><p><strong>多线程原理：</strong><br>同一时间，CPU只能处理一条线程，只有1条线程在工作。多线程并发执行，其实就是CPU快速的在多线程之间调度（切换），当CPU调度线程的时间足够快，就造成了多线程并发执行的假象。</p><p><strong>使用情况：</strong><br>让多个任务同时执行。</p><p>补充：<br>a、打印当前时间</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">datetime</span><br><span class="hljs-selector-tag">datetime</span><span class="hljs-selector-class">.datetime</span><span class="hljs-selector-class">.now</span>()<br></code></pre></td></tr></table></figure><p>b、延时</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-keyword">import</span> <span class="hljs-built_in">time</span><br><span class="hljs-built_in">time</span>.sleep(s)<br></code></pre></td></tr></table></figure><h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><h5 id="1、模块"><a href="#1、模块" class="headerlink" title="1、模块"></a>1、模块</h5><p><strong>python中内置模块 threading，用来支持多线程。Thread类的对象就是线程对象，需要线程的时候，就创建这个类或者这个类的子类对象。</strong></p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-keyword">import</span> threading<br></code></pre></td></tr></table></figure><p>获取当前线程对象 &gt;&gt;&gt; 用于测试</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">threading</span><span class="hljs-selector-class">.current_thread</span>()<br></code></pre></td></tr></table></figure><h5 id="2、创建子线程对象"><a href="#2、创建子线程对象" class="headerlink" title="2、创建子线程对象"></a>2、创建子线程对象</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">t1 = threading.Thread(target=download, args=(<span class="hljs-string">&#x27;终结者&#x27;</span>,))<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">target:需要在子线程中调用的函数的函数名，子线程中执行的任务就是函数里面的代码。</span><br><span class="hljs-string">args:函数对应的参数值（元组）</span><br><span class="hljs-string">返回值：创建好的线程对象</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure><h5 id="3、执行"><a href="#3、执行" class="headerlink" title="3、执行"></a>3、执行</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">t1.<span class="hljs-literal">start</span>()<br></code></pre></td></tr></table></figure><p>效果：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> time<br><br>#模拟下载两个电影<br>def download(file):<br>    print(<span class="hljs-string">&#x27;开始下载：&#x27;</span>, datetime.datetime.now())<br>    # 线程阻塞<span class="hljs-number">2</span>s<br>    time.sleep(<span class="hljs-number">2</span>)<br>    print(file+<span class="hljs-string">&#x27;下载结束&#x27;</span>,datetime.datetime.now())<br>    print(threading.current_thread())<br>t1 = threading.Thread(target=download, args=(<span class="hljs-string">&#x27;终结者2&#x27;</span>,))<br>t1.start()<br>t2 = threading.Thread(target=download, args=(<span class="hljs-string">&#x27;沉默的羔羊&#x27;</span>,))<br>t2.start()<br>download(<span class="hljs-string">&#x27;终结者1&#x27;</span>)<br><br>开始下载： <span class="hljs-number">2018</span><span class="hljs-number">-09</span><span class="hljs-number">-13</span> <span class="hljs-number">11</span>:<span class="hljs-number">08</span>:<span class="hljs-number">56.927703</span><br>开始下载： <span class="hljs-number">2018</span><span class="hljs-number">-09</span><span class="hljs-number">-13</span> <span class="hljs-number">11</span>:<span class="hljs-number">08</span>:<span class="hljs-number">56.928703</span><br>开始下载： <span class="hljs-number">2018</span><span class="hljs-number">-09</span><span class="hljs-number">-13</span> <span class="hljs-number">11</span>:<span class="hljs-number">08</span>:<span class="hljs-number">56.928703</span><br>终结者<span class="hljs-number">2</span>下载结束 <span class="hljs-number">2018</span><span class="hljs-number">-09</span><span class="hljs-number">-13</span> <span class="hljs-number">11</span>:<span class="hljs-number">08</span>:<span class="hljs-number">58.927818</span><br>&lt;Thread(Thread<span class="hljs-number">-1</span>, started <span class="hljs-number">2324</span>)&gt;<br>沉默的羔羊下载结束 <span class="hljs-number">2018</span><span class="hljs-number">-09</span><span class="hljs-number">-13</span> <span class="hljs-number">11</span>:<span class="hljs-number">08</span>:<span class="hljs-number">58.928818</span><br>&lt;Thread(Thread<span class="hljs-number">-2</span>, started <span class="hljs-number">5908</span>)&gt;<br>终结者<span class="hljs-number">1</span>下载结束 <span class="hljs-number">2018</span><span class="hljs-number">-09</span><span class="hljs-number">-13</span> <span class="hljs-number">11</span>:<span class="hljs-number">08</span>:<span class="hljs-number">58.928818</span><br>&lt;_MainThread(MainThread, started <span class="hljs-number">5852</span>)&gt;<br></code></pre></td></tr></table></figure><h3 id="方式二—面向对象的多线程技术（重点）"><a href="#方式二—面向对象的多线程技术（重点）" class="headerlink" title="方式二—面向对象的多线程技术（重点）"></a>方式二—面向对象的多线程技术（重点）</h3><h6 id="1、声明一个类继承自Thread类"><a href="#1、声明一个类继承自Thread类" class="headerlink" title="1、声明一个类继承自Thread类"></a>1、声明一个类继承自Thread类</h6><h6 id="2、重写run方法，将需要在子线程中执行的任务放到run方法中"><a href="#2、重写run方法，将需要在子线程中执行的任务放到run方法中" class="headerlink" title="2、重写run方法，将需要在子线程中执行的任务放到run方法中"></a>2、重写run方法，将需要在子线程中执行的任务放到run方法中</h6><h6 id="3、在需要子线程的位置去创建这个类的对象，然后调用start-方法去执行run中的任务。"><a href="#3、在需要子线程的位置去创建这个类的对象，然后调用start-方法去执行run中的任务。" class="headerlink" title="3、在需要子线程的位置去创建这个类的对象，然后调用start 方法去执行run中的任务。"></a>3、在需要子线程的位置去创建这个类的对象，然后调用start 方法去执行run中的任务。</h6><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">class</span> DownLoadThread(Thread):<br>    <span class="hljs-keyword">def</span> __init__(self, <span class="hljs-keyword">file</span>):<br>        <span class="hljs-keyword">super</span>().__init__()<br>        self.<span class="hljs-keyword">file</span> = <span class="hljs-keyword">file</span><br><br>    <span class="hljs-keyword">def</span> run(self):<br>        <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;开始下载:&lt;%s&gt;  时间：%s&#x27;</span>%(self.<span class="hljs-keyword">file</span>,datetime.datetime.now()))<br>        time.sleep(<span class="hljs-number">5</span>)<br>        <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;下载结束:&lt;%s&gt;！  时间：%s&#x27;</span>%(self.<span class="hljs-keyword">file</span>,datetime.datetime.now()))<br><br><span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;===========&#x27;</span>)<br><br>t1 = DownLoadThread(<span class="hljs-string">&#x27;沉默的羔羊&#x27;</span>)<br>t1.start()<br><br><span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;+++++++++++&#x27;</span>)<br><br>结果：<br>===========<br>开始下载:&lt;沉默的羔羊&gt;  时间：<span class="hljs-number">2018</span>-<span class="hljs-number">09</span>-<span class="hljs-number">13</span> <span class="hljs-number">11</span>:<span class="hljs-number">26</span>:<span class="hljs-number">42.730664</span><br>+++++++++++<br>下载结束:&lt;沉默的羔羊&gt;！  时间：<span class="hljs-number">2018</span>-<span class="hljs-number">09</span>-<span class="hljs-number">13</span> <span class="hljs-number">11</span>:<span class="hljs-number">26</span>:<span class="hljs-number">47.730950</span><br></code></pre></td></tr></table></figure><h3 id="三、join方法的使用"><a href="#三、join方法的使用" class="headerlink" title="三、join方法的使用"></a>三、join方法的使用</h3><p><strong>如果希望某个线程结束后才执行某个操作，就用线程对象调用 join（）</strong></p><p>start（）会自动调用run（）</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">from</span> threading <span class="hljs-keyword">import</span> Thread<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">DownLoadThread</span>(<span class="hljs-type">Thread</span>):</span><br><span class="hljs-class">    def __init__(<span class="hljs-title">self</span>, <span class="hljs-title">file</span>):</span><br><span class="hljs-class">        super().__init__()</span><br><span class="hljs-class">        self.file = file</span><br><span class="hljs-class"></span><br><span class="hljs-class">    def run(<span class="hljs-title">self</span>):</span><br><span class="hljs-class">        print(<span class="hljs-title">self</span>.<span class="hljs-title">file</span>+&#x27; 开始下载&#x27;, <span class="hljs-title">datetime</span>.<span class="hljs-title">datetime</span>.<span class="hljs-title">now</span>())</span><br><span class="hljs-class">        time.sleep(<span class="hljs-title">random</span>.<span class="hljs-title">randint</span>(5,15))</span><br><span class="hljs-class">        print(<span class="hljs-title">self</span>.<span class="hljs-title">file</span>+&#x27; 下载结束&#x27;, <span class="hljs-title">datetime</span>.<span class="hljs-title">datetime</span>.<span class="hljs-title">now</span>())</span><br><span class="hljs-class"></span><br><span class="hljs-class"></span><br><span class="hljs-class">t1 = <span class="hljs-type">DownLoadThread</span>(&#x27;美丽人生&#x27;)</span><br><span class="hljs-class">t2 = <span class="hljs-type">DownLoadThread</span>(&#x27;怦然心动&#x27;)</span><br><span class="hljs-class"></span><br><span class="hljs-class">start = time.time()</span><br><span class="hljs-class"></span><br><span class="hljs-class">t1.start()</span><br><span class="hljs-class">t2.start()</span><br><span class="hljs-class"></span><br><span class="hljs-class">#t1,t2都结束才执行</span><br><span class="hljs-class">t1.join()   #后面的代码在t1对应的线程结束后才执行</span><br><span class="hljs-class">t2.join()   #后面的代码在t1对应的线程结束后才执行</span><br><span class="hljs-class">end = time.time()</span><br><span class="hljs-class">print(<span class="hljs-title">end</span> - <span class="hljs-title">start</span>)</span><br><span class="hljs-class"></span><br><span class="hljs-class">结果：</span><br><span class="hljs-class">美丽人生 开始下载 2018-09-13 13:36:42.334387</span><br><span class="hljs-class">怦然心动 开始下载 2018-09-13 13:36:42.334387</span><br><span class="hljs-class">美丽人生 下载结束 2018-09-13 13:36:49.334787</span><br><span class="hljs-class">怦然心动 下载结束 2018-09-13 13:36:50.336844</span><br><span class="hljs-class">8.00445818901062</span><br></code></pre></td></tr></table></figure><h3 id="四、多线程的数据混乱问题"><a href="#四、多线程的数据混乱问题" class="headerlink" title="四、多线程的数据混乱问题"></a>四、多线程的数据混乱问题</h3><p><img src="https://upload-images.jianshu.io/upload_images/13692175-6855fb18bc2556d3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p>尽量避免多个线程对同一个数据进行操作</p><p><strong>解决方法：对相关代码加锁，让同一时间只有能有一个线程进行操作，释放后，才能让其它线程操作</strong></p><p>锁： 同步锁（RLock） 和 互斥锁（Lock）– 了解</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> <span class="hljs-keyword">Lock</span><br></code></pre></td></tr></table></figure><h6 id="1、创建锁对象"><a href="#1、创建锁对象" class="headerlink" title="1、创建锁对象"></a>1、创建锁对象</h6><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">self.lock</span> = Lock()<br><span class="hljs-comment"># 一般写在__init__方法中</span><br></code></pre></td></tr></table></figure><h6 id="2、加锁"><a href="#2、加锁" class="headerlink" title="2、加锁"></a>2、加锁</h6><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-keyword">self</span>.lock.acquire()<br><span class="hljs-comment"># 线程操作前</span><br></code></pre></td></tr></table></figure><h6 id="3、解锁"><a href="#3、解锁" class="headerlink" title="3、解锁"></a>3、解锁</h6><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-keyword">self</span>.lock.release()<br><span class="hljs-comment">#  线程操作后</span><br></code></pre></td></tr></table></figure><p>实例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;__author__=Deathfeeling&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread, Lock<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;账号类&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, balance</span>):</span><br>        self.balance = balance<br>        <span class="hljs-comment"># 创建锁对象</span><br>        self.lock = Lock()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_money</span>(<span class="hljs-params">self, amount</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;存钱&quot;&quot;&quot;</span><br>        print(<span class="hljs-string">&#x27;开始存钱&#x27;</span>)<br><br>        <span class="hljs-comment"># 加锁</span><br>        self.lock.acquire()<br>        old_amount = self.balance<br>        time.sleep(<span class="hljs-number">2</span>)<br>        self.balance = old_amount + amount<br>        print(<span class="hljs-string">&#x27;存钱成功！最新余额是：&#x27;</span>,self.balance)<br><br>        <span class="hljs-comment"># 解锁</span><br>        self.lock.release()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_money</span>(<span class="hljs-params">self, amount</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;取钱&quot;&quot;&quot;</span><br>        self.lock.acquire()<br>        print(<span class="hljs-string">&#x27;开始取钱&#x27;</span>)<br>        old_amount = self.balance<br>        <span class="hljs-keyword">if</span> old_amount &lt; amount:<br>            print(<span class="hljs-string">&#x27;余额不足&#x27;</span>)<br>            <span class="hljs-keyword">return</span><br>        time.sleep(<span class="hljs-number">2</span>)<br>        self.balance = old_amount - amount<br>        print(<span class="hljs-string">&#x27;取钱成功！最新余额是：&#x27;</span>, self.balance)<br>        self.lock.release()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show_balance</span>(<span class="hljs-params">self</span>):</span><br>        print(<span class="hljs-string">&#x27;当前余额：&#x27;</span>, self.balance)<br><br><br>account = Account(<span class="hljs-number">1000</span>)<br><span class="hljs-comment"># account.save_money(200)</span><br><span class="hljs-comment"># account.get_money(100)</span><br><span class="hljs-comment"># account.show_balance()</span><br>t1 = Thread(target=account.save_money, args=(<span class="hljs-number">200</span>,))<br>t2 = Thread(target=account.save_money, args=(<span class="hljs-number">300</span>,))<br>t1.start()<br>t2.start()<br><br>结果：<br>开始存钱<br>开始存钱<br>存钱成功！最新余额是： <span class="hljs-number">1200</span><br>存钱成功！最新余额是： <span class="hljs-number">1500</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>多线程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>socket编程</title>
    <link href="/Myblog/2018/09/12/socket%E7%BC%96%E7%A8%8B/"/>
    <url>/Myblog/2018/09/12/socket%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<p>socket又叫套接字，就是进行数据通信两端。分为服务器套接字和客户端套接字。<br>套接字编程：自己写服务器或者客户端，进行数据传输。</p><p>python对socket编程的支持：提供一个socket库（内置）</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-keyword">import</span> socket<br></code></pre></td></tr></table></figure><h3 id="一、服务器端（socket）"><a href="#一、服务器端（socket）" class="headerlink" title="一、服务器端（socket）"></a>一、服务器端（socket）</h3><h6 id="1、创建套接字对象"><a href="#1、创建套接字对象" class="headerlink" title="1、创建套接字对象"></a>1、创建套接字对象</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros">def creat_server():<br>    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">    socket(family,type)</span><br><span class="hljs-string">    a.family：确定IP协议类型</span><br><span class="hljs-string">    AF_INET:ipv4（默认）</span><br><span class="hljs-string">    AF_INET6:ipv6</span><br><span class="hljs-string">    b.type:传输协议类型</span><br><span class="hljs-string">    SOCK_STREAM:TCP协议（默认）</span><br><span class="hljs-string">    SOCK_DGRAM:UDP协议</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>   <span class="hljs-built_in"> server </span>= socket.socket()<br></code></pre></td></tr></table></figure><h6 id="2、绑定IP地址和端口"><a href="#2、绑定IP地址和端口" class="headerlink" title="2、绑定IP地址和端口"></a>2、绑定IP地址和端口</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">端口：一台电脑上一个端口标记一个唯一的服务。范围0~65535,0~1014是著名端口，专门标记一个特殊服务，一般不适用。</span><br><span class="hljs-string">注意：同一端口同一时间只能绑定一个服务。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>server.bind((<span class="hljs-string">&quot;10.7.153.113&quot;</span>,<span class="hljs-number">8080</span>))<br></code></pre></td></tr></table></figure><h6 id="3、监听（客户端请求）"><a href="#3、监听（客户端请求）" class="headerlink" title="3、监听（客户端请求）"></a>3、监听（客户端请求）</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">listen(个数)</span><br><span class="hljs-string">同一时间能够连接的客户端个数。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>server.listen()<br></code></pre></td></tr></table></figure><h6 id="4、让服务器处于运行状态"><a href="#4、让服务器处于运行状态" class="headerlink" title="4、让服务器处于运行状态"></a>4、让服务器处于运行状态</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    print(<span class="hljs-string">&#x27;监听状态！&#x27;</span>)<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    连接客户端（建立连接）,返回连接对象和客户端地址。</span><br><span class="hljs-string">    这句代码会阻塞线程，直到有客户端来请求当前服务器为止。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    connect, addr = server.accept()<br><br>    print(addr)<br></code></pre></td></tr></table></figure><h6 id="5、服务器给客户端发送消息"><a href="#5、服务器给客户端发送消息" class="headerlink" title="5、服务器给客户端发送消息"></a>5、服务器给客户端发送消息</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">send(data)</span><br><span class="hljs-string">date：python3中要求类型是bytes，python2中可以是字符串。</span><br><span class="hljs-string">字符串 &gt;&gt;&gt;&gt; 二进制 ：</span><br><span class="hljs-string">1、字符串.encode（编码方式）默认utf-8</span><br><span class="hljs-string">2、bytes(字符串，编码方式)默认None</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>connect.send(<span class="hljs-string">&#x27;你好！&#x27;</span>.encode())<br>connect.send(bytes(<span class="hljs-string">&#x27;你好&#x27;</span>,<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br></code></pre></td></tr></table></figure><h6 id="6、接收从客户端发送过来的消息"><a href="#6、接收从客户端发送过来的消息" class="headerlink" title="6、接收从客户端发送过来的消息"></a>6、接收从客户端发送过来的消息</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">recv(bufsize)</span><br><span class="hljs-string">bufsize:每次能够接收的最大字节数</span><br><span class="hljs-string">返回值：接收到的数据（二进制）</span><br><span class="hljs-string">二进制 &gt;&gt;&gt; 字符串：</span><br><span class="hljs-string">1、二进制.decode()</span><br><span class="hljs-string">2、str(二进制，编码方式)</span><br><span class="hljs-string">注意：recv方法也会阻塞线程。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>recv_data = connect.recv(<span class="hljs-number">1024</span>)<br>print(recv_data.decode())<br>print(str(recv_data, <span class="hljs-string">&#x27;utf-8&#x27;</span>))<br></code></pre></td></tr></table></figure><h6 id="7、断开连接"><a href="#7、断开连接" class="headerlink" title="7、断开连接"></a>7、断开连接</h6><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-built_in">connect</span>.<span class="hljs-built_in">close</span>()<br></code></pre></td></tr></table></figure><h3 id="二、客户端（socket）"><a href="#二、客户端（socket）" class="headerlink" title="二、客户端（socket）"></a>二、客户端（socket）</h3><h6 id="1、创建套接字对象-1"><a href="#1、创建套接字对象-1" class="headerlink" title="1、创建套接字对象"></a>1、创建套接字对象</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import socket<br>def creat_client():<br>   <span class="hljs-built_in"> client </span>= socket.socket()<br></code></pre></td></tr></table></figure><h6 id="2、连接服务器"><a href="#2、连接服务器" class="headerlink" title="2、连接服务器"></a>2、连接服务器</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">connect(服务器地址,端口)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>client.connect((<span class="hljs-string">&#x27;10.7.153.113&#x27;</span>, <span class="hljs-number">8080</span>))<br></code></pre></td></tr></table></figure><h6 id="3、接收服务器发送的消息"><a href="#3、接收服务器发送的消息" class="headerlink" title="3、接收服务器发送的消息"></a>3、接收服务器发送的消息</h6><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword">data</span> = client.recv(1024)</span><br><span class="hljs-title">print</span>(<span class="hljs-class"><span class="hljs-keyword">data</span>.decode(<span class="hljs-title">encoding</span>=&#x27;<span class="hljs-title">utf</span>-8&#x27;))</span><br></code></pre></td></tr></table></figure><h6 id="4、给服务器发送消息"><a href="#4、给服务器发送消息" class="headerlink" title="4、给服务器发送消息"></a>4、给服务器发送消息</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">client.<span class="hljs-built_in">send</span>(<span class="hljs-string">&#x27;我是客户端~~&#x27;</span>.encode())<br></code></pre></td></tr></table></figure><h6 id="5、断开连接"><a href="#5、断开连接" class="headerlink" title="5、断开连接"></a>5、断开连接</h6><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">client.<span class="hljs-built_in">close</span>()<br></code></pre></td></tr></table></figure><p><strong>实例一：通信</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 服务器端</span><br><span class="hljs-string">&quot;&quot;&quot;__author__=Deathfeeling&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">creat_server</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;写一个服务器&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 1、创建套接字对象</span><br>    server = socket.socket()<br><br>    <span class="hljs-comment"># 2、绑定IP地址和端口</span><br>    server.bind((<span class="hljs-string">&quot;10.7.153.113&quot;</span>,<span class="hljs-number">8080</span>))<br><br>    <span class="hljs-comment"># 3、监听（客户端请求）</span><br>    server.listen(<span class="hljs-number">5</span>)<br>    print(<span class="hljs-string">&#x27;监听状态！&#x27;</span>)<br>    connect, addr = server.accept()<br>    <br>    <span class="hljs-comment"># 4、让服务器处于运行状态</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        mesag = input(<span class="hljs-string">&#x27;服务器：&#x27;</span>)<br>        connect.send(mesag.encode())<br><br>        <span class="hljs-comment">#6、接收从客户端发送过来的消息</span><br>        recv_data = connect.recv(<span class="hljs-number">1024</span>)<br>        print(recv_data.decode())<br><br>    <span class="hljs-comment">#7、断开连接</span><br>    connect.close()<br><br>creat_server()<br><br><span class="hljs-comment"># 客户端</span><br><span class="hljs-string">&quot;&quot;&quot;__author__=Deathfeeling&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">creat_client</span>():</span><br>    <span class="hljs-comment"># 1、创建套接字对象</span><br>    client = socket.socket()<br><br>    <span class="hljs-comment"># 2、连接服务器</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    connect(服务器地址)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    client.connect((<span class="hljs-string">&#x27;10.7.153.113&#x27;</span>, <span class="hljs-number">8080</span>))<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment"># 3、接收服务器发送的消息</span><br>        data = client.recv(<span class="hljs-number">1024</span>)<br>        print(data.decode(encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><br>        <span class="hljs-comment"># 4、给服务器发送消息</span><br>        mesag = input(<span class="hljs-string">&#x27;客户端：&#x27;</span>)<br>        client.send(mesag.encode())<br><br>    <span class="hljs-comment"># 5、断开连接</span><br>    client.close()<br><br>creat_client()<br></code></pre></td></tr></table></figure><p><strong>实例二：下载图片</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#图片服务器</span><br><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;__author__=Deathfeeling&quot;</span><span class="hljs-string">&quot;&quot;</span><br><br>import socket<br><br>server = socket.socket()<br>server.bind((<span class="hljs-string">&#x27;10.7.153.113&#x27;</span>, 8082))<br>server.listen(100)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    connect,addr = server.accept()<br><br>    with open(<span class="hljs-string">&#x27;./beauty.png&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>) as f:<br>        data = f.read()<br>    connect.send(data)<br><br>    connect.close()<br><br><span class="hljs-comment">#图片客户端</span><br><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;__author__=Deathfeeling&quot;</span><span class="hljs-string">&quot;&quot;</span><br><br>import socket<br><br>client = socket.socket()<br>client.connect((<span class="hljs-string">&#x27;10.7.153.113&#x27;</span>,8082))<br><br><span class="hljs-comment">#创建一个空的二进制数据</span><br>all_data = bytes()<br>data = client.recv(1024)<br><span class="hljs-keyword">while</span> data:<br>    <span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;正在接收~~~&#x27;</span>)<br>    #拼接二进制数据，得到完整的图片<br>    all_data += data <br>    data = client.recv(1024)<br><span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;接收完毕！&#x27;</span>)<br><span class="hljs-comment">#写入在本地</span><br>with open(<span class="hljs-string">&#x27;./new.png&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>) as f:<br>    f.write(all_data)<br>client.close()<br></code></pre></td></tr></table></figure><h3 id="三、网络请求"><a href="#三、网络请求" class="headerlink" title="三、网络请求"></a>三、网络请求</h3><p><strong>get方法</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;__author__=Deathfeeling&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-comment"># 1、准备url</span><br>url = <span class="hljs-string">&#x27;https://www.apiopen.top/satinApi?type=1&amp;page=1&#x27;</span><br><br><span class="hljs-comment"># 2、发送请求（get）</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">get(url,参数对应的字典)</span><br><span class="hljs-string">post(url,参数对应的字典)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = requests.get(url)<br><span class="hljs-comment"># requests.get(&#x27;https://www.apiopen.top/satinApi&#x27;,&#123;&#x27;type&#x27;=1,&#x27;page&#x27;=1&#125;)</span><br><span class="hljs-comment"># print(response)</span><br><br><span class="hljs-comment"># 3、通过相应获取服务器返回的数据</span><br><span class="hljs-comment"># a、获取字符串类型的数据</span><br>print(response.text)<br><br><span class="hljs-comment"># b、获取json的数据</span><br>print(response.json)<br><br><span class="hljs-comment"># c、获取二进制格式的数据</span><br>print(response.content)<br><br><span class="hljs-comment"># d、获取响应头（了解）</span><br>print(response.headers)<br><br></code></pre></td></tr></table></figure><h6 id="post类似，但是需要有对应的post接口。"><a href="#post类似，但是需要有对应的post接口。" class="headerlink" title="post类似，但是需要有对应的post接口。"></a>post类似，但是需要有对应的post接口。</h6><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a><strong>练习</strong></h2><p>1. 客户端和服务器聊天，可以一直聊天，直到一方发送’拜拜’。然后就可以和下一个人一直聊     </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#服务端</span><br><span class="hljs-string">&quot;&quot;&quot;__author__=Deathfeeling&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">creat_server</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;写一个服务器&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 1、创建套接字对象</span><br>    server = socket.socket()<br><br>    <span class="hljs-comment"># 2、绑定IP地址和端口</span><br>    server.bind((<span class="hljs-string">&quot;10.7.153.113&quot;</span>,<span class="hljs-number">8080</span>))<br><br>    <span class="hljs-comment"># 3、监听（客户端请求）</span><br>    server.listen(<span class="hljs-number">5</span>)<br>    print(<span class="hljs-string">&#x27;监听状态！&#x27;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        connect, addr = server.accept()<br>        <span class="hljs-comment"># 4、让服务器处于运行状态</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            mesag = input(<span class="hljs-string">&#x27;服务器：&#x27;</span>)<br>            <span class="hljs-keyword">if</span> mesag == <span class="hljs-string">&#x27;拜拜&#x27;</span>:<br>                print(<span class="hljs-string">&#x27;客户端已下线！&#x27;</span>)<br>                connect.close()<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                connect.send(mesag.encode())<br><br>            <span class="hljs-comment"># 6、接收从客户端发送过来的消息</span><br>            recv_data = connect.recv(<span class="hljs-number">1024</span>)<br>            <span class="hljs-keyword">if</span> recv_data.decode() == <span class="hljs-string">&#x27;拜拜&#x27;</span>:<br>                print(<span class="hljs-string">&#x27;客户端已下线！&#x27;</span>)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                print(<span class="hljs-string">&#x27;客户端：&#x27;</span>, recv_data.decode())<br><br><br>creat_server()<br><br><span class="hljs-comment">#客户端</span><br><span class="hljs-string">&quot;&quot;&quot;__author__=Deathfeeling&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">creat_client</span>():</span><br>    <span class="hljs-comment"># 1、创建套接字对象</span><br>    client = socket.socket()<br><br>    <span class="hljs-comment"># 2、连接服务器</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    connect(服务器地址)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    client.connect((<span class="hljs-string">&#x27;10.7.153.113&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment"># 3、接收服务器发送的消息</span><br>        data = client.recv(<span class="hljs-number">1024</span>)<br>        print(<span class="hljs-string">&#x27;服务器：&#x27;</span>, data.decode(encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><br>        <span class="hljs-comment"># 4、给服务器发送消息</span><br>        mesag = input(<span class="hljs-string">&#x27;客户端：&#x27;</span>)<br>        <span class="hljs-keyword">if</span> mesag == <span class="hljs-string">&#x27;拜拜&#x27;</span>:<br>            client.send(mesag.encode())<br>            print(<span class="hljs-string">&#x27;已下线！&#x27;</span>)<br>            client.close()<br>        <span class="hljs-keyword">else</span>:<br>            client.send(mesag.encode())<br><br><br>creat_client()<br></code></pre></td></tr></table></figure><p>2. 下载网络图片（<a href="https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=2808438283,4249462766&amp;fm=26&amp;gp=0.jpg%EF%BC%89%E5%88%B0%E6%9C%AC%E5%9C%B0">https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=2808438283,4249462766&amp;fm=26&amp;gp=0.jpg）到本地</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;__author__=Deathfeeling&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&#x27;https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=2808438283,4249462766&amp;fm=26&amp;gp=0.jpg&#x27;</span><br>pic = bytes()<br>response = requests.get(url)<br>pic += response.content<br><span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;./pic.jpg&#x27;</span>,<span class="hljs-string">&#x27;ab&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(pic)<br></code></pre></td></tr></table></figure><p>下载的图片如下：<br><img src="https://upload-images.jianshu.io/upload_images/13692175-71fc7380f0b5762d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="pic.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>socket</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>正则表达式</title>
    <link href="/Myblog/2018/09/11/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <url>/Myblog/2018/09/11/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p><code>正则表达式就是用来检测字符串是否满足某种规则的工具</code><br>例如：匹配手机号、邮箱、脏话检测等</p><h4 id="1、单字符"><a href="#1、单字符" class="headerlink" title="1、单字符"></a>1、单字符</h4><p>python对正则表达式的支持，提供了一个内置模块：re</p><p><code>fullmatch</code>（正则表达式，字符串）：查找字符串中是否有符合正则表达式规则，不符合返回None。</p><p><code>search</code>（正则表达式，字符串）：判断整个字符串是否符合正则表达式规则，不符合返回None。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">from</span> re <span class="hljs-keyword">import</span> fullmatch<br></code></pre></td></tr></table></figure><p><code>匹配对应字符（占位）</code></p><p>（1）<code>.</code> ：匹配一位任意字符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">re_str = <span class="hljs-string">r&#x27;.&#x27;</span>   <span class="hljs-comment">#阻止转义</span><br>print(fullmatch(re_str,<span class="hljs-string">&#x27;a&#x27;</span>))<br><br>&lt;_sre.SRE_Match object; span=(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>), match=<span class="hljs-string">&#x27;a&#x27;</span>&gt;<br></code></pre></td></tr></table></figure><p>（2）<code>\w</code>：匹配一位字母、数字、下划线。<br>（3）<code>\s</code>：匹配空白字符（空格、制表符<code>\t</code>、回车<code>\n</code>等所有能产生空白的字符）。<br>（4）<code>\d</code>：匹配一个数字字符。<br>（5）<code>\W</code>：匹配一个非字母、数字、下划线（<code>\w</code>取反）<br>（6）<code>\S</code>：匹配非空白字符<br>（7）<code>\D</code>：匹配非数字字符</p><p><code>位置检测（不占位）</code></p><p>（8）<code>\b</code>：检测是否是单词边界, <code>\b</code> 不占位，并且必须所在位置是单词边界，否则匹配不成功。<br>注意：<br>re_str = r’when\bwhere’<br><del>print(fullmatch(re_str,’whenwhere’)）</del><br><del>print(fullmatch(re_str,’when where’))</del></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">re_str = <span class="hljs-string">r&#x27;when\b\swhere&#x27;</span><br>print(fullmatch(re_str,<span class="hljs-string">&#x27;when where&#x27;</span>))<br></code></pre></td></tr></table></figure><p>（9）<code>\B</code>：检测非单词边界<br>（10）<code>^</code>：检测字符串是否以给定的正则表达式开头。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">re_str = <span class="hljs-string">r&#x27;^sd&#x27;</span><br>print(search(re_str,<span class="hljs-string">&#x27;sdwfe&#x27;</span>))<br><br>&lt;_sre.SRE_Match object; span=(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>), match=<span class="hljs-string">&#x27;sd&#x27;</span>&gt;<br></code></pre></td></tr></table></figure><p>（11）<code>$</code>：字符串是否以给定的正则表达式结束。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">re_str = <span class="hljs-string">r&#x27;fe$&#x27;</span><br>print(search(re_str,<span class="hljs-string">&#x27;sdwfe&#x27;</span>))<br></code></pre></td></tr></table></figure><h4 id="2、匹配次数"><a href="#2、匹配次数" class="headerlink" title="2、匹配次数"></a>2、匹配次数</h4><p>注意：次数相关的操作，只约束次数符合前的一个字符。</p><p>在匹配次数的字符后加 <code>?</code> , 表示尽可能少的次数匹配。</p><p>（1）<code>[]</code>：匹配中括号中出现的任意字符，只匹配一个字符。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">re_str = <span class="hljs-string">r&#x27;[abc]\d\d&#x27;</span><br><span class="hljs-comment">#匹陪第一个字符是否是[]中的一个字符</span><br>print(fullmatch(re_str,<span class="hljs-string">&#x27;c11&#x27;</span>))<br><br>&lt;_sre.SRE_Match object; span=(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>), match=<span class="hljs-string">&#x27;c11&#x27;</span>&gt;<br></code></pre></td></tr></table></figure><p><code>减号（-） =&gt;  在正则的中括号中的应用</code><br><code>[1-8]</code>    =&gt;    代表字符集：12345678<br><code>[-18]</code> or <code>[18-]</code>    —&gt;    代表字符集：<code>&#39;-&#39;、&#39;1&#39;、&#39;8&#39;</code></p><p>（2）<code>[^字符集]</code>：匹配不再[]字符集中的任意一个字符。</p><p>（3） <code>*</code>：匹配 <code>*</code> 号前的字符0次或者多次。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">re_str = <span class="hljs-string">r&#x27;a*b&#x27;</span>    <span class="hljs-comment">#a能匹配多次，b依次</span><br>print(fullmatch(re_str, <span class="hljs-string">&#x27;aaab&#x27;</span>))<br><br>&lt;_sre.SRE_Match object; span=(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>), match=<span class="hljs-string">&#x27;aaab&#x27;</span>&gt;<br></code></pre></td></tr></table></figure><p><code>re_str = r&#39;[abc]*&#39;  =&gt;  &#39;a&#39;, &#39;abb&#39;, &#39;accb&#39;</code></p><p>（4） <code>+</code>：+前的字符集至少匹配一次。<br>re_str：<code>r&#39;[1-9]+\d*&#39;</code>   =&gt;     首位不是0的数字集</p><p>（5）<code>？</code>：匹配 0次 或者 1次。</p><p>（6）<code>&#123;N&#125;</code>：匹配N次。<br><code>re__str = r&#39;\d&#123;3&#125;&#39;</code>   =&gt;  匹配 <code>\d</code> 3次</p><p>（7）<code>&#123;N，&#125;</code>：至少匹配N次。</p><p>（8）<code>&#123;N，M&#125;</code>至少匹配N次，最多M次。（M&gt;N）</p><p>练习：输入用户名，必须是字母数字下划线组成，6-20位<br>qq必须是数字组成，不能0开头，4-11位</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> re <span class="hljs-keyword">import</span> fullmatch<br><br>name = input(<span class="hljs-string">&#x27;请输入用户名：&#x27;</span>)<br><span class="hljs-keyword">if</span> fullmatch(<span class="hljs-string">r&#x27;\w&#123;6,20&#125;&#x27;</span>,用户名):<br>    print(<span class="hljs-string">&#x27;输入用户名合法&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    print(<span class="hljs-string">&#x27;用户名不合法&#x27;</span>)<br>QQ = input(<span class="hljs-string">&#x27;请输入QQ：&#x27;</span>)<br><span class="hljs-keyword">if</span> fullmatch(<span class="hljs-string">r&#x27;[1-9]\d&#123;4,11&#125;&#x27;</span>,QQ):<br>    print(<span class="hljs-string">&#x27;输入QQ合法&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    print(<span class="hljs-string">&#x27;QQ不合法&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="3、分支和分组"><a href="#3、分支和分组" class="headerlink" title="3、分支和分组"></a>3、分支和分组</h4><p><code>注意：正则中的分支有短路条件，如果使用 | 去连接多个条件，前面的条件如果已经匹配出结果，后面就不会匹配了。</code></p><p><strong>（1）分支</strong><br><code>|</code>：或（相当于逻辑运算中的or）</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">re_str = <span class="hljs-string">r&#x27;[a-zA-Z]&#123;3&#125;|\d&#123;3&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p><code>|</code> ：前后是两种条件，分别是一个整体。</p><p><strong>（2）分组</strong><br><code>通过加（）来对正则条件进行分组。</code><br>a、分组</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">re_str = <span class="hljs-string">r&#x27;([a-z]&#123;2&#125;\d&#123;2&#125;)&#123;3&#125;&#x27;</span><br>print(fullmatch(re_str,<span class="hljs-string">&#x27;ac23gd45fd77&#x27;</span>))<br><br>&lt;_sre.SRE_Match object; span=(<span class="hljs-number">0</span>, <span class="hljs-number">12</span>), match=<span class="hljs-string">&#x27;ac23gd45fd77&#x27;</span>&gt;<br></code></pre></td></tr></table></figure><p>b、重复<br>可以通过 <code>1\数字</code> 来重复匹配前面的分组中匹配的结果，重复位置就是 <code>\数字</code> 的位置，数字的值代表前面的第几个分组（数字不是重复次数）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">re_str = <span class="hljs-string">r&#x27;(\d&#123;3&#125;)-(\w&#123;2&#125;)\1&#123;2&#125;\2&#x27;</span><br>print(fullmatch(re_str,<span class="hljs-string">&#x27;123-aa123123aa&#x27;</span>))<br><br>&lt;_sre.SRE_Match object; span=(<span class="hljs-number">0</span>, <span class="hljs-number">14</span>), match=<span class="hljs-string">&#x27;123-aa123123aa&#x27;</span>&gt;<br></code></pre></td></tr></table></figure><p>c、捕获<br>按照完整的正则表达式去匹配，只捕获<code>（）</code>中的内容。只有在 findall 方法中有效。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">re_str = <span class="hljs-string">r&#x27;a(\d&#123;3&#125;)b&#x27;</span><br>print(findall(re_str,<span class="hljs-string">&#x27;a786b&#x27;</span>))<br><br>[<span class="hljs-string">&#x27;786&#x27;</span>]<br></code></pre></td></tr></table></figure><h4 id="4、正则表达式的转义"><a href="#4、正则表达式的转义" class="headerlink" title="4、正则表达式的转义"></a>4、正则表达式的转义</h4><p>正则表达式中的转义和字符串中的转义字符没有任何关系。</p><p>在python中的字符串前加 r 阻止的是字符串转义，不能阻止正则表达式的转义。</p><p><code>在正则表达式中，可以通过在有特殊意义的符号前加 \ 来表示符号本身。</code></p><p><code>\+， \. ，\*， \? ，\\，\(，\)，……</code></p><p>注意：<br>a、只有在 <code>[]</code> 中两个字符中间的 <code>-</code> 才有特殊意义。<br>b、如果特殊符号放在 <code>[]</code> 中，是不需要转义的。<br>c、 <code>\</code> 不管在哪儿都需要转义，<code>^</code> 放在中括号前面需要转义。</p><h4 id="5、re-模块中的方法"><a href="#5、re-模块中的方法" class="headerlink" title="5、re 模块中的方法"></a>5、re 模块中的方法</h4><p>（1）、compile（正则表达式）：将正则表达式转换成正则表达式对象。</p><p>（2）、match（正则表达式，字符串）:判断字符串开头是否能够和正则表达式匹配。匹配成功返回匹配对象，否则返回None。</p><p>（3）、fullmatch（正则表达式，字符串）：判断整个字符串能否和正则表达式匹配。匹配成功返回匹配对象，否则返回None。<br>返回结果：通过对象调用方法可以取到里面的值。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">re_str = <span class="hljs-string">r&#x27;(\d&#123;3&#125;)-(\w&#123;2&#125;)\1&#123;2&#125;\2&#x27;</span><br>fullmatch1 = fullmatch(re_str,<span class="hljs-string">&#x27;123-aa123123aa&#x27;</span>)<br>&lt;_sre.SRE_Match object; span=(<span class="hljs-number">0</span>, <span class="hljs-number">14</span>), match=<span class="hljs-string">&#x27;123-aa123123aa&#x27;</span>&gt;<br></code></pre></td></tr></table></figure><p>a、获取第一个分组的范围<br><code>print(fullmatch1.span(1))</code> —括号里面可以不写<br>b、获取第一个分组的起始下标<br><code>print(fullmatch1.start(1))</code> —对应有end方法<br>c、获取匹配结果对应的字符串<br><code>print(fullmatch1.group(1))</code></p><p>（4）search（正则表达式，字符串）<br>在字符串中取查找第一个满足正则表达式要求的字串，如果找到了返回对象，否则返回None</p><p>（5）split（正则表达式，字符串）<br>按满足正则表达式的字串去切割字符串。<br>返回值是一个列表。</p><p>（6）sub（正则表达式，替换字符串，被替换字符串）</p><p>（7）findall（正则表达式， 字符串）<br>获取字符串中所有满足正则表达式的字串。返回值是列表<br>注意：分组中的捕获效果在findall中是有效的（得到分组中的内容）。</p><p><img src="https://upload-images.jianshu.io/upload_images/13692175-16884dcde2d41b55.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>正则表达式</tag>
      
      <tag>re</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>面向对象</title>
    <link href="/Myblog/2018/09/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/"/>
    <url>/Myblog/2018/09/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/</url>
    
    <content type="html"><![CDATA[<p>面向对象的三大支柱：</p><ul><li>封装：隐藏实现细节，暴露简单调用接口 -&gt; 对象</li><li>继承：从已经有的类，创建新的类的过程。提供继承信息的叫父类、超类、基类，得到继承信息的叫子类、派生类</li><li>多态：调用同样的方法，实现不同的功能。子类重写父类方法，不同子类实现父类方法的不同版本</li></ul><p>示例：模拟扑克牌（52张牌，去掉大小王）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<br><span class="hljs-keyword">import</span> random<br><br><br><span class="hljs-meta">@unique</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Suite</span>(<span class="hljs-params">Enum</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;枚举&quot;&quot;&quot;</span><br>    SOADE = <span class="hljs-number">0</span><br>    HEART = <span class="hljs-number">1</span><br>    CLUB = <span class="hljs-number">2</span><br>    DIAOND = <span class="hljs-number">3</span><br>    <span class="hljs-comment"># 如果通过枚举我们可以定义符号常量，符号常量优于字面常量</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__lt__</span>(<span class="hljs-params">self, other</span>):</span><br>        <span class="hljs-keyword">return</span> self.value &lt; other.value<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Card</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;牌&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, suite, face</span>):</span><br>        self.suite = suite<br>        self.face = face<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__str__</span>(<span class="hljs-params">self</span>):</span><br>        suites = (<span class="hljs-string">&#x27;♠&#x27;</span>,<span class="hljs-string">&#x27;♥&#x27;</span>,<span class="hljs-string">&#x27;♣&#x27;</span>,<span class="hljs-string">&#x27;♦&#x27;</span>)<br>        faces = (<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;8&#x27;</span>, <span class="hljs-string">&#x27;9&#x27;</span>, <br>                <span class="hljs-string">&#x27;10&#x27;</span>, <span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;suites[self.suite.value]&#125;</span><span class="hljs-subst">&#123;faces[self.face]&#125;</span>&#x27;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">return</span> self.__str__()<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Poker</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;扑克&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;初始化一副牌&quot;&quot;&quot;</span><br>        self.index = <span class="hljs-number">0</span><br>        self.cards = [Card(suite, face) <br>                        <span class="hljs-keyword">for</span> suite <span class="hljs-keyword">in</span> Suite <br>                        <span class="hljs-keyword">for</span> face <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, <span class="hljs-number">14</span>)]<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shuffle</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;洗牌&quot;&quot;&quot;</span><br>        self.index = <span class="hljs-number">0</span><br>        random.shuffle(self.cards)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deal</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;发牌&quot;&quot;&quot;</span><br>        card = self.cards[self.index]<br>        self.index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> card<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">has_more</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;是否有更多的牌&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> self.index &lt; len(self.cards)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Player</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;玩家&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, name</span>):</span><br>        self.name = name<br>        self.cards = []<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_card</span>(<span class="hljs-params">self, card</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;摸牌&quot;&quot;&quot;</span><br>        self.cards.append(card)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arrange</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;整理手中的牌&quot;&quot;&quot;</span><br>        self.cards.sort(key=<span class="hljs-keyword">lambda</span> card: (card.suite, card.face))<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-comment"># card1 = Card(Suite.HEART, 13)</span><br>    <span class="hljs-comment"># card2 = Card(Suite.CLUB, 5)</span><br>    <span class="hljs-comment"># print(card1, card2)</span><br><br>    poker = Poker()<br>    poker.shuffle()<br>    players = [Player(<span class="hljs-string">&#x27;张&#x27;</span>), Player(<span class="hljs-string">&#x27;李&#x27;</span>), Player(<span class="hljs-string">&#x27;赵&#x27;</span>), Player(<span class="hljs-string">&#x27;马&#x27;</span>)]<br>    <span class="hljs-keyword">while</span> poker.has_more:<br>        <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> players:<br>            player.get_card(poker.deal())<br><br>    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> players:<br>        player.arrange()<br>        print(player.name, end=<span class="hljs-string">&#x27;: &#x27;</span>)<br>        print(player.cards)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br>    <br>    <br><span class="hljs-comment"># output</span><br>张: [♠<span class="hljs-number">3</span>, ♠<span class="hljs-number">4</span>, ♠<span class="hljs-number">5</span>, ♠<span class="hljs-number">6</span>, ♠<span class="hljs-number">9</span>, ♠J, ♥<span class="hljs-number">2</span>, ♥<span class="hljs-number">4</span>, ♥<span class="hljs-number">6</span>, ♥<span class="hljs-number">9</span>, ♥<span class="hljs-number">10</span>, ♦<span class="hljs-number">5</span>, ♦<span class="hljs-number">6</span>]<br>李: [♠A, ♥<span class="hljs-number">5</span>, ♥<span class="hljs-number">7</span>, ♥J, ♥Q, ♣<span class="hljs-number">2</span>, ♣<span class="hljs-number">3</span>, ♣<span class="hljs-number">5</span>, ♣<span class="hljs-number">7</span>, ♣<span class="hljs-number">8</span>, ♣Q, ♦<span class="hljs-number">9</span>, ♦J]<br>赵: [♠<span class="hljs-number">7</span>, ♠<span class="hljs-number">10</span>, ♠Q, ♥<span class="hljs-number">3</span>, ♣A, ♣<span class="hljs-number">6</span>, ♣<span class="hljs-number">10</span>, ♣J, ♦A, ♦<span class="hljs-number">3</span>, ♦<span class="hljs-number">4</span>, ♦<span class="hljs-number">8</span>, ♦Q]<br>马: [♠<span class="hljs-number">2</span>, ♠<span class="hljs-number">8</span>, ♠K, ♥A, ♥<span class="hljs-number">8</span>, ♥K, ♣<span class="hljs-number">4</span>, ♣<span class="hljs-number">9</span>, ♣K, ♦<span class="hljs-number">2</span>, ♦<span class="hljs-number">7</span>, ♦<span class="hljs-number">10</span>, ♦K]<br>[Finished <span class="hljs-keyword">in</span> <span class="hljs-number">1.0</span>s]<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>面向对象</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>类和对象02</title>
    <link href="/Myblog/2018/09/07/%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A102/"/>
    <url>/Myblog/2018/09/07/%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A102/</url>
    
    <content type="html"><![CDATA[<h3 id="一、内置类属性"><a href="#一、内置类属性" class="headerlink" title="一、内置类属性"></a>一、内置类属性</h3><p>内置类属性就是魔法属性</p><h5 id="1、魔法属性"><a href="#1、魔法属性" class="headerlink" title="1、魔法属性"></a>1、魔法属性</h5><p><strong>魔法属性：属性名的前面和后面都有两个下划线。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">__name__：获取类名。.<br>类的属性<br><br>__class__：获取对象的类，返回类。<br>对象的属性（一般不用类的属性）<br><br>__dict__：将对象和类的属性及其对应的值转换成键值对存为一个字典返回。<br>对象的属性（一般不用类的属性）<br><br>__bases__：获取当前类的父类<br>类的属性<br><br>__module__：获取类所在模块对应的名字。<br>类的属性<br><br>__doc__：获取类的说明文档。<br>类的属性<br></code></pre></td></tr></table></figure><p><strong>特殊的魔法属性：__slots__</strong>：通过它存的元素的属性值来约束这个类的对象的属性。<br>一旦在类中给_<em>slots__赋值，name类对象的_<em>dict\</em></em> 属性不能用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span>:</span><br>    <span class="hljs-comment">#通过__slots__中存的元素的属性值来约束这个类的对象的属性，对象的属性不能比元组里面的多.</span><br>    __slots__ = (<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;age&#x27;</span>,<span class="hljs-string">&#x27;face&#x27;</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.name = <span class="hljs-string">&#x27;zhangsan&#x27;</span><br>        self.age = <span class="hljs-number">18</span><br>        self.face = <span class="hljs-number">70</span><br></code></pre></td></tr></table></figure><h5 id="2、魔法方法"><a href="#2、魔法方法" class="headerlink" title="2、魔法方法"></a>2、魔法方法</h5><p><strong>魔法方法：方法的前后都有两个下划线。</strong></p><h3 id="二、私有化"><a href="#二、私有化" class="headerlink" title="二、私有化"></a>二、私有化</h3><p>python中没有真正的私有化。<br>python中默认的属性和方法都是公开的。</p><h5 id="1、声明："><a href="#1、声明：" class="headerlink" title="1、声明："></a>1、声明：</h5><ul><li>类中的属性和方法都可以通过在属性名和方法名前加两个下划线，来让其变成私有的。</li><li>私有的属性和方法只能在当前类中使用。<h5 id="2、私有化原理"><a href="#2、私有化原理" class="headerlink" title="2、私有化原理"></a>2、私有化原理</h5>在前面有两个下划线的属性名和方法名的前面添加“_类名”，阻止外部直接用属性名访问。</li></ul><h3 id="三、属性的保护类型-–-getter-和setter"><a href="#三、属性的保护类型-–-getter-和setter" class="headerlink" title="三、属性的保护类型 – getter 和setter"></a>三、属性的保护类型 – getter 和setter</h3><p><strong>保护类型的属性：</strong>声明对象属性的时候，在属性名前加一个下划线（_），来代表这个属性是受保护的属性。</p><ul><li>那么以后访问这个属性的时候就不要直接访问，要通过 getter（获取属性值） 和 setter（给属性赋值）。</li><li>如果一个属性已经声明成保护类型的属性，那么我们就需要给这个属性添加 getter ，或者添加 setter<h5 id="1、添加-getter（获取值）"><a href="#1、添加-getter（获取值）" class="headerlink" title="1、添加 getter（获取值）"></a>1、添加 getter（获取值）</h5>添加 getter 就是声明一个没有参数，有一个返回值的函数。</li></ul><p><strong>格式：@property</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Car</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(<span class="hljs-keyword">self</span>)</span></span><span class="hljs-symbol">:</span><br>        <span class="hljs-keyword">self</span>.color = <span class="hljs-string">&#x27;yellow&#x27;</span><br>        <span class="hljs-keyword">self</span>.type = <span class="hljs-string">&#x27;bike&#x27;</span><br>        <span class="hljs-comment">#_price属性是保护类型</span><br>        <span class="hljs-keyword">self</span>._price = <span class="hljs-number">2000</span><br><br>    <span class="hljs-comment">#给_price属性添加getter</span><br>    @property<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">price</span><span class="hljs-params">(<span class="hljs-keyword">self</span>)</span></span>:  <span class="hljs-comment">#函数名为函数体去掉下划线</span><br>        <span class="hljs-comment">#函数体</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>._price<br><br>car1 = Car()<br><span class="hljs-comment">#添加完getter后使用</span><br>print(car1.price)<br></code></pre></td></tr></table></figure><h6 id="使用场景一"><a href="#使用场景一" class="headerlink" title="使用场景一"></a>使用场景一</h6><p>如果想要获取对象的某个属性的值之前，想要再干点儿别的事情，就可以给这个属性添加 getter 。</p><h6 id="使用场景二"><a href="#使用场景二" class="headerlink" title="使用场景二"></a>使用场景二</h6><p>想要获取某个属性被使用的时刻。</p><h5 id="2、添加-setter（赋值）"><a href="#2、添加-setter（赋值）" class="headerlink" title="2、添加 setter（赋值）"></a>2、添加 setter（赋值）</h5><p>添加 setter 就是声明一个有一个参数，但是没有返回值的函数。<br>想要给一个属性添加 getter ，就必须给这个属性添加 setter</p><p><strong>格式：@price.setter（price是setter的值）</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Car</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(<span class="hljs-keyword">self</span>)</span></span><span class="hljs-symbol">:</span><br>        <span class="hljs-keyword">self</span>.color = <span class="hljs-string">&#x27;yellow&#x27;</span><br>        <span class="hljs-keyword">self</span>.type = <span class="hljs-string">&#x27;bike&#x27;</span><br>        <span class="hljs-comment">#_price属性是保护类型</span><br>        <span class="hljs-keyword">self</span>._price = <span class="hljs-number">2000</span><br><br>    <span class="hljs-comment">#给_price属性添加setter</span><br>    @price.setter<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">price</span><span class="hljs-params">(<span class="hljs-keyword">self</span>, price)</span></span><span class="hljs-symbol">:</span><br>        <span class="hljs-keyword">if</span> isinstance(price, int) <span class="hljs-keyword">or</span> isinstance(price, float)<span class="hljs-symbol">:</span><br>            <span class="hljs-keyword">self</span>._price = price<br>        <span class="hljs-symbol">else:</span><br>            <span class="hljs-keyword">self</span>._price = <span class="hljs-number">0</span><br><span class="hljs-comment">#添加完getter后使用,实质是在调用setter方法</span><br>car1.price = <span class="hljs-number">1000</span><br>print(car1.price)<br></code></pre></td></tr></table></figure><h3 id="四、继承"><a href="#四、继承" class="headerlink" title="四、继承"></a>四、继承</h3><h4 id="1、继承"><a href="#1、继承" class="headerlink" title="1、继承"></a>1、继承</h4><p>python中类可以继承，并且支持多继承。<br>程序的继承：就是让子类直接拥有父类的属性和方法。</p><h6 id="（1）、继承的语法"><a href="#（1）、继承的语法" class="headerlink" title="（1）、继承的语法"></a>（1）、继承的语法</h6> <figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-class"><span class="hljs-keyword">class</span> 子类（父类）：</span><br>    类的内容<br></code></pre></td></tr></table></figure><p>注意：如果申明类的时候没有写继承，那么这个类会自动继承python的基类（object）。</p><h6 id="（2）、能继承什么东西"><a href="#（2）、能继承什么东西" class="headerlink" title="（2）、能继承什么东西"></a>（2）、能继承什么东西</h6><p>a、所有的属性和方法都可以继承__ slots__的值不会继承，但是会影响子类对象的__ dict__属性，不能获取到父类继承下来的属性。<br>b、私有化本质上是继承下来了，只是python使用了一个小手段（改名），看起来没有继承下来。</p><h4 id="2、多继承（了解）"><a href="#2、多继承（了解）" class="headerlink" title="2、多继承（了解）"></a>2、多继承（了解）</h4><p>python中的类支持多继承，但是不建议使用。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">class</span> 类（父类<span class="hljs-symbol">1</span>， 父类<span class="hljs-symbol">2</span>）：<br>    <span class="hljs-symbol">pass</span><br><br></code></pre></td></tr></table></figure><p>多继承继承的时候，子类可以拥有所有父类的所有方法和类的字段，但是只能继承第一个父类的对象的属性。</p><h4 id="3、多态"><a href="#3、多态" class="headerlink" title="3、多态"></a>3、多态</h4><p>多态就是指多种形态。<br>有继承就有多态：不同的类继承至同一个类，其实就是对这个共同的父类不同的表现方式。继承后对方法的重写也是多态的表现。</p><h4 id="4、封装、继承、包"><a href="#4、封装、继承、包" class="headerlink" title="4、封装、继承、包"></a>4、封装、继承、包</h4><p>封装：一个类可以通过不同的方法对不同的功能进行封装。通过属性对不同的数据进行封装。<br>继承：通过继承可以让子类拥有父类的属性和方法。</p><h3 id="五、重写相关"><a href="#五、重写相关" class="headerlink" title="五、重写相关"></a>五、重写相关</h3><p>子类继承父类，拥有父类的属性和方法以后，还可以添加自己的属性和方法。</p><h5 id="1、在子类中添加方法和类的字段"><a href="#1、在子类中添加方法和类的字段" class="headerlink" title="1、在子类中添加方法和类的字段"></a>1、在子类中添加方法和类的字段</h5><p>直接添加</p><h5 id="2、添加对象的属性"><a href="#2、添加对象的属性" class="headerlink" title="2、添加对象的属性"></a>2、添加对象的属性</h5><ul><li>对象的属性是通过继承父类的__ init__方法而继承下来的。</li><li>如果想要在保留父类的对象的同时，添加自己的对象属性，需要在子类的__ init__方法中用使用 super（）去调用父类的__ init__方法</li></ul><h5 id="3、方法的重写"><a href="#3、方法的重写" class="headerlink" title="3、方法的重写"></a>3、方法的重写</h5><p>在子类中重新实现父类的方法，就是重写</p><p><strong>注意：使用super的时候，必须是通过super（）来代替父类，或者是父类对象</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">super</span><span class="hljs-params">()</span></span>.number<br></code></pre></td></tr></table></figure><p><strong>方式一：直接覆盖父类的实现。</strong></p><ul><li>直接写和父类一样的方法名</li></ul><p><strong>方式二：保留父类的功能在添加其他功能。</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(<span class="hljs-keyword">self</span>)</span></span><span class="hljs-symbol">:</span><br>    <span class="hljs-keyword">super</span>().__init_<span class="hljs-number">_</span>()<br>    <span class="hljs-keyword">self</span>.name = <span class="hljs-string">&#x27;小花&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># 通过super()调用父类的方法，保留父类的功能</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shout</span><span class="hljs-params">(<span class="hljs-keyword">self</span>)</span></span><span class="hljs-symbol">:</span><br>    <span class="hljs-keyword">super</span>().shout()<br>    print(<span class="hljs-string">&#x27;喵喵~~&#x27;</span>)<br></code></pre></td></tr></table></figure><p>######4、类中方法的调用过程<br>先在当前这个类中去找，没有就去父类找，依次找到基类（object），如果都没有找到，就让程序崩溃。</p><p>练习：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># 写一个Person类，拥有属性name，age，sex，</span><br><span class="hljs-comment"># 要求创建person对象的时候必须给name和age赋值，sex可以选择赋值</span><br><span class="hljs-comment"># 再写一个Staff类继承Person类，保存所有属性，并且添加新的属性：salary，</span><br><span class="hljs-comment"># 要求创建Staff类的对象的时候，只能给name必须赋值。</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(<span class="hljs-keyword">self</span>, name, age, sex=<span class="hljs-string">&#x27;boy&#x27;</span>)</span></span><span class="hljs-symbol">:</span><br>        <span class="hljs-keyword">self</span>.name = name<br>        <span class="hljs-keyword">self</span>.age = age<br>        <span class="hljs-keyword">self</span>.sex = sex<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Staff</span>(<span class="hljs-title">Person</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(<span class="hljs-keyword">self</span>, name)</span></span><span class="hljs-symbol">:</span><br>        <span class="hljs-keyword">super</span>().__init_<span class="hljs-number">_</span>(name, <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">self</span>.salary = <span class="hljs-number">10000</span><br><br>p1 = Person(<span class="hljs-string">&#x27;xingchen&#x27;</span>, <span class="hljs-number">18</span>)<br>p2 = Person(<span class="hljs-string">&#x27;zhangsan&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-string">&#x27;girl&#x27;</span>)<br>s1 = Staff(<span class="hljs-string">&#x27;xiaohong&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p>###六、运算符的重载<br>如果希望类的对象支持相应的运算符操作（例如：+，-，*，/，&gt;，&lt;等），就必须实现相应的魔法方法，这个过程就叫运算符的重载。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># 加操作</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__add__</span><span class="hljs-params">(<span class="hljs-keyword">self</span>, other)</span></span><span class="hljs-symbol">:</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.score + other.score<br><span class="hljs-comment"># 大于操作(重载大于方法后，不用重载小于方法，另一个功能自动取反)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__gt__</span><span class="hljs-params">(<span class="hljs-keyword">self</span>, other)</span></span><span class="hljs-symbol">:</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.score &gt; other.score<br><br>stu1 = Student(<span class="hljs-string">&#x27;小明&#x27;</span>,<span class="hljs-number">18</span>,<span class="hljs-number">90</span>)<br>stu2 = Student(<span class="hljs-string">&#x27;小王&#x27;</span>,<span class="hljs-number">16</span>,<span class="hljs-number">89</span>)<br>print(stu1 + stu2)<br>print(stu1 &gt; stu2)<br><br><span class="hljs-number">179</span><br>True<br></code></pre></td></tr></table></figure><p>一般情况需要对 &gt; 或者 &lt; 进行重载，重载后可以通过用 sort（）方法直接对列表中的对象进行排序。</p><p>补充：<br>重写魔法方法__ str__，用来定制对象的打印样式( print方法 )。<br>###七、包<br>包：将多个模块封装到一起，就是包。包就是有一个默认文件__ init__.py的文件夹。</p><p>格式：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-number">1</span>、包.模块<br><span class="hljs-number">2</span>、<span class="hljs-keyword">from</span> 包 <span class="hljs-keyword">import</span> 模块<br><span class="hljs-number">3</span>、<span class="hljs-keyword">from</span> 包.模块 <span class="hljs-keyword">import</span> 方法/类/变量<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>类和对象</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>类和对象01</title>
    <link href="/Myblog/2018/09/06/%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A101/"/>
    <url>/Myblog/2018/09/06/%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A101/</url>
    
    <content type="html"><![CDATA[<h5 id="1、理论上的定义："><a href="#1、理论上的定义：" class="headerlink" title="1、理论上的定义："></a>1、理论上的定义：</h5><p>类：就是拥有相同功能和属性的对象的集合。（抽象）<br>对象：类的实例（具体）</p><h5 id="2、从生活角度"><a href="#2、从生活角度" class="headerlink" title="2、从生活角度"></a>2、从生活角度</h5><p>如果说人这个物种是一个类，那么每一个人就是一个对象。</p><h5 id="3、编程方式"><a href="#3、编程方式" class="headerlink" title="3、编程方式"></a>3、编程方式</h5><p>面向过程编程：以算法为工具<br>函数式编程：以函数为工具<br>面向对象编程：以类和对象为工具（面向生活）</p><p>类：对拥有相同功能（方法）和相同属性的封装。<br>封装效果：一个类中可以对多个功能进行封装（多个函数）；封装多个属性</p><h3 id="一、类的声明格式"><a href="#一、类的声明格式" class="headerlink" title="一、类的声明格式"></a>一、类的声明格式</h3><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ceylon"><span class="hljs-keyword">class</span> 类名（父类列表）：<br>    <span class="hljs-string">&quot;&quot;&quot;类的说明文档&quot;&quot;&quot;</span><br>    类的内容<br></code></pre></td></tr></table></figure><p><strong>class</strong>：声明类的关键字。<br><strong>类名</strong>：标识符，不能是关键字。首字母必须大写！采用驼峰式命名。例如：StudentSystem。<br>（驼峰式命名：第一个单词首字母小写，其他单词的首字母大写）<br><strong>父类列表</strong>：这个部分可以省。这是一个继承语法，可以多继承。<br><strong>类的内容</strong>：类的方法和属性。</p><h3 id="二、类中的方法"><a href="#二、类中的方法" class="headerlink" title="二、类中的方法"></a>二、类中的方法</h3><p><strong>调用方式：对象.函数名（）</strong><br>方法：就是声明在类中的函数<br>方法分类：对象方法，类方法，静态方法。<br>直接写在类中的方法，自带一个 self 参数<br>对象方法：通过对象来调用。</p><h3 id="三、构造方法"><a href="#三、构造方法" class="headerlink" title="三、构造方法"></a>三、构造方法</h3><ul><li>构造方法：系统自动创建，方法名和类名一样。用来创建对象。</li><li>__init__：方法的功能是用来做初始化和添加对象属性。</li><li>当我们通过构造方法去创建对象的时候，系统会自动调用init方法。</li><li>如果类的 init 方法有参数，通过给构造方法传参。</li></ul><h3 id="四、创建对象"><a href="#四、创建对象" class="headerlink" title="四、创建对象"></a>四、创建对象</h3><p><strong>创建类的时候，系统会默认创建这个类对应的构造方法（方法名和类名相同）。一个类可以有多个对象，只要调用构造方法，就会产生新的对象。</strong></p><ul><li>构造方法：类名（） –&gt;  创建类对应的对象</li><li>通过对象调用对象方法，默认参数 self 不需要传参。</li><li>创建对象的过程：调用构造方法在内存中开辟空间创建一个对象，然后用新建的这个对象去调用 init 方法来初始化对象的属性，最后才将对象返回。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span>:</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    人类</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">eat</span>(<span class="hljs-params">self</span>):</span><br>        print(<span class="hljs-string">&#x27;人吃饭&#x27;</span>)<br><span class="hljs-comment">#创建Person类的对象，并且将对象的地址存到 p1中</span><br>p1 = Person()  <br>p1.eat()<br></code></pre></td></tr></table></figure><h3 id="五、对象属性"><a href="#五、对象属性" class="headerlink" title="五、对象属性"></a>五、对象属性</h3><h5 id="1、属性"><a href="#1、属性" class="headerlink" title="1、属性"></a>1、属性</h5></li></ul><p><strong>对象的属性</strong>：不同的对象，对应的值可能不一样，这样的属性是对象属性。属于对象类中的对象属性是声明在 init 方法中的。</p><ul><li><strong>声明格式是：self . 属性名 = 初始值</strong></li><li><strong>对象的使用：对象 . 属性名</strong><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">方法一<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>:</span><br>    <span class="hljs-string">&quot;&quot;&quot;学生类&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-comment">#声明对象的属性name，age，id</span><br>        self.name = <span class="hljs-string">&#x27;张三&#x27;</span><br>        self.age = <span class="hljs-number">0</span><br>        self.id = <span class="hljs-string">&#x27;001&#x27;</span><br>stu1 = Student()<br>print(stu1.name,stu1.age,stu1.id)<br><span class="hljs-comment">#通过对象去修改对象的属性</span><br>stu1.name = <span class="hljs-string">&#x27;星辰&#x27;</span><br>print(stu1.name)<br><br>方法二<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span>:</span><br>    <span class="hljs-string">&quot;&quot;&quot;狗类&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, type1, color1</span>):</span><br>        self.type = type1<br>        self.color = color1<br>dog1 = Dog(<span class="hljs-string">&#x27;土狗&#x27;</span>,<span class="hljs-string">&#x27;黄色&#x27;</span>)<br>print(dog1.type, dog1.color)<br><br>方法三<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Computer</span>:</span><br>    <span class="hljs-string">&quot;&quot;&quot;电脑类&quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, color=<span class="hljs-string">&#x27;白色&#x27;</span>, memory=<span class="hljs-number">0</span></span>):</span><br>        self.color = color<br>        self.memory = memory<br>com1 = Computer()<br>print(com1.color,com1.memory)<br></code></pre></td></tr></table></figure></li></ul><p><strong>类的字段（属性）</strong>：属于类，所有对象对应的值是一样的。<br>#####2、属性的增删改查<br>python是动态语言，python中类的对象的属性可以进行增删改查的操作。</p><ul><li><strong>查</strong><br>方法一：对象.属性名（常用）<br>方法二：getattr(对象, 属性名, default=None)<br>属性不存在可以通过设置默认值，让程序不崩溃，并且返回默认值。<br>方法三：对象.__getattribute__(属性名)</li><li><strong>改</strong><br>方法一：对象.属性 = 新值（常用）<br>方法二：setattr(对象， 属性名，值)<br>方法三：对象.__setattr__（属性名，值）</li><li><strong>增</strong><br>方法一：对象.属性 = 新值（属性不存在，就是添加）<br>方法二：setattr(对象， 属性名，值)<br>方法三：对象.__setattr__（属性名，值）</li><li><strong>删</strong><br>方法一：del 对象.属性<br>方法二：delattr（对象，属性）<br>方法三：对象. __delattr__(属性)<h3 id="六、类的属性（字段）"><a href="#六、类的属性（字段）" class="headerlink" title="六、类的属性（字段）"></a>六、类的属性（字段）</h3>1、类的字段：就是声明在类的里面，方法的外面的变量<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">class</span> <span class="hljs-symbol">Person:</span><br>  #这个<span class="hljs-symbol">number</span>就是类的字段<br>  <span class="hljs-symbol">number</span> = <span class="hljs-symbol">6</span><br></code></pre></td></tr></table></figure>2、什么时候声明类的属性：<br>属于类，并且对于类的所有对象来说是共有的。</li></ul><p>3、怎么使用</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(Person.number)</span></span><br></code></pre></td></tr></table></figure><h3 id="七、对象方法"><a href="#七、对象方法" class="headerlink" title="七、对象方法"></a>七、对象方法</h3><ul><li><strong>直接声明在类中的函数默认是对象方法，有一个默认参数 self</strong></li><li>对象方法要通过对象来调用：<strong>对象.对象方法</strong></li><li>对象方法中默认参数 self ， 不需要传参。因为在调用这个方法时，系统自动当当前对象传给 self 。</li><li>哪个对象调用，self 就指向谁。对象能做的事情，self 也能做，本质上是一样的</li></ul><p>练习：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># 1、写一个矩形类，有属性长和宽,功能：求周长和面积</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Rect</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(<span class="hljs-keyword">self</span>, width, weight)</span></span><span class="hljs-symbol">:</span><br>        <span class="hljs-keyword">self</span>.width = width<br>        <span class="hljs-keyword">self</span>.weight = weight<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">perimeter</span><span class="hljs-params">(<span class="hljs-keyword">self</span>)</span></span><span class="hljs-symbol">:</span><br>        print(<span class="hljs-string">&#x27;周长是：&#x27;</span>,(<span class="hljs-keyword">self</span>.weight + <span class="hljs-keyword">self</span>.width)*<span class="hljs-number">2</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">area</span><span class="hljs-params">(<span class="hljs-keyword">self</span>)</span></span><span class="hljs-symbol">:</span><br>        print(<span class="hljs-string">&#x27;面积是：&#x27;</span>,(<span class="hljs-keyword">self</span>.width*<span class="hljs-keyword">self</span>.weight))<br>rect1 = Rect(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)<br>rect1.perimeter()<br>rect1.area()<br><br>周长是： <span class="hljs-number">14</span><br>面积是： <span class="hljs-number">12</span><br><br><span class="hljs-comment">#2、写一个班级类，班级里面有多个学生的成绩，可以获取成绩的最高分</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Class_python</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(<span class="hljs-keyword">self</span>,*score)</span></span><span class="hljs-symbol">:</span><br>        <span class="hljs-keyword">self</span>.score = score<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">score_max</span><span class="hljs-params">(<span class="hljs-keyword">self</span>)</span></span><span class="hljs-symbol">:</span><br>        a = list(<span class="hljs-keyword">self</span>.score)<br>        a.sort()<br>        print(<span class="hljs-string">&#x27;最高分是:%d&#x27;</span>%a[-<span class="hljs-number">1</span>])<br>class1 = Class_python(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">23</span>,<span class="hljs-number">43</span>,<span class="hljs-number">32</span>,)<br>class1.score_max()<br><br>最高分是<span class="hljs-symbol">:</span><span class="hljs-number">43</span><br></code></pre></td></tr></table></figure><h3 id="八、类的方法"><a href="#八、类的方法" class="headerlink" title="八、类的方法"></a>八、类的方法</h3><p><strong>声明形式：</strong>声明方法前需要使用@classmethod说明。<br>特点：自带一个默认参数 cls，这个参数调用的时候不需要传值。系统自动传值，谁调用指向谁。（因为只能被类调用，所以始终指向当前类）<br>调用：通过类来调用 –&gt; 类.类方法（）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Class1</span>:</span><br>    <span class="hljs-comment">#声明一个对象方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">class2</span>(<span class="hljs-params">self</span>):</span><br>        print(<span class="hljs-string">&#x27;这是一个对象方法&#x27;</span>)<br>    <span class="hljs-comment">#声明一个类方法</span><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">class_func</span>(<span class="hljs-params">cls</span>):</span><br>        print(<span class="hljs-string">&#x27;这是一个类方法&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="九、静态方法"><a href="#九、静态方法" class="headerlink" title="九、静态方法"></a>九、静态方法</h3><p><strong>声明形式：</strong>声明方法前需要使用@staticmethod说明。<br>特点：没有默认参数<br>调用：通过当前类调用 –&gt; 类.静态方法（）</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ruby">    @staticmethod<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">static_func</span><span class="hljs-params">()</span></span><span class="hljs-symbol">:</span><br>        print(<span class="hljs-string">&#x27;这是一个静态方法&#x27;</span>)<br>调用<br>c1 = Class1()<br>c1.static_func()<br></code></pre></td></tr></table></figure><h3 id="十、怎么选择三种方法"><a href="#十、怎么选择三种方法" class="headerlink" title="十、怎么选择三种方法"></a>十、怎么选择三种方法</h3><p>a、只要实现方法的功能需要用到对象的属性，我们就使用对象方法；否则就使用静态方法或者类方法。<br>b、不使用对象方法的前提下，如果实现功能需要用到类的字段，就用类方法。<br>c、实现功能既不需要对象的属性，又不需要类的字段，就使用静态方法。<br>注意：静态方法和类方法划分不用那么严格，因为静态方法能做的，类方法也能使用；反之亦然。</p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>类和对象</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pygame</title>
    <link href="/Myblog/2018/09/04/pygame/"/>
    <url>/Myblog/2018/09/04/pygame/</url>
    
    <content type="html"><![CDATA[<p><strong>安装：pip install Pygame</strong></p><h4 id="1、初始化游戏模块"><a href="#1、初始化游戏模块" class="headerlink" title="1、初始化游戏模块"></a>1、初始化游戏模块</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">pygame.<span class="hljs-keyword">init</span>()<br></code></pre></td></tr></table></figure><h4 id="2、创建游戏窗口"><a href="#2、创建游戏窗口" class="headerlink" title="2、创建游戏窗口"></a>2、创建游戏窗口</h4><p>set_mode((100, 200)) : 单位像素</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">window</span> = pygame.display.set_mode((<span class="hljs-number">400</span>, <span class="hljs-number">600</span>)）<br><span class="hljs-comment">#窗口大小：元组，元组中的两个值表示宽度和高度</span><br></code></pre></td></tr></table></figure><p>程序结束窗口会自动关闭，所以需要循环或者其他方式让窗口手动关闭。</p><h4 id="3、给窗口填充颜色"><a href="#3、给窗口填充颜色" class="headerlink" title="3、给窗口填充颜色"></a>3、给窗口填充颜色</h4><p>颜色：计算机三原色（红、绿、蓝），每个颜色对应的值范围是0-255.可以改变三原色的值可以调配出不同的颜色。<br>颜色值：是一个元组，有三个元素，分别代表红绿蓝（rgb）。<br>(255, 0 ,0) –&gt; 红色<br>(0, 0, 0) –&gt; 黑色<br>(255, 255 , 255) –&gt; 白色</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">window.fill((<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))<br></code></pre></td></tr></table></figure><h4 id="4、让游戏一直运行，直到点关闭按钮才结束"><a href="#4、让游戏一直运行，直到点关闭按钮才结束" class="headerlink" title="4、让游戏一直运行，直到点关闭按钮才结束"></a>4、让游戏一直运行，直到点关闭按钮才结束</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-keyword">while</span> True:<br>    <span class="hljs-comment">#获取游戏过程中产生的所有事件</span><br>    <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> pygame.event.get():<br>        <span class="hljs-comment"># type判断事件的类型（QUIT：点击×）</span><br>        <span class="hljs-keyword">if</span> event.type == pygame.QUIT:<br>            <span class="hljs-keyword">exit</span>() <span class="hljs-comment">#退出程序</span><br></code></pre></td></tr></table></figure><p><strong>a、事件的type — 决定发生的是什么事件</strong></p><p>QUIT ： 关闭按钮被点击事件</p><p>鼠标事件:<br>MOUSEBUTTONDOWN: 鼠标按下事件<br>MOUSEBUTTONUP: 鼠标按下松开时对应的事件<br>MOUSEMOTION：鼠标移动事件</p><p>键盘事件:<br>KEYDOWN： 键盘按下<br>KEYUP:  键盘弹起</p><p><strong>b.事件的pos(event.pos) — 鼠标事件发生的位置(坐标)</strong></p><p><strong>c.事件的key(event.key) — 键盘事件被按的键对应的编码值</strong></p><p>应用：</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">for</span> <span class="hljs-keyword">event</span> <span class="hljs-keyword">in</span> pygame.<span class="hljs-keyword">event</span>.get():<br>    # 不同的事件发生后，对应type值不一样<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">event</span>.type == pygame.QUIT:<br>        <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;点击关闭按钮&#x27;</span>)<br>        exit()<br>    elif <span class="hljs-keyword">event</span>.type == pygame.MOUSEBUTTONDOWN:<br>        # 鼠标按下要做的事情就写在这儿<br>        <span class="hljs-keyword">print</span>(<span class="hljs-keyword">event</span>.pos)<br>        <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;鼠标按下&#x27;</span>)<br>        # 鼠标按下一次画一个球<br>        # pygame.draw.<span class="hljs-keyword">circle</span>(<span class="hljs-keyword">window</span>, (randint(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>), randint(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>),\<br>        #                             randint(<span class="hljs-number">0</span>,<span class="hljs-number">255</span>)), <span class="hljs-keyword">event</span>.pos, randint(<span class="hljs-number">20</span>, <span class="hljs-number">50</span>))<br>        # pygame.display.flip()<br><br>    elif <span class="hljs-keyword">event</span>.type == pygame.MOUSEBUTTONUP:<br>        <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;鼠标弹起&#x27;</span>, <span class="hljs-keyword">event</span>.pos)<br>    elif <span class="hljs-keyword">event</span>.type == pygame.MOUSEMOTION:<br>        # 鼠标按下一次画一个球<br>        pygame.draw.<span class="hljs-keyword">circle</span>(<span class="hljs-keyword">window</span>, (randint(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>), randint(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>), \<br>                                    randint(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>)), <span class="hljs-keyword">event</span>.pos, <span class="hljs-number">20</span>)<br>        pygame.display.flip()<br>        # <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;鼠标正在移动&#x27;</span>, <span class="hljs-keyword">event</span>.pos)<br>        pass<br>    elif <span class="hljs-keyword">event</span>.type == pygame.KEYDOWN:<br>        <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;键盘按下&#x27;</span>, <span class="hljs-keyword">event</span>.key, chr(<span class="hljs-keyword">event</span>.key))<br>    elif <span class="hljs-keyword">event</span>.type == pygame.KEYUP:<br>        <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;键盘弹起&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="5、图片相关"><a href="#5、图片相关" class="headerlink" title="5、图片相关"></a>5、图片相关</h4><p>获取本地的一张图片，返回图片对象<br>image.load(路径)<br><strong>（1）获取图片，创建图片对象</strong></p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-built_in">image</span> = pygame.<span class="hljs-built_in">image</span>.<span class="hljs-built_in">load</span>(<span class="hljs-string">&#x27;./files/luffy4.jpg&#x27;</span>)<br></code></pre></td></tr></table></figure><p><strong>获取图片的宽和高</strong></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-built_in">image</span>.get_size() ： 获取屏幕宽和高，返回一个元组（宽、高）<br></code></pre></td></tr></table></figure><p><strong>形变：</strong><br>a、缩放<br><code>transform.scale(缩放对象，目标大小)</code><br>将制定的对象缩放到指定的大小，会返回缩放后的对象。</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">new_image = pygame.<span class="hljs-built_in">transform</span>.<span class="hljs-built_in">scale</span>(<span class="hljs-built_in">image</span>,(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>))<br></code></pre></td></tr></table></figure><p>b、旋转缩放（指定缩放比例）<br><code>transform.rotozoom(Surface, angle, scale)</code><br>Surface:旋转缩放对象<br>angle：旋转角度( 0<del>360)<br>scale：缩放比例（初始为1）<br>c、旋转<br><code>transform.rotate(Surface, angle)</code><br>Surface：旋转对象<br>angle：旋转角度（0</del>360）<br><strong>（2）渲染图片（将图片画在纸上）</strong></p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">window</span>.blit(渲染对象， 位置)<br></code></pre></td></tr></table></figure><p>位置：坐标（x，y）</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">window = blit(<span class="hljs-name">image</span>, (<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))<br></code></pre></td></tr></table></figure><p>坐标计算如下图：<br><img src="https://upload-images.jianshu.io/upload_images/13692175-634fb6606cff822e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><h6 id="（3）展示内容-将纸展示"><a href="#（3）展示内容-将纸展示" class="headerlink" title="（3）展示内容(将纸展示)"></a>（3）展示内容(将纸展示)</h6><p>一般第一次用这个方法</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">pygame</span><span class="hljs-selector-class">.display</span><span class="hljs-selector-class">.flip</span>()<br></code></pre></td></tr></table></figure><p>一定范围刷新</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">pygame</span><span class="hljs-selector-class">.display</span><span class="hljs-selector-class">.update</span>()<br></code></pre></td></tr></table></figure><h4 id="6、文字相关"><a href="#6、文字相关" class="headerlink" title="6、文字相关"></a>6、文字相关</h4><h6 id="（1）、字体对象"><a href="#（1）、字体对象" class="headerlink" title="（1）、字体对象"></a>（1）、字体对象</h6><p>a、系统字体（一般不支持中文）<br><code>font = pygame.font.SysFont(&#39;Times&#39;, 30)</code><br>SysFont(name, size, bold=False, italic=False)<br>bold : 是否加粗<br>italic：是否倾斜<br>b、自定义字体对象（支持 ttf 文件）<br>Font(字体文件路径，字体大小)<br>font = pygame.font.Font(‘./file/aa.ttf’, 30)</p><h6 id="（2）、根据字体去创建文字对象"><a href="#（2）、根据字体去创建文字对象" class="headerlink" title="（2）、根据字体去创建文字对象"></a>（2）、根据字体去创建文字对象</h6><p>render(text, antialias, color，background=None)<br>text : 需要显示的文字（字符串）<br>antialias：是否平滑（布尔）<br>color：（颜色）<br>background：背景颜色</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">text</span> = font.render(<span class="hljs-string">&#x27;hello&#x27;</span>, <span class="hljs-literal">True</span>, (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>))<br></code></pre></td></tr></table></figure><p>（3）、渲染文字<br>window.blit(text, (50,50))<br>（4）、展示内容<br>pygame.display.flip()</p><h4 id="7、图形相关"><a href="#7、图形相关" class="headerlink" title="7、图形相关"></a>7、图形相关</h4><h5 id="（1）、直线"><a href="#（1）、直线" class="headerlink" title="（1）、直线"></a>（1）、直线</h5><h6 id="a、线段"><a href="#a、线段" class="headerlink" title="a、线段"></a>a、线段</h6><p><code>pygame.draw.line(Surface, color, start_pos, end_pos, width=1)</code><br>Surface：画在哪儿<br>color：线的颜色<br>start_pos：起点<br>end_pos：终点<br>width：宽度</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">#水平线</span><br><span class="hljs-attribute">pygame</span>.draw.line(window, (<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (<span class="hljs-number">50</span>, <span class="hljs-number">100</span>), (<span class="hljs-number">200</span>, <span class="hljs-number">100</span>))<br></code></pre></td></tr></table></figure><h6 id="b、多条线段（折线）"><a href="#b、多条线段（折线）" class="headerlink" title="b、多条线段（折线）"></a>b、多条线段（折线）</h6><p>lines(Surface, color, closed, pointlist, blend=1)<br>colsed：是否闭合</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">pygame.draw.lines(window, (<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>), False, [(<span class="hljs-number">100</span>,<span class="hljs-number">200</span>), (<span class="hljs-number">150</span>,<span class="hljs-number">120</span>), (<span class="hljs-number">140</span>,<span class="hljs-number">150</span>)])<br></code></pre></td></tr></table></figure><h6 id="c、圆"><a href="#c、圆" class="headerlink" title="c、圆"></a>c、圆</h6><p><code>pygame.draw.circle(Surface,color,pos,radius,width=0)</code><br>Surface:圆心半径<br>color:颜色<br>pos:位置<br>radius:半径<br>width:线段，0-&gt;填充</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">pygame.draw.circle(window,(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0</span>),(<span class="hljs-number">250</span>,<span class="hljs-number">275</span>),<span class="hljs-number">100</span>,<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><h6 id="d、矩形"><a href="#d、矩形" class="headerlink" title="d、矩形"></a>d、矩形</h6><p><code>pygame.draw.rect(Surface,color,Rect,width=0)</code><br>Surface:画在哪儿<br>color:颜色<br>Rect:范围(元组，元组中有四个元素，分别是x,y,width,height)<br>width:线宽，0-&gt;填充</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">pygame.draw.rect(window,(<span class="hljs-number">255</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">50</span>,<span class="hljs-number">100</span>))<br><br></code></pre></td></tr></table></figure><h6 id="e、多边形"><a href="#e、多边形" class="headerlink" title="e、多边形"></a>e、多边形</h6><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">pygame.<span class="hljs-built_in">draw</span>.<span class="hljs-built_in">polygon</span>(Surface,<span class="hljs-built_in">color</span>,pointlist,<span class="hljs-built_in">width</span>=<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><h6 id="f、椭圆"><a href="#f、椭圆" class="headerlink" title="f、椭圆"></a>f、椭圆</h6><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs maxima">pygame.<span class="hljs-built_in">draw</span>.<span class="hljs-built_in">ellipse</span>(Surface.<span class="hljs-built_in">color</span>,Rect,<span class="hljs-built_in">width</span>=<span class="hljs-number">0</span>)<br>#内切矩形原理<br></code></pre></td></tr></table></figure><h6 id="g、弧线"><a href="#g、弧线" class="headerlink" title="g、弧线"></a>g、弧线</h6><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">pygame.draw.arc(Surface,color,Rect,start_angle,end_angle,width=<span class="hljs-number">1</span>)<br>#start_angle: <span class="hljs-number">0</span><span class="hljs-number">-2</span>pi<br>#stop_angle:<br>#pi --- <span class="hljs-number">180</span>°   <span class="hljs-number">1</span>° --- pi/<span class="hljs-number">180</span><br>#<span class="hljs-number">59</span>° = pi/<span class="hljs-number">180</span> * <span class="hljs-number">59</span><br></code></pre></td></tr></table></figure><h5 id="（2）、展示"><a href="#（2）、展示" class="headerlink" title="（2）、展示"></a>（2）、展示</h5><p><code>pygame.display.flip()</code></p><h4 id="8、一些游戏效果原理"><a href="#8、一些游戏效果原理" class="headerlink" title="8、一些游戏效果原理"></a>8、一些游戏效果原理</h4><h5 id="（1）、动画原理"><a href="#（1）、动画原理" class="headerlink" title="（1）、动画原理"></a>（1）、动画原理</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">import</span> pygame<br><br><span class="hljs-attribute">if</span> __name__ == &#x27;__main__&#x27;:<br>    <span class="hljs-comment"># 初始化</span><br>    <span class="hljs-attribute">pygame</span>.init()<br>    <span class="hljs-attribute">window</span> = pygame.display.set_mode((<span class="hljs-number">400</span>, <span class="hljs-number">600</span>))<br>    <span class="hljs-attribute">window</span>.fill((<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))<br>    <span class="hljs-attribute">pygame</span>.display.flip()<br><br>    <span class="hljs-comment"># 球的圆心坐标</span><br>    <span class="hljs-attribute">x</span> = <span class="hljs-number">100</span><br>    <span class="hljs-attribute">y</span> = <span class="hljs-number">100</span><br>    <span class="hljs-attribute">r</span> = <span class="hljs-number">50</span><br>    <span class="hljs-attribute">add</span> = <span class="hljs-number">4</span><br>    <span class="hljs-attribute">y_speed</span> = <span class="hljs-number">2</span><br>    <span class="hljs-comment"># 游戏循环</span><br>    <span class="hljs-attribute">while</span> True:<br><br>        <span class="hljs-comment"># 延迟</span><br>        <span class="hljs-comment"># pygame.time.delay(10)</span><br><br>        <span class="hljs-comment"># 将之前纸上的内容给覆盖</span><br>        <span class="hljs-attribute">window</span>.fill((<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))<br>        <span class="hljs-comment"># 不断的画圆</span><br>        <span class="hljs-attribute">pygame</span>.draw.circle(window, (<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (x, y), r)<br>        <span class="hljs-attribute">pygame</span>.display.update()<br><br>        <span class="hljs-comment"># 改变y值让圆在垂直方向移动</span><br>        <span class="hljs-attribute">y</span> += y_speed<br>        <span class="hljs-comment"># r += add</span><br>        <span class="hljs-comment"># if r &gt;= 120 or r &lt;= 20:</span><br>        <span class="hljs-comment">#     add *= -1</span><br>        <span class="hljs-comment"># 边界检测</span><br>        <span class="hljs-attribute">if</span> y &gt; <span class="hljs-number">600</span> - r:<br>            <span class="hljs-attribute">y</span> = <span class="hljs-number">600</span> - r<br>            <span class="hljs-attribute">y_speed</span> = -<span class="hljs-number">2</span><br>        <span class="hljs-attribute">elif</span> y &lt; <span class="hljs-number">50</span>:<br>            <span class="hljs-attribute">y</span> = <span class="hljs-number">50</span><br>            <span class="hljs-attribute">y_speed</span> = <span class="hljs-number">2</span><br><br>        <span class="hljs-comment"># 事件检测</span><br>        <span class="hljs-attribute">for</span> event in pygame.event.get():<br>            <span class="hljs-attribute">if</span> event.type == pygame.QUIT:<br>                <span class="hljs-attribute">exit</span>()<br></code></pre></td></tr></table></figure><p>设置延迟：毫秒<br><code>pygame.time.delay（毫秒）</code></p><h5 id="（2）、按住不放原理"><a href="#（2）、按住不放原理" class="headerlink" title="（2）、按住不放原理"></a>（2）、按住不放原理</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">import</span> <span class="hljs-string">pygame</span><br><br><span class="hljs-string">if</span> <span class="hljs-string">__name__</span> <span class="hljs-string">==</span> <span class="hljs-attr">&#x27;__main__&#x27;:</span><br>    <span class="hljs-comment"># 游戏初始化</span><br>    <span class="hljs-string">pygame.init()</span><br>    <span class="hljs-string">window</span> <span class="hljs-string">=</span> <span class="hljs-string">pygame.display.set_mode((400,</span> <span class="hljs-number">600</span><span class="hljs-string">))</span><br>    <span class="hljs-string">window.fill((255,</span> <span class="hljs-number">255</span><span class="hljs-string">,</span> <span class="hljs-number">255</span><span class="hljs-string">))</span><br>    <span class="hljs-comment"># pygame.display.flip()</span><br><br>    <span class="hljs-comment"># 1.显示一张图片</span><br>    <span class="hljs-string">image</span> <span class="hljs-string">=</span> <span class="hljs-string">pygame.image.load(&#x27;./files/luffy4.jpg&#x27;)</span><br>    <span class="hljs-comment"># 缩放</span><br>    <span class="hljs-string">image</span> <span class="hljs-string">=</span> <span class="hljs-string">pygame.transform.rotozoom(image,</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-number">0.5</span><span class="hljs-string">)</span><br>    <span class="hljs-string">window.blit(image,</span> <span class="hljs-string">(100,</span> <span class="hljs-number">100</span><span class="hljs-string">))</span><br>    <span class="hljs-comment"># 获取图片的宽度和高度</span><br>    <span class="hljs-string">image_w,</span> <span class="hljs-string">image_h</span> <span class="hljs-string">=</span> <span class="hljs-string">image.get_size()</span><br><br>    <span class="hljs-string">pygame.display.flip()</span><br><br>    <span class="hljs-comment"># 用来存储图片是否移动</span><br>    <span class="hljs-string">flag</span> <span class="hljs-string">=</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 保存图片的坐标</span><br>    <span class="hljs-string">image_x,</span> <span class="hljs-string">image_y</span> <span class="hljs-string">=</span> <span class="hljs-number">100</span><span class="hljs-string">,</span> <span class="hljs-number">100</span><br><br>    <span class="hljs-comment"># 游戏循环</span><br>    <span class="hljs-attr">while True:</span><br>        <span class="hljs-string">for</span> <span class="hljs-string">event</span> <span class="hljs-string">in</span> <span class="hljs-string">pygame.event.get():</span><br>            <span class="hljs-string">if</span> <span class="hljs-string">event.type</span> <span class="hljs-string">==</span> <span class="hljs-attr">pygame.QUIT:</span><br>                <span class="hljs-string">exit()</span><br><br>            <span class="hljs-comment"># 鼠标按下</span><br>            <span class="hljs-string">if</span> <span class="hljs-string">event.type</span> <span class="hljs-string">==</span> <span class="hljs-attr">pygame.MOUSEBUTTONDOWN:</span><br>                <span class="hljs-comment"># 判断按下的位置是否在图片上</span><br>                <span class="hljs-string">m_x,</span> <span class="hljs-string">m_y</span> <span class="hljs-string">=</span> <span class="hljs-string">event.pos</span><br>                <span class="hljs-string">if</span> <span class="hljs-string">image_x&lt;=m_x&lt;=image_x+image_w</span> <span class="hljs-string">and</span> <span class="hljs-string">image_y&lt;=m_y&lt;=image_y+image_h:</span><br>                    <span class="hljs-string">flag</span> <span class="hljs-string">=</span> <span class="hljs-literal">True</span><br>            <span class="hljs-string">elif</span> <span class="hljs-string">event.type</span> <span class="hljs-string">==</span> <span class="hljs-attr">pygame.MOUSEBUTTONUP:</span><br>                <span class="hljs-string">flag</span> <span class="hljs-string">=</span> <span class="hljs-literal">False</span><br>            <span class="hljs-comment"># 鼠标移动事件</span><br>            <span class="hljs-comment"># (鼠标在移动并且flag是True)</span><br>            <span class="hljs-string">if</span> <span class="hljs-string">event.type</span> <span class="hljs-string">==</span> <span class="hljs-attr">pygame.MOUSEMOTION and flag:</span><br>                <span class="hljs-comment"># 填充背景色,覆盖原来的内容</span><br>                <span class="hljs-string">window.fill((255,</span> <span class="hljs-number">255</span><span class="hljs-string">,</span> <span class="hljs-number">255</span><span class="hljs-string">))</span><br>                <span class="hljs-comment"># 在鼠标移动的位置渲染图片</span><br>                <span class="hljs-comment"># window.blit(image, event.pos)</span><br>                <span class="hljs-string">center_x,</span> <span class="hljs-string">center_y</span> <span class="hljs-string">=</span> <span class="hljs-string">event.pos</span><br>                <span class="hljs-string">image_x,</span> <span class="hljs-string">image_y</span> <span class="hljs-string">=</span> <span class="hljs-string">center_x</span> <span class="hljs-bullet">-</span> <span class="hljs-string">image_w/2,</span> <span class="hljs-string">center_y-image_h/2</span><br>                <span class="hljs-string">window.blit(image,</span> <span class="hljs-string">(image_x,</span> <span class="hljs-string">image_y))</span><br>                <span class="hljs-comment"># 更新屏幕的显示</span><br>                <span class="hljs-string">pygame.display.update()</span><br></code></pre></td></tr></table></figure><p>##pygame小游戏</p><h5 id="1、小球碰撞"><a href="#1、小球碰撞" class="headerlink" title="1、小球碰撞"></a>1、小球碰撞</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;__author__=星辰&quot;</span><span class="hljs-string">&quot;&quot;</span><br>import pygame<br>import random<br>from time import <span class="hljs-keyword">sleep</span><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pygame.init()<br>    window = pygame.<span class="hljs-keyword">display</span>.set_mode((<span class="hljs-number">800</span>,<span class="hljs-number">600</span>))<br>    window.fill((<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>))<br>    pygame.<span class="hljs-keyword">display</span>.flip()<br>    list_balls=[]<br>    <span class="hljs-keyword">while</span> True:<br><br>        <span class="hljs-keyword">if</span> list_ball<span class="hljs-variable">s:</span><br>            <span class="hljs-keyword">for</span> <span class="hljs-keyword">ball</span> in list_ball<span class="hljs-variable">s:</span><br>                <span class="hljs-keyword">x</span>,<span class="hljs-keyword">y</span>=<span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;pos&#x27;</span>]<br>                r=<span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;re&#x27;</span>]<br>                <span class="hljs-built_in">index</span>=list_balls.<span class="hljs-built_in">index</span>(<span class="hljs-keyword">ball</span>)<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">index</span>&lt;<span class="hljs-built_in">len</span>(list_balls)-<span class="hljs-number">1</span>:<br>                    <span class="hljs-keyword">while</span> <span class="hljs-built_in">index</span>+<span class="hljs-number">1</span>&lt;<span class="hljs-built_in">len</span>(list_balls):<br>                        ball2=list_balls[<span class="hljs-built_in">index</span>+<span class="hljs-number">1</span>]<br>                        x2,y2=ball2[<span class="hljs-string">&#x27;pos&#x27;</span>]<br>                        <span class="hljs-keyword">if</span> (x2-<span class="hljs-keyword">x</span>)**<span class="hljs-number">2</span>+(y2-<span class="hljs-keyword">y</span>)**<span class="hljs-number">2</span>&lt;=(<span class="hljs-number">2</span>*r)**<span class="hljs-number">2</span>:<br>                            <span class="hljs-keyword">if</span> <span class="hljs-keyword">x</span>&gt;=x2:<br>                                <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;xs&#x27;</span>]=<span class="hljs-number">1</span><br>                                ball2[<span class="hljs-string">&#x27;xs&#x27;</span>]=-<span class="hljs-number">1</span><br>                            <span class="hljs-keyword">if</span> <span class="hljs-keyword">x</span>&lt;=x2:<br>                                <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;xs&#x27;</span>] = -<span class="hljs-number">1</span><br>                                ball2[<span class="hljs-string">&#x27;xs&#x27;</span>] = <span class="hljs-number">1</span><br><br>                            <span class="hljs-keyword">if</span> <span class="hljs-keyword">y</span>&gt;=y2:<br>                                <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;ys&#x27;</span>]=-<span class="hljs-number">1</span><br>                                ball2[<span class="hljs-string">&#x27;ys&#x27;</span>]=<span class="hljs-number">1</span><br>                            <span class="hljs-keyword">if</span> <span class="hljs-keyword">y</span>&lt;=y2:<br>                                <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;ys&#x27;</span>]=<span class="hljs-number">1</span><br>                                ball2[<span class="hljs-string">&#x27;ys&#x27;</span>]=-<span class="hljs-number">1</span><br>                        <span class="hljs-built_in">index</span> +=<span class="hljs-number">1</span><br><br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">x</span>+r&gt;=<span class="hljs-number">800</span>:<br>                    xs = -<span class="hljs-number">1</span><br>                    <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;xs&#x27;</span>]=xs<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">x</span>-r&lt;=<span class="hljs-number">0</span>:<br>                    xs = <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;xs&#x27;</span>] = xs<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">y</span>+r&gt;=<span class="hljs-number">600</span>:<br>                    ys = -<span class="hljs-number">1</span><br>                    <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;ys&#x27;</span>]=ys<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">y</span>-r&lt;=<span class="hljs-number">0</span>:<br>                    ys=<span class="hljs-number">1</span><br>                    <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;ys&#x27;</span>] = ys<br>                <span class="hljs-keyword">x</span> += <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;xs&#x27;</span>]<br>                <span class="hljs-keyword">y</span> += <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;ys&#x27;</span>]<br>                <span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;pos&#x27;</span>]=(<span class="hljs-keyword">x</span>,<span class="hljs-keyword">y</span>)<br>                pygame.draw.circle(window,<span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;rgb&#x27;</span>],(<span class="hljs-keyword">x</span>,<span class="hljs-keyword">y</span>),<span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;re&#x27;</span>],<span class="hljs-keyword">ball</span>[<span class="hljs-string">&#x27;width&#x27;</span>])<br>            <span class="hljs-keyword">sleep</span>(<span class="hljs-number">0.01</span>)<br>            pygame.<span class="hljs-keyword">display</span>.flip()<br><br>            window.fill((<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>))<br><br><br>        <span class="hljs-keyword">for</span> event in pygame.event.<span class="hljs-built_in">get</span>():<br>            <span class="hljs-keyword">if</span> event.<span class="hljs-built_in">type</span>==pygame.QUIT:<br>                <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">if</span> event.<span class="hljs-built_in">type</span>==pygame.MOUSEBUTTONDOWN:<br>                dic_ball = &#123;&#125;<br>                dic_ball[<span class="hljs-string">&#x27;rgb&#x27;</span>]=(random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">255</span>),random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">255</span>),random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">255</span>))<br>                dic_ball[<span class="hljs-string">&#x27;pos&#x27;</span>]=event.pos<br>                dic_ball[<span class="hljs-string">&#x27;re&#x27;</span>]=<span class="hljs-number">20</span><br>                dic_ball[<span class="hljs-string">&#x27;width&#x27;</span>]=<span class="hljs-number">0</span><br>                dic_ball[<span class="hljs-string">&#x27;xs&#x27;</span>]=[-<span class="hljs-number">1</span>,<span class="hljs-number">1</span>][random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)]<br>                dic_ball[<span class="hljs-string">&#x27;ys&#x27;</span>]=[-<span class="hljs-number">1</span>,<span class="hljs-number">1</span>][random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)]<br>                # pygame.draw.circle(window,dic_ball[<span class="hljs-string">&#x27;rgb&#x27;</span>],dic_ball[<span class="hljs-string">&#x27;pos&#x27;</span>],dic_ball[<span class="hljs-string">&#x27;re&#x27;</span>],dic_ball[<span class="hljs-string">&#x27;width&#x27;</span>])<br>                list_balls.<span class="hljs-keyword">append</span>(dic_ball)<br>                pygame.<span class="hljs-keyword">display</span>.flip()<br>                <span class="hljs-keyword">sleep</span>(<span class="hljs-number">0.01</span>)<br>                window.fill((<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>))<br></code></pre></td></tr></table></figure><h5 id="2、接球游戏"><a href="#2、接球游戏" class="headerlink" title="2、接球游戏"></a>2、接球游戏</h5><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">import</span> pygame<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pygame.init()<br>    mx = <span class="hljs-number">0</span><br>    my = <span class="hljs-number">300</span><br>    m_width=<span class="hljs-number">100</span><br>    m_height=<span class="hljs-number">10</span><br>    window = pygame.display.set_mode((<span class="hljs-number">600</span>,<span class="hljs-number">400</span>))<br>    window.fill((<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>))<br>    pygame.draw.rect(window,(<span class="hljs-number">255</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),(mx,my,m_width,m_height),<span class="hljs-number">0</span>)<br>    pygame.display.flip()<br><br><br><br>    xs=<span class="hljs-number">1</span><br>    ys=<span class="hljs-number">1</span><br>    x=random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">600</span>)<br>    y=random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">400</span>)<br><br><br>    <span class="hljs-keyword">while</span> True:<br>        pygame.draw.circle(window, (<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (x, y), <span class="hljs-number">20</span>, <span class="hljs-number">0</span>)<br>        pygame.draw.rect(window, (<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (mx, my, m_width, m_height), <span class="hljs-number">0</span>)<br>        pygame.display.update()  # 可以刷新指定的范围<br>        x +=xs<br>        y +=ys<br>        window.fill((<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>))<br>        <span class="hljs-keyword">if</span> mx&lt;=(x+<span class="hljs-number">20</span>)&lt;=mx+m_width <span class="hljs-keyword">and</span> y+<span class="hljs-number">20</span>&gt;=<span class="hljs-number">300</span> :<br>            <span class="hljs-keyword">if</span> xs&gt;<span class="hljs-number">0</span>:<br>                xs = <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                xs = <span class="hljs-number">-1</span><br>            ys = <span class="hljs-number">-1</span><br>        elif x+<span class="hljs-number">20</span>==<span class="hljs-number">600</span> :<br>            xs = <span class="hljs-number">-1</span><br>        <span class="hljs-keyword">if</span> (x<span class="hljs-number">-20</span>)==<span class="hljs-number">0</span>:<br>            xs = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> (y<span class="hljs-number">-20</span>)==<span class="hljs-number">0</span>:<br>            ys = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> (y+<span class="hljs-number">20</span>)&gt;<span class="hljs-number">320</span>:<br>            exit(<span class="hljs-number">0</span>)<br><br><br>        sleep(<span class="hljs-number">0.01</span>)<br>        <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> pygame.event.<span class="hljs-keyword">get</span>():<br>            <span class="hljs-keyword">if</span> event.type == pygame.QUIT:<br>                exit(<span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">if</span> event.type == pygame.MOUSEMOTION:<br>                mx,my=event.pos<br>                mx=mx-m_width/<span class="hljs-number">2</span><br>                my=<span class="hljs-number">300</span><br><br></code></pre></td></tr></table></figure><h5 id="3、大球吃小球"><a href="#3、大球吃小球" class="headerlink" title="3、大球吃小球"></a>3、大球吃小球</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">import</span> pygame<br><span class="hljs-attribute">import</span> random<br><span class="hljs-attribute">from</span> time import sleep<br><span class="hljs-attribute">if</span> __name__==&#x27;__main__&#x27;:<br>    <span class="hljs-attribute">pygame</span>.init()<br>    <span class="hljs-attribute">window</span> = pygame.display.set_mode((<span class="hljs-number">800</span>,<span class="hljs-number">600</span>))<br>    <span class="hljs-attribute">window</span>.fill((<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>))<br>    <span class="hljs-attribute">pygame</span>.display.flip()<br>    <span class="hljs-attribute">list_balls</span>=[]<br>    <span class="hljs-attribute">while</span> True:<br><br>        <span class="hljs-attribute">if</span> list_balls:<br>            <span class="hljs-attribute">for</span> ball in list_balls:<br>                <span class="hljs-attribute">x</span>,y=ball[&#x27;pos&#x27;]<br>                <span class="hljs-attribute">r1</span>=ball[&#x27;re&#x27;]<br>                <span class="hljs-attribute">if</span> r<span class="hljs-number">1</span>&gt;=<span class="hljs-number">150</span>:<br>                    <span class="hljs-attribute">ball</span>[&#x27;re&#x27;]=<span class="hljs-number">10</span><br>                    <span class="hljs-attribute">r1</span>=<span class="hljs-number">10</span><br>                <span class="hljs-attribute">index</span>=list_balls.index(ball)<br>                <span class="hljs-attribute">if</span> index&lt;len(list_balls)-<span class="hljs-number">1</span>:<br>                    <span class="hljs-attribute">while</span> index+<span class="hljs-number">1</span>&lt;len(list_balls):<br>                        <span class="hljs-attribute">ball2</span>=list_balls[index+<span class="hljs-number">1</span>]<br>                        <span class="hljs-attribute">r2</span> = ball<span class="hljs-number">2</span>[&#x27;re&#x27;]<br>                        <span class="hljs-attribute">x2</span>,y<span class="hljs-number">2</span>=ball<span class="hljs-number">2</span>[&#x27;pos&#x27;]<br>                        <span class="hljs-attribute">if</span> (x<span class="hljs-number">2</span>-x)**<span class="hljs-number">2</span>+(y<span class="hljs-number">2</span>-y)**<span class="hljs-number">2</span>&lt;=(r<span class="hljs-number">1</span>+r<span class="hljs-number">2</span>)**<span class="hljs-number">2</span>:<br>                            <span class="hljs-attribute">if</span> r<span class="hljs-number">1</span>&gt;r<span class="hljs-number">2</span>:<br>                                <span class="hljs-attribute">ball</span>[&#x27;re&#x27;]=int(r<span class="hljs-number">1</span>+r<span class="hljs-number">2</span>/<span class="hljs-number">2</span>)<br>                                <span class="hljs-attribute">list_balls</span>.remove(ball<span class="hljs-number">2</span>)<br>                            <span class="hljs-attribute">if</span> r<span class="hljs-number">1</span>&lt;=r<span class="hljs-number">2</span>:<br>                                <span class="hljs-attribute">ball2</span>[&#x27;re&#x27;] =int(r<span class="hljs-number">2</span> + r<span class="hljs-number">1</span> / <span class="hljs-number">2</span>)<br>                                <span class="hljs-attribute">list_balls</span>.remove(ball)<br>                        <span class="hljs-attribute">index</span> +=<span class="hljs-number">1</span><br><br>                <span class="hljs-attribute">if</span> x+r<span class="hljs-number">1</span>&gt;=<span class="hljs-number">800</span>:<br>                    <span class="hljs-attribute">xs</span> = -<span class="hljs-number">1</span><br>                    <span class="hljs-attribute">ball</span>[&#x27;xs&#x27;]=xs<br>                <span class="hljs-attribute">if</span> x-r<span class="hljs-number">1</span>&lt;=<span class="hljs-number">0</span>:<br>                    <span class="hljs-attribute">xs</span> = <span class="hljs-number">1</span><br>                    <span class="hljs-attribute">ball</span>[&#x27;xs&#x27;] = xs<br>                <span class="hljs-attribute">if</span> y+r<span class="hljs-number">1</span>&gt;=<span class="hljs-number">600</span>:<br>                    <span class="hljs-attribute">ys</span> = -<span class="hljs-number">1</span><br>                    <span class="hljs-attribute">ball</span>[&#x27;ys&#x27;]=ys<br>                <span class="hljs-attribute">if</span> y-r<span class="hljs-number">1</span>&lt;=<span class="hljs-number">0</span>:<br>                    <span class="hljs-attribute">ys</span>=<span class="hljs-number">1</span><br>                    <span class="hljs-attribute">ball</span>[&#x27;ys&#x27;] = ys<br>                <span class="hljs-attribute">x</span> += ball[&#x27;xs&#x27;]<br>                <span class="hljs-attribute">y</span> += ball[&#x27;ys&#x27;]<br>                <span class="hljs-attribute">ball</span>[&#x27;pos&#x27;]=(x,y)<br>                <span class="hljs-attribute">pygame</span>.draw.circle(window,ball[&#x27;rgb&#x27;],(x,y),ball[&#x27;re&#x27;],ball[&#x27;width&#x27;])<br>            <span class="hljs-attribute">sleep</span>(<span class="hljs-number">0</span>.<span class="hljs-number">001</span>)<br>            <span class="hljs-attribute">pygame</span>.display.flip()<br><br>            <span class="hljs-attribute">window</span>.fill((<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>))<br><br><br>        <span class="hljs-attribute">for</span> event in pygame.event.get():<br>            <span class="hljs-attribute">if</span> event.type==pygame.QUIT:<br>                <span class="hljs-attribute">exit</span>(<span class="hljs-number">0</span>)<br>            <span class="hljs-attribute">if</span> event.type==pygame.MOUSEBUTTONDOWN:<br>                <span class="hljs-attribute">dic_ball</span> = &#123;&#125;<br>                <span class="hljs-attribute">dic_ball</span>[&#x27;rgb&#x27;]=(random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">255</span>),random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">255</span>),random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">255</span>))<br>                <span class="hljs-attribute">dic_ball</span>[&#x27;pos&#x27;]=event.pos<br>                <span class="hljs-attribute">dic_ball</span>[&#x27;re&#x27;]=random.randint(<span class="hljs-number">10</span>,<span class="hljs-number">30</span>)<br>                <span class="hljs-attribute">dic_ball</span>[&#x27;width&#x27;]=<span class="hljs-number">0</span><br>                <span class="hljs-attribute">dic_ball</span>[&#x27;xs&#x27;]=[-<span class="hljs-number">1</span>,<span class="hljs-number">1</span>][random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)]<br>                <span class="hljs-attribute">dic_ball</span>[&#x27;ys&#x27;]=[-<span class="hljs-number">1</span>,<span class="hljs-number">1</span>][random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)]<br>                <span class="hljs-comment"># pygame.draw.circle(window,dic_ball[&#x27;rgb&#x27;],dic_ball[&#x27;pos&#x27;],dic_ball[&#x27;re&#x27;],dic_ball[&#x27;width&#x27;])</span><br>                <span class="hljs-attribute">list_balls</span>.append(dic_ball)<br>                <span class="hljs-attribute">pygame</span>.display.flip()<br>                <span class="hljs-attribute">sleep</span>(<span class="hljs-number">0</span>.<span class="hljs-number">01</span>)<br>                <span class="hljs-attribute">window</span>.fill((<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>))<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pygame</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>文件操作和异常捕获</title>
    <link href="/Myblog/2018/09/03/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%92%8C%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7/"/>
    <url>/Myblog/2018/09/03/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%92%8C%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7/</url>
    
    <content type="html"><![CDATA[<h3 id="一、文件操作"><a href="#一、文件操作" class="headerlink" title="一、文件操作"></a>一、文件操作</h3><h6 id="1、基本过程："><a href="#1、基本过程：" class="headerlink" title="1、基本过程："></a>1、基本过程：</h6><p>打开文件 — 操作 — 关闭文件<br>open：(路径，打开方式，encoding=编码方式)<br>路径：绝对路径（了解），相对路径： ./ ， ../ ， …/<br>打开方式：r， rb，w，wb，a<br>注意：路径不存在的时候，读的形式打开会报错，写的形式打开会自动创建文件。<br>设置编码方式：utf-8 ， gbk<br>注意：如果以二进制的方式打开文件（rb，wb），不能设置编码方式。</p><h6 id="2、文件的读和写："><a href="#2、文件的读和写：" class="headerlink" title="2、文件的读和写："></a>2、文件的读和写：</h6><p>read（）、readline（） – 读<br>write（） – 写</p><h6 id="3、关闭"><a href="#3、关闭" class="headerlink" title="3、关闭"></a>3、关闭</h6><p>close（）    —- 良好的习惯</p><h6 id="4、打开文件和关闭文件的简写方式（常用的）"><a href="#4、打开文件和关闭文件的简写方式（常用的）" class="headerlink" title="4、打开文件和关闭文件的简写方式（常用的）"></a>4、打开文件和关闭文件的简写方式（常用的）</h6><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment">#文件打开操作完成后，会自动关闭文件</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>（） <span class="hljs-keyword">as</span> 文件变量名：<br>  文件操作<br></code></pre></td></tr></table></figure><ul><li>下载文件的本质就是从网络上下载二进制数据，再写入本地文件。<br>二进制文件（图片、视频等）只能用二进制方式（rb、wb）打开。<br><img src="https://upload-images.jianshu.io/upload_images/13692175-ec01e62198b43249.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><h3 id="二、json文件"><a href="#二、json文件" class="headerlink" title="二、json文件"></a>二、json文件</h3>json是有特定格式的一种文本形式，它有自己的语法。（.json文件）<h6 id="1、json格式对应的数据类型及其表现。"><a href="#1、json格式对应的数据类型及其表现。" class="headerlink" title="1、json格式对应的数据类型及其表现。"></a>1、json格式对应的数据类型及其表现。</h6></li><li><strong>一个json文件中只能存一个数据，这个数据的类型必须是以下类型中的一个，并且只能用双引号。</strong><br>对象（object）—– {“a”:10,”b”:[1,2]} 相当于Python的字典<br>数组（array）—– [100,”abc”,true,[1,2]] 相当于Python的列表<br>数字（number）—– 0,100,3.14<br>字符串（string）—–  “abc”<br>True —–  true/false<br>null —– null（空值）</li></ul><p>json模块是python中内置的，专门处理json数据的一个模块。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">import json<br><span class="hljs-keyword">with</span> <span class="hljs-keyword">open</span>(<span class="hljs-string">&#x27;./files/json1.json&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-keyword">encoding</span>=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>  <span class="hljs-keyword">content</span> = json1.json<br>  <br></code></pre></td></tr></table></figure><h6 id="2、python-对-json-数据的支持"><a href="#2、python-对-json-数据的支持" class="headerlink" title="2、python 对 json 数据的支持"></a>2、python 对 json 数据的支持</h6><p><strong>A、json –&gt; python</strong><br>（1）、json.load（json文件对象）：以json的格式，获取文件中的内容。将内容转换成相应的python数据。<br>（2）、json.loads（json格式内容的字符串，编码方式）：将json格式的字符串转换成python对应的数据。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">json</span> <span class="hljs-comment">---&gt; python</span><br>对象 <span class="hljs-comment">---&gt; 字典</span><br>数组 <span class="hljs-comment">---&gt; 列表</span><br>数字 <span class="hljs-comment">---&gt; 整数、浮点数</span><br><span class="hljs-keyword">true</span>，<span class="hljs-keyword">false</span> <span class="hljs-comment">---&gt; 布尔（True，False）</span><br><span class="hljs-keyword">null</span> <span class="hljs-comment">---&gt; None</span><br></code></pre></td></tr></table></figure><p><strong>B、python –&gt; json</strong></p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livescript">python ---&gt; json<br>字典 ---&gt; 对象<br>列表、元组 ---&gt; 数组<br>整数、浮点数 ---&gt; 数字<br>True，False ---&gt; <span class="hljs-literal">true</span>,<span class="hljs-literal">false</span><br>字符串 ---&gt; 字符串（双引号）<br>None ---&gt; <span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure><p>（1）、json.dump（写入json文件中的python数据，json对象）<br>（2）、json.dumps（转换成json格式字符串的python数据）</p><h6 id="3-异常捕获"><a href="#3-异常捕获" class="headerlink" title="3.异常捕获"></a>3.异常捕获</h6><p><strong>程序出现某种异常，但是不想因为这个异常而让程序崩溃。这个时候就可以使用异常捕获机制。</strong></p><ul><li>执行过程：依次执行try后面的代码块，一旦遇到异常，就马上执行except后面的代码块。执行完后再执行其他的代码。<br>如果try里面的代码块没有异常，就不执行except后面的代码，而执行其他的代码。</li></ul><p>形式一（捕获所有异常）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>  需要捕获异常的代码块（可能会出现异常的代码块）<br><span class="hljs-keyword">except</span>:<br>  出现异常后执行的代码<br><br>a = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>]<br><span class="hljs-keyword">try</span>:<br>    print(a[<span class="hljs-number">5</span>])<br><span class="hljs-keyword">except</span>:<br>    print(<span class="hljs-string">&#x27;捕获到异常&#x27;</span>)<br></code></pre></td></tr></table></figure><p>形式二（捕获指定类型）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>  需要捕获异常的代码块（可能会出现异常的代码块）<br><span class="hljs-keyword">except</span> 错误类型:<br>  出现异常后执行的代码<br><br>a = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>]<br><span class="hljs-keyword">try</span>:<br>    print(a[<span class="hljs-number">5</span>])<br><span class="hljs-keyword">except</span> IndexError:<br>    print(<span class="hljs-string">&#x27;捕获到异常&#x27;</span>)<br><br>a = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>]<br><span class="hljs-keyword">try</span>:<br>    print(a[<span class="hljs-number">5</span>])<br><span class="hljs-keyword">except</span> (IndexError,KeyError):<br>    print(<span class="hljs-string">&#x27;捕获到异常&#x27;</span>)<br></code></pre></td></tr></table></figure><p>形式三（捕获到异常进行多种处理）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>  需要捕获的异常的代码块（可能会出现异常的代码块）<br><span class="hljs-keyword">except</span> 错误类型<span class="hljs-number">1</span>:<br>  执行语句<span class="hljs-number">1</span><br><span class="hljs-keyword">except</span> 错误类型<span class="hljs-number">2</span>:<br>  执行语句<span class="hljs-number">2</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">还是只会捕获到一个异常</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>形式四（finally:不管有没有异常，即使崩溃，也会执行finally里面的的东西。）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>  需要捕获的异常的代码块（可能会出现异常的代码块）<br><span class="hljs-keyword">except</span> 错误类型<span class="hljs-number">1</span>:<br>  执行语句<span class="hljs-number">1</span><br><span class="hljs-keyword">except</span> 错误类型<span class="hljs-number">2</span>:<br>  执行语句<span class="hljs-number">2</span><br><span class="hljs-keyword">finally</span>:<br>  执行语句   <br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">finally:不管有没有异常，都会执行finally里面的的东西。</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">user_input</span>():</span><br>    <span class="hljs-keyword">try</span>:<br>        numb1 = float(input(<span class="hljs-string">&#x27;请输入除数:&#x27;</span>))<br>        numb2 = float(input(<span class="hljs-string">&#x27;请输入被除数:&#x27;</span>))<br>    <span class="hljs-keyword">except</span> ValueError:<br>        print(<span class="hljs-string">&#x27;输入类型错误，请输入数字！！&#x27;</span>)<br>        user_input()<br>    test(numb1,numb2)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span>(<span class="hljs-params">n,y</span>):</span><br>    <span class="hljs-keyword">try</span>:<br>        print(<span class="hljs-string">&#x27;%f / %f = %.2f&#x27;</span> % (n,y,n/y))<br>    <span class="hljs-keyword">except</span> ZeroDivisionError:<br>        print(<span class="hljs-string">&#x27;被除数不能为0&#x27;</span>)<br>        user_input()<br>    <span class="hljs-keyword">finally</span>:<br>        print(<span class="hljs-string">&#x27;哈哈哈哈哈哈&#x27;</span>)<br>user_input()<br></code></pre></td></tr></table></figure><h6 id="4、抛出异常（以后补充）"><a href="#4、抛出异常（以后补充）" class="headerlink" title="4、抛出异常（以后补充）"></a>4、抛出异常（以后补充）</h6><p><strong>raise 异常类型</strong></p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>模块定义和文件操作</title>
    <link href="/Myblog/2018/08/31/%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89%E5%92%8C%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/"/>
    <url>/Myblog/2018/08/31/%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89%E5%92%8C%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<p><strong>补充：按住Ctrl同时点击模块名，可以查看模块内的方法（实现内容大多数被加密）。</strong></p><h4 id="一、什么是模块？："><a href="#一、什么是模块？：" class="headerlink" title="一、什么是模块？："></a>一、什么是模块？：</h4><p>对变量、函数、类进行封装，每一个py文件就是一个模块。</p><ul><li>怎么使用其他模块中的内容？</li></ul><h6 id="a、import-模块"><a href="#a、import-模块" class="headerlink" title="a、import 模块"></a>a、import 模块</h6><p>通过 “模块.内容” 的形式去使用模块中的内容（全局变量、函数、类）</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">import</span> my_list<br>my_list.count([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>])<br></code></pre></td></tr></table></figure><h6 id="b、from-模块-import-模块中的内容"><a href="#b、from-模块-import-模块中的内容" class="headerlink" title="b、from 模块 import 模块中的内容"></a>b、from 模块 import 模块中的内容</h6><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">from</span> my_list <span class="hljs-keyword">import</span> count<br>count([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>])<br>#这样导入可以直接使用模块中的内容。<br></code></pre></td></tr></table></figure><h6 id="c、from-模块-import"><a href="#c、from-模块-import" class="headerlink" title="c、from 模块 import  *"></a>c、from 模块 import  *</h6><p>导入模块中的所有内容</p><h4 id="二、重命名"><a href="#二、重命名" class="headerlink" title="二、重命名"></a>二、重命名</h4><p><strong>import 模块 as 新名字<br>import 模块 import 内容 as 新名字</strong></p><ul><li><p>如果不导入模块后出现一些不希望使用的内容，可以把这些内容放在这个 if 语句里面</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section">#将不希望被别的模块导入（执行）的代码放在这个if语句中。</span><br>if <span class="hljs-strong">__name__</span> == &#x27;<span class="hljs-strong">__main__</span>&#x27;:<br></code></pre></td></tr></table></figure></li><li><p>原理：每个模块都有一个__name __属性。<br>a、这个属性的默认值就是当前模块的文件名（别人导入的情况）。<br>b、当当前模块正在被执行（直接在当前模块中点击run）的时候，__name __属性的值是__main __。<br>所以当别人导入这个模块的时候，名字变成了当前模块的文件名，if条件不成立，便不会执行之后的代码。</p></li><li><p>建议：函数声明、类的声明、一些希望被外部使用的全局变量，一般写在 if 的外面，其他写在 if 里面</p></li></ul><h4 id="三、文件"><a href="#三、文件" class="headerlink" title="三、文件"></a>三、文件</h4><p><strong>程序中不管操作任何文件，不管怎么操作，过程都是一样的。</strong></p><ul><li>过程：打开文件 –&gt; 操作文件 –&gt; 关闭文件</li></ul><p>程序中通过变量、列表、字典等保存的数据，在程序结束后都会销毁。</p><p>数据持久化、本地化，都要使用文件来保存数据（数据库文件、txt文档、json文件、plist文件、xml文件、二进制文件（图片、音频、视频等））</p><h6 id="1、打开文件"><a href="#1、打开文件" class="headerlink" title="1、打开文件"></a>1、打开文件</h6><p><strong>open（文件地址，打开方式，encoding=编码方式）</strong></p><p><strong>文件地址</strong>：填文件路径（绝对路径和相对路径）<br>相对路径：<br>./ 相对路径（相对于当前文件所在的目录）<br>../相对路径（相对于当前文件目录的上一个目录）<br>…/相对路径（相对于当前文件目录的上两个目录）</p><p><strong>打开方式</strong>：读和写的方式<br>‘r’ –&gt; 读（默认值），读出来的文字以文本形式返回<br>‘rb’ / ‘br’  –&gt; 读，读出来的内容以二进制（bytes）的形式返回<br>‘w’ –&gt; 写，写文本到文件中<br>‘wb’ / ‘bw’ –&gt; 写，以二进制数据（bytes）到文件中<br>‘a’ –&gt; 写，追加</p><p><strong>编码方式</strong>：以文本的形式读和写的时候才需要设置编码方式。<br>utf-8：万国码<br>gbk：只支持中文</p><p><strong>返回值</strong>：open函数的返回值是被打开的文件对象</p><h6 id="2-操作文件"><a href="#2-操作文件" class="headerlink" title="2.操作文件"></a>2.操作文件</h6><p><strong>a、读文件</strong><br>关闭文件之前，因为指针问题，每次读操作接着上次指针的位置继续读取。</p><p><strong>f.readline(): 每次读一行</strong></p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs maxima">f = open(&#x27;../<span class="hljs-number">1111.</span>txt&#x27;,&#x27;r&#x27;)<br><span class="hljs-built_in">content</span> = f.<span class="hljs-built_in">readline</span>()<br><span class="hljs-keyword">while</span> <span class="hljs-built_in">content</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">content</span>)<br>    <span class="hljs-built_in">content</span> = f.<span class="hljs-built_in">readline</span>()<br>f.<span class="hljs-built_in">close</span><br></code></pre></td></tr></table></figure><p><strong>b、写操作</strong><br>打开方式是‘w’，操作会覆盖原文件；打开方式是‘a’，操作是在文件后追加。</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment">#会覆盖原来的文件</span><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;../1111.txt&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br>f.<span class="hljs-built_in">write</span>(<span class="hljs-string">&#x27;程序员的诗&#x27;</span>)<br>f.<span class="hljs-built_in">close</span><br></code></pre></td></tr></table></figure><h6 id="3、关闭文件"><a href="#3、关闭文件" class="headerlink" title="3、关闭文件"></a>3、关闭文件</h6><p>f.close()</p><h6 id="4、文件不存在的情况"><a href="#4、文件不存在的情况" class="headerlink" title="4、文件不存在的情况"></a>4、文件不存在的情况</h6><p>当以读的形式打开文件，文件不存在会报错。<br>当以写的形式（w、a）打开文件，文件会自动创建。</p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>函数基础03-生成器、装饰器</title>
    <link href="/Myblog/2018/08/30/%E5%87%BD%E6%95%B0%E5%9F%BA%E7%A1%8003-%E7%94%9F%E6%88%90%E5%99%A8%E3%80%81%E8%A3%85%E9%A5%B0%E5%99%A8/"/>
    <url>/Myblog/2018/08/30/%E5%87%BD%E6%95%B0%E5%9F%BA%E7%A1%8003-%E7%94%9F%E6%88%90%E5%99%A8%E3%80%81%E8%A3%85%E9%A5%B0%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<ul><li>函数就是一种特殊的类型。声明函数的时候，其实就是声明一个类型为function的变量，所以变量能做的事情，函数都能做。<h3 id="一、回调函数"><a href="#一、回调函数" class="headerlink" title="一、回调函数"></a>一、回调函数</h3><h5 id="1、函数作为函数的参数"><a href="#1、函数作为函数的参数" class="headerlink" title="1、函数作为函数的参数"></a>1、函数作为函数的参数</h5><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs perl">ef clean_floor(<span class="hljs-keyword">time</span>):<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;%s,做地板清洁服务&#x27;</span>%time)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;收费100&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">100</span><br>def clean_kitchen(<span class="hljs-keyword">time</span>):<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;%s,做厨房清洁服务&#x27;</span>%time)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;收费200&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">200</span><br>def call_service(<span class="hljs-keyword">time</span>:str,service):<br>    service(<span class="hljs-keyword">time</span>)<br><br><span class="hljs-comment">#将函数作为参数，传给其他函数</span><br>call_service(<span class="hljs-string">&#x27;上午十点&#x27;</span>,clean_floor)<br>call_service(<span class="hljs-string">&#x27;下午五点&#x27;</span>,clean_kitchen)<br><br>结果：<br>上午十点,做地板清洁服务<br>收费<span class="hljs-number">100</span><br>下午五点,做厨房清洁服务<br>收费<span class="hljs-number">200</span><br></code></pre></td></tr></table></figure><h5 id="2、函数作为函数的返回值"><a href="#2、函数作为函数的返回值" class="headerlink" title="2、函数作为函数的返回值"></a>2、函数作为函数的返回值</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">operation</span>(<span class="hljs-params">operator:str</span>):</span><br>    <span class="hljs-keyword">if</span> operator == <span class="hljs-string">&#x27;+&#x27;</span>:<br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_sum</span>(<span class="hljs-params">*nums</span>):</span><br>            sum = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> nums:<br>                sum += num<br>            print(sum)<br>    <span class="hljs-keyword">elif</span> operator == <span class="hljs-string">&#x27;*&#x27;</span>:<br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_sum</span>(<span class="hljs-params">*nums</span>):</span><br>            sum1 = <span class="hljs-number">1</span><br>            <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> nums:<br>                sum1 *= num<br>            print(sum1)<br><br>        <span class="hljs-comment">#将函数返回</span><br>    <span class="hljs-keyword">return</span> my_sum    <span class="hljs-comment">#返回内部函数作为外部函数的返回值</span><br><br>operation(<span class="hljs-string">&#x27;+&#x27;</span>)(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br>operation(<span class="hljs-string">&#x27;*&#x27;</span>)(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)<br><br>结果：<br><span class="hljs-number">3</span><br><span class="hljs-number">24</span><br></code></pre></td></tr></table></figure><h3 id="二、生成器和迭代器"><a href="#二、生成器和迭代器" class="headerlink" title="二、生成器和迭代器"></a>二、生成器和迭代器</h3><ul><li><strong>生成器就是来生成迭代器，可以把迭代器看成一个容器，类似列表。</strong></li></ul></li><li><strong>生成式–产生一个迭代器的表达式（下面等号右边的式子）</strong><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#通过将生成式产生的迭代器转换成了一个列表</span><br><span class="hljs-attr">a</span> = (x for x in range(<span class="hljs-number">10</span>))<br></code></pre></td></tr></table></figure>说明：把等号右边全部保存给 a ，每次调用next（a）取一个值，并且保存已经调用的位置，下次调用next（a）时继续调用后面的值。</li></ul><p><strong>生成器和迭代器都是通过 next（）来获取里面的数据。不管通过什么方式取出数据，取出数据的位置不会返回。</strong><br><code>print(next(a))</code></p><h6 id="1、把生成式的结果转换成一个列表（-生成式-）："><a href="#1、把生成式的结果转换成一个列表（-生成式-）：" class="headerlink" title="1、把生成式的结果转换成一个列表（[生成式]）："></a>1、把生成式的结果转换成一个列表（[生成式]）：</h6><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">a = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>)]<br>print(a)<br>[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]<br></code></pre></td></tr></table></figure><h6 id="2、把生成式的结果转换成一个字典："><a href="#2、把生成式的结果转换成一个字典：" class="headerlink" title="2、把生成式的结果转换成一个字典："></a>2、把生成式的结果转换成一个字典：</h6><p>条件：生成式生成的结果是一个元组，并且元组的元素个数必须是 2</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">dict1 = dict((x,x*<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>))<br>print(dict1)<br>&#123;<span class="hljs-number">0</span>: <span class="hljs-number">0</span>, <span class="hljs-number">1</span>: <span class="hljs-number">2</span>, <span class="hljs-number">2</span>: <span class="hljs-number">4</span>, <span class="hljs-number">3</span>: <span class="hljs-number">6</span>, <span class="hljs-number">4</span>: <span class="hljs-number">8</span>, <span class="hljs-number">5</span>: <span class="hljs-number">10</span>, <span class="hljs-number">6</span>: <span class="hljs-number">12</span>, <span class="hljs-number">7</span>: <span class="hljs-number">14</span>, <span class="hljs-number">8</span>: <span class="hljs-number">16</span>, <span class="hljs-number">9</span>: <span class="hljs-number">18</span>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">#用生成式交换字典key和<span class="hljs-keyword">value</span><br>dict1 = dict((<span class="hljs-keyword">value</span>,key) <span class="hljs-keyword">for key</span>,<span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> &#123;<span class="hljs-string">&#x27;a&#x27;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;b&#x27;</span>:<span class="hljs-number">2</span>&#125;.items())<br>print(dict1)<br>&#123;<span class="hljs-number">1</span>: <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">2</span>: <span class="hljs-string">&#x27;b&#x27;</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="三、生成器"><a href="#三、生成器" class="headerlink" title="三、生成器"></a>三、生成器</h3><h5 id="yield-关键字"><a href="#yield-关键字" class="headerlink" title="yield 关键字"></a>yield 关键字</h5><p>只要函数中有 yield 关键字，不管执行yield语句与否，这个函数都会变成一个生成器。<br>a、有 yield 的函数，在调用函数的时候不再是获取返回值，而是产生一个生成器对象，生成器对象中保留的是函数体。<br>b、当通过 next 获取生成器中的数据的时候，才会去执行函数体，执行到 yield 为止，并且将 yiled 后面的结果作为生成的数据返回，同时记录结束的位置，下次再调用 next 的时候，从上次结束的位置接着往后执行。</p><p>练习：写一个生成器，可以产生一个斐波那契数列</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 练习：</span><br>def fib():<br>    yield 1<br>    yield 1<br>    x = 1<br>    y = 1<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            x,y = x+y,x<br>            yield x<br>n = fib()   #必须保存一下，不然直接next会产生多个生成器，每次取第一个值，结果全为 1 <br><span class="hljs-builtin-name">print</span>(next(n),<span class="hljs-attribute">end</span>=<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-builtin-name">print</span>(next(n),<span class="hljs-attribute">end</span>=<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-builtin-name">print</span>(next(n),<span class="hljs-attribute">end</span>=<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-builtin-name">print</span>(next(n),<span class="hljs-attribute">end</span>=<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-builtin-name">print</span>(next(n),<span class="hljs-attribute">end</span>=<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-builtin-name">print</span>(next(n),<span class="hljs-attribute">end</span>=<span class="hljs-string">&#x27; &#x27;</span>)<br>结果：<br>1 1 2 3 5 8 <br></code></pre></td></tr></table></figure><h3 id="四、迭代器-–-iter"><a href="#四、迭代器-–-iter" class="headerlink" title="四、迭代器 – iter"></a>四、迭代器 – iter</h3><p>生成器和生成式产生的对象就是迭代器。<br>将列表转换成迭代器对象</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lisp">iter1 = iter([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>])<br>print(<span class="hljs-name">iter1</span>)<br>print(<span class="hljs-name">next</span>(<span class="hljs-name">iter1</span>))<br>print(<span class="hljs-name">next</span>(<span class="hljs-name">iter1</span>))<br>print(<span class="hljs-name">next</span>(<span class="hljs-name">iter1</span>))<br><span class="hljs-number">1</span><br><span class="hljs-number">2</span><br><span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p>利用 iter 把其他类型转换成迭代器，取出时候都是用 next 取出，和生成器一样，只是产生方式不同。</p><h3 id="五、装饰器"><a href="#五、装饰器" class="headerlink" title="五、装饰器"></a>五、装饰器</h3><p>装饰器函数：用一个函数装饰另一个函数,装饰器函数的参数是被装饰的函数，返回一个装饰后的函数,当调用被装饰的函数时，其实执行的是装饰器中返回的函数,给他增加额外的功能，凡是需要这个额外的功能的地方,只需要加上装饰器即可，而不需要书写额外的代码。</p><p>给函数添加装饰器的语法，就是在函数前添加@函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> perf_counter<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">record</span>(<span class="hljs-params">func</span>):</span><br><span class="hljs-meta">    @wraps(func)  # 保留函数本身的名字</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):</span><br>        start = perf_counter()<br>        ret_value = func(*args, **kwargs)<br>        end = perf_counter()<br>        print(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;end - start&#125;</span>s&#x27;</span>)<br>        <span class="hljs-keyword">return</span> ret_value<br><br>    <span class="hljs-keyword">return</span> wrapper <br><br><span class="hljs-comment"># 这里加了装饰器的函数，被调用的时候，实际上是调用的weapper函数</span><br><span class="hljs-meta">@record</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fac</span>(<span class="hljs-params">num</span>):</span><br>    result = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, num + <span class="hljs-number">1</span>):<br>        result *= n<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>):<br>        print(fac(num))<br><br></code></pre></td></tr></table></figure><p>如果想要使用带参数的装饰器，需要再嵌套一层函数</p><p>示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> perf_counter, sleep<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">record</span>(<span class="hljs-params">output</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorate</span>(<span class="hljs-params">func</span>):</span><br><br><span class="hljs-meta">        @wraps(func)</span><br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):</span><br>            start = perf_counter()<br>            ret_value = func(*args, **kwargs)<br>            end = perf_counter()<br>            output(func.__name__, end - start)<br>            <span class="hljs-keyword">return</span> ret_value<br><br>        <span class="hljs-keyword">return</span> wrapper<br><br>    <span class="hljs-keyword">return</span> decorate<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">output_to_file</span>(<span class="hljs-params">fname, duration</span>):</span><br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;log.txt&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>) <span class="hljs-keyword">as</span> file_stream:<br>        file_stream.write(<span class="hljs-string">&#x27;%s:%.3fs&#x27;</span>%(fname, duration))<br><br>        <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">output_to_console</span>(<span class="hljs-params">fname, duration</span>):</span><br>    print(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;fname&#125;</span>: <span class="hljs-subst">&#123;duration&#125;</span>&#x27;</span>)<br><br>    <br><span class="hljs-meta">@record(output_to_file)   # 将函数作为参数传入，作为装饰器的参数</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    sleep(randint(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>函数</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>函数基础02-匿名函数、递归函数</title>
    <link href="/Myblog/2018/08/30/%E5%87%BD%E6%95%B0%E5%9F%BA%E7%A1%8002-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0%E3%80%81%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0/"/>
    <url>/Myblog/2018/08/30/%E5%87%BD%E6%95%B0%E5%9F%BA%E7%A1%8002-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0%E3%80%81%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h3 id="一、匿名函数"><a href="#一、匿名函数" class="headerlink" title="一、匿名函数"></a>一、匿名函数</h3><p>匿名函数本质还是函数，之前函数的所有内容仍然适用。</p><h5 id="1、匿名函数的声明"><a href="#1、匿名函数的声明" class="headerlink" title="1、匿名函数的声明"></a>1、匿名函数的声明</h5><p>函数名 = lambda  参数列表：返回值</p><h5 id="2、说明"><a href="#2、说明" class="headerlink" title="2、说明"></a>2、说明</h5><p><strong>函数名</strong>：本质是一个变量存储右边的函数。（可无）<br><strong>lambda</strong>：声明匿名函数的关键字。<br><strong>参数列表</strong>：参数名1，参数名2，……<br><strong>冒号</strong>：固定写法。<br><strong>返回值</strong>：表达式的值就是返回值。</p><figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gml">#用匿名函数计算两个数的和<br>my_sum = lambda <span class="hljs-symbol">x</span>, <span class="hljs-symbol">y</span>: <span class="hljs-symbol">x</span> + <span class="hljs-symbol">y</span><br>print(my_sum(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))<br><br><span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h5 id="3、调用"><a href="#3、调用" class="headerlink" title="3、调用"></a>3、调用</h5><p>匿名函数的调用和普通函数一样：函数名（实参）</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">#<span class="hljs-number">1</span>、写一个匿名函数，获取指定数字列表，指定下标的值得<span class="hljs-number">1</span>/<span class="hljs-number">2</span><br>x = lambda list1,index:list1[index]/<span class="hljs-number">2</span><br>print(x([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],<span class="hljs-number">3</span>))<br><br># <span class="hljs-number">2</span>、获取一个列表所有元素的和和平均值（sum函数可以计算一个序列的和）<br>x = lambda list2 : (sum(list2), sum(list2)/len(list2))<br>sum,average = x([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>])<br>print(sum,average)<br>#或者这样取值<br>#print(x([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>])[<span class="hljs-number">0</span>])  <br></code></pre></td></tr></table></figure><p><strong>函数的调用过程是一个压栈的过程：</strong><br>每次调用一个函数，系统就会在内存区域中的栈区间取开辟空间，保存函数调用产生的数据。当函数调用完成后，对应的栈区间会自动销毁。<br>函数调用时产生的栈区间中保存的数据有：形参、函数中声明变量</p><h3 id="二、函数作用域"><a href="#二、函数作用域" class="headerlink" title="二、函数作用域"></a>二、函数作用域</h3><p>作用域：指的是一个变量能够使用的范围</p><h5 id="1、全局变量（global）"><a href="#1、全局变量（global）" class="headerlink" title="1、全局变量（global）"></a>1、全局变量（global）</h5><ul><li>全局变量：就是声明在函数和类外面的变量都是全局变量。</li><li>全局变量作用域：从声明开始到文件结束。</li></ul><h5 id="2、局部变量（local）"><a href="#2、局部变量（local）" class="headerlink" title="2、局部变量（local）"></a>2、局部变量（local）</h5><ul><li>局部变量：声明在函数中或者类的变量就是局部变量。</li><li>局部变量的作用域：从声明开始到函数结束（类结束）。<br>注意：函数的参数是声明在函数中的局部变量，同样不能在别的函数中使用。<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># x, y, z都是局部变量</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func3</span><span class="hljs-params">(x, y)</span></span><span class="hljs-symbol">:</span><br>  z = <span class="hljs-string">&#x27;ab&#x27;</span><br></code></pre></td></tr></table></figure></li><li>在局部区域内修改全局变量的值 — global<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-keyword">c</span> = <span class="hljs-number">100</span><br>def func<span class="hljs-number">1</span>():<br>    <span class="hljs-keyword">global</span> <span class="hljs-keyword">c</span>   #修改全局变量<br>    <span class="hljs-keyword">c</span> = <span class="hljs-number">200</span><br>func<span class="hljs-number">1</span>()<br>print(<span class="hljs-keyword">c</span>)<br></code></pre></td></tr></table></figure></li><li>在局部的局部中修改局部变量 — nonlocal<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func5</span>():</span><br>    nn = <span class="hljs-number">10</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func6</span>():</span><br>        <span class="hljs-keyword">nonlocal</span> nn<br>        nn = <span class="hljs-number">20</span><br>        print(<span class="hljs-string">&#x27;func6&#x27;</span>,nn)<br>    func6()<br>    print(<span class="hljs-string">&#x27;func5&#x27;</span>, nn)<br>func5()<br><br>func6 <span class="hljs-number">20</span><br>func5 <span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h3 id="三、递归函数"><a href="#三、递归函数" class="headerlink" title="三、递归函数"></a>三、递归函数</h3></li></ul><p><strong>递归函数</strong>：在函数的函数体中调用函数本身，这样的函数就是递归函数。</p><p><strong>注意</strong>：尽量不使用，递归函数反复调用函数，开辟空间，消耗内存。</p><h5 id="怎么写递归函数？"><a href="#怎么写递归函数？" class="headerlink" title="怎么写递归函数？"></a>怎么写递归函数？</h5><p>（1）、找临界值。（找到让循环结束的值/ 找到能够确定函数结果值）<br>（2）、假设函数的功能已经实现的前提下，找关系 f（n）和 f（n-1）/ 当次循环和上次循环的关系。<br>（3）、根据 f（n）和 f（n-1）的关系，来通过 f（n-1）实现 f（n）的效果。</p><p>练习：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">#练习一<br>#<span class="hljs-number">1</span>+<span class="hljs-number">2</span>+<span class="hljs-number">3</span>+...+<span class="hljs-number">100</span><br>def my_sum(n):<br>    #在临界值的位置一定要让函数结束<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> my_sum(n<span class="hljs-number">-1</span>) + n<br>print(my_sum(<span class="hljs-number">100</span>))<br><br>结果：<br><span class="hljs-number">5050</span><br><br>#练习二：计算斐波那契数列<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8.</span>..第n个数<br>def fib(n):<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> n == <span class="hljs-number">2</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> fib(n<span class="hljs-number">-1</span>) + fib(n<span class="hljs-number">-2</span>)<br>print(fib(<span class="hljs-number">5</span>))<br><br>结果：<br><span class="hljs-number">5</span><br><br>#练习三：使用递归完成以下效果<br>n = <span class="hljs-number">3</span><br>#***<br>#**<br># *<br>def xxx(n):<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span> :<br>        print(<span class="hljs-string">&#x27;*&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br>    print(<span class="hljs-string">&#x27;*&#x27;</span>*n)<br>    xxx(n<span class="hljs-number">-1</span>)<br>xxx(<span class="hljs-number">3</span>)<br><br>结果：<br>***<br>**<br>*<br></code></pre></td></tr></table></figure><p>思考一下程序结果和运行过程：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">def func():<br>    a = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">5</span>):<br>        a.append(lambda x:x*i)     #先把匿名函数存进去，没有计算返回值。<br>    <span class="hljs-keyword">return</span> a     #返回func（）值时，开始计算列表内的数，此时 i = <span class="hljs-number">4</span>，所以列表内所有匿名函数 i值都为<span class="hljs-number">4</span><br>aa = func()<br>print(aa[<span class="hljs-number">0</span>](<span class="hljs-number">2</span>), aa[<span class="hljs-number">2</span>](<span class="hljs-number">2</span>), aa[<span class="hljs-number">3</span>](<span class="hljs-number">2</span>))<br><br>结果：<br><span class="hljs-number">8</span> <span class="hljs-number">8</span> <span class="hljs-number">8</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>函数</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>函数基础01</title>
    <link href="/Myblog/2018/08/29/%E5%87%BD%E6%95%B0%E5%9F%BA%E7%A1%8001/"/>
    <url>/Myblog/2018/08/29/%E5%87%BD%E6%95%B0%E5%9F%BA%E7%A1%8001/</url>
    
    <content type="html"><![CDATA[<p>推荐一个网址：<a href="http://pythontutor.com/visualize.html#mode=edit">http://pythontutor.com/visualize.html#mode=edit</a><br>可以在线运行代码，观看执行过程，很好用。</p><hr><p><strong>没有函数，出现的问题是什么？</strong><br>1、同样的代码需要些多次。<br>2、一个功能的需求发生改变，需要修改多个地方。</p><ul><li>定义：函数就是对实现某一特定功能的代码段的封装。</li><li>作用：提高代码的复用度，让代码更简洁。<h3 id="一、函数分类"><a href="#一、函数分类" class="headerlink" title="一、函数分类"></a>一、函数分类</h3></li><li>内置函数：系统写好的，可以直接使用的函数。例如 print函数、input函数、sum函数等。</li><li>自定义函数：程序员自己创建的函数<h3 id="二、函数的说明"><a href="#二、函数的说明" class="headerlink" title="二、函数的说明"></a>二、函数的说明</h3><h5 id="1、固定格式："><a href="#1、固定格式：" class="headerlink" title="1、固定格式："></a>1、固定格式：</h5><figure class="highlight flix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs flix"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">函数名（参数列表）</span></span>:<br>  函数的说明文档<br>  函数体<br></code></pre></td></tr></table></figure>说明文档的格式：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download</span>(<span class="hljs-params">url</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    在这里写说明文档（函数功能描述）</span><br><span class="hljs-string">    :param url:下载数据的地址（对参数说明）</span><br><span class="hljs-string">    :return:None（返回值的说明）</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure><h5 id="2、-函数组成说明："><a href="#2、-函数组成说明：" class="headerlink" title="2、 函数组成说明："></a>2、 函数组成说明：</h5></li><li><strong>def</strong>：python中声明函数的关键字。</li><li><strong>函数名</strong>：标识符，不能是关键字。（规范：PEP8规则，见名知义）</li><li><strong>（）</strong>：固定格式，并且必须写。</li><li><strong>参数列表</strong>(行参)：参数名1，参数名2，参数名3…..（参数可以有多个，也可以不写）。<br>参数是用来从函数的外面，向函数里面传值用的。</li><li><strong>说明文档</strong>：说明函数功能。</li><li><strong>函数体</strong>：实现函数功能的代码段。<br>函数体中可能会包含return语句。<h5 id="3、初学者声明函数的过程："><a href="#3、初学者声明函数的过程：" class="headerlink" title="3、初学者声明函数的过程："></a>3、初学者声明函数的过程：</h5>1、确定函数的功能 ===》2、根据功能确定函数的名字 ===》 3、确定参数（确定函数需不需要从函数外面传递数据进来） ===》4、实现函数功能 ===》5、确定返回值<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#写一个函数，打印两个数的和</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mysum</span>(<span class="hljs-params">a,b</span>):</span><br>    <span class="hljs-keyword">return</span> a + b<br>print(mysum(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))<br><br><span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h5 id="4、函数的调用"><a href="#4、函数的调用" class="headerlink" title="4、函数的调用"></a>4、函数的调用</h5></li></ul><p><strong>格式：函数名（实参列表）<br>函数体只有调用的时候才会执行，并且只能先声明才能调用</strong></p><ul><li>实参列表：就是给形参赋值的<h5 id="5、函数的调用过程（重要）"><a href="#5、函数的调用过程（重要）" class="headerlink" title="5、函数的调用过程（重要）"></a>5、函数的调用过程（重要）</h5>（1）、回到函数声明的位置。<br>（2）、使用实参给形参赋值（传参）。<br>（3）、执行函数体。<br>（4）、将返回值返回给函数调用者。<br>（5）、回到函数调用的地方，接着往后执行。</li></ul><p>练习：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs excel">#写一个函数，打印一个整数的阶乘<br>def jiecheng(<span class="hljs-built_in">n</span>)<span class="hljs-symbol">:</span><br>    <span class="hljs-built_in">product</span> = <span class="hljs-number">1</span><br>    for <span class="hljs-built_in">index</span> in range(<span class="hljs-number">1</span>,<span class="hljs-built_in">n</span>+<span class="hljs-number">1</span>)<span class="hljs-symbol">:</span><br>        <span class="hljs-built_in">product</span> *= <span class="hljs-built_in">index</span><br>    print(<span class="hljs-built_in">product</span>)<br>jiecheng(<span class="hljs-number">5</span>)<br><br>结果：<br><span class="hljs-number">120</span><br></code></pre></td></tr></table></figure><h5 id="6、参数"><a href="#6、参数" class="headerlink" title="6、参数"></a>6、参数</h5><p>实参：<br>（1）、位置参数：实参的位置和形参一一对应。<br>（2）、关键字参数：通过 ‘ 形参名 = 实参 ’ 来传参。<br> <code>func1(b=&#39;abc&#39; , c=True , a=10)</code><br>（3）、关键字参数和位置结合：<br><code>func1(10, b=2, c=4)</code></p><p><strong>声明函数时，参数赋予默认值：</strong></p><ul><li>在声明函数的时候，可以参数赋默认值的。（可以参数赋默认值）</li><li>给部分参数赋默认值的时候，要求有默认值的参数必须放在参数列表的最后。</li><li>没有默认值的参数必须传参，有默认值的参数，可以传可以不传。<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">def func(a, <span class="hljs-attribute">b</span>=<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-attribute">c</span>=<span class="hljs-literal">True</span>):<br>  <span class="hljs-builtin-name">print</span>(a, b, c)<br>func(10)<br><br>结果：<br>10 a <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure></li></ul><p><strong>不定个数参数</strong></p><p>格式：def 函数名(*形参)</p><ul><li>python中通过在形参名前面加 * ，让这个形参变成一个元组，来让这个形参可以接受多个实参。<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">def mysum(*nums):<br>  print(nums, type(nums))<br>  sum = <span class="hljs-number">0</span><br>  <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> nums:<br>    sum += item<br>  print(sum)<br>mysum(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)<br><br>结果：<br>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>) &lt;<span class="hljs-keyword">class</span> &#x27;<span class="hljs-symbol">tuple</span>&#x27;&gt;<br><span class="hljs-symbol">15</span><br></code></pre></td></tr></table></figure>python不能直接约束一个变量的类型。但是可以通过说明，来提示用户调用参数的时候，参数的类型。<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs swift">def <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(name:str, age:int, study_id)</span></span>:<br>  <span class="hljs-built_in">print</span>(name)<br></code></pre></td></tr></table></figure>其中str、int有提示作用<h5 id="7、函数的返回值"><a href="#7、函数的返回值" class="headerlink" title="7、函数的返回值"></a>7、函数的返回值</h5></li><li>返回值：函数的返回值就是return关键字后面表达式的结果。就是函数调用表达式的结果。</li><li>python中所有的函数都有返回值，默认为None（没有return）。<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs fortran">def <span class="hljs-keyword">Pass</span>():<br>    <span class="hljs-keyword">pass</span><br><span class="hljs-built_in">print</span>(<span class="hljs-keyword">Pass</span>())<br><br>结果：<br><span class="hljs-keyword">None</span><br></code></pre></td></tr></table></figure></li><li>return 关键字<br> 1、确定返回值<br> 2、结束函数（函数中只要遇到return，函数就直接结束）</li></ul><p><strong>什么时候需要返回值？</strong><br>只要实现函数的功能会产生新的数据，就通过返回值将新的数据返回，并不是打印它。</p><p>练习：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">#练习：<span class="hljs-number">1</span>、写一个函数，统计一个列表中整数的个数<br>def count1(list):<br>    count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> list:<br>        <span class="hljs-keyword">if</span> isinstance(index,<span class="hljs-built_in">int</span>):<br>            count += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> count<br>print(count1([<span class="hljs-number">1</span>, <span class="hljs-number">1.2</span>, <span class="hljs-number">3.4</span> ,<span class="hljs-number">34.5</span>, <span class="hljs-number">34</span>, <span class="hljs-number">34</span>]))<br><br># <span class="hljs-number">2</span>、将一个数字列表中所有的元素的值都变成原来的<span class="hljs-number">2</span>倍<br>def list2(list_new):<br>    n = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> list_new:<br>        list_new[n] *= <span class="hljs-number">2</span><br>        n += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> list_new<br>print(list2([<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]))<br><br># <span class="hljs-number">3</span>、获取指定元素对应的下标<br>def list_1(list:list, item):<br>    index_list = []<br>    <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(len(list)):<br>        <span class="hljs-keyword">if</span> list[index] == item:<br>            index_list.append(index)<br>    <span class="hljs-keyword">return</span> index_list<br>print(list_1([<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>],<span class="hljs-number">3</span>))<br>结果：<br><span class="hljs-number">3</span><br>[<span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">12</span>]<br><span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>函数</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学生管理系统</title>
    <link href="/Myblog/2018/08/28/%E5%AD%A6%E7%94%9F%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/"/>
    <url>/Myblog/2018/08/28/%E5%AD%A6%E7%94%9F%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h3 id="学生管理系统"><a href="#学生管理系统" class="headerlink" title="学生管理系统"></a>学生管理系统</h3><p>练手小项目：学生管理系统</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">=================================================<br>XXX学生管理系统功能点<br><span class="hljs-number">1.</span>添加学生信息<br><span class="hljs-number">2.</span>查看学生信息<br><span class="hljs-number">3.</span>修改学生信息<br><span class="hljs-number">4.</span>删除学生信息<br><span class="hljs-number">5.</span>退出<br>要求<br><span class="hljs-number">1.</span>在一个系统中可以保存多个学生信息<br><span class="hljs-number">2.</span>添加学生（输入姓名、年龄、电话）到<span class="hljs-number">1</span>中的变量中<br><span class="hljs-number">3.</span>修改学生的电话（输入姓名，和电话）<br><span class="hljs-number">4.</span>删除学生（输入姓名，将其对应的信息从系统中删除）<br><span class="hljs-number">5.</span>退出系统<br></code></pre></td></tr></table></figure><h4 id="python版本"><a href="#python版本" class="headerlink" title="python版本"></a>python版本</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs vim">name = <span class="hljs-string">&#x27;&#x27;</span>   #存储用户信息<br>age = <span class="hljs-string">&#x27;&#x27;</span><br>tel = <span class="hljs-string">&#x27;&#x27;</span><br>python1806 = []<br><br><span class="hljs-keyword">while</span> True:<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;=================================================&#x27;</span>)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;                  1.添加学生信息&#x27;</span>)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;                  2.查看学生信息&#x27;</span>)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;                  3.修改学生信息&#x27;</span>)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;                  4.删除学生信息&#x27;</span>)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;                  5.退出&#x27;</span>)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;=================================================&#x27;</span>)<br>    n = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请输入你想执行的功能：&#x27;</span>)<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-string">&#x27;1&#x27;</span>:    #添加信息<br>        name = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请添加学生姓名：&#x27;</span>)<br>        age = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请添加学生年龄：&#x27;</span>)<br>        tel = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请添加学生电话：&#x27;</span>)<br>        dict_new = &#123;<span class="hljs-string">&#x27;name&#x27;</span>: name, <span class="hljs-string">&#x27;age&#x27;</span>: age, <span class="hljs-string">&#x27;tel&#x27;</span>: tel&#125;<br>        python1806.<span class="hljs-keyword">append</span>(dict_new)<br>        <span class="hljs-keyword">continue</span><br>    elif n == <span class="hljs-string">&#x27;2&#x27;</span>:    #查看信息<br>        <span class="hljs-keyword">for</span> <span class="hljs-built_in">index</span> in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(python1806)):<br>            <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;姓名：%s ，年龄：%s ，电话：%s&#x27;</span>%(python1806[<span class="hljs-built_in">index</span>][<span class="hljs-string">&#x27;name&#x27;</span>]\<br>                                             ,python1806[<span class="hljs-built_in">index</span>][<span class="hljs-string">&#x27;age&#x27;</span>],\<br>                                         python1806[<span class="hljs-built_in">index</span>][<span class="hljs-string">&#x27;tel&#x27;</span>]))<br>    elif n == <span class="hljs-string">&#x27;3&#x27;</span>:    #修改信息<br>        temp_index = []    #姓名相同时，临时存储姓名<br>        name_change = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请输入你想要修改信息的学生姓名：&#x27;</span>)<br>        <span class="hljs-keyword">for</span> <span class="hljs-built_in">index</span> in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(python1806)):    #依次查找学生信息<br>            <span class="hljs-keyword">if</span> python1806[<span class="hljs-built_in">index</span>][<span class="hljs-string">&#x27;name&#x27;</span>] == name_change:   #找到对应学生，修改信息<br>                temp_index.<span class="hljs-keyword">append</span>(<span class="hljs-built_in">index</span>)  #姓名相同学生所对应的下标都存在temp_index表里面去<br>            elif <span class="hljs-built_in">index</span> == <span class="hljs-built_in">len</span>(python1806) - <span class="hljs-number">1</span>:  #没有查找到对应学生<br>                <span class="hljs-keyword">if</span> not temp_index:<br>                    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;你输入的学生不存在！！&#x27;</span>)<br>                    <span class="hljs-keyword">break</span><br>        <span class="hljs-built_in">count</span> = []   #保存提示序号<br>        <span class="hljs-keyword">for</span> <span class="hljs-keyword">x</span> in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(temp_index)):   #给予用户相同姓名学生信息提示,进行选择修改<br>            <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;%d、姓名：%s 年龄：%s 电话：%s&#x27;</span>%(<span class="hljs-keyword">x</span>,python1806[temp_index[<span class="hljs-keyword">x</span>]][<span class="hljs-string">&#x27;name&#x27;</span>],\<br>                                          python1806[temp_index[<span class="hljs-keyword">x</span>]][<span class="hljs-string">&#x27;age&#x27;</span>], \<br>                                          python1806[temp_index[<span class="hljs-keyword">x</span>]][<span class="hljs-string">&#x27;tel&#x27;</span>]))<br>            <span class="hljs-built_in">count</span>.<span class="hljs-keyword">append</span>(<span class="hljs-keyword">x</span>)<br>        <span class="hljs-keyword">if</span> coun<span class="hljs-variable">t:</span><br>            num = <span class="hljs-keyword">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请输入你要修改的相同姓名学生编号：&#x27;</span>))<br>        <span class="hljs-keyword">for</span> i in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(<span class="hljs-built_in">count</span>)):<br>            <span class="hljs-keyword">if</span> num == i:<br>                age_change = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;修改年龄为：&#x27;</span>)<br>                tel_change = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;修改电话为：&#x27;</span>)<br>                python1806[temp_index[<span class="hljs-built_in">count</span>[i]]][<span class="hljs-string">&#x27;age&#x27;</span>] = age_change<br>                python1806[temp_index[<span class="hljs-built_in">count</span>[i]]][<span class="hljs-string">&#x27;tel&#x27;</span>] = tel_change<br>                <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;修改成功！&#x27;</span>)<br>            elif num &lt; <span class="hljs-number">0</span> <span class="hljs-built_in">or</span> num &gt;= <span class="hljs-built_in">len</span>(<span class="hljs-built_in">count</span>):<br>                <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;输入错误！&#x27;</span>)<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">continue</span><br>    elif n == <span class="hljs-string">&#x27;4&#x27;</span>:    #删除信息<br>        temp_index = []  # 姓名相同时，临时存储姓名<br>        name_del = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请输入你想要删除信息的学生姓名：&#x27;</span>)<br>        <span class="hljs-keyword">for</span> <span class="hljs-built_in">index</span> in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(python1806)):  # 依次查找学生信息<br>            <span class="hljs-keyword">if</span> python1806[<span class="hljs-built_in">index</span>][<span class="hljs-string">&#x27;name&#x27;</span>] == name_de<span class="hljs-variable">l:</span>  # 找到对应学生<br>                temp_index.<span class="hljs-keyword">append</span>(<span class="hljs-built_in">index</span>)  # 姓名相同学生所对应的下标都存在temp_index表里面去<br>            elif <span class="hljs-built_in">index</span> == <span class="hljs-built_in">len</span>(python1806) - <span class="hljs-number">1</span>:  # 没有查找到对应学生<br>                <span class="hljs-keyword">if</span> not temp_index:<br>                    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;你输入的学生不存在！！&#x27;</span>)<br>                    <span class="hljs-keyword">break</span><br>        <span class="hljs-built_in">count</span> = []  # 保存提示序号<br>        <span class="hljs-keyword">for</span> <span class="hljs-keyword">x</span> in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(temp_index)):  # 给予用户相同姓名学生信息提示,进行选择删除<br>            <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;%d、姓名：%s 年龄：%s 电话：%s&#x27;</span> % (<span class="hljs-keyword">x</span>, python1806[temp_index[<span class="hljs-keyword">x</span>]][<span class="hljs-string">&#x27;name&#x27;</span>], \<br>                                            python1806[temp_index[<span class="hljs-keyword">x</span>]][<span class="hljs-string">&#x27;age&#x27;</span>], \<br>                                            python1806[temp_index[<span class="hljs-keyword">x</span>]][<span class="hljs-string">&#x27;tel&#x27;</span>]))<br>            <span class="hljs-built_in">count</span>.<span class="hljs-keyword">append</span>(<span class="hljs-keyword">x</span>)<br>        <span class="hljs-keyword">if</span> coun<span class="hljs-variable">t:</span><br>            num = <span class="hljs-keyword">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请输入你要删除的相同姓名学生编号：&#x27;</span>))<br>        <span class="hljs-keyword">for</span> i in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(<span class="hljs-built_in">count</span>)):<br>            <span class="hljs-keyword">if</span> num == i:<br>                del python1806[temp_index[<span class="hljs-built_in">count</span>[i]]]<br>                <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;删除成功！&#x27;</span>)<br>            elif num &lt; <span class="hljs-number">0</span> <span class="hljs-built_in">or</span> num &gt;= <span class="hljs-built_in">len</span>(<span class="hljs-built_in">count</span>):<br>                <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;输入错误！&#x27;</span>)<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">continue</span><br>    elif n == <span class="hljs-string">&#x27;5&#x27;</span>:   #退出<br>        <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;系统已退出...&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:    #输入不合法，提示重新输入<br>        <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;输入错误，请按照提示输入！&#x27;</span>)<br>        <span class="hljs-keyword">while</span> True:<br>            <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;请选择：1（继续）、2（退出）：&#x27;</span>)<br>            n = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请输入数字：&#x27;</span>)<br>            <span class="hljs-keyword">if</span> n == <span class="hljs-string">&#x27;1&#x27;</span>:    #输入合法性判断<br>                <span class="hljs-keyword">break</span><br>            elif n == <span class="hljs-string">&#x27;2&#x27;</span>:<br>                <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;退出系统...&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:    #输入错误，提示重新输入<br>                <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;输入错误！请重新输入！&#x27;</span>)<br>                <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure><p>扩展要求：<br>1、增加文件文件操作，让所有增加、修改、删除操作后的结果保存在文件里面。<br>2、增加用户登录系统，不同用户只能管理自己所对应的学生系统</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;__author__=Deathfeeling&quot;&quot;&quot;</span><br><span class="hljs-comment"># 要求：</span><br><span class="hljs-comment"># 1、增加文件文件操作，让所有增加、修改、删除操作后的结果保存在结果里面。</span><br><span class="hljs-comment"># 2、增加用户登录系统，不同用户只能管理自己所对应的学生系统</span><br><br><br><br>manager_name = <span class="hljs-string">&#x27;&#x27;</span>  <span class="hljs-comment">#存储管理员信息</span><br>manager_passwd = <span class="hljs-string">&#x27;&#x27;</span><br>manager =[]<br><br><span class="hljs-comment">#登录界面</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    print(<span class="hljs-string">&#x27;==========================================================&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;      Welcome To QianFeng Student Manager System &#x27;</span>)<br>    print(<span class="hljs-string">&#x27;                      1.Login&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;                      2.Logon&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;                      3.Out&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;==========================================================&#x27;</span>)<br>    n = input(<span class="hljs-string">&#x27;请输入你想执行的功能：&#x27;</span>)<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-string">&#x27;1&#x27;</span>:  <span class="hljs-comment"># 注册</span><br>        manager_name = input(<span class="hljs-string">&#x27;请输入用户名：&#x27;</span>)<br>        manager_passwd = input(<span class="hljs-string">&#x27;请输入密码：&#x27;</span>)<br>        manager_passwd_re = input(<span class="hljs-string">&#x27;请确认密码：&#x27;</span>)<br>        <span class="hljs-keyword">if</span> manager_passwd != manager_passwd_re:   <span class="hljs-comment">#判断两次输入密码是否相同</span><br>            print(<span class="hljs-string">&#x27;两次输入密码不正确，请重新注册！&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">elif</span> manager_passwd == manager_passwd_re:<br>            print(<span class="hljs-string">&#x27;注册成功！&#x27;</span>)<br>            dict_manager = &#123;<span class="hljs-string">&#x27;name&#x27;</span>:manager_name,<span class="hljs-string">&#x27;passwd&#x27;</span>:manager_passwd&#125;<br>            manager.append(dict_manager)<br>            <span class="hljs-comment">#将注册信息追加在manager.txt文件中</span><br>            f = open(<span class="hljs-string">&#x27;./manager.txt&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>)<br>            f.write(str(dict_manager[<span class="hljs-string">&#x27;name&#x27;</span>]) + <span class="hljs-string">&#x27; &#x27;</span>)<br>            f.write(str(dict_manager[<span class="hljs-string">&#x27;passwd&#x27;</span>]) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>            f.close()<br>            <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">elif</span> n == <span class="hljs-string">&#x27;2&#x27;</span>:  <span class="hljs-comment"># 登录</span><br>        logon_name = input(<span class="hljs-string">&#x27;请输入用户名：&#x27;</span>)<br>        logon_passwd = input(<span class="hljs-string">&#x27;请输入密码：&#x27;</span>)<br>        <span class="hljs-comment"># 打开manager.txt文件，查看有没有相应管理员信息</span><br>        <span class="hljs-keyword">try</span>:<br>            f_logon = open(<span class="hljs-string">&#x27;./manager.txt&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>)<br>            f_logon_1 = f_logon.readline()<br>            <span class="hljs-keyword">while</span> f_logon_1:<br>                info = f_logon_1.split()   <span class="hljs-comment">#把字符串的空格前后分割成两个字符串存在一个列表中</span><br>                <span class="hljs-keyword">if</span> info[<span class="hljs-number">0</span>] == logon_name <span class="hljs-keyword">and</span> info[<span class="hljs-number">1</span>] == logon_passwd:<br>                    print(<span class="hljs-string">&#x27;登录成功！&#x27;</span>)<br>                    temp = <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">break</span><br>                f_logon_1 = f_logon.readline()<br>            <span class="hljs-keyword">else</span>:<br>                temp = <span class="hljs-number">0</span><br>                print(<span class="hljs-string">&#x27;账号或者密码不正确!请重新输入!&#x27;</span>)<br>            f_logon.close()<br>            <span class="hljs-keyword">if</span> temp:   <span class="hljs-comment">#temp=1,跳出循环进入系统管理界面</span><br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">elif</span> <span class="hljs-keyword">not</span> temp: <span class="hljs-comment">#temp = 0 ,表示密码不正确，重新输入</span><br>                <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">except</span> IOError:   <span class="hljs-comment">#没有找到文件抛出异常，提示用户注册</span><br>            print(<span class="hljs-string">&#x27;没有查找到相关信息，请注册！&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">elif</span> n == <span class="hljs-string">&#x27;3&#x27;</span>:  <span class="hljs-comment"># 退出</span><br>        exit(<span class="hljs-string">&#x27;系统已退出...&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 输入不合法，提示重新输入</span><br>        print(<span class="hljs-string">&#x27;输入错误，请按照提示输入！&#x27;</span>)<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            print(<span class="hljs-string">&#x27;请选择：1（继续）、2（退出）：&#x27;</span>)<br>            n = input(<span class="hljs-string">&#x27;请输入数字：&#x27;</span>)<br>            <span class="hljs-keyword">if</span> n == <span class="hljs-string">&#x27;1&#x27;</span>:  <span class="hljs-comment"># 输入合法性判断</span><br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">elif</span> n == <span class="hljs-string">&#x27;2&#x27;</span>:<br>                exit(<span class="hljs-string">&#x27;退出系统...&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 输入错误，提示重新输入</span><br>                print(<span class="hljs-string">&#x27;输入错误！请重新输入！&#x27;</span>)<br>                <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">continue</span><br><br><span class="hljs-comment">#学生管理系统</span><br>name = <span class="hljs-string">&#x27;&#x27;</span>   <span class="hljs-comment">#存储学生用户信息</span><br>age = <span class="hljs-string">&#x27;&#x27;</span><br>tel = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    print(<span class="hljs-string">&#x27;=================================================&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;                  1.添加学生信息&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;                  2.查看学生信息&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;                  3.修改学生信息&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;                  4.删除学生信息&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;                  5.退出&#x27;</span>)<br>    print(<span class="hljs-string">&#x27;=================================================&#x27;</span>)<br>    n = input(<span class="hljs-string">&#x27;请输入你想执行的功能：&#x27;</span>)<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-string">&#x27;1&#x27;</span>:    <span class="hljs-comment">#添加信息</span><br>        name = input(<span class="hljs-string">&#x27;请添加学生姓名：&#x27;</span>)<br>        age = input(<span class="hljs-string">&#x27;请添加学生年龄：&#x27;</span>)<br>        tel = input(<span class="hljs-string">&#x27;请添加学生电话：&#x27;</span>)<br>        student_file = open(logon_name + <span class="hljs-string">&#x27;.txt&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>)  <span class="hljs-comment"># 打开并创建管理员对应的学生管理文件</span><br>        student_file.write(name+<span class="hljs-string">&#x27; &#x27;</span>+age+<span class="hljs-string">&#x27; &#x27;</span>+tel+<span class="hljs-string">&#x27;\n&#x27;</span>)<br>        student_file.close()<br>        print(<span class="hljs-string">&#x27;添加成功！&#x27;</span>)<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">elif</span> n == <span class="hljs-string">&#x27;2&#x27;</span>:    <span class="hljs-comment">#查看信息</span><br>        <span class="hljs-keyword">try</span>:<br>            student_file = open(logon_name + <span class="hljs-string">&#x27;.txt&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>)<br>            re = student_file.readline()<br>            <span class="hljs-keyword">while</span> re:<br>                list1 = re.split()   <span class="hljs-comment">#以空格为界，切分成3个字符串元素组成的列表</span><br>                print(<span class="hljs-string">&#x27;姓名：%s 年龄：%s 电话：%s&#x27;</span>%(list1[<span class="hljs-number">0</span>],list1[<span class="hljs-number">1</span>],list1[<span class="hljs-number">2</span>]))<br>                re = student_file.readline()<br>            student_file.close()<br>        <span class="hljs-keyword">except</span> IOError:<br>            print(<span class="hljs-string">&#x27;没有任何学生信息，请添加！&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>    <span class="hljs-keyword">elif</span> n == <span class="hljs-string">&#x27;3&#x27;</span>:    <span class="hljs-comment">#修改信息</span><br>        temp_samename = []    <span class="hljs-comment">#姓名相同时，临时存储姓名</span><br>        list2_name_index = []  <span class="hljs-comment">#存相同名字学生对应list2的下标</span><br>        name_change = input(<span class="hljs-string">&#x27;请输入你想要修改信息的学生姓名：&#x27;</span>)<br>        list2 = []   <span class="hljs-comment">#存储文件信息</span><br>        student_file = open(logon_name + <span class="hljs-string">&#x27;.txt&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-comment">#先按行读入列表</span><br>        re = student_file.readline().rstrip(<span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment">#rstip(&#x27;\n&#x27;)去掉字符串末尾的换行符</span><br>        <span class="hljs-keyword">while</span> re :<br>            list2.append(re)<br>            re = student_file.readline().rstrip(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br>        nn1 = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> count <span class="hljs-keyword">in</span> range(len(list2)):<br>            temp_list = list2[count].split()<br>            <span class="hljs-keyword">if</span> temp_list[<span class="hljs-number">0</span>] == name_change:<br>                temp_samename.append(list2[:].pop(count))<br>                list2_name_index.append(count)<br>            <span class="hljs-keyword">elif</span> count == len(list2) - <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> temp_samename:<br>                    nn1 = <span class="hljs-number">1</span><br>                    print(<span class="hljs-string">&#x27;没有查找到对应学生&#x27;</span>)<br>        <span class="hljs-keyword">if</span> nn1 == <span class="hljs-number">1</span>:    <span class="hljs-comment">#没有查找的到对应学生回到管理页面</span><br>            <span class="hljs-keyword">continue</span><br>        count_1 = <span class="hljs-number">0</span><br>        <span class="hljs-comment">#相同姓名学生处理</span><br>        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> temp_samename:<br>            temp_list_1 = index.split()<br>            print(<span class="hljs-string">&#x27;%d、姓名：%s 年龄：%s 电话：%s&#x27;</span> % (count_1,temp_list_1[<span class="hljs-number">0</span>], temp_list_1[<span class="hljs-number">1</span>], temp_list_1[<span class="hljs-number">2</span>]))<br>            count_1 += <span class="hljs-number">1</span><br>        n = input(<span class="hljs-string">&#x27;请输入你要修改的学生信息（数字）：&#x27;</span>)<br>        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(len(temp_samename)):<br>            <span class="hljs-keyword">if</span> n == str(index):<br>                nn = temp_samename[index].split()<br>                nn[<span class="hljs-number">1</span>] = input(<span class="hljs-string">&#x27;请输入你想要修改的年龄：&#x27;</span>)<br>                nn[<span class="hljs-number">2</span>] = input(<span class="hljs-string">&#x27;请输入你想要修改的电话：&#x27;</span>)<br>                temp_samename[int(n)]= nn[<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27; &#x27;</span> + nn[<span class="hljs-number">1</span>] + <span class="hljs-string">&#x27; &#x27;</span> + nn[<span class="hljs-number">2</span>]<br>                print(<span class="hljs-string">&#x27;修改成功！&#x27;</span>)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">elif</span> index == len(temp_samename) <span class="hljs-number">-1</span> :<br>                <span class="hljs-keyword">if</span> n != str(index):<br>                    print(<span class="hljs-string">&#x27;输入错误！&#x27;</span>)<br>                    <span class="hljs-keyword">break</span><br>        <span class="hljs-comment">#把修改后的姓名表替换到list2表中</span><br>        nn2 = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> list2_name_index:<br>            list2[index] = temp_samename[nn2]<br>            nn2 += <span class="hljs-number">1</span><br>        <span class="hljs-comment">#再把修改后的列表值写入文件</span><br>        student_file.close()<br>        student_file_2 = open(logon_name + <span class="hljs-string">&#x27;.txt&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> list2:<br>            student_file_2.write(i+<span class="hljs-string">&#x27;\n&#x27;</span>)<br>        student_file_2.close()<br>        <span class="hljs-keyword">continue</span><br><br>    <span class="hljs-keyword">elif</span> n == <span class="hljs-string">&#x27;4&#x27;</span>:    <span class="hljs-comment">#删除信息</span><br>        temp_samename = []    <span class="hljs-comment">#姓名相同时，临时存储姓名</span><br>        list2_name_index = []  <span class="hljs-comment">#存相同名字学生对应list2的下标</span><br>        name_change = input(<span class="hljs-string">&#x27;请输入你想要删除信息的学生姓名：&#x27;</span>)<br>        list2 = []   <span class="hljs-comment">#存储文件信息</span><br>        student_file = open(logon_name + <span class="hljs-string">&#x27;.txt&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-comment">#先按行读入列表</span><br>        re = student_file.readline().rstrip(<span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment">#rstip(&#x27;\n&#x27;)去掉字符串末尾的换行符</span><br>        <span class="hljs-keyword">while</span> re :<br>            list2.append(re)<br>            re = student_file.readline().rstrip(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br>        nn1 = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> count <span class="hljs-keyword">in</span> range(len(list2)):<br>            temp_list = list2[count].split()<br>            <span class="hljs-keyword">if</span> temp_list[<span class="hljs-number">0</span>] == name_change:<br>                temp_samename.append(list2[:].pop(count))<br>                list2_name_index.append(count)<br>            <span class="hljs-keyword">elif</span> count == len(list2) - <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> temp_samename:<br>                    nn1 = <span class="hljs-number">1</span><br>                    print(<span class="hljs-string">&#x27;没有查找到对应学生&#x27;</span>)<br>        <span class="hljs-keyword">if</span> nn1 == <span class="hljs-number">1</span>:    <span class="hljs-comment">#没有查找的到对应学生回到管理页面</span><br>            <span class="hljs-keyword">continue</span><br>        count_1 = <span class="hljs-number">0</span><br>        <span class="hljs-comment">#相同姓名学生处理</span><br>        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> temp_samename:<br>            temp_list_1 = index.split()<br>            print(<span class="hljs-string">&#x27;%d、姓名：%s 年龄：%s 电话：%s&#x27;</span> % (count_1,temp_list_1[<span class="hljs-number">0</span>], temp_list_1[<span class="hljs-number">1</span>], temp_list_1[<span class="hljs-number">2</span>]))<br>            count_1 += <span class="hljs-number">1</span><br>        n = input(<span class="hljs-string">&#x27;请输入你要删除的学生信息（数字）：&#x27;</span>)<br>        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(len(temp_samename)):<br>            <span class="hljs-keyword">if</span> n == str(index):   <span class="hljs-comment">#删除指定编号的学生，查找原list2表对应元素进行删除</span><br>                list2.pop(list2_name_index[index])<br>                print(<span class="hljs-string">&#x27;删除成功！&#x27;</span>)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">elif</span> index == len(temp_samename) - <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">if</span> n != str(index):<br>                    print(<span class="hljs-string">&#x27;输入错误！&#x27;</span>)<br>                    <span class="hljs-keyword">break</span><br>        <span class="hljs-comment">#再把修改后的列表值写入文件</span><br>        student_file.close()<br>        student_file_2 = open(logon_name + <span class="hljs-string">&#x27;.txt&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> list2:<br>            student_file_2.write(i+<span class="hljs-string">&#x27;\n&#x27;</span>)<br>        student_file_2.close()<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">elif</span> n == <span class="hljs-string">&#x27;5&#x27;</span>:   <span class="hljs-comment">#退出</span><br>        exit(<span class="hljs-string">&#x27;系统已退出...&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:    <span class="hljs-comment">#输入不合法，提示重新输入</span><br>        print(<span class="hljs-string">&#x27;输入错误，请按照提示输入！&#x27;</span>)<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            print(<span class="hljs-string">&#x27;请选择：1（继续）、2（退出）：&#x27;</span>)<br>            n = input(<span class="hljs-string">&#x27;请输入数字：&#x27;</span>)<br>            <span class="hljs-keyword">if</span> n == <span class="hljs-string">&#x27;1&#x27;</span>:    <span class="hljs-comment">#输入合法性判断</span><br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">elif</span> n == <span class="hljs-string">&#x27;2&#x27;</span>:<br>                exit(<span class="hljs-string">&#x27;退出系统...&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:    <span class="hljs-comment">#输入错误，提示重新输入</span><br>                print(<span class="hljs-string">&#x27;输入错误！请重新输入！&#x27;</span>)<br>                <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure><h4 id="golang版本"><a href="#golang版本" class="headerlink" title="golang版本"></a>golang版本</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;bufio&quot;</span><br><span class="hljs-string">&quot;errors&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><span class="hljs-string">&quot;strconv&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><br><span class="hljs-keyword">var</span> studentMap <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]Student = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]Student)<br><br><br><span class="hljs-keyword">type</span> Student <span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>age <span class="hljs-keyword">int</span><br>phone <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getStudent</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Student, error)</span></span> &#123;<br>s, ok := studentMap[name]<br><span class="hljs-keyword">if</span> ok &#123;<br><span class="hljs-keyword">return</span> &amp;s, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">return</span> &amp;s, errors.New(<span class="hljs-string">&quot;student not found! &quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addStudent</span><span class="hljs-params">()</span> <span class="hljs-title">Student</span></span> &#123;<br>reader := bufio.NewReader(os.Stdin)<br>fmt.Print(<span class="hljs-string">&quot;请输入学生姓名: &quot;</span>)<br>name, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>fmt.Print(<span class="hljs-string">&quot;请输入学生年龄: &quot;</span>)<br>ageString, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>age, _ := strconv.Atoi(replaceString(ageString))<br>fmt.Print(<span class="hljs-string">&quot;请输入学生电话: &quot;</span>)<br>phone, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-keyword">return</span> Student&#123; replaceString(name), age, replaceString(phone)&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">updateStudent</span><span class="hljs-params">(sName <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(newStudent Student)</span></span> &#123;<br>reader := bufio.NewReader(os.Stdin)<br>fmt.Print(<span class="hljs-string">&quot;请更新后的学生信息!\n学生姓名: &quot;</span>)<br>name, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>name = replaceString(name)<br>fmt.Print(<span class="hljs-string">&quot;请输入学生年龄: &quot;</span>)<br>ageString, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>age, _ := strconv.Atoi(replaceString(ageString))<br>fmt.Print(<span class="hljs-string">&quot;请输入学生电话: &quot;</span>)<br>phone, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>phone = replaceString(phone)<br><span class="hljs-built_in">delete</span>(studentMap, sName)<br>newStudent = Student&#123; name, age, phone&#125;<br>studentMap[name] = newStudent<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deleteStudent</span><span class="hljs-params">(s *Student)</span></span> &#123;<br><span class="hljs-built_in">delete</span>(studentMap, s.name)<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">replaceString</span><span class="hljs-params">(s <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> strings.Replace(s, <span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-number">-1</span>)<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mainMenu</span><span class="hljs-params">()</span> <span class="hljs-params">(operate <span class="hljs-keyword">int</span>)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">`</span><br><span class="hljs-string">=================================================</span><br><span class="hljs-string">                      0.查看所有学生信息</span><br><span class="hljs-string">                      1.添加学生信息</span><br><span class="hljs-string">                      2.查看学生信息</span><br><span class="hljs-string">                      3.修改学生信息</span><br><span class="hljs-string">                      4.删除学生信息</span><br><span class="hljs-string">                      5.退出</span><br><span class="hljs-string">    =================================================`</span>)<br>fmt.Print(<span class="hljs-string">&quot;输入您想执行的功能: &quot;</span>)<br>reader := bufio.NewReader(os.Stdin)<br>readString, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>operate, _ = strconv.Atoi(replaceString(readString))<br><span class="hljs-keyword">return</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;欢迎来到XXX学生管理系统&quot;</span>)<br>reader := bufio.NewReader(os.Stdin)<br>end:<br><span class="hljs-keyword">for</span> &#123;<br>operate := mainMenu()<br><span class="hljs-keyword">switch</span> operate &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br><span class="hljs-keyword">for</span> _, s := <span class="hljs-keyword">range</span> studentMap &#123;<br>fmt.Println(s)<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>s := addStudent()<br>studentMap[s.name] = s<br><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>fmt.Print(<span class="hljs-string">&quot;请输入查找学生姓名: &quot;</span>)<br>name, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>student, err := getStudent(replaceString(name))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err.Error())<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;找到学生: &quot;</span>, *student)<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>fmt.Print(<span class="hljs-string">&quot;请输入更新学生姓名: &quot;</span>)<br>name, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>student, err := getStudent(replaceString(name))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err.Error())<br><span class="hljs-keyword">continue</span><br>&#125;<br>newStudent := updateStudent(student.name)<br>fmt.Println(<span class="hljs-string">&quot;更新后的学生信息: &quot;</span>, newStudent)<br><span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>fmt.Print(<span class="hljs-string">&quot;请输入删除学生姓名: &quot;</span>)<br>name, _ := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>student, err := getStudent(replaceString(name))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err.Error())<br><span class="hljs-keyword">continue</span><br>&#125;<br>deleteStudent(student)<br>fmt.Println(<span class="hljs-string">&quot;删除成功！&quot;</span>)<br><span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>fmt.Println(<span class="hljs-string">&quot;程序退出...&quot;</span>)<br><span class="hljs-keyword">break</span> end<br><span class="hljs-keyword">default</span>:<br>fmt.Println(<span class="hljs-string">&quot;输入错误，请重新输入...&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>学生管理系统</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>容器02-字典和集合</title>
    <link href="/Myblog/2018/08/28/%E5%AE%B9%E5%99%A802-%E5%AD%97%E5%85%B8%E5%92%8C%E9%9B%86%E5%90%88/"/>
    <url>/Myblog/2018/08/28/%E5%AE%B9%E5%99%A802-%E5%AD%97%E5%85%B8%E5%92%8C%E9%9B%86%E5%90%88/</url>
    
    <content type="html"><![CDATA[<h2 id="字典和集合"><a href="#字典和集合" class="headerlink" title="字典和集合"></a>字典和集合</h2><h3 id="一、字典–dict"><a href="#一、字典–dict" class="headerlink" title="一、字典–dict"></a>一、字典–dict</h3><p><strong>字典：容器类型，以键值对作为元素。（字典里面存的数据全是以键值对出现的）</strong></p><p><strong>字典是可变的（增删改）— 指字典中的键值对的值和个数是可变的</strong></p><ul><li>键值对 –&gt; 键：值（key：value）<br>{key1：value1，key2：value2，…}<br>注意：<br>key–必须唯一，不可变的（数字、布尔、字符串、元组，推荐使用字符串）<br>值 – 没有要求<h5 id="1、声明字典"><a href="#1、声明字典" class="headerlink" title="1、声明字典"></a>1、声明字典</h5><code>dict1 = &#123;1:100, &#39;a&#39;:97, True:&#39;布尔&#39;, (10,11):&#39;start&#39;&#125;</code><h5 id="2、获取字典的元素对应的值（字典存数据实质是存值，key是获取value的手段）"><a href="#2、获取字典的元素对应的值（字典存数据实质是存值，key是获取value的手段）" class="headerlink" title="2、获取字典的元素对应的值（字典存数据实质是存值，key是获取value的手段）"></a>2、获取字典的元素对应的值（字典存数据实质是存值，key是获取value的手段）</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">person = &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;星辰&#x27;</span>,<span class="hljs-string">&#x27;age&#x27;</span>:<span class="hljs-number">20</span>&#125;<br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(person[<span class="hljs-string">&#x27;name&#x27;</span>])</span></span><br></code></pre></td></tr></table></figure>通过 key 获取 value 时，如果key不存在会发生keyError异常</li></ul><p><strong>- dict[‘key’] 和 dict.get(‘key’) 方法使用区别</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">person = &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;星辰&#x27;</span>,<span class="hljs-string">&#x27;age&#x27;</span>:20&#125;<br><span class="hljs-builtin-name">print</span>(person[<span class="hljs-string">&#x27;name&#x27;</span>])<br><span class="hljs-comment">#下面两种方式结果相同</span><br><span class="hljs-builtin-name">print</span>(person.<span class="hljs-builtin-name">get</span>(<span class="hljs-string">&#x27;age&#x27;</span>))<br><span class="hljs-builtin-name">print</span>(person[<span class="hljs-string">&#x27;age&#x27;</span>])     <br><span class="hljs-comment">#下面两种方式结果不同</span><br><span class="hljs-builtin-name">print</span>(person.<span class="hljs-builtin-name">get</span>(<span class="hljs-string">&#x27;sex&#x27;</span>))     #如果key不存在返回None<br><span class="hljs-builtin-name">print</span>(person[<span class="hljs-string">&#x27;sex&#x27;</span>])   #报错<br></code></pre></td></tr></table></figure><p>使用情况总结：<br>1、确定key肯定存在，用 dict[] 语法获取 value ；<br>2、key值可能不存在，不存在的时候不希望报错，而是对它进行特殊处理，使用dict.get(‘key’)方法</p><h5 id="3、遍历字典"><a href="#3、遍历字典" class="headerlink" title="3、遍历字典"></a>3、遍历字典</h5><p><strong>遍历字典直接取到的是字典所有 key 值</strong></p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs processing">person = &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;星辰&#x27;</span>,<span class="hljs-string">&#x27;age&#x27;</span>:<span class="hljs-number">20</span>&#125;<br><span class="hljs-keyword">for</span> <span class="hljs-built_in">key</span> in person:<br>  <span class="hljs-built_in">print</span>(<span class="hljs-built_in">key</span>)<br>  <span class="hljs-built_in">print</span>(person[<span class="hljs-built_in">key</span>])<br>  <span class="hljs-built_in">print</span>()<br><br>name<br>星辰<br><br>age<br><span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h5 id="4、改（修改key对应的value）"><a href="#4、改（修改key对应的value）" class="headerlink" title="4、改（修改key对应的value）"></a>4、改（修改key对应的value）</h5><p>语法：dict[key] = 新值</p><h5 id="5、增（添加键值对）"><a href="#5、增（添加键值对）" class="headerlink" title="5、增（添加键值对）"></a>5、增（添加键值对）</h5><p><strong>增加语法和修改语法一样，如果存在即为修改，不存在即为增加。</strong><br>语法：dict[key] = 值</p><h5 id="5、删（删除键值对）"><a href="#5、删（删除键值对）" class="headerlink" title="5、删（删除键值对）"></a>5、删（删除键值对）</h5><p>语法：<br>（1）、del dict [key]<br>（2）、dict.pop（key）— 与列表类似，将值取出来保存,不是键值对。</p><h5 id="6、运算符-–-in-、not-in"><a href="#6、运算符-–-in-、not-in" class="headerlink" title="6、运算符 – in 、not in"></a>6、运算符 – in 、not in</h5><p>不支持 ‘ + ‘ 和 ‘ * ‘ 操作<br><strong>查找 值 在不在字典中</strong></p><h5 id="7、一些关于字典的方法"><a href="#7、一些关于字典的方法" class="headerlink" title="7、一些关于字典的方法"></a>7、一些关于字典的方法</h5><p><img src="https://upload-images.jianshu.io/upload_images/13692175-dc1f3f9e864bfa5b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="字典相关函数.png"><br>说明：</p><ul><li>dict.copy()：拷贝字典中所有元素，放在一个新的字典中（浅拷贝–见Day6）。</li><li>dict.fromkeys(序列，默认值=None)： 将序列中的每个值作为key，默认值为value创建一个新的字典<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">dict = &#123;&#125;<br>dict = dict.fromkeys(<span class="hljs-string">&#x27;abcd&#x27;</span>,<span class="hljs-number">111</span>)<br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(dict)</span></span><br><br>&#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">111</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">111</span>, <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">111</span>, <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-number">111</span>&#125;<br></code></pre></td></tr></table></figure></li><li>dict.setdefault(key,default=None)：添加键值对，默认为None，不能修改。</li><li>dict1.update(dict2)：将dict2的键值对更新（添加）到dict1中：（1）如果dict2中的key在dict1中存在，就用key2对应的值更新key1的值（2）不存在就添加。<h5 id="8、字典和列表的组合使用–重点"><a href="#8、字典和列表的组合使用–重点" class="headerlink" title="8、字典和列表的组合使用–重点"></a>8、字典和列表的组合使用–重点</h5></li></ul><p><strong>列表和字典选择：<br>列表–保存数据是一个类型。<br>字典–保存数据类型不同。</strong></p><p><strong>应用：学生管理系统</strong><br>a、一个系统可以存储多个学生<br>b、一个学生可以存储：姓名，电话，籍贯，专业等<br>c、添加、删除、修改学生信息</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#1、列表中有字典</span><br>student_system = [ &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;stu1&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>:18, <span class="hljs-string">&#x27;tel&#x27;</span>:110&#125;,<br>                   &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;stu2&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>:19, <span class="hljs-string">&#x27;tel&#x27;</span>:120&#125;,<br>                   &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;stu3&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>:20, <span class="hljs-string">&#x27;tel&#x27;</span>:130&#125;]<br><span class="hljs-comment">#取出第一个学生的籍贯</span><br><span class="hljs-builtin-name">print</span>(student_system[0][<span class="hljs-string">&#x27;name&#x27;</span>])<br><br><span class="hljs-comment">#2、字典中有列表</span><br>py_class = &#123;<br>    <span class="hljs-string">&#x27;class_name&#x27;</span>:<span class="hljs-string">&#x27;python1806&#x27;</span>,<br>    <span class="hljs-string">&#x27;student&#x27;</span>:[&#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;stu1&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>:18, <span class="hljs-string">&#x27;tel&#x27;</span>:110&#125;,<br>               &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;stu2&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>:19, <span class="hljs-string">&#x27;tel&#x27;</span>:120&#125;,<br>               &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;stu3&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>:20, <span class="hljs-string">&#x27;tel&#x27;</span>:130&#125;<br>    ],<br>&#125;<br><span class="hljs-comment">#取班级名</span><br><span class="hljs-builtin-name">print</span>(py_class[<span class="hljs-string">&#x27;class_name&#x27;</span>])<br><span class="hljs-comment">#取第三个学生的名字</span><br><span class="hljs-builtin-name">print</span>(py_class[<span class="hljs-string">&#x27;student&#x27;</span>][2][<span class="hljs-string">&#x27;name&#x27;</span>])<br><br>python1806<br>stu3<br></code></pre></td></tr></table></figure><p>扩展：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs vim"># 练习<span class="hljs-number">1</span>：在班级python1806添加一个学生，要学生自己输入信息：名字，年龄，id<br>name = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请输入您的名字：&#x27;</span>)<br>age = <span class="hljs-keyword">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;输入您的年龄：&#x27;</span>))<br>id = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;请输入您的id：&#x27;</span>)<br>student = &#123;<span class="hljs-string">&#x27;name&#x27;</span>:name, <span class="hljs-string">&#x27;age&#x27;</span>:age, <span class="hljs-string">&#x27;id&#x27;</span>:id&#125;<br>class_python1806 = [&#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;stu1&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>:<span class="hljs-number">18</span>, <span class="hljs-string">&#x27;tel&#x27;</span>:<span class="hljs-number">110</span>&#125;,<br>                    &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;stu2&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>:<span class="hljs-number">19</span>, <span class="hljs-string">&#x27;tel&#x27;</span>:<span class="hljs-number">120</span>&#125;,<br>                    &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;stu3&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>:<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;tel&#x27;</span>:<span class="hljs-number">130</span>&#125;<br>                     ]<br>class_python1806.<span class="hljs-keyword">append</span>(student)<br><span class="hljs-keyword">print</span>(class_python1806)<br><br>#练习<span class="hljs-number">2</span>：输入一个学生的姓名，根据姓名取删除对应的学生<br>name_del = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;输入您要删除的学生姓名：&#x27;</span>)<br><span class="hljs-keyword">for</span> i in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(class_python1806)):<br>    <span class="hljs-keyword">if</span> class_python1806[i][<span class="hljs-string">&#x27;name&#x27;</span>] == name_de<span class="hljs-variable">l:</span><br>        del class_python1806[i]<br><span class="hljs-keyword">print</span>(class_python1806)<br><br>结果：<br>请输入您的名字：<span class="hljs-number">111</span><br>输入您的年龄：<span class="hljs-number">11</span><br>请输入您的id：<span class="hljs-number">11</span><br>[&#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;stu1&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>: <span class="hljs-number">18</span>, <span class="hljs-string">&#x27;tel&#x27;</span>: <span class="hljs-number">110</span>&#125;, &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;stu2&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>: <span class="hljs-number">19</span>, <span class="hljs-string">&#x27;tel&#x27;</span>: <span class="hljs-number">120</span>&#125;, &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;stu3&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>: <span class="hljs-number">20</span>, <span class="hljs-string">&#x27;tel&#x27;</span>: <span class="hljs-number">130</span>&#125;, &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;111&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>: <span class="hljs-number">11</span>, <span class="hljs-string">&#x27;id&#x27;</span>: <span class="hljs-string">&#x27;11&#x27;</span>&#125;]<br>输入您要删除的学生姓名：<span class="hljs-number">111</span><br>[&#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;stu1&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>: <span class="hljs-number">18</span>, <span class="hljs-string">&#x27;tel&#x27;</span>: <span class="hljs-number">110</span>&#125;, &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;stu2&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>: <span class="hljs-number">19</span>, <span class="hljs-string">&#x27;tel&#x27;</span>: <span class="hljs-number">120</span>&#125;, &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;stu3&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>: <span class="hljs-number">20</span>, <span class="hljs-string">&#x27;tel&#x27;</span>: <span class="hljs-number">130</span>&#125;]<br><br></code></pre></td></tr></table></figure><h3 id="二、集合-–-set"><a href="#二、集合-–-set" class="headerlink" title="二、集合 – set"></a>二、集合 – set</h3><p>集合是python中的一种容器类型：无序的，可变的，值唯一</p><h5 id="1、声明一个集合"><a href="#1、声明一个集合" class="headerlink" title="1、声明一个集合"></a>1、声明一个集合</h5><p>set1 = {1, ‘abc’}<br>将其他序列转换为集合，自动去重<br><code>set2 = set(&#39;name name&#39;) --&gt; &#123;&#39;n&#39;, &#39;a&#39;, &#39; &#39;, &#39;e&#39;, &#39;m&#39;&#125;</code><br>一般容器类型都不能放入集合，比如列表，字典等</p><h5 id="2、查（获取集合中的元素）"><a href="#2、查（获取集合中的元素）" class="headerlink" title="2、查（获取集合中的元素）"></a>2、查（获取集合中的元素）</h5><p><strong>集合是不能直接单独获取其中某一个元素的。<br>只能遍历获取每一个元素</strong></p><h5 id="3、增"><a href="#3、增" class="headerlink" title="3、增"></a>3、增</h5><p>a、set.add(元素)<br>b、set1.update(set2)  – 将set2元素添加到set1中</p><h5 id="4、删"><a href="#4、删" class="headerlink" title="4、删"></a>4、删</h5><p>set.remove(元素)<br>set.clear()  —  全删</p><h5 id="5、数学相关的集合运算-—-重点"><a href="#5、数学相关的集合运算-—-重点" class="headerlink" title="5、数学相关的集合运算 — 重点"></a>5、数学相关的集合运算 — 重点</h5><ul><li>判断包含情况：<br>集合1 &gt;= 集合2：判断集合1中是否包含集合2</li><li>求并集：|<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">set1 = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;<br>set2 = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br>print(set1 | set2)<br><br>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br></code></pre></td></tr></table></figure></li><li>求交集：&amp;<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">set1 = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;<br>set2 = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br>print(set1 &amp; set2)<br><br>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;<br></code></pre></td></tr></table></figure></li><li>求差集：-<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">set1 = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;<br>set2 = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br>print(set1 &amp; set2)<br><br>&#123;<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;<br></code></pre></td></tr></table></figure></li><li>求补集：^<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">set1 = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;<br>set2 = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br>print(set1 ^ set2)<br><br>&#123;<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br></code></pre></td></tr></table></figure>补充：<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">sum</span>（）：python中对序列求和的方法<br>dir（）：可以查找一些内置函数<br>isinstance(<span class="hljs-keyword">a</span>, b)：比较<span class="hljs-keyword">a</span>、b类型是否相同，返回True和False<br>isinstance(<span class="hljs-keyword">a</span>, 类型)：判断<span class="hljs-keyword">a</span>是否为一个类型<br>str.<span class="hljs-built_in">split</span>():把字符串以空格分开，返回一个列表<br>re.sub(<span class="hljs-string">&#x27;[要替换的字符]&#x27;</span>, <span class="hljs-string">&#x27;新字符&#x27;</span>,字符串)<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>容器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>容器01-列表和元组</title>
    <link href="/Myblog/2018/08/27/%E5%AE%B9%E5%99%A801-%E5%88%97%E8%A1%A8%E5%92%8C%E5%85%83%E7%BB%84/"/>
    <url>/Myblog/2018/08/27/%E5%AE%B9%E5%99%A801-%E5%88%97%E8%A1%A8%E5%92%8C%E5%85%83%E7%BB%84/</url>
    
    <content type="html"><![CDATA[<h2 id="一、列表–list"><a href="#一、列表–list" class="headerlink" title="一、列表–list"></a>一、列表–list</h2><ul><li>列表示python中的容器类型。有序的，可变的容器（可变指列表中的元素、位置、个数可变）</li><li>元素：指的是列表中的每一个内容。列表中的元素可以是任意类型的元素</li></ul><p><strong>1、声明列表</strong><br>   （1）、直接声明列表<br>   <code>scores =  [90, 80, 75]</code><br>   #   [] –&gt; 代表空列表<br>   （2）、将其它的数据类型转换成列表（只有序列才能转换:字符串和range（）、字典、元组、集合、生成式、迭代器）<br>   <code>chars = list（&#39;abcdef&#39;）</code><br><strong>2、获取列表元素–列表[下标]</strong><br><code>tv_name = [&#39;行尸走肉&#39;, &#39;冰与火之歌：权利的游戏&#39;]</code><br><strong>3、获取部分元素（切片）：列表[下标1：下标2：步进]</strong><br>#  切片的结果是列表–效果和字符串切片相同<br># 步进为正，从前往后取值；步进为负，从后往前取值。<br><strong>4、遍历（一次获取每个元素）</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">#统计<span class="hljs-number">80</span>分以上的个数<br>grade = [<span class="hljs-number">67</span>, <span class="hljs-number">84</span>, <span class="hljs-number">93</span>, <span class="hljs-number">74</span>, <span class="hljs-number">95</span>, <span class="hljs-number">83</span>]<br>count = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> grade:<br>    <span class="hljs-keyword">if</span> item &gt;= <span class="hljs-number">80</span> :<br>        count += <span class="hljs-number">1</span><br>print(<span class="hljs-string">&#x27;80分以上的同学有：%d&#x27;</span>%count)<br><br><span class="hljs-number">80</span>分以上的同学有：<span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><h4 id="改-–-gt-修改列表"><a href="#改-–-gt-修改列表" class="headerlink" title="改 –&gt; 修改列表"></a>改 –&gt; 修改列表</h4><p>语法：列表名[下标] = 新值    （通过下标获取元素）</p><h4 id="增-–-gt-增加元素"><a href="#增-–-gt-增加元素" class="headerlink" title="增 –&gt; 增加元素"></a>增 –&gt; 增加元素</h4><p><strong>a: list.append（元素）</strong><br>#添加到list的后面</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">scores</span> = []<br><span class="hljs-variable">for</span> <span class="hljs-variable">_</span> <span class="hljs-variable"><span class="hljs-keyword">in</span></span> <span class="hljs-variable">range</span> (<span class="hljs-number">5</span>):<br>    <span class="hljs-variable">score</span> = <span class="hljs-function"><span class="hljs-title">input</span>(<span class="hljs-string">&#x27;请输入学生成绩：&#x27;</span>)</span><br>    <span class="hljs-variable">scores.append</span>(<span class="hljs-function"><span class="hljs-title">int</span>(<span class="hljs-variable">score</span>))</span><br><span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-variable">scores</span>)</span><br></code></pre></td></tr></table></figure><p><strong>b: list.insert（下标，元素）</strong><br># 在指定的下标前插入一个元素</p><h4 id="删-–-gt-删除元素"><a href="#删-–-gt-删除元素" class="headerlink" title="删 –&gt; 删除元素"></a>删 –&gt; 删除元素</h4><p><strong>a:del  列表[下标]  –&gt; 根据下标去删除列表中的元素</strong></p><p>del 语句是python中删除数据的语法，它可以删除任何数据：del 变量（删除变量） del 列表（删除列表）</p><p><strong>b:list.pop（下标）–&gt; 将列表中的指定下标对应的元素取出来</strong><br><strong>list.pop() –&gt; 将列表最后一个元素取出来</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">food</span> = foods.pop(<span class="hljs-number">1</span>)   <span class="hljs-comment">#将foods中删除值取出来保存在food中</span><br></code></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">练习：将一个保存成绩的列表中，成绩低于<span class="hljs-number">60</span>分的全部删除<br>[<span class="hljs-number">78</span>, <span class="hljs-number">59</span>, <span class="hljs-number">40</span>, <span class="hljs-number">90</span>, <span class="hljs-number">89</span>, <span class="hljs-number">45</span>, <span class="hljs-number">69</span>, <span class="hljs-number">30</span>] --&gt;[<span class="hljs-number">78</span>, <span class="hljs-number">90</span>, <span class="hljs-number">89</span>, <span class="hljs-number">69</span>]<br>a = [<span class="hljs-number">78</span>, <span class="hljs-number">59</span>, <span class="hljs-number">40</span>, <span class="hljs-number">90</span>, <span class="hljs-number">89</span>, <span class="hljs-number">45</span>, <span class="hljs-number">69</span>, <span class="hljs-number">30</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a[:]:   <br>    <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">60</span>:<br>        a.remove(i)<br>print(a)<br></code></pre></td></tr></table></figure><h5 id="我们遍历列表的元素，我们一般遍历它的拷贝的值"><a href="#我们遍历列表的元素，我们一般遍历它的拷贝的值" class="headerlink" title="我们遍历列表的元素，我们一般遍历它的拷贝的值( [:] )"></a>我们遍历列表的元素，我们一般遍历它的拷贝的值( [:] )</h5><p><strong>c: list.remove（元素） –&gt; 删除列表中的值</strong><br>如果这个值在列表中有多个，只删除第一个值。</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-keyword">a</span> = [<span class="hljs-string">&#x27;香蕉&#x27;</span>， <span class="hljs-string">&#x27;饼干&#x27;</span>]<br><span class="hljs-keyword">a</span>.remove(<span class="hljs-string">&#x27;饼干&#x27;</span>)<br></code></pre></td></tr></table></figure><h5 id="注意：python中，变量在存数据的时候，会根据数据类型的不同，使用两种方式来存值"><a href="#注意：python中，变量在存数据的时候，会根据数据类型的不同，使用两种方式来存值" class="headerlink" title="注意：python中，变量在存数据的时候，会根据数据类型的不同，使用两种方式来存值"></a>注意：python中，变量在存数据的时候，会根据数据类型的不同，使用两种方式来存值</h5><ul><li>值类型：变量存数据直接存值。例如：整型、浮点型、布尔、字符串</li><li>引用类型：变量存数据的时候，存的是数据在内存中的地址。例如：列表、字典、元组、集合、函数、自定义的类的对象等。<br><img src="https://upload-images.jianshu.io/upload_images/13692175-9511381e9fefd0e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="存储方式.png"><h4 id="列表之间的运算"><a href="#列表之间的运算" class="headerlink" title="列表之间的运算"></a>列表之间的运算</h4><h6 id="A、-操作"><a href="#A、-操作" class="headerlink" title="A、 + 操作"></a>A、 + 操作</h6>列表1 + 列表2：将列表1中的元素和列表2的元素依次合并，产生一个新的列表。<h6 id="B、-操作"><a href="#B、-操作" class="headerlink" title="B、 *  操作"></a>B、 *  操作</h6>列表 * N：将列表中的元素重复N次，产生一个新的列表。<h6 id="C、-in-操作"><a href="#C、-in-操作" class="headerlink" title="C、 in  操作"></a>C、 in  操作</h6>元素 in 列表：判断一个元素是否在列表中。<br><img src="https://upload-images.jianshu.io/upload_images/13692175-382bb1f075409c2c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="列表相关方法.png"><br>说明：</li><li>append（）和extend（）方法区别：<br>append（）是将一个列表作为一个元素加在另一个列表后面。<br>extend（）是将元素一个一个加在另一个列表后面。</li><li>copy（）方法：将列表的元素全部拷贝一份产生一个新的列表，相当于列表[:]<br>注意：这儿拷贝是浅拷贝</li></ul><p><strong>浅拷贝：只是单纯将值拷贝，如果是对象就拷贝相应的地址<br>深拷贝：拷贝元素的值，如果是对象，先根据地址找到值，拷贝值出来，存在一个新的地址里面</strong></p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-meta">#浅拷贝：改变number1值，会影响new_numbers的值</span><br>numbers1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]<br>numbers = [numbers1,<span class="hljs-number">3</span>, <span class="hljs-number">4</span>,<span class="hljs-number">100</span>]<br><span class="hljs-keyword">new</span><span class="hljs-type">_numbers</span> = numbers.copy()<br><span class="hljs-meta">#深拷贝：改变number1值，不会影响new_numbers的值</span><br><span class="hljs-keyword">import</span> copy<br><span class="hljs-keyword">new</span><span class="hljs-type">_numbers2</span> = copy.deepcopy(numbers)<br></code></pre></td></tr></table></figure><h2 id="二、元组–tuple"><a href="#二、元组–tuple" class="headerlink" title="二、元组–tuple"></a>二、元组–tuple</h2><p><strong>元组就是不可变的列表。列表中除了和可变相关的内容以外，都使用于元组。</strong><br>不支持增、删除、修改，只支持和查相关的操作。<br><code>tuple1 = （1, 2，&#39;abc&#39;, True）</code><br>t2 = (100) –&gt; type( t2 ) 是int型  #<br>t2 = (100,) –&gt; type( t2 ) 是tuple型<br>t2 = 1,2,3,4 –&gt; type( t2 ) 是tuple型<br>t2 = () –&gt; 空元组</p><p>特殊操作一：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">point = (<span class="hljs-number">100</span>,<span class="hljs-number">200</span>)<br>print(point[<span class="hljs-number">0</span>], point[<span class="hljs-number">1</span>])<br>#通过两个变量来获取元组中唯一的两个元素的值<br>x, y = point<br><br><span class="hljs-number">100</span> <span class="hljs-number">200</span><br></code></pre></td></tr></table></figure><p>特殊操作二：</p><ul><li>通过在变量前加 * ，获取元组、列表的一部分元素值，结果是列表<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">user = (<span class="hljs-string">&#x27;小刘&#x27;</span>,80,90,78,<span class="hljs-string">&#x27;男&#x27;</span>)<br>name, *score,sex = user<br><span class="hljs-builtin-name">print</span>(name, score,sex)<br><br>小刘 [80, 90, 78] 男<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>容器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Break和Continue</title>
    <link href="/Myblog/2018/08/24/Break%E5%92%8CContinue/"/>
    <url>/Myblog/2018/08/24/Break%E5%92%8CContinue/</url>
    
    <content type="html"><![CDATA[<h2 id="break-、continue-、else、print的用法"><a href="#break-、continue-、else、print的用法" class="headerlink" title="break 、continue 、else、print的用法"></a>break 、continue 、else、print的用法</h2><p>补充：python控制台输入函数— input（）函数<br> <strong>n = input（’请输入：’）</strong><br>说明：<br>1、程序运行到input，会停下来，等待输入才继续执行<br>2、输入结束：遇到return就结束<br>3、获取的输入内容的类型是字符串（不管输入时什么）</p><h3 id="1、-break"><a href="#1、-break" class="headerlink" title="1、 break:"></a>1、 break:</h3><p>程序执行中，只要遇到break，就结束包含break的最近的一个循环</p><p>练习：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">#练习：随机生成一个整数，然后去猜，猜中为止<br><span class="hljs-keyword">import</span> random <br><br>number = random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">100</span>)<br>count = <span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> True:<br>  input_number = <span class="hljs-built_in">int</span>(input(<span class="hljs-string">&#x27;请输入0~100中想要输入的数字：&#x27;</span>))<br>  <span class="hljs-keyword">if</span> input_number &lt; number: <br>    print(<span class="hljs-string">&#x27;小了小了~~\n&#x27;</span>)<br>  elif input_number == number:<br>    print(<span class="hljs-string">&quot;恭喜你答对了！&quot;</span>)<br>    <span class="hljs-keyword">break</span><br>  <span class="hljs-keyword">else</span> :<br>    print(<span class="hljs-string">&#x27; 大了大了~~\n&#x27;</span>)<br><br><br>结果：<br>请输入<span class="hljs-number">0</span>~<span class="hljs-number">100</span>中想要输入的数字：<span class="hljs-number">50</span><br> 大了大了~~<br><br>请输入<span class="hljs-number">0</span>~<span class="hljs-number">100</span>中想要输入的数字：<span class="hljs-number">25</span><br>小了小了~~<br><br>请输入<span class="hljs-number">0</span>~<span class="hljs-number">100</span>中想要输入的数字：<span class="hljs-number">37</span><br>恭喜你答对了！<br><br></code></pre></td></tr></table></figure><h3 id="2、continue"><a href="#2、continue" class="headerlink" title="2、continue"></a>2、continue</h3><p>continue:循环执行到continue后，结束当次循环，跳转到下次循环</p><h3 id="3、else"><a href="#3、else" class="headerlink" title="3、else"></a>3、else</h3><p>else：循环结束后要执行的代码</p><p>比如：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">while</span> 条件语句：<br>  循环体<br><span class="hljs-keyword">else</span>：<br>  循环后要执行的语句<br></code></pre></td></tr></table></figure><h6 id="“while-else”是一个整体，如果break，结束出整个循环，不会执行else中的内容"><a href="#“while-else”是一个整体，如果break，结束出整个循环，不会执行else中的内容" class="headerlink" title="“while-else”是一个整体，如果break，结束出整个循环，不会执行else中的内容"></a>“while-else”是一个整体，如果break，结束出整个循环，不会执行else中的内容</h6><h3 id="4、print"><a href="#4、print" class="headerlink" title="4、print"></a>4、print</h3><p>格式：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">print</span>(*objects, <span class="hljs-attribute">sep</span>=<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-attribute">end</span>=<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-attribute">file</span>=sys.stdout)<br></code></pre></td></tr></table></figure><p>说明：<br>objects –表示输出的对象。输出多个对象时，需要用 , （逗号）分隔。<br>sep – 用来间隔多个对象。<br>end – 用来设定以什么结尾。默认值是换行符 \n，我们可以换成其他字符。<br>file – 要写入的文件对象。</p><p>（1）、一个print（）打印完内容后，默认会换行。<br>（2）、一个print（）可以打印多个内容，多个内容之间用空格隔开。<br>（3）、设置一个print打印结尾结束后的样式（默认换行）。<br>end = 字符串<br>（4）、同时打印多个内容，中间的间隔（默认空格）<br>sep = ‘ ‘</p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>循环和分支</title>
    <link href="/Myblog/2018/08/23/%E5%BE%AA%E7%8E%AF%E5%92%8C%E5%88%86%E6%94%AF/"/>
    <url>/Myblog/2018/08/23/%E5%BE%AA%E7%8E%AF%E5%92%8C%E5%88%86%E6%94%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="一、IF语句"><a href="#一、IF语句" class="headerlink" title="一、IF语句"></a>一、IF语句</h2><p>语法：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">if</span> 条件语句A：<br>      语句块<span class="hljs-number">1</span><br>elif 条件语句B：<br>      语句块<span class="hljs-number">2</span><br><span class="hljs-keyword">else</span>:<br>      语句块<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p>说明：<br>（1）. if 是python中关键字，用于判断条件<br>（2）. 结果转换成布尔值<br>（3）. 条件语句后有 “：”，必须写<br>（4）. 执行语句块的内容必须和 if 保持一个缩进</p><p>执行过程：先判断条件A语句的结果是否为True，如果是，则运行“语句块1”中的语句；反之，判断条件B语句的结果是否为True, 如果为真，运行“语句块2”中的语句；反之，执行 else 模块后的其他语句</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable"><span class="hljs-keyword">if</span></span>  <span class="hljs-variable">age</span> &gt;= <span class="hljs-number">18</span>:<br>  <span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-string">&#x27;成年可以进入网吧!&#x27;</span>)</span><br><span class="hljs-variable"><span class="hljs-keyword">else</span></span>:<br>  <span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-string">&quot;未成年，滚回去学习吧~~~&quot;</span>)</span><br></code></pre></td></tr></table></figure><p>练习：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 产生一个随机数，判断是否是偶数，如果是，打印偶数，否则，打印奇数，若果能够被4整除，再打印‘ 能被4整除’</span><br>import random<br>number = random.randint(0,10000)<br><span class="hljs-keyword">if</span> number % 2 == 0:<br><span class="hljs-builtin-name">print</span>(number)<br><span class="hljs-builtin-name">print</span> (<span class="hljs-string">&#x27;偶数&#x27;</span>)<br><span class="hljs-keyword">if</span> number % 4 == 0:<br><span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;能被4整除&#x27;</span>)<br><span class="hljs-keyword">else</span> :<br><span class="hljs-builtin-name">print</span>(number)<br><span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;奇数&#x27;</span>)<br><br>结果：<br>5731<br>奇数<br>[Finished <span class="hljs-keyword">in</span> 0.4s]<br></code></pre></td></tr></table></figure><p>补充：<br><code>if number % 2 == 0</code> 等价于 <code>if not number  % 2</code></p><h2 id="二、While循环-和-For循环"><a href="#二、While循环-和-For循环" class="headerlink" title="二、While循环 和 For循环"></a>二、While循环 和 For循环</h2><p>完成某个功能时，需要重复某个操作，需要使用循环。</p><h3 id="1-While循环"><a href="#1-While循环" class="headerlink" title="1.While循环"></a>1.While循环</h3><p>语法：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">while</span> 条件语句：<br>  循环体<br></code></pre></td></tr></table></figure><p>说明：<br>A. while：关键字<br>B. 条件语句： 结果是True 或者 False<br>C. 循环体 ： 要重复执行的代码</p><p>执行过程：<br><strong>判断条件语句的结果是否为 True ， 如果为 True 就执行循环体 ， 执行完循环体再判断条件语句是否为 True ，直到条件语句的结果为  False 为止。</strong> </p><p>练习：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"># 找大于<span class="hljs-number">10000</span>中第一个能被<span class="hljs-number">47</span>整除的数<br>x = <span class="hljs-number">10000</span> <br><span class="hljs-keyword">while</span> x % <span class="hljs-number">47</span> :<br>x += <span class="hljs-number">1</span> <br>print(<span class="hljs-string">&#x27;大于10000中的第一个能被47整除的数：%d&#x27;</span>%x)<br><br>大于<span class="hljs-number">10000</span>中的第一个能被<span class="hljs-number">47</span>整除的数：<span class="hljs-number">10011</span><br>[Finished <span class="hljs-keyword">in</span> <span class="hljs-number">0.4</span>s]<br></code></pre></td></tr></table></figure><h3 id="2-for循环"><a href="#2-for循环" class="headerlink" title="2.for循环"></a>2.for循环</h3><p>语法：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">for</span> 变量名 in 序列：<br>  循环体<br></code></pre></td></tr></table></figure><p>说明：<br>A. for:关键字<br>B. 变量名： 和声明变量时的变量名的要求一样<br>C. in ： 关键字<br>D. 序列 ：容器 - 数据本身是由多个数据组成 ，例如字符串、字典、元祖 、集合 、range（）、生成式 、生成器<br>E. 循环体 ： 需要重复执行的代码</p><p>执行过程：<br><strong>让变量去序列中取数据，取完为止。每取一个数据，执行一次循环体</strong></p><p>range()函数是python中的内置函数，作用是产生一定范围的数字。<br>—-xrange（）是python2中的函数，python3中用range（）代替。<br><strong>range（n，m，step）产生n ~ m-1 的所有数字，step为步进。</strong></p><p>练习：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"># 统计一下<span class="hljs-number">1</span>~<span class="hljs-number">1000</span>中能被<span class="hljs-number">3</span>整除的数的个数<br>len = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">1001</span>):<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i % <span class="hljs-number">3</span>:<br>len += <span class="hljs-number">1</span><br>i += <span class="hljs-number">1</span><br>print(<span class="hljs-string">&#x27;1~1000中能被3整除的数的个数为：%d&#x27;</span>%len)<br><br><span class="hljs-number">1</span>~<span class="hljs-number">1000</span>中能被<span class="hljs-number">3</span>整除的数的个数为：<span class="hljs-number">333</span><br>[Finished <span class="hljs-keyword">in</span> <span class="hljs-number">0.4</span>s]<br></code></pre></td></tr></table></figure><h3 id="3-While循环-和-For循环-的选择"><a href="#3-While循环-和-For循环-的选择" class="headerlink" title="3.While循环 和 For循环 的选择"></a>3.While循环 和 For循环 的选择</h3><h6 id="For-循环次数是有限的，While循环次数不确定"><a href="#For-循环次数是有限的，While循环次数不确定" class="headerlink" title="For 循环次数是有限的，While循环次数不确定"></a>For 循环次数是有限的，While循环次数不确定</h6><p>1.优先选择 For 循环：<br>（1）遍历序列的值 （2）循环次数确定<br>2.优先选择 While 循环：<br>（1）死循环 （2）循环次数不确定</p><h2 id="三、break-和-continue"><a href="#三、break-和-continue" class="headerlink" title="三、break 和 continue"></a>三、break 和 continue</h2><p>break 和 continue 放到循环体有特殊的功能</p><ul><li>break ： 程序执行到 break ， 整个循环直接结束。</li><li>continue ： 循环体中遇到 continue ，结束当次循环，进入到下次循环 。 </li></ul>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>循环</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>字符串相关</title>
    <link href="/Myblog/2018/08/22/%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B8%E5%85%B3/"/>
    <url>/Myblog/2018/08/22/%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B8%E5%85%B3/</url>
    
    <content type="html"><![CDATA[<h2 id="1-数据存储形式"><a href="#1-数据存储形式" class="headerlink" title="1.数据存储形式"></a>1.数据存储形式</h2><p><strong>计算机以二进制的形式存储</strong></p><p><strong>(1).原码：数据的二进制形式</strong></p><p>10 –&gt; 1010 原码：00001010<br>-10 –&gt;  原码：10001010</p><p><strong>(2).反码</strong></p><ul><li>正数的反码：反码和原码一样</li><li>负数的反码：符号位不变，后面每一位取反<br>10 –&gt;  反码：00001010</li><li>10 –&gt; 反码：11110101</li></ul><p><strong>(3).补码</strong></p><ul><li>正数的补码：补码和原码一样</li><li>负数的补码：符号位不变，后面每一位取反再加1（反码+1）</li></ul><h2 id="2-认识字符串"><a href="#2-认识字符串" class="headerlink" title="2.认识字符串"></a>2.认识字符串</h2><ul><li><strong>用单引号或者双引号括起来的字符集就是字符串</strong></li><li><strong>字符串中的每个独立的单元就叫字符</strong></li></ul><h2 id="3-转义字符"><a href="#3-转义字符" class="headerlink" title="3.转义字符"></a>3.转义字符</h2><ul><li>通过 \ 将一些特殊的字符转换成一个具有特殊功能或特殊意义的字符，就是转义字符。</li><li><strong>常见的转义字符</strong><br>\n — 换行<br>\t  — 制表符（tab）<br>\‘ —  ‘</li></ul><p><strong>(1).需要显示转义字符，在前面加 \ 即可。</strong><br>\\  — \<br><strong>计算字符串长度的时候，转义字符的长度是1</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/n    /</span>t   <span class="hljs-regexp">//</span>  <br></code></pre></td></tr></table></figure><p><strong>(2).如果需要同时转义多个字符，可以在字符串前面加 r 即可。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">a = <span class="hljs-string">r&#x27;abcd\nsde\t&#x27;</span><br>print(a)<br><br>abcd\nsde\t     <span class="hljs-comment">#a</span><br></code></pre></td></tr></table></figure><p><strong>(3).python中字符的编码采用的是Unicode编码</strong><br>A.Unicode编码包括了ASCII码。<br>B.Unicode是采用两个字节对一个字符进行编码（2^15）,将世界上所有符号进行编码。</p><ul><li>将字符转换成指定的数值，这个过程就是编码（目的是方便计算机存储）</li><li>将数值转换成对应的符号的过程及时反编码（解码）</li></ul><p><strong>Unicode和字符的转换</strong><br>1).将Unicode码转换成字符：chr（编码）–</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-title">chr</span>(<span class="hljs-number">0</span><span class="hljs-variable">xAC00</span>))</span><br><span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-title">chr</span>(<span class="hljs-number">0</span><span class="hljs-variable">x4e60</span>))</span><br><br>가<br>习<br></code></pre></td></tr></table></figure><p>2)将字符转换成Unicode编码：ord（字符）</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lisp">code1 = ord(&#x27;星&#x27;)<br>code2 = ord(&#x27;辰&#x27;)<br>print(<span class="hljs-name">hex</span>(<span class="hljs-name">code1</span>), hex(<span class="hljs-name">code2</span>))<br><br><span class="hljs-number">0</span>x661f <span class="hljs-number">0</span>x8fb0<br></code></pre></td></tr></table></figure><h2 id="4-获取字符"><a href="#4-获取字符" class="headerlink" title="4.获取字符"></a>4.获取字符</h2><ul><li>字符串实质可以是一个不可变的序列，序列内容是字符。</li><li>一旦字符串确定，那么里面的字符和字符的位置就不可变了，例如‘abc’</li></ul><p><strong>A. 怎么获取单个字符</strong><br>python中的字符串，可以通过下标（索引）来获取指定位置上的字符：字符串[索引]<br>   说明：<br>   a.字符串：可以是字符串值，也可以是字符串变量</p><p>   b. []:中括号是固定语法</p><p>   <strong>c.索引：从0开始到字符串长度减1（0对应第一个字符）；-1~-长度（-1对应最后一个字符）</strong></p><p>注意：索引不能越界，否则越界！（产生异常）</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">str1</span> = &#x27;abc&#x27;    #a-&gt;</span><span class="hljs-number">0</span> , <span class="hljs-function"><span class="hljs-title">b</span>-&gt;</span><span class="hljs-number">1</span> , <span class="hljs-function"><span class="hljs-title">c</span>-&gt;</span><span class="hljs-number">2</span><br>print(str1[<span class="hljs-number">2</span>])<br><br>c<br></code></pre></td></tr></table></figure><p><strong>B.获取部分字符串（获取子串） –  切片</strong></p><p><strong>注意：<br>步进如果是正数，那么下标1对应的位置必须在下标2的前面；如果步进为负数，那么下标1对应的位置必须在下标2的后面</strong></p><p><strong>下标2对应的字符是取不到的</strong></p><ul><li>字符串[下标1：下标2]  ： </li></ul><p>说明：从下标1开始，获取到下标2前的所有字符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">str2 = <span class="hljs-string">&#x27;hello world&#x27;</span><br>print(str2[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>])<br>print(str2[<span class="hljs-number">-4</span>:<span class="hljs-number">-1</span>])<br><br>hell<br>orl<br></code></pre></td></tr></table></figure><ul><li>字符串[下标1：下标2：步进]</li></ul><p>说明：从下标1开始获取，每次下标值增加步进值，每增加一次取一次，直到取到下标2为止。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs"><span class="hljs-attribute">str2</span> = &#x27;hello world&#x27;<br><span class="hljs-attribute">print</span>(str<span class="hljs-number">2</span>[<span class="hljs-number">0</span>:<span class="hljs-number">8</span>:<span class="hljs-number">2</span>])<br><br><span class="hljs-attribute">hlow</span><br>[Finished in 0.3s]<br></code></pre></td></tr></table></figure><ul><li><p>切片的时候，下标1和下标2是可以省略</p><ul><li><p>下标1省略：默认从开始的位置开始获取（可能是第一个字符，也可能是最后一个开始，取决于步进）</p></li><li><p>下标2省略：从下标1开始获取（同上）</p><p>效果如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus">str2 = <span class="hljs-string">&#x27;hello world&#x27;</span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(str2[:<span class="hljs-number">8</span>:<span class="hljs-number">1</span>])</span></span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(str2[:<span class="hljs-number">8</span>:-<span class="hljs-number">1</span>])</span></span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(str2[<span class="hljs-number">1</span>::<span class="hljs-number">1</span>])</span></span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(str2[<span class="hljs-number">1</span>::-<span class="hljs-number">1</span>])</span></span><br><br>hello wo<br>dl<br>ello world<br>eh<br>[Finished <span class="hljs-keyword">in</span> <span class="hljs-number">0.3s</span>]<br></code></pre></td></tr></table></figure></li><li><p>下标1和下标2都省略</p><figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs hsp"><span class="hljs-keyword">str</span> = <span class="hljs-string">&#x27;hello world and python&#x27;</span><br><span class="hljs-keyword">print</span>(<span class="hljs-keyword">str</span>[::<span class="hljs-number">2</span>])      <span class="hljs-meta">#打印所有奇数位</span><br><br>hlowrdadpto<br>[Finished in <span class="hljs-number">0.3</span>s]<br></code></pre></td></tr></table></figure><h2 id="5-字符串运算"><a href="#5-字符串运算" class="headerlink" title="5.字符串运算"></a>5.字符串运算</h2></li></ul></li></ul><p><strong>1.加法运算</strong><br>python支持两个字符串相加，效果就是将两个字符串拼接在一起产生一个新的字符串</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&#x27;abc&#x27;</span>+<span class="hljs-string">&#x27;123&#x27;</span>)</span></span><br><br>abc123<br>[Finished <span class="hljs-keyword">in</span> <span class="hljs-number">0.3s</span>]<br></code></pre></td></tr></table></figure><p>注意：“+”号的两边必须是同一类型</p><p><strong>2.乘法运算</strong><br>格式：字符串*整数</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&#x27;abc&#x27;</span> * <span class="hljs-number">3</span>)</span></span><br><br>abcabcabc<br>[Finished <span class="hljs-keyword">in</span> <span class="hljs-number">0.2s</span>]<br></code></pre></td></tr></table></figure><p><strong>3.支持所有的比较运算符</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">str1 = <span class="hljs-string">&#x27;abc&#x27;</span><br><span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;abc&#x27;</span> == str1)<br><span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;abcd&#x27;</span> &gt; <span class="hljs-string">&#x27;ac&#x27;</span>)  <br>每一位依次比较其 Unicode码值大小<br><br><span class="hljs-literal">True</span><br><span class="hljs-literal">False</span><br>[Finished <span class="hljs-keyword">in</span> 0.3s]<br></code></pre></td></tr></table></figure><p><strong>4.in 和 not in</strong><br>‘a’ in ‘abd’ : 判断 ‘a’ 是否在 ‘abd’ 中<br><strong>判断结果为布尔值</strong></p><p><strong>5.获取字符串长度</strong><br>字符串长度 = 字符串个数<br>使用 len() 内置函数</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">str3</span> = <span class="hljs-string">&#x27;project&#x27;</span><br><span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-title">len</span>(<span class="hljs-variable">str3</span>))</span><br><br><span class="hljs-number">7</span><br></code></pre></td></tr></table></figure><p>补充：空串</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">str</span> = <span class="hljs-string">&#x27;&#x27;</span>    <span class="hljs-comment">#长度是0</span><br></code></pre></td></tr></table></figure><p><strong>6.阻止转义</strong><br>在字符串的最前面添加 r/R 可以阻止转义</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">print(<span class="hljs-string">r&#x27;a\nb&#x27;</span>)<br><br>a\nb<br></code></pre></td></tr></table></figure><p><strong>7.python为字符串提供了很多的內建函数</strong></p><p><strong>格式： 字符串.函数（）</strong></p><p><strong>这些所有函数的功能都不会影响原来的字符串，而是产生一个新的字符串</strong></p><p>A.capitalize()：将字符串第一个字符转换成大写</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">str1 = <span class="hljs-string">&#x27;hello world&#x27;</span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(str1.capitalize()</span></span>)<br><br>Hello world<br>[Finished <span class="hljs-keyword">in</span> <span class="hljs-number">0.2s</span>]<br></code></pre></td></tr></table></figure><p>B.center(width, fillchar) : 让字符串居中（width 宽度 ， fillchar 填充的字符）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">print</span>(<span class="hljs-string">&#x27;abc&#x27;</span>.center(10,<span class="hljs-string">&#x27;*&#x27;</span>))<br><br>**<span class="hljs-number">*abc</span>****<br></code></pre></td></tr></table></figure><p>C.rjust(width , fillchar) : 让字符串局右（width 宽度 ， fillchar 填充的字符）</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs haxe">number = <span class="hljs-string">&#x27;1&#x27;</span><br><span class="hljs-keyword">new</span><span class="hljs-type">_id</span> = number.rjust(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;0&#x27;</span>)<br>print(<span class="hljs-keyword">new</span><span class="hljs-type">_id</span>)<br><br><span class="hljs-number">001</span><br>[Finished <span class="hljs-keyword">in</span> <span class="hljs-number">0.2</span>s]<br></code></pre></td></tr></table></figure><p>同理 ljust（width，fillchar）左对齐</p><p>D. str.count(sub, start= 0,end=len(string))<br> 统计次数（sub是搜索的子字符串，start和end分别是开始和结束位置）</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&#x27;adgfdsaaa&#x27;</span> .count(<span class="hljs-string">&#x27;a&#x27;</span>)</span></span>)<br><br><span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><p>E.str1.join(str2)<br>在str2中的每个字符串之间插入一个str1</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&#x27;+&#x27;</span>.join(<span class="hljs-string">&#x27;abc&#x27;</span>)</span></span>)<br><br>a+b+c<br></code></pre></td></tr></table></figure><p>F. str1.replace(old, new,num)<br>将str1中的old全部替换成new(num表示替换前几个)</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">new</span><span class="hljs-type">_str</span> = <span class="hljs-string">&#x27;abcdfdwdadfswqaqd&#x27;</span>.replace(<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;+&#x27;</span>)<br>print(<span class="hljs-keyword">new</span><span class="hljs-type">_str</span>)<br><br>+bcdfdwd+dfswq+qd<br></code></pre></td></tr></table></figure><h2 id="6-字符串的格式化"><a href="#6-字符串的格式化" class="headerlink" title="6.字符串的格式化"></a>6.字符串的格式化</h2><p><strong>语法：’格式符’  %（格式符对应的值）</strong></p><ul><li><p>常见格式化字符：</p><ul><li>格式化字符串 —&gt; %s</li><li>格式化数字 —&gt; %d</li><li>格式化浮点数 —&gt; %f</li><li>格式化字符 —&gt; %c （一般用于ascii码或者Unicode码）<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs haxe">first_name = <span class="hljs-string">&#x27;星&#x27;</span><br>last_name = <span class="hljs-string">&#x27;辰&#x27;</span><br>age = <span class="hljs-number">18</span><br><span class="hljs-keyword">new</span><span class="hljs-type">str</span> = <span class="hljs-string">&#x27;hello,%s%s!今年%d岁&#x27;</span> %(first_name,last_name,age)<br>print(<span class="hljs-keyword">new</span><span class="hljs-type">str</span>)<br><br>hello,星辰!今年<span class="hljs-number">18</span>岁<br>[Finished <span class="hljs-keyword">in</span> <span class="hljs-number">0.5</span>s]<br></code></pre></td></tr></table></figure></li></ul></li></ul><p><strong>%n.mf ：m表示显示的最小总宽度，n表示小数点位数</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs"><span class="hljs-attribute">a</span> = <span class="hljs-number">3434</span>.<span class="hljs-number">12345</span><br><span class="hljs-attribute">print</span>(&#x27;%<span class="hljs-number">8</span>.<span class="hljs-number">4</span>f&#x27;%a)<br><br><span class="hljs-attribute">3434</span>.<span class="hljs-number">1235</span><br>[Finished in 0.6s]<br></code></pre></td></tr></table></figure><p>附：<br><img src="https://upload-images.jianshu.io/upload_images/13692175-d9fabc24c795a5eb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><h2 id="7-数据类型转换"><a href="#7-数据类型转换" class="headerlink" title="7.数据类型转换"></a>7.数据类型转换</h2><p>1.数据类型的自动转换</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">a</span> = <span class="hljs-number">10</span>   <span class="hljs-comment">#整型 </span><br><span class="hljs-attr">b</span> = <span class="hljs-number">12.5</span>   <span class="hljs-comment">#浮点型</span><br><span class="hljs-attr">result</span> = a+ b  <span class="hljs-comment">#浮点型--会自动转换整型为浮点型 </span><br></code></pre></td></tr></table></figure><p>2.强制转换<br>基本语法：类型名（数据）</p><ul><li>其他类型 —&gt; 整型<br>int（12.5）—&gt; 12</li></ul><p><em>去掉字符串的引号后，字符串的本身就是整数，才能转换成整型</em><br>int（’123’） —&gt; 123<br><del>int ( ‘123a’)</del><br><del>int (‘123.5’)</del>  </p><ul><li>其他类型 —&gt; 浮点型<br>float(True) —&gt; 1.0</li></ul><p><em>去掉字符串的引号后，字符串的本身就是浮点数，才能转换成浮点型</em><br>float(‘2e3’) —&gt; 2000.0</p><ul><li>其他类型 —&gt; 布尔型</li></ul><p><em>所有数据类型的数据都可以转换成布尔</em><br>（1）.数字中：除了0都是True<br>bool(100) —&gt; True<br>bool(-12.5) —&gt; True<br>bool (0) —&gt; False<br>（2）.字符串中除了空串都是True<br>bool (‘False’) —&gt; True<br>bool （’’） —&gt; False<br>bool (None) —&gt; False</p><ul><li>其他类型 —&gt; 字符串</li></ul><p><em>所有数据都可以转换成字符串</em><br>str(100) —&gt; ‘100’<br>str(True) —&gt; ‘True’</p><h2 id="8-字符串相关方法"><a href="#8-字符串相关方法" class="headerlink" title="8.字符串相关方法"></a>8.字符串相关方法</h2><h6 id="python的字符串内建函数"><a href="#python的字符串内建函数" class="headerlink" title="python的字符串内建函数"></a>python的字符串内建函数</h6><p><strong>name.split(‘,’)</strong><br>按照逗号分割(不写默认按照空格分割)</p><p><a href="http://www.runoob.com/python/att-string-capitalize.html">string.capitalize()</a><br>把字符串的第一个字符大写</p><p><a href="http://www.runoob.com/python/att-string-center.html">string.center(width)</a><br>返回一个原字符串居中,并使用空格填充至长度 width 的新字符串</p><p><strong><a href="http://www.runoob.com/python/att-string-count.html">string.count(str, beg=0, end=len(string))</a></strong><br>返回 str 在 string 里面出现的次数，如果 beg 或者 end 指定则返回指定范围内 str 出现的次数</p><p><a href="http://www.runoob.com/python/att-string-decode.html">string.decode(encoding=’UTF-8’, errors=’strict’)</a><br>以 encoding 指定的编码格式解码 string，如果出错默认报一个 ValueError 的 异 常 ， 除 非 errors 指 定 的 是 ‘ignore’ 或 者’replace’</p><p><a href="http://www.runoob.com/python/att-string-encode.html">string.encode(encoding=’UTF-8’, errors=’strict’)</a><br>以 encoding 指定的编码格式编码 string，如果出错默认报一个ValueError 的异常，除非 errors 指定的是’ignore’或者’replace’</p><p><strong><a href="http://www.runoob.com/python/att-string-endswith.html">string.endswith(obj, beg=0, end=len(string))</a></strong><br>检查字符串是否以 obj 结束，如果beg 或者 end 指定则检查指定的范围内是否以 obj 结束，如果是，返回 True,否则返回 False.</p><p><a href="http://www.runoob.com/python/att-string-expandtabs.html">string.expandtabs(tabsize=8)</a><br>字符串 string 中的 tab 符号转为空格，tab 符号默认的空格数是 8。</p><p><strong><a href="http://www.runoob.com/python/att-string-find.html">string.find(str, beg=0, end=len(string))</a></strong><br>检测 str 是否包含在 string 中，如果 beg 和 end 指定范围，则检查是否包含在指定范围内，如果是返回开始的索引值，否则返回-1</p><p><strong><a href="http://www.runoob.com/python/att-string-format.html">string.format()</a></strong><br>格式化字符串</p><p><strong><a href="http://www.runoob.com/python/att-string-index.html">string.index(str, beg=0, end=len(string))</a></strong><br>跟find()方法一样，只不过如果str不在 string中会报一个异常.</p><p><a href="http://www.runoob.com/python/att-string-isalnum.html">string.isalnum()</a><br>如果 string 至少有一个字符并且所有字符都是字母或数字则返<br>回 True,否则返回 False</p><p><a href="http://www.runoob.com/python/att-string-isalpha.html">string.isalpha()</a><br>如果 string 至少有一个字符并且所有字符都是字母则返回 True,<br>否则返回 False</p><p><a href="http://www.runoob.com/python/att-string-isdecimal.html">string.isdecimal()</a><br>如果 string 只包含十进制数字则返回 True 否则返回 False.</p><p><a href="http://www.runoob.com/python/att-string-isdigit.html">string.isdigit()</a><br>如果 string 只包含数字则返回 True 否则返回 False.</p><p><a href="http://www.runoob.com/python/att-string-islower.html">string.islower()</a><br>如果 string 中包含至少一个区分大小写的字符，并且所有这些(区分大小写的)字符都是小写，则返回 True，否则返回 False</p><p><a href="http://www.runoob.com/python/att-string-isnumeric.html">string.isnumeric()</a><br>如果 string 中只包含数字字符，则返回 True，否则返回 False</p><p><a href="http://www.runoob.com/python/att-string-isspace.html">string.isspace()</a><br>如果 string 中只包含空格，则返回 True，否则返回 False.</p><p><a href="http://www.runoob.com/python/att-string-istitle.html">string.istitle()</a><br>如果 string 是标题化的(见 title())则返回 True，否则返回 False</p><p><a href="http://www.runoob.com/python/att-string-isupper.html">string.isupper()</a><br>如果 string 中包含至少一个区分大小写的字符，并且所有这些(区分大小写的)字符都是大写，则返回 True，否则返回 False</p><p><strong><a href="http://www.runoob.com/python/att-string-join.html">string.join(seq)</a></strong><br>以 string 作为分隔符，将 seq 中所有的元素(的字符串表示)合并为一个新的字符串</p><p><a href="http://www.runoob.com/python/att-string-ljust.html">string.ljust(width)</a><br>返回一个原字符串左对齐,并使用空格填充至长度 width 的新字符串</p><p><a href="http://www.runoob.com/python/att-string-lower.html">string.lower()</a><br>转换 string 中所有大写字符为小写.</p><p><a href="http://www.runoob.com/python/att-string-lstrip.html">string.lstrip()</a><br>截掉 string 左边的空格</p><p><a href="http://www.runoob.com/python/att-string-maketrans.html">string.maketrans(intab, outtab)</a><br>maketrans() 方法用于创建字符映射的转换表，对于接受两个参数的最简单的调用方式，第一个参数是字符串，表示需要转换的字符，第二个参数也是字符串表示转换的目标。</p><p><a href="http://www.runoob.com/python/att-string-max.html">max(str)</a><br>返回字符串 <em>str</em> 中最大的字母。</p><p><a href="http://www.runoob.com/python/att-string-min.html">min(str)</a><br>返回字符串 <em>str</em> 中最小的字母。</p><p><strong><a href="http://www.runoob.com/python/att-string-partition.html">string.partition(str)</a></strong><br>有点像 find()和 split()的结合体,从 str 出现的第一个位置起,把 字 符 串 string 分 成 一 个 3 元 素 的 元 组 (string_pre_str,str,string_post_str),如果 string 中不包含str 则 string_pre_str == string.</p><p><strong><a href="http://www.runoob.com/python/att-string-replace.html">string.replace(str1, str2,  num=string.count(str1))</a></strong><br>把 string 中的 str1 替换成 str2,如果 num 指定，则替换不超过 num 次.</p><p><a href="http://www.runoob.com/python/att-string-rfind.html">string.rfind(str, beg=0,end=len(string) )</a><br>类似于 find()函数，不过是从右边开始查找.</p><p><a href="http://www.runoob.com/python/att-string-rindex.html">string.rindex( str, beg=0,end=len(string))</a><br>类似于 index()，不过是从右边开始.</p><p><a href="http://www.runoob.com/python/att-string-rjust.html">string.rjust(width)</a><br>返回一个原字符串右对齐,并使用空格填充至长度 width 的新字符串</p><p>string.rpartition(str)<br>类似于 partition()函数,不过是从右边开始查找.</p><p><a href="http://www.runoob.com/python/att-string-rstrip.html">string.rstrip()</a><br>删除 string 字符串末尾的空格.</p><p><strong><a href="http://www.runoob.com/python/att-string-split.html">string.split(str=””, num=string.count(str))</a></strong><br>以 str 为分隔符切片 string，如果 num有指定值，则仅分隔 num 个子字符串</p><p><a href="http://www.runoob.com/python/att-string-splitlines.html">string.splitlines([keepends])</a><br>按照行(‘\r’, ‘\r\n’, \n’)分隔，返回一个包含各行作为元素的列表，如果参数 keepends 为 False，不包含换行符，如果为 True，则保留换行符。</p><p><a href="http://www.runoob.com/python/att-string-startswith.html">string.startswith(obj, beg=0,end=len(string))</a><br>检查字符串是否是以 obj 开头，是则返回 True，否则返回 False。如果beg 和 end 指定值，则在指定范围内检查.</p><p><strong><a href="http://www.runoob.com/python/att-string-strip.html">string.strip([obj])</a></strong></p><p>在 string 上执行 lstrip()和 rstrip()<br><a href="http://www.runoob.com/python/att-string-swapcase.html">string.swapcase()</a></p><p>翻转 string 中的大小写<br><a href="http://www.runoob.com/python/att-string-title.html">string.title()</a><br>返回”标题化”的 string,就是说所有单词都是以大写开始，其余字母均为小写(见 istitle())</p><p><strong><a href="http://www.runoob.com/python/att-string-translate.html">string.translate(str, del=””)</a></strong><br>根据 str 给出的表(包含 256 个字符)转换 string 的字符,要过滤掉的字符放到 del 参数中</p><p><a href="http://www.runoob.com/python/att-string-upper.html">string.upper()</a><br>转换 string 中的小写字母为大写</p><p><a href="http://www.runoob.com/python/att-string-zfill.html">string.zfill(width)</a><br>返回长度为 width 的字符串，原字符串 string 右对齐，前面填充0</p><p><a href="http://www.runoob.com/python/att-string-isdecimal.html">string.isdecimal()</a><br>isdecimal()方法检查字符串是否只包含十进制字符。这种方法只存在于unicode对象。</p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>字符串</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python基础语法</title>
    <link href="/Myblog/2018/08/21/Python%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/"/>
    <url>/Myblog/2018/08/21/Python%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h2 id="Python就业领域"><a href="#Python就业领域" class="headerlink" title="Python就业领域"></a>Python就业领域</h2><ol><li>服务器端应用开发 - 网站服务器/游戏服务器<br> Django / Flask / Tornado</li><li>云服务基础平台<br> Go / Java / Python - OpenStack</li><li>爬虫开发（网络数据采集）</li><li>量化交易（数字货币）</li><li>自动化测试（Shell/Java –&gt; Python）</li><li>自动化运维</li><li>数据分析+机器学习(深度学习)</li></ol><hr><h1 id="python解释性、编译性、互动性和面向对象的脚本语言。"><a href="#python解释性、编译性、互动性和面向对象的脚本语言。" class="headerlink" title="python解释性、编译性、互动性和面向对象的脚本语言。"></a>python解释性、编译性、互动性和面向对象的脚本语言。</h1><h2 id="python语言具有很强的可读性"><a href="#python语言具有很强的可读性" class="headerlink" title="python语言具有很强的可读性"></a>python语言具有很强的可读性</h2><p>特点：1.易于学习 2.易于阅读 3.易于维护 4.一个广泛的标准库 5.互动模式 6.可移植性 7.可扩展性 8.数据库 9.GUI编程 10.可嵌入</p><h1 id="1-快捷键："><a href="#1-快捷键：" class="headerlink" title="1.快捷键："></a>1.快捷键：</h1><p>ctrl+/  添加/取消注释<br>ctrl+s  保存<br>ctrl+c  复制<br>ctrl+x  剪切<br>ctrl+v  粘贴<br>ctrl+b  编译<br>ctrl+a  全选<br>ctrl+z  撤销<br>ctrl+shift+z  反撤销<br>ctrl+f  弹出搜索框<br>ctrl+n  新建<br>ctrl+shift+n 新建（工程）<br>按住shift点鼠标，可以选中部分内容</p><h1 id="2-注意："><a href="#2-注意：" class="headerlink" title="2.注意："></a>2.注意：</h1><p>写代码的时候，一定是在英文输入的状态</p><h1 id="3-注释"><a href="#3-注释" class="headerlink" title="3.注释"></a>3.注释</h1><p>  注释是不会参与代码的编译和执行的，只是对代码进行解释和说明<br>  单行注释：注释文字前加#<br>  多行注释：3个单引号（双引号）前后包起来</p><h1 id="4-标识符：（专门用来命名的-变量、函数、类）"><a href="#4-标识符：（专门用来命名的-变量、函数、类）" class="headerlink" title="4.标识符：（专门用来命名的-变量、函数、类）"></a>4.标识符：（专门用来命名的-变量、函数、类）</h1><p>  要求<br>  a.是由字母数字下划线（只能少不能多）<br>  b.数字表示开头的<br>  c.大小写敏感<br>  d.python3以后，标识符中可以包含非ASCII码（可以包含中文-不建议使用）</p><h1 id="5-关键字（保留字）"><a href="#5-关键字（保留字）" class="headerlink" title="5.关键字（保留字）"></a>5.关键字（保留字）</h1><p>  <strong>Python中用来作为特殊语法和拥有特殊功能的单词</strong></p><p><strong>查看关键字</strong></p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">import</span> <span class="hljs-built_in">keyword</span> <br>print (<span class="hljs-built_in">keyword</span>.kwlist)<br></code></pre></td></tr></table></figure><p>效果如下：</p><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scheme">[<span class="hljs-symbol">&#x27;False</span>&#x27;, <span class="hljs-symbol">&#x27;None</span>&#x27;, <span class="hljs-symbol">&#x27;True</span>&#x27;, <span class="hljs-symbol">&#x27;and</span>&#x27;, <span class="hljs-symbol">&#x27;as</span>&#x27;, <span class="hljs-symbol">&#x27;assert</span>&#x27;, <span class="hljs-symbol">&#x27;break</span>&#x27;, <span class="hljs-symbol">&#x27;class</span>&#x27;, <span class="hljs-symbol">&#x27;continue</span>&#x27;, <span class="hljs-symbol">&#x27;def</span>&#x27;, <span class="hljs-symbol">&#x27;del</span>&#x27;, <span class="hljs-symbol">&#x27;elif</span>&#x27;, <span class="hljs-symbol">&#x27;else</span>&#x27;, <span class="hljs-symbol">&#x27;except</span>&#x27;, <span class="hljs-symbol">&#x27;finally</span>&#x27;, <span class="hljs-symbol">&#x27;for</span>&#x27;, <span class="hljs-symbol">&#x27;from</span>&#x27;, <span class="hljs-symbol">&#x27;global</span>&#x27;, <span class="hljs-symbol">&#x27;if</span>&#x27;, <span class="hljs-symbol">&#x27;import</span>&#x27;, <span class="hljs-symbol">&#x27;in</span>&#x27;, <span class="hljs-symbol">&#x27;is</span>&#x27;, <span class="hljs-symbol">&#x27;lambda</span>&#x27;, <span class="hljs-symbol">&#x27;nonlocal</span>&#x27;, <span class="hljs-symbol">&#x27;not</span>&#x27;, <span class="hljs-symbol">&#x27;or</span>&#x27;, <span class="hljs-symbol">&#x27;pass</span>&#x27;, <span class="hljs-symbol">&#x27;raise</span>&#x27;, <span class="hljs-symbol">&#x27;return</span>&#x27;, <span class="hljs-symbol">&#x27;try</span>&#x27;, <span class="hljs-symbol">&#x27;while</span>&#x27;, <span class="hljs-symbol">&#x27;with</span>&#x27;, <span class="hljs-symbol">&#x27;yield</span>&#x27;]<br>[<span class="hljs-name">Finished</span> in <span class="hljs-number">0.3</span>s]<br></code></pre></td></tr></table></figure><h1 id="6-行与缩进"><a href="#6-行与缩进" class="headerlink" title="6.行与缩进"></a>6.行与缩进</h1><p><strong>缩进的要求：</strong><br>1.同一级的代码必须保持统一缩进（统一使用tab键来产生缩进）<br>2.通过缩进来产生代码块（类似其他语言中的{}）<br><strong>行的规范：</strong><br>1.声明函数的前后必须有两个换行<br>2.声明类的前后也需要两个换行<br>3.都个功能模块间用换行隔开</p><h1 id="7-多行显示（一句代码多行显示）"><a href="#7-多行显示（一句代码多行显示）" class="headerlink" title="7.多行显示（一句代码多行显示）"></a>7.多行显示（一句代码多行显示）</h1><p>一行代码显示不完，不方便阅读时使用，不影响代码效果！<br><strong>1.语法：行末加反斜杠“\”即可</strong></p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">1000 </span>+ <span class="hljs-number">2434543</span> - \<br><span class="hljs-symbol">43643435 </span>/ <span class="hljs-number">1000</span><br></code></pre></td></tr></table></figure><p>2.列表、字典、元组和集合的字面量换行不用加“\”</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">[<span class="hljs-number">120</span>,<span class="hljs-number">23</span>,<br>&#x27;abc&#x27;,<br><span class="hljs-number">545</span>,hehe]<br></code></pre></td></tr></table></figure><h1 id="8-字面量（具体的值）"><a href="#8-字面量（具体的值）" class="headerlink" title="8.字面量（具体的值）"></a>8.字面量（具体的值）</h1><p><strong>1.数字字面量：</strong><br>10,12.5，-20，+10.0,2e2<br><strong>2.布尔值：</strong><br>True（真），False（假）<br><strong>3.字符串：’proxy123’ , “hello”</strong><br><strong>4.列表：</strong><br>[10,20,’python’]<br><strong>5.字典：</strong><br>{‘a’:10 , ‘name’:’xingchen’}</p><h1 id="9-python中的基本数据类型"><a href="#9-python中的基本数据类型" class="headerlink" title="9.python中的基本数据类型"></a>9.python中的基本数据类型</h1><p><strong>1.数字相关的：</strong><br>int（整型），  float（浮点型），complex（复数）<br><strong>2.布尔 - bool</strong><br>只有True ，False两个值<br>**3.字符串 - str **</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">a</span>=<span class="hljs-string">&quot;abc&quot;</span><br></code></pre></td></tr></table></figure><p><strong>4.列表 - list</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">a</span>=[<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-number">10</span>]<br></code></pre></td></tr></table></figure><p><strong>5.字典 - dict</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">a=&#123;a:<span class="hljs-number">10</span> , b:<span class="hljs-number">20</span>&#125;<br></code></pre></td></tr></table></figure><p><strong>6.元组 - tuple</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">a</span>=  (<span class="hljs-number">10</span> , <span class="hljs-number">20</span>  ,<span class="hljs-string">&#x27;abc&#x27;</span>)<br></code></pre></td></tr></table></figure><p>**7.集合 - set **</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">a</span> = set(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-string">&#x27;abc&#x27;</span>)<br></code></pre></td></tr></table></figure><p><strong>8.函数 - function</strong><br><strong>9.字节 - bytes</strong></p><h1 id="10-变量"><a href="#10-变量" class="headerlink" title="10.变量"></a>10.变量</h1><p><strong>声明变量及时在内存中开辟空间存储数据–变量就是存储数据</strong></p><p><strong>python是动态语言（不用声明数据类型）</strong><br>1.怎么声明变量<br><strong>格式：变量名 = 值</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">name</span> = <span class="hljs-string">&#x27;路飞&#x27;</span><br></code></pre></td></tr></table></figure><p>说明：<br>1.类型：不用确定<br>2.变量名：标志符，不能是关键字<br>–见名知义，PEP8命名规范（所有字母都小写，多个单词之间用“_”隔开）</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">class_name</span> = <span class="hljs-string">&quot;python1806&quot;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>=： 赋值符号，将右边的值赋给左边的变量</li><li>值：表达式（就是有结果的，例如字面量，运算表达式（10+20），其他的变量）</li></ol><p>如果申明一个变量，可以重新存储不同的数据类型</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">number</span>  =  <span class="hljs-number">100</span><br><span class="hljs-keyword">number</span>  =  <span class="hljs-string">&#x27;瑞文&#x27;</span><br><span class="hljs-keyword">print</span> (<span class="hljs-keyword">number</span>)<br></code></pre></td></tr></table></figure><p>效果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">瑞文<br></code></pre></td></tr></table></figure><p>注：python中每条语句结束可以不用分号，但是如果一行需要写多条语句就必须加“ ； ”隔开。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">number</span> = <span class="hljs-number">10</span> <span class="hljs-comment">; name = &#x27;aaa&#x27;</span><br></code></pre></td></tr></table></figure><p>同时声明多个变量，并且赋一样的值</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">str1</span> = str2 = str3 = <span class="hljs-string">&#x27;abc&#x27;</span><br></code></pre></td></tr></table></figure><p>使用print同时打印多个值</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">print</span>(str<span class="hljs-number">1</span> , str<span class="hljs-number">2</span> , str<span class="hljs-number">3</span>)<br></code></pre></td></tr></table></figure><h1 id="一些内置函数"><a href="#一些内置函数" class="headerlink" title="一些内置函数"></a>一些内置函数</h1><h2 id="1-id函数"><a href="#1-id函数" class="headerlink" title="1.id函数"></a>1.id函数</h2><p>id（）—-查看变量的地址<br>先在内存中开辟空间存储数据，然后再将变量名作为数据对应内存的标签<br>例如：<br>a = 100<br>a = 10000<br>先把100存起来，再将其给予a的标签，所以a的地址发生变化</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lisp">a = <span class="hljs-number">100</span> <br>print(<span class="hljs-name">id</span>(<span class="hljs-name">a</span>))<br>a = <span class="hljs-number">10000</span><br>print(<span class="hljs-name">id</span>(<span class="hljs-name">a</span>))<br></code></pre></td></tr></table></figure><p>打印地址如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-number">1687149152</span><br><span class="hljs-number">34333232</span><br></code></pre></td></tr></table></figure><p>同理：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lisp">a = <span class="hljs-number">100</span> <br>print(<span class="hljs-name">id</span>(<span class="hljs-name">a</span>))<br>b = <span class="hljs-number">100</span><br>print(<span class="hljs-name">id</span>(<span class="hljs-name">b</span>))<br></code></pre></td></tr></table></figure><p>地址相同，如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-number">1687149152</span><br><span class="hljs-number">1687149152</span><br></code></pre></td></tr></table></figure><p><strong>所有的整数都是整型，python3中整型只有int，python2中整型有int和long</strong></p><h2 id="2-type函数"><a href="#2-type函数" class="headerlink" title="2.type函数"></a>2.type函数</h2><p><strong>type() —  获取括号中的数据类型</strong></p><h2 id="3-float—-浮点型"><a href="#3-float—-浮点型" class="headerlink" title="3.float—-浮点型"></a>3.float—-浮点型</h2><p><strong>所有带小数点的数字，都是浮点型</strong></p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">num1</span> = <span class="hljs-number">0.12</span><br><span class="hljs-title">num2</span> = <span class="hljs-number">-3.14</span><br><span class="hljs-title">num3</span> = <span class="hljs-number">2e2</span><br><span class="hljs-title">print</span>(<span class="hljs-class"><span class="hljs-keyword">type</span>(<span class="hljs-title">num1</span>),<span class="hljs-keyword">type</span>(<span class="hljs-title">num3</span>))</span><br><br>&lt;<span class="hljs-keyword">class</span> &#x27;float&#x27;&gt; &lt;<span class="hljs-keyword">class</span> &#x27;float&#x27;&gt;<br>[<span class="hljs-type">Finished</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0.3</span>s]<br></code></pre></td></tr></table></figure><h2 id="4-布尔"><a href="#4-布尔" class="headerlink" title="4.布尔"></a>4.布尔</h2><p>布尔就是True和False<br>True = 1  ；   False = 0</p><hr><hr><h1 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h1><h2 id="1-数学运算符："><a href="#1-数学运算符：" class="headerlink" title="1.数学运算符："></a>1.数学运算符：</h2><h6 id="（加）、-（减）、-（乘）-、-（除）"><a href="#（加）、-（减）、-（乘）-、-（除）" class="headerlink" title="+ （加）、- （减）、*（乘） 、/ （除）"></a>+ （加）、- （减）、*（乘） 、/ （除）</h6><h6 id="整除-、-取余-、-（幂运算）"><a href="#整除-、-取余-、-（幂运算）" class="headerlink" title="//(整除) 、%(取余) 、**（幂运算）"></a>//(整除) 、%(取余) 、**（幂运算）</h6><p>//(整除) ：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">print(<span class="hljs-number">5</span><span class="hljs-comment">//2)</span><br><br><span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>%(取余):</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">print(<span class="hljs-number">5</span>%<span class="hljs-number">2</span>)<br><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>**（幂运算）:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">print</span>(2*<span class="hljs-number">*3</span>)<br><br></code></pre></td></tr></table></figure><p>–练习–：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment">#取出一个4位整数的百位上的数是多少</span><br><span class="hljs-keyword">a</span> = <span class="hljs-number">1343</span><br><span class="hljs-built_in">num</span> = <span class="hljs-keyword">a</span> % <span class="hljs-number">1e3</span><br><span class="hljs-built_in">num</span> = <span class="hljs-built_in">num</span><span class="hljs-comment"> // 1e2</span><br>print(<span class="hljs-built_in">num</span>)<br><br><span class="hljs-number">3.0</span><br></code></pre></td></tr></table></figure><h2 id="2-比较运算符"><a href="#2-比较运算符" class="headerlink" title="2.比较运算符"></a>2.比较运算符</h2><blockquote><p>(大于)  ； &lt;(小于)  ； ==(等于)   ；!=(不等于)<br><strong>所有比较运算的结果都是布尔值</strong></p></blockquote><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-number">20</span> &gt; <span class="hljs-number">10</span>)</span><br><span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-variable"><span class="hljs-literal">True</span></span> == <span class="hljs-number">1</span>)</span><br><span class="hljs-function"><span class="hljs-title">print</span>(<span class="hljs-variable"><span class="hljs-literal">False</span></span> <span class="hljs-variable">!</span>= <span class="hljs-number">10</span>)</span><br><br><span class="hljs-variable"><span class="hljs-literal">True</span></span><br><span class="hljs-variable"><span class="hljs-literal">True</span></span><br><span class="hljs-variable"><span class="hljs-literal">True</span></span><br>[<span class="hljs-variable">Finished</span> <span class="hljs-variable"><span class="hljs-keyword">in</span></span> <span class="hljs-number">0.2</span><span class="hljs-variable">s</span>]<br></code></pre></td></tr></table></figure><h2 id="3-逻辑运算符"><a href="#3-逻辑运算符" class="headerlink" title="3.逻辑运算符"></a>3.逻辑运算符</h2><p><strong>and （与）</strong>：两个 或者多个条件同时满足<br><strong>or（或）</strong>： 只要一个为True，结果就为False<br><strong>not（非）</strong>：返回结果与条件相反<br><strong>操作的数据是布尔值，返回的结果也是布尔值</strong></p><p>示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">print(True</span> <span class="hljs-string">and</span> <span class="hljs-literal">False</span><span class="hljs-string">)</span><br><span class="hljs-comment"># 成绩为A</span><br><span class="hljs-string">score</span> <span class="hljs-string">=</span> <span class="hljs-number">4</span> <span class="hljs-string">;</span> <span class="hljs-string">score2</span> <span class="hljs-string">=</span> <span class="hljs-number">91</span><br><span class="hljs-string">print(score&gt;3.5</span> <span class="hljs-string">or</span> <span class="hljs-string">score2&gt;=90)</span><br><br><span class="hljs-comment"># 年龄不小于18</span><br><span class="hljs-string">age</span> <span class="hljs-string">=</span> <span class="hljs-number">20</span> <br><span class="hljs-string">print(not</span> <span class="hljs-string">age</span> <span class="hljs-string">&lt;</span> <span class="hljs-number">18</span><span class="hljs-string">)</span><br><br><span class="hljs-literal">False</span><br><span class="hljs-literal">True</span><br><span class="hljs-literal">True</span><br>[<span class="hljs-string">Finished</span> <span class="hljs-string">in</span> <span class="hljs-number">0.</span><span class="hljs-string">2s</span>]<br></code></pre></td></tr></table></figure><h2 id="4-赋值运算符"><a href="#4-赋值运算符" class="headerlink" title="4.赋值运算符"></a>4.赋值运算符</h2><p>赋值符号：<br>=（赋值），+=， -+ ， <em>=，<br>/= ,  //= , *= , *</em>=</p><p>赋值符号的左边必须是变量。<br>运算顺序：先运算赋值符号右边的值，然后将结果赋值给左边的变量。<br>a.变量 = 值<br><code>a = 10</code><br> b.变量 += 值<br>这儿的变量必须是已经声明过的变量<br><code>a += 2   #相当于 a = a + 2</code><br>注意：a += 2 地址不会变化<br> a = a+2  地址会变化</p><h2 id="5-运算符的优先级"><a href="#5-运算符的优先级" class="headerlink" title="5.运算符的优先级"></a>5.运算符的优先级</h2><p><strong>正负&gt;数学运算符&gt;比较运算符&gt;逻辑运算符&gt;赋值运算符</strong><br>–优先级高的先计算，如果优先级相同，就从左往右依次计算，括号优先运算。</p><h2 id="6-进制"><a href="#6-进制" class="headerlink" title="6.进制"></a>6.进制</h2><ul><li>计算机中常用的进制有：二进制、八进制、十进制、十六进制</li></ul><ol><li>十进制：<br>a. 基数：0-9<br>b. 进制：逢10进1<br>c. 十进制上的每一位：123 = 10^2 * 2 + 10^ 1 * 2 + 10^0 * 3</li><li>二进制：<br>a. 基数：0-1<br>b. 进制：逢2进1<br>c. 二进制上的每一位：110 = 2^2 * 1 + 2^ 1 * 1 + 2^0 * 0</li></ol><p>3.八进制和十六进制类似</p><ul><li>八进制基数是0-7</li><li>十六进制的基数0-9，a,b,c,d,e,f<h2 id="7-进制间的转换"><a href="#7-进制间的转换" class="headerlink" title="7.进制间的转换"></a>7.进制间的转换</h2><ol><li>二进制、八进制、十六进制  —-&gt;  十进制</li></ol></li><li>进制数^位数*每一位上的值得和<ol start="2"><li>八进制、十六进制 —-&gt; 二进制</li></ol></li><li>将一位的八进制转换成3位的二进制，将一位的十六进制转换成4位的二进制，反之类似！<br>例如：123（8）=001 010 011（2）<br>a2（16）= 1011 0010（2）<ol start="3"><li>十进制 —&gt; 二进制</li></ol></li></ul><ul><li>辗转相除法<h2 id="8-Python对进制的支持"><a href="#8-Python对进制的支持" class="headerlink" title="8.Python对进制的支持"></a>8.Python对进制的支持</h2></li></ul><ul><li>python支持整数的二进制、八进制、十六进制</li><li>二进制：0b<br>0b11=3（10）</li><li>八进制：0o</li><li>十六进制：0x</li></ul><p><strong>python中内置进制转化方法</strong><br>转换成二进制：bin（）<br>转换成八进制：oct（）<br>转换成十六进制：hex（）</p>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Markdown语法</title>
    <link href="/Myblog/2018/08/20/Markdown%E8%AF%AD%E6%B3%95/"/>
    <url>/Myblog/2018/08/20/Markdown%E8%AF%AD%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h3 id="编辑器"><a href="#编辑器" class="headerlink" title="编辑器"></a>编辑器</h3><p>推荐markdown编辑器，支持macos，windows各大主流操作系统</p><ul><li><p><a href="https://typora.io/">typora</a>（收费）</p></li><li><p><a href="https://marktext.app/">marktext</a>（开源免费）</p></li></ul><h3 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h3><p>在想要设置的标题的文字前面加#来表示，一个#是一级标记，二个#是二级标题，以此类推。共6级标题。</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs clean"># 这是一级标题<br>## 这是二级标题<br>### 这是三级标题<br>#### 这是四级标题<br>##### 这是五级标题<br>###### 这是六级标题<br></code></pre></td></tr></table></figure><p>效果如下：<br>#这是一级标题<br>##这是二级标题<br>###这是三级标题<br>####这是四级标题<br>#####这是五级标题<br>######这是六级标题</p><h3 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h3><p><strong>-加粗</strong><br>要加粗的文字左右分别用2个* 包起来<br>*<em>-斜体**<br>要倾斜的文字左右用1个</em> 包起来<br>*<em>-斜体加粗**<br>要倾斜和加粗的文字左右分别用3个</em> 包起来<br>**-删除线**<br>要加删除线的文字左右分别用2个~~包起来</p><p>示例：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">*<span class="hljs-strong">*这是加粗的文字*</span><span class="hljs-strong">*</span><br><span class="hljs-strong">*</span>这是倾斜的文字<span class="hljs-strong">*</span><br><span class="hljs-strong">*</span>*<span class="hljs-strong">*这是斜体加粗的文字*</span>*<span class="hljs-strong">*</span><br><span class="hljs-strong">~~这是加删除线的文字~~</span><br></code></pre></td></tr></table></figure><p>效果如下：<br><strong>这是加粗的文字</strong><br><em>这是倾斜的文字</em><br>**<em>这是斜体加粗的文字**</em><br><del>这是加删除线的文字</del></p><h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>在引用的文字前加&gt;即可。可以嵌套，如加2个&gt;&gt; 3个&gt;&gt;&gt;…<br>示例：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ruby">&gt; 这是引用的内容<br><span class="hljs-meta">&gt;&gt;</span> 这是引用的内容<br><span class="hljs-meta">&gt;&gt;</span>&gt;&gt;&gt;&gt; 这是引用的内容<br></code></pre></td></tr></table></figure><p>效果：</p><blockquote><p>这是引用的内容</p><blockquote><p>这是引用的内容</p><blockquote><blockquote><blockquote><blockquote><p>这是引用的内容</p></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote><h3 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h3><p>三个或者三个以上的-或者*都可以实现</p><p>示例：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">---<br>-----<br>**<span class="hljs-strong">*</span><br><span class="hljs-strong">*</span>*****<span class="hljs-strong">*</span><br></code></pre></td></tr></table></figure><p>效果：</p><hr><hr><hr><hr><h3 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h3><p>语法：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown">![<span class="hljs-string">图片alt</span>](<span class="hljs-link">图片地址&quot;图片title&quot;</span>)<br>图片alt：显示在图片下的文字，用于对图片内容的解释<br>图片title：图片的标题<br></code></pre></td></tr></table></figure><p>示例：<br>[图片上传失败…(image-e3b85b-1534764999445)]<br><strong>上传本地图片直接点击导航栏的图片标志即可</strong></p><h3 id="超链接"><a href="#超链接" class="headerlink" title="超链接"></a>超链接</h3><p>语法：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown">[<span class="hljs-string">超链接名</span>](<span class="hljs-link">超链接地址 &quot;超链接title&quot;</span>)<br></code></pre></td></tr></table></figure><p>代码：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs markdown">[<span class="hljs-string">简书</span>](<span class="hljs-link">http://jianshu.com</span>)<br>[<span class="hljs-string">百度</span>](<span class="hljs-link">www.baidu.com</span>)<br></code></pre></td></tr></table></figure><p>示例：<br><a href="http://jianshu.com/">简书</a><br><a href="www.baidu.com">百度</a></p><h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><ul><li>无序列表</li></ul><p>无序列表用- + *都可以</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">-</span> 列表内容<br><span class="hljs-bullet">+</span> 列表内容<br><span class="hljs-bullet">*</span> 列表内容<br>注意：序号和内容之间需要有空格<br></code></pre></td></tr></table></figure><p>效果如下：</p><ul><li>列表内容</li></ul><ul><li>列表内容</li></ul><ul><li>列表内容<br>-有序列表<br>语法：<br>数字加点<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-number">1.</span> 列表内容<br><span class="hljs-number">2.</span> 列表内容<br><span class="hljs-number">3.</span> 列表内容<br>   间隔需要有空格<br></code></pre></td></tr></table></figure> 效果如下：</li></ul><ol start="4"><li>列表内容</li><li>列表内容</li><li>列表内容</li></ol><ul><li>列表嵌套<br>上一级和下一级之间敲三个空格即可</li><li>以及无序列表内容<ul><li>二级无序列表内容</li><li>二级无序列表内容</li></ul></li></ul><ol><li>一级有序列表内容<br>1.二级有序列表内容<br>2.二级有序列表内容</li></ol><h3 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h3><p>语法：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">表头|<span class="hljs-string">表头</span>|<span class="hljs-string">表头</span><br><span class="hljs-string">---</span>|<span class="hljs-string">:--:</span>|<span class="hljs-string">---:</span><br><span class="hljs-string">内容</span>|<span class="hljs-string">内容</span>|<span class="hljs-string">内容</span><br><span class="hljs-string">内容</span>|<span class="hljs-string">内容</span>|<span class="hljs-string">内容</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>姓名</th><th align="center">技能</th><th align="right">排行</th></tr></thead><tbody><tr><td>刘备</td><td align="center">哭</td><td align="right">大哥</td></tr><tr><td>关羽</td><td align="center">打</td><td align="right">二哥</td></tr><tr><td>张飞</td><td align="center">骂</td><td align="right">三哥</td></tr></tbody></table><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>语法：<br>单行代码：代码之间分别用一个反引号包起来</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-string">`代码内容`</span><br></code></pre></td></tr></table></figure><p>代码块之间分别用三个反引号抱起来，并且两边的反引号单独占一行</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">(```)<br>代码...<br>代码...<br>代码...<br>(```)<br></code></pre></td></tr></table></figure><p>注：为了防止转译，前后三个反引号处加了小括号，实际是没有的。这里只是用来演示，实际中去掉两边小括号即可。</p><p><a href="%5Bhttps://www.markdown.cn%5D(https://www.markdown.cn/)">Markdown官方文档</a> / <a href="https://juejin.im/entry/59a9620df265da249a202763">Markdown高级用法</a> /  <a href="https://www.webfx.com/tools/emoji-cheat-sheet/">emoji表情</a> / </p>]]></content>
    
    
    <categories>
      
      <category>Markdown</category>
      
    </categories>
    
    
    <tags>
      
      <tag>markdown</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ssh-key配置</title>
    <link href="/Myblog/2018/08/18/ssh-key%E9%85%8D%E7%BD%AE/"/>
    <url>/Myblog/2018/08/18/ssh-key%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h3 id="一、创建秘钥目录并进入"><a href="#一、创建秘钥目录并进入" class="headerlink" title="一、创建秘钥目录并进入"></a>一、创建秘钥目录并进入</h3><p><code>cd ~/.ssh</code></p><h3 id="二、生成SSH秘钥"><a href="#二、生成SSH秘钥" class="headerlink" title="二、生成SSH秘钥"></a>二、生成SSH秘钥</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell">ssh<span class="hljs-literal">-keygen</span> <span class="hljs-literal">-t</span> rsa <span class="hljs-literal">-C</span> <span class="hljs-string">&#x27;youremail@***.com&#x27;</span> <span class="hljs-operator">-f</span> <span class="hljs-string">&#x27;gitee_id_rsa&#x27;</span><br>ssh<span class="hljs-literal">-keygen</span> <span class="hljs-literal">-t</span> rsa <span class="hljs-literal">-C</span> <span class="hljs-string">&#x27;youremail@***.com&#x27;</span> <span class="hljs-operator">-f</span> <span class="hljs-string">&#x27;github_id_rsa&#x27;</span><br></code></pre></td></tr></table></figure><p>生成两对秘钥，分别为<code>gitee_id_rsa</code>和<code>github_id_rsa</code>对应在gitee和github使用。</p><h3 id="三、把公钥复制到gitee和github上"><a href="#三、把公钥复制到gitee和github上" class="headerlink" title="三、把公钥复制到gitee和github上"></a>三、把公钥复制到gitee和github上</h3><p>把公钥内容复制，复制到gitee上。</p><p>同样的操作，添加gitee的ssh。</p><h3 id="四、创建config文件解决ssh冲突"><a href="#四、创建config文件解决ssh冲突" class="headerlink" title="四、创建config文件解决ssh冲突"></a>四、创建config文件解决ssh冲突</h3><p>在.ssh文件夹下添加文件config，并添加以下内容</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># gitee</span><br><span class="hljs-attr">Host</span> <span class="hljs-string">gitee.com</span><br><span class="hljs-attr">HostName</span> <span class="hljs-string">gitee.com</span><br><span class="hljs-attr">PreferredAuthentications</span> <span class="hljs-string">publickey</span><br><span class="hljs-attr">IdentityFile</span> <span class="hljs-string">~/.ssh/gitee_id_rsa</span><br><br><span class="hljs-comment"># github</span><br><span class="hljs-attr">Host</span> <span class="hljs-string">github.com</span><br><span class="hljs-attr">HostName</span> <span class="hljs-string">github.com</span><br><span class="hljs-attr">PreferredAuthentications</span> <span class="hljs-string">publickey</span><br><span class="hljs-attr">IdentityFile</span> <span class="hljs-string">~/.ssh/github_id_rsa</span><br></code></pre></td></tr></table></figure><h3 id="五、测试"><a href="#五、测试" class="headerlink" title="五、测试"></a>五、测试</h3><p>执行</p><p><code>ssh -T git@gitee.com</code></p><p><code>ssh -T git@github.com</code></p><h3 id="遇到问题："><a href="#遇到问题：" class="headerlink" title="遇到问题："></a>遇到问题：</h3><p>出现错误信息：<code>git@gitee.com: Permission denied (publickey).</code></p><h3 id="解决办法一-一次性-："><a href="#解决办法一-一次性-：" class="headerlink" title="解决办法一(一次性)："></a>解决办法一(一次性)：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-built_in">eval</span> <span class="hljs-string">`ssh-agent -s`</span><br>ssh-add ~<span class="hljs-regexp">/.ssh/gi</span>tee_id_rsa(公钥名称)<br></code></pre></td></tr></table></figure><h3 id="解决方法二："><a href="#解决方法二：" class="headerlink" title="解决方法二："></a>解决方法二：</h3><p>在.ssh文件夹下添加文件config，并添加以下内容</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># gitee</span><br><span class="hljs-attr">Host</span> <span class="hljs-string">gitee.com</span><br><span class="hljs-attr">HostName</span> <span class="hljs-string">gitee.com</span><br><span class="hljs-attr">PreferredAuthentications</span> <span class="hljs-string">publickey</span><br><span class="hljs-attr">IdentityFile</span> <span class="hljs-string">~/.ssh/gitee_id_rsa</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>SSH-KEY</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ssh-key</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>云服务器端搭建hexo博客</title>
    <link href="/Myblog/2018/08/18/hexo%E5%8D%9A%E5%AE%A2%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%90%AD%E5%BB%BA/"/>
    <url>/Myblog/2018/08/18/hexo%E5%8D%9A%E5%AE%A2%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h3 id="云服务器端配置"><a href="#云服务器端配置" class="headerlink" title="云服务器端配置"></a>云服务器端配置</h3><h4 id="安装-git-和配置"><a href="#安装-git-和配置" class="headerlink" title="安装 git 和配置"></a>安装 git 和配置</h4><p>1、使用<code>git --version</code>查看git版本，如果电脑不存在，就进行git安装</p><p>2、创建git仓库，用于存放博客网站资源</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">mkdir <span class="hljs-regexp">/home/gi</span>t/<br>chown -R <span class="hljs-variable">$USER</span>:<span class="hljs-variable">$USER</span> <span class="hljs-regexp">/home/gi</span>t/<br>chmod -R <span class="hljs-number">755</span> <span class="hljs-regexp">/home/gi</span>t/<br></code></pre></td></tr></table></figure><p>然后，执行如下命令：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-keyword">cd</span> <span class="hljs-string">/home/git/</span><br>git init <span class="hljs-params">--bare</span> hexoBlog.git<br></code></pre></td></tr></table></figure><p>3、创建一个新的 git 钩子，用于自动部署</p><ul><li><p>在 <code>/home/git/hexoBlog.git</code> 下，有一个自动生成的 <code>hooks</code> 文件夹。我们需要在里边新建一个新的钩子文件 <code>post-receive</code>。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/home/gi</span>t<span class="hljs-regexp">/hexoBlog.git/</span>hooks/post-receive<br></code></pre></td></tr></table></figure></li><li><p>按 <code>i</code> 键进入文件的编辑模式，在该文件中添加两行代码（将下边的代码粘贴进去)，指定 Git 的工作树（源代码）和 Git 目录（配置文件等）.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>git --work-tree=/home/hexoBlog --git-dir=/home/git/hexoBlog.git checkout -f<br></code></pre></td></tr></table></figure></li><li><p>修改文件权限，使得其可执行。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">chmod +x <span class="hljs-regexp">/home/gi</span>t<span class="hljs-regexp">/hexoBlog.git/</span>hooks/post-receive<br></code></pre></td></tr></table></figure><p> 到这里，我们的 git 仓库算是完全搭建好了。下面进行 Nginx 的配置。</p></li></ul><h4 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h4><ol><li>安装 Nginx</li></ol><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> -y nginx<br><br></code></pre></td></tr></table></figure><ol start="2"><li>启动 Nginx</li></ol><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">service nginx <span class="hljs-literal">start</span><br><br></code></pre></td></tr></table></figure><ol start="3"><li>测试 Nginx 服务器</li></ol><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><br><br></code></pre></td></tr></table></figure><p>能够正常获取以下欢迎页面说明Nginx安装成功。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">Connecting to <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">80.</span>.. connected.<br>HTTP request sent, awaiting response... <span class="hljs-number">200</span> OK<br>Length: <span class="hljs-number">43704</span> (<span class="hljs-number">43</span>K) [text/html]<br>Saving to: ‘index.html’<br><br><span class="hljs-number">100</span>%[=======================================&gt;] <span class="hljs-number">43</span>,<span class="hljs-number">704</span>      --.-K/s   <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>s<br><br><span class="hljs-number">2018</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">23</span>:<span class="hljs-number">04</span>:<span class="hljs-number">09</span> (<span class="hljs-number">487</span> MB/s) - ‘index.html’ saved [<span class="hljs-number">43704</span>/<span class="hljs-number">43704</span>]<br><br></code></pre></td></tr></table></figure><ol start="4"><li><p>测试网页是否能打开<br>在浏览器中输入服务器 ip 地址，就是服务器的公网 ip。</p></li><li><p>配置 Nginx 托管文件目录</p><ol><li>接下来，创建 <code>/home/hexoBlog</code>目录，用于 Nginx 托管。</li></ol><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">mkdir <span class="hljs-regexp">/home/</span>hexoBlog/<br>chown -R <span class="hljs-variable">$USER</span>:<span class="hljs-variable">$USER</span> <span class="hljs-regexp">/home/</span>hexoBlog/<br>chmod -R <span class="hljs-number">755</span> <span class="hljs-regexp">/home/</span>hexoBlog/<br><br></code></pre></td></tr></table></figure><ol start="2"><li>查看 Nginx 的默认配置的安装位置</li></ol><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">nginx -t</span><br><br></code></pre></td></tr></table></figure><ol start="3"><li>修改Nginx的默认配置，其中 cd 后边就是刚才查到的安装位置（每个人可能都不一样）</li></ol><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/etc/</span>nginx/nginx.conf<br><br></code></pre></td></tr></table></figure><ol start="4"><li>按方向键，找到如下位置</li></ol><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;<br>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server;<br>    <span class="hljs-attribute">root</span> /home/hexoBlog;    <span class="hljs-comment">#需要修改</span><br><br>    <span class="hljs-attribute">server_name</span> www.bujige.net; <span class="hljs-comment">#需要修改</span><br><br>    <span class="hljs-comment"># Load configuration files for the default server block.</span><br>    <span class="hljs-attribute">include</span> /etc/nginx/default.d/<span class="hljs-regexp">*.conf</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>    &#125;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> /<span class="hljs-number">404</span>.html;<br>        <span class="hljs-attribute">location</span> = /40x.html &#123;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>按<code>i</code>键进入插入模式，将其中的 root 值改为 <code>/home/hexoBlog</code> （刚才创建的托管仓库目录）。<br>将 server_name 值改成你的域名。</p><ol start="5"><li>重启 Nginx 服务</li></ol><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">service nginx restart</span><br><br></code></pre></td></tr></table></figure><p>至此，服务器端配置就结束了。接下来，就剩下本地 hexo 的配置更改了。</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo博客迁移</title>
    <link href="/Myblog/2018/08/18/hexo%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB/"/>
    <url>/Myblog/2018/08/18/hexo%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB/</url>
    
    <content type="html"><![CDATA[<h3 id="方法一：把原来的配置文件进行备份转移"><a href="#方法一：把原来的配置文件进行备份转移" class="headerlink" title="方法一：把原来的配置文件进行备份转移"></a>方法一：把原来的配置文件进行备份转移</h3><h4 id="1、复制配置文件"><a href="#1、复制配置文件" class="headerlink" title="1、复制配置文件"></a>1、复制配置文件</h4><p>其中只需要把 source、themes、scaffolds配置文件_config.yml备份即可，其他相关文件会自动生成。</p><h4 id="2、安装Node-js"><a href="#2、安装Node-js" class="headerlink" title="2、安装Node.js"></a>2、安装Node.js</h4><p><code>sudo apt-get install nodejs</code><br><code>sudo apt-get install npm</code></p><h4 id="3、安装hexo"><a href="#3、安装hexo" class="headerlink" title="3、安装hexo"></a>3、安装hexo</h4><p><code>sudo npm install -g hexo</code></p><h4 id="4、新建项目文件夹，cd进入"><a href="#4、新建项目文件夹，cd进入" class="headerlink" title="4、新建项目文件夹，cd进入"></a>4、新建项目文件夹，cd进入</h4><p><code>hexo init</code></p><h4 id="5、将备份的文件覆盖到新文件夹"><a href="#5、将备份的文件覆盖到新文件夹" class="headerlink" title="5、将备份的文件覆盖到新文件夹"></a>5、将备份的文件覆盖到新文件夹</h4><p>使用<code>hexo g &amp;&amp; hexo s</code>查看本地能否运行</p><h4 id="遇到问题1："><a href="#遇到问题1：" class="headerlink" title="遇到问题1："></a>遇到问题1：</h4><p><code>hexo deploy </code> 后出现错误：<code>ERROR Deployer not found: git</code></p><h4 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h4><p><code>npm install hexo-deployer-git --save </code>即可</p><h4 id="遇到问题2："><a href="#遇到问题2：" class="headerlink" title="遇到问题2："></a>遇到问题2：</h4><p><code>hexo deploy</code> 后依然出错：<code>Error: *** Please tell me who you are.</code></p><h4 id="解决：-1"><a href="#解决：-1" class="headerlink" title="解决："></a>解决：</h4><p><code>git config --global user.email &quot;you@example.com&quot;</code></p><p><code>git config --global user.name &quot;Your Name&quot;</code></p><h3 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3><p>待补充…</p>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo部署到gitee</title>
    <link href="/Myblog/2018/08/18/hexo%E9%83%A8%E7%BD%B2%E5%88%B0gitee/"/>
    <url>/Myblog/2018/08/18/hexo%E9%83%A8%E7%BD%B2%E5%88%B0gitee/</url>
    
    <content type="html"><![CDATA[<h3 id="为何使用Gitee而不是GitHub"><a href="#为何使用Gitee而不是GitHub" class="headerlink" title="为何使用Gitee而不是GitHub"></a>为何使用Gitee而不是GitHub</h3><p>目前国内访问GitHub速度慢，还可能被墙，所以Gitee来构建个人博客。Gitee类似国内版的GitHub，访问速度有保证。</p><h3 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h3><ul><li>Git</li><li>NodeJs</li></ul><h3 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">打开 <span class="hljs-keyword">shell</span><span class="bash"> 终端，输入命令`npm install -g hexo`</span><br></code></pre></td></tr></table></figure><h4 id="初始化Hexo"><a href="#初始化Hexo" class="headerlink" title="初始化Hexo"></a>初始化Hexo</h4><p>在你的电脑上创建<code>Hexo</code>文件夹，在shell终端中切换到<code>Hexo</code>目录，输入命令 <code>hexo init</code> </p><h3 id="创建gitee公开项目"><a href="#创建gitee公开项目" class="headerlink" title="创建gitee公开项目"></a>创建gitee公开项目</h3><p>复制项目地址。 </p><h4 id="修改站点配置文件-config-yml"><a href="#修改站点配置文件-config-yml" class="headerlink" title="修改站点配置文件_config.yml"></a>修改站点配置文件_config.yml</h4><p>repo: 写上自己gitee上项目地址，并加上.git后缀</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-attribute">deploy</span>: <br>  <span class="hljs-attribute">type</span>: git<br>  <span class="hljs-attribute">repo</span>: <span class="hljs-attribute">https</span>:<span class="hljs-comment">//gitee.com/Deathfeeling/Myblog.git</span><br>  <span class="hljs-attribute">branch</span>: master<br></code></pre></td></tr></table></figure><h4 id="发布到Gitee"><a href="#发布到Gitee" class="headerlink" title="发布到Gitee"></a>发布到Gitee</h4><p>输入命令<code>npm install hexo-deployer-git --save</code> 安装自动部署发布工具 </p><p>输入命令<code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</code> 发布博客，首次发布需要在shell中输入gitee用户名和密码。</p><h3 id="Gitee-Pages设置"><a href="#Gitee-Pages设置" class="headerlink" title="Gitee Pages设置"></a>Gitee Pages设置</h3><p>在项目的服务中选择Pages选项 ，选择 master分支，点击 部署/更新 </p><p>这样就就可以访问自己搭建的博客地址了<a href="https://stellae.gitee.io/myblog/">https://stellae.gitee.io/myblog/</a></p><h3 id="遇到问题："><a href="#遇到问题：" class="headerlink" title="遇到问题："></a>遇到问题：</h3><p>博客的样式不对，显示有问题</p><h3 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h3><p>需要在_config.yml中配置下博客地址和路径： </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">url: https:<span class="hljs-regexp">//</span>stellae.gitee.io<span class="hljs-regexp">/myblog/</span><br>root: /Myblog<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
